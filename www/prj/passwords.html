<!DOCTYPE html>
<html>
<head>
<title>Управление паролями из консоли</title>
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="rigidus">
<link href="/css/style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="content">
<h1 class="title">Управление паролями из консоли</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Intro</a></li>
<li><a href="#sec-2">Features</a>
<ul>
<li><a href="#sec-2-1">Создание стойких паролей на основе ключевой фразы</a></li>
<li><a href="#sec-2-2">Хранение паролей</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Intro</h2>
<div class="outline-text-2" id="text-1">
<p>
В последнее время получили распространение "менеджеры паролей" - программы, которые
освобождают мозг пользователя от тяжелой работы по созданию и запоминанию множества
паролей к различным аккаунтам. Взамен они становятся <code>single point of failure</code>, требуют
денег, и могут неожиданно привести к утечке наиболее чувствительных данных.
</p>

<p>
Тем временем, все что нужно - у нас (в linux) уже есть и совершенно бесплатно,
достаточно лишь скомпоновать это в набор небольших утилит, доступных из командной
строки. Этот маленький проект будет собран только из утилит командной строки linux с
использованием <code>bash</code>.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Features</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">Создание стойких паролей на основе ключевой фразы</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Мы хотим получить стойкий пароль на основе нестойкой ключевой фразы или слова. В
простейшем случае мы можем хэшировать ключевую фразу и использовать детерминированный
генератор на основе полученного хеша.
</p>

<p>
Первое, что она сделает - это прочтет одну строчку пользовательского ввода в переменную
<code>pass</code>. Ключ <code>r</code> отлючает escaping, а <code>s</code> - silent mode, т.е. ввод не будет показан в
терминале (на случай если кто-то подсматривает в монитор)
</p>

<div class="org-src-container">

<pre class="src src-sh" id="read_secret"><span style="color: #5f5f87;">read</span> -rs pass
<span style="color: #af0000;"># </span><span style="color: #af0000;">echo "pass=$pass"</span>
</pre>
</div>

<p>
Затем полученную ключевую фразу мы захэшируем, удалим лишние символы и переведем
результат в верхний регистр. Получим что-то вроде:
"DC460DA4AD72C482231E28E688E01F2778A88CE31A08826899D54EF7183998B5". Этот результат
запишем в переменную <code>alfa</code>:
</p>

<div class="org-src-container">

<pre class="src src-sh" id="alfa_hash"><span style="color: #af5f00;">alfa</span>=<span style="color: #cd00cd;">`echo $pass | sha256sum | tr -d " -" | tr a-z A-Z`</span>
<span style="color: #af0000;"># </span><span style="color: #af0000;">echo "alfa=$alfa"</span>
</pre>
</div>

<p>
Такой пароль содержит только цифры от "0" до "9" и буквы от "A" до "F". Мы же хотим,
чтобы пароль состоял из всех цифр и букв алфавита, разного регистра, кроме тех, которые
можно перепутать: так например несложно перепутать букву <code>l</code> и цифру <code>1</code> или букву <code>O</code>
и цифру <code>0</code>.
</p>

<p>
Первое, что нам понадобится на этом пути - это набор разрешенных символов
пароля. Составим его в переменной <code>tbl</code> (таблица символов):
</p>

<div class="org-src-container">

<pre class="src src-sh" id="tbl"><span style="color: #5f5f87;">local</span> <span style="color: #af5f00;">tbl</span>=({0..9} {A..H} {J..N} {P..Z} {a..k} {m..z});
<span style="color: #af0000;"># </span><span style="color: #af0000;">echo "tbl=${tbl[@]}"</span>
<span style="color: #af0000;"># </span><span style="color: #af0000;">echo "len_tbl=${#tbl[@]}"</span>
</pre>
</div>

<p>
Теперь мы хотим взять наш хэш, сохраненный в переменной <code>alfa</code> и перевести его из
формата шестнадцатиричного числа в формат числа, основанием которого должен быть размер
нашей таблицы разрешенных символов пароля.
</p>

<p>
Для этого используем <code>GNU Basic Calcilator</code> командной строки или просто <code>bc</code>. Мы
передаем ему основание входного и выходного числа и само число, а он делает все
остальное. Правда, он форматирует вывод, пытаясь представить число в удобном для чтения
виде, поэтому нам приходится убирать переносы строки и обратные слэши с помощью
<code>sed</code>. Результат помещаем в перменную <code>beta</code>:
</p>

<div class="org-src-container">

<pre class="src src-sh" id="gnubc"><span style="color: #af5f00;">beta</span>=<span style="color: #cd00cd;">`bc &lt;&lt;&lt; "obase=58;ibase=16;${alfa^^}" | sed -z 's/\\\\\n/ /g'`</span>
<span style="color: #af0000;"># </span><span style="color: #af0000;">echo "beta=$beta"</span>
</pre>
</div>

<p>
Теперь мы можем прочесть содержимое <code>beta</code> как массив с помощью
<code>readarray</code>. Прочитанный массив кладем в переменную <code>gamma</code>
</p>

<div class="org-src-container">

<pre class="src src-sh" id="gammma_array"><span style="color: #5f5f87;">read</span> -ra gamma &lt;&lt;&lt; <span style="color: #87005f;">"$beta"</span>
<span style="color: #af0000;"># </span><span style="color: #af0000;">echo "gamma=${gamma[@]}"</span>
</pre>
</div>

<p>
Нам осталось перебрать содержимое массива <code>gamma</code> делая lookup в <code>tbl</code> по индексу и
выводя полученное значение. Обратите внимание что чтобы индекс воспринимался как
шестнадцатиричное число мы используем "16#"
</p>

<div class="org-src-container">

<pre class="src src-sh" id="iterate"><span style="color: #af00ff;">for</span> idx<span style="color: #af00ff;"> in</span> <span style="color: #87005f;">"${gamma[@]}"</span> ;
<span style="color: #af00ff;">do</span>
    <span style="color: #5f5f87;">printf</span> %s ${<span style="color: #af5f00;">tbl</span>[ <span style="color: #87005f;">"16#$idx"</span> ]};
<span style="color: #af00ff;">done</span>;
<span style="color: #5f5f87;">echo</span>
</pre>
</div>

<p>
Теперь осталось собрать все это в функцию <code>np</code> (new password) и положить куда-нибудь в
<code>.bashrc</code>:
</p>

<div class="org-src-container">

<pre class="src src-sh" id="new_password"><span style="color: #af0000;">#</span><span style="color: #af0000;">!/bin/</span><span style="color: #af00ff;">bash</span>

<span style="color: #af00ff;">function</span> <span style="color: #0000ff;">np</span>() {
    &lt;&lt;tbl&gt;&gt;
<span style="color: #ffaf5f;">    &lt;&lt;read_secret&gt;&gt;</span>
<span style="color: #ffaf5f;">    &lt;&lt;alfa_hash&gt;&gt;</span>
<span style="color: #ffaf5f;">    &lt;&lt;gnubc&gt;&gt;</span>
<span style="color: #ffaf5f;">    &lt;&lt;gammma_array&gt;&gt;</span>
<span style="color: #ffaf5f;">    &lt;&lt;iterate&gt;&gt;</span>
<span style="color: #ffaf5f;">}</span>

<span style="color: #ffaf5f;">np</span>
</pre>
</div>

<p>
Получается вот такой код:
</p>

<div class="org-src-container">

<pre class="src src-sh" id="result"><span style="color: #af0000;">#</span><span style="color: #af0000;">!/bin/</span><span style="color: #af00ff;">bash</span>

<span style="color: #af00ff;">function</span> <span style="color: #0000ff;">np</span>() {
    <span style="color: #5f5f87;">local</span> <span style="color: #af5f00;">tbl</span>=({1..9} {A..H} {J..N} {P..Z} {a..k} {m..z});
    <span style="color: #af0000;"># </span><span style="color: #af0000;">echo "tbl=${tbl[@]}"</span>
    <span style="color: #af0000;"># </span><span style="color: #af0000;">echo "len_tbl=${#tbl[@]}"</span>
    <span style="color: #5f5f87;">read</span> -rs pass
    <span style="color: #af0000;"># </span><span style="color: #af0000;">echo "pass=$pass"</span>
    <span style="color: #af5f00;">alfa</span>=<span style="color: #cd00cd;">`echo $pass | sha256sum | tr -d " -" | tr a-z A-Z`</span>
    <span style="color: #af0000;"># </span><span style="color: #af0000;">echo "alfa=$alfa"</span>
    <span style="color: #af5f00;">beta</span>=<span style="color: #cd00cd;">`bc &lt;&lt;&lt; "obase=58;ibase=16;${alfa^^}" | sed -z 's/\\\\\n/ /g'`</span>
    <span style="color: #af0000;"># </span><span style="color: #af0000;">echo "beta=$beta"</span>
    <span style="color: #5f5f87;">read</span> -ra gamma &lt;&lt;&lt; <span style="color: #87005f;">"$beta"</span>
    <span style="color: #af0000;"># </span><span style="color: #af0000;">echo "gamma=${gamma[@]}"</span>
    <span style="color: #af00ff;">for</span> idx<span style="color: #af00ff;"> in</span> <span style="color: #87005f;">"${gamma[@]}"</span> ;
    <span style="color: #af00ff;">do</span>
        <span style="color: #5f5f87;">printf</span> %s ${<span style="color: #af5f00;">tbl</span>[ <span style="color: #87005f;">"16#$idx"</span> ]};
    <span style="color: #af00ff;">done</span>;
    <span style="color: #5f5f87;">echo</span>
}

np
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">Хранение паролей</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Пока у меня не так много паролей, чтобы не помнить все их ключевые фразы, поэтому я еще
не реализовал надежно зашифронное хранилище паролей. Но я с удовольствием приму
pull-request если кто-то сделает это.
</p>
</div>
</div>
</div>
</div>
</body>
</html>
