<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Как сделан сайт rigidus.ru</title>
<meta name="generator" content="Org mode">
<meta name="author" content="rigidus">
<link href="/css/style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="content">
<h1 class="title">Как сделан сайт rigidus.ru</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org6882a18">О проекте</a></li>
<li><a href="#orge669c4c">Установка и настройка</a>
<ul>
<li><a href="#org9ae61b4">Легкий старт</a></li>
<li><a href="#org4433b76">Инструменты разработки</a></li>
</ul>
</li>
<li><a href="#org316381d">Как это работает</a></li>
<li><a href="#org242e1a5">Сборка</a>
<ul>
<li><a href="#orgb9f64d4">Файл определения системы</a></li>
<li><a href="#orgd70c252">Подготовка к запуску</a></li>
<li><a href="#org318a236">Определение пакетов</a></li>
<li><a href="#org5af6d78">Утилиты</a></li>
<li><a href="#orgaaad173">Copyright</a></li>
<li><a href="#org7234533">Определение модуля</a></li>
<li><a href="#orgcc890ed">Инициализация</a></li>
</ul>
</li>
<li><a href="#org37ba792">Трансляция путей</a></li>
<li><a href="#org5078432">Шаблон блоков статистики</a></li>
<li><a href="#orgf9cf361">Html-tree</a>
<ul>
<li><a href="#org578861a">Парсинг html</a></li>
<li><a href="#org550c642">Сборка в html</a></li>
</ul>
</li>
<li><a href="#orgeb843b9">Преобразование страниц</a></li>
<li><a href="#org2721db4">Рендеринг</a></li>
<li><a href="#orgc7de36b">Маршрутизация</a>
<ul>
<li><a href="#org03c6831">Статические файлы</a></li>
<li><a href="#org0182442">404 страница</a></li>
<li><a href="#org60b4f5d">Страница robots.txt</a></li>
<li><a href="#org00ce4f6">Страницы orgmode</a></li>
<li><a href="#orgf6b2d86">Маршруты страниц</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org6882a18">О проекте</a></li>
<li><a href="#orge669c4c">Установка и настройка</a>
<ul>
<li><a href="#org9ae61b4">Легкий старт</a></li>
<li><a href="#org4433b76">Инструменты разработки</a></li>
</ul>
</li>
<li><a href="#org316381d">Как это работает</a></li>
<li><a href="#org242e1a5">Сборка</a>
<ul>
<li><a href="#orgb9f64d4">Файл определения системы</a></li>
<li><a href="#orgd70c252">Подготовка к запуску</a></li>
<li><a href="#org318a236">Определение пакетов</a></li>
<li><a href="#org5af6d78">Утилиты</a></li>
<li><a href="#orgaaad173">Copyright</a></li>
<li><a href="#org7234533">Определение модуля</a></li>
<li><a href="#orgcc890ed">Инициализация</a></li>
</ul>
</li>
<li><a href="#org37ba792">Трансляция путей</a></li>
<li><a href="#org5078432">Шаблон блоков статистики</a></li>
<li><a href="#orgf9cf361">Html-tree</a>
<ul>
<li><a href="#org578861a">Парсинг html</a></li>
<li><a href="#org550c642">Сборка в html</a></li>
</ul>
</li>
<li><a href="#orgeb843b9">Преобразование страниц</a></li>
<li><a href="#org2721db4">Рендеринг</a></li>
<li><a href="#orgc7de36b">Маршрутизация</a>
<ul>
<li><a href="#org03c6831">Статические файлы</a></li>
<li><a href="#org0182442">404 страница</a></li>
<li><a href="#org60b4f5d">Страница robots.txt</a></li>
<li><a href="#org00ce4f6">Страницы orgmode</a></li>
<li><a href="#orgf6b2d86">Маршруты страниц</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org6882a18" class="outline-2">
<h2 id="org6882a18">О проекте</h2>
<div class="outline-text-2" id="text-org6882a18">
<p>
Я делал этот сайт, тренируясь в <a href="../../../doc/literate-programming.html">литературном программировании</a>.
Литературное программирование (Literate Programming) - методология
программирования и документирования, в которой программа состоит из
прозы на естественном языке вперемежку с макроподстановками и кодом на
языках программирования.
</p>

<p>
Он содержит в себе весь код, который обеспечивает работу сайта и
сделан максимально простым, чтобы служить наглядным введением в
<code>literate programming</code> с использованием <code>lisp</code> и набора инструментов,
реализованного в <code>emacs</code>: <code>org-mode</code>, <code>babel</code> и других.
</p>

<div class="NOTE">
<p>
Вы можете пропустить раздел <b>Установка и настройка</b> и перейти сразу
к разделу <b><a href="#org316381d">Как это работает</a></b>, если вы не собираетесь использовать
эти инструменты прямо сейчас.
</p>

</div>

<p>
Документ ниже является литературным исходником сайта
<a href="http://rigidus.ru">http://rigidus.ru</a>.
</p>

<p>
Сам сайт был изначально создан для сбора редких и интересных
материалов о вычислительных моделях и языках программирования. Позже
он также превратился в занимательное упражнение в реализации
разнообразных программистких концепций.
</p>

<p>
Исходный код открыт по лицензии GNU v.3. Данные, в том числе
руководства и книги, могут иметь свои лицензии.
</p>

<p>
Репозиторий с исходным кодом и историей коммитов доступен на
<a href="https://github.com/rigidus/rigidus.ru">https://github.com/rigidus/rigidus.ru</a>
</p>

<p>
Вы можете делать любые дополнения и предложения в форме
<code>pull-requests</code> и <code>issue</code>.
</p>
</div>
</div>

<div id="outline-container-orge669c4c" class="outline-2">
<h2 id="orge669c4c">Установка и настройка</h2>
<div class="outline-text-2" id="text-orge669c4c">
<p>
Этот сайт работает внутри образа <code>Common Lisp</code> под управлением
веб-сервера <code>hunchentoot</code>. В качестве высокоуровневой библиотеки
используется <a href="https://github.com/archimag/restas">RESTAS</a>, которую написал Андрей Москвитин (archimag).
</p>

<p>
Веб-сервер, библиотеку и все необходимые зависимости лучше всего
установить при помощи менеджера библиотек <a href="http://quicklisp.org">Quicklisp</a>.
</p>

<p>
Чтобы просто запустить сайт и попробовать его в работе, пройдите
раздел "Легкий старт". Все что идет дальше потребуется вам чтобы
обеспечить инструментарий для литературного программирования.
</p>
</div>

<div id="outline-container-org9ae61b4" class="outline-3">
<h3 id="org9ae61b4">Легкий старт</h3>
<div class="outline-text-3" id="text-org9ae61b4">
<p>
Установите <code>git</code> - систему управления версиями, если она еще не
установлена:
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo apt-get install git
</pre>
</div>

<p>
Клонируйте репозиторий проекта:
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir -p ~/repo
cd ~/repo
git clone git@github.com:rigidus/rigidus.ru.git
</pre>
</div>

<p>
Установите <code>sbcl</code> - реализацию Common Lisp
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo apt-get install sbcl
</pre>
</div>

<p>
Установите quicklisp - менеджер библиотек для Common Lisp
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir -p ~/build
cd ~/build
wget https://beta.quicklisp.org/quicklisp.lisp
sbcl --load quicklisp.lisp
</pre>
</div>

<p>
Теперь мы внутри <code>quicklisp</code>-а, работающего в образе <code>sbcl</code>. Попросим
его добавить себя в инициализационный файл, чтобы <code>quicklisp</code>
загружался каждый раз, когда стартует <code>sbcl</code>
</p>

<div class="org-src-container">
<pre class="src src-lisp">(ql:add-to-init-file)
</pre>
</div>

<p>
Выйдите из лиспа:
</p>

<div class="org-src-container">
<pre class="src src-lisp">(quit)
</pre>
</div>

<p>
Откройте файл <code>~/.sbclrc</code> и добавьте в конец файла следующие строки,
чтобы <code>quicklisp</code> знал, где находится репозиторий с сайтом:
</p>

<div class="org-src-container">
<pre class="src src-lisp">#+quicklisp
(mapcar #'(lambda (x)
            (pushnew x ql:*local-project-directories*))
        (list #P"~/repo/rigidus.ru/"))
</pre>
</div>

<p>
Снова запустите <code>sbcl</code>
</p>

<div class="org-src-container">
<pre class="src src-sh">sbcl
</pre>
</div>

<p>
И в нем загрузите сайт:
</p>

<div class="org-src-container">
<pre class="src src-lisp">(ql:quickload "rigidus")
</pre>
</div>

<p>
Наберите в адресной строке броузера <code>http://localhost:9993</code> и
загрузите главную страницу.
</p>

<div class="NOTE">
<p>
Если вы не видите главной страницы, возможно это потому, что
сгенерированные файлы не попадают в репозиторий (так может быть
настроен <code>.gitignore</code>). Если это действительно так - поместите в в
<code>/repo/rigidus.ru/www</code> файл <code>index.html</code> и проверьте, отобразился ли
он в броузере. Вы также можете пройти следующий раздел и
сгенерировать все файлы сайта, используя инструменты из него.
</p>

</div>
</div>
</div>

<div id="outline-container-org4433b76" class="outline-3">
<h3 id="org4433b76">Инструменты разработки</h3>
<div class="outline-text-3" id="text-org4433b76">
<p>
Чтобы настроить инструменты <code>emacs</code> для поддержки литературного
программирования совершите следующие действия:
</p>

<p>
Установите <code>emacs</code>, если он еще не установлен.
</p>

<div class="org-src-container">
<pre class="src src-sh">apt-get install emacs23
</pre>
</div>

<p>
Добавьте в файл конфигурации <code>/.emacs.d/init.el</code> следующие строки, при
необходимости изменив пути к папкам:
</p>

<div class="org-src-container">
<pre class="src src-lisp">(defun org-custom-link-img-follow (path)
  (org-open-file-with-emacs
   (format "../img/%s" path)))

(defun org-custom-link-img-export (path desc format)
  (cond
    ((eq format 'html)
     (format "&lt;img src=\"/img/%s\" alt=\"%s\"/&gt;" path desc))))

(org-add-link-type "img" 'org-custom-link-img-follow 'org-custom-link-img-export)

(setq org-export-time-stamp-file nil)
(setq org-publish-project-alist
      '(("org-notes"
         :base-directory "~/repo/rigidus.ru/org/"
         :base-extension "org"
         :publishing-directory "~/repo/rigidus.ru/www/"
         :recursive t
         :publishing-function org-html-publish-to-html
         :timestamp nil
         :html-doctype "html5"
         :section-numbers nil
         :html-postamble nil
         :html-preamble nil
         :with-timestamps nil
         :timestamp nil
         :with-date nil
         :html-head-extra "&lt;link href=\"/css/style.css\" rel=\"stylesheet\" type=\"text/css\" /&gt;"
         :html-head-include-default-style nil
         :html-head-include-scripts nil)
        ("org-static"
         :base-directory "~/repo/rigidus.ru/org/"
         :base-extension "css\\|js\\|png\\|jpg\\|gif\\|pdf\\|djvu"
         :publishing-directory "~/repo/rigidus.ru/www/"
         :recursive t
         :publishing-function org-publish-attachment)
        ("org"
         :components ("org-notes" "org-static"))))
</pre>
</div>

<p>
Если вы желаете заняться написанием кода на лиспе для этого проекта -
установите <code>slime</code> с <a href="https://common-lisp.net/project/slime/">официального сайта</a> или используя <code>quicklisp</code> и
сконфигурируйте его в файле конфигурации <code>emacs</code> <code>/.emacs.d/init.el</code>
поправив путь к <code>slime</code>:
</p>

<div class="org-src-container">
<pre class="src src-lisp">(setq inferior-lisp-program "sbcl")
(setq slime-lisp-implementations '((sbcl ("sbcl"))))
(setq slime-startup-animation nil)
;; SLIME
(add-to-list 'load-path "~/quicklisp/dists/quicklisp/software/path/to/slime")
(require 'slime)
</pre>
</div>

<p>
Теперь вы готовы писать лисп-код в литературном стиле.
</p>
</div>
</div>
</div>

<div id="outline-container-org316381d" class="outline-2">
<h2 id="org316381d">Как это работает</h2>
<div class="outline-text-2" id="text-org316381d">
<p>
Мне нравится работать в <code>emacs</code> и использовать <code>orgmode</code> для
формирования структурированных документов,
</p>

<p>
Orgmode включает в себя <a href="http://orgmode.org/manual/index.html#toc_Publishing">систему публикации</a>, которая хорошо
конфигурируется. Обычно я просто выполняю из емакса команду
<code>org-publish-all</code>. Емакс осуществляет экспорт всех .org-файлов проекта
в .html, в процессе выполняя директивы в них, такие как
<code>INCLUDE</code>. Настройки экспорта задаются в конфигурации, результат
попадает в папку <code>./www/</code>
</p>

<p>
Тем не менее, мне всегда хотелось большей гибкости,
поэтому я решил взять тот результат, который она производит, построить
из него дерево s-выражений и применить все преобразования, которые мне могут
понадобиться. После этого, преобразованный результат может быть снова
транслирован в html/css/javascript и отображен на сайте.
</p>

<p>
Для того чтобы разбирать HTML-код в LHTML я использую библиотеку
<code>cl-html-parse</code>. Переносимые пути обеспечиваются механизмом трансляции
логических путей.
</p>

<p>
Вебсервер, запущенный на порту 9993, имеет несколько маршрутов,
некоторые из которых связаны с файлами из этой папки. Соответствующий
файл преобразовывется и отдается пользователю.
</p>
</div>
</div>

<div id="outline-container-org242e1a5" class="outline-2">
<h2 id="org242e1a5">Сборка</h2>
<div class="outline-text-2" id="text-org242e1a5">
</div>
<div id="outline-container-orgb9f64d4" class="outline-3">
<h3 id="orgb9f64d4">Файл определения системы</h3>
<div class="outline-text-3" id="text-orgb9f64d4">
<p>
Файл определения системы представляет собой каркас проекта и содержит
в себе определение системы:
</p>
<ul class="org-ul">
<li>библиотеки, от которых зависит система</li>
<li>набор всех файлов, который должны быть загружены в лисп-процесс.</li>
</ul>

<p>
Определение системы экпортируется из литературного исходника в
корневой каталог проекта.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org13dddbe">;;;; &lt;&lt;copyright&gt;&gt;
(asdf:defsystem #:rigidus
  :version      "0.0.3"
  :author       "rigidus &lt;i.am.rigidus@gmail.com&gt;"
  :licence      "AGPLv3"
  :description  "site http://rigidus.ru"
  :depends-on   (#:anaphora
                 #:closer-mop
                 #:cl-ppcre
                 #:cl-base64
                 #:cl-json
                 #:cl-html5-parser
                 #:cl-who
                 #:cl-fad
                 #:optima
                 #:closure-template
                 #:drakma
                 #:restas
                 #:restas-directory-publisher
                 #:split-sequence
                 #:postmodern
                 #:restas
                 #:optima
                 #:fare-quasiquote-extras
                 #:fare-quasiquote-optima)
  :serial       t
  :components   ((:module "src"
                          :serial t
                          :pathname "src"
                          :components ((:static-file "templates.htm")
                                       (:file "prepare")
                                       (:file "defmodule")
                                       (:file "html")
                                       (:file "ext-html")
                                       (:file "orgmode")
                                       (:file "render")
                                       (:file "routes")
                                       (:file "init")
                                       (:static-file "daemon.conf")
                                       (:static-file "daemon.lisp")
                                       (:static-file "daemon.sh")))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd70c252" class="outline-3">
<h3 id="orgd70c252">Подготовка к запуску</h3>
<div class="outline-text-3" id="text-orgd70c252">
<p>
Этот файл компилирует шаблоны и создает пакет <code>TPL</code>. Он делает это еще до объявления
базового пакета. Для того чтобы в процессе загрузки все ссылки на этот пакет были
правильно разрешены, необходимо, чтобы создание пакета завершилось к моменту появления
ссылок на него. А для этого нужно помещать компиляцию в отдельный файл.
</p>

<p>
Однако тогда у нас возникает проблема, заключающаяся в том, что <code>base-dir</code>, путь, от
которого отсчитываются все пути придется объявлять дважды - вне пакета и внутри
него. Мы решаем эту проблему средствами подстановки литературного программирования:
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgb509708">(merge-pathnames
 (make-pathname :directory '(:relative "repo/rigidus.ru"))
 (user-homedir-pathname))
</pre>
</div>


<div class="org-src-container">
<pre class="src src-lisp" id="org93ff01e">;;;; &lt;&lt;copyright&gt;&gt;

(closure-template:compile-template
 :common-lisp-backend (merge-pathnames
                       (make-pathname :name "templates" :type "htm")
                       (merge-pathnames
                        (make-pathname :directory '(:relative "src"))
                        &lt;&lt;base_dir&gt;&gt;)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org318a236" class="outline-3">
<h3 id="org318a236">Определение пакетов</h3>
<div class="outline-text-3" id="text-org318a236">
<p>
Что такое пакет и зачем он нужен лучше всего прочитать <a href="../../doc/packages-in-lisp.html">тут</a>. Обычно
определение пакетов экспортируется в файл <code>src/package.lisp</code>, но этот
проект слишком простой, он содержит всего один пакет. Поэтому
определение пакета происходит в разделе <a href="#org7234533">Определение модуля</a>
</p>
</div>
</div>

<div id="outline-container-org5af6d78" class="outline-3">
<h3 id="org5af6d78">Утилиты</h3>
<div class="outline-text-3" id="text-org5af6d78">
<p>
Несколько маленьких утилитарных функций определены здесь. При экспорте
они подключатся в тот же файл, где происходит определение модуля. Это
функции:
</p>
<ul class="org-ul">
<li>отладочного вывода и ошибок</li>
<li>получения содержимого директории</li>
<li>трансформации дерева, в которое разбирается html из файла</li>
</ul>

<div class="org-src-container">
<pre class="src src-lisp" id="org7ac6187">(in-package :rigidus)

(defmacro bprint (var)
  `(subseq (with-output-to-string (*standard-output*)
             (pprint ,var)) 1))

(defmacro err (var)
  `(error (format nil "ERR:[~A]" (bprint ,var))))

(define-condition pattern-not-found-error (error)
  ((text :initarg :text :reader text)))

(defun extract (cortege html)
  (loop :for (begin end regexp) :in cortege :collect
     (multiple-value-bind (start fin)
         (ppcre:scan regexp html)
       (when (null start)
         (error 'pattern-not-found-error :text regexp))
       (subseq html (+ start begin) (- fin end)))))

(defun get-directory-contents (path)
  "Функция возвращает содержимое каталога"
  (when (not (equal "/" (coerce (last (coerce path 'list)) 'string)))
    (setf path (format nil "~A/" path)))
  (directory (format nil "~A*.*" path)))

(defun maptree-transform (predicate-transformer tree)
  (multiple-value-bind (t-tree control)
      (aif (funcall predicate-transformer tree)
           it
           (values tree #'mapcar))
    (if (and (consp t-tree)
             control)
        (funcall control
                 #'(lambda (x)
                     (maptree-transform predicate-transformer x))
                 t-tree)
        t-tree)))

;; mtm - синтаксический сахар для maptree-transform
(defmacro mtm (transformer tree)
  (let ((lambda-param (gensym)))
    `(maptree-transform #'(lambda (,lambda-param)
                            (values (optima:match ,lambda-param ,transformer)
                                    #'mapcar))
                        ,tree)))

</pre>
</div>
</div>
</div>

<div id="outline-container-orgaaad173" class="outline-3">
<h3 id="orgaaad173">Copyright</h3>
<div class="outline-text-3" id="text-orgaaad173">
<p>
Копирайт вставляется в каждый сгенерированный файл для того чтобы
соблюсти требования лицензии AGPL
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org404220f">Copyright © 2014-2017 Glukhov Mikhail. All rights reserved.
Licensed under the GNU AGPLv3
</pre>
</div>
</div>
</div>

<div id="outline-container-org7234533" class="outline-3">
<h3 id="org7234533">Определение модуля</h3>
<div class="outline-text-3" id="text-org7234533">
<p>
Файл определения модуля экспортируется в каталог src. Во время
экспорта в него включаются утилиты.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgce6c67c">;;;; &lt;&lt;copyright&gt;&gt;
(restas:define-module #:rigidus
  (:use #:closer-mop #:cl #:iter #:alexandria #:anaphora #:postmodern)
  (:shadowing-import-from :closer-mop
                          :defclass
                          :defmethod
                          :standard-class
                          :ensure-generic-function
                          :defgeneric
                          :standard-generic-function
                          :class-name))

(in-package #:rigidus)

;; special syntax for pattern-matching - ON
(named-readtables:in-readtable :fare-quasiquote)

;; Здесь подключаются утилиты
&lt;&lt;utility&gt;&gt;

;; Механизм трансляции путей
&lt;&lt;pathname-translations&gt;&gt;

;; Работа с html tree
&lt;&lt;html_s_tree&gt;&gt;

;; Механизм преобразования страниц
&lt;&lt;enobler&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcc890ed" class="outline-3">
<h3 id="orgcc890ed">Инициализация</h3>
<div class="outline-text-3" id="text-orgcc890ed">
<p>
Эта часть запускает сервер на 9993 порту.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org5724580">;;;; &lt;&lt;copyright&gt;&gt;
(in-package #:rigidus)

;; start
(restas:start '#:rigidus :port 9993)
(restas:debug-mode-on)
;; (restas:debug-mode-off)
(setf hunchentoot:*catch-errors-p* t)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org37ba792" class="outline-2">
<h2 id="org37ba792">Трансляция путей</h2>
<div class="outline-text-2" id="text-org37ba792">
<p>
Трансляция путей производится с помощью встроенного механизма
<code>logical-pathname-translations</code>
</p>

<p>
По-умолчанию считается, что директория, от которой отсчитываются
пути: <code>~/repo/rigidus.ru</code>. Я не стал создавать отдельный
конфигурационный файл для этой информации.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org9314d5b">(in-package :rigidus)

(defparameter *base-dir*
  &lt;&lt;base_dir&gt;&gt;)

(defparameter *base-path* (directory-namestring *base-dir*))

(setf (logical-pathname-translations "org")
      `(("source;*.*"
         ,(concatenate 'string *base-path* "org/*.org"))
        ("publish;*.*"
         ,(concatenate 'string *base-path* "www/*.html"))))

;; (translate-logical-pathname "org:source;articles;about.txt")
;; ;; #P"/home/rigidus/repo/rigidus.ru/org/articles/about.org"
;; (translate-logical-pathname "org:source;articles;emacs;about.txt")
;; ;; #P"/home/rigidus/repo/rigidus.ru/org/articles/emacs/about.org"
;; (translate-logical-pathname "org:publish;articles;about.txt")
;; ;; #P"/home/rigidus/repo/rigidus.ru/www/articles/about.org"
;; (translate-logical-pathname "org:publish;articles;emacs;about.txt")
;; ;; #P"/home/rigidus/repo/rigidus.ru/www/articles/emacs/about.org"
</pre>
</div>
</div>
</div>

<div id="outline-container-org5078432" class="outline-2">
<h2 id="org5078432">Шаблон блоков статистики</h2>
<div class="outline-text-2" id="text-org5078432">
<p>
Это статистика от яндекса, гугла и liveinternet counter
</p>

<p>
[TODO:gmm] - обновить
</p>

<div class="org-src-container">
<pre class="src src-html" id="org20ed472">// -*- mode: closure-template-html; fill-column: 140 -*-

{namespace tpl}

{template stat}

{literal}
 &lt;div style="position:absolute; left:-9999px;"&gt;

    &lt;!--Google Analitics --&gt;
    &lt;script type="text/javascript"&gt;
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-20801780-1']);
        _gaq.push(['_trackPageview']);
        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    &lt;/script&gt;
    &lt;!--Google Analitics --&gt;

    &lt;!--LiveInternet counter--&gt;
    &lt;script type="text/javascript"&gt;
        &lt;!--
             document.write("&lt;a href='http://www.liveinternet.ru/click' "+
             "target=_blank&gt;&lt;img src='//counter.yadro.ru/hit?t24.5;r"+
             escape(document.referrer)+((typeof(screen)=="undefined")?"":
             ";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?
             screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+
             ";h"+escape(document.title.substring(0,80))+";"+Math.random()+
             "' alt='' title='LiveInternet: показано число посетителей за"+
             " сегодня' "+
             "border='0' width='88' height='15'&gt;&lt;\/a&gt;")
    //--&gt;
    &lt;/script&gt;
    &lt;!--/LiveInternet--&gt;


    &lt;!-- Yandex.Metrika informer --&gt;
    &lt;a href="https://metrika.yandex.ru/stat/?id=3701317&amp;amp;from=informer"
    target="_blank" rel="nofollow"&gt;&lt;img src="//bs.yandex.ru/informer/3701317/1_0_9F9F9FFF_7F7F7FFF_0_pageviews"
    style="width:80px; height:15px; border:0;" alt="Яндекс.Метрика" title="Яндекс.Метрика: данные за сегодня (просмотры)"
                                        onclick="try{Ya.Metrika.informer({i:this,id:3701317,lang:'ru'});return false}catch(e){}"/&gt;&lt;/a&gt;
    &lt;!-- /Yandex.Metrika informer --&gt;

    &lt;!-- Yandex.Metrika counter --&gt;
    &lt;script type="text/javascript"&gt;
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter3701317 = new Ya.Metrika({id:3701317,
                        webvisor:true,
                        clickmap:true,
                        trackLinks:true,
                        accurateTrackBounce:true});
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
    &lt;/script&gt;

    &lt;noscript&gt;&lt;div&gt;&lt;img src="//mc.yandex.ru/watch/3701317" style="position:absolute; left:-9999px;" alt="" /&gt;&lt;/div&gt;&lt;/noscript&gt;
    &lt;!-- /Yandex.Metrika counter --&gt;

  &lt;/div&gt;
{/literal}

{/template}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf9cf361" class="outline-2">
<h2 id="orgf9cf361">Html-tree</h2>
<div class="outline-text-2" id="text-orgf9cf361">
<p>
В процессе работы бывает очень полезным представление страницы в виде дерева
s-выражений. Для того чтобы разбирать html в дерево и собирать его обратно используется
парсер из библиотеки <code>html5-parser</code> и простой сборщик, сохраняющий отступы:
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org7f1716a">(in-package :rigidus)

&lt;&lt;html_to_tree&gt;&gt;
&lt;&lt;tree_to_html&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-org578861a" class="outline-3">
<h3 id="org578861a">Парсинг html</h3>
<div class="outline-text-3" id="text-org578861a">
<p>
Разбираем html в дерево s-выражений
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orga9d602d">(in-package :rigidus)

(defun html-to-tree (html)
  ;; (html5-parser:node-to-xmls
  (html5-parser:parse-html5-fragment html :dom :xmls))
</pre>
</div>
</div>
</div>

<div id="outline-container-org550c642" class="outline-3">
<h3 id="org550c642">Сборка в html</h3>
<div class="outline-text-3" id="text-org550c642">
<div class="org-src-container">
<pre class="src src-lisp" id="org3d2fa7b">(in-package :rigidus)

(defun tree-to-html (tree &amp;optional (step 0))
  (macrolet ((indent ()
               `(make-string (* 3 step) :initial-element #\Space)))
    (labels ((paired (subtree)
               (format nil "~A&lt;~A~A&gt;~%~A~4:*~A&lt;/~A&gt;~%"
                       (indent)
                       (car subtree)
                       (format nil "~:[~; ~1:*~{~A~^ ~}~]"
                               (mapcar #'(lambda (attr)
                                           (let ((key (car attr))
                                                 (val (cadr attr)))
                                             (format nil "~A=\"~A\"" key val)))
                                       (cadr subtree)))
                       (format nil "~{~A~}"
                               (progn
                                 (incf step)
                                 (let ((ret (mapcar #'(lambda (x)
                                                        (subtree-to-html x step))
                                                    (cddr subtree))))
                                   (decf step)
                                   ret)))))
             (singled (subtree)
               (format nil "~A&lt;~A~A /&gt;~%"
                       (indent)
                       (car subtree)
                       (format nil "~:[~; ~1:*~{~A~^ ~}~]"
                               (mapcar #'(lambda (attr)
                                           (let ((key (car attr))
                                                 (val (cadr attr)))
                                             (format nil "~A=\"~A\"" key val)))
                                       (cadr subtree)))))
             (subtree-to-html (subtree &amp;optional (step 0))
               (cond ((stringp subtree) (format nil "~A~A~%" (indent) subtree))
                     ((numberp subtree) (format nil "~A~A~%" (indent) subtree))
                     ((listp   subtree)
                      (let ((tag (car subtree)))
                        (cond ((or (equal tag "img")
                                   (equal tag "link")
                                   (equal tag "meta"))  (singled subtree))
                              (t (paired subtree)))))
                     (t (format nil "[:err:~A]" subtree)))))
      (reduce #'(lambda (a b) (concatenate 'string a b))
              (mapcar #'(lambda (x) (subtree-to-html x step))
                      tree)))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgeb843b9" class="outline-2">
<h2 id="orgeb843b9">Преобразование страниц</h2>
<div class="outline-text-2" id="text-orgeb843b9">
<p>
Здесь механизм, который разбирает файлы, строит из них дерево s-выражений и
осуществляет его трансформацию.
</p>

<p>
Я обнаружил определенную проблему с ним, связанную с выводом листингов внутри тега
<code>&lt;pre&gt;&lt;/pre&gt;</code> - из-за отступов, которые формирует <code>tree-to-html</code> сьезжает
форматирование исходного кода. Поэтому, до написания своего парсера, учитывающего эти
аспекты, я закомментировал такую обработку, тем более, что в данный момент
трансформация заключается просто в присоединении шаблона, содержащего трекеры
статистики.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org0e84109">(in-package :rigidus)

(defun enobler (pathname &amp;optional dbg)
  (let* ((file-contents (alexandria:read-file-into-string pathname))
         (onestring (cl-ppcre:regex-replace-all "(\\n|\\s*$)" file-contents (if dbg "" " ")))
         (tree (html-to-tree onestring))
         ;; (inject-css '("link" (("href" "/css/style.css") ("rel" "stylesheet") ("type" "text/css"))))
         ;; (replace-css #'(lambda (in)
         ;;                  (optima:match in
         ;;                    (`("style" (("type" "text/css")) ,_) inject-css))))
         ;; (remove-css (maptree-transform replace-css tree))
         ;; (inject-js '("script" (("src" "scripts.js"))))
         ;; (replace-js  #'(lambda (in)
         ;;                  (optima:match in
         ;;                    (`("script" (("type" "text/javascript")) ,_) inject-js))))
         ;; (remove-js (maptree-transform replace-js remove-css))
         (result tree))
    (if dbg
        result
        (format nil "~A~A~%~A~%~A"
                ;; "&lt;!DOCTYPE html&gt;\n"
                ""
                ;; (tree-to-html result)
                file-contents
                (tpl:stat)
                "  &lt;div id=\"linker\"&gt;&lt;a href=\"/\"&gt;Home&lt;/a&gt;&lt;/div&gt;"
                ))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org2721db4" class="outline-2">
<h2 id="org2721db4">Рендеринг</h2>
<div class="outline-text-2" id="text-org2721db4">
<p>
RESTAS использует концепцию <code>рендера</code> чтобы отделить отображение страницы от ее
маршрута. Нам надо определить рендер для вывода orgmode-страниц:
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org4b54f95">;;;; &lt;&lt;copyright&gt;&gt;
(in-package #:rigidus)

(defclass orgmode-handler () ())

(defmethod restas:render-object ((renderer orgmode-handler) (file pathname))
  ;; NOTE: Оставлено как пример вызова CGI
  ;; (cond
  ;;   ((and (string= (pathname-type file) "cgi"))
  ;;    (hunchentoot-cgi::handle-cgi-script file))
  ;;   (t
  ;;    (call-next-method)))
  (enobler file))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc7de36b" class="outline-2">
<h2 id="orgc7de36b">Маршрутизация</h2>
<div class="outline-text-2" id="text-orgc7de36b">
<p>
Маршрутизация осуществляется средствами библиотеки <code>RESTAS</code>, документация по
которой доступна <a href="http://github.com/archimag/restas/">здесь</a>.
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org01395b9">;;;; &lt;&lt;copyright&gt;&gt;
(in-package #:rigidus)

&lt;&lt;route_static_files&gt;&gt;
&lt;&lt;route_404&gt;&gt;
&lt;&lt;route_robots&gt;&gt;
&lt;&lt;route_orgmode&gt;&gt;
&lt;&lt;route_pages&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-org03c6831" class="outline-3">
<h3 id="org03c6831">Статические файлы</h3>
<div class="outline-text-3" id="text-org03c6831">
<p>
Для всех файлов, которые должны отдаваться "как есть", таких как картинки, скрипты и
стили предусмотрены соответствующие маршруты:
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgf98c94f">(in-package #:rigidus)

(restas:mount-module -css- (#:restas.directory-publisher)
  (:url "/css/")
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname :directory '(:relative "css"))
                    *base-dir*)))

(restas:mount-module -img- (#:restas.directory-publisher)
  (:url "/img/")
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname :directory '(:relative "img"))
                    *base-dir*)))

(restas:mount-module -js- (#:restas.directory-publisher)
  (:url "/js/")
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname :directory '(:relative "js"))
                    *base-dir*)))

(restas:mount-module -resources- (#:restas.directory-publisher)
  (:url "/resources")
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname :directory '(:relative "resources"))
                    *base-dir*)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org0182442" class="outline-3">
<h3 id="org0182442">404 страница</h3>
<div class="outline-text-3" id="text-org0182442">
<p>
Для ненайденных страниц мы определяем страницу с 404 ошибкой.
</p>

<p>
[TODO:gmm] - Сделать ее более функциональной и красивой
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgb3fc9d3">(in-package #:rigidus)

(defparameter *log-404* nil)

(defun page-404 (&amp;optional (title "404 Not Found") (content "Страница не найдена"))
  "404 Not Found")

(restas:define-route not-found-route ("*any")
  (push any *log-404*)
  (restas:abort-route-handler
   (page-404)
   :return-code hunchentoot:+http-not-found+
   :content-type "text/html"))
</pre>
</div>
</div>
</div>

<div id="outline-container-org60b4f5d" class="outline-3">
<h3 id="org60b4f5d">Страница robots.txt</h3>
<div class="outline-text-3" id="text-org60b4f5d">
<p>
Для указаний поисковым краулерам делаем страницу <code>robots.txt</code>
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orgef75d07">(in-package #:rigidus)

(restas:define-route robots ("/robots.txt")
  (format nil "User-agent: *~%Disallow: "))
</pre>
</div>
</div>
</div>

<div id="outline-container-org00ce4f6" class="outline-3">
<h3 id="org00ce4f6">Страницы orgmode</h3>
<div class="outline-text-3" id="text-org00ce4f6">
<p>
Для отображения страниц, экспортированных из orgmode, используется <code>render-method</code>,
который преобразует код страницы перед выдачей пользователю:
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="orga124ca8">(in-package :rigidus)

;; (restas:mount-module -base- (#:restas.directory-publisher)
;;   (:url "/")
;;   (:render-method (make-instance 'orgmode-handler))
;;   (restas.directory-publisher:*directory*
;;    (merge-pathnames (make-pathname :directory '(:relative "www"))
;;                     *base-dir*)))

(restas:mount-module -doc- (#:restas.directory-publisher)
  (:url "/doc")
  (:render-method (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname :directory '(:relative "www/doc"))
                    *base-dir*)))

(restas:mount-module -about- (#:restas.directory-publisher)
  (:url "/about")
  (:render-method (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname :directory '(:relative "www/about"))
                    *base-dir*)))

(restas:mount-module -prj- (#:restas.directory-publisher)
  (:url "/prj")
  (:render-method (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname :directory '(:relative "www/prj"))
                    *base-dir*)))

(restas:mount-module -holy- (#:restas.directory-publisher)
  (:url "/holy")
  (:render-method (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname :directory '(:relative "www/holy"))
                    *base-dir*)))

(restas:mount-module -lrn/asm- (#:restas.directory-publisher)
  (:url "/lrn/asm")
  (:render-method (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname :directory '(:relative "www/lrn/asm"))
                    *base-dir*)))

(restas:mount-module -lrn/forth- (#:restas.directory-publisher)
  (:url "/lrn/forth")
  (:render-method (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname :directory '(:relative "www/lrn/forth"))
                    *base-dir*)))

(restas:mount-module -lrn/lisp- (#:restas.directory-publisher)
  (:url "/lrn/lisp")
  (:render-method (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname :directory '(:relative "www/lrn/lisp"))
                    *base-dir*)))

(restas:mount-module -lrn/java- (#:restas.directory-publisher)
  (:url "/lrn/java")
  (:render-method (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname :directory '(:relative "www/lrn/java"))
                    *base-dir*)))

(restas:mount-module -lrn/crypto- (#:restas.directory-publisher)
  (:url "/lrn/crypto")
  (:render-method (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname :directory '(:relative "www/lrn/crypto"))
                    *base-dir*)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf6b2d86" class="outline-3">
<h3 id="orgf6b2d86">Маршруты страниц</h3>
<div class="outline-text-3" id="text-orgf6b2d86">
<p>
Для всех остальных страниц маршруты определены напрямую, так, чтобы ведомый слэш не
приводил к появляению 404-ой ошибки:
</p>

<div class="org-src-container">
<pre class="src src-lisp" id="org0383c56">(in-package :rigidus)

(restas:define-route index ("/")
  (enobler (translate-logical-pathname "org:publish;index")))

(restas:define-route index.html ("/index.html")
  (enobler (translate-logical-pathname "org:publish;index")))

(defmacro def/route (name param &amp;body body)
  `(progn
     (restas:define-route ,name ,param
       ,@body)
     (restas:define-route
         ,(intern (concatenate 'string (symbol-name name) "/"))
         ,(cons (concatenate 'string (car param) "/") (cdr param))
       ,@body)
     (restas:define-route
         ,(intern (concatenate 'string (symbol-name name) ".html"))
         ,(cons (concatenate 'string (car param) ".html") (cdr param))
       ,@body)))

(def/route research ("research")
  (enobler (translate-logical-pathname "org:publish;research")))

(def/route slides ("slides")
  (enobler (translate-logical-pathname "org:publish;slides")))

(def/route projects ("projects")
  (enobler (translate-logical-pathname "org:publish;projects")))
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
