<!DOCTYPE html>
<html>
<head>
<title>Как сделан сайт rigidus.ru</title>
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="rigidus">
<link href="/css/style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="content">
<h1 class="title">Как сделан сайт rigidus.ru</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#unnumbered-1">О проекте</a></li>
<li><a href="#unnumbered-2">Установка и настройка</a>
<ul>
<li><a href="#unnumbered-3">Легкий старт</a></li>
<li><a href="#unnumbered-4">Инструменты разработки</a></li>
</ul>
</li>
<li><a href="#unnumbered-5">Как это работает</a></li>
<li><a href="#unnumbered-6">Сборка</a>
<ul>
<li><a href="#unnumbered-7">Файл определения системы</a></li>
<li><a href="#unnumbered-8">Подготовка к запуску</a></li>
<li><a href="#unnumbered-9">Определение пакетов</a></li>
<li><a href="#unnumbered-10">Утилиты</a></li>
<li><a href="#unnumbered-11">Copyright</a></li>
<li><a href="#unnumbered-12">Определение модуля</a></li>
<li><a href="#unnumbered-13">Инициализация</a></li>
</ul>
</li>
<li><a href="#unnumbered-14">Трансляция путей</a></li>
<li><a href="#unnumbered-15">Шаблон блоков статистики</a></li>
<li><a href="#unnumbered-16">Html-tree</a>
<ul>
<li><a href="#unnumbered-17">Парсинг html</a></li>
<li><a href="#unnumbered-18">Сборка в html</a></li>
</ul>
</li>
<li><a href="#unnumbered-19">Преобразование страниц</a></li>
<li><a href="#unnumbered-20">Рендеринг</a></li>
<li><a href="#unnumbered-21">Маршрутизация</a>
<ul>
<li><a href="#unnumbered-22">Статические файлы</a></li>
<li><a href="#unnumbered-23">404 страница</a></li>
<li><a href="#unnumbered-24">Страница robots.txt</a></li>
<li><a href="#unnumbered-25">Страницы orgmode</a></li>
<li><a href="#unnumbered-26">Маршруты страниц</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#unnumbered-1">О проекте</a></li>
<li><a href="#unnumbered-2">Установка и настройка</a>
<ul>
<li><a href="#unnumbered-3">Легкий старт</a></li>
<li><a href="#unnumbered-4">Инструменты разработки</a></li>
</ul>
</li>
<li><a href="#unnumbered-5">Как это работает</a></li>
<li><a href="#unnumbered-6">Сборка</a>
<ul>
<li><a href="#unnumbered-7">Файл определения системы</a></li>
<li><a href="#unnumbered-8">Подготовка к запуску</a></li>
<li><a href="#unnumbered-9">Определение пакетов</a></li>
<li><a href="#unnumbered-10">Утилиты</a></li>
<li><a href="#unnumbered-11">Copyright</a></li>
<li><a href="#unnumbered-12">Определение модуля</a></li>
<li><a href="#unnumbered-13">Инициализация</a></li>
</ul>
</li>
<li><a href="#unnumbered-14">Трансляция путей</a></li>
<li><a href="#unnumbered-15">Шаблон блоков статистики</a></li>
<li><a href="#unnumbered-16">Html-tree</a>
<ul>
<li><a href="#unnumbered-17">Парсинг html</a></li>
<li><a href="#unnumbered-18">Сборка в html</a></li>
</ul>
</li>
<li><a href="#unnumbered-19">Преобразование страниц</a></li>
<li><a href="#unnumbered-20">Рендеринг</a></li>
<li><a href="#unnumbered-21">Маршрутизация</a>
<ul>
<li><a href="#unnumbered-22">Статические файлы</a></li>
<li><a href="#unnumbered-23">404 страница</a></li>
<li><a href="#unnumbered-24">Страница robots.txt</a></li>
<li><a href="#unnumbered-25">Страницы orgmode</a></li>
<li><a href="#unnumbered-26">Маршруты страниц</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-unnumbered-1" class="outline-2">
<h2 id="unnumbered-1">О проекте</h2>
<div class="outline-text-2" id="text-unnumbered-1">
<p>
Я делал этот сайт, тренируясь в <a href="../doc/literate-programming.html">литературном программировании</a>.
Литературное программирование (Literate Programming) - методология
программирования и документирования, в которой программа состоит из
прозы на естественном языке вперемежку с макроподстановками и кодом на
языках программирования.
</p>

<p>
Он содержит в себе весь код, который обеспечивает работу сайта и
сделан максимально простым, чтобы служить наглядным введением в
<code>literate programming</code> с использованием <code>lisp</code> и набора инструментов,
реализованного в <code>emacs</code>: <code>org-mode</code>, <code>babel</code> и других.
</p>

<div class="NOTE">
<p>
Вы можете пропустить раздел <b>Установка и настройка</b> и перейти сразу
к разделу <b><a href="#unnumbered-5">Как это работает</a></b>, если вы не собираетесь использовать
эти инструменты прямо сейчас.
</p>

</div>

<p>
Документ ниже является литературным исходником сайта
<a href="http://rigidus.ru">http://rigidus.ru</a>.
</p>

<p>
Сам сайт был изначально создан для сбора редких и интересных
материалов о вычислительных моделях и языках программирования. Позже
он также превратился в занимательное упражнение в реализации
разнообразных программистких концепций.
</p>

<p>
Исходный код открыт по лицензии GNU v.3. Данные, в том числе
руководства и книги, могут иметь свои лицензии.
</p>

<p>
Репозиторий с исходным кодом и историей коммитов доступен на
<a href="https://github.com/rigidus/rigidus.ru">https://github.com/rigidus/rigidus.ru</a>
</p>

<p>
Вы можете делать любые дополнения и предложения в форме
<code>pull-requests</code> и <code>issue</code>.
</p>
</div>
</div>

<div id="outline-container-unnumbered-2" class="outline-2">
<h2 id="unnumbered-2">Установка и настройка</h2>
<div class="outline-text-2" id="text-unnumbered-2">
<p>
Этот сайт работает внутри образа <code>Common Lisp</code> под управлением
веб-сервера <code>hunchentoot</code>. В качестве высокоуровневой библиотеки
используется <a href="https://github.com/archimag/restas">RESTAS</a>, которую написал Андрей Москвитин (archimag).
</p>

<p>
Веб-сервер, библиотеку и все необходимые зависимости лучше всего
установить при помощи менеджера библиотек <a href="http://quicklisp.org">Quicklisp</a>.
</p>

<p>
Чтобы просто запустить сайт и попробовать его в работе, пройдите
раздел "Легкий старт". Все что идет дальше потребуется вам чтобы
обеспечить инструментарий для литературного программирования.
</p>
</div>

<div id="outline-container-unnumbered-3" class="outline-3">
<h3 id="unnumbered-3">Легкий старт</h3>
<div class="outline-text-3" id="text-unnumbered-3">
<p>
Установите <code>git</code> - систему управления версиями, если она еще не
установлена:
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo apt-get install git
</pre>
</div>

<p>
Клонируйте репозиторий проекта:
</p>

<div class="org-src-container">

<pre class="src src-sh">mkdir -p ~/repo
<span style="color: #b0c4de;">cd</span> ~/repo
git clone git@github.com:rigidus/rigidus.ru.git
</pre>
</div>

<p>
Установите <code>sbcl</code> - реализацию Common Lisp
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo apt-get install sbcl
</pre>
</div>

<p>
Установите quicklisp - менеджер библиотек для Common Lisp
</p>

<div class="org-src-container">

<pre class="src src-sh">mkdir -p ~/build
<span style="color: #b0c4de;">cd</span> ~/build
wget https://beta.quicklisp.org/quicklisp.lisp
sbcl --load quicklisp.lisp
</pre>
</div>

<p>
Теперь мы внутри <code>quicklisp</code>-а, работающего в образе <code>sbcl</code>. Попросим
его добавить себя в инициализационный файл, чтобы <code>quicklisp</code>
загружался каждый раз, когда стартует <code>sbcl</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp">(ql:add-to-init-file)
</pre>
</div>

<p>
Выйдите из лиспа:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(quit)
</pre>
</div>

<p>
Откройте файл <code>~/.sbclrc</code> и добавьте в конец файла следующие строки,
чтобы <code>quicklisp</code> знал, где находится репозиторий с сайтом:
</p>

<div class="org-src-container">

<pre class="src src-lisp">#+quicklisp
(mapcar #'(<span style="color: #00ffff;">lambda</span> (x)
            (pushnew x ql:*local-project-directories*))
        (list #P<span style="color: #ffa07a;">"~/repo/rigidus.ru/"</span>))
</pre>
</div>

<p>
Снова запустите <code>sbcl</code>
</p>

<div class="org-src-container">

<pre class="src src-sh">sbcl
</pre>
</div>

<p>
И в нем загрузите сайт:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(ql:quickload <span style="color: #ffa07a;">"rigidus"</span>)
</pre>
</div>

<p>
Наберите в адресной строке броузера <code>http://localhost:9993</code> и
загрузите главную страницу.
</p>

<div class="NOTE">
<p>
Если вы не видите главной страницы, возможно это потому, что
сгенерированные файлы не попадают в репозиторий (так может быть
настроен <code>.gitignore</code>). Если это действительно так - поместите в в
<code>/repo/rigidus.ru/www</code> файл <code>index.html</code> и проверьте, отобразился ли
он в броузере. Вы также можете пройти следующий раздел и
сгенерировать все файлы сайта, используя инструменты из него.
</p>

</div>
</div>
</div>

<div id="outline-container-unnumbered-4" class="outline-3">
<h3 id="unnumbered-4">Инструменты разработки</h3>
<div class="outline-text-3" id="text-unnumbered-4">
<p>
Чтобы настроить инструменты <code>emacs</code> для поддержки литературного
программирования совершите следующие действия:
</p>

<p>
Установите <code>emacs</code>, если он еще не установлен.
</p>

<div class="org-src-container">

<pre class="src src-sh">apt-get install emacs23
</pre>
</div>

<p>
Добавьте в файл конфигурации <code>/.emacs.d/init.el</code> следующие строки, при
необходимости изменив пути к папкам:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">org-custom-link-img-follow</span> (path)
  (org-open-file-with-emacs
   (format <span style="color: #ffa07a;">"../img/%s"</span> path)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">org-custom-link-img-export</span> (path desc format)
  (<span style="color: #00ffff;">cond</span>
    ((eq format 'html)
     (format <span style="color: #ffa07a;">"&lt;img src=\"/img/%s\" alt=\"%s\"/&gt;"</span> path desc))))

(org-add-link-type <span style="color: #ffa07a;">"img"</span> 'org-custom-link-img-follow 'org-custom-link-img-export)

(setq org-export-time-stamp-file nil)
(setq org-publish-project-alist
      '((<span style="color: #ffa07a;">"org-notes"</span>
         <span style="color: #b0c4de;">:base-directory</span> <span style="color: #ffa07a;">"~/repo/rigidus.ru/org/"</span>
         <span style="color: #b0c4de;">:base-extension</span> <span style="color: #ffa07a;">"org"</span>
         <span style="color: #b0c4de;">:publishing-directory</span> <span style="color: #ffa07a;">"~/repo/rigidus.ru/www/"</span>
         <span style="color: #b0c4de;">:recursive</span> t
         <span style="color: #b0c4de;">:publishing-function</span> org-html-publish-to-html
         <span style="color: #b0c4de;">:timestamp</span> nil
         <span style="color: #b0c4de;">:html-doctype</span> <span style="color: #ffa07a;">"html5"</span>
         <span style="color: #b0c4de;">:section-numbers</span> nil
         <span style="color: #b0c4de;">:html-postamble</span> nil
         <span style="color: #b0c4de;">:html-preamble</span> nil
         <span style="color: #b0c4de;">:with-timestamps</span> nil
         <span style="color: #b0c4de;">:timestamp</span> nil
         <span style="color: #b0c4de;">:with-date</span> nil
         <span style="color: #b0c4de;">:html-head-extra</span> <span style="color: #ffa07a;">"&lt;link href=\"/css/style.css\" rel=\"stylesheet\" type=\"text/css\" /&gt;"</span>
         <span style="color: #b0c4de;">:html-head-include-default-style</span> nil
         <span style="color: #b0c4de;">:html-head-include-scripts</span> nil)
        (<span style="color: #ffa07a;">"org-static"</span>
         <span style="color: #b0c4de;">:base-directory</span> <span style="color: #ffa07a;">"~/repo/rigidus.ru/org/"</span>
         <span style="color: #b0c4de;">:base-extension</span> <span style="color: #ffa07a;">"css\\|js\\|png\\|jpg\\|gif\\|pdf\\|djvu"</span>
         <span style="color: #b0c4de;">:publishing-directory</span> <span style="color: #ffa07a;">"~/repo/rigidus.ru/www/"</span>
         <span style="color: #b0c4de;">:recursive</span> t
         <span style="color: #b0c4de;">:publishing-function</span> org-publish-attachment)
        (<span style="color: #ffa07a;">"org"</span>
         <span style="color: #b0c4de;">:components</span> (<span style="color: #ffa07a;">"org-notes"</span> <span style="color: #ffa07a;">"org-static"</span>))))
</pre>
</div>

<p>
Если вы желаете заняться написанием кода на лиспе для этого проекта -
установите <code>slime</code> с <a href="https://common-lisp.net/project/slime/">официального сайта</a> или используя <code>quicklisp</code> и
сконфигурируйте его в файле конфигурации <code>emacs</code> <code>/.emacs.d/init.el</code>
поправив путь к <code>slime</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(setq inferior-lisp-program <span style="color: #ffa07a;">"sbcl"</span>)
(setq slime-lisp-implementations '((sbcl (<span style="color: #ffa07a;">"sbcl"</span>))))
(setq slime-startup-animation nil)
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">SLIME</span>
(add-to-list 'load-path <span style="color: #ffa07a;">"~/quicklisp/dists/quicklisp/software/path/to/slime"</span>)
(<span style="color: #00ffff;">require</span> '<span style="color: #7fffd4;">slime</span>)
</pre>
</div>

<p>
Теперь вы готовы писать лисп-код в литературном стиле.
</p>
</div>
</div>
</div>

<div id="outline-container-unnumbered-5" class="outline-2">
<h2 id="unnumbered-5">Как это работает</h2>
<div class="outline-text-2" id="text-unnumbered-5">
<p>
Мне нравится работать в <code>emacs</code> и использовать <code>orgmode</code> для
формирования структурированных документов,
</p>

<p>
Orgmode включает в себя <a href="http://orgmode.org/manual/index.html#toc_Publishing">систему публикации</a>, которая хорошо
конфигурируется. Обычно я просто выполняю из емакса команду
<code>org-publish-all</code>. Емакс осуществляет экспорт всех .org-файлов проекта
в .html, в процессе выполняя директивы в них, такие как
<code>INCLUDE</code>. Настройки экспорта задаются в конфигурации, результат
попадает в папку <code>./www/</code>
</p>

<p>
Тем не менее, мне всегда хотелось большей гибкости,
поэтому я решил взять тот результат, который она производит, построить
из него дерево s-выражений и применить все преобразования, которые мне могут
понадобиться. После этого, преобразованный результат может быть снова
транслирован в html/css/javascript и отображен на сайте.
</p>

<p>
Для того чтобы разбирать HTML-код в LHTML я использую библиотеку
<code>cl-html-parse</code>. Переносимые пути обеспечиваются механизмом трансляции
логических путей.
</p>

<p>
Вебсервер, запущенный на порту 9993, имеет несколько маршрутов,
некоторые из которых связаны с файлами из этой папки. Соответствующий
файл преобразовывется и отдается пользователю.
</p>
</div>
</div>

<div id="outline-container-unnumbered-6" class="outline-2">
<h2 id="unnumbered-6">Сборка</h2>
<div class="outline-text-2" id="text-unnumbered-6">
</div><div id="outline-container-unnumbered-7" class="outline-3">
<h3 id="unnumbered-7">Файл определения системы</h3>
<div class="outline-text-3" id="text-unnumbered-7">
<p>
Файл определения системы представляет собой каркас проекта и содержит
в себе определение системы:
</p>
<ul class="org-ul">
<li>библиотеки, от которых зависит система
</li>
<li>набор всех файлов, который должны быть загружены в лисп-процесс.
</li>
</ul>

<p>
Определение системы экпортируется из литературного исходника в
корневой каталог проекта.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="defsystem"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(asdf:defsystem #<span style="color: #b0c4de;">:rigidus</span>
  <span style="color: #b0c4de;">:version</span>      <span style="color: #ffa07a;">"0.0.3"</span>
  <span style="color: #b0c4de;">:author</span>       <span style="color: #ffa07a;">"rigidus <a href="mailto:i.am.rigidus%40gmail.com">&lt;i.am.rigidus@gmail.com&gt;</a>"</span>
  <span style="color: #b0c4de;">:licence</span>      <span style="color: #ffa07a;">"AGPLv3"</span>
  <span style="color: #b0c4de;">:description</span>  <span style="color: #ffa07a;">"site http://rigidus.ru"</span>
  <span style="color: #b0c4de;">:depends-on</span>   (#<span style="color: #b0c4de;">:anaphora</span>
                 #<span style="color: #b0c4de;">:closer-mop</span>
                 #<span style="color: #b0c4de;">:cl-ppcre</span>
                 #<span style="color: #b0c4de;">:cl-base64</span>
                 #<span style="color: #b0c4de;">:cl-json</span>
                 #<span style="color: #b0c4de;">:cl-html5-parser</span>
                 #<span style="color: #b0c4de;">:cl-who</span>
                 #<span style="color: #b0c4de;">:cl-fad</span>
                 #<span style="color: #b0c4de;">:optima</span>
                 #<span style="color: #b0c4de;">:closure-template</span>
                 #<span style="color: #b0c4de;">:drakma</span>
                 #<span style="color: #b0c4de;">:restas</span>
                 #<span style="color: #b0c4de;">:restas-directory-publisher</span>
                 #<span style="color: #b0c4de;">:split-sequence</span>
                 #<span style="color: #b0c4de;">:postmodern</span>
                 #<span style="color: #b0c4de;">:restas</span>
                 #<span style="color: #b0c4de;">:optima</span>
                 #<span style="color: #b0c4de;">:fare-quasiquote-extras</span>
                 #<span style="color: #b0c4de;">:fare-quasiquote-optima</span>)
  <span style="color: #b0c4de;">:serial</span>       t
  <span style="color: #b0c4de;">:components</span>   ((<span style="color: #b0c4de;">:module</span> <span style="color: #ffa07a;">"src"</span>
                          <span style="color: #b0c4de;">:serial</span> t
                          <span style="color: #b0c4de;">:pathname</span> <span style="color: #ffa07a;">"src"</span>
                          <span style="color: #b0c4de;">:components</span> ((<span style="color: #b0c4de;">:static-file</span> <span style="color: #ffa07a;">"templates.htm"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"prepare"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"defmodule"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"html"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"ext-html"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"orgmode"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"render"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"routes"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"init"</span>)
                                       (<span style="color: #b0c4de;">:static-file</span> <span style="color: #ffa07a;">"daemon.conf"</span>)
                                       (<span style="color: #b0c4de;">:static-file</span> <span style="color: #ffa07a;">"daemon.lisp"</span>)
                                       (<span style="color: #b0c4de;">:static-file</span> <span style="color: #ffa07a;">"daemon.sh"</span>)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-8" class="outline-3">
<h3 id="unnumbered-8">Подготовка к запуску</h3>
<div class="outline-text-3" id="text-unnumbered-8">
<p>
Этот файл компилирует шаблоны и создает пакет <code>TPL</code>. Он делает это еще до объявления
базового пакета. Для того чтобы в процессе загрузки все ссылки на этот пакет были
правильно разрешены, необходимо, чтобы создание пакета завершилось к моменту появления
ссылок на него. А для этого нужно помещать компиляцию в отдельный файл.
</p>

<p>
Однако тогда у нас возникает проблема, заключающаяся в том, что <code>base-dir</code>, путь, от
которого отсчитываются все пути придется объявлять дважды - вне пакета и внутри
него. Мы решаем эту проблему средствами подстановки литературного программирования:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="base_dir">(merge-pathnames
 (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"repo/rigidus.ru"</span>))
 (user-homedir-pathname))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="prepare"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>

(closure-template:compile-template
 <span style="color: #b0c4de;">:common-lisp-backend</span> (merge-pathnames
                       (make-pathname <span style="color: #b0c4de;">:name</span> <span style="color: #ffa07a;">"templates"</span> <span style="color: #b0c4de;">:type</span> <span style="color: #ffa07a;">"htm"</span>)
                       (merge-pathnames
                        (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"src"</span>))
                        &lt;&lt;base_dir&gt;&gt;)))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-9" class="outline-3">
<h3 id="unnumbered-9">Определение пакетов</h3>
<div class="outline-text-3" id="text-unnumbered-9">
<p>
Что такое пакет и зачем он нужен лучше всего прочитать <a href="doc/packages-in-lisp.html">тут</a>. Обычно
определение пакетов экспортируется в файл <code>src/package.lisp</code>, но этот
проект слишком простой, он содержит всего один пакет. Поэтому
определение пакета происходит в разделе <a href="#unnumbered-12">Определение модуля</a>
</p>
</div>
</div>

<div id="outline-container-unnumbered-10" class="outline-3">
<h3 id="unnumbered-10">Утилиты</h3>
<div class="outline-text-3" id="text-unnumbered-10">
<p>
Несколько маленьких утилитарных функций определены здесь. При экспорте
они подключатся в тот же файл, где происходит определение модуля. Это
функции:
</p>
<ul class="org-ul">
<li>отладочного вывода и ошибок
</li>
<li>получения содержимого директории
</li>
<li>трансформации дерева, в которое разбирается html из файла
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="utility">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:rigidus</span>)

(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">bprint</span> (var)
  `(subseq (<span style="color: #00ffff;">with-output-to-string</span> (*standard-output*)
             (pprint ,var)) <span style="color: #ffc0cb; font-weight: bold;">1))</span>

(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">err</span> (var)
  `(<span style="color: #ffc0cb; font-weight: bold;">error</span> (format nil <span style="color: #ffa07a;">"ERR:[~A]"</span> (bprint ,var))))

(<span style="color: #00ffff;">define-condition</span> <span style="color: #87cefa;">pattern-not-found-error</span> (<span style="color: #ffc0cb; font-weight: bold;">error</span>)
  ((text <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:text</span> <span style="color: #b0c4de;">:reader</span> text)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">extract</span> (cortege html)
  (<span style="color: #00ffff;">loop</span> <span style="color: #b0c4de;">:for</span> (begin end regexp) <span style="color: #b0c4de;">:in</span> cortege <span style="color: #b0c4de;">:collect</span>
     (<span style="color: #00ffff;">multiple-value-bind</span> (start fin)
         (ppcre:scan regexp html)
       (<span style="color: #00ffff;">when</span> (null start)
         (<span style="color: #ffc0cb; font-weight: bold;">error</span> 'pattern-not-found-error <span style="color: #b0c4de;">:text</span> regexp))
       (subseq html (+ start begin) (- fin end)))))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">get-directory-contents</span> (path)
  <span style="color: #ffa07a;">"&#1060;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; &#1089;&#1086;&#1076;&#1077;&#1088;&#1078;&#1080;&#1084;&#1086;&#1077; &#1082;&#1072;&#1090;&#1072;&#1083;&#1086;&#1075;&#1072;"</span>
  (<span style="color: #00ffff;">when</span> (not (equal <span style="color: #ffa07a;">"/"</span> (coerce (last (coerce path 'list)) 'string)))
    (setf path (format nil <span style="color: #ffa07a;">"~A/"</span> path)))
  (directory (format nil <span style="color: #ffa07a;">"~A*.*"</span> path)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">maptree-transform</span> (predicate-transformer tree)
  (<span style="color: #00ffff;">multiple-value-bind</span> (t-tree control)
      (aif (funcall predicate-transformer tree)
           it
           (values tree #'mapcar))
    (<span style="color: #00ffff;">if</span> (and (consp t-tree)
             control)
        (funcall control
                 #'(<span style="color: #00ffff;">lambda</span> (x)
                     (maptree-transform predicate-transformer x))
                 t-tree)
        t-tree)))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">mtm - &#1089;&#1080;&#1085;&#1090;&#1072;&#1082;&#1089;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1089;&#1072;&#1093;&#1072;&#1088; &#1076;&#1083;&#1103; maptree-transform</span>
(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">mtm</span> (transformer tree)
  (<span style="color: #00ffff;">let</span> ((lambda-param (gensym)))
    `(maptree-transform #'(<span style="color: #00ffff;">lambda</span> (,lambda-param)
                            (values (optima:match ,lambda-param ,transformer)
                                    #'mapcar))
                        ,tree)))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-11" class="outline-3">
<h3 id="unnumbered-11">Copyright</h3>
<div class="outline-text-3" id="text-unnumbered-11">
<p>
Копирайт вставляется в каждый сгенерированный файл для того чтобы
соблюсти требования лицензии AGPL
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="copyright">Copyright &#169; 2014-2017 Glukhov Mikhail. All rights reserved.
Licensed under the GNU AGPLv3
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-12" class="outline-3">
<h3 id="unnumbered-12">Определение модуля</h3>
<div class="outline-text-3" id="text-unnumbered-12">
<p>
Файл определения модуля экспортируется в каталог src. Во время
экспорта в него включаются утилиты.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="defmodule"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(restas:define-module #<span style="color: #b0c4de;">:rigidus</span>
  (<span style="color: #b0c4de;">:use</span> #<span style="color: #b0c4de;">:closer-mop</span> #<span style="color: #b0c4de;">:cl</span> #<span style="color: #b0c4de;">:iter</span> #<span style="color: #b0c4de;">:alexandria</span> #<span style="color: #b0c4de;">:anaphora</span> #<span style="color: #b0c4de;">:postmodern</span>)
  (<span style="color: #b0c4de;">:shadowing-import-from</span> <span style="color: #b0c4de;">:closer-mop</span>
                          <span style="color: #b0c4de;">:defclass</span>
                          <span style="color: #b0c4de;">:defmethod</span>
                          <span style="color: #b0c4de;">:standard-class</span>
                          <span style="color: #b0c4de;">:ensure-generic-function</span>
                          <span style="color: #b0c4de;">:defgeneric</span>
                          <span style="color: #b0c4de;">:standard-generic-function</span>
                          <span style="color: #b0c4de;">:class-name</span>))

(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:rigidus</span>)

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">special syntax for pattern-matching - ON</span>
(named-readtables:in-readtable <span style="color: #b0c4de;">:fare-quasiquote</span>)

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1047;&#1076;&#1077;&#1089;&#1100; &#1087;&#1086;&#1076;&#1082;&#1083;&#1102;&#1095;&#1072;&#1102;&#1090;&#1089;&#1103; &#1091;&#1090;&#1080;&#1083;&#1080;&#1090;&#1099;</span>
&lt;&lt;utility&gt;&gt;

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1052;&#1077;&#1093;&#1072;&#1085;&#1080;&#1079;&#1084; &#1090;&#1088;&#1072;&#1085;&#1089;&#1083;&#1103;&#1094;&#1080;&#1080; &#1087;&#1091;&#1090;&#1077;&#1081;</span>
&lt;&lt;pathname-translations&gt;&gt;

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1056;&#1072;&#1073;&#1086;&#1090;&#1072; &#1089; html tree</span>
&lt;&lt;html_s_tree&gt;&gt;

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1052;&#1077;&#1093;&#1072;&#1085;&#1080;&#1079;&#1084; &#1087;&#1088;&#1077;&#1086;&#1073;&#1088;&#1072;&#1079;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;</span>
&lt;&lt;enobler&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-13" class="outline-3">
<h3 id="unnumbered-13">Инициализация</h3>
<div class="outline-text-3" id="text-unnumbered-13">
<p>
Эта часть запускает сервер на 9993 порту.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="init"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:rigidus</span>)

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">start</span>
(restas:start '#<span style="color: #b0c4de;">:rigidus</span> <span style="color: #b0c4de;">:port</span> 9993)
(restas:debug-mode-on)
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(restas:debug-mode-off)</span>
(setf hunchentoot:*catch-errors-p* t)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-unnumbered-14" class="outline-2">
<h2 id="unnumbered-14">Трансляция путей</h2>
<div class="outline-text-2" id="text-unnumbered-14">
<p>
Трансляция путей производится с помощью встроенного механизма
<code>logical-pathname-translations</code>
</p>

<p>
По-умолчанию считается, что директория, от которой отсчитываются
пути: <code>~/repo/rigidus.ru</code>. Я не стал создавать отдельный
конфигурационный файл для этой информации.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="pathname-translations">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:rigidus</span>)

(<span style="color: #00ffff;">defparameter</span> <span style="color: #eedd82;">*base-dir*</span>
  &lt;&lt;base_dir&gt;&gt;)

(<span style="color: #00ffff;">defparameter</span> <span style="color: #eedd82;">*base-path*</span> (directory-namestring *base-dir*))

(setf (logical-pathname-translations <span style="color: #ffa07a;">"org"</span>)
      `((<span style="color: #ffa07a;">"source;*.*"</span>
         ,(concatenate 'string *base-path* <span style="color: #ffa07a;">"org/*.org"</span>))
        (<span style="color: #ffa07a;">"publish;*.*"</span>
         ,(concatenate 'string *base-path* <span style="color: #ffa07a;">"www/*.html"</span>))))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(translate-logical-pathname "org:source;articles;about.txt")</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">;; #P"/home/rigidus/repo/rigidus.ru/org/articles/about.org"</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(translate-logical-pathname "org:source;articles;emacs;about.txt")</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">;; #P"/home/rigidus/repo/rigidus.ru/org/articles/emacs/about.org"</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(translate-logical-pathname "org:publish;articles;about.txt")</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">;; #P"/home/rigidus/repo/rigidus.ru/www/articles/about.org"</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(translate-logical-pathname "org:publish;articles;emacs;about.txt")</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">;; #P"/home/rigidus/repo/rigidus.ru/www/articles/emacs/about.org"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-15" class="outline-2">
<h2 id="unnumbered-15">Шаблон блоков статистики</h2>
<div class="outline-text-2" id="text-unnumbered-15">
<p>
Это статистика от яндекса, гугла и liveinternet counter
</p>

<p>
[TODO:gmm] - обновить
</p>

<div class="org-src-container">

<pre class="src src-html" id="tpl_stat">// -*- mode: closure-template-html; fill-column: 140 -*-

{namespace tpl}

{template stat}

{literal}
 &lt;<span style="color: #87cefa;">div</span> <span style="color: #eedd82;">style</span>=<span style="color: #ffa07a;">"position:absolute; left:-9999px;"</span>&gt;

    <span style="color: #ff7f24;">&lt;!--</span><span style="color: #ff7f24;">Google Analitics </span><span style="color: #ff7f24;">--&gt;</span>
    &lt;<span style="color: #87cefa;">script</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">"text/javascript"</span>&gt;
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-20801780-1']);
        _gaq.push(['_trackPageview']);
        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    &lt;/<span style="color: #87cefa;">script</span>&gt;
    <span style="color: #ff7f24;">&lt;!--</span><span style="color: #ff7f24;">Google Analitics </span><span style="color: #ff7f24;">--&gt;</span>

    <span style="color: #ff7f24;">&lt;!--</span><span style="color: #ff7f24;">LiveInternet counter</span><span style="color: #ff7f24;">--&gt;</span>
    &lt;<span style="color: #87cefa;">script</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">"text/javascript"</span>&gt;
        <span style="color: #ff7f24;">&lt;!--</span>
<span style="color: #ff7f24;">             document.write("&lt;a href='http://www.liveinternet.ru/click' "+</span>
<span style="color: #ff7f24;">             "target=_blank&gt;&lt;img src='//counter.yadro.ru/hit?t24.5;r"+</span>
<span style="color: #ff7f24;">             escape(document.referrer)+((typeof(screen)=="undefined")?"":</span>
<span style="color: #ff7f24;">             ";s"+screen.width+"*"+screen.height+"*"+(screen.colorDepth?</span>
<span style="color: #ff7f24;">             screen.colorDepth:screen.pixelDepth))+";u"+escape(document.URL)+</span>
<span style="color: #ff7f24;">             ";h"+escape(document.title.substring(0,80))+";"+Math.random()+</span>
<span style="color: #ff7f24;">             "' alt='' title='LiveInternet: &#1087;&#1086;&#1082;&#1072;&#1079;&#1072;&#1085;&#1086; &#1095;&#1080;&#1089;&#1083;&#1086; &#1087;&#1086;&#1089;&#1077;&#1090;&#1080;&#1090;&#1077;&#1083;&#1077;&#1081; &#1079;&#1072;"+</span>
<span style="color: #ff7f24;">             " &#1089;&#1077;&#1075;&#1086;&#1076;&#1085;&#1103;' "+</span>
<span style="color: #ff7f24;">             "border='0' width='88' height='15'&gt;&lt;\/a&gt;")</span>
<span style="color: #ff7f24;">    //</span><span style="color: #ff7f24;">--&gt;</span>
    &lt;/<span style="color: #87cefa;">script</span>&gt;
    <span style="color: #ff7f24;">&lt;!--</span><span style="color: #ff7f24;">/LiveInternet</span><span style="color: #ff7f24;">--&gt;</span>


    <span style="color: #ff7f24;">&lt;!-- </span><span style="color: #ff7f24;">Yandex.Metrika informer </span><span style="color: #ff7f24;">--&gt;</span>
    &lt;<span style="color: #87cefa;">a</span> <span style="color: #eedd82;">href</span>=<span style="color: #ffa07a;">"https://metrika.yandex.ru/stat/?id=3701317&amp;amp;from=informer"</span>
    <span style="color: #eedd82;">target</span>=<span style="color: #ffa07a;">"_blank"</span> <span style="color: #eedd82;">rel</span>=<span style="color: #ffa07a;">"nofollow"</span>&gt;&lt;<span style="color: #87cefa;">img</span> <span style="color: #eedd82;">src</span>=<span style="color: #ffa07a;">"//bs.yandex.ru/informer/3701317/1_0_9F9F9FFF_7F7F7FFF_0_pageviews"</span>
    <span style="color: #eedd82;">style</span>=<span style="color: #ffa07a;">"width:80px; height:15px; border:0;"</span> <span style="color: #eedd82;">alt</span>=<span style="color: #ffa07a;">"&#1071;&#1085;&#1076;&#1077;&#1082;&#1089;.&#1052;&#1077;&#1090;&#1088;&#1080;&#1082;&#1072;"</span> <span style="color: #eedd82;">title</span>=<span style="color: #ffa07a;">"&#1071;&#1085;&#1076;&#1077;&#1082;&#1089;.&#1052;&#1077;&#1090;&#1088;&#1080;&#1082;&#1072;: &#1076;&#1072;&#1085;&#1085;&#1099;&#1077; &#1079;&#1072; &#1089;&#1077;&#1075;&#1086;&#1076;&#1085;&#1103; (&#1087;&#1088;&#1086;&#1089;&#1084;&#1086;&#1090;&#1088;&#1099;)"</span>
                                        <span style="color: #eedd82;">onclick</span>=<span style="color: #ffa07a;">"try{Ya.Metrika.informer({i:this,id:3701317,lang:'ru'});return false}catch(e){}"</span>/&gt;&lt;/<span style="color: #87cefa;">a</span>&gt;
    <span style="color: #ff7f24;">&lt;!-- </span><span style="color: #ff7f24;">/Yandex.Metrika informer </span><span style="color: #ff7f24;">--&gt;</span>

    <span style="color: #ff7f24;">&lt;!-- </span><span style="color: #ff7f24;">Yandex.Metrika counter </span><span style="color: #ff7f24;">--&gt;</span>
    &lt;<span style="color: #87cefa;">script</span> <span style="color: #eedd82;">type</span>=<span style="color: #ffa07a;">"text/javascript"</span>&gt;
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter3701317 = new Ya.Metrika({id:3701317,
                        webvisor:true,
                        clickmap:true,
                        trackLinks:true,
                        accurateTrackBounce:true});
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
    &lt;/<span style="color: #87cefa;">script</span>&gt;

    &lt;<span style="color: #87cefa;">noscript</span>&gt;&lt;<span style="color: #87cefa;">div</span>&gt;&lt;<span style="color: #87cefa;">img</span> <span style="color: #eedd82;">src</span>=<span style="color: #ffa07a;">"//mc.yandex.ru/watch/3701317"</span> <span style="color: #eedd82;">style</span>=<span style="color: #ffa07a;">"position:absolute; left:-9999px;"</span> <span style="color: #eedd82;">alt</span>=<span style="color: #ffa07a;">""</span> /&gt;&lt;/<span style="color: #87cefa;">div</span>&gt;&lt;/<span style="color: #87cefa;">noscript</span>&gt;
    <span style="color: #ff7f24;">&lt;!-- </span><span style="color: #ff7f24;">/Yandex.Metrika counter </span><span style="color: #ff7f24;">--&gt;</span>

  &lt;/<span style="color: #87cefa;">div</span>&gt;
{/literal}

{/template}
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-16" class="outline-2">
<h2 id="unnumbered-16">Html-tree</h2>
<div class="outline-text-2" id="text-unnumbered-16">
<p>
В процессе работы бывает очень полезным представление страницы в виде дерева
s-выражений. Для того чтобы разбирать html в дерево и собирать его обратно используется
парсер из библиотеки <code>html5-parser</code> и простой сборщик, сохраняющий отступы:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="html_s_tree">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:rigidus</span>)

&lt;&lt;html_to_tree&gt;&gt;
&lt;&lt;tree_to_html&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-unnumbered-17" class="outline-3">
<h3 id="unnumbered-17">Парсинг html</h3>
<div class="outline-text-3" id="text-unnumbered-17">
<p>
Разбираем html в дерево s-выражений
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="html_to_tree">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:rigidus</span>)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">html-to-tree</span> (html)
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(html5-parser:node-to-xmls</span>
  (html5-parser:parse-html5-fragment html <span style="color: #b0c4de;">:dom</span> <span style="color: #b0c4de;">:xmls</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-18" class="outline-3">
<h3 id="unnumbered-18">Сборка в html</h3>
<div class="outline-text-3" id="text-unnumbered-18">
<div class="org-src-container">

<pre class="src src-lisp" id="tree_to_html">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:rigidus</span>)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">tree-to-html</span> (tree <span style="color: #98fb98;">&amp;optional</span> (step 0))
  (<span style="color: #00ffff;">macrolet</span> ((indent ()
               `(make-string (* 3 step) <span style="color: #b0c4de;">:initial-element</span> #\Space)))
    (<span style="color: #00ffff;">labels</span> ((paired (subtree)
               (format nil <span style="color: #ffa07a;">"~A&lt;~A~A&gt;~%~A~4:*~A&lt;/~A&gt;~%"</span>
                       (indent)
                       (car subtree)
                       (format nil <span style="color: #ffa07a;">"~:[~; ~1:*~{~A~^ ~}~]"</span>
                               (mapcar #'(<span style="color: #00ffff;">lambda</span> (attr)
                                           (<span style="color: #00ffff;">let</span> ((key (car attr))
                                                 (val (cadr attr)))
                                             (format nil <span style="color: #ffa07a;">"~A=\"~A\""</span> key val)))
                                       (cadr subtree)))
                       (format nil <span style="color: #ffa07a;">"~{~A~}"</span>
                               (<span style="color: #00ffff;">progn</span>
                                 (incf step)
                                 (<span style="color: #00ffff;">let</span> ((ret (mapcar #'(<span style="color: #00ffff;">lambda</span> (x)
                                                        (subtree-to-html x step))
                                                    (cddr subtree))))
                                   (decf step)
                                   ret)))))
             (singled (subtree)
               (format nil <span style="color: #ffa07a;">"~A&lt;~A~A /&gt;~%"</span>
                       (indent)
                       (car subtree)
                       (format nil <span style="color: #ffa07a;">"~:[~; ~1:*~{~A~^ ~}~]"</span>
                               (mapcar #'(<span style="color: #00ffff;">lambda</span> (attr)
                                           (<span style="color: #00ffff;">let</span> ((key (car attr))
                                                 (val (cadr attr)))
                                             (format nil <span style="color: #ffa07a;">"~A=\"~A\""</span> key val)))
                                       (cadr subtree)))))
             (subtree-to-html (subtree <span style="color: #98fb98;">&amp;optional</span> (step 0))
               (<span style="color: #00ffff;">cond</span> ((stringp subtree) (format nil <span style="color: #ffa07a;">"~A~A~%"</span> (indent) subtree))
                     ((numberp subtree) (format nil <span style="color: #ffa07a;">"~A~A~%"</span> (indent) subtree))
                     ((listp   subtree)
                      (<span style="color: #00ffff;">let</span> ((tag (car subtree)))
                        (<span style="color: #00ffff;">cond</span> ((or (equal tag <span style="color: #ffa07a;">"img"</span>)
                                   (equal tag <span style="color: #ffa07a;">"link"</span>)
                                   (equal tag <span style="color: #ffa07a;">"meta"</span>))  <span style="color: #ffc0cb; font-weight: bold;">(singled subtree))</span>
                              (t (paired subtree)))))
                     (t (format nil <span style="color: #ffa07a;">"[:err:~A]"</span> subtree)))))
      (reduce #'(<span style="color: #00ffff;">lambda</span> (a b) (concatenate 'string a b))
              (mapcar #'(<span style="color: #00ffff;">lambda</span> (x) (subtree-to-html x step))
                      tree)))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-unnumbered-19" class="outline-2">
<h2 id="unnumbered-19">Преобразование страниц</h2>
<div class="outline-text-2" id="text-unnumbered-19">
<p>
Здесь механизм, который разбирает файлы, строит из них дерево s-выражений и
осуществляет его трансформацию.
</p>

<p>
Я обнаружил определенную проблему с ним, связанную с выводом листингов внутри тега
<code>&lt;pre&gt;&lt;/pre&gt;</code> - из-за отступов, которые формирует <code>tree-to-html</code> сьезжает
форматирование исходного кода. Поэтому, до написания своего парсера, учитывающего эти
аспекты, я закомментировал такую обработку, тем более, что в данный момент
трансформация заключается просто в присоединении шаблона, содержащего трекеры
статистики.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="enobler">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:rigidus</span>)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">enobler</span> (pathname <span style="color: #98fb98;">&amp;optional</span> dbg)
  (<span style="color: #00ffff;">let*</span> ((file-contents (alexandria:read-file-into-string pathname))
         (onestring (cl-ppcre:regex-replace-all <span style="color: #ffa07a;">"(\\n|\\s*$)"</span> file-contents (<span style="color: #00ffff;">if</span> dbg <span style="color: #ffa07a;">""</span> <span style="color: #ffa07a;">" "</span>)))
         (tree (html-to-tree onestring))
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(inject-css '("link" (("href" "/css/style.css") ("rel" "stylesheet") ("type" "text/css"))))</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(replace-css #'(lambda (in)</span>
         <span style="color: #ff7f24;">;;                  </span><span style="color: #ff7f24;">(optima:match in</span>
         <span style="color: #ff7f24;">;;                    </span><span style="color: #ff7f24;">(`("style" (("type" "text/css")) ,_) inject-css))))</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(remove-css (maptree-transform replace-css tree))</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(inject-js '("script" (("src" "scripts.js"))))</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(replace-js  #'(lambda (in)</span>
         <span style="color: #ff7f24;">;;                  </span><span style="color: #ff7f24;">(optima:match in</span>
         <span style="color: #ff7f24;">;;                    </span><span style="color: #ff7f24;">(`("script" (("type" "text/javascript")) ,_) inject-js))))</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(remove-js (maptree-transform replace-js remove-css))</span>
         (result tree))
    (<span style="color: #00ffff;">if</span> dbg
        result
        (format nil <span style="color: #ffa07a;">"~A~A~%~A~%~A"</span>
                <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">"&lt;!DOCTYPE html&gt;\n"</span>
                <span style="color: #ffa07a;">""</span>
                <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(tree-to-html result)</span>
                file-contents
                (tpl:stat)
                <span style="color: #ffa07a;">"  &lt;div id=\"linker\"&gt;&lt;a href=\"/\"&gt;Home&lt;/a&gt;&lt;/div&gt;"</span>
                ))))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-20" class="outline-2">
<h2 id="unnumbered-20">Рендеринг</h2>
<div class="outline-text-2" id="text-unnumbered-20">
<p>
RESTAS использует концепцию <code>рендера</code> чтобы отделить отображение страницы от ее
маршрута. Нам надо определить рендер для вывода orgmode-страниц:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="render"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:rigidus</span>)

(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">orgmode-handler</span> () ())

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">restas:render-object</span> ((renderer orgmode-handler) (file pathname))
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">NOTE: &#1054;&#1089;&#1090;&#1072;&#1074;&#1083;&#1077;&#1085;&#1086; &#1082;&#1072;&#1082; &#1087;&#1088;&#1080;&#1084;&#1077;&#1088; &#1074;&#1099;&#1079;&#1086;&#1074;&#1072; CGI</span>
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(cond</span>
  <span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">((and (string= (pathname-type file) "cgi"))</span>
  <span style="color: #ff7f24;">;;    </span><span style="color: #ff7f24;">(hunchentoot-cgi::handle-cgi-script file))</span>
  <span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(t</span>
  <span style="color: #ff7f24;">;;    </span><span style="color: #ff7f24;">(call-next-method)))</span>
  (enobler file))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-21" class="outline-2">
<h2 id="unnumbered-21">Маршрутизация</h2>
<div class="outline-text-2" id="text-unnumbered-21">
<p>
Маршрутизация осуществляется средствами библиотеки <code>RESTAS</code>, документация по
которой доступна <a href="http://github.com/archimag/restas/">здесь</a>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="routes"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:rigidus</span>)

&lt;&lt;route_static_files&gt;&gt;
&lt;&lt;route_404&gt;&gt;
&lt;&lt;route_robots&gt;&gt;
&lt;&lt;route_orgmode&gt;&gt;
&lt;&lt;route_pages&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-unnumbered-22" class="outline-3">
<h3 id="unnumbered-22">Статические файлы</h3>
<div class="outline-text-3" id="text-unnumbered-22">
<p>
Для всех файлов, которые должны отдаваться "как есть", таких как картинки, скрипты и
стили предусмотрены соответствующие маршруты:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_static_files">(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:rigidus</span>)

(restas:mount-module -css- (#<span style="color: #b0c4de;">:restas.directory-publisher</span>)
  (<span style="color: #b0c4de;">:url</span> <span style="color: #ffa07a;">"/css/"</span>)
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"css"</span>))
                    *base-dir*)))

(restas:mount-module -img- (#<span style="color: #b0c4de;">:restas.directory-publisher</span>)
  (<span style="color: #b0c4de;">:url</span> <span style="color: #ffa07a;">"/img/"</span>)
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"img"</span>))
                    *base-dir*)))

(restas:mount-module -js- (#<span style="color: #b0c4de;">:restas.directory-publisher</span>)
  (<span style="color: #b0c4de;">:url</span> <span style="color: #ffa07a;">"/js/"</span>)
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"js"</span>))
                    *base-dir*)))

(restas:mount-module -resources- (#<span style="color: #b0c4de;">:restas.directory-publisher</span>)
  (<span style="color: #b0c4de;">:url</span> <span style="color: #ffa07a;">"/resources"</span>)
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"resources"</span>))
                    *base-dir*)))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-23" class="outline-3">
<h3 id="unnumbered-23">404 страница</h3>
<div class="outline-text-3" id="text-unnumbered-23">
<p>
Для ненайденных страниц мы определяем страницу с 404 ошибкой.
</p>

<p>
[TODO:gmm] - Сделать ее более функциональной и красивой
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_404">(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:rigidus</span>)

(<span style="color: #00ffff;">defparameter</span> <span style="color: #eedd82;">*log-404*</span> nil)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">page-404</span> (<span style="color: #98fb98;">&amp;optional</span> (title <span style="color: #ffa07a;">"404 Not Found"</span>) (content <span style="color: #ffa07a;">"&#1057;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1072; &#1085;&#1077; &#1085;&#1072;&#1081;&#1076;&#1077;&#1085;&#1072;"</span>))
  <span style="color: #ffa07a;">"404 Not Found"</span>)

(restas:define-route not-found-route (<span style="color: #ffa07a;">"*any"</span>)
  (push any *log-404*)
  (restas:abort-route-handler
   (page-404)
   <span style="color: #b0c4de;">:return-code</span> hunchentoot:+http-not-found+
   <span style="color: #b0c4de;">:content-type</span> <span style="color: #ffa07a;">"text/html"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-24" class="outline-3">
<h3 id="unnumbered-24">Страница robots.txt</h3>
<div class="outline-text-3" id="text-unnumbered-24">
<p>
Для указаний поисковым краулерам делаем страницу <code>robots.txt</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_robots">(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:rigidus</span>)

(restas:define-route robots (<span style="color: #ffa07a;">"/robots.txt"</span>)
  (format nil <span style="color: #ffa07a;">"User-agent: *~%Disallow: "</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-25" class="outline-3">
<h3 id="unnumbered-25">Страницы orgmode</h3>
<div class="outline-text-3" id="text-unnumbered-25">
<p>
Для отображения страниц, экспортированных из orgmode, используется <code>render-method</code>,
который преобразует код страницы перед выдачей пользователю:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_orgmode">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:rigidus</span>)

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(restas:mount-module -base- (#:restas.directory-publisher)</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(:url "/")</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(:render-method (make-instance 'orgmode-handler))</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(restas.directory-publisher:*directory*</span>
<span style="color: #ff7f24;">;;    </span><span style="color: #ff7f24;">(merge-pathnames (make-pathname :directory '(:relative "www"))</span>
<span style="color: #ff7f24;">;;                     </span><span style="color: #ff7f24;">*base-dir*)))</span>

(restas:mount-module -doc- (#<span style="color: #b0c4de;">:restas.directory-publisher</span>)
  (<span style="color: #b0c4de;">:url</span> <span style="color: #ffa07a;">"/doc"</span>)
  (<span style="color: #b0c4de;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"www/doc"</span>))
                    *base-dir*)))

(restas:mount-module -about- (#<span style="color: #b0c4de;">:restas.directory-publisher</span>)
  (<span style="color: #b0c4de;">:url</span> <span style="color: #ffa07a;">"/about"</span>)
  (<span style="color: #b0c4de;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"www/about"</span>))
                    *base-dir*)))

(restas:mount-module -prj- (#<span style="color: #b0c4de;">:restas.directory-publisher</span>)
  (<span style="color: #b0c4de;">:url</span> <span style="color: #ffa07a;">"/prj"</span>)
  (<span style="color: #b0c4de;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"www/prj"</span>))
                    *base-dir*)))

(restas:mount-module -holy- (#<span style="color: #b0c4de;">:restas.directory-publisher</span>)
  (<span style="color: #b0c4de;">:url</span> <span style="color: #ffa07a;">"/holy"</span>)
  (<span style="color: #b0c4de;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"www/holy"</span>))
                    *base-dir*)))

(restas:mount-module -lrn/asm- (#<span style="color: #b0c4de;">:restas.directory-publisher</span>)
  (<span style="color: #b0c4de;">:url</span> <span style="color: #ffa07a;">"/lrn/asm"</span>)
  (<span style="color: #b0c4de;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"www/lrn/asm"</span>))
                    *base-dir*)))

(restas:mount-module -lrn/forth- (#<span style="color: #b0c4de;">:restas.directory-publisher</span>)
  (<span style="color: #b0c4de;">:url</span> <span style="color: #ffa07a;">"/lrn/forth"</span>)
  (<span style="color: #b0c4de;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"www/lrn/forth"</span>))
                    *base-dir*)))

(restas:mount-module -lrn/lisp- (#<span style="color: #b0c4de;">:restas.directory-publisher</span>)
  (<span style="color: #b0c4de;">:url</span> <span style="color: #ffa07a;">"/lrn/lisp"</span>)
  (<span style="color: #b0c4de;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"www/lrn/lisp"</span>))
                    *base-dir*)))

(restas:mount-module -lrn/java- (#<span style="color: #b0c4de;">:restas.directory-publisher</span>)
  (<span style="color: #b0c4de;">:url</span> <span style="color: #ffa07a;">"/lrn/java"</span>)
  (<span style="color: #b0c4de;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"www/lrn/java"</span>))
                    *base-dir*)))

(restas:mount-module -lrn/crypto- (#<span style="color: #b0c4de;">:restas.directory-publisher</span>)
  (<span style="color: #b0c4de;">:url</span> <span style="color: #ffa07a;">"/lrn/crypto"</span>)
  (<span style="color: #b0c4de;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"www/lrn/crypto"</span>))
                    *base-dir*)))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-26" class="outline-3">
<h3 id="unnumbered-26">Маршруты страниц</h3>
<div class="outline-text-3" id="text-unnumbered-26">
<p>
Для всех остальных страниц маршруты определены напрямую, так, чтобы ведомый слэш не
приводил к появляению 404-ой ошибки:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_pages">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:rigidus</span>)

(restas:define-route index (<span style="color: #ffa07a;">"/"</span>)
  (enobler (translate-logical-pathname <span style="color: #ffa07a;">"org:publish;index"</span>)))

(restas:define-route index.html (<span style="color: #ffa07a;">"/index.html"</span>)
  (enobler (translate-logical-pathname <span style="color: #ffa07a;">"org:publish;index"</span>)))

(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">def/route</span> (name param <span style="color: #98fb98;">&amp;body</span> body)
  `(<span style="color: #00ffff;">progn</span>
     (restas:define-route ,name ,param
       ,@body)
     (restas:define-route
         ,(intern (concatenate 'string (symbol-name name) <span style="color: #ffa07a;">"/"</span>))
         ,(cons (concatenate 'string (car param) <span style="color: #ffa07a;">"/"</span>) (cdr param))
       ,@body)
     (restas:define-route
         ,(intern (concatenate 'string (symbol-name name) <span style="color: #ffa07a;">".html"</span>))
         ,(cons (concatenate 'string (car param) <span style="color: #ffa07a;">".html"</span>) (cdr param))
       ,@body)))

(def/route research (<span style="color: #ffa07a;">"research"</span>)
  (enobler (translate-logical-pathname <span style="color: #ffa07a;">"org:publish;research"</span>)))

(def/route slides (<span style="color: #ffa07a;">"slides"</span>)
  (enobler (translate-logical-pathname <span style="color: #ffa07a;">"org:publish;slides"</span>)))

(def/route projects (<span style="color: #ffa07a;">"projects"</span>)
  (enobler (translate-logical-pathname <span style="color: #ffa07a;">"org:publish;projects"</span>)))
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
