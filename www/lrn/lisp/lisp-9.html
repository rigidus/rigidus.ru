<!DOCTYPE html>
<html>
<head>
<title>lisp-9</title>
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="rigidus">
<link href="/css/style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="content">
<h1 class="title">lisp-9</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">План работ</a></li>
<li><a href="#sec-2">Глобальное окружение</a></li>
<li><a href="#sec-3">Функции для тестирования</a></li>
<li><a href="#sec-4">Структура замыкания</a></li>
<li><a href="#sec-5">Структура UNICONT</a></li>
<li><a href="#sec-6">Применение продолжений</a></li>
<li><a href="#sec-7">MyApply</a>
<ul>
<li><a href="#sec-7-1">Работа с CONS-ячейками</a></li>
<li><a href="#sec-7-2">NULL-предикат</a></li>
<li><a href="#sec-7-3">Встроенные функции арифметики</a></li>
<li><a href="#sec-7-4">CLOSURE</a></li>
<li><a href="#sec-7-5">PRINT</a></li>
<li><a href="#sec-7-6">LIST</a></li>
<li><a href="#sec-7-7">CALL/CC</a></li>
</ul>
</li>
<li><a href="#sec-8">MyEval</a>
<ul>
<li><a href="#sec-8-1">Самовычисляемые формы</a></li>
<li><a href="#sec-8-2">Вычисление символов</a></li>
<li><a href="#sec-8-3">Цитирование</a></li>
<li><a href="#sec-8-4">Условное выполнение IF</a></li>
<li><a href="#sec-8-5">COND</a></li>
<li><a href="#sec-8-6">PROGN</a></li>
<li><a href="#sec-8-7">AND</a></li>
<li><a href="#sec-8-8">OR</a></li>
<li><a href="#sec-8-9">LET</a></li>
<li><a href="#sec-8-10">LET*</a></li>
<li><a href="#sec-8-11">DEFUN</a></li>
<li><a href="#sec-8-12">SETQ</a></li>
<li><a href="#sec-8-13">LAMBDA</a></li>
<li><a href="#sec-8-14">BLOCK</a></li>
<li><a href="#sec-8-15">RETURN-FROM</a></li>
<li><a href="#sec-8-16">CATCH</a></li>
<li><a href="#sec-8-17">THROW</a></li>
<li><a href="#sec-8-18">TAGBODY</a></li>
<li><a href="#sec-8-19">GO</a></li>
<li><a href="#sec-8-20">LABELS</a></li>
<li><a href="#sec-8-21">RESET</a></li>
<li><a href="#sec-8-22">SHIFT</a></li>
</ul>
</li>
<li><a href="#sec-9">REPL</a></li>
<li><a href="#sec-10">Итоги</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">План работ</h2>
<div class="outline-text-2" id="text-1">
<p>
На этом этапе мы проведем дефункционализацию. Дефункционализация - это представление
продолжений явными структурами. Для этого мы берем лямбду продолжения и все её
свободные переменные упаковываем в структуру, соответствующую этом вызову.
</p>

<p>
Большинство вызовов похожи друг на друга в отношении принимаемых параметров, значит и
структуры будут похожи в отношении полей. Поэтому мы можем объявить структуру (назовем
ее <code>unicont</code>) от которой будем наследовать различающиеся поля. Мы сделаем это в разделе
<a href="#sec-5">Структура UNICONT</a>.
</p>

<p>
Теперь у нас есть передача структур вместо функций в продолжениях. Когда продолжения
были функциями мы применяли их с помощью <code>funcall</code>. Теперь мы вынесем применение
продолжения в отдельную функцию <code>apply-continuation</code>, которая по типу продолжения
определяет как именно его применить. Т.е. вся логика лямбда-функции продолжений
переносится туда. Большинство продолжений принимают один аргумент, но есть и такие (в
<code>go</code>) которые не принимают аргументов. Мы сделаем это в разделе <a href="#sec-6">Применение продолжений</a>
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Глобальное окружение</h2>
<div class="outline-text-2" id="text-2">
<p>
Здесь мы не должны менять <code>funcall</code> на <code>apply-continuation</code>, потому что продолжения
assoc-2 не являются продолжениями интерпретатора. Поэтому для наглядоности переименуем
<code>cont</code> в <code>success</code> а <code>errcont</code> в <code>failure</code>:
</p>

<p>
[TODO:gmm] Возможно это стоит бэкпортить
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="assoc_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">assoc-2</span> (key alist success failure) <span style="color: #af0000;">;; </span><span style="color: #af0000;">NB!: inverted order of</span>
                                           <span style="color: #af0000;">;; </span><span style="color: #af0000;">successinuations (for lookup)</span>
  (<span style="color: #af00ff;">cond</span> ((null alist)              (funcall failure key))
        ((equal key (caar alist))  (funcall success (cdar alist)))
        (t                         (assoc-2 key (cdr alist) success failure))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="assoc_9_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 123 (lookup 'aaa '((aaa . 123)) #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"stub"</span>  (lookup 'aaa '((bbb . 123)) #'stub #'ok)))
</pre>
</div>

<p>
Заменяем передачу продолжения <code>cont</code> в <code>assoc</code> на <code>(apply-continuation cont ...)</code>. Также
заменяем вызов <code>funcall errcont</code> на <code>(apply-continuation errcont ...)</code>. Мы можем это
сделать, так как когда <code>apply-continuation</code> встречает лямбду, а не структуру, она
применяет ее с помощью <code>funcall</code>.
</p>

<p>
[TODO:gmm] Я тут поправил возможную ошибку с потерей лямбды, замеченную в следущем
файле. Проверить что все работает.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="lookup_9"><span style="color: #af0000;">;; </span><span style="color: #af0000;">environment</span>
(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">*glob-env*</span> nil)
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">lookup</span> (symb env errcont cont)
  (assoc-2 symb env
           (<span style="color: #af00ff;">lambda</span> (x)
             (apply-continuation cont x))
           (<span style="color: #af00ff;">lambda</span> (key)
             (assoc-2 key *glob-env*
                      (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1074;&#1086;&#1079;&#1084;&#1086;&#1078;&#1085;&#1086; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072; (&#1073;&#1099;&#1083;&#1072;) &#1090;&#1091;&#1090;</span>
                        (apply-continuation cont x))
                      (<span style="color: #af00ff;">lambda</span> (key)
                        (apply-continuation
                         errcont
                         (format
                          nil <span style="color: #87005f;">"UNBOUD VARIABLE [~A] ~%LOCAL ENV: [~A] ~%GLOBAL ENV: [~A]"</span>
                          key env *glob-env*)))))))
</pre>
</div>

<p>
Изменяем тесты так чтобы они использовали <code>stub</code> в качестве продолжения
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="lookup_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">test lookup</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 123 (lookup 'aaa '((aaa . 123)) #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"stub"</span>  (lookup 'aaa '((bbb . 123)) #'stub #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Функции для тестирования</h2>
<div class="outline-text-2" id="text-3">
<p>
Добавляем функцию <code>stub</code> для тестирования продолжений ошибки
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="ok_err_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">ok</span> (x)
  (format t <span style="color: #87005f;">"~%ok: ~A"</span> x)
  x)
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">err</span> (x)
  (format t <span style="color: #87005f;">"~%err: ~A"</span> x)
  x)
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">stub</span> (x)
  (format t <span style="color: #87005f;">"~%stub: ~A"</span> x)
  <span style="color: #87005f;">"stub"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Структура замыкания</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">

<pre class="src src-lisp" id="closure_9">(<span style="color: #af00ff;">defstruct</span> <span style="color: #008700;">closure</span>
  body
  env
  block-env
  go-env
  args)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Структура UNICONT</h2>
<div class="outline-text-2" id="text-5">
<p>
Определим структуру <code>unicont</code>, которая будет хранить
</p>
<ul class="org-ul">
<li>block-env
</li>
<li>go-env
</li>
<li>catch-env
</li>
<li>errcont
</li>
<li>cont
</li>
</ul>
<p>
дефункционализированного продолжения. Остальные структуры разнотипных продолжений будем
наследовать от нее. Поэтому они будут включаться здесь, под объединяющим литературным
плейсхолдером <code>contstruct</code> (игра слов: от continuation structure), так же как мы
включаем общий плейсхлолдер ошибок <code>errors</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="unicont_9">(<span style="color: #af00ff;">defstruct</span> <span style="color: #008700;">unicont</span>
  block-env
  go-env
  catch-env
  errcont
  cont)
&lt;&lt;construct_9&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">Применение продолжений</h2>
<div class="outline-text-2" id="text-6">
<p>
Когда <code>apply-continuation</code> получает структуру, которую не знает как обрабатывать - это
определенно ошибка. Создадим класс ошибки для этого случая.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="errors_9">(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">unknown-continuation</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((cont <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:cont</span>  <span style="color: #5f5f87;">:reader</span> cont))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in APPLY-CONTINUATION: unknown-continuation: ~A"</span>
             (cont condition)))))
</pre>
</div>

<p>
Создадим функцию <code>apply-continuation</code>, в которую будем переносить логику обработки
продолжений из лямбд. Мы пока оставляем возможность применять лямбду в качестве
продолжения, поэтому на это идет отдельная проверка
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_continuation_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">apply-continuation</span> (cont arg)
  (<span style="color: #af00ff;">cond</span> ((eq #'ok   cont)       (funcall cont arg))
        ((eq #'err  cont)       (funcall cont arg))
        ((eq #'stub cont)       (funcall cont arg))
        ((functionp cont)       (funcall cont arg)) <span style="color: #af0000;">;; </span><span style="color: #af0000;">tmp</span>
        &lt;&lt;apply_cont_if_9&gt;&gt;
        &lt;&lt;apply_cont_evcond_9&gt;&gt;
        &lt;&lt;apply_cont_evcond_9&gt;&gt;
        &lt;&lt;apply_cont_evand_9&gt;&gt;
        &lt;&lt;apply_cont_evor_9&gt;&gt;
        &lt;&lt;apply_cont_evlet_9&gt;&gt;
        &lt;&lt;apply_cont_evletstar_9&gt;&gt;
        &lt;&lt;apply_cont_setq_9&gt;&gt;
        &lt;&lt;apply_cont_catch_9&gt;&gt;
        &lt;&lt;apply_cont_throw_9&gt;&gt;
        &lt;&lt;apply_cont_throw2_9&gt;&gt;
        &lt;&lt;apply_cont_evtagbody_9&gt;&gt;
        &lt;&lt;apply_cont_evlis_9&gt;&gt;
        (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'unknown-continuation <span style="color: #5f5f87;">:cont</span> cont))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">MyApply</h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">

<pre class="src src-lisp" id="errors_9">(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">unknown-function</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((fn <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:fn</span>  <span style="color: #5f5f87;">:reader</span> fn))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYAPPLY: unknown-function: ~A"</span>
             (fn condition)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_9">&lt;&lt;evaddmul_9&gt;&gt;
&lt;&lt;evlis_9&gt;&gt;
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">myapply</span> (fn args catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span>
    &lt;&lt;myapply_car_cdr_cons_9&gt;&gt;
    &lt;&lt;myapply_null_9&gt;&gt;
    &lt;&lt;myapply_ariph_9&gt;&gt;
    &lt;&lt;myapply_closure_9&gt;&gt;
    &lt;&lt;myapply_print_9&gt;&gt;
    &lt;&lt;myapply_list_9&gt;&gt;
    &lt;&lt;myapply_callcc_9&gt;&gt;
    (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'unknown-function <span style="color: #5f5f87;">:fn</span> fn))))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myapply_9_test">&lt;&lt;myapply_car_cdr_cons_9_test&gt;&gt;
&lt;&lt;myapply_null_9_test&gt;&gt;
&lt;&lt;evaddmul_9_test&gt;&gt;
&lt;&lt;myapply_ariph_9_test&gt;&gt;
&lt;&lt;myapply_closure_9_test&gt;&gt;
&lt;&lt;myapply_print_9_test&gt;&gt;
&lt;&lt;myapply_evlis_9_test&gt;&gt;
&lt;&lt;myapply_list_9_test&gt;&gt;
&lt;&lt;myapply_callcc_9_test&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1">Работа с CONS-ячейками</h3>
<div class="outline-text-3" id="text-7-1">
<p>
Заменяем <code>funcall</code> на <code>apply-continuation</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_car_cdr_cons_9">((equal fn 'car)             (apply-continuation cont (caar args)))
((equal fn 'cdr)             (apply-continuation cont (cdar args)))
((equal fn 'cons)            (apply-continuation cont (cons (car args) (cadr args))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_car_cdr_cons_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; cons, car, cdr</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(cons 1 2) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 2) 3 . 4) (myeval '(cons (cons 1 2) (cons 3 4)) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(car (cons 2 3)) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(cdr (cons 2 3)) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(car (cons (cons 1 2) (cons 3 4))) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 . 4) (myeval '(cdr (cons (cons 1 2) (cons 3 4))) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; cons-&#1103;&#1095;&#1077;&#1077;&#1082;, &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1093; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(car a) '((a . (1 . 2))) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(cdr a) '((a . (1 . 2))) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(car b) '((a . (1 . 2)) (b . (3 . 4))) nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2">NULL-предикат</h3>
<div class="outline-text-3" id="text-7-2">
<div class="org-src-container">

<pre class="src src-lisp" id="errors_9">(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">invalid-number-of-arguments</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((fn <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:fn</span>  <span style="color: #5f5f87;">:reader</span> fn))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYAPPLY: invalid-number-of-arguments: ~A"</span>
             (fn condition)))))
</pre>
</div>

<p>
Заменяем <code>funcall</code> на <code>apply-continuation</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_null_9">((equal fn 'null)            (<span style="color: #af00ff;">if</span> (null (cdr args))
                                 (apply-continuation cont (null (car args)))
                                 (<span style="color: #ff0000; font-weight: bold;">error</span> 'invalid-number-of-arguments <span style="color: #5f5f87;">:fn</span> fn)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_null_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; NULL</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval '(null ()) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval '(null nil) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval '(null T) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval '(null a) '((a . ())) nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; NULL, &#1089; &#1072;&#1088;&#1075;&#1091;&#1084;&#1077;&#1085;&#1090;&#1086;&#1084;, &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1077; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval '(null a) '((a . T)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval '(null a) '((a . 1)) nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3">Встроенные функции арифметики</h3>
<div class="outline-text-3" id="text-7-3">
<div class="org-src-container">

<pre class="src src-lisp" id="evaddmul_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evadd</span> (lst acc)
  (<span style="color: #af00ff;">cond</span> ((null lst)        0)
        ((null (cdr lst))  (+ acc (car lst)))
        (t                 (evadd (cdr lst)
                                  (+ acc (car lst))))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evmul</span> (lst acc)
  (<span style="color: #af00ff;">cond</span> ((null lst)        1)
        ((null (cdr lst))  (* acc (car lst)))
        (t                 (evmul (cdr lst)
                                  (* acc (car lst))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="evaddmul_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVADD</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0                (evadd '() 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2                (evadd '(2) 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 5                (evadd '(2 3) 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3 4)        (evadd '(2 3 4) 0)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVMUL</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1                (evmul '() 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2                (evmul '(2) 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 6                (evmul '(2 3) 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3 4)        (evmul '(2 3 4) 1)))
</pre>
</div>

<p>
Заменяем <code>funcall</code> на <code>apply-continuation</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_ariph_9">((equal fn '+)               (apply-continuation cont (evadd args 0)))
((equal fn '*)               (apply-continuation cont (evmul args 1)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_ariph_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0                (myeval '(+) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2)            (myeval '(+ 2) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3)          (myeval '(+ 2 3) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3 4)        (myeval '(+ 2 3 4) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 (+ 3 4))    (myeval '(+ 2 (+ 3 4)) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 (+ 3 4) 5)  (myeval '(+ 2 (+ 3 4) 5) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1091;&#1084;&#1085;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1                (myeval '(*) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2)            (myeval '(* 2) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3)          (myeval '(* 2 3) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3 4)        (myeval '(* 2 3 4) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 (* 3 4))    (myeval '(* 2 (* 3 4)) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 (* 3 4) 5)  (myeval '(* 2 (* 3 4) 5) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0
               (myeval '(+) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2))
                 (+ a))
               (myeval '(+ a)
                       '((a . 2))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3))
                 (+ a b))
               (myeval '(+ a b)
                       '((a . 2) (b . 3))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (+ a b c))
               (myeval '(+ a b c)
                       '((a . 2) (b . 3) (c . 4))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (+ a (+ b c)))
               (myeval '(+ a (+ b c))
                       '((a . 2) (b . 3) (c . 4))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4) (d 5))
                 (+ a (+ b c) d))
               (myeval '(+ a (+ b c) d)
                       '((a . 2) (b . 3) (c . 4) (d . 5))
                       nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1091;&#1084;&#1085;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;  &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1
               (myeval '(*) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2))
                 (* a))
               (myeval '(* a)
                       '((a . 2))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3))
                 (* a b))
               (myeval '(* a b)
                       '((a . 2) (b . 3))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (* a b c))
               (myeval '(* a b c)
                       '((a . 2) (b . 3) (c . 4))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (* a (* b c)))
               (myeval '(* a (* b c))
                       '((a . 2) (b . 3) (c . 4))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4) (d 5))
                 (* a (* b c) d))
               (myeval '(* a (* b c) d)
                       '((a . 2) (b . 3) (c . 4) (d . 5))
                       nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-4" class="outline-3">
<h3 id="sec-7-4">CLOSURE</h3>
<div class="outline-text-3" id="text-7-4">
<div class="org-src-container">

<pre class="src src-lisp" id="myapply_closure_9">((closure-p fn)              (evprogn (closure-body fn)
                                      (pairlis (closure-args fn)
                                               args
                                               (closure-env fn))
                                      (closure-block-env fn)
                                      (closure-go-env fn)
                                      catch-env
                                      errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_closure_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1087;&#1088;&#1080;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1103; CLOSURE</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(((<span style="color: #af00ff;">lambda</span> (x)
                              (<span style="color: #af00ff;">lambda</span> (y) x))
                            1)
                           2)
                         nil nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-5" class="outline-3">
<h3 id="sec-7-5">PRINT</h3>
<div class="outline-text-3" id="text-7-5">
<p>
Заменяем <code>funcall</code> на <code>apply-continuation</code>.
</p>

<p>
[TODO:gmm] Сделать проверку кол-ва аргументов
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_print_9">((equal fn 'print)           (apply-continuation cont (print (car args))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_print_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; PRINT &#1074; &#1089;&#1088;&#1072;&#1074;&#1085;&#1077;&#1085;&#1080;&#1080; &#1089; host-&#1086;&#1074;&#1099;&#1084; print</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (print 12))
               (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (myeval '(print 12) nil nil nil nil #'err #'identity))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (print 12)
               (myeval '(print 12) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; PRINT &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (<span style="color: #af00ff;">let</span> ((a 12))
                   (print a)))
               (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (myeval '(print a)
                         '((b . 23) (a . 12))
                         nil nil nil #'err #'identity))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 12))
                 (print a))
               (myeval '(print a)
                       '((b . 23) (a . 12))
                       nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-6" class="outline-3">
<h3 id="sec-7-6">LIST</h3>
<div class="outline-text-3" id="text-7-6">
<p>
Определим структуру для сохранения продолжения <code>evlis</code>, которая будет унаследована от
<code>unicond</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_9">(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">evlis-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  fn
  unevaled
  evaled
  env)
</pre>
</div>

<p>
Теперь <code>evlis</code>, в случае получения непустого <code>unevaled</code> будет создавать эту структуру и
передавать её в качестве продолжения в <code>myeval</code>, вместо лямбды
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="evlis_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evlis</span> (fn unevaled evaled env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null unevaled)  (myapply fn (reverse evaled) catch-env errcont cont))
        (t                (myeval (car unevaled) env block-env go-env catch-env errcont
                                  (make-evlis-cont
                                   <span style="color: #5f5f87;">:fn</span> fn
                                   <span style="color: #5f5f87;">:unevaled</span> unevaled
                                   <span style="color: #5f5f87;">:evaled</span> evaled
                                   <span style="color: #5f5f87;">:env</span> env
                                   <span style="color: #5f5f87;">:block-env</span> block-env
                                   <span style="color: #5f5f87;">:go-env</span> go-env
                                   <span style="color: #5f5f87;">:catch-env</span> catch-env
                                   <span style="color: #5f5f87;">:errcont</span> errcont
                                   <span style="color: #5f5f87;">:cont</span> cont)))))
</pre>
</div>

<p>
А саму логику из лямбды переместим в <code>apply-continuation</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evlis_9">((evlis-cont-p cont)    (evlis (evlis-cont-fn cont)
                               (cdr (evlis-cont-unevaled cont))
                               (cons arg (evlis-cont-evaled cont))
                               (evlis-cont-env cont)
                               (unicont-block-env cont)
                               (unicont-go-env cont)
                               (unicont-catch-env cont)
                               (unicont-errcont cont)
                               (unicont-cont cont)))
</pre>
</div>

<p>
Заменяем <code>funcall</code> на <code>apply-continuation</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_list_9">((equal fn 'list)            (apply-continuation cont args))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_evlis_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; EVLIS</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 4           (evlis '+     '(1 (+ 1 2))   nil nil nil nil nil  #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 1 3 5)   (evlis '+     '(1 (+ 1 2) 5) nil nil nil nil nil  #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 3 5)    (evlis 'list  '(1 (+ 1 2) 5) nil nil nil nil nil  #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(0 3 6 42) (evlis 'list  '(0 (+ a b) (* b c) 42)
                                  nil
                                  '((a . 1) (b . 2) (c . 3) (d . 4))
                                  nil nil nil  #'err #'ok)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_list_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LIST</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 14) (myeval '(list 1 (+ 2 (* 3 4)))
                               nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (myeval '(list (+ 1 2) (* 2 3) 42) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (myeval '(list (+ a b) (* b c) 42)
                       '((a . 1) (b . 2) (c . 3) (d . 4))
                       nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-7" class="outline-3">
<h3 id="sec-7-7">CALL/CC</h3>
<div class="outline-text-3" id="text-7-7">
<div class="org-src-container">

<pre class="src src-lisp" id="myapply_callcc_9">((equal fn 'call/cc)         (myapply (car args) (list cont) catch-env errcont cont))
((functionp fn)              (apply fn args))      <span style="color: #af0000;">; interim hack</span>
((unicont-p fn)              (apply-continuation fn (car args)))
<span style="color: #af0000;">;;  </span><span style="color: #af0000;">((identity-cont-p fn)        (apply-continuation fn (car args))) ;; for identity</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_callcc_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; CALL/CC</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 14 (myeval '(+ 1 2 (call/cc (<span style="color: #af00ff;">lambda</span> (x) (+ 3 4) (x (+ 5 6)) (+7 8))))
                          nil nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8">MyEval</h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_9">&lt;&lt;myeval_evcond_9&gt;&gt;
&lt;&lt;myeval_evprogn_9&gt;&gt;
&lt;&lt;myeval_evand_9&gt;&gt;
&lt;&lt;myeval_evor_9&gt;&gt;
&lt;&lt;myeval_mypairlis_9&gt;&gt;
&lt;&lt;myeval_evlet_9&gt;&gt;
&lt;&lt;myeval_evletstar_9&gt;&gt;
&lt;&lt;myeval_evthrow_9&gt;&gt;
&lt;&lt;myeval_evtagbody_9&gt;&gt;
&lt;&lt;myeval_is_cont_subset_9&gt;&gt;
&lt;&lt;myeval_make_goenv_9&gt;&gt;
&lt;&lt;myeval_apply_go_continuation_9&gt;&gt;
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">myeval</span> (exp env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span>
    &lt;&lt;myeval_number_9&gt;&gt;
    &lt;&lt;myeval_symb_9&gt;&gt;
    &lt;&lt;myeval_quote_9&gt;&gt;
    &lt;&lt;myeval_if_9&gt;&gt;
    &lt;&lt;myeval_cond_9&gt;&gt;
    &lt;&lt;myeval_progn_9&gt;&gt;
    &lt;&lt;myeval_and_9&gt;&gt;
    &lt;&lt;myeval_or_9&gt;&gt;
    &lt;&lt;myeval_let_9&gt;&gt;
    &lt;&lt;myeval_letstar_9&gt;&gt;
    &lt;&lt;myeval_defun_9&gt;&gt;
    &lt;&lt;myeval_setq_9&gt;&gt;
    &lt;&lt;myeval_lambda_9&gt;&gt;
    &lt;&lt;myeval_block_9&gt;&gt;
    &lt;&lt;myeval_return_from_9&gt;&gt;
    &lt;&lt;myeval_catch_9&gt;&gt;
    &lt;&lt;myeval_throw_9&gt;&gt;
    &lt;&lt;myeval_tagbody_9&gt;&gt;
    &lt;&lt;myeval_go_9&gt;&gt;
    &lt;&lt;myeval_labels_9&gt;&gt;
    &lt;&lt;myeval_reset_9&gt;&gt;
    &lt;&lt;myeval_shift_9&gt;&gt;
    (t
     (myeval (car exp) env block-env go-env catch-env errcont
             (<span style="color: #af00ff;">lambda</span> (x)
               (evlis x (cdr exp) nil env block-env go-env catch-env errcont cont))))))
</pre>
</div>

<p>
Тесты:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_9_test">&lt;&lt;myeval_number_9_test&gt;&gt;
&lt;&lt;myeval_symb_9_test&gt;&gt;
&lt;&lt;myeval_quote_9_test&gt;&gt;
&lt;&lt;myeval_if_9_test&gt;&gt;
&lt;&lt;myeval_evcond_9_test&gt;&gt;
&lt;&lt;myeval_cond_9_test&gt;&gt;
&lt;&lt;myeval_evprogn_9_test&gt;&gt;
&lt;&lt;myeval_progn_9_test&gt;&gt;
&lt;&lt;myeval_evand_9_test&gt;&gt;
&lt;&lt;myeval_and_9_test&gt;&gt;
&lt;&lt;myeval_evor_9_test&gt;&gt;
&lt;&lt;myeval_or_9_test&gt;&gt;
&lt;&lt;myeval_mypairlis_9_test&gt;&gt;
&lt;&lt;myeval_evlet_9_test&gt;&gt;
&lt;&lt;myeval_let_9_test&gt;&gt;
&lt;&lt;myeval_evletstar_9_test&gt;&gt;
&lt;&lt;myeval_letstar_9_test&gt;&gt;
&lt;&lt;myeval_defun_9_test&gt;&gt;
&lt;&lt;myeval_setq_9_test&gt;&gt;
&lt;&lt;myeval_lambda_9_test&gt;&gt;
&lt;&lt;myeval_block_9_test&gt;&gt;
&lt;&lt;myeval_return_from_9_test&gt;&gt;
&lt;&lt;myeval_catch_9_test&gt;&gt;
&lt;&lt;myeval_throw_9_test&gt;&gt;
&lt;&lt;myeval_tagbody_9_test&gt;&gt;
&lt;&lt;myeval_go_9_test&gt;&gt;
&lt;&lt;myeval_labels_9_test&gt;&gt;
&lt;&lt;myeval_reset_9_test&gt;&gt;
&lt;&lt;myeval_shift_9_test&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1">Самовычисляемые формы</h3>
<div class="outline-text-3" id="text-8-1">
<p>
Замена <code>funcall cont</code> на <code>apply-continuaation</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_number_9">((null exp)                  (apply-continuation cont 'nil))
((equal 't exp)              (apply-continuation cont 't))
((member exp '(+ * car cdr cons null print list call/cc repl))  (apply-continuation cont exp))
((numberp exp)               (apply-continuation cont exp))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_number_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1072;&#1084;&#1086;&#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1093; &#1092;&#1086;&#1088;&#1084;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval 'T nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval 'NIL nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 999 (myeval 999 nil nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2">Вычисление символов</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_symb_9">((symbolp exp)               (lookup exp env errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_symb_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1077;&#1085;&#1080;&#1103; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 6 (myeval 'b '((a . 3) (b . 6)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span> (car (myeval 'b nil nil nil nil
                                    #'(<span style="color: #af00ff;">lambda</span> (x) (cons <span style="color: #87005f;">"error"</span> x))
                                    #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3">Цитирование</h3>
<div class="outline-text-3" id="text-8-3">
<p>
Замена <code>funcall cont</code> на <code>apply-continauation</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_quote_9">((equal (car exp) 'quote)    (apply-continuation cont (cadr exp)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_quote_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; QUOTE</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(+ 1 2) (myeval '(quote (+ 1 2)) nil nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-4" class="outline-3">
<h3 id="sec-8-4">Условное выполнение IF</h3>
<div class="outline-text-3" id="text-8-4">
<p>
Определим структуру для сохранения продолжения <code>if</code>, которая будет унаследована от
<code>unicond</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_9">(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">if-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  clauses
  env)
</pre>
</div>

<p>
Теперь в <code>myeval</code>, будем создавать эту структуру и передавать её в качестве продолжения
в <code>myeval</code>, вместо лямбды:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_if_9">((equal (car exp) 'if)       (myeval (cadr exp) env block-env go-env catch-env errcont
                                     (make-if-cont
                                      <span style="color: #5f5f87;">:clauses</span> exp
                                      <span style="color: #5f5f87;">:env</span> env
                                      <span style="color: #5f5f87;">:block-env</span> block-env
                                      <span style="color: #5f5f87;">:go-env</span> go-env
                                      <span style="color: #5f5f87;">:catch-env</span> catch-env
                                      <span style="color: #5f5f87;">:errcont</span> errcont
                                      <span style="color: #5f5f87;">:cont</span> cont)))
</pre>
</div>

<p>
А саму логику из лямбды переместим в <code>apply-continuation</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_if_9">((if-cont-p cont)       (<span style="color: #af00ff;">if</span> arg
                            (myeval (caddr (if-cont-clauses cont))
                                    (if-cont-env cont)
                                    (if-cont-block-env cont)
                                    (if-cont-go-env cont)
                                    (if-cont-catch-env cont)
                                    (if-cont-errcont cont)
                                    (if-cont-cont cont))
                            (myeval (cadddr (if-cont-clauses cont))
                                    (if-cont-env cont)
                                    (if-cont-block-env cont)
                                    (if-cont-go-env cont)
                                    (if-cont-catch-env cont)
                                    (if-cont-errcont cont)
                                    (if-cont-cont cont))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_if_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; IF</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">if</span> () 1 2) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">if</span> (null ()) 1 2) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; IF, &#1075;&#1076;&#1077; &#1091;&#1089;&#1083;&#1086;&#1074;&#1080;&#1077; &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1090;&#1089;&#1103; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">if</span> a 1 2) '((a . ())) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">if</span> a 1 2) '((a . 1)) nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-5" class="outline-3">
<h3 id="sec-8-5">COND</h3>
<div class="outline-text-3" id="text-8-5">
<p>
Определим структуру для сохранения продолжения COND, которая будет унаследована от
<code>unicond</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_9">(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">evcond-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  clauses
  env)
</pre>
</div>

<p>
Теперь <code>evcond</code>, в случае получения непустого <code>cond</code> будет создавать эту структуру и
передавать её в качестве продолжения в <code>myeval</code>, вместо лямбды:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evcond_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evcond</span> (clauses env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null clauses)  (apply-continuation cont nil))
        (t               (myeval (caar clauses) env block-env go-env catch-env errcont
                                 (make-evcond-cont
                                  <span style="color: #5f5f87;">:clauses</span> clauses
                                  <span style="color: #5f5f87;">:env</span> env
                                  <span style="color: #5f5f87;">:block-env</span> block-env
                                  <span style="color: #5f5f87;">:go-env</span> go-env
                                  <span style="color: #5f5f87;">:catch-env</span> catch-env
                                  <span style="color: #5f5f87;">:errcont</span> errcont
                                  <span style="color: #5f5f87;">:cont</span> cont)))))
</pre>
</div>

<p>
А саму логику из лямбды переместим в <code>apply-continuation</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evcond_9">((evcond-cont-p cont)   (<span style="color: #af00ff;">if</span> arg
                            (myeval (cadar (evcond-cont-clauses cont))
                                  (evcond-cont-env cont)
                                  (evcond-cont-block-env cont)
                                  (evcond-cont-go-env cont)
                                  (evcond-cont-catch-env cont)
                                  (evcond-cont-errcont cont)
                                  (evcond-cont-cont cont))
                            (evcond (cdr (evcond-cont-clauses cont))
                                    (evcond-cont-env cont)
                                    (evcond-cont-block-env cont)
                                    (evcond-cont-go-env cont)
                                    (evcond-cont-catch-env cont)
                                    (evcond-cont-errcont cont)
                                    (evcond-cont-cont cont))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evcond_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVCOND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2   (evcond '((t 2)   (t 1)) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1   (evcond '((nil 2) (t 1)) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (evcond '((nil 2) (nil 1)) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVCOND, &#1075;&#1076;&#1077; &#1091;&#1095;&#1072;&#1089;&#1090;&#1074;&#1091;&#1077;&#1090; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (evcond '((a 2) (b 1))
                         '((a . 1) (b . ()))
                         nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (evcond '((a 2) (b 1))
                         '((a . nil) (b . T))
                         nil nil nil #'err #'ok)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_cond_9">((equal (car exp) 'cond)     (evcond (cdr exp)
                                     env block-env go-env catch-env
                                     errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_cond_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; COND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">cond</span>
                           (() 1)
                           (1 2))
                         nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">cond</span>
                           (a 1)
                           (b 2))
                         '((a . ()) (b . 1))
                         nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">cond</span>
                           (a 1)
                           (b 2))
                         '((a . 1) (b . ()))
                         nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-6" class="outline-3">
<h3 id="sec-8-6">PROGN</h3>
<div class="outline-text-3" id="text-8-6">
<p>
Определим структуру для сохранения продолжения <code>progn</code>, которая будет унаследована от
<code>unicond</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_9">(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">evprogn-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  clauses
  env)
</pre>
</div>

<p>
Теперь <code>evprogn</code>, имеет три варианта действий
</p>
<ul class="org-ul">
<li>если <code>lst</code> пуст, то вызвать продолжение, передав ему nil
</li>
<li>если <code>lst</code> - список из одного элемента - вызвать <code>myeval</code>, передав ему этот элемент и
свое продолжение
</li>
<li>в ином случае - вызвать <code>myeval</code>, передав в качестве продолжения созданную структуру
<code>evprogn-cont</code> вместо лямбды.
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evprogn_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evprogn</span> (lst env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null lst)         (apply-continuation cont nil))
        ((null (cdr lst))   (myeval (car lst) env block-env go-env catch-env errcont cont))
        (t                  (myeval (car lst) env block-env go-env catch-env errcont
                                    (make-evprogn-cont
                                     <span style="color: #5f5f87;">:clauses</span> lst
                                     <span style="color: #5f5f87;">:env</span> env
                                     <span style="color: #5f5f87;">:block-env</span> block-env
                                     <span style="color: #5f5f87;">:go-env</span> go-env
                                     <span style="color: #5f5f87;">:catch-env</span> catch-env
                                     <span style="color: #5f5f87;">:errcont</span> errcont
                                     <span style="color: #5f5f87;">:cont</span> cont)))))
</pre>
</div>

<p>
А саму логику из лямбды переместим в <code>apply-continuation</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evcond_9">((evprogn-cont-p cont)  (evprogn (cdr (evprogn-cont-clauses cont))
                                 (evprogn-cont-env cont)
                                 (evprogn-cont-block-env cont)
                                 (evprogn-cont-go-env cont)
                                 (evprogn-cont-catch-env cont)
                                 (evprogn-cont-errcont cont)
                                 (evprogn-cont-cont cont)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evprogn_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; EVPROGN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (evprogn '(1 2) nil nil nil nil  #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; EVPROGN &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (evprogn '(a b c)
                          '((a . 1) (b . 2) (c . 3))
                           nil nil nil #'err #'ok)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_progn_9">((equal (car exp) 'progn)    (evprogn (cdr exp)
                                      env block-env go-env catch-env
                                      errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_progn_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; PROGN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">progn</span> 1 2 3) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; PROGN &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">progn</span> a b c) '((a . 1) (b . 2) (c . 3))
                         nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-7" class="outline-3">
<h3 id="sec-8-7">AND</h3>
<div class="outline-text-3" id="text-8-7">
<p>
Определим структуру для сохранения продолжения AND, которая будет унаследована от
<code>unicond</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_9">(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">and-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  exps
  env)
</pre>
</div>

<p>
Теперь <code>evand</code>, в случае получения непустого списка аргументов будет создавать эту
структуру и передавать её в качестве продолжения в <code>myeval</code>, вместо лямбды. Для
единообразия мы переименовали <code>args</code> в <code>exps</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evand_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evand</span> (exps env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null exps)       (apply-continuation cont T))
        ((null (cdr exps)) (myeval (car exps) env block-env go-env catch-env errcont cont))
        (t                 (myeval (car exps) env block-env go-env catch-env errcont
                                   (make-and-cont
                                    <span style="color: #5f5f87;">:exps</span> (cdr exps)
                                    <span style="color: #5f5f87;">:env</span> env
                                    <span style="color: #5f5f87;">:block-env</span> block-env
                                    <span style="color: #5f5f87;">:go-env</span> go-env
                                    <span style="color: #5f5f87;">:catch-env</span> catch-env
                                    <span style="color: #5f5f87;">:errcont</span> errcont
                                    <span style="color: #5f5f87;">:cont</span> cont)))))
</pre>
</div>

<p>
А саму логику из лямбды переместим в <code>apply-continuation</code>. В этот момент аргументы уже
вычислены. Если аргумент ложный, то возвращаем применение продолжения к nil (потому что
<code>and</code> возвращает nil, если встречает ложный аргумент). Это продолжение берем из
структуры . В противном случае нам надо продолжить вычисление, оценивая другие
формы. Для этого рекурсивно вызываем <code>evand</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evand_9">((and-cont-p cont)      (<span style="color: #af00ff;">if</span> (null arg)
                            (apply-continuation (and-cont-cont cont) nil)
                            (evand (and-cont-exps cont)
                                   (and-cont-env cont)
                                   (and-cont-block-env cont)
                                   (and-cont-go-env cont)
                                   (and-cont-catch-env cont)
                                   (and-cont-errcont cont)
                                   (and-cont-cont cont))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evand_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVAND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and)           (evand '() nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1)         (evand '(1) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and nil)       (evand '(nil) nil nil nil  nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 nil)     (evand '(1 nil) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 nil)   (evand '(1 2 nil) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 3)     (evand '(1 2 3) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 nil 3) (evand '(1 2 nil 3) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVAND &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (and nil))
               (evand '(a) '((a . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (and a))
               (evand '(a) '((a . 1)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b nil))
                 (and a b))
               (evand '(a b) '((a . 1) (b . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c nil))
                 (and a b c))
               (evand '(a b c) '((a . 1) (b . 2) (c . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a b c))
               (evand '(a b c) '((a . 1) (b . 2) (c . 3)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c nil)
                     (d 3))
                 (and a b c d))
               (evand '(a b c) '((a . 1) (b . 2) (c . nil) (d . 3)) nil nil nil #'err #'ok)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_and_9">((equal (car exp) 'and)      (evand (cdr exp)
                                    env block-env go-env catch-env
                                    errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_and_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; AND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and)                (myeval '(and) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1)              (myeval '(and 1) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and nil)            (myeval '(and nil) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 nil)          (myeval '(and 1 nil) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 nil)        (myeval '(and 1 2 nil) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 3)          (myeval '(and 1 2 3) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 (and 1 2) 3)  (myeval '(and 1 (and 1 2) 3) nil nil nil nil
                                            #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 (and 1 nil) 3)  (myeval '(and 1 (and 1 nil) 3) nil nil nil nil
                                              #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; AND &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (and nil))
               (myeval '(and a) '((a . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (and a))
               (myeval '(and a) '((a . 1)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b nil))
                 (and a b))
               (myeval '(and a b) '((a . 1) (b . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c nil))
                 (and a b c))
               (myeval '(and a b c) '((a . 1) (b . 2) (c . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a b c))
               (myeval '(and a b c) '((a . 1) (b . 2) (c . 3)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a (and a b) c))
               (myeval '(and a (and a b) c) '((a . 1) (b . 2) (c . 3)) nil nil nil
                       #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b nil)
                     (c 3))
                 (and a (and a b) c))
               (myeval '(and a (and a b) c) '((a . 1) (b . nil) (c . 3)) nil nil nil
                       #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-8" class="outline-3">
<h3 id="sec-8-8">OR</h3>
<div class="outline-text-3" id="text-8-8">
<p>
Определим структуру для сохранения продолжения OR, которая будет унаследована от
<code>unicond</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_9">(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">or-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  exps
  env)
</pre>
</div>

<p>
Теперь <code>evor</code>, в случае получения непустого списка параметров будет создавать эту
структуру и передавать её в качестве продолжения в <code>myeval</code>, вместо лямбды. Для
единообразия мы переименовали <code>args</code> в <code>exps</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evor_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evor</span> (exps env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null exps)       (apply-continuation cont nil))
        ((null (cdr exps)) (myeval (car exps) env block-env go-env catch-env errcont cont))
        (t                 (myeval (car exps) env block-env go-env catch-env errcont
                                   (make-or-cont
                                    <span style="color: #5f5f87;">:exps</span> (cdr exps)
                                    <span style="color: #5f5f87;">:env</span> env
                                    <span style="color: #5f5f87;">:block-env</span> block-env
                                    <span style="color: #5f5f87;">:go-env</span> go-env
                                    <span style="color: #5f5f87;">:catch-env</span> catch-env
                                    <span style="color: #5f5f87;">:errcont</span> errcont
                                    <span style="color: #5f5f87;">:cont</span> cont)))))
</pre>
</div>

<p>
А саму логику из лямбды переместим в <code>apply-continuation</code>. В этот момент аргументы уже
вычислены. Если аргумент истинный, то возвращаем применение продолжения к аргументу
(потому что <code>or</code> возвращает свой аргумент). Это продолжение берем из структуры, . В
противном случае нам надо продолжить вычисление, оценивая другие формы. Для этого
рекурсивно вызываем <code>evor</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evor_9">((or-cont-p cont)       (<span style="color: #af00ff;">if</span> (not (null arg))
                            (apply-continuation (or-cont-cont cont) arg)
                            (evor (or-cont-exps cont)
                                  (or-cont-env cont)
                                  (or-cont-block-env cont)
                                  (or-cont-go-env cont)
                                  (or-cont-catch-env cont)
                                  (or-cont-errcont cont)
                                  (or-cont-cont cont))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evor_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVOR</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or)                   (evor '() nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1)             (evor '(nil 1) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil nil 1)         (evor '(nil nil 1) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1 2)           (evor '(nil 1 2) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or 1 2 3)             (evor '(1 2 3) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil nil 3 nil)     (evor '(nil nil 3 nil) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVOR &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (or a))
               (evor '(a) '((a . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (or a))
               (evor '(a) '((a . 1)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1))
                 (or a b))
               (evor '(a b) '((a . nil) (b . 1)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b nil)
                     (c 3))
                 (or a b c))
               (evor '(a b c) '((a . nil) (b . nil) (c . 3)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1)
                     (c 2))
                 (or a b c))
               (evor '(a b c) '((a . nil) (b . 1) (c . 2)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b nil)
                     (c 3)
                     (d nil))
                 (or a b c d))
               (evor '(a b c d) '((a . nil) (b . nil) (c . 3) (d . nil)) nil nil nil
                     #'err #'ok)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_or_9">((equal (car exp) 'or)       (evor  (cdr exp)
                                    env block-env go-env catch-env
                                    errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_or_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; OR</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or)                  (myeval '(or) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1)            (myeval '(or nil 1) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil nil 1)        (myeval '(or nil nil 1) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1 2)          (myeval '(or nil 1 2) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil (or 3 2) 2)   (myeval '(or nil (or 3 2) 2) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; OR &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (or a))
               (myeval '(or a) '((a . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (or a))
               (myeval '(or a) '((a . 1)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1))
                 (or a b))
               (myeval '(or a b) '((a . nil) (b . 1)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b nil)
                     (c 3))
                 (or a b c))
               (myeval '(or a b c) '((a . nil) (b . nil) (c . 3)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1)
                     (c 2))
                 (or a b c))
               (myeval '(or a b c) '((a . nil) (b . 1) (c . 2)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b nil)
                     (c nil)
                     (d 2))
                 (or a (or b c) d))
               (myeval '(or  a (or b c) d) '((a . nil) (b . nil) (c . nil) (d . 2))
                       nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-9" class="outline-3">
<h3 id="sec-8-9">LET</h3>
<div class="outline-text-3" id="text-8-9">
<div class="org-src-container">

<pre class="src src-lisp" id="errors_9">(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">mypairlis-error</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((lst1 <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:lst1</span>  <span style="color: #5f5f87;">:reader</span> lst1)
   (lst2 <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:lst2</span>  <span style="color: #5f5f87;">:reader</span> lst2))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYPAIRLIS: wrong params:~%'~A~%'~A"</span>
             (lst1 condition) (lst2 condition)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_mypairlis_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">mypairlis</span> (lst1 lst2 alist)
  (<span style="color: #af00ff;">cond</span> ((and (null lst1) (null lst2))  alist)
        ((or  (null lst1) (null lst2))  (<span style="color: #ff0000; font-weight: bold;">error</span> 'mypairlis-error <span style="color: #5f5f87;">:lst1</span> lst1 <span style="color: #5f5f87;">:lst2</span> lst2))
        (t                              (cons (cons (car lst1)
                                                    (car lst2))
                                              (mypairlis (cdr lst1)
                                                         (cdr lst2)
                                                         alist)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_mypairlis_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; MYPAIRLIS</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(( a . 1) (b . 2) ( c . 3) (z . 6) (y . 77))
               (mypairlis '(a b c) '(1 2 3) '((z . 6) (y . 77)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span>
               (<span style="color: #af00ff;">handler-case</span> (mypairlis '(a b c) nil '((z . 6) (y . 77)))
                 (MYPAIRLIS-ERROR (condition) <span style="color: #87005f;">"error"</span>))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span>
               (<span style="color: #af00ff;">handler-case</span> (mypairlis nil '(1 2 3) '((z . 6) (y . 77)))
                 (MYPAIRLIS-ERROR (condition) <span style="color: #87005f;">"error"</span>))))
</pre>
</div>

<p>
Определим структуру для сохранения продолжения <code>let</code>, которая будет унаследована от
<code>unicond</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_9">(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">evlet-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  vars
  exps
  evald-exps
  exp
  env)
</pre>
</div>

<p>
Теперь вместо передачи продолжения в виде лямбды мы будем передавать эту структуру:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evlet_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evlet</span> (vars exps evald-exps exp env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null exps)  (evprogn exp
                               (pairlis vars (reverse evald-exps) env)
                               block-env go-env catch-env
                               errcont cont))
        (t            (myeval (car exps) env block-env go-env catch-env errcont
                              (make-evlet-cont
                               <span style="color: #5f5f87;">:vars</span> vars
                               <span style="color: #5f5f87;">:exps</span> exps
                               <span style="color: #5f5f87;">:evald-exps</span> evald-exps
                               <span style="color: #5f5f87;">:exp</span> exp
                               <span style="color: #5f5f87;">:env</span> env
                               <span style="color: #5f5f87;">:block-env</span> block-env
                               <span style="color: #5f5f87;">:go-env</span> go-env
                               <span style="color: #5f5f87;">:catch-env</span> catch-env
                               <span style="color: #5f5f87;">:errcont</span> errcont
                               <span style="color: #5f5f87;">:cont</span> cont)))))
</pre>
</div>

<p>
А саму логику из лямбды переместим в <code>apply-continuation</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evlet_9">((evlet-cont-p cont)    (evlet (evlet-cont-vars cont)
                               (cdr (evlet-cont-exps cont))
                               (cons arg (evlet-cont-evald-exps cont))
                               (evlet-cont-exp cont)
                               (evlet-cont-env cont)
                               (evlet-cont-block-env cont)
                               (evlet-cont-go-env cont)
                               (evlet-cont-catch-env cont)
                               (evlet-cont-errcont cont)
                               (evlet-cont-cont cont)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evlet_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVLET</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (evlet '(a b) '(1 2) nil '(4 (+ a b)) nil nil nil nil #'err #'ok)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_let_9">((equal (car exp) 'let)      (evlet (mapcar #'car (cadr exp))
                                    (mapcar #'cadr (cadr exp))
                                    nil
                                    (cddr exp)
                                    env block-env go-env catch-env
                                    errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_let_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LET</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(<span style="color: #af00ff;">let</span> ((a 1)
                                       (b 2))
                                  (cons a b))
                                  nil nil nil nil
                                  #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-10" class="outline-3">
<h3 id="sec-8-10">LET*</h3>
<div class="outline-text-3" id="text-8-10">
<p>
Определим структуру для сохранения продолжения <code>letstar</code>, которая будет унаследована от
<code>unicond</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_9">(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">evletstar-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  varpairs
  exp
  env)
</pre>
</div>

<p>
Теперь вместо передачи продолжения в виде лямбды мы будем передавать эту структуру:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evletstar_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evletstar</span> (varpairs exp env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null varpairs)  (evprogn exp env block-env go-env catch-env errcont cont))
        (t                (myeval (cadar varpairs) env block-env go-env catch-env errcont
                                  (make-evletstar-cont
                                   <span style="color: #5f5f87;">:varpairs</span> varpairs
                                   <span style="color: #5f5f87;">:exp</span> exp
                                   <span style="color: #5f5f87;">:env</span> env
                                   <span style="color: #5f5f87;">:block-env</span> block-env
                                   <span style="color: #5f5f87;">:go-env</span> go-env
                                   <span style="color: #5f5f87;">:catch-env</span> catch-env
                                   <span style="color: #5f5f87;">:errcont</span> errcont
                                   <span style="color: #5f5f87;">:cont</span> cont)))))
</pre>
</div>

<p>
А саму логику из лямбды переместим в <code>apply-continuation</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evletstar_9">((evletstar-cont-p cont) (evletstar (cdr (evletstar-cont-varpairs cont))
                                    (evletstar-cont-exp cont)
                                    (acons (caar (evletstar-cont-varpairs cont))
                                           arg
                                           (evletstar-cont-env cont))
                                    (evletstar-cont-block-env cont)
                                    (evletstar-cont-go-env cont)
                                    (evletstar-cont-catch-env cont)
                                    (evletstar-cont-errcont cont)
                                    (evletstar-cont-cont cont)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evletstar_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVLETSTAR</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (evletstar '((a 1) (b a)) '(4 (+ a b)) nil nil nil nil #'err #'ok)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_letstar_9">((equal (car exp) 'let*)     (evletstar (cadr exp)
                                        (cddr exp)
                                        env block-env go-env catch-env
                                        errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_letstar_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LET*</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 1 . 2) (myeval '(<span style="color: #af00ff;">let*</span> ((a 1)
                                          (b 2)
                                          (c (+ a b)))
                                    (cons c (cons a b)))
                                  nil nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-11" class="outline-3">
<h3 id="sec-8-11">DEFUN</h3>
<div class="outline-text-3" id="text-8-11">
<p>
Заменяем <code>funcall cont</code> на <code>apply-continuation</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_defun_9">((equal (car exp) 'defun)         (<span style="color: #af00ff;">progn</span>
                                    (push (cons (cadr exp)
                                                (make-closure <span style="color: #5f5f87;">:body</span> (cdddr exp)
                                                              <span style="color: #5f5f87;">:block-env</span> block-env
                                                              <span style="color: #5f5f87;">:env</span> env
                                                              <span style="color: #5f5f87;">:go-env</span> go-env
                                                              <span style="color: #5f5f87;">:args</span> (caddr exp)))
                                          *glob-env*)
                                    (apply-continuation cont (cadr exp))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_defun_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; DEFUN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 64 (<span style="color: #af00ff;">progn</span>
                    (setf *glob-env* nil)
                    (myeval '(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">alfa</span> (x) (* x x)) nil nil nil nil #'err #'ok)
                    (<span style="color: #af00ff;">prog1</span> (myeval '(alfa 8) nil nil nil nil #'err #'ok)
                      (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1085;&#1072; IMPLICIT-PROGN &#1074; DEFUN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 384 (<span style="color: #af00ff;">progn</span>
                     (setf *glob-env* nil)
                     (myeval '(<span style="color: #af00ff;">let</span> ((y 3))
                               (<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">alfa</span> (x)
                                 (setq y 6)
                                 (* x x y)))
                             nil nil nil nil #'err #'ok)
                     (<span style="color: #af00ff;">prog1</span> (myeval '(alfa 8) nil nil nil nil #'err #'ok)
                       (setf *glob-env* nil)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-12" class="outline-3">
<h3 id="sec-8-12">SETQ</h3>
<div class="outline-text-3" id="text-8-12">
<p>
Определим структуру для сохранения продолжения <code>setq</code>, которая будет унаследована от
<code>unicond</code>:
</p>

<p>
[TODO:gmm] Судя по дальнейшему коду unicont-поля не используются, откажемся?
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_9">(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">setq-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  clauses
  env)
</pre>
</div>

<p>
Теперь в <code>myeval</code>, будем создавать эту структуру и передавать её в качестве продолжения
в <code>myeval</code>, вместо лямбды:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_setq_9">((equal (car exp) 'setq)     (myeval (caddr exp) env block-env go-env catch-env errcont
                                     (make-setq-cont
                                      <span style="color: #5f5f87;">:clauses</span> exp
                                      <span style="color: #5f5f87;">:env</span> env
                                      <span style="color: #5f5f87;">:block-env</span> block-env
                                      <span style="color: #5f5f87;">:go-env</span> go-env
                                      <span style="color: #5f5f87;">:catch-env</span> catch-env
                                      <span style="color: #5f5f87;">:errcont</span> errcont
                                      <span style="color: #5f5f87;">:cont</span> cont)))
</pre>
</div>

<p>
А саму логику из лямбды переместим в <code>apply-continuation</code>, заменив <code>funcall</code> на
<code>apply-continuation</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_setq_9">((setq-cont-p cont)     (<span style="color: #af00ff;">progn</span>
                          (<span style="color: #af00ff;">if</span> (null (assoc (cadr (setq-cont-clauses cont))
                                           (setq-cont-env cont)))
                              <span style="color: #af0000;">;; </span><span style="color: #af0000;">if-null</span>
                              (<span style="color: #af00ff;">if</span> (null (assoc (cadr (setq-cont-clauses cont))
                                               *glob-env*))
                                  <span style="color: #af0000;">;; </span><span style="color: #af0000;">then</span>
                                  (push (cons (cadr (setq-cont-clauses cont))
                                              arg)
                                        *glob-env*)
                                  <span style="color: #af0000;">;; </span><span style="color: #af0000;">else</span>
                                  (rplacd (assoc (cadr (setq-cont-clauses cont))
                                                 *glob-env*)
                                          arg))
                              <span style="color: #af0000;">;; </span><span style="color: #af0000;">if-not-null</span>
                              (rplacd (assoc (cadr (setq-cont-clauses cont))
                                             (setq-cont-env cont))
                                      arg))
                          (apply-continuation (setq-cont-cont cont) arg)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_setq_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; SETQ</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1082;&#1072; &#1080;&#1079;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1103; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; &#1083;&#1086;&#1082;&#1072;&#1083;&#1100;&#1085;&#1086;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;, &#1085;&#1077; &#1079;&#1072;&#1090;&#1088;&#1072;&#1075;&#1080;&#1074;&#1072;&#1103; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1086;&#1075;&#1086; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((2 . 2) ((alfa . 0)))
               (<span style="color: #af00ff;">progn</span>
                 (setf *glob-env* '((alfa . 0)))
                 (<span style="color: #af00ff;">prog1</span> (list (myeval '(cons (setq alfa 2)
                                        alfa)
                                      '((alfa . 1))
                                      nil nil nil #'err #'ok)
                              *glob-env*)
                   (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1048;&#1079;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; &#1085;&#1077;&#1089;&#1091;&#1097;&#1077;&#1089;&#1090;&#1074;&#1091;&#1102;&#1097;&#1077;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081; (&#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1080;&#1077; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1086;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;)</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 1) ((ALFA . 1) (BETA . 222)))
               (<span style="color: #af00ff;">progn</span>
                 (setf *glob-env* '((beta . 222)))
                 (<span style="color: #af00ff;">prog1</span> (list (myeval '(cons
                                        (setq alfa 1)
                                        alfa)
                                      nil nil nil nil #'err #'ok)
                              *glob-env*)
                   (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1048;&#1079;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; &#1089;&#1091;&#1097;&#1077;&#1089;&#1090;&#1074;&#1091;&#1102;&#1097;&#1077;&#1081; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1086;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 1) ((BETA . 1)))
               (<span style="color: #af00ff;">progn</span>
                 (setf *glob-env* '((beta . 222)))
                 (<span style="color: #af00ff;">prog1</span> (list (myeval '(cons
                                        (setq beta 1)
                                        beta)
                                      nil nil nil nil #'err #'ok)
                              *glob-env*)
                   (setf *glob-env* nil)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-13" class="outline-3">
<h3 id="sec-8-13">LAMBDA</h3>
<div class="outline-text-3" id="text-8-13">
<p>
Заменяем <code>funcall cont</code> на <code>apply-continuation</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_lambda_9"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1089;&#1090;&#1072;&#1083;&#1086;</span>
((equal (car exp) 'lambda)   (apply-continuation cont (make-closure <span style="color: #5f5f87;">:body</span> (cddr exp)
                                                                    <span style="color: #5f5f87;">:block-env</span> block-env
                                                                    <span style="color: #5f5f87;">:env</span> env
                                                                    <span style="color: #5f5f87;">:go-env</span> go-env
                                                                    <span style="color: #5f5f87;">:args</span> (cadr exp))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_lambda_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LAMBDA</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '((<span style="color: #af00ff;">lambda</span> (x) (+ 1  x)) 2)
                         nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LAMBDA &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 5 (myeval '(<span style="color: #af00ff;">let</span> ((y 3))
                           ((<span style="color: #af00ff;">lambda</span> (x) (+ y x)) 2))
                         nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1085;&#1072; IMPLICIT-PROGN &#1074; LAMBDA</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 8 (myeval '(<span style="color: #af00ff;">let</span> ((y 3))
                           ((<span style="color: #af00ff;">lambda</span> (x)
                              (setq y 6)
                              (+ y x)) 2))
                         nil nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-14" class="outline-3">
<h3 id="sec-8-14">BLOCK</h3>
<div class="outline-text-3" id="text-8-14">
<p>
Нет лямбды - не нужно дефункционализировать
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_block_9">((equal (car exp) 'block)    (myeval (caddr exp)
                                     env
                                     (acons (cadr exp)
                                            cont
                                            block-env)
                                     go-env catch-env errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_block_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; BLOCK</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (myeval '(<span style="color: #af00ff;">block</span> testblock)
                           nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">block</span> testblock 3)
                         nil nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-15" class="outline-3">
<h3 id="sec-8-15">RETURN-FROM</h3>
<div class="outline-text-3" id="text-8-15">
<p>
С нашей текущей реализацией <code>block/return-from</code> есть одна проблема, которая проявляется
так: если присвоить внешней переменой значение какой-нибудь функции, которая
захватывает <code>block</code>, то таким образом можно сэмулировать <code>call/cc</code>.
</p>

<p>
В семантике Common Lisp <code>return-from</code> при выходе из блока, который уже закрыт должен
возвращать ошибку. В Common Lisp продолжение, создаваемое <code>block</code> ограничено
локально. Для того чтобы это реализовать необходимо, что <code>return-from</code> проверял, вышли
мы из блока или нет. Этого нельзя достичь до того как мы сделали дефункционализацию. Но
теперь мы можем пройтись по цепочке продолжений и посмотреть, достижимо ли из точки, в
которой мы находимся продолжение, в которое мы хотим попасть при выполнении
<code>return-from</code>. Для этого нам нужна функция, которая проходит по цепочке
продолжений. Назовем ее <code>is-cont-subset</code>. Она будет принимать два продолжения и должна
будет проверить, если ли первое продолжение во втором. По сути это похоже на <code>sublis</code>
только для продолжений.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_is_cont_subset_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">is-cont-subset</span> (target-cont cont)
  (<span style="color: #af00ff;">cond</span> ((equal target-cont cont) t)    <span style="color: #af0000;">;; </span><span style="color: #af0000;">positive</span>
        ((functionp cont) nil)          <span style="color: #af0000;">;; </span><span style="color: #af0000;">negative</span>
        (t (is-cont-subset target-cont (cdr cont)))))
</pre>
</div>

<p>
Для остановки рекурсии и возврата отрицательного ответа (nil) мы будем использовать то,
что у нас есть identity-продолжение, которое представлено как функция. В будущем, когда
мы полностью откажемся от представления продолжений в виде функций мы заменим в этой
строчке <code>functionp</code> на явное сравнение с оконечным продолжением. Важно отметить, что
сравнение <code>(equal target-cont cont)</code> должно идти раньше чем <code>(functionp cont)</code> по той
причине, что они могут совпадать и при этом оба быть функциями.
</p>

<p>
Теперь приступим к преобразованию <code>return-from</code>. Сначала заменяем <code>funcall</code> на
<code>apply-continuation</code> - это преобразование уже нам знакомо:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_return_from_9_step_1"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1089;&#1090;&#1072;&#1083;&#1086;</span>
((equal (car exp) 'return-from)
                             (<span style="color: #af00ff;">if</span> (not (symbolp (cadr exp)))
                                 (apply-continuation
                                  errcont
                                  (format nil <span style="color: #87005f;">"return-from: first argument not a symbol"</span>))
                                 (myeval (caddr exp) env block-env go-env catch-env errcont
                                         (<span style="color: #af00ff;">lambda</span> (x)
                                           (assoc-2 (cadr exp) block-env
                                                    (<span style="color: #af00ff;">lambda</span> (y) (apply-continuation y x))
                                                    (<span style="color: #af00ff;">lambda</span> (y) (apply-continuation
                                                                 errcont
                                                                 (format nil <span style="color: #87005f;">"return-from: undefined return block ~A"</span> y))))))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1073;&#1099;&#1083;&#1086;</span>
((equal (car exp) 'return-from)
                             (<span style="color: #af00ff;">if</span> (not (symbolp (cadr exp)))
                                 (funcall errcont
                                          (format nil
                                                  <span style="color: #87005f;">"return-from: first argument not a symbol"</span>))
                                 (myeval (caddr exp) env block-env go-env catch-env errcont
                                         (<span style="color: #af00ff;">lambda</span> (x)
                                           (assoc-2 (cadr exp) block-env
                                                    (<span style="color: #af00ff;">lambda</span> (y) (funcall y x))
                                                    (<span style="color: #af00ff;">lambda</span> (y) (funcall
                                                                 errcont
                                                                 (format nil <span style="color: #87005f;">"return-from: undefined return block ~A"</span> y))))))))
</pre>
</div>

<p>
Потом выполним кое-что поинтереснее. Когда <code>assoc-2</code> находит целевое продолжение
<code>return-from</code> он вызывает свое первое продолжение <code>success</code>. В этом продолжении мы
можем проверить, достижимо ли целевое продолжение <code>y</code> в <code>x</code>. Если да - то делаем
<code>apply-continuation</code>, иначе - применяем error-продолжение, потому что это ошибка
недостижимости.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_return_from_9">((equal (car exp) 'return-from)
                             (<span style="color: #af00ff;">if</span> (not (symbolp (cadr exp)))
                                 (apply-continuation
                                  errcont (format nil <span style="color: #87005f;">"return-from: first argument not a symbol"</span>))
                                 (myeval (caddr exp) env block-env go-env catch-env errcont
                                         (<span style="color: #af00ff;">lambda</span> (x)
                                           (assoc-2 (cadr exp) block-env
                                                    (<span style="color: #af00ff;">lambda</span> (y)
                                                      (<span style="color: #af00ff;">if</span> (is-cont-subset y cont)
                                                          (apply-continuation y x)
                                                          (apply-continuation
                                                           errcont
                                                           (format nil <span style="color: #87005f;">"return-from: attempt to RETURN-FROM to ~A that no longer exists"</span> (cadr exp)))))
                                                    (<span style="color: #af00ff;">lambda</span> (y)
                                                      (apply-continuation
                                                       errcont (format nil <span style="color: #87005f;">"return-from: undefined return block ~A"</span> y))))))))
</pre>
</div>

<p>
[TODO:gmm] продолжить дефункционализацию?
</p>


<p>
Добавляем тест на ошибку недостижимого блока. Для этого заставим return-from возвратить
тот блок из которого он только что вышел. Аналогично проверяем, что эта ошибка не
срабатывает в корректных блоках.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_return_from_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; RETURN-FROM</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">block</span> testblock (<span style="color: #af00ff;">return-from</span> testblock (+ 1 2)) 777)
                         nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span> (myeval '(<span style="color: #af00ff;">block</span> testblock (<span style="color: #af00ff;">return-from</span> notblock (+ 1 2)) 777)
                               nil nil nil nil #'(<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>) #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span> (myeval '(<span style="color: #af00ff;">progn</span> (<span style="color: #af00ff;">return-from</span> not-found-block (+ 1 2)) 777)
                               nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                               #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; RETURN-FROM &#1074; &#1083;&#1077;&#1082;&#1089;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 12 (<span style="color: #af00ff;">progn</span>
                    (setf *glob-env* nil)
                    (<span style="color: #af00ff;">prog1</span> (myeval '(<span style="color: #af00ff;">progn</span>
                                     (<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                       (<span style="color: #af00ff;">block</span> in-lambda-block
                                         (<span style="color: #af00ff;">return-from</span> in-lambda-block
                                           (+ x 2))
                                         777))
                                     (foo 10))
                                   nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                                   #'ok)
                      (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; RETURN-FROM &#1074; &#1076;&#1080;&#1085;&#1072;&#1084;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080; (&#1076;&#1086;&#1083;&#1078;&#1085;&#1072; &#1073;&#1099;&#1090;&#1100; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072;)</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span> (<span style="color: #af00ff;">progn</span>
                         (setf *glob-env* nil)
                         (<span style="color: #af00ff;">prog1</span> (myeval '(<span style="color: #af00ff;">progn</span>
                                          (<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                            (<span style="color: #af00ff;">return-from</span> in-lambda-block
                                              (+ x 2))
                                            777)
                                          (<span style="color: #af00ff;">block</span> in-lambda-block
                                            (foo 10)))
                                        nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                                        #'ok)
                           (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1085;&#1072; &#1086;&#1096;&#1080;&#1073;&#1082;&#1091; &#1085;&#1077;&#1076;&#1086;&#1089;&#1090;&#1080;&#1078;&#1080;&#1084;&#1086;&#1075;&#1086; &#1073;&#1083;&#1086;&#1082;&#1072;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span> (myeval '((<span style="color: #af00ff;">block</span> the-block (<span style="color: #af00ff;">lambda</span> () (<span style="color: #af00ff;">return-from</span> the-block nil))))
                               nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                               #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1085;&#1072; &#1086;&#1090;&#1089;&#1091;&#1090;&#1089;&#1090;&#1074;&#1080;&#1077; &#1086;&#1096;&#1080;&#1073;&#1082;&#1080; &#1087;&#1088;&#1080; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1077; &#1074; &#1076;&#1086;&#1089;&#1090;&#1080;&#1078;&#1080;&#1084;&#1099;&#1081; &#1073;&#1083;&#1086;&#1082;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 123 (myeval '(<span style="color: #af00ff;">block</span> the-block (<span style="color: #af00ff;">return-from</span> the-block 123))
                           nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                           #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-16" class="outline-3">
<h3 id="sec-8-16">CATCH</h3>
<div class="outline-text-3" id="text-8-16">
<p>
Определим структуру для сохранения продолжения <code>catch</code>, которая будет унаследована от
<code>unicond</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_9">(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">catch-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  clauses
  env)
</pre>
</div>

<p>
Теперь в <code>myeval</code>, будем создавать эту структуру и передавать её в качестве продолжения
в <code>myeval</code>, вместо лямбды:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_catch_9">((equal (car exp) 'catch)    (myeval (cadr exp) env block-env go-env catch-env errcont
                                     (make-catch-cont
                                      <span style="color: #5f5f87;">:clauses</span> exp
                                      <span style="color: #5f5f87;">:env</span> env
                                      <span style="color: #5f5f87;">:block-env</span> block-env
                                      <span style="color: #5f5f87;">:go-env</span> go-env
                                      <span style="color: #5f5f87;">:catch-env</span> catch-env
                                      <span style="color: #5f5f87;">:errcont</span> errcont
                                      <span style="color: #5f5f87;">:cont</span> cont)))
</pre>
</div>

<p>
А саму логику из лямбды переместим в <code>apply-continuation</code>, заменяя вызов продолжения
через <code>funcall</code> на вызов через <code>apply-continuation</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_catch_9">((catch-cont-p cont)    (<span style="color: #af00ff;">if</span> (not (symbolp arg))
                            (apply-continuation
                             errcont
                             (format nil <span style="color: #87005f;">"catch: first argument not a symbol"</span>))
                            (myeval (caddr (catch-cont-clauses cont))
                                    (catch-cont-env cont)
                                    (catch-cont-block-env cont)
                                    (catch-cont-go-env cont)
                                    (acons arg
                                           (catch-cont-cont cont)
                                           (catch-cont-catch-env cont))
                                    (catch-cont-errcont cont)
                                    (catch-cont-cont cont))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_catch_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; CATCH</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (myeval '(<span style="color: #af00ff;">catch</span> '<span style="color: #008787;">zzz</span>)
                           nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">catch</span> '<span style="color: #008787;">zzz</span> 3)
                         nil nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-17" class="outline-3">
<h3 id="sec-8-17">THROW</h3>
<div class="outline-text-3" id="text-8-17">
<p>
Определим структуру для сохранения продолжения <code>throw</code>, которая будет унаследована от
<code>unicond</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_9">(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">throw-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  clauses
  env)
</pre>
</div>

<p>
Теперь в <code>evthrow</code>, которая вызывается из <code>myeval</code>, будем создавать эту структуру и
передавать её в качестве продолжения в <code>myeval</code>, вместо лямбды:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evthrow_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evthrow</span> (exp env block-env go-env catch-env errcont cont)
  (myeval (cadr exp) env block-env go-env catch-env errcont
          (make-throw-cont
           <span style="color: #5f5f87;">:clauses</span> exp
           <span style="color: #5f5f87;">:env</span> env
           <span style="color: #5f5f87;">:block-env</span> block-env
           <span style="color: #5f5f87;">:go-env</span> go-env
           <span style="color: #5f5f87;">:catch-env</span> catch-env
           <span style="color: #5f5f87;">:errcont</span> errcont
           <span style="color: #5f5f87;">:cont</span> cont)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_throw_9">((equal (car exp) 'throw)    (evthrow exp
                                      env block-env go-env catch-env
                                      errcont cont))
</pre>
</div>

<p>
А саму логику из лямбды переместим в <code>apply-continuation</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_throw_9_step_1">((throw-cont-p cont)    (myeval (caddr (throw-cont-clauses cont))
                                (throw-cont-env cont)
                                (throw-cont-block-env cont)
                                (throw-cont-go-env cont)
                                (throw-cont-catch-env cont)
                                (throw-cont-errcont cont)
                                (make-throw2-cont
                                 <span style="color: #5f5f87;">:prev-arg</span> arg
                                 <span style="color: #5f5f87;">:catch-env</span> catch-env
                                 <span style="color: #5f5f87;">:errcont</span> errcont
                                (<span style="color: #af00ff;">lambda</span> (exp-res)
                                  (assoc-2 arg catch-env
                                           (<span style="color: #af00ff;">lambda</span> (cont-res)
                                             (apply-continuation cont-res exp-res))
                                           (<span style="color: #af00ff;">lambda</span> (key)
                                             (apply-continuation errcont
                                                      (format
                                                       nil
                                                       <span style="color: #87005f;">"throw: matching ~A catch is not found"</span>
                                                       key)))))))
</pre>
</div>

<p>
Продолжения передаваемые в assoc-2 не надо дефункционализировать, т.к. продолжения тут
используются для выражения полупредиката. А вот оборачивающую лямбду
дефункционализировать придется, поэтому создаем для нее еще одну структуру:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_9">(<span style="color: #af00ff;">defstruct</span> <span style="color: #008700;">throw2-cont</span>
  prev-arg
  catch-env
  errcont)
</pre>
</div>

<p>
Соответственно добавляем обработку этой структуры в <code>apply-continuation</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_throw2_9">((throw2-cont-p cont)   (assoc-2 (throw2-cont-prev-arg cont)
                                 (throw2-cont-catch-env cont)
                                 (<span style="color: #af00ff;">lambda</span> (cont-res)
                                   (apply-continuation cont-res arg))
                                 (<span style="color: #af00ff;">lambda</span> (key)
                                   (apply-continuation (throw2-cont-errcont cont)
                                            (format
                                             nil
                                             <span style="color: #87005f;">"throw: matching ~A catch is not found"</span>
                                             key)))))
</pre>
</div>

<p>
Тогда получается так:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_throw_9">((throw-cont-p cont)    (myeval (caddr (throw-cont-clauses cont))
                                (throw-cont-env cont)
                                (throw-cont-block-env cont)
                                (throw-cont-go-env cont)
                                (throw-cont-catch-env cont)
                                (throw-cont-errcont cont)
                                (make-throw2-cont
                                 <span style="color: #5f5f87;">:prev-arg</span> arg
                                 <span style="color: #5f5f87;">:catch-env</span> (throw-cont-catch-env cont)
                                 <span style="color: #5f5f87;">:errcont</span> (throw-cont-errcont cont))))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myeval_throw_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; THROW</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">catch</span> '<span style="color: #008787;">testcatch</span> (<span style="color: #af00ff;">throw</span> '<span style="color: #008787;">testcatch</span> (+ 1 2)) 777)
                         nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span> (myeval '(<span style="color: #af00ff;">catch</span> '<span style="color: #008787;">testcatch</span> (<span style="color: #af00ff;">throw</span> '<span style="color: #008787;">notcatch</span> (+ 1 2)) 777)
                               nil nil nil nil
                               #'(<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                               #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span> (myeval '(<span style="color: #af00ff;">progn</span> (<span style="color: #af00ff;">throw</span> '<span style="color: #008787;">not-found-catch</span> (+ 1 2)) 777)
                               nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                               #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; THROW &#1074; &#1083;&#1077;&#1082;&#1089;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 12 (<span style="color: #af00ff;">progn</span>
                    (setf *glob-env* nil)
                    (<span style="color: #af00ff;">prog1</span> (myeval '(<span style="color: #af00ff;">progn</span>
                                     (<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                       (<span style="color: #af00ff;">catch</span> '<span style="color: #008787;">in-lambda-catch</span>
                                         (<span style="color: #af00ff;">throw</span> '<span style="color: #008787;">in-lambda-catch</span>
                                           (+ x 2))
                                         777))
                                     (foo 10))
                                   nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                                   #'ok)
                      (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; THROW &#1074; &#1076;&#1080;&#1085;&#1072;&#1084;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080; (&#1076;&#1086;&#1083;&#1078;&#1085;&#1086; &#1089;&#1088;&#1072;&#1073;&#1086;&#1090;&#1072;&#1090;&#1100;)</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 12 (<span style="color: #af00ff;">progn</span>
                    (setf *glob-env* nil)
                    (<span style="color: #af00ff;">prog1</span> (myeval '(<span style="color: #af00ff;">progn</span>
                                     (<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                       (<span style="color: #af00ff;">throw</span> '<span style="color: #008787;">in-lambda-catch</span>
                                         (+ x 2))
                                       777)
                                     (<span style="color: #af00ff;">catch</span> '<span style="color: #008787;">in-lambda-catch</span>
                                       (foo 10)))
                                   nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                                   #'ok)
                      (setf *glob-env* nil)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-18" class="outline-3">
<h3 id="sec-8-18">TAGBODY</h3>
<div class="outline-text-3" id="text-8-18">
<div class="org-src-container">

<pre class="src src-lisp" id="tagbody_slice_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">tagbody-slice</span> (exp res)
  (<span style="color: #af00ff;">cond</span> ((null exp) res)
        ((symbolp (car exp))  (tagbody-slice (cdr exp) (cons exp res)))
        (t                    (tagbody-slice (cdr exp) res))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="tagbody_check_tag_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">tagbody-check-tag</span> (exp cont errcont)
  (<span style="color: #af00ff;">cond</span> ((null exp) (funcall cont))
        ((and (symbolp (car exp))
              (member (car exp) (cdr exp)))
         (funcall errcont (car exp)))
        (t (tagbody-check-tag (cdr exp) cont errcont))))
</pre>
</div>

<p>
Определим структуру для сохранения продолжения TAGBODY, которая будет унаследована от
<code>unicond</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_9">(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">evtagbody-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  body
  env)
</pre>
</div>

<p>
Теперь <code>evtagbody</code>, в случае получения непустого <code>body</code> будет создавать эту структуру и
передавать её в качестве продолжения в <code>myeval</code>, вместо лямбды:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evtagbody_9">&lt;&lt;tagbody_check_tag_9&gt;&gt;
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evtagbody</span> (body env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null (car body))      (apply-continuation cont nil))
        ((symbolp (car body))   (evtagbody (cdr body) env block-env go-env catch-env errcont cont))
        (t                      (myeval (car body) env block-env go-env catch-env errcont
                                        (make-evtagbody-cont
                                         <span style="color: #5f5f87;">:body</span> (cdr body)
                                         <span style="color: #5f5f87;">:env</span>  env
                                         <span style="color: #5f5f87;">:block-env</span> block-env
                                         <span style="color: #5f5f87;">:go-env</span> go-env
                                         <span style="color: #5f5f87;">:catch-env</span> catch-env
                                         <span style="color: #5f5f87;">:errcont</span> errcont
                                         <span style="color: #5f5f87;">:cont</span> cont)))))
&lt;&lt;tagbody_slice_9&gt;&gt;
</pre>
</div>

<p>
Теперь перейдем к вызову. Напомним, для ориентира, как выглядит обработка
<code>tagbody</code>-формы в <code>myeval</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp">((equal (car exp) 'tagbody)  (tagbody-check-tag
                              (cdr exp)
                              (<span style="color: #af00ff;">lambda</span> ()
                                (setq go-env
                                      (append (mapcar #'(<span style="color: #af00ff;">lambda</span> (x)
                                                          (cons (car x)
                                                                (<span style="color: #af00ff;">lambda</span> ()
                                                                  (evtagbody x
                                                                             env
                                                                             block-env
                                                                             go-env
                                                                             catch-env
                                                                             errcont cont))))
                                                      (tagbody-slice (cdr exp) nil))
                                              go-env))
                                (evtagbody (cdr exp) env block-env go-env catch-env errcont cont))
                              (<span style="color: #af00ff;">lambda</span> (x)
                                (apply-continuation
                                 errcont
                                 (format
                                  nil
                                  <span style="color: #87005f;">"tagbody: The tag ~A appears more than once in a tagbody"</span> x)))))
</pre>
</div>

<p>
Продолжая дефункционализацию нам надо преобразовать лямбду, которая вызывает
<code>evtagbody</code> (самую глубокую по уровню в примере выше). Преобразуем ее в структуру,
которую назовем <code>go-cont</code>. Помимо unicont-полей она будет содержать <code>env</code> и свой
<code>slice</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_9">(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">go-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  slice
  env)
</pre>
</div>

<p>
Поднимаясь до уровня <code>append</code> мы делаем список таких структур. Но тогда у нас будет
выпадать <code>go-env</code>, потому что: пока мы не сделали окружение мы не можем его записать в
<code>go-env</code>, т.е цикличности не получится.
</p>

<p>
Поэтому мы применим тот же трюк что и с <code>labels</code>: мы сделаем все окружения, а потом
пройдемся по ним и <code>setf</code>-ом изменим поле <code>go-env</code> в них. Для удобства мы
дефункционализируем не всю лямбду, а ее часть, соответствующую содержимому формы
<code>setq</code>. Назовем этот кусок <code>make-go-env</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_make_goenv_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">make-go-env</span> (tagbody-body env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">let*</span> ((conts (mapcar #'(<span style="color: #af00ff;">lambda</span> (x) <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1077;&#1085;&#1080;&#1103;, &#1085;&#1072;&#1088;&#1077;&#1079;&#1072;&#1085;&#1085;&#1099;&#1077; &#1080;&#1079; tagbody</span>
                            (make-go-cont
                             <span style="color: #5f5f87;">:slice</span> x
                             <span style="color: #5f5f87;">:env</span> env
                             <span style="color: #5f5f87;">:block-env</span> block-env
                             <span style="color: #5f5f87;">:go-env</span> go-env <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1101;&#1090;&#1086;&#1090; &#1089;&#1083;&#1086;&#1090; &#1073;&#1091;&#1076;&#1077;&#1084; setf-&#1101;&#1092;&#1080;&#1090;&#1100;</span>
                             <span style="color: #5f5f87;">:catch-env</span>  catch-env
                             <span style="color: #5f5f87;">:errcont</span> errcont
                             <span style="color: #5f5f87;">:cont</span> cont))
                        (tagbody-slice tagbody-body nil)))
         <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1072;&#1088;&#1099; (&#1089;&#1080;&#1084;&#1074;&#1086;&#1083; . &#1087;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1077;&#1085;&#1080;&#1077;) &#1085;&#1072;&#1088;&#1077;&#1079;&#1072;&#1085;&#1085;&#1099;&#1077; &#1080;&#1079;</span>
         <span style="color: #af0000;">;; </span><span style="color: #af0000;">tagbody &#1080; &#1076;&#1086;&#1073;&#1072;&#1074;&#1083;&#1077;&#1085;&#1085;&#1099;&#1077; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
         (new-go-env (append (mapcar #'(<span style="color: #af00ff;">lambda</span> (go-cont)
                                         (cons (car (go-cont-slice go-cont))
                                               go-cont))
                                     conts)
                             go-env)))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1080;&#1079;&#1084;&#1077;&#1085;&#1103;&#1077;&#1084; &#1087;&#1086;&#1083;&#1103; go-env, &#1079;&#1072;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1103; &#1074; &#1085;&#1080;&#1093; new-go-env</span>
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1074;&#1086; &#1074;&#1089;&#1077;&#1093; &#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1087;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1077;&#1085;&#1080;&#1103;&#1093;</span>
    (<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> elt-cont <span style="color: #5f5f87;">:in</span> conts <span style="color: #5f5f87;">:do</span>
       (setf (go-cont-go-env elt-cont)
             new-go-env))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084; &#1085;&#1086;&#1074;&#1086;&#1077; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
    new-go-env))
</pre>
</div>

<p>
Также нам нужна функция, которая будет <code>go-cont</code> применять, она будет вызывать
<code>evtagbody</code> - мы просто переносём логику самой глубокой лямбды в нее. Эта функция будет
вызываться при обработке формы <code>go</code>. Она просто вызывает <code>evtagbody</code>, которая просто
проходит по телу <code>tagbody</code> и выполняет все формы, отбрасывая метки.
</p>

<p>
Мы могли бы применять <code>go-cont</code> как обычное продолжение, и тогда мы бы добавили его в
<code>apply-continuation</code>. Но лучше сделать для него отдельную функцию, потому что <code>go-cont</code>
отличается от всех остальных продолжений тем, что у него нет параметров.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_apply_go_continuation_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">apply-go-continuation</span> (go-cont)
  (evtagbody (go-cont-slice go-cont)
             (go-cont-env go-cont)
             (go-cont-block-env go-cont)
             (go-cont-go-env go-cont)
             (go-cont-catch-env go-cont)
             (go-cont-errcont go-cont)
             (go-cont-cont go-cont)))
</pre>
</div>

<p>
Теперь в <code>myeval</code> мы должны:
</p>
<ul class="org-ul">
<li>Заменить <code>funcall</code> на <code>apply-continuation</code>
</li>
<li>Заменить форму <code>setf</code> на вызов <code>evtagbody</code>, в котором для формирования окружения
<code>go-env</code> вызовем <code>make-go-env</code>.
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_tagbody_9">((equal (car exp) 'tagbody)  (tagbody-check-tag
                              (cdr exp)
                              (<span style="color: #af00ff;">lambda</span> ()
                                (evtagbody (cdr exp) env block-env
                                           (make-go-env (cdr exp)
                                                        env block-env go-env catch-env
                                                        errcont cont)
                                           catch-env errcont cont))
                              (<span style="color: #af00ff;">lambda</span> (x)
                                (apply-continuation
                                 errcont
                                 (format
                                  nil
                                  <span style="color: #87005f;">"tagbody: The tag ~A appears more than once in a tagbody"</span>
                                  x)))))
</pre>
</div>

<p>
Теперь добавим в <code>apply-continuation</code> обработку <code>evtagbody-cont</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evtagbody_9">((evtagbody-cont-p cont) (evtagbody (evtagbody-cont-body cont)
                                    (evtagbody-cont-env cont)
                                    (unicont-block-env cont)
                                    (unicont-go-env cont)
                                    (unicont-catch-env cont)
                                    (unicont-errcont cont)
                                    (unicont-cont cont)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_tagbody_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; TAGBODY</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (myeval '(<span style="color: #af00ff;">tagbody</span> a 1)
                           nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (myeval '(<span style="color: #af00ff;">tagbody</span> a 1 b 2)
                           nil nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-19" class="outline-3">
<h3 id="sec-8-19">GO</h3>
<div class="outline-text-3" id="text-8-19">
<p>
Заменяем <code>funcall</code> на <code>(apply-continuation x 'NOT-A-PARAM)</code>. А потом сразу же заменяем
его на <code>apply-go-continuation</code>, определенный в разделе <code>tagbody</code>.
</p>

<p>
[TODO:gmm] В следующем файле перенести определение <code>apply-go-continuation</code> сюда.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_go_9"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1089;&#1090;&#1072;&#1083;&#1086;</span>
((equal (car exp) 'go)       (assoc-2 (cadr exp) go-env
                                      (<span style="color: #af00ff;">lambda</span> (go-cont)
                                        (apply-go-continuation go-cont))
                                      (<span style="color: #af00ff;">lambda</span> (go-label)
                                        (apply-continuation
                                         errcont
                                         (format nil <span style="color: #87005f;">"go: wrong target ~A"</span> go-label)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1088;&#1086;&#1084;&#1077;&#1078;&#1091;&#1090;&#1086;&#1095;&#1085;&#1099;&#1081; &#1074;&#1072;&#1088;&#1080;&#1072;&#1085;&#1090;</span>
((equal (car exp) 'go)       (assoc-2 (cadr exp) go-env
                                      (<span style="color: #af00ff;">lambda</span> (x)
                                        (apply-continuation x 'NOT-A-PARAM))
                                      (<span style="color: #af00ff;">lambda</span> (x)
                                        (apply-continuation
                                         errcont
                                         (format nil <span style="color: #87005f;">"go: wrong target ~A"</span> x)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1073;&#1099;&#1083;&#1086;</span>
((equal (car exp) 'go)       (assoc-2 (cadr exp) go-env
                                      (<span style="color: #af00ff;">lambda</span> (x)
                                        (funcall x))
                                      (<span style="color: #af00ff;">lambda</span> (x)
                                        (funcall
                                         errcont
                                         (format nil <span style="color: #87005f;">"go: wrong target ~A"</span> x)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_go_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; GO</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 4) (myeval '(<span style="color: #af00ff;">let</span> ((alfa 0))
                                  (<span style="color: #af00ff;">tagbody</span>
                                   a (setq alfa 1)
                                   b (<span style="color: #af00ff;">go</span> d)
                                   c (setq alfa (cons alfa 3))
                                   d (setq alfa (cons alfa 4)))
                                  alfa)
                                nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; "&#1086;&#1073;&#1088;&#1072;&#1090;&#1085;&#1086;&#1075;&#1086; &#1093;&#1086;&#1076;&#1072;" GO</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 5) (myeval '(<span style="color: #af00ff;">let</span> ((alfa 0))
                                  (<span style="color: #af00ff;">tagbody</span>
                                   a (<span style="color: #af00ff;">go</span> d)
                                   b (setq alfa 1)
                                   c (<span style="color: #af00ff;">go</span> e)
                                   d (<span style="color: #af00ff;">go</span> b)
                                   e (setq alfa (cons alfa 5)))
                                  alfa)
                                nil nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-20" class="outline-3">
<h3 id="sec-8-20">LABELS</h3>
<div class="outline-text-3" id="text-8-20">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_labels_9">((equal (car exp) 'labels)   (<span style="color: #af00ff;">let*</span> ((alist (mapcar (<span style="color: #af00ff;">lambda</span> (label) <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1092;&#1086;&#1088;&#1084;&#1080;&#1088;&#1091;&#1077;&#1084; &#1089;&#1087;&#1080;&#1089;&#1086;&#1082; &#1087;&#1072;&#1088; (&#1080;&#1084;&#1103; . nil)</span>
                                                     (cons (car label) nil))
                                                   (cadr exp)))
                                    (new-env (append alist env))   <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1076;&#1086;&#1073;&#1072;&#1074;&#1080;&#1084; &#1082; &#1089;&#1087;&#1080;&#1089;&#1082;&#1091; &#1087;&#1072;&#1088; &#1087;&#1088;&#1077;&#1076;&#1099;&#1076;&#1091;&#1097;&#1077;&#1077; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
                                    (closures (mapcar (<span style="color: #af00ff;">lambda</span> (label)
                                                        <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1089;&#1086;&#1079;&#1076;&#1072;&#1077;&#1084; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1077;, &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1102;&#1097;&#1077;&#1077; (env) &#1085;&#1072; &#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1085;&#1099;&#1077; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1099;&#1077; (&#1089;&#1086;&#1076;&#1077;&#1088;&#1078;&#1072;&#1097;&#1080;&#1077; &#1087;&#1086;&#1082;&#1072; nil)</span>
                                                        (make-closure <span style="color: #5f5f87;">:body</span> (cddr label) <span style="color: #af0000;">;; </span><span style="color: #af0000;">implicit progn</span>
                                                                      <span style="color: #5f5f87;">:block-env</span> block-env
                                                                      <span style="color: #5f5f87;">:env</span> new-env
                                                                      <span style="color: #5f5f87;">:go-env</span> go-env
                                                                      <span style="color: #5f5f87;">:args</span> (cadr label)))
                                                      (cadr exp))))
                               <span style="color: #af0000;">;; </span><span style="color: #af0000;">alist:    '((zzz . nil) (xxx . nil))</span>
                               <span style="color: #af0000;">;; </span><span style="color: #af0000;">new-env:  '((zzz . nil) (xxx . nil) (old . #:closure))</span>
                               <span style="color: #af0000;">;; </span><span style="color: #af0000;">closures: '(#:closure #:closure) ;; &#1091; &#1101;&#1090;&#1080;&#1093; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1081; :env &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; new-env</span>
                               (<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (length alist) (length closures)))
                               (<span style="color: #af00ff;">loop</span>
                                  <span style="color: #5f5f87;">:for</span> aelt     <span style="color: #5f5f87;">:in</span> alist
                                  <span style="color: #5f5f87;">:for</span> closure  <span style="color: #5f5f87;">:in</span> closures
                                  <span style="color: #5f5f87;">:do</span> (rplacd aelt closure))
                               <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084;:</span>
                               <span style="color: #af0000;">;; </span><span style="color: #af0000;">alist:    '((zzz . #:closure) (xxx . #:closure))</span>
                               <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1048; &#1087;&#1077;&#1088;&#1077;&#1076;&#1072;&#1077;&#1084; new-env &#1074; &#1082;&#1072;&#1095;&#1077;&#1089;&#1090;&#1074;&#1077; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
                               (evprogn (cddr exp) new-env block-env go-env catch-env errcont cont)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_labels_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LABELS</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">labels</span> ((zzz (lst acc)
                          (print acc)
                          (<span style="color: #af00ff;">cond</span> ((null lst) acc)
                                (t (zzz (cdr lst) (+ 1 acc))))))
                 (print 888)
                 (zzz '(1 2 3) 0))
               (myeval '(<span style="color: #af00ff;">labels</span> ((zzz (lst acc)
                                  (print acc)
                                  (<span style="color: #af00ff;">cond</span> ((null lst) acc)
                                        (t (zzz (cdr lst) (+ 1 acc))))))
                         (print 888)
                         (zzz '(1 2 3) 0))
                         nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (<span style="color: #af00ff;">labels</span> ((zzz (lst acc)
                            (print acc)
                            (<span style="color: #af00ff;">cond</span> ((null lst) acc)
                                  (t (zzz (cdr lst) (+ 1 acc))))))
                   (print 888)
                   (zzz '(1 2 3) 0)))
               (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (myeval '(<span style="color: #af00ff;">labels</span> ((zzz (lst acc)
                                    (print acc)
                                    (<span style="color: #af00ff;">cond</span> ((null lst) acc)
                                          (t (zzz (cdr lst) (+ 1 acc))))))
                           (print 888)
                           (zzz '(1 2 3) 0))
                         nil nil nil nil #'err #'identity))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-21" class="outline-3">
<h3 id="sec-8-21">RESET</h3>
<div class="outline-text-3" id="text-8-21">
<p>
Заменяем <code>funcall</code> на <code>apply-continuation</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_reset_9">((equal (car exp) 'reset)    (apply-continuation cont (myeval (cadr exp)
                                                              env block-env go-env catch-env
                                                              errcont #'identity)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_reset_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; RESET</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 8 (myeval '(<span style="color: #af00ff;">progn</span>
                            (+ 1 (reset (+ 2 3)) 2))
                            nil nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-22" class="outline-3">
<h3 id="sec-8-22">SHIFT</h3>
<div class="outline-text-3" id="text-8-22">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_shift_9">((equal (car exp) 'shift)    (myeval (caddr exp)
                                     (acons (cadr exp) cont env)
                                     block-env go-env catch-env
                                     errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_shift_9_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; SHIFT/RESET</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 44 (myeval '(<span style="color: #af00ff;">let</span> ((foo))
                            (+ 1 (reset (+ 2 (shift f (<span style="color: #af00ff;">progn</span> (setq foo f) 4)))))
                            (foo 42))
                          nil nil nil nil #'err #'ok)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9">REPL</h2>
<div class="outline-text-2" id="text-9">
<div class="org-src-container">

<pre class="src src-lisp" id="repl_9">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">repl</span> (prompt catch-env errcont cont)
  (format t <span style="color: #87005f;">"~%~A&gt; "</span> prompt)
  (finish-output)
  (myeval (read) nil nil nil (acons 'exit cont catch-env)
    #'(<span style="color: #af00ff;">lambda</span> (x)
        (princ x)
        (terpri)
        (finish-output)
        (repl prompt catch-env errcont cont))
    #'(<span style="color: #af00ff;">lambda</span> (x)
        (princ x)
        (terpri)
        (finish-output)
        (repl prompt catch-env errcont cont))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10">Итоги</h2>
<div class="outline-text-2" id="text-10">
<div class="org-src-container">

<pre class="src src-lisp">(setq *print-circle* T)
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1050;&#1083;&#1072;&#1089;&#1089;&#1099; &#1086;&#1096;&#1080;&#1073;&#1086;&#1082;</span>
&lt;&lt;errors_9&gt;&gt;
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1057;&#1090;&#1088;&#1091;&#1082;&#1090;&#1091;&#1088;&#1099;</span>
&lt;&lt;unicont_9&gt;&gt;
<span style="color: #af0000;">;; </span><span style="color: #af0000;">APPLY-CONTINUATION</span>
&lt;&lt;apply_continuation_9&gt;&gt;
<span style="color: #af0000;">;; </span><span style="color: #af0000;">CPS-&#1074;&#1077;&#1088;&#1089;&#1080;&#1103; ASSOC</span>
&lt;&lt;assoc_9&gt;&gt;
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1053;&#1086;&#1074;&#1072;&#1103; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; lookup</span>
&lt;&lt;lookup_9&gt;&gt;
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1057;&#1090;&#1088;&#1091;&#1082;&#1090;&#1091;&#1088;&#1072; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1103;</span>
&lt;&lt;closure_9&gt;&gt;
<span style="color: #af0000;">;; </span><span style="color: #af0000;">CPS-&#1074;&#1072;&#1088;&#1080;&#1072;&#1085;&#1090; MYAPPLY &#1080; &#1074;&#1089;&#1077; &#1095;&#1090;&#1086; &#1082; &#1085;&#1077;&#1084;&#1091; &#1086;&#1090;&#1085;&#1086;&#1089;&#1080;&#1090;&#1089;&#1103;</span>
&lt;&lt;myapply_9&gt;&gt;
<span style="color: #af0000;">;; </span><span style="color: #af0000;">CPS-&#1074;&#1072;&#1088;&#1080;&#1072;&#1085;&#1090; MYEVAL &#1080; &#1074;&#1089;&#1077; &#1095;&#1090;&#1086; &#1082; &#1085;&#1077;&#1084;&#1091; &#1086;&#1090;&#1085;&#1086;&#1089;&#1080;&#1090;&#1089;&#1103;</span>
&lt;&lt;myeval_9&gt;&gt;
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1080;&#1088;&#1091;&#1077;&#1084; &#1085;&#1086;&#1074;&#1099;&#1081; lookup</span>
&lt;&lt;lookup_9_test&gt;&gt;
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1060;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080; &#1076;&#1083;&#1103; &#1090;&#1077;&#1089;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; CPS-&#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1081;</span>
&lt;&lt;ok_err_9&gt;&gt;
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; MYAPPLY</span>
&lt;&lt;myapply_9_test&gt;&gt;
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; MYEVAL</span>
&lt;&lt;myeval_9_test&gt;&gt;
<span style="color: #af0000;">;; </span><span style="color: #af0000;">REPL</span>
&lt;&lt;repl_9&gt;&gt;
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(repl)</span>
</pre>
</div>

<p>
Получиться должен вот такой результат:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(setq *print-circle* T)
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1050;&#1083;&#1072;&#1089;&#1089;&#1099; &#1086;&#1096;&#1080;&#1073;&#1086;&#1082;</span>
(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">unknown-continuation</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((cont <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:cont</span>  <span style="color: #5f5f87;">:reader</span> cont))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in APPLY-CONTINUATION: unknown-continuation: ~A"</span>
             (cont condition)))))
(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">unknown-function</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((fn <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:fn</span>  <span style="color: #5f5f87;">:reader</span> fn))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYAPPLY: unknown-function: ~A"</span>
             (fn condition)))))
(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">invalid-number-of-arguments</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((fn <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:fn</span>  <span style="color: #5f5f87;">:reader</span> fn))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYAPPLY: invalid-number-of-arguments: ~A"</span>
             (fn condition)))))
(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">mypairlis-error</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((lst1 <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:lst1</span>  <span style="color: #5f5f87;">:reader</span> lst1)
   (lst2 <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:lst2</span>  <span style="color: #5f5f87;">:reader</span> lst2))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYPAIRLIS: wrong params:~%'~A~%'~A"</span>
             (lst1 condition) (lst2 condition)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1057;&#1090;&#1088;&#1091;&#1082;&#1090;&#1091;&#1088;&#1099;</span>
(<span style="color: #af00ff;">defstruct</span> <span style="color: #008700;">unicont</span>
  block-env
  go-env
  catch-env
  errcont
  cont)
(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">evlis-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  fn
  unevaled
  evaled
  env)
(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">if-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  clauses
  env)
(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">evcond-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  clauses
  env)
(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">evprogn-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  clauses
  env)
(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">and-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  exps
  env)
(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">or-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  exps
  env)
(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">evlet-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  vars
  exps
  evald-exps
  exp
  env)
(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">evletstar-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  varpairs
  exp
  env)
(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">setq-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  clauses
  env)
(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">catch-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  clauses
  env)
(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">throw-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  clauses
  env)
(<span style="color: #af00ff;">defstruct</span> <span style="color: #008700;">throw2-cont</span>
  prev-arg
  catch-env
  errcont)
(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">evtagbody-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  body
  env)
(<span style="color: #af00ff;">defstruct</span> (<span style="color: #008700;">go-cont</span> (<span style="color: #5f5f87;">:include</span> unicont))
  slice
  env)
<span style="color: #af0000;">;; </span><span style="color: #af0000;">APPLY-CONTINUATION</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">apply-continuation</span> (cont arg)
  (<span style="color: #af00ff;">cond</span> ((functionp cont)       (funcall cont arg))
        ((if-cont-p cont)       (<span style="color: #af00ff;">if</span> arg
                                    (myeval (caddr (if-cont-clauses cont))
                                            (if-cont-env cont)
                                            (if-cont-block-env cont)
                                            (if-cont-go-env cont)
                                            (if-cont-catch-env cont)
                                            (if-cont-errcont cont)
                                            (if-cont-cont cont))
                                    (myeval (cadddr (if-cont-clauses cont))
                                            (if-cont-env cont)
                                            (if-cont-block-env cont)
                                            (if-cont-go-env cont)
                                            (if-cont-catch-env cont)
                                            (if-cont-errcont cont)
                                            (if-cont-cont cont))))
        ((evcond-cont-p cont)   (<span style="color: #af00ff;">if</span> arg
                                    (myeval (cadar (evcond-cont-clauses cont))
                                            (evcond-cont-env cont)
                                            (evcond-cont-block-env cont)
                                            (evcond-cont-go-env cont)
                                            (evcond-cont-catch-env cont)
                                            (evcond-cont-errcont cont)
                                            (evcond-cont-cont cont))
                                    (evcond (cdr (evcond-cont-clauses cont))
                                            (evcond-cont-env cont)
                                            (evcond-cont-block-env cont)
                                            (evcond-cont-go-env cont)
                                            (evcond-cont-catch-env cont)
                                            (evcond-cont-errcont cont)
                                            (evcond-cont-cont cont))))
        ((evprogn-cont-p cont)  (evprogn (cdr (evprogn-cont-clauses cont))
                                         (evprogn-cont-env cont)
                                         (evprogn-cont-block-env cont)
                                         (evprogn-cont-go-env cont)
                                         (evprogn-cont-catch-env cont)
                                         (evprogn-cont-errcont cont)
                                         (evprogn-cont-cont cont)))
        ((evcond-cont-p cont)   (<span style="color: #af00ff;">if</span> arg
                                    (myeval (cadar (evcond-cont-clauses cont))
                                            (evcond-cont-env cont)
                                            (evcond-cont-block-env cont)
                                            (evcond-cont-go-env cont)
                                            (evcond-cont-catch-env cont)
                                            (evcond-cont-errcont cont)
                                            (evcond-cont-cont cont))
                                    (evcond (cdr (evcond-cont-clauses cont))
                                            (evcond-cont-env cont)
                                            (evcond-cont-block-env cont)
                                            (evcond-cont-go-env cont)
                                            (evcond-cont-catch-env cont)
                                            (evcond-cont-errcont cont)
                                            (evcond-cont-cont cont))))
        ((evprogn-cont-p cont)  (evprogn (cdr (evprogn-cont-clauses cont))
                                         (evprogn-cont-env cont)
                                         (evprogn-cont-block-env cont)
                                         (evprogn-cont-go-env cont)
                                         (evprogn-cont-catch-env cont)
                                         (evprogn-cont-errcont cont)
                                         (evprogn-cont-cont cont)))
        ((and-cont-p cont)      (<span style="color: #af00ff;">if</span> (null arg)
                                    (apply-continuation (and-cont-cont cont) nil)
                                    (evand (and-cont-exps cont)
                                           (and-cont-env cont)
                                           (and-cont-block-env cont)
                                           (and-cont-go-env cont)
                                           (and-cont-catch-env cont)
                                           (and-cont-errcont cont)
                                           (and-cont-cont cont))))
        ((or-cont-p cont)       (<span style="color: #af00ff;">if</span> (not (null arg))
                                    (apply-continuation (or-cont-cont cont) arg)
                                    (evor (or-cont-exps cont)
                                          (or-cont-env cont)
                                          (or-cont-block-env cont)
                                          (or-cont-go-env cont)
                                          (or-cont-catch-env cont)
                                          (or-cont-errcont cont)
                                          (or-cont-cont cont))))
        ((evlet-cont-p cont)    (evlet (evlet-cont-vars cont)
                                       (cdr (evlet-cont-exps cont))
                                       (cons arg (evlet-cont-evald-exps cont))
                                       (evlet-cont-exp cont)
                                       (evlet-cont-env cont)
                                       (evlet-cont-block-env cont)
                                       (evlet-cont-go-env cont)
                                       (evlet-cont-catch-env cont)
                                       (evlet-cont-errcont cont)
                                       (evlet-cont-cont cont)))
        ((evletstar-cont-p cont) (evletstar (cdr (evletstar-cont-varpairs cont))
                                            (evletstar-cont-exp cont)
                                            (acons (caar (evletstar-cont-varpairs cont))
                                                   arg
                                                   (evletstar-cont-env cont))
                                            (evletstar-cont-block-env cont)
                                            (evletstar-cont-go-env cont)
                                            (evletstar-cont-catch-env cont)
                                            (evletstar-cont-errcont cont)
                                            (evletstar-cont-cont cont)))
        ((setq-cont-p cont)     (<span style="color: #af00ff;">progn</span>
                                  (<span style="color: #af00ff;">if</span> (null (assoc (cadr (setq-cont-clauses cont))
                                                   (setq-cont-env cont)))
                                      <span style="color: #af0000;">;; </span><span style="color: #af0000;">if-null</span>
                                      (<span style="color: #af00ff;">if</span> (null (assoc (cadr (setq-cont-clauses cont))
                                                       *glob-env*))
                                          <span style="color: #af0000;">;; </span><span style="color: #af0000;">then</span>
                                          (push (cons (cadr (setq-cont-clauses cont))
                                                      arg)
                                                *glob-env*)
                                          <span style="color: #af0000;">;; </span><span style="color: #af0000;">else</span>
                                          (rplacd (assoc (cadr (setq-cont-clauses cont))
                                                         *glob-env*)
                                                  arg))
                                      <span style="color: #af0000;">;; </span><span style="color: #af0000;">if-not-null</span>
                                      (rplacd (assoc (cadr (setq-cont-clauses cont))
                                                     (setq-cont-env cont))
                                              arg))
                                  (apply-continuation (setq-cont-cont cont) arg)))
        ((catch-cont-p cont)    (<span style="color: #af00ff;">if</span> (not (symbolp arg))
                                    (apply-continuation
                                     errcont
                                     (format nil <span style="color: #87005f;">"catch: first argument not a symbol"</span>))
                                    (myeval (caddr (catch-cont-clauses cont))
                                            (catch-cont-env cont)
                                            (catch-cont-block-env cont)
                                            (catch-cont-go-env cont)
                                            (acons arg
                                                   (catch-cont-cont cont)
                                                   (catch-cont-catch-env cont))
                                            (catch-cont-errcont cont)
                                            (catch-cont-cont cont))))
        ((throw-cont-p cont)    (myeval (caddr (throw-cont-clauses cont))
                                        (throw-cont-env cont)
                                        (throw-cont-block-env cont)
                                        (throw-cont-go-env cont)
                                        (throw-cont-catch-env cont)
                                        (throw-cont-errcont cont)
                                        (make-throw2-cont
                                         <span style="color: #5f5f87;">:prev-arg</span> arg
                                         <span style="color: #5f5f87;">:catch-env</span> (throw-cont-catch-env cont)
                                         <span style="color: #5f5f87;">:errcont</span> (throw-cont-errcont cont))))
        ((throw2-cont-p cont)   (assoc-2 (throw2-cont-prev-arg cont)
                                         (throw2-cont-catch-env cont)
                                         (<span style="color: #af00ff;">lambda</span> (cont-res)
                                           (funcall cont-res arg))
                                         (<span style="color: #af00ff;">lambda</span> (key)
                                           (funcall (throw2-cont-errcont cont)
                                                    (format
                                                     nil
                                                     <span style="color: #87005f;">"throw: matching ~A catch is not found"</span>
                                                     key)))))
        ((evtagbody-cont-p cont) (evtagbody (evtagbody-cont-body cont)
                                            (evtagbody-cont-env cont)
                                            (unicont-block-env cont)
                                            (unicont-go-env cont)
                                            (unicont-catch-env cont)
                                            (unicont-errcont cont)
                                            (unicont-cont cont)))
        ((evlis-cont-p cont)    (evlis (evlis-cont-fn cont)
                                       (cdr (evlis-cont-unevaled cont))
                                       (cons arg (evlis-cont-evaled cont))
                                       (evlis-cont-env cont)
                                       (unicont-block-env cont)
                                       (unicont-go-env cont)
                                       (unicont-catch-env cont)
                                       (unicont-errcont cont)
                                       (unicont-cont cont)))
        (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'unknown-continuation <span style="color: #5f5f87;">:cont</span> cont))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">CPS-&#1074;&#1077;&#1088;&#1089;&#1080;&#1103; ASSOC</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">assoc-2</span> (key alist success failure) <span style="color: #af0000;">;; </span><span style="color: #af0000;">NB!: inverted order of</span>
                                           <span style="color: #af0000;">;; </span><span style="color: #af0000;">successinuations (for lookup)</span>
  (<span style="color: #af00ff;">cond</span> ((null alist)              (funcall failure key))
        ((equal key (caar alist))  (funcall success (cdar alist)))
        (t                         (assoc-2 key (cdr alist) success failure))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1053;&#1086;&#1074;&#1072;&#1103; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; lookup</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">environment</span>
(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">*glob-env*</span> nil)
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">lookup</span> (symb env errcont cont)
  (assoc-2 symb env
           (<span style="color: #af00ff;">lambda</span> (x)
             (apply-continuation cont x))
           (<span style="color: #af00ff;">lambda</span> (key)
             (assoc-2 key *glob-env*
                      (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1074;&#1086;&#1079;&#1084;&#1086;&#1078;&#1085;&#1086; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072; (&#1073;&#1099;&#1083;&#1072;) &#1090;&#1091;&#1090;</span>
                        (apply-continuation cont x))
                      (<span style="color: #af00ff;">lambda</span> (key)
                        (apply-continuation
                         errcont
                         (format
                          nil <span style="color: #87005f;">"UNBOUD VARIABLE [~A] ~%LOCAL ENV: [~A] ~%GLOBAL ENV: [~A]"</span>
                          key env *glob-env*)))))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1057;&#1090;&#1088;&#1091;&#1082;&#1090;&#1091;&#1088;&#1072; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1103;</span>
(<span style="color: #af00ff;">defstruct</span> <span style="color: #008700;">closure</span>
  body
  env
  block-env
  go-env
  args)
<span style="color: #af0000;">;; </span><span style="color: #af0000;">CPS-&#1074;&#1072;&#1088;&#1080;&#1072;&#1085;&#1090; MYAPPLY &#1080; &#1074;&#1089;&#1077; &#1095;&#1090;&#1086; &#1082; &#1085;&#1077;&#1084;&#1091; &#1086;&#1090;&#1085;&#1086;&#1089;&#1080;&#1090;&#1089;&#1103;</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evadd</span> (lst acc)
  (<span style="color: #af00ff;">cond</span> ((null lst)        0)
        ((null (cdr lst))  (+ acc (car lst)))
        (t                 (evadd (cdr lst)
                                  (+ acc (car lst))))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evmul</span> (lst acc)
  (<span style="color: #af00ff;">cond</span> ((null lst)        1)
        ((null (cdr lst))  (* acc (car lst)))
        (t                 (evmul (cdr lst)
                                  (* acc (car lst))))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evlis</span> (fn unevaled evaled env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null unevaled)  (myapply fn (reverse evaled) catch-env errcont cont))
        (t                (myeval (car unevaled) env block-env go-env catch-env errcont
                                  (make-evlis-cont
                                   <span style="color: #5f5f87;">:fn</span> fn
                                   <span style="color: #5f5f87;">:unevaled</span> unevaled
                                   <span style="color: #5f5f87;">:evaled</span> evaled
                                   <span style="color: #5f5f87;">:env</span> env
                                   <span style="color: #5f5f87;">:block-env</span> block-env
                                   <span style="color: #5f5f87;">:go-env</span> go-env
                                   <span style="color: #5f5f87;">:catch-env</span> catch-env
                                   <span style="color: #5f5f87;">:errcont</span> errcont
                                   <span style="color: #5f5f87;">:cont</span> cont)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">myapply</span> (fn args catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span>
    ((equal fn 'car)             (apply-continuation cont (caar args)))
    ((equal fn 'cdr)             (apply-continuation cont (cdar args)))
    ((equal fn 'cons)            (apply-continuation cont (cons (car args) (cadr args))))
    ((equal fn 'null)            (<span style="color: #af00ff;">if</span> (null (cdr args))
                                     (apply-continuation cont (null (car args)))
                                     (<span style="color: #ff0000; font-weight: bold;">error</span> 'invalid-number-of-arguments <span style="color: #5f5f87;">:fn</span> fn)))
    ((equal fn '+)               (apply-continuation cont (evadd args 0)))
    ((equal fn '*)               (apply-continuation cont (evmul args 1)))
    ((closure-p fn)              (evprogn (closure-body fn)
                                          (pairlis (closure-args fn)
                                                   args
                                                   (closure-env fn))
                                          (closure-block-env fn)
                                          (closure-go-env fn)
                                          catch-env
                                          errcont cont))
    ((equal fn 'print)           (apply-continuation cont (print (car args))))
    ((equal fn 'list)            (apply-continuation cont args))
    ((equal fn 'call/cc)         (myapply (car args) (list cont) catch-env errcont cont))
    ((functionp fn)              (apply fn args))      <span style="color: #af0000;">; interim hack</span>
    ((unicont-p fn)              (apply-continuation fn (car args)))
    <span style="color: #af0000;">;;  </span><span style="color: #af0000;">((identity-cont-p fn)        (apply-continuation fn (car args))) ;; for identity</span>
    (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'unknown-function <span style="color: #5f5f87;">:fn</span> fn))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">CPS-&#1074;&#1072;&#1088;&#1080;&#1072;&#1085;&#1090; MYEVAL &#1080; &#1074;&#1089;&#1077; &#1095;&#1090;&#1086; &#1082; &#1085;&#1077;&#1084;&#1091; &#1086;&#1090;&#1085;&#1086;&#1089;&#1080;&#1090;&#1089;&#1103;</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evcond</span> (clauses env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null clauses)  (apply-continuation cont nil))
        (t               (myeval (caar clauses) env block-env go-env catch-env errcont
                                 (make-evcond-cont
                                  <span style="color: #5f5f87;">:clauses</span> clauses
                                  <span style="color: #5f5f87;">:env</span> env
                                  <span style="color: #5f5f87;">:block-env</span> block-env
                                  <span style="color: #5f5f87;">:go-env</span> go-env
                                  <span style="color: #5f5f87;">:catch-env</span> catch-env
                                  <span style="color: #5f5f87;">:errcont</span> errcont
                                  <span style="color: #5f5f87;">:cont</span> cont)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evprogn</span> (lst env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null lst)         (apply-continuation cont nil))
        ((null (cdr lst))   (myeval (car lst) env block-env go-env catch-env errcont cont))
        (t                  (myeval (car lst) env block-env go-env catch-env errcont
                                    (make-evprogn-cont
                                     <span style="color: #5f5f87;">:clauses</span> lst
                                     <span style="color: #5f5f87;">:env</span> env
                                     <span style="color: #5f5f87;">:block-env</span> block-env
                                     <span style="color: #5f5f87;">:go-env</span> go-env
                                     <span style="color: #5f5f87;">:catch-env</span> catch-env
                                     <span style="color: #5f5f87;">:errcont</span> errcont
                                     <span style="color: #5f5f87;">:cont</span> cont)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evand</span> (exps env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null exps)       (apply-continuation cont T))
        ((null (cdr exps)) (myeval (car exps) env block-env go-env catch-env errcont cont))
        (t                 (myeval (car exps) env block-env go-env catch-env errcont
                                   (make-and-cont
                                    <span style="color: #5f5f87;">:exps</span> (cdr exps)
                                    <span style="color: #5f5f87;">:env</span> env
                                    <span style="color: #5f5f87;">:block-env</span> block-env
                                    <span style="color: #5f5f87;">:go-env</span> go-env
                                    <span style="color: #5f5f87;">:catch-env</span> catch-env
                                    <span style="color: #5f5f87;">:errcont</span> errcont
                                    <span style="color: #5f5f87;">:cont</span> cont)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evor</span> (exps env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null exps)       (apply-continuation cont nil))
        ((null (cdr exps)) (myeval (car exps) env block-env go-env catch-env errcont cont))
        (t                 (myeval (car exps) env block-env go-env catch-env errcont
                                   (make-or-cont
                                    <span style="color: #5f5f87;">:exps</span> (cdr exps)
                                    <span style="color: #5f5f87;">:env</span> env
                                    <span style="color: #5f5f87;">:block-env</span> block-env
                                    <span style="color: #5f5f87;">:go-env</span> go-env
                                    <span style="color: #5f5f87;">:catch-env</span> catch-env
                                    <span style="color: #5f5f87;">:errcont</span> errcont
                                    <span style="color: #5f5f87;">:cont</span> cont)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">mypairlis</span> (lst1 lst2 alist)
  (<span style="color: #af00ff;">cond</span> ((and (null lst1) (null lst2))  alist)
        ((or  (null lst1) (null lst2))  (<span style="color: #ff0000; font-weight: bold;">error</span> 'mypairlis-error <span style="color: #5f5f87;">:lst1</span> lst1 <span style="color: #5f5f87;">:lst2</span> lst2))
        (t                              (cons (cons (car lst1)
                                                    (car lst2))
                                              (mypairlis (cdr lst1)
                                                         (cdr lst2)
                                                         alist)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evlet</span> (vars exps evald-exps exp env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null exps)  (evprogn exp
                               (pairlis vars (reverse evald-exps) env)
                               block-env go-env catch-env
                               errcont cont))
        (t            (myeval (car exps) env block-env go-env catch-env errcont
                              (make-evlet-cont
                               <span style="color: #5f5f87;">:vars</span> vars
                               <span style="color: #5f5f87;">:exps</span> exps
                               <span style="color: #5f5f87;">:evald-exps</span> evald-exps
                               <span style="color: #5f5f87;">:exp</span> exp
                               <span style="color: #5f5f87;">:env</span> env
                               <span style="color: #5f5f87;">:block-env</span> block-env
                               <span style="color: #5f5f87;">:go-env</span> go-env
                               <span style="color: #5f5f87;">:catch-env</span> catch-env
                               <span style="color: #5f5f87;">:errcont</span> errcont
                               <span style="color: #5f5f87;">:cont</span> cont)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evletstar</span> (varpairs exp env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null varpairs)  (evprogn exp env block-env go-env catch-env errcont cont))
        (t                (myeval (cadar varpairs) env block-env go-env catch-env errcont
                                  (make-evletstar-cont
                                   <span style="color: #5f5f87;">:varpairs</span> varpairs
                                   <span style="color: #5f5f87;">:exp</span> exp
                                   <span style="color: #5f5f87;">:env</span> env
                                   <span style="color: #5f5f87;">:block-env</span> block-env
                                   <span style="color: #5f5f87;">:go-env</span> go-env
                                   <span style="color: #5f5f87;">:catch-env</span> catch-env
                                   <span style="color: #5f5f87;">:errcont</span> errcont
                                   <span style="color: #5f5f87;">:cont</span> cont)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evthrow</span> (exp env block-env go-env catch-env errcont cont)
  (myeval (cadr exp) env block-env go-env catch-env errcont
          (make-throw-cont
           <span style="color: #5f5f87;">:clauses</span> exp
           <span style="color: #5f5f87;">:env</span> env
           <span style="color: #5f5f87;">:block-env</span> block-env
           <span style="color: #5f5f87;">:go-env</span> go-env
           <span style="color: #5f5f87;">:catch-env</span> catch-env
           <span style="color: #5f5f87;">:errcont</span> errcont
           <span style="color: #5f5f87;">:cont</span> cont)))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">tagbody-check-tag</span> (exp cont errcont)
  (<span style="color: #af00ff;">cond</span> ((null exp) (funcall cont))
        ((and (symbolp (car exp))
              (member (car exp) (cdr exp)))
         (funcall errcont (car exp)))
        (t (tagbody-check-tag (cdr exp) cont errcont))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evtagbody</span> (body env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span> ((null (car body))      (apply-continuation cont nil))
        ((symbolp (car body))   (evtagbody (cdr body) env block-env go-env catch-env errcont cont))
        (t                      (myeval (car body) env block-env go-env catch-env errcont
                                        (make-evtagbody-cont
                                         <span style="color: #5f5f87;">:body</span> (cdr body)
                                         <span style="color: #5f5f87;">:env</span>  env
                                         <span style="color: #5f5f87;">:block-env</span> block-env
                                         <span style="color: #5f5f87;">:go-env</span> go-env
                                         <span style="color: #5f5f87;">:catch-env</span> catch-env
                                         <span style="color: #5f5f87;">:errcont</span> errcont
                                         <span style="color: #5f5f87;">:cont</span> cont)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">tagbody-slice</span> (exp res)
  (<span style="color: #af00ff;">cond</span> ((null exp) res)
        ((symbolp (car exp))  (tagbody-slice (cdr exp) (cons exp res)))
        (t                    (tagbody-slice (cdr exp) res))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">is-cont-subset</span> (target-cont cont)
  (<span style="color: #af00ff;">cond</span> ((equal target-cont cont) t)    <span style="color: #af0000;">;; </span><span style="color: #af0000;">positive</span>
        ((functionp cont) nil)          <span style="color: #af0000;">;; </span><span style="color: #af0000;">negative</span>
        (t (is-cont-subset target-cont (cdr cont)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">make-go-env</span> (tagbody-body env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">let*</span> ((conts (mapcar #'(<span style="color: #af00ff;">lambda</span> (x) <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1077;&#1085;&#1080;&#1103;, &#1085;&#1072;&#1088;&#1077;&#1079;&#1072;&#1085;&#1085;&#1099;&#1077; &#1080;&#1079; tagbody</span>
                            (make-go-cont
                             <span style="color: #5f5f87;">:slice</span> x
                             <span style="color: #5f5f87;">:env</span> env
                             <span style="color: #5f5f87;">:block-env</span> block-env
                             <span style="color: #5f5f87;">:go-env</span> go-env <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1101;&#1090;&#1086;&#1090; &#1089;&#1083;&#1086;&#1090; &#1073;&#1091;&#1076;&#1077;&#1084; setf-&#1101;&#1092;&#1080;&#1090;&#1100;</span>
                             <span style="color: #5f5f87;">:catch-env</span>  catch-env
                             <span style="color: #5f5f87;">:errcont</span> errcont
                             <span style="color: #5f5f87;">:cont</span> cont))
                        (tagbody-slice tagbody-body nil)))
         <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1072;&#1088;&#1099; (&#1089;&#1080;&#1084;&#1074;&#1086;&#1083; . &#1087;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1077;&#1085;&#1080;&#1077;) &#1085;&#1072;&#1088;&#1077;&#1079;&#1072;&#1085;&#1085;&#1099;&#1077; &#1080;&#1079;</span>
         <span style="color: #af0000;">;; </span><span style="color: #af0000;">tagbody &#1080; &#1076;&#1086;&#1073;&#1072;&#1074;&#1083;&#1077;&#1085;&#1085;&#1099;&#1077; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
         (new-go-env (append (mapcar #'(<span style="color: #af00ff;">lambda</span> (go-cont)
                                         (cons (car (go-cont-slice go-cont))
                                               go-cont))
                                     conts)
                             go-env)))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1080;&#1079;&#1084;&#1077;&#1085;&#1103;&#1077;&#1084; &#1087;&#1086;&#1083;&#1103; go-env, &#1079;&#1072;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1103; &#1074; &#1085;&#1080;&#1093; new-go-env</span>
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1074;&#1086; &#1074;&#1089;&#1077;&#1093; &#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1087;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1077;&#1085;&#1080;&#1103;&#1093;</span>
    (<span style="color: #af00ff;">loop</span> <span style="color: #5f5f87;">:for</span> elt-cont <span style="color: #5f5f87;">:in</span> conts <span style="color: #5f5f87;">:do</span>
       (setf (go-cont-go-env elt-cont)
             new-go-env))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084; &#1085;&#1086;&#1074;&#1086;&#1077; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
    new-go-env))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">apply-go-continuation</span> (go-cont)
  (evtagbody (go-cont-slice go-cont)
             (go-cont-env go-cont)
             (go-cont-block-env go-cont)
             (go-cont-go-env go-cont)
             (go-cont-catch-env go-cont)
             (go-cont-errcont go-cont)
             (go-cont-cont go-cont)))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">myeval</span> (exp env block-env go-env catch-env errcont cont)
  (<span style="color: #af00ff;">cond</span>
    ((null exp)                  (apply-continuation cont 'nil))
    ((equal 't exp)              (apply-continuation cont 't))
    ((member exp '(+ * car cdr cons null print list call/cc repl))  (apply-continuation cont exp))
    ((numberp exp)               (apply-continuation cont exp))
    ((symbolp exp)               (lookup exp env errcont cont))
    ((equal (car exp) 'quote)    (apply-continuation cont (cadr exp)))
    ((equal (car exp) 'if)       (myeval (cadr exp) env block-env go-env catch-env errcont
                                         (make-if-cont
                                          <span style="color: #5f5f87;">:clauses</span> exp
                                          <span style="color: #5f5f87;">:env</span> env
                                          <span style="color: #5f5f87;">:block-env</span> block-env
                                          <span style="color: #5f5f87;">:go-env</span> go-env
                                          <span style="color: #5f5f87;">:catch-env</span> catch-env
                                          <span style="color: #5f5f87;">:errcont</span> errcont
                                          <span style="color: #5f5f87;">:cont</span> cont)))
    ((equal (car exp) 'cond)     (evcond (cdr exp)
                                         env block-env go-env catch-env
                                         errcont cont))
    ((equal (car exp) 'progn)    (evprogn (cdr exp)
                                          env block-env go-env catch-env
                                          errcont cont))
    ((equal (car exp) 'and)      (evand (cdr exp)
                                        env block-env go-env catch-env
                                        errcont cont))
    ((equal (car exp) 'or)       (evor  (cdr exp)
                                        env block-env go-env catch-env
                                        errcont cont))
    ((equal (car exp) 'let)      (evlet (mapcar #'car (cadr exp))
                                        (mapcar #'cadr (cadr exp))
                                        nil
                                        (cddr exp)
                                        env block-env go-env catch-env
                                        errcont cont))
    ((equal (car exp) 'let*)     (evletstar (cadr exp)
                                            (cddr exp)
                                            env block-env go-env catch-env
                                            errcont cont))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1089;&#1090;&#1072;&#1083;&#1086;</span>
    ((equal (car exp) 'defun)         (<span style="color: #af00ff;">progn</span>
                                        (push (cons (cadr exp)
                                                    (make-closure <span style="color: #5f5f87;">:body</span> (cdddr exp)
                                                                  <span style="color: #5f5f87;">:block-env</span> block-env
                                                                  <span style="color: #5f5f87;">:env</span> env
                                                                  <span style="color: #5f5f87;">:go-env</span> go-env
                                                                  <span style="color: #5f5f87;">:args</span> (caddr exp)))
                                              *glob-env*)
                                        (apply-continuation cont (cadr exp))))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1073;&#1099;&#1083;&#1086;</span>
    ((equal (car exp) 'defun)         (<span style="color: #af00ff;">progn</span>
                                        (push (cons (cadr exp)
                                                    (make-closure <span style="color: #5f5f87;">:body</span> (cdddr exp)
                                                                  <span style="color: #5f5f87;">:env</span> env
                                                                  <span style="color: #5f5f87;">:block-env</span> block-env
                                                                  <span style="color: #5f5f87;">:go-env</span> go-env
                                                                  <span style="color: #5f5f87;">:args</span> (caddr exp)))
                                              *glob-env*)
                                        (funcall cont (cadr exp))))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1089;&#1090;&#1072;&#1083;&#1086;</span>
    ((equal (car exp) 'setq)     (myeval (caddr exp) env block-env go-env catch-env errcont
                                         (make-setq-cont
                                          <span style="color: #5f5f87;">:clauses</span> exp
                                          <span style="color: #5f5f87;">:env</span> env
                                          <span style="color: #5f5f87;">:block-env</span> block-env
                                          <span style="color: #5f5f87;">:go-env</span> go-env
                                          <span style="color: #5f5f87;">:catch-env</span> catch-env
                                          <span style="color: #5f5f87;">:errcont</span> errcont
                                          <span style="color: #5f5f87;">:cont</span> cont)))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1073;&#1099;&#1083;&#1086;</span>
    ((equal (car exp) 'setq)     (myeval (caddr exp) env block-env go-env catch-env errcont
                                         (<span style="color: #af00ff;">lambda</span> (val)
                                           (<span style="color: #af00ff;">if</span> (null (assoc (cadr exp) env))
                                               (<span style="color: #af00ff;">if</span> (null (assoc (cadr exp) *glob-env*))
                                                   (push (cons (cadr exp) val)
                                                         *glob-env*)
                                                   (rplacd (assoc (cadr exp) *glob-env*) val))
                                               (rplacd (assoc (cadr exp) env) val))
                                           (funcall cont val))))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1089;&#1090;&#1072;&#1083;&#1086;</span>
    ((equal (car exp) 'lambda)   (apply-continuation cont (make-closure <span style="color: #5f5f87;">:body</span> (cddr exp)
                                                                        <span style="color: #5f5f87;">:block-env</span> block-env
                                                                        <span style="color: #5f5f87;">:env</span> env
                                                                        <span style="color: #5f5f87;">:go-env</span> go-env
                                                                        <span style="color: #5f5f87;">:args</span> (cadr exp))))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1073;&#1099;&#1083;&#1086;</span>
    ((equal (car exp) 'lambda)   (funcall cont (make-closure <span style="color: #5f5f87;">:body</span> (cddr exp)
                                                             <span style="color: #5f5f87;">:env</span> env
                                                             <span style="color: #5f5f87;">:block-env</span> block-env
                                                             <span style="color: #5f5f87;">:go-env</span> go-env
                                                             <span style="color: #5f5f87;">:args</span> (cadr exp))))
    ((equal (car exp) 'block)    (myeval (caddr exp)
                                         env
                                         (acons (cadr exp)
                                                cont
                                                block-env)
                                         go-env catch-env errcont cont))
    ((equal (car exp) 'return-from)
                                 (<span style="color: #af00ff;">if</span> (not (symbolp (cadr exp)))
                                     (apply-continuation
                                      errcont (format nil <span style="color: #87005f;">"return-from: first argument not a symbol"</span>))
                                     (myeval (caddr exp) env block-env go-env catch-env errcont
                                             (<span style="color: #af00ff;">lambda</span> (x)
                                               (assoc-2 (cadr exp) block-env
                                                        (<span style="color: #af00ff;">lambda</span> (y)
                                                          (<span style="color: #af00ff;">if</span> (is-cont-subset y cont)
                                                              (apply-continuation y x)
                                                              (apply-continuation
                                                               errcont
                                                               (format nil <span style="color: #87005f;">"return-from: attempt to RETURN-FROM to ~A that no longer exists"</span> (cadr exp)))))
                                                        (<span style="color: #af00ff;">lambda</span> (y)
                                                          (apply-continuation
                                                           errcont (format nil <span style="color: #87005f;">"return-from: undefined return block ~A"</span> y))))))))
    ((equal (car exp) 'catch)    (myeval (cadr exp) env block-env go-env catch-env errcont
                                         (make-catch-cont
                                          <span style="color: #5f5f87;">:clauses</span> exp
                                          <span style="color: #5f5f87;">:env</span> env
                                          <span style="color: #5f5f87;">:block-env</span> block-env
                                          <span style="color: #5f5f87;">:go-env</span> go-env
                                          <span style="color: #5f5f87;">:catch-env</span> catch-env
                                          <span style="color: #5f5f87;">:errcont</span> errcont
                                          <span style="color: #5f5f87;">:cont</span> cont)))
    ((equal (car exp) 'throw)    (evthrow exp
                                          env block-env go-env catch-env
                                          errcont cont))
    ((equal (car exp) 'return-from)
                                 (<span style="color: #af00ff;">if</span> (not (symbolp (cadr exp)))
                                     (apply-continuation
                                      errcont (format nil <span style="color: #87005f;">"return-from: first argument not a symbol"</span>))
                                     (myeval (caddr exp) env block-env go-env catch-env errcont
                                             (<span style="color: #af00ff;">lambda</span> (x)
                                               (assoc-2 (cadr exp) block-env
                                                        (<span style="color: #af00ff;">lambda</span> (y)
                                                          (<span style="color: #af00ff;">if</span> (is-cont-subset y cont)
                                                              (apply-continuation y x)
                                                              (apply-continuation
                                                               errcont
                                                               (format nil <span style="color: #87005f;">"return-from: attempt to RETURN-FROM to ~A that no longer exists"</span> (cadr exp)))))
                                                        (<span style="color: #af00ff;">lambda</span> (y)
                                                          (apply-continuation
                                                           errcont (format nil <span style="color: #87005f;">"return-from: undefined return block ~A"</span> y))))))))
    ((equal (car exp) 'catch)    (myeval (cadr exp) env block-env go-env catch-env errcont
                                         (make-catch-cont
                                          <span style="color: #5f5f87;">:clauses</span> exp
                                          <span style="color: #5f5f87;">:env</span> env
                                          <span style="color: #5f5f87;">:block-env</span> block-env
                                          <span style="color: #5f5f87;">:go-env</span> go-env
                                          <span style="color: #5f5f87;">:catch-env</span> catch-env
                                          <span style="color: #5f5f87;">:errcont</span> errcont
                                          <span style="color: #5f5f87;">:cont</span> cont)))
    ((equal (car exp) 'throw)    (evthrow exp
                                          env block-env go-env catch-env
                                          errcont cont))
    ((equal (car exp) 'tagbody)  (tagbody-check-tag
                                  (cdr exp)
                                  (<span style="color: #af00ff;">lambda</span> ()
                                    (evtagbody (cdr exp) env block-env
                                               (make-go-env (cdr exp)
                                                            env block-env go-env catch-env
                                                            errcont cont)
                                               catch-env errcont cont))
                                  (<span style="color: #af00ff;">lambda</span> (x)
                                    (apply-continuation
                                     errcont
                                     (format
                                      nil
                                      <span style="color: #87005f;">"tagbody: The tag ~A appears more than once in a tagbody"</span>
                                      x)))))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1089;&#1090;&#1072;&#1083;&#1086;</span>
    ((equal (car exp) 'go)       (assoc-2 (cadr exp) go-env
                                          (<span style="color: #af00ff;">lambda</span> (go-cont)
                                            (apply-go-continuation go-cont))
                                          (<span style="color: #af00ff;">lambda</span> (go-label)
                                            (apply-continuation
                                             errcont
                                             (format nil <span style="color: #87005f;">"go: wrong target ~A"</span> go-label)))))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1088;&#1086;&#1084;&#1077;&#1078;&#1091;&#1090;&#1086;&#1095;&#1085;&#1099;&#1081; &#1074;&#1072;&#1088;&#1080;&#1072;&#1085;&#1090;</span>
    ((equal (car exp) 'go)       (assoc-2 (cadr exp) go-env
                                          (<span style="color: #af00ff;">lambda</span> (x)
                                            (apply-continuation x 'NOT-A-PARAM))
                                          (<span style="color: #af00ff;">lambda</span> (x)
                                            (apply-continuation
                                             errcont
                                             (format nil <span style="color: #87005f;">"go: wrong target ~A"</span> x)))))
    <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1073;&#1099;&#1083;&#1086;</span>
    ((equal (car exp) 'go)       (assoc-2 (cadr exp) go-env
                                          (<span style="color: #af00ff;">lambda</span> (x)
                                            (funcall x))
                                          (<span style="color: #af00ff;">lambda</span> (x)
                                            (funcall
                                             errcont
                                             (format nil <span style="color: #87005f;">"go: wrong target ~A"</span> x)))))
    ((equal (car exp) 'labels)   (<span style="color: #af00ff;">let*</span> ((alist (mapcar (<span style="color: #af00ff;">lambda</span> (label) <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1092;&#1086;&#1088;&#1084;&#1080;&#1088;&#1091;&#1077;&#1084; &#1089;&#1087;&#1080;&#1089;&#1086;&#1082; &#1087;&#1072;&#1088; (&#1080;&#1084;&#1103; . nil)</span>
                                                         (cons (car label) nil))
                                                       (cadr exp)))
                                        (new-env (append alist env))   <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1076;&#1086;&#1073;&#1072;&#1074;&#1080;&#1084; &#1082; &#1089;&#1087;&#1080;&#1089;&#1082;&#1091; &#1087;&#1072;&#1088; &#1087;&#1088;&#1077;&#1076;&#1099;&#1076;&#1091;&#1097;&#1077;&#1077; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
                                        (closures (mapcar (<span style="color: #af00ff;">lambda</span> (label)
                                                            <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1089;&#1086;&#1079;&#1076;&#1072;&#1077;&#1084; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1077;, &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1102;&#1097;&#1077;&#1077; (env) &#1085;&#1072; &#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1085;&#1099;&#1077; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1099;&#1077; (&#1089;&#1086;&#1076;&#1077;&#1088;&#1078;&#1072;&#1097;&#1080;&#1077; &#1087;&#1086;&#1082;&#1072; nil)</span>
                                                            (make-closure <span style="color: #5f5f87;">:body</span> (cddr label) <span style="color: #af0000;">;; </span><span style="color: #af0000;">implicit progn</span>
                                                                          <span style="color: #5f5f87;">:block-env</span> block-env
                                                                          <span style="color: #5f5f87;">:env</span> new-env
                                                                          <span style="color: #5f5f87;">:go-env</span> go-env
                                                                          <span style="color: #5f5f87;">:args</span> (cadr label)))
                                                          (cadr exp))))
                                   <span style="color: #af0000;">;; </span><span style="color: #af0000;">alist:    '((zzz . nil) (xxx . nil))</span>
                                   <span style="color: #af0000;">;; </span><span style="color: #af0000;">new-env:  '((zzz . nil) (xxx . nil) (old . #:closure))</span>
                                   <span style="color: #af0000;">;; </span><span style="color: #af0000;">closures: '(#:closure #:closure) ;; &#1091; &#1101;&#1090;&#1080;&#1093; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1081; :env &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; new-env</span>
                                   (<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (length alist) (length closures)))
                                   (<span style="color: #af00ff;">loop</span>
                                      <span style="color: #5f5f87;">:for</span> aelt     <span style="color: #5f5f87;">:in</span> alist
                                      <span style="color: #5f5f87;">:for</span> closure  <span style="color: #5f5f87;">:in</span> closures
                                      <span style="color: #5f5f87;">:do</span> (rplacd aelt closure))
                                   <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084;:</span>
                                   <span style="color: #af0000;">;; </span><span style="color: #af0000;">alist:    '((zzz . #:closure) (xxx . #:closure))</span>
                                   <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1048; &#1087;&#1077;&#1088;&#1077;&#1076;&#1072;&#1077;&#1084; new-env &#1074; &#1082;&#1072;&#1095;&#1077;&#1089;&#1090;&#1074;&#1077; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
                                   (evprogn (cddr exp) new-env block-env go-env catch-env errcont cont)))
    ((equal (car exp) 'reset)    (apply-continuation cont (myeval (cadr exp)
                                                                  env block-env go-env catch-env
                                                                  errcont #'identity)))
    ((equal (car exp) 'shift)    (myeval (caddr exp)
                                         (acons (cadr exp) cont env)
                                         block-env go-env catch-env
                                         errcont cont))
    (t
     (myeval (car exp) env block-env go-env catch-env errcont
             (<span style="color: #af00ff;">lambda</span> (x)
               (evlis x (cdr exp) nil env block-env go-env catch-env errcont cont))))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1080;&#1088;&#1091;&#1077;&#1084; &#1085;&#1086;&#1074;&#1099;&#1081; lookup</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">test lookup</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"ok:123"</span> (lookup 'aaa '((aaa . 123))
                                (<span style="color: #af00ff;">lambda</span> (x) (format nil <span style="color: #87005f;">"err:~A"</span> x))
                                (<span style="color: #af00ff;">lambda</span> (x) (format nil <span style="color: #87005f;">"ok:~A"</span> x)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil      (lookup 'aaa '((bbb . 123))
                                (<span style="color: #af00ff;">lambda</span> (x) (<span style="color: #af00ff;">declare</span> (ignore x)) nil)
                                (<span style="color: #af00ff;">lambda</span> (x) (format nil <span style="color: #87005f;">"ok:~A"</span> x)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1060;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080; &#1076;&#1083;&#1103; &#1090;&#1077;&#1089;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; CPS-&#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1081;</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">ok</span> (x)
  (format t <span style="color: #87005f;">"~%ok: ~A"</span> x)
  x)
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">err</span> (x)
  (format t <span style="color: #87005f;">"~%err: ~A"</span> x)
  x)
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; MYAPPLY</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; cons, car, cdr</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(cons 1 2) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 2) 3 . 4) (myeval '(cons (cons 1 2) (cons 3 4)) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(car (cons 2 3)) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(cdr (cons 2 3)) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(car (cons (cons 1 2) (cons 3 4))) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 . 4) (myeval '(cdr (cons (cons 1 2) (cons 3 4))) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; cons-&#1103;&#1095;&#1077;&#1077;&#1082;, &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1093; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(car a) '((a . (1 . 2))) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(cdr a) '((a . (1 . 2))) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(car b) '((a . (1 . 2)) (b . (3 . 4))) nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; NULL</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval '(null ()) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval '(null nil) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval '(null T) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval '(null a) '((a . ())) nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; NULL, &#1089; &#1072;&#1088;&#1075;&#1091;&#1084;&#1077;&#1085;&#1090;&#1086;&#1084;, &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1077; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval '(null a) '((a . T)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval '(null a) '((a . 1)) nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVADD</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0                (evadd '() 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2                (evadd '(2) 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 5                (evadd '(2 3) 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3 4)        (evadd '(2 3 4) 0)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVMUL</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1                (evmul '() 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2                (evmul '(2) 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 6                (evmul '(2 3) 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3 4)        (evmul '(2 3 4) 1)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0                (myeval '(+) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2)            (myeval '(+ 2) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3)          (myeval '(+ 2 3) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3 4)        (myeval '(+ 2 3 4) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 (+ 3 4))    (myeval '(+ 2 (+ 3 4)) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 (+ 3 4) 5)  (myeval '(+ 2 (+ 3 4) 5) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1091;&#1084;&#1085;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1                (myeval '(*) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2)            (myeval '(* 2) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3)          (myeval '(* 2 3) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3 4)        (myeval '(* 2 3 4) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 (* 3 4))    (myeval '(* 2 (* 3 4)) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 (* 3 4) 5)  (myeval '(* 2 (* 3 4) 5) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0
               (myeval '(+) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2))
                 (+ a))
               (myeval '(+ a)
                       '((a . 2))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3))
                 (+ a b))
               (myeval '(+ a b)
                       '((a . 2) (b . 3))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (+ a b c))
               (myeval '(+ a b c)
                       '((a . 2) (b . 3) (c . 4))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (+ a (+ b c)))
               (myeval '(+ a (+ b c))
                       '((a . 2) (b . 3) (c . 4))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4) (d 5))
                 (+ a (+ b c) d))
               (myeval '(+ a (+ b c) d)
                       '((a . 2) (b . 3) (c . 4) (d . 5))
                       nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1091;&#1084;&#1085;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;  &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1
               (myeval '(*) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2))
                 (* a))
               (myeval '(* a)
                       '((a . 2))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3))
                 (* a b))
               (myeval '(* a b)
                       '((a . 2) (b . 3))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (* a b c))
               (myeval '(* a b c)
                       '((a . 2) (b . 3) (c . 4))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (* a (* b c)))
               (myeval '(* a (* b c))
                       '((a . 2) (b . 3) (c . 4))
                       nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4) (d 5))
                 (* a (* b c) d))
               (myeval '(* a (* b c) d)
                       '((a . 2) (b . 3) (c . 4) (d . 5))
                       nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1087;&#1088;&#1080;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1103; CLOSURE</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(((<span style="color: #af00ff;">lambda</span> (x)
                              (<span style="color: #af00ff;">lambda</span> (y) x))
                            1)
                           2)
                         nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; PRINT &#1074; &#1089;&#1088;&#1072;&#1074;&#1085;&#1077;&#1085;&#1080;&#1080; &#1089; host-&#1086;&#1074;&#1099;&#1084; print</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (print 12))
               (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (myeval '(print 12) nil nil nil nil #'err #'identity))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (print 12)
               (myeval '(print 12) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; PRINT &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (<span style="color: #af00ff;">let</span> ((a 12))
                   (print a)))
               (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (myeval '(print a)
                         '((b . 23) (a . 12))
                         nil nil nil #'err #'identity))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 12))
                 (print a))
               (myeval '(print a)
                       '((b . 23) (a . 12))
                       nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; EVLIS</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 4           (evlis '+     '(1 (+ 1 2))   nil nil nil nil nil  #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 1 3 5)   (evlis '+     '(1 (+ 1 2) 5) nil nil nil nil nil  #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 3 5)    (evlis 'list  '(1 (+ 1 2) 5) nil nil nil nil nil  #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(0 3 6 42) (evlis 'list  '(0 (+ a b) (* b c) 42)
                                  nil
                                  '((a . 1) (b . 2) (c . 3) (d . 4))
                                  nil nil nil  #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LIST</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 14) (myeval '(list 1 (+ 2 (* 3 4)))
                               nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (myeval '(list (+ 1 2) (* 2 3) 42) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (myeval '(list (+ a b) (* b c) 42)
                       '((a . 1) (b . 2) (c . 3) (d . 4))
                       nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; CALL/CC</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 14 (myeval '(+ 1 2 (call/cc (<span style="color: #af00ff;">lambda</span> (x) (+ 3 4) (x (+ 5 6)) (+7 8))))
                          nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; MYEVAL</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1072;&#1084;&#1086;&#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1093; &#1092;&#1086;&#1088;&#1084;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval 'T nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval 'NIL nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 999 (myeval 999 nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1077;&#1085;&#1080;&#1103; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 6 (myeval 'b '((a . 3) (b . 6)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span> (car (myeval 'b nil nil nil nil
                                    #'(<span style="color: #af00ff;">lambda</span> (x) (cons <span style="color: #87005f;">"error"</span> x))
                                    #'ok))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; QUOTE</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(+ 1 2) (myeval '(quote (+ 1 2)) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; IF</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">if</span> () 1 2) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">if</span> (null ()) 1 2) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; IF, &#1075;&#1076;&#1077; &#1091;&#1089;&#1083;&#1086;&#1074;&#1080;&#1077; &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1090;&#1089;&#1103; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">if</span> a 1 2) '((a . ())) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">if</span> a 1 2) '((a . 1)) nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVCOND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2   (evcond '((t 2)   (t 1)) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1   (evcond '((nil 2) (t 1)) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (evcond '((nil 2) (nil 1)) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVCOND, &#1075;&#1076;&#1077; &#1091;&#1095;&#1072;&#1089;&#1090;&#1074;&#1091;&#1077;&#1090; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (evcond '((a 2) (b 1))
                         '((a . 1) (b . ()))
                         nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (evcond '((a 2) (b 1))
                         '((a . nil) (b . T))
                         nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; COND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">cond</span>
                           (() 1)
                           (1 2))
                         nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">cond</span>
                           (a 1)
                           (b 2))
                         '((a . ()) (b . 1))
                         nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">cond</span>
                           (a 1)
                           (b 2))
                         '((a . 1) (b . ()))
                         nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; EVPROGN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (evprogn '(1 2) nil nil nil nil  #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; EVPROGN &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (evprogn '(a b c)
                          '((a . 1) (b . 2) (c . 3))
                           nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; PROGN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">progn</span> 1 2 3) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; PROGN &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">progn</span> a b c) '((a . 1) (b . 2) (c . 3))
                         nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVAND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and)           (evand '() nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1)         (evand '(1) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and nil)       (evand '(nil) nil nil nil  nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 nil)     (evand '(1 nil) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 nil)   (evand '(1 2 nil) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 3)     (evand '(1 2 3) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 nil 3) (evand '(1 2 nil 3) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVAND &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (and nil))
               (evand '(a) '((a . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (and a))
               (evand '(a) '((a . 1)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b nil))
                 (and a b))
               (evand '(a b) '((a . 1) (b . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c nil))
                 (and a b c))
               (evand '(a b c) '((a . 1) (b . 2) (c . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a b c))
               (evand '(a b c) '((a . 1) (b . 2) (c . 3)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c nil)
                     (d 3))
                 (and a b c d))
               (evand '(a b c) '((a . 1) (b . 2) (c . nil) (d . 3)) nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; AND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and)                (myeval '(and) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1)              (myeval '(and 1) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and nil)            (myeval '(and nil) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 nil)          (myeval '(and 1 nil) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 nil)        (myeval '(and 1 2 nil) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 3)          (myeval '(and 1 2 3) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 (and 1 2) 3)  (myeval '(and 1 (and 1 2) 3) nil nil nil nil
                                            #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 (and 1 nil) 3)  (myeval '(and 1 (and 1 nil) 3) nil nil nil nil
                                              #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; AND &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (and nil))
               (myeval '(and a) '((a . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (and a))
               (myeval '(and a) '((a . 1)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b nil))
                 (and a b))
               (myeval '(and a b) '((a . 1) (b . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c nil))
                 (and a b c))
               (myeval '(and a b c) '((a . 1) (b . 2) (c . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a b c))
               (myeval '(and a b c) '((a . 1) (b . 2) (c . 3)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a (and a b) c))
               (myeval '(and a (and a b) c) '((a . 1) (b . 2) (c . 3)) nil nil nil
                       #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b nil)
                     (c 3))
                 (and a (and a b) c))
               (myeval '(and a (and a b) c) '((a . 1) (b . nil) (c . 3)) nil nil nil
                       #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVOR</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or)                   (evor '() nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1)             (evor '(nil 1) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil nil 1)         (evor '(nil nil 1) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1 2)           (evor '(nil 1 2) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or 1 2 3)             (evor '(1 2 3) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil nil 3 nil)     (evor '(nil nil 3 nil) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVOR &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (or a))
               (evor '(a) '((a . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (or a))
               (evor '(a) '((a . 1)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1))
                 (or a b))
               (evor '(a b) '((a . nil) (b . 1)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b nil)
                     (c 3))
                 (or a b c))
               (evor '(a b c) '((a . nil) (b . nil) (c . 3)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1)
                     (c 2))
                 (or a b c))
               (evor '(a b c) '((a . nil) (b . 1) (c . 2)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b nil)
                     (c 3)
                     (d nil))
                 (or a b c d))
               (evor '(a b c d) '((a . nil) (b . nil) (c . 3) (d . nil)) nil nil nil
                     #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; OR</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or)                  (myeval '(or) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1)            (myeval '(or nil 1) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil nil 1)        (myeval '(or nil nil 1) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1 2)          (myeval '(or nil 1 2) nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil (or 3 2) 2)   (myeval '(or nil (or 3 2) 2) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; OR &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (or a))
               (myeval '(or a) '((a . nil)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (or a))
               (myeval '(or a) '((a . 1)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1))
                 (or a b))
               (myeval '(or a b) '((a . nil) (b . 1)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b nil)
                     (c 3))
                 (or a b c))
               (myeval '(or a b c) '((a . nil) (b . nil) (c . 3)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1)
                     (c 2))
                 (or a b c))
               (myeval '(or a b c) '((a . nil) (b . 1) (c . 2)) nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b nil)
                     (c nil)
                     (d 2))
                 (or a (or b c) d))
               (myeval '(or  a (or b c) d) '((a . nil) (b . nil) (c . nil) (d . 2))
                       nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; MYPAIRLIS</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(( a . 1) (b . 2) ( c . 3) (z . 6) (y . 77))
               (mypairlis '(a b c) '(1 2 3) '((z . 6) (y . 77)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span>
               (<span style="color: #af00ff;">handler-case</span> (mypairlis '(a b c) nil '((z . 6) (y . 77)))
                 (MYPAIRLIS-ERROR (condition) <span style="color: #87005f;">"error"</span>))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span>
               (<span style="color: #af00ff;">handler-case</span> (mypairlis nil '(1 2 3) '((z . 6) (y . 77)))
                 (MYPAIRLIS-ERROR (condition) <span style="color: #87005f;">"error"</span>))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVLET</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (evlet '(a b) '(1 2) nil '(4 (+ a b)) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LET</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(<span style="color: #af00ff;">let</span> ((a 1)
                                       (b 2))
                                  (cons a b))
                                  nil nil nil nil
                                  #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVLETSTAR</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (evletstar '((a 1) (b a)) '(4 (+ a b)) nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LET*</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 1 . 2) (myeval '(<span style="color: #af00ff;">let*</span> ((a 1)
                                          (b 2)
                                          (c (+ a b)))
                                    (cons c (cons a b)))
                                  nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; DEFUN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 64 (<span style="color: #af00ff;">progn</span>
                    (setf *glob-env* nil)
                    (myeval '(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">alfa</span> (x) (* x x)) nil nil nil nil #'err #'ok)
                    (<span style="color: #af00ff;">prog1</span> (myeval '(alfa 8) nil nil nil nil #'err #'ok)
                      (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1085;&#1072; IMPLICIT-PROGN &#1074; DEFUN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 384 (<span style="color: #af00ff;">progn</span>
                     (setf *glob-env* nil)
                     (myeval '(<span style="color: #af00ff;">let</span> ((y 3))
                               (<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">alfa</span> (x)
                                 (setq y 6)
                                 (* x x y)))
                             nil nil nil nil #'err #'ok)
                     (<span style="color: #af00ff;">prog1</span> (myeval '(alfa 8) nil nil nil nil #'err #'ok)
                       (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; SETQ</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1082;&#1072; &#1080;&#1079;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1103; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; &#1083;&#1086;&#1082;&#1072;&#1083;&#1100;&#1085;&#1086;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;, &#1085;&#1077; &#1079;&#1072;&#1090;&#1088;&#1072;&#1075;&#1080;&#1074;&#1072;&#1103; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1086;&#1075;&#1086; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((2 . 2) ((alfa . 0)))
               (<span style="color: #af00ff;">progn</span>
                 (setf *glob-env* '((alfa . 0)))
                 (<span style="color: #af00ff;">prog1</span> (list (myeval '(cons (setq alfa 2)
                                        alfa)
                                      '((alfa . 1))
                                      nil nil nil #'err #'ok)
                              *glob-env*)
                   (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1048;&#1079;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; &#1085;&#1077;&#1089;&#1091;&#1097;&#1077;&#1089;&#1090;&#1074;&#1091;&#1102;&#1097;&#1077;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081; (&#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1080;&#1077; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1086;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;)</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 1) ((ALFA . 1) (BETA . 222)))
               (<span style="color: #af00ff;">progn</span>
                 (setf *glob-env* '((beta . 222)))
                 (<span style="color: #af00ff;">prog1</span> (list (myeval '(cons
                                        (setq alfa 1)
                                        alfa)
                                      nil nil nil nil #'err #'ok)
                              *glob-env*)
                   (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1048;&#1079;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; &#1089;&#1091;&#1097;&#1077;&#1089;&#1090;&#1074;&#1091;&#1102;&#1097;&#1077;&#1081; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1086;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 1) ((BETA . 1)))
               (<span style="color: #af00ff;">progn</span>
                 (setf *glob-env* '((beta . 222)))
                 (<span style="color: #af00ff;">prog1</span> (list (myeval '(cons
                                        (setq beta 1)
                                        beta)
                                      nil nil nil nil #'err #'ok)
                              *glob-env*)
                   (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LAMBDA</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '((<span style="color: #af00ff;">lambda</span> (x) (+ 1  x)) 2)
                         nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LAMBDA &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 5 (myeval '(<span style="color: #af00ff;">let</span> ((y 3))
                           ((<span style="color: #af00ff;">lambda</span> (x) (+ y x)) 2))
                         nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1085;&#1072; IMPLICIT-PROGN &#1074; LAMBDA</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 8 (myeval '(<span style="color: #af00ff;">let</span> ((y 3))
                           ((<span style="color: #af00ff;">lambda</span> (x)
                              (setq y 6)
                              (+ y x)) 2))
                         nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; BLOCK</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (myeval '(<span style="color: #af00ff;">block</span> testblock)
                           nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">block</span> testblock 3)
                         nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; RETURN-FROM</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">block</span> testblock (<span style="color: #af00ff;">return-from</span> testblock (+ 1 2)) 777)
                         nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span> (myeval '(<span style="color: #af00ff;">block</span> testblock (<span style="color: #af00ff;">return-from</span> notblock (+ 1 2)) 777)
                               nil nil nil nil #'(<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>) #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span> (myeval '(<span style="color: #af00ff;">progn</span> (<span style="color: #af00ff;">return-from</span> not-found-block (+ 1 2)) 777)
                               nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                               #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; RETURN-FROM &#1074; &#1083;&#1077;&#1082;&#1089;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 12 (<span style="color: #af00ff;">progn</span>
                    (setf *glob-env* nil)
                    (<span style="color: #af00ff;">prog1</span> (myeval '(<span style="color: #af00ff;">progn</span>
                                     (<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                       (<span style="color: #af00ff;">block</span> in-lambda-block
                                         (<span style="color: #af00ff;">return-from</span> in-lambda-block
                                           (+ x 2))
                                         777))
                                     (foo 10))
                                   nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                                   #'ok)
                      (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; RETURN-FROM &#1074; &#1076;&#1080;&#1085;&#1072;&#1084;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080; (&#1076;&#1086;&#1083;&#1078;&#1085;&#1072; &#1073;&#1099;&#1090;&#1100; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072;)</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span> (<span style="color: #af00ff;">progn</span>
                         (setf *glob-env* nil)
                         (<span style="color: #af00ff;">prog1</span> (myeval '(<span style="color: #af00ff;">progn</span>
                                          (<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                            (<span style="color: #af00ff;">return-from</span> in-lambda-block
                                              (+ x 2))
                                            777)
                                          (<span style="color: #af00ff;">block</span> in-lambda-block
                                            (foo 10)))
                                        nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                                        #'ok)
                           (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1085;&#1072; &#1086;&#1096;&#1080;&#1073;&#1082;&#1091; &#1085;&#1077;&#1076;&#1086;&#1089;&#1090;&#1080;&#1078;&#1080;&#1084;&#1086;&#1075;&#1086; &#1073;&#1083;&#1086;&#1082;&#1072;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span> (myeval '((<span style="color: #af00ff;">block</span> the-block (<span style="color: #af00ff;">lambda</span> () (<span style="color: #af00ff;">return-from</span> the-block nil))))
                               nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                               #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1085;&#1072; &#1086;&#1090;&#1089;&#1091;&#1090;&#1089;&#1090;&#1074;&#1080;&#1077; &#1086;&#1096;&#1080;&#1073;&#1082;&#1080; &#1087;&#1088;&#1080; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1077; &#1074; &#1076;&#1086;&#1089;&#1090;&#1080;&#1078;&#1080;&#1084;&#1099;&#1081; &#1073;&#1083;&#1086;&#1082;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 123 (myeval '(<span style="color: #af00ff;">block</span> the-block (<span style="color: #af00ff;">return-from</span> the-block 123))
                           nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                           #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; CATCH</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (myeval '(<span style="color: #af00ff;">catch</span> '<span style="color: #008787;">zzz</span>)
                           nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">catch</span> '<span style="color: #008787;">zzz</span> 3)
                         nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; THROW</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">catch</span> '<span style="color: #008787;">testcatch</span> (<span style="color: #af00ff;">throw</span> '<span style="color: #008787;">testcatch</span> (+ 1 2)) 777)
                         nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span> (myeval '(<span style="color: #af00ff;">catch</span> '<span style="color: #008787;">testcatch</span> (<span style="color: #af00ff;">throw</span> '<span style="color: #008787;">notcatch</span> (+ 1 2)) 777)
                               nil nil nil nil
                               #'(<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                               #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span> (myeval '(<span style="color: #af00ff;">progn</span> (<span style="color: #af00ff;">throw</span> '<span style="color: #008787;">not-found-catch</span> (+ 1 2)) 777)
                               nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                               #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; THROW &#1074; &#1083;&#1077;&#1082;&#1089;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 12 (<span style="color: #af00ff;">progn</span>
                    (setf *glob-env* nil)
                    (<span style="color: #af00ff;">prog1</span> (myeval '(<span style="color: #af00ff;">progn</span>
                                     (<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                       (<span style="color: #af00ff;">catch</span> '<span style="color: #008787;">in-lambda-catch</span>
                                         (<span style="color: #af00ff;">throw</span> '<span style="color: #008787;">in-lambda-catch</span>
                                           (+ x 2))
                                         777))
                                     (foo 10))
                                   nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                                   #'ok)
                      (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; THROW &#1074; &#1076;&#1080;&#1085;&#1072;&#1084;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080; (&#1076;&#1086;&#1083;&#1078;&#1085;&#1086; &#1089;&#1088;&#1072;&#1073;&#1086;&#1090;&#1072;&#1090;&#1100;)</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 12 (<span style="color: #af00ff;">progn</span>
                    (setf *glob-env* nil)
                    (<span style="color: #af00ff;">prog1</span> (myeval '(<span style="color: #af00ff;">progn</span>
                                     (<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                       (<span style="color: #af00ff;">throw</span> '<span style="color: #008787;">in-lambda-catch</span>
                                         (+ x 2))
                                       777)
                                     (<span style="color: #af00ff;">catch</span> '<span style="color: #008787;">in-lambda-catch</span>
                                       (foo 10)))
                                   nil nil nil nil (<span style="color: #af00ff;">lambda</span> (x) <span style="color: #87005f;">"error"</span>)
                                   #'ok)
                      (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; TAGBODY</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (myeval '(<span style="color: #af00ff;">tagbody</span> a 1)
                           nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (myeval '(<span style="color: #af00ff;">tagbody</span> a 1 b 2)
                           nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; GO</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 4) (myeval '(<span style="color: #af00ff;">let</span> ((alfa 0))
                                  (<span style="color: #af00ff;">tagbody</span>
                                   a (setq alfa 1)
                                   b (<span style="color: #af00ff;">go</span> d)
                                   c (setq alfa (cons alfa 3))
                                   d (setq alfa (cons alfa 4)))
                                  alfa)
                                nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; "&#1086;&#1073;&#1088;&#1072;&#1090;&#1085;&#1086;&#1075;&#1086; &#1093;&#1086;&#1076;&#1072;" GO</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 5) (myeval '(<span style="color: #af00ff;">let</span> ((alfa 0))
                                  (<span style="color: #af00ff;">tagbody</span>
                                   a (<span style="color: #af00ff;">go</span> d)
                                   b (setq alfa 1)
                                   c (<span style="color: #af00ff;">go</span> e)
                                   d (<span style="color: #af00ff;">go</span> b)
                                   e (setq alfa (cons alfa 5)))
                                  alfa)
                                nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LABELS</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">labels</span> ((zzz (lst acc)
                          (print acc)
                          (<span style="color: #af00ff;">cond</span> ((null lst) acc)
                                (t (zzz (cdr lst) (+ 1 acc))))))
                 (print 888)
                 (zzz '(1 2 3) 0))
               (myeval '(<span style="color: #af00ff;">labels</span> ((zzz (lst acc)
                                  (print acc)
                                  (<span style="color: #af00ff;">cond</span> ((null lst) acc)
                                        (t (zzz (cdr lst) (+ 1 acc))))))
                         (print 888)
                         (zzz '(1 2 3) 0))
                         nil nil nil nil #'err #'ok)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (<span style="color: #af00ff;">labels</span> ((zzz (lst acc)
                            (print acc)
                            (<span style="color: #af00ff;">cond</span> ((null lst) acc)
                                  (t (zzz (cdr lst) (+ 1 acc))))))
                   (print 888)
                   (zzz '(1 2 3) 0)))
               (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (myeval '(<span style="color: #af00ff;">labels</span> ((zzz (lst acc)
                                    (print acc)
                                    (<span style="color: #af00ff;">cond</span> ((null lst) acc)
                                          (t (zzz (cdr lst) (+ 1 acc))))))
                           (print 888)
                           (zzz '(1 2 3) 0))
                         nil nil nil nil #'err #'identity))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; RESET</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 8 (myeval '(<span style="color: #af00ff;">progn</span>
                            (+ 1 (reset (+ 2 3)) 2))
                            nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; SHIFT/RESET</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 44 (myeval '(<span style="color: #af00ff;">let</span> ((foo))
                            (+ 1 (reset (+ 2 (shift f (<span style="color: #af00ff;">progn</span> (setq foo f) 4)))))
                            (foo 42))
                          nil nil nil nil #'err #'ok)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">REPL</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">repl</span> (prompt catch-env errcont cont)
  (format t <span style="color: #87005f;">"~%~A&gt; "</span> prompt)
  (finish-output)
  (myeval (read) nil nil nil (acons 'exit cont catch-env)
    #'(<span style="color: #af00ff;">lambda</span> (x)
        (princ x)
        (terpri)
        (finish-output)
        (repl prompt catch-env errcont cont))
    #'(<span style="color: #af00ff;">lambda</span> (x)
        (princ x)
        (terpri)
        (finish-output)
        (repl prompt catch-env errcont cont))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(repl)</span>
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
