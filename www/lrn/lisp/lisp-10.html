<!DOCTYPE html>
<html>
<head>
<title>lisp-10</title>
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="rigidus">
<link href="/css/style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="content">
<h1 class="title">lisp-10</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">План работ</a></li>
<li><a href="#sec-2">Stepper</a></li>
<li><a href="#sec-3">Глобальное окружение</a></li>
<li><a href="#sec-4">Функции для тестирования</a></li>
<li><a href="#sec-5">Структура замыкания</a></li>
<li><a href="#sec-6">Структура UNICONT</a></li>
<li><a href="#sec-7">Применение продолжений</a></li>
<li><a href="#sec-8">MyApply</a>
<ul>
<li><a href="#sec-8-1">Работа с CONS-ячейками</a></li>
<li><a href="#sec-8-2">NULL-предикат</a></li>
<li><a href="#sec-8-3">Встроенные функции арифметики</a></li>
<li><a href="#sec-8-4">CLOSURE</a></li>
<li><a href="#sec-8-5">PRINT</a></li>
<li><a href="#sec-8-6">LIST</a></li>
<li><a href="#sec-8-7">CALL/CC</a></li>
</ul>
</li>
<li><a href="#sec-9">MyEval</a>
<ul>
<li><a href="#sec-9-1">Самовычисляемые формы</a></li>
<li><a href="#sec-9-2">Вычисление символов</a></li>
<li><a href="#sec-9-3">Цитирование</a></li>
<li><a href="#sec-9-4">Условное выполнение IF</a></li>
<li><a href="#sec-9-5">COND</a></li>
<li><a href="#sec-9-6">PROGN</a></li>
<li><a href="#sec-9-7">AND</a></li>
<li><a href="#sec-9-8">OR</a></li>
<li><a href="#sec-9-9">LET</a></li>
<li><a href="#sec-9-10">LET*</a></li>
<li><a href="#sec-9-11">DEFUN</a></li>
<li><a href="#sec-9-12">SETQ</a></li>
<li><a href="#sec-9-13">LAMBDA</a></li>
<li><a href="#sec-9-14">BLOCK</a></li>
<li><a href="#sec-9-15">RETURN-FROM</a></li>
<li><a href="#sec-9-16">CATCH</a></li>
<li><a href="#sec-9-17">THROW</a></li>
<li><a href="#sec-9-18">TAGBODY</a></li>
<li><a href="#sec-9-19">GO</a></li>
<li><a href="#sec-9-20">LABELS</a></li>
<li><a href="#sec-9-21">RESET</a></li>
<li><a href="#sec-9-22">SHIFT</a></li>
</ul>
</li>
<li><a href="#sec-10">REPL</a></li>
<li><a href="#sec-11"><span class="todo TODO">TODO</span> TODO</a></li>
<li><a href="#sec-12">Итоги</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">План работ</h2>
<div class="outline-text-2" id="text-1">
<p>
Теперь нам нужно сделать трамполинизацию, т.е. преобразовать дефункционализованный
интерпретатор так, чтобы он был написан в trampoline-стиле. Трамполинизация часто
используется для написания хвосторекурсивных функций на языках, которые не поддерживают
хвостовую рекурсию, но имеют ФВП.
</p>

<p>
В качестве примера возьмем <code>fact-tail-call-cps</code>, который был определен ранее:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">fact-tail-call-cps</span> (n cont)
  (<span style="color: #a020f0;">cond</span> ((equal n 1)  (funcall cont 1))
        (t            (fact-tail-call-cps (- n 1)
                                          (<span style="color: #a020f0;">lambda</span> (x)
                                            (funcall cont (* n x)))))))
</pre>
</div>

<p>
Мы можем заставить его возвращать на каждом шаге вычисления список, в котором в первом
элементе будет тип действия, который нужно выполнить дальше:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">fact-tramp</span> (n cont)
  (<span style="color: #a020f0;">cond</span> ((equal n 1)  (list 'return cont 1))
        (t            (list 'fact   (- n 1)
                                    (<span style="color: #a020f0;">lambda</span> (x)
                                      (funcall cont (* n x)))))))
</pre>
</div>

<p>
Тогда цепочка вызовов будет строиться так:
</p>

<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #b22222;">;; </span><span style="color: #b22222;">1</span>
(fact-tramp 1 #'identity)
<span style="color: #a020f0;">=&gt;</span> ('return #'identity 1)
(funcall (cadr retval) (caddr retval))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">2</span>
(fact-tramp 2 #'identity)
<span style="color: #a020f0;">=&gt;</span> ('fact 1 (<span style="color: #a020f0;">lambda</span> (x)
              (funcall #'identity (* 2 x))))
(funcall #'fact-tramp (cadr retval) (caddr retval))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">3</span>
(fact-tramp 3 #'identity)
<span style="color: #a020f0;">=&gt;</span> ('fact 1 (<span style="color: #a020f0;">lambda</span> (x)
              (funcall (<span style="color: #a020f0;">lambda</span> (x)
                         (funcall identity (* 2 x)))
                       (* 3 x))))
(funcall #'fact-tramp (cadr retval) (caddr retval))
</pre>
</div>

<p>
Здесь на каждом шаге последовательно показан вызов, его возвращаемое значение и
действие, которое нужно выполнить над возвращаемым значением, чтобы продолжить
вычисления.
</p>

<p>
Эти действия выполняет внешний вычислитель, который мы назовем <code>stepper</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">stepper</span> (retval)
  (<span style="color: #a020f0;">cond</span> ((equal (car retval) 'return)  (funcall (cadr retval) (caddr retval)))
        ((equal (car retval) 'fact)    (stepper
                                        (funcall #'fact-tramp (cadr retval) (caddr retval))))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(print (stepper `(fact 3 ,#'identity)))</span>
</pre>
</div>

<p>
Появление степпера дает нам возможность организовать пошаговый отладчик или даже
очереди из шагов вычислений и делать шаг из каждой такой очереди по порядку,
т.е. обеспечить парралелелизм.
</p>

<p>
Кроме того, такая техника не приводит к росту стека хост-языка при выполнении
хвосторекурсивных вызовов интерпретируемой программы.
</p>

<p>
Реализуем это в нашем интерпретаторе. Он будет иметь два фрейма - там, где мы делаем
<code>apply-continuatuon</code> и там где мы делаем <code>eval</code>. Остальное трамполинизировать нет
необходимости, т.к. это ничуть не помогает нам, например, сделать отладчик.
</p>

<p>
Наша задача - заменить вызовы <code>myeval</code> на возврат значения таким образом, чтобы внешний
вычислитель мог получить это значение и выполнить действие.
</p>

<p>
Также заменяем вызовы <code>apply-continuation</code> на возврат списка, начинающегося с символа
<code>return</code>.
</p>

<p>
Ну и собственно напишем этот внешний вычислитель, который назовем <code>stepper</code>
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Stepper</h2>
<div class="outline-text-2" id="text-2">
<p>
Нам нужен некоторый внешний запускатель кода, который принимает список, в котором в
первом элементе указано, что следует запустить. Так мы выделяем фреймы
вычисления.
</p>

<p>
Нам понадобится фреймы DONE и ERROR - на этих точках мы будем прерывать
рекурсию. IDENTITY-continuations (<code>ok</code> и <code>err</code>) будет возвращать 'done и 'error.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="stepper_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">stepper</span> (frame)
  (<span style="color: #a020f0;">cond</span> ((equal (car frame) 'done)   (cadr frame))
        ((equal (car frame) 'error)  (cadr frame))
        ((equal (car frame) 'return) (stepper (apply #'apply-continuation (cdr frame))))
        ((equal (car frame) 'eval)   (stepper (apply #'myeval (cdr frame))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Глобальное окружение</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-lisp" id="assoc_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">assoc-2</span> (key alist success failure) <span style="color: #b22222;">;; </span><span style="color: #b22222;">NB!: inverted order of continuations</span>
                                           <span style="color: #b22222;">;; </span><span style="color: #b22222;">(for lookup comfort)</span>
  (<span style="color: #a020f0;">cond</span> ((null alist)              (funcall failure key))
        ((equal key (caar alist))  (funcall success    (cdar alist)))
        (t                         (assoc-2 key (cdr alist) success failure))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="assoc_10_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"ok:123"</span>
               (assoc-2 'alfa '((alfa . 123))
                        (<span style="color: #a020f0;">lambda</span> (x) (format nil <span style="color: #8b2252;">"ok:~A"</span> x))
                        (<span style="color: #a020f0;">lambda</span> (x) (format nil <span style="color: #8b2252;">"err:~A"</span> x)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"err:ALFA"</span>
               (assoc-2 'alfa '((beta . 123))
                        (<span style="color: #a020f0;">lambda</span> (x) (format nil <span style="color: #8b2252;">"ok:~A"</span> x))
                        (<span style="color: #a020f0;">lambda</span> (x) (format nil <span style="color: #8b2252;">"err:~A"</span> x)))))
</pre>
</div>

<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="lookup_10"><span style="color: #b22222;">;; </span><span style="color: #b22222;">environment</span>
(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*glob-env*</span> nil)
<span style="color: #b22222;">;; </span><span style="color: #b22222;">lookup</span>
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">lookup</span> (symb env errcont cont)
  (assoc-2 symb env
           (<span style="color: #a020f0;">lambda</span> (x)
             (list 'return cont x))
           (<span style="color: #a020f0;">lambda</span> (key)
             (assoc-2 key *glob-env*
                      (<span style="color: #a020f0;">lambda</span> (x) <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1074;&#1086;&#1079;&#1084;&#1086;&#1078;&#1085;&#1086; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072; (&#1073;&#1099;&#1083;&#1072;) &#1090;&#1091;&#1090;</span>
                        (list 'return cont x))
                      (<span style="color: #a020f0;">lambda</span> (key)
                        (list 'return
                              errcont
                              (format
                               nil <span style="color: #8b2252;">"UNBOUD VARIABLE [~A] ~%LOCAL ENV: [~A] ~%GLOBAL ENV: [~A]"</span>
                               key env *glob-env*)))))))
</pre>
</div>

<p>
Модифицируем тесты
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="lookup_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">test lookup</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"ok:123"</span> (<span style="color: #a020f0;">let</span> ((retval (lookup 'aaa '((aaa . 123))
                                              (<span style="color: #a020f0;">lambda</span> (x) (format nil <span style="color: #8b2252;">"err:~A"</span> x))
                                              (<span style="color: #a020f0;">lambda</span> (x) (format nil <span style="color: #8b2252;">"ok:~A"</span> x)))))
                          (apply-continuation (cadr retval) (caddr retval)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil      (<span style="color: #a020f0;">let</span> ((retval (lookup 'aaa '((bbb . 123))
                                              (<span style="color: #a020f0;">lambda</span> (x) (<span style="color: #a020f0;">declare</span> (ignore x)) nil)
                                              (<span style="color: #a020f0;">lambda</span> (x) (format nil <span style="color: #8b2252;">"ok:~A"</span> x)))))
                          (apply-continuation (cadr retval) (caddr retval)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Функции для тестирования</h2>
<div class="outline-text-2" id="text-4">
<p>
Теперь возвращают DONE-фрейм и ERROR-фрейм:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="ok_err_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">ok</span> (x)
  (format t <span style="color: #8b2252;">"~%ok: ~A"</span> x)
  (list 'done x))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">err</span> (x)
  (format t <span style="color: #8b2252;">"~%err: ~A"</span> x)
  (list 'error x))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Структура замыкания</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-lisp" id="closure_10">(<span style="color: #a020f0;">defstruct</span> <span style="color: #228b22;">closure</span>
  body
  env
  block-env
  go-env
  args)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">Структура UNICONT</h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-lisp" id="unicont_10">(<span style="color: #a020f0;">defstruct</span> <span style="color: #228b22;">unicont</span>
  block-env
  go-env
  catch-env
  errcont
  cont)
&lt;&lt;construct_10&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">Применение продолжений</h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">

<pre class="src src-lisp" id="errors_10">(<span style="color: #a020f0;">define-condition</span> <span style="color: #0000ff;">unknown-continuation</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((cont <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:cont</span>  <span style="color: #483d8b;">:reader</span> cont))
  (<span style="color: #483d8b;">:report</span>
   (<span style="color: #a020f0;">lambda</span> (condition stream)
     (format stream <span style="color: #8b2252;">"Error in APPLY-CONTINUATION: unknown-continuation: ~A"</span>
             (cont condition)))))
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
</p>

<p>
[TODO:gmm] Дефункционализировать <code>cont</code> и <code>errcont</code> и убрать <code>((functionp cont) (funcall cont arg))</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_continuation_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">apply-continuation</span> (cont arg)
  (<span style="color: #a020f0;">cond</span> ((functionp cont)       (funcall cont arg))
        &lt;&lt;apply_cont_if_10&gt;&gt;
        &lt;&lt;apply_cont_evcond_10&gt;&gt;
        &lt;&lt;apply_cont_evcond_10&gt;&gt;
        &lt;&lt;apply_cont_evand_10&gt;&gt;
        &lt;&lt;apply_cont_evor_10&gt;&gt;
        &lt;&lt;apply_cont_evlet_10&gt;&gt;
        &lt;&lt;apply_cont_evletstar_10&gt;&gt;
        &lt;&lt;apply_cont_setq_10&gt;&gt;
        &lt;&lt;apply_cont_catch_10&gt;&gt;
        &lt;&lt;apply_cont_throw_10&gt;&gt;
        &lt;&lt;apply_cont_throw2_10&gt;&gt;
        &lt;&lt;apply_cont_evtagbody_10&gt;&gt;
        &lt;&lt;apply_cont_evlis_10&gt;&gt;
        (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'unknown-continuation <span style="color: #483d8b;">:cont</span> cont))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8">MyApply</h2>
<div class="outline-text-2" id="text-8">
<div class="org-src-container">

<pre class="src src-lisp" id="errors_10">(<span style="color: #a020f0;">define-condition</span> <span style="color: #0000ff;">unknown-function</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((fn <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:fn</span>  <span style="color: #483d8b;">:reader</span> fn))
  (<span style="color: #483d8b;">:report</span>
   (<span style="color: #a020f0;">lambda</span> (condition stream)
     (format stream <span style="color: #8b2252;">"Error in MYAPPLY: unknown-function: ~A"</span>
             (fn condition)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_10">&lt;&lt;evlis_cont_10&gt;&gt;
&lt;&lt;evaddmul_10&gt;&gt;
&lt;&lt;evlis_10&gt;&gt;
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">myapply</span> (fn args catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span>
    &lt;&lt;myapply_car_cdr_cons_10&gt;&gt;
    &lt;&lt;myapply_null_10&gt;&gt;
    &lt;&lt;myapply_ariph_10&gt;&gt;
    &lt;&lt;myapply_closure_10&gt;&gt;
    &lt;&lt;myapply_print_10&gt;&gt;
    &lt;&lt;myapply_list_10&gt;&gt;
    &lt;&lt;myapply_callcc_10&gt;&gt;
    (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'unknown-function <span style="color: #483d8b;">:fn</span> fn))))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myapply_10_test">&lt;&lt;myapply_car_cdr_cons_10_test&gt;&gt;
&lt;&lt;myapply_null_10_test&gt;&gt;
&lt;&lt;evaddmul_10_test&gt;&gt;
&lt;&lt;myapply_ariph_10_test&gt;&gt;
&lt;&lt;myapply_closure_10_test&gt;&gt;
&lt;&lt;myapply_print_10_test&gt;&gt;
&lt;&lt;myapply_list_10_test&gt;&gt;
&lt;&lt;myapply_callcc_10_test&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1">Работа с CONS-ячейками</h3>
<div class="outline-text-3" id="text-8-1">
<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_car_cdr_cons_10">((equal fn 'car)             (list 'return cont (caar args)))
((equal fn 'cdr)             (list 'return cont (cdar args)))
((equal fn 'cons)            (list 'return cont (cons (car args) (cadr args))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_car_cdr_cons_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; cons, car, cdr</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (stepper (myeval '(cons 1 2) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 2) 3 . 4) (stepper (myeval '(cons (cons 1 2) (cons 3 4)) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (stepper (myeval '(car (cons 2 3)) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(cdr (cons 2 3)) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (stepper (myeval '(car (cons (cons 1 2) (cons 3 4)))
                                         nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 . 4) (stepper (myeval '(cdr (cons (cons 1 2) (cons 3 4)))
                                         nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; cons-&#1103;&#1095;&#1077;&#1077;&#1082;, &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1093; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (stepper (myeval '(car a) '((a . (1 . 2))) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (stepper (myeval '(cdr a) '((a . (1 . 2))) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(car b) '((a . (1 . 2)) (b . (3 . 4))) nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2">NULL-предикат</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">

<pre class="src src-lisp" id="errors_10">(<span style="color: #a020f0;">define-condition</span> <span style="color: #0000ff;">invalid-number-of-arguments</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((fn <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:fn</span>  <span style="color: #483d8b;">:reader</span> fn))
  (<span style="color: #483d8b;">:report</span>
   (<span style="color: #a020f0;">lambda</span> (condition stream)
     (format stream <span style="color: #8b2252;">"Error in MYAPPLY: invalid-number-of-arguments: ~A"</span>
             (fn condition)))))
</pre>
</div>

<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_null_10">((equal fn 'null)            (<span style="color: #a020f0;">if</span> (null (cdr args))
                                 (list 'return cont (null (car args)))
                                 (<span style="color: #ff0000; font-weight: bold;">error</span> 'invalid-number-of-arguments <span style="color: #483d8b;">:fn</span> fn)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_null_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; NULL</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (stepper (myeval '(null ()) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (stepper (myeval '(null nil) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (stepper (myeval '(null T) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (stepper (myeval '(null a) '((a . ())) nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; NULL, &#1089; &#1072;&#1088;&#1075;&#1091;&#1084;&#1077;&#1085;&#1090;&#1086;&#1084;, &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1077; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (stepper (myeval '(null a) '((a . T)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (stepper (myeval '(null a) '((a . 1)) nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3">Встроенные функции арифметики</h3>
<div class="outline-text-3" id="text-8-3">
<div class="org-src-container">

<pre class="src src-lisp" id="evaddmul_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evadd</span> (lst acc)
  (<span style="color: #a020f0;">cond</span> ((null lst)        0)
        ((null (cdr lst))  (+ acc (car lst)))
        (t                 (evadd (cdr lst)
                                  (+ acc (car lst))))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evmul</span> (lst acc)
  (<span style="color: #a020f0;">cond</span> ((null lst)        1)
        ((null (cdr lst))  (* acc (car lst)))
        (t                 (evmul (cdr lst)
                                  (* acc (car lst))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="evaddmul_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVADD</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0                (evadd '() 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2                (evadd '(2) 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 5                (evadd '(2 3) 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3 4)        (evadd '(2 3 4) 0)))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVMUL</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1                (evmul '() 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2                (evmul '(2) 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 6                (evmul '(2 3) 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3 4)        (evmul '(2 3 4) 1)))
</pre>
</div>

<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_ariph_10">((equal fn '+)             (list 'return cont (evadd args 0)))
((equal fn '*)             (list 'return cont (evmul args 1)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_ariph_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0                (stepper (myeval '(+) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2)            (stepper (myeval '(+ 2) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3)          (stepper (myeval '(+ 2 3) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3 4)        (stepper (myeval '(+ 2 3 4) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 (+ 3 4))    (stepper (myeval '(+ 2 (+ 3 4)) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 (+ 3 4) 5)  (stepper (myeval '(+ 2 (+ 3 4) 5) nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1091;&#1084;&#1085;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1                (stepper (myeval '(*) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2)            (stepper (myeval '(* 2) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3)          (stepper (myeval '(* 2 3) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3 4)        (stepper (myeval '(* 2 3 4) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 (* 3 4))    (stepper (myeval '(* 2 (* 3 4)) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 (* 3 4) 5)  (stepper (myeval '(* 2 (* 3 4) 5) nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0
               (stepper (myeval '(+) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2))
                 (+ a))
               (stepper (myeval '(+ a)
                       '((a . 2))
                       nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3))
                 (+ a b))
               (stepper (myeval '(+ a b)
                       '((a . 2) (b . 3))
                       nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3) (c 4))
                 (+ a b c))
               (stepper (myeval '(+ a b c)
                       '((a . 2) (b . 3) (c . 4))
                       nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3) (c 4))
                 (+ a (+ b c)))
               (stepper (myeval '(+ a (+ b c))
                       '((a . 2) (b . 3) (c . 4))
                       nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3) (c 4) (d 5))
                 (+ a (+ b c) d))
               (stepper (myeval '(+ a (+ b c) d)
                       '((a . 2) (b . 3) (c . 4) (d . 5))
                       nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1091;&#1084;&#1085;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;  &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1
               (stepper (myeval '(*) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2))
                 (* a))
               (stepper (myeval '(* a)
                       '((a . 2))
                       nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3))
                 (* a b))
               (stepper (myeval '(* a b)
                       '((a . 2) (b . 3))
                       nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3) (c 4))
                 (* a b c))
               (stepper (myeval '(* a b c)
                       '((a . 2) (b . 3) (c . 4))
                       nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3) (c 4))
                 (* a (* b c)))
               (stepper (myeval '(* a (* b c))
                       '((a . 2) (b . 3) (c . 4))
                       nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3) (c 4) (d 5))
                 (* a (* b c) d))
               (stepper (myeval '(* a (* b c) d)
                       '((a . 2) (b . 3) (c . 4) (d . 5))
                       nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-4" class="outline-3">
<h3 id="sec-8-4">CLOSURE</h3>
<div class="outline-text-3" id="text-8-4">
<div class="org-src-container">

<pre class="src src-lisp" id="myapply_closure_10">((closure-p fn)              (evprogn (closure-body fn)
                                      (pairlis (closure-args fn)
                                               args
                                               (closure-env fn))
                                      (closure-block-env fn)
                                      (closure-go-env fn)
                                      catch-env
                                      errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_closure_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1087;&#1088;&#1080;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1103; CLOSURE</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (stepper (myeval '(((<span style="color: #a020f0;">lambda</span> (x)
                                       (<span style="color: #a020f0;">lambda</span> (y) x))
                                     1)
                                    2)
                                  nil nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-5" class="outline-3">
<h3 id="sec-8-5">PRINT</h3>
<div class="outline-text-3" id="text-8-5">
<p>
[TODO:gmm] Сделать проверку кол-ва аргументов
</p>

<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_print_10">((equal fn 'print)           (list 'return cont (print (car args))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_print_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; PRINT &#1074; &#1089;&#1088;&#1072;&#1074;&#1085;&#1077;&#1085;&#1080;&#1080; &#1089; host-&#1086;&#1074;&#1099;&#1084; print</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (format nil <span style="color: #8b2252;">"~%~A ~%ok: ~A"</span> 12 12)
               (<span style="color: #a020f0;">with-output-to-string</span> (*standard-output*)
                 (stepper (myeval '(print 12) nil nil nil nil #'err #'ok)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (print 12)
               (stepper (myeval '(print 12) nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; PRINT &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (format nil <span style="color: #8b2252;">"~%~A ~%ok: ~A"</span> 12 12)
               (<span style="color: #a020f0;">with-output-to-string</span> (*standard-output*)
                 (stepper (myeval '(print a)
                                  '((b . 23) (a . 12))
                                  nil nil nil #'err #'ok)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (print 12)
               (stepper (myeval '(print a)
                                '((b . 23) (a . 12))
                                nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-6" class="outline-3">
<h3 id="sec-8-6">LIST</h3>
<div class="outline-text-3" id="text-8-6">
<div class="org-src-container">

<pre class="src src-lisp" id="evlis_cont_10">(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">evlis-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  fn
  unevaled
  evaled
  env)
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="evlis_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evlis</span> (fn unevaled evaled env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null unevaled)  (myapply fn (reverse evaled) catch-env errcont cont))
        (t                (list 'eval (car unevaled) env block-env go-env catch-env errcont
                                  (make-evlis-cont
                                   <span style="color: #483d8b;">:fn</span> fn
                                   <span style="color: #483d8b;">:unevaled</span> unevaled
                                   <span style="color: #483d8b;">:evaled</span> evaled
                                   <span style="color: #483d8b;">:env</span> env
                                   <span style="color: #483d8b;">:block-env</span> block-env
                                   <span style="color: #483d8b;">:go-env</span> go-env
                                   <span style="color: #483d8b;">:catch-env</span> catch-env
                                   <span style="color: #483d8b;">:errcont</span> errcont
                                   <span style="color: #483d8b;">:cont</span> cont)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evlis_10">((evlis-cont-p cont)    (evlis (evlis-cont-fn cont)
                               (cdr (evlis-cont-unevaled cont))
                               (cons arg (evlis-cont-evaled cont))
                               (evlis-cont-env cont)
                               (unicont-block-env cont)
                               (unicont-go-env cont)
                               (unicont-catch-env cont)
                               (unicont-errcont cont)
                               (unicont-cont cont)))
</pre>
</div>

<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_list_10">((equal fn 'list)            (list 'return cont args))
</pre>
</div>

<p>
Убираем тесты <code>evlis</code>, т.к. теперь мы не можем тестировать без <code>stepper</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_list_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LIST</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 14) (stepper (myeval '(list 1 (+ 2 (* 3 4)))
                               nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (stepper (myeval '(list (+ 1 2) (* 2 3) 42) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (stepper (myeval '(list (+ a b) (* b c) 42)
                       '((a . 1) (b . 2) (c . 3) (d . 4))
                       nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-8-7" class="outline-3">
<h3 id="sec-8-7">CALL/CC</h3>
<div class="outline-text-3" id="text-8-7">
<div class="org-src-container">

<pre class="src src-lisp" id="myapply_callcc_10">((equal fn 'call/cc)         (myapply (car args) (list cont) catch-env errcont cont))
((functionp fn)              (apply fn args))      <span style="color: #b22222;">; interim hack</span>
((unicont-p fn)              (apply-continuation fn (car args)))
<span style="color: #b22222;">;;  </span><span style="color: #b22222;">((identity-cont-p fn)        (apply-continuation fn (car args))) ;; for identity</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_callcc_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; CALL/CC</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 14 (stepper (myeval '(+ 1 2 (call/cc (<span style="color: #a020f0;">lambda</span> (x) (+ 3 4) (x (+ 5 6)) (+7 8))))
                                   nil nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9">MyEval</h2>
<div class="outline-text-2" id="text-9">
<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_10">&lt;&lt;myeval_evcond_10&gt;&gt;
&lt;&lt;myeval_evprogn_10&gt;&gt;
&lt;&lt;myeval_evand_10&gt;&gt;
&lt;&lt;myeval_evor_10&gt;&gt;
&lt;&lt;myeval_mypairlis_10&gt;&gt;
&lt;&lt;myeval_evlet_10&gt;&gt;
&lt;&lt;myeval_evletstar_10&gt;&gt;
&lt;&lt;myeval_evthrow_10&gt;&gt;
&lt;&lt;myeval_evtagbody_10&gt;&gt;
&lt;&lt;myeval_is_cont_subset_10&gt;&gt;
&lt;&lt;myeval_make_goenv_10&gt;&gt;
&lt;&lt;myeval_apply_go_continuation_10&gt;&gt;
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">myeval</span> (exp env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span>
    &lt;&lt;myeval_number_10&gt;&gt;
    &lt;&lt;myeval_symb_10&gt;&gt;
    &lt;&lt;myeval_quote_10&gt;&gt;
    &lt;&lt;myeval_if_10&gt;&gt;
    &lt;&lt;myeval_cond_10&gt;&gt;
    &lt;&lt;myeval_progn_10&gt;&gt;
    &lt;&lt;myeval_and_10&gt;&gt;
    &lt;&lt;myeval_or_10&gt;&gt;
    &lt;&lt;myeval_let_10&gt;&gt;
    &lt;&lt;myeval_letstar_10&gt;&gt;
    &lt;&lt;myeval_defun_10&gt;&gt;
    &lt;&lt;myeval_setq_10&gt;&gt;
    &lt;&lt;myeval_lambda_10&gt;&gt;
    &lt;&lt;myeval_block_10&gt;&gt;
    &lt;&lt;myeval_return_from_10&gt;&gt;
    &lt;&lt;myeval_catch_10&gt;&gt;
    &lt;&lt;myeval_throw_10&gt;&gt;
    &lt;&lt;myeval_tagbody_10&gt;&gt;
    &lt;&lt;myeval_go_10&gt;&gt;
    &lt;&lt;myeval_labels_10&gt;&gt;
    &lt;&lt;myeval_reset_10&gt;&gt;
    &lt;&lt;myeval_shift_10&gt;&gt;
    (t
     (list 'eval (car exp) env block-env go-env catch-env errcont
             (<span style="color: #a020f0;">lambda</span> (x)
               (evlis x (cdr exp) nil env block-env go-env catch-env errcont cont))))))
</pre>
</div>

<p>
Тесты:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_10_test">&lt;&lt;myeval_number_10_test&gt;&gt;
&lt;&lt;myeval_symb_10_test&gt;&gt;
&lt;&lt;myeval_quote_10_test&gt;&gt;
&lt;&lt;myeval_if_10_test&gt;&gt;
&lt;&lt;myeval_cond_10_test&gt;&gt;
&lt;&lt;myeval_progn_10_test&gt;&gt;
&lt;&lt;myeval_and_10_test&gt;&gt;
&lt;&lt;myeval_or_10_test&gt;&gt;
&lt;&lt;myeval_mypairlis_10_test&gt;&gt;
&lt;&lt;myeval_let_10_test&gt;&gt;
&lt;&lt;myeval_letstar_10_test&gt;&gt;
&lt;&lt;myeval_defun_10_test&gt;&gt;
&lt;&lt;myeval_setq_10_test&gt;&gt;
&lt;&lt;myeval_lambda_10_test&gt;&gt;
&lt;&lt;myeval_block_10_test&gt;&gt;
&lt;&lt;myeval_return_from_10_test&gt;&gt;
&lt;&lt;myeval_catch_10_test&gt;&gt;
&lt;&lt;myeval_throw_10_test&gt;&gt;
&lt;&lt;myeval_tagbody_10_test&gt;&gt;
&lt;&lt;myeval_go_10_test&gt;&gt;
&lt;&lt;myeval_labels_10_test&gt;&gt;
&lt;&lt;myeval_reset_10_test&gt;&gt;
&lt;&lt;myeval_shift_10_test&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1">Самовычисляемые формы</h3>
<div class="outline-text-3" id="text-9-1">
<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_number_10">((null exp)                  (list 'return cont 'nil))
((equal 't exp)              (list 'return cont 't))
((member exp '(+ * car cdr cons null print list call/cc repl))  (list 'return cont exp))
((numberp exp)               (list 'return cont exp))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_number_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1072;&#1084;&#1086;&#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1093; &#1092;&#1086;&#1088;&#1084;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (stepper (myeval 'T nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (stepper (myeval 'NIL nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 999 (stepper (myeval 999 nil nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2">Вычисление символов</h3>
<div class="outline-text-3" id="text-9-2">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_symb_10">((symbolp exp)               (lookup exp env errcont cont))
</pre>
</div>

<p>
Немного модифицируем тест на ошибку
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_symb_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1077;&#1085;&#1080;&#1103; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 6 (stepper (myeval 'b '((a . 3) (b . 6)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal #'err (cadr (myeval 'b nil nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-3" class="outline-3">
<h3 id="sec-9-3">Цитирование</h3>
<div class="outline-text-3" id="text-9-3">
<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_quote_10">((equal (car exp) 'quote)    (list 'return cont (cadr exp)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_quote_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; QUOTE</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(+ 1 2) (stepper (myeval '(quote (+ 1 2)) nil nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-4" class="outline-3">
<h3 id="sec-9-4">Условное выполнение IF</h3>
<div class="outline-text-3" id="text-9-4">
<div class="org-src-container">

<pre class="src src-lisp" id="construct_10">(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">if-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  clauses
  env)
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_if_10">((equal (car exp) 'if)       (list 'eval (cadr exp) env block-env go-env catch-env errcont
                                   (make-if-cont
                                    <span style="color: #483d8b;">:clauses</span> exp
                                    <span style="color: #483d8b;">:env</span> env
                                    <span style="color: #483d8b;">:block-env</span> block-env
                                    <span style="color: #483d8b;">:go-env</span> go-env
                                    <span style="color: #483d8b;">:catch-env</span> catch-env
                                    <span style="color: #483d8b;">:errcont</span> errcont
                                    <span style="color: #483d8b;">:cont</span> cont)))
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_if_10">((if-cont-p cont)       (<span style="color: #a020f0;">if</span> arg
                            (list 'eval (caddr (if-cont-clauses cont))
                                  (if-cont-env cont)
                                  (if-cont-block-env cont)
                                  (if-cont-go-env cont)
                                  (if-cont-catch-env cont)
                                  (if-cont-errcont cont)
                                  (if-cont-cont cont))
                            (list 'eval (cadddr (if-cont-clauses cont))
                                  (if-cont-env cont)
                                  (if-cont-block-env cont)
                                  (if-cont-go-env cont)
                                  (if-cont-catch-env cont)
                                  (if-cont-errcont cont)
                                  (if-cont-cont cont))))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myeval_if_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; IF</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (stepper (myeval '(<span style="color: #a020f0;">if</span> () 1 2) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (stepper (myeval '(<span style="color: #a020f0;">if</span> (null ()) 1 2) nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; IF, &#1075;&#1076;&#1077; &#1091;&#1089;&#1083;&#1086;&#1074;&#1080;&#1077; &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1090;&#1089;&#1103; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (stepper (myeval '(<span style="color: #a020f0;">if</span> a 1 2) '((a . ())) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (stepper (myeval '(<span style="color: #a020f0;">if</span> a 1 2) '((a . 1)) nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-5" class="outline-3">
<h3 id="sec-9-5">COND</h3>
<div class="outline-text-3" id="text-9-5">
<div class="org-src-container">

<pre class="src src-lisp" id="construct_10">(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">evcond-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  clauses
  env)
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evcond_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evcond</span> (clauses env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null clauses)  (list 'return cont nil))
        (t               (list 'eval (caar clauses) env block-env go-env catch-env errcont
                               (make-evcond-cont
                                <span style="color: #483d8b;">:clauses</span> clauses
                                <span style="color: #483d8b;">:env</span> env
                                <span style="color: #483d8b;">:block-env</span> block-env
                                <span style="color: #483d8b;">:go-env</span> go-env
                                <span style="color: #483d8b;">:catch-env</span> catch-env
                                <span style="color: #483d8b;">:errcont</span> errcont
                                <span style="color: #483d8b;">:cont</span> cont)))))
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evcond_10">((evcond-cont-p cont)   (<span style="color: #a020f0;">if</span> arg
                            (list 'eval (cadar (evcond-cont-clauses cont))
                                  (evcond-cont-env cont)
                                  (evcond-cont-block-env cont)
                                  (evcond-cont-go-env cont)
                                  (evcond-cont-catch-env cont)
                                  (evcond-cont-errcont cont)
                                  (evcond-cont-cont cont))
                            (evcond (cdr (evcond-cont-clauses cont))
                                    (evcond-cont-env cont)
                                    (evcond-cont-block-env cont)
                                    (evcond-cont-go-env cont)
                                    (evcond-cont-catch-env cont)
                                    (evcond-cont-errcont cont)
                                    (evcond-cont-cont cont))))
</pre>
</div>

<p>
Убираем тесты <code>evcond</code>, т.к. теперь мы не можем тестировать без <code>stepper</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_cond_10">((equal (car exp) 'cond)     (evcond (cdr exp) env block-env go-env catch-env errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_cond_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; COND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (stepper (myeval '(<span style="color: #a020f0;">cond</span>
                           (() 1)
                           (1 2))
                         nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (stepper (myeval '(<span style="color: #a020f0;">cond</span>
                           (a 1)
                           (b 2))
                         '((a . ()) (b . 1))
                         nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (stepper (myeval '(<span style="color: #a020f0;">cond</span>
                           (a 1)
                           (b 2))
                         '((a . 1) (b . ()))
                         nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-6" class="outline-3">
<h3 id="sec-9-6">PROGN</h3>
<div class="outline-text-3" id="text-9-6">
<div class="org-src-container">

<pre class="src src-lisp" id="construct_10">(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">evprogn-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  clauses
  env)
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evprogn_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evprogn</span> (lst env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null lst)         (list 'return cont nil))
        ((null (cdr lst))   (list 'eval (car lst) env block-env go-env catch-env errcont cont))
        (t                  (list 'eval (car lst) env block-env go-env catch-env errcont
                                  (make-evprogn-cont
                                   <span style="color: #483d8b;">:clauses</span> lst
                                   <span style="color: #483d8b;">:env</span> env
                                   <span style="color: #483d8b;">:block-env</span> block-env
                                   <span style="color: #483d8b;">:go-env</span> go-env
                                   <span style="color: #483d8b;">:catch-env</span> catch-env
                                   <span style="color: #483d8b;">:errcont</span> errcont
                                   <span style="color: #483d8b;">:cont</span> cont)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evcond_10">((evprogn-cont-p cont)  (evprogn (cdr (evprogn-cont-clauses cont))
                                 (evprogn-cont-env cont)
                                 (evprogn-cont-block-env cont)
                                 (evprogn-cont-go-env cont)
                                 (evprogn-cont-catch-env cont)
                                 (evprogn-cont-errcont cont)
                                 (evprogn-cont-cont cont)))
</pre>
</div>

<p>
Убираем тесты <code>evprogn</code>, т.к. теперь мы не можем тестировать без <code>stepper</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_progn_10">((equal (car exp) 'progn)    (evprogn (cdr exp)
                                      env block-env go-env catch-env
                                      errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_progn_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; PROGN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(<span style="color: #a020f0;">progn</span> 1 2 3) nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; PROGN &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(<span style="color: #a020f0;">progn</span> a b c) '((a . 1) (b . 2) (c . 3))
                         nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-7" class="outline-3">
<h3 id="sec-9-7">AND</h3>
<div class="outline-text-3" id="text-9-7">
<div class="org-src-container">

<pre class="src src-lisp" id="construct_10">(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">and-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  exps
  env)
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evand_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evand</span> (exps env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null exps)       (list 'return cont T))
        ((null (cdr exps)) (list 'eval (car exps) env block-env go-env catch-env errcont cont))
        (t                 (list 'eval (car exps) env block-env go-env catch-env errcont
                                 (make-and-cont
                                  <span style="color: #483d8b;">:exps</span> (cdr exps)
                                  <span style="color: #483d8b;">:env</span> env
                                  <span style="color: #483d8b;">:block-env</span> block-env
                                  <span style="color: #483d8b;">:go-env</span> go-env
                                  <span style="color: #483d8b;">:catch-env</span> catch-env
                                  <span style="color: #483d8b;">:errcont</span> errcont
                                  <span style="color: #483d8b;">:cont</span> cont)))))
</pre>
</div>

<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evand_10">((and-cont-p cont)      (<span style="color: #a020f0;">if</span> (null arg)
                            (list 'return (and-cont-cont cont) nil)
                            (evand (and-cont-exps cont)
                                   (and-cont-env cont)
                                   (and-cont-block-env cont)
                                   (and-cont-go-env cont)
                                   (and-cont-catch-env cont)
                                   (and-cont-errcont cont)
                                   (and-cont-cont cont))))
</pre>
</div>

<p>
Убираем тесты <code>evand</code>, т.к. теперь мы не можем тестировать без <code>stepper</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_and_10">((equal (car exp) 'and)      (evand (cdr exp)
                                    env block-env go-env catch-env
                                    errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_and_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; AND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and)                (stepper (myeval '(and) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1)              (stepper (myeval '(and 1) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and nil)            (stepper (myeval '(and nil) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 nil)          (stepper (myeval '(and 1 nil) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 nil)        (stepper (myeval '(and 1 2 nil) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 3)          (stepper (myeval '(and 1 2 3) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 (and 1 2) 3)  (stepper (myeval '(and 1 (and 1 2) 3) nil nil nil nil
                                            #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 (and 1 nil) 3)  (stepper (myeval '(and 1 (and 1 nil) 3) nil nil nil nil
                                              #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; AND &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a nil))
                 (and nil))
               (stepper (myeval '(and a) '((a . nil)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 1))
                 (and a))
               (stepper (myeval '(and a) '((a . 1)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 1)
                     (b nil))
                 (and a b))
               (stepper (myeval '(and a b) '((a . 1) (b . nil)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 1)
                     (b 2)
                     (c nil))
                 (and a b c))
               (stepper (myeval '(and a b c) '((a . 1) (b . 2) (c . nil)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a b c))
               (stepper (myeval '(and a b c) '((a . 1) (b . 2) (c . 3)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a (and a b) c))
               (stepper (myeval '(and a (and a b) c) '((a . 1) (b . 2) (c . 3)) nil nil nil
                       #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 1)
                     (b nil)
                     (c 3))
                 (and a (and a b) c))
               (stepper (myeval '(and a (and a b) c) '((a . 1) (b . nil) (c . 3)) nil nil nil
                       #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-8" class="outline-3">
<h3 id="sec-9-8">OR</h3>
<div class="outline-text-3" id="text-9-8">
<div class="org-src-container">

<pre class="src src-lisp" id="construct_10">(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">or-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  exps
  env)
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evor_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evor</span> (exps env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null exps)       (list 'return cont nil))
        ((null (cdr exps)) (list 'eval (car exps) env block-env go-env catch-env errcont cont))
        (t                 (list 'eval (car exps) env block-env go-env catch-env errcont
                                 (make-or-cont
                                  <span style="color: #483d8b;">:exps</span> (cdr exps)
                                  <span style="color: #483d8b;">:env</span> env
                                  <span style="color: #483d8b;">:block-env</span> block-env
                                  <span style="color: #483d8b;">:go-env</span> go-env
                                  <span style="color: #483d8b;">:catch-env</span> catch-env
                                  <span style="color: #483d8b;">:errcont</span> errcont
                                  <span style="color: #483d8b;">:cont</span> cont)))))
</pre>
</div>

<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evor_10">((or-cont-p cont)       (<span style="color: #a020f0;">if</span> (not (null arg))
                            (list 'return (or-cont-cont cont) arg)
                            (evor (or-cont-exps cont)
                                  (or-cont-env cont)
                                  (or-cont-block-env cont)
                                  (or-cont-go-env cont)
                                  (or-cont-catch-env cont)
                                  (or-cont-errcont cont)
                                  (or-cont-cont cont))))
</pre>
</div>

<p>
Убираем тесты <code>evor</code>, т.к. теперь мы не можем тестировать без <code>stepper</code>
</p>

<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_or_10">((equal (car exp) 'or)       (evor  (cdr exp)
                                    env block-env go-env catch-env
                                    errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_or_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; OR</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or)                  (stepper (myeval '(or) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1)            (stepper (myeval '(or nil 1) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil nil 1)        (stepper (myeval '(or nil nil 1) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1 2)          (stepper (myeval '(or nil 1 2) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil (or 3 2) 2)   (stepper (myeval '(or nil (or 3 2) 2) nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; OR &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a nil))
                 (or a))
               (stepper (myeval '(or a) '((a . nil)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 1))
                 (or a))
               (stepper (myeval '(or a) '((a . 1)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a nil)
                     (b 1))
                 (or a b))
               (stepper (myeval '(or a b) '((a . nil) (b . 1)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a nil)
                     (b nil)
                     (c 3))
                 (or a b c))
               (stepper (myeval '(or a b c) '((a . nil) (b . nil) (c . 3)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a nil)
                     (b 1)
                     (c 2))
                 (or a b c))
               (stepper (myeval '(or a b c) '((a . nil) (b . 1) (c . 2)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a nil)
                     (b nil)
                     (c nil)
                     (d 2))
                 (or a (or b c) d))
               (stepper (myeval '(or  a (or b c) d) '((a . nil) (b . nil) (c . nil) (d . 2))
                       nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-9" class="outline-3">
<h3 id="sec-9-9">LET</h3>
<div class="outline-text-3" id="text-9-9">
<div class="org-src-container">

<pre class="src src-lisp" id="errors_10">(<span style="color: #a020f0;">define-condition</span> <span style="color: #0000ff;">mypairlis-error</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((lst1 <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:lst1</span>  <span style="color: #483d8b;">:reader</span> lst1)
   (lst2 <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:lst2</span>  <span style="color: #483d8b;">:reader</span> lst2))
  (<span style="color: #483d8b;">:report</span>
   (<span style="color: #a020f0;">lambda</span> (condition stream)
     (format stream <span style="color: #8b2252;">"Error in MYPAIRLIS: wrong params:~%'~A~%'~A"</span>
             (lst1 condition) (lst2 condition)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_mypairlis_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">mypairlis</span> (lst1 lst2 alist)
  (<span style="color: #a020f0;">cond</span> ((and (null lst1) (null lst2))  alist)
        ((or  (null lst1) (null lst2))  (<span style="color: #ff0000; font-weight: bold;">error</span> 'mypairlis-error <span style="color: #483d8b;">:lst1</span> lst1 <span style="color: #483d8b;">:lst2</span> lst2))
        (t                              (cons (cons (car lst1)
                                                    (car lst2))
                                              (mypairlis (cdr lst1)
                                                         (cdr lst2)
                                                         alist)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_mypairlis_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; MYPAIRLIS</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(( a . 1) (b . 2) ( c . 3) (z . 6) (y . 77))
               (mypairlis '(a b c) '(1 2 3) '((z . 6) (y . 77)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"error"</span>
               (<span style="color: #a020f0;">handler-case</span> (mypairlis '(a b c) nil '((z . 6) (y . 77)))
                 (MYPAIRLIS-ERROR (condition) <span style="color: #8b2252;">"error"</span>))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"error"</span>
               (<span style="color: #a020f0;">handler-case</span> (mypairlis nil '(1 2 3) '((z . 6) (y . 77)))
                 (MYPAIRLIS-ERROR (condition) <span style="color: #8b2252;">"error"</span>))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_10">(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">evlet-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  vars
  exps
  evald-exps
  exp
  env)
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evlet_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evlet</span> (vars exps evald-exps exp env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null exps)  (evprogn exp
                               (pairlis vars (reverse evald-exps) env)
                               block-env go-env catch-env
                               errcont cont))
        (t            (list 'eval (car exps) env block-env go-env catch-env errcont
                            (make-evlet-cont
                             <span style="color: #483d8b;">:vars</span> vars
                             <span style="color: #483d8b;">:exps</span> exps
                             <span style="color: #483d8b;">:evald-exps</span> evald-exps
                             <span style="color: #483d8b;">:exp</span> exp
                             <span style="color: #483d8b;">:env</span> env
                             <span style="color: #483d8b;">:block-env</span> block-env
                             <span style="color: #483d8b;">:go-env</span> go-env
                             <span style="color: #483d8b;">:catch-env</span> catch-env
                             <span style="color: #483d8b;">:errcont</span> errcont
                             <span style="color: #483d8b;">:cont</span> cont)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evlet_10">((evlet-cont-p cont)    (evlet (evlet-cont-vars cont)
                               (cdr (evlet-cont-exps cont))
                               (cons arg (evlet-cont-evald-exps cont))
                               (evlet-cont-exp cont)
                               (evlet-cont-env cont)
                               (evlet-cont-block-env cont)
                               (evlet-cont-go-env cont)
                               (evlet-cont-catch-env cont)
                               (evlet-cont-errcont cont)
                               (evlet-cont-cont cont)))
</pre>
</div>

<p>
Убираем тесты <code>evlet</code>, т.к. теперь мы не можем тестировать без <code>stepper</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_let_10">((equal (car exp) 'let)      (evlet (mapcar #'car (cadr exp))
                                    (mapcar #'cadr (cadr exp))
                                    nil
                                    (cddr exp)
                                    env block-env go-env catch-env
                                    errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_let_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LET</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (stepper (myeval '(<span style="color: #a020f0;">let</span> ((a 1)
                                                (b 2))
                                           (cons a b))
                                         nil nil nil nil
                                         #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-10" class="outline-3">
<h3 id="sec-9-10">LET*</h3>
<div class="outline-text-3" id="text-9-10">
<div class="org-src-container">

<pre class="src src-lisp" id="construct_10">(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">evletstar-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  varpairs
  exp
  env)
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evletstar_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evletstar</span> (varpairs exp env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null varpairs)  (evprogn exp env block-env go-env catch-env errcont cont))
        (t                (list 'eval (cadar varpairs) env block-env go-env catch-env errcont
                                (make-evletstar-cont
                                 <span style="color: #483d8b;">:varpairs</span> varpairs
                                 <span style="color: #483d8b;">:exp</span> exp
                                 <span style="color: #483d8b;">:env</span> env
                                 <span style="color: #483d8b;">:block-env</span> block-env
                                 <span style="color: #483d8b;">:go-env</span> go-env
                                 <span style="color: #483d8b;">:catch-env</span> catch-env
                                 <span style="color: #483d8b;">:errcont</span> errcont
                                 <span style="color: #483d8b;">:cont</span> cont)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evletstar_10">((evletstar-cont-p cont) (evletstar (cdr (evletstar-cont-varpairs cont))
                                    (evletstar-cont-exp cont)
                                    (acons (caar (evletstar-cont-varpairs cont))
                                           arg
                                           (evletstar-cont-env cont))
                                    (evletstar-cont-block-env cont)
                                    (evletstar-cont-go-env cont)
                                    (evletstar-cont-catch-env cont)
                                    (evletstar-cont-errcont cont)
                                    (evletstar-cont-cont cont)))
</pre>
</div>

<p>
Убираем тесты <code>evletstar</code>, т.к. теперь мы не можем тестировать без <code>stepper</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_letstar_10">((equal (car exp) 'let*)     (evletstar (cadr exp)
                                        (cddr exp)
                                        env block-env go-env catch-env
                                        errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_letstar_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LET*</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 1 . 2) (stepper (myeval '(<span style="color: #a020f0;">let*</span> ((a 1)
                                                   (b 2)
                                                   (c (+ a b)))
                                             (cons c (cons a b)))
                                           nil nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-11" class="outline-3">
<h3 id="sec-9-11">DEFUN</h3>
<div class="outline-text-3" id="text-9-11">
<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_defun_10">((equal (car exp) 'defun)         (<span style="color: #a020f0;">progn</span>
                                    (push (cons (cadr exp)
                                                (make-closure <span style="color: #483d8b;">:body</span> (cdddr exp)
                                                              <span style="color: #483d8b;">:block-env</span> block-env
                                                              <span style="color: #483d8b;">:env</span> env
                                                              <span style="color: #483d8b;">:go-env</span> go-env
                                                              <span style="color: #483d8b;">:args</span> (caddr exp)))
                                          *glob-env*)
                                    (list 'return cont (cadr exp))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_defun_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; DEFUN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 64 (<span style="color: #a020f0;">progn</span>
                    (setf *glob-env* nil)
                    (stepper (myeval '(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">alfa</span> (x) (* x x)) nil nil nil nil #'err #'ok))
                    (<span style="color: #a020f0;">prog1</span> (stepper (myeval '(alfa 8) nil nil nil nil #'err #'ok))
                      (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1085;&#1072; IMPLICIT-PROGN &#1074; DEFUN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 384 (<span style="color: #a020f0;">progn</span>
                     (setf *glob-env* nil)
                     (stepper (myeval '(<span style="color: #a020f0;">let</span> ((y 3))
                               (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">alfa</span> (x)
                                 (setq y 6)
                                 (* x x y)))
                             nil nil nil nil #'err #'ok))
                     (<span style="color: #a020f0;">prog1</span> (stepper (myeval '(alfa 8) nil nil nil nil #'err #'ok))
                       (setf *glob-env* nil)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-12" class="outline-3">
<h3 id="sec-9-12">SETQ</h3>
<div class="outline-text-3" id="text-9-12">
<div class="org-src-container">

<pre class="src src-lisp" id="construct_10">(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">setq-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  clauses
  env)
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_setq_10">((equal (car exp) 'setq)     (list 'eval (caddr exp) env block-env go-env catch-env errcont
                                     (make-setq-cont
                                      <span style="color: #483d8b;">:clauses</span> exp
                                      <span style="color: #483d8b;">:env</span> env
                                      <span style="color: #483d8b;">:block-env</span> block-env
                                      <span style="color: #483d8b;">:go-env</span> go-env
                                      <span style="color: #483d8b;">:catch-env</span> catch-env
                                      <span style="color: #483d8b;">:errcont</span> errcont
                                      <span style="color: #483d8b;">:cont</span> cont)))
</pre>
</div>

<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_setq_10">((setq-cont-p cont)     (<span style="color: #a020f0;">progn</span>
                          (<span style="color: #a020f0;">if</span> (null (assoc (cadr (setq-cont-clauses cont))
                                           (setq-cont-env cont)))
                              <span style="color: #b22222;">;; </span><span style="color: #b22222;">if-null</span>
                              (<span style="color: #a020f0;">if</span> (null (assoc (cadr (setq-cont-clauses cont))
                                               *glob-env*))
                                  <span style="color: #b22222;">;; </span><span style="color: #b22222;">then</span>
                                  (push (cons (cadr (setq-cont-clauses cont))
                                              arg)
                                        *glob-env*)
                                  <span style="color: #b22222;">;; </span><span style="color: #b22222;">else</span>
                                  (rplacd (assoc (cadr (setq-cont-clauses cont))
                                                 *glob-env*)
                                          arg))
                              <span style="color: #b22222;">;; </span><span style="color: #b22222;">if-not-null</span>
                              (rplacd (assoc (cadr (setq-cont-clauses cont))
                                             (setq-cont-env cont))
                                      arg))
                          (list 'return (setq-cont-cont cont) arg)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_setq_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; SETQ</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1082;&#1072; &#1080;&#1079;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1103; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; &#1083;&#1086;&#1082;&#1072;&#1083;&#1100;&#1085;&#1086;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;, &#1085;&#1077; &#1079;&#1072;&#1090;&#1088;&#1072;&#1075;&#1080;&#1074;&#1072;&#1103; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1086;&#1075;&#1086; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((2 . 2) ((alfa . 0)))
               (<span style="color: #a020f0;">progn</span>
                 (setf *glob-env* '((alfa . 0)))
                 (<span style="color: #a020f0;">prog1</span> (list (stepper (myeval '(cons (setq alfa 2)
                                        alfa)
                                      '((alfa . 1))
                                      nil nil nil #'err #'ok))
                              *glob-env*)
                   (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1048;&#1079;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; &#1085;&#1077;&#1089;&#1091;&#1097;&#1077;&#1089;&#1090;&#1074;&#1091;&#1102;&#1097;&#1077;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081; (&#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1080;&#1077; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1086;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;)</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 1) ((ALFA . 1) (BETA . 222)))
               (<span style="color: #a020f0;">progn</span>
                 (setf *glob-env* '((beta . 222)))
                 (<span style="color: #a020f0;">prog1</span> (list (stepper (myeval '(cons
                                        (setq alfa 1)
                                        alfa)
                                      nil nil nil nil #'err #'ok))
                              *glob-env*)
                   (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1048;&#1079;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; &#1089;&#1091;&#1097;&#1077;&#1089;&#1090;&#1074;&#1091;&#1102;&#1097;&#1077;&#1081; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1086;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 1) ((BETA . 1)))
               (<span style="color: #a020f0;">progn</span>
                 (setf *glob-env* '((beta . 222)))
                 (<span style="color: #a020f0;">prog1</span> (list (stepper (myeval '(cons
                                        (setq beta 1)
                                        beta)
                                      nil nil nil nil #'err #'ok))
                              *glob-env*)
                   (setf *glob-env* nil)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-13" class="outline-3">
<h3 id="sec-9-13">LAMBDA</h3>
<div class="outline-text-3" id="text-9-13">
<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_lambda_10"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1089;&#1090;&#1072;&#1083;&#1086;</span>
((equal (car exp) 'lambda)   (list 'return cont (make-closure <span style="color: #483d8b;">:body</span> (cddr exp)
                                                              <span style="color: #483d8b;">:block-env</span> block-env
                                                              <span style="color: #483d8b;">:env</span> env
                                                              <span style="color: #483d8b;">:go-env</span> go-env
                                                              <span style="color: #483d8b;">:args</span> (cadr exp))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_lambda_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LAMBDA</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '((<span style="color: #a020f0;">lambda</span> (x) (+ 1  x)) 2)
                         nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LAMBDA &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 5 (stepper (myeval '(<span style="color: #a020f0;">let</span> ((y 3))
                           ((<span style="color: #a020f0;">lambda</span> (x) (+ y x)) 2))
                         nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1085;&#1072; IMPLICIT-PROGN &#1074; LAMBDA</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 8 (stepper (myeval '(<span style="color: #a020f0;">let</span> ((y 3))
                           ((<span style="color: #a020f0;">lambda</span> (x)
                              (setq y 6)
                              (+ y x)) 2))
                         nil nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-14" class="outline-3">
<h3 id="sec-9-14">BLOCK</h3>
<div class="outline-text-3" id="text-9-14">
<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_block_10"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1089;&#1090;&#1072;&#1083;&#1086;</span>
((equal (car exp) 'block)    (list 'eval (caddr exp)
                                   env
                                   (acons (cadr exp)
                                          cont
                                          block-env)
                                   go-env catch-env errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_block_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; BLOCK</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (stepper (myeval '(<span style="color: #a020f0;">block</span> testblock)
                           nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(<span style="color: #a020f0;">block</span> testblock 3)
                         nil nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-15" class="outline-3">
<h3 id="sec-9-15">RETURN-FROM</h3>
<div class="outline-text-3" id="text-9-15">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_is_cont_subset_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">is-cont-subset</span> (target-cont cont)
  (<span style="color: #a020f0;">cond</span> ((equal target-cont cont) t)    <span style="color: #b22222;">;; </span><span style="color: #b22222;">positive</span>
        ((functionp cont) nil)          <span style="color: #b22222;">;; </span><span style="color: #b22222;">negative</span>
        (t (is-cont-subset target-cont (cdr cont)))))
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_return_from_10">((equal (car exp) 'return-from)
                             (<span style="color: #a020f0;">if</span> (not (symbolp (cadr exp)))
                                 (list 'return
                                       errcont
                                       (format
                                        nil
                                        <span style="color: #8b2252;">"return-from: first argument not a symbol"</span>))
                                 (list 'eval (caddr exp) env block-env go-env catch-env errcont
                                       (<span style="color: #a020f0;">lambda</span> (x)
                                         (assoc-2 (cadr exp) block-env
                                                  (<span style="color: #a020f0;">lambda</span> (y)
                                                    (<span style="color: #a020f0;">if</span> (is-cont-subset y cont)
                                                        (list 'return y x)
                                                        (list 'return
                                                         errcont
                                                         (format nil <span style="color: #8b2252;">"return-from: attempt to RETURN-FROM to ~A that no longer exists"</span> (cadr exp)))))
                                                  (<span style="color: #a020f0;">lambda</span> (y)
                                                    (list 'return
                                                     errcont (format nil <span style="color: #8b2252;">"return-from: undefined return block ~A"</span> y))))))))
</pre>
</div>

<p>
Слегка модифицируем тесты на ошибку
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_return_from_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; RETURN-FROM</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(<span style="color: #a020f0;">block</span> testblock (<span style="color: #a020f0;">return-from</span> testblock (+ 1 2)) 777)
                                  nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal  <span style="color: #8b2252;">"return-from: undefined return block NOTBLOCK"</span>
                (stepper (myeval '(<span style="color: #a020f0;">block</span> testblock (<span style="color: #a020f0;">return-from</span> notblock (+ 1 2)) 777)
                                 nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"return-from: undefined return block NOT-FOUND-BLOCK"</span>
               (stepper (myeval '(<span style="color: #a020f0;">progn</span> (<span style="color: #a020f0;">return-from</span> not-found-block (+ 1 2)) 777)
                                nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; RETURN-FROM &#1074; &#1083;&#1077;&#1082;&#1089;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 12 (<span style="color: #a020f0;">progn</span>
                    (setf *glob-env* nil)
                    (<span style="color: #a020f0;">prog1</span> (stepper (myeval '(<span style="color: #a020f0;">progn</span>
                                              (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                                (<span style="color: #a020f0;">block</span> in-lambda-block
                                                  (<span style="color: #a020f0;">return-from</span> in-lambda-block
                                                    (+ x 2))
                                                  777))
                                              (foo 10))
                                            nil nil nil nil #'err #'ok))
                      (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; RETURN-FROM &#1074; &#1076;&#1080;&#1085;&#1072;&#1084;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080; (&#1076;&#1086;&#1083;&#1078;&#1085;&#1072; &#1073;&#1099;&#1090;&#1100; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072;)</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"return-from: undefined return block IN-LAMBDA-BLOCK"</span>
               (<span style="color: #a020f0;">progn</span>
                 (setf *glob-env* nil)
                 (<span style="color: #a020f0;">prog1</span> (stepper (myeval '(<span style="color: #a020f0;">progn</span>
                                           (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                             (<span style="color: #a020f0;">return-from</span> in-lambda-block
                                               (+ x 2))
                                             777)
                                           (<span style="color: #a020f0;">block</span> in-lambda-block
                                             (foo 10)))
                                         nil nil nil nil #'err #'ok))
                   (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; &#1085;&#1072; &#1086;&#1096;&#1080;&#1073;&#1082;&#1091; &#1085;&#1077;&#1076;&#1086;&#1089;&#1090;&#1080;&#1078;&#1080;&#1084;&#1086;&#1075;&#1086; &#1073;&#1083;&#1086;&#1082;&#1072;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"return-from: attempt to RETURN-FROM to THE-BLOCK that no longer exists"</span>
               (stepper (myeval '((<span style="color: #a020f0;">block</span> the-block (<span style="color: #a020f0;">lambda</span> () (<span style="color: #a020f0;">return-from</span> the-block nil))))
                                nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; &#1085;&#1072; &#1086;&#1090;&#1089;&#1091;&#1090;&#1089;&#1090;&#1074;&#1080;&#1077; &#1086;&#1096;&#1080;&#1073;&#1082;&#1080; &#1087;&#1088;&#1080; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1077; &#1074; &#1076;&#1086;&#1089;&#1090;&#1080;&#1078;&#1080;&#1084;&#1099;&#1081; &#1073;&#1083;&#1086;&#1082;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 123 (stepper (myeval '(<span style="color: #a020f0;">block</span> the-block (<span style="color: #a020f0;">return-from</span> the-block 123))
                           nil nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-16" class="outline-3">
<h3 id="sec-9-16">CATCH</h3>
<div class="outline-text-3" id="text-9-16">
<div class="org-src-container">

<pre class="src src-lisp" id="construct_10">(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">catch-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  clauses
  env)
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_catch_10">((equal (car exp) 'catch)    (list 'eval (cadr exp) env block-env go-env catch-env errcont
                                   (make-catch-cont
                                    <span style="color: #483d8b;">:clauses</span> exp
                                    <span style="color: #483d8b;">:env</span> env
                                    <span style="color: #483d8b;">:block-env</span> block-env
                                    <span style="color: #483d8b;">:go-env</span> go-env
                                    <span style="color: #483d8b;">:catch-env</span> catch-env
                                    <span style="color: #483d8b;">:errcont</span> errcont
                                    <span style="color: #483d8b;">:cont</span> cont)))
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_catch_10">((catch-cont-p cont)    (<span style="color: #a020f0;">if</span> (not (symbolp arg))
                            (list 'return
                                  errcont
                                  (format nil <span style="color: #8b2252;">"catch: first argument not a symbol"</span>))
                            (list 'eval (caddr (catch-cont-clauses cont))
                                  (catch-cont-env cont)
                                  (catch-cont-block-env cont)
                                  (catch-cont-go-env cont)
                                  (acons arg
                                         (catch-cont-cont cont)
                                         (catch-cont-catch-env cont))
                                  (catch-cont-errcont cont)
                                  (catch-cont-cont cont))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_catch_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; CATCH</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (stepper (myeval '(<span style="color: #a020f0;">catch</span> '<span style="color: #008b8b;">zzz</span>)
                           nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(<span style="color: #a020f0;">catch</span> '<span style="color: #008b8b;">zzz</span> 3)
                         nil nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-17" class="outline-3">
<h3 id="sec-9-17">THROW</h3>
<div class="outline-text-3" id="text-9-17">
<div class="org-src-container">

<pre class="src src-lisp" id="construct_10">(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">throw-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  clauses
  env)
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evthrow_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evthrow</span> (exp env block-env go-env catch-env errcont cont)
  (list 'eval (cadr exp) env block-env go-env catch-env errcont
        (make-throw-cont
         <span style="color: #483d8b;">:clauses</span> exp
         <span style="color: #483d8b;">:env</span> env
         <span style="color: #483d8b;">:block-env</span> block-env
         <span style="color: #483d8b;">:go-env</span> go-env
         <span style="color: #483d8b;">:catch-env</span> catch-env
         <span style="color: #483d8b;">:errcont</span> errcont
         <span style="color: #483d8b;">:cont</span> cont)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_throw_10">((equal (car exp) 'throw)    (evthrow exp
                                      env block-env go-env catch-env
                                      errcont cont))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_10">(<span style="color: #a020f0;">defstruct</span> <span style="color: #228b22;">throw2-cont</span>
  prev-arg
  catch-env
  errcont)
</pre>
</div>

<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_throw2_10">((throw2-cont-p cont)   (assoc-2 (throw2-cont-prev-arg cont)
                                 (throw2-cont-catch-env cont)
                                 (<span style="color: #a020f0;">lambda</span> (cont-res)
                                   (list 'return cont-res arg))
                                 (<span style="color: #a020f0;">lambda</span> (key)
                                   (list 'return (throw2-cont-errcont cont)
                                            (format
                                             nil
                                             <span style="color: #8b2252;">"throw: matching ~A catch is not found"</span>
                                             key)))))
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_throw_10">((throw-cont-p cont)    (list 'eval (caddr (throw-cont-clauses cont))
                              (throw-cont-env cont)
                              (throw-cont-block-env cont)
                              (throw-cont-go-env cont)
                              (throw-cont-catch-env cont)
                              (throw-cont-errcont cont)
                              (make-throw2-cont
                               <span style="color: #483d8b;">:prev-arg</span> arg
                               <span style="color: #483d8b;">:catch-env</span> (throw-cont-catch-env cont)
                               <span style="color: #483d8b;">:errcont</span> (throw-cont-errcont cont))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_throw_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; THROW</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(<span style="color: #a020f0;">catch</span> '<span style="color: #008b8b;">testcatch</span> (<span style="color: #a020f0;">throw</span> '<span style="color: #008b8b;">testcatch</span> (+ 1 2)) 777)
                         nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"throw: matching NOTCATCH catch is not found"</span>
               (stepper (myeval '(<span style="color: #a020f0;">catch</span> '<span style="color: #008b8b;">testcatch</span> (<span style="color: #a020f0;">throw</span> '<span style="color: #008b8b;">notcatch</span> (+ 1 2)) 777)
                                nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"throw: matching NOT-FOUND-CATCH catch is not found"</span>
               (stepper (myeval '(<span style="color: #a020f0;">progn</span> (<span style="color: #a020f0;">throw</span> '<span style="color: #008b8b;">not-found-catch</span> (+ 1 2)) 777)
                                nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; THROW &#1074; &#1083;&#1077;&#1082;&#1089;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 12 (<span style="color: #a020f0;">progn</span>
                    (setf *glob-env* nil)
                    (<span style="color: #a020f0;">prog1</span> (stepper (myeval '(<span style="color: #a020f0;">progn</span>
                                              (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                                (<span style="color: #a020f0;">catch</span> '<span style="color: #008b8b;">in-lambda-catch</span>
                                                  (<span style="color: #a020f0;">throw</span> '<span style="color: #008b8b;">in-lambda-catch</span>
                                                    (+ x 2))
                                                  777))
                                              (foo 10))
                                            nil nil nil nil #'err #'ok))
                      (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; THROW &#1074; &#1076;&#1080;&#1085;&#1072;&#1084;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080; (&#1076;&#1086;&#1083;&#1078;&#1085;&#1086; &#1089;&#1088;&#1072;&#1073;&#1086;&#1090;&#1072;&#1090;&#1100;)</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 12 (<span style="color: #a020f0;">progn</span>
                    (setf *glob-env* nil)
                    (<span style="color: #a020f0;">prog1</span> (stepper (myeval '(<span style="color: #a020f0;">progn</span>
                                              (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                                (<span style="color: #a020f0;">throw</span> '<span style="color: #008b8b;">in-lambda-catch</span>
                                                  (+ x 2))
                                                777)
                                              (<span style="color: #a020f0;">catch</span> '<span style="color: #008b8b;">in-lambda-catch</span>
                                                (foo 10)))
                                            nil nil nil nil #'err #'ok))
                      (setf *glob-env* nil)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-18" class="outline-3">
<h3 id="sec-9-18">TAGBODY</h3>
<div class="outline-text-3" id="text-9-18">
<div class="org-src-container">

<pre class="src src-lisp" id="tagbody_slice_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">tagbody-slice</span> (exp res)
  (<span style="color: #a020f0;">cond</span> ((null exp) res)
        ((symbolp (car exp))  (tagbody-slice (cdr exp) (cons exp res)))
        (t                    (tagbody-slice (cdr exp) res))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="tagbody_check_tag_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">tagbody-check-tag</span> (exp cont errcont)
  (<span style="color: #a020f0;">cond</span> ((null exp) (funcall cont))
        ((and (symbolp (car exp))
              (member (car exp) (cdr exp)))
         (funcall errcont (car exp)))
        (t (tagbody-check-tag (cdr exp) cont errcont))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_10">(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">evtagbody-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  body
  env)
</pre>
</div>

<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа
<code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evtagbody_10">&lt;&lt;tagbody_check_tag_10&gt;&gt;
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evtagbody</span> (body env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null (car body))      (list 'return cont nil))
        ((symbolp (car body))   (evtagbody (cdr body) env block-env go-env catch-env errcont cont))
        (t                      (list 'eval (car body) env block-env go-env catch-env errcont
                                      (make-evtagbody-cont
                                       <span style="color: #483d8b;">:body</span> (cdr body)
                                       <span style="color: #483d8b;">:env</span>  env
                                       <span style="color: #483d8b;">:block-env</span> block-env
                                       <span style="color: #483d8b;">:go-env</span> go-env
                                       <span style="color: #483d8b;">:catch-env</span> catch-env
                                       <span style="color: #483d8b;">:errcont</span> errcont
                                       <span style="color: #483d8b;">:cont</span> cont)))))
&lt;&lt;tagbody_slice_10&gt;&gt;
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_tagbody_10">((equal (car exp) 'tagbody)  (tagbody-check-tag
                              (cdr exp)
                              (<span style="color: #a020f0;">lambda</span> ()
                                (evtagbody (cdr exp) env block-env
                                           (make-go-env (cdr exp)
                                                        env block-env go-env catch-env
                                                        errcont cont)
                                           catch-env errcont cont))
                              (<span style="color: #a020f0;">lambda</span> (x)
                                (list 'return
                                 errcont
                                 (format
                                  nil
                                  <span style="color: #8b2252;">"tagbody: The tag ~A appears more than once in a tagbody"</span>
                                  x)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="apply_cont_evtagbody_10">((evtagbody-cont-p cont) (evtagbody (evtagbody-cont-body cont)
                                    (evtagbody-cont-env cont)
                                    (unicont-block-env cont)
                                    (unicont-go-env cont)
                                    (unicont-catch-env cont)
                                    (unicont-errcont cont)
                                    (unicont-cont cont)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_tagbody_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; TAGBODY</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (stepper (myeval '(<span style="color: #a020f0;">tagbody</span> a 1)
                           nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (stepper (myeval '(<span style="color: #a020f0;">tagbody</span> a 1 b 2)
                           nil nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-19" class="outline-3">
<h3 id="sec-9-19">GO</h3>
<div class="outline-text-3" id="text-9-19">
<p>
Перемещаем все связанное с <code>go-cont</code> сюда из предыдущего раздела
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="construct_10">(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">go-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  slice
  env)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_make_goenv_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">make-go-env</span> (tagbody-body env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">let*</span> ((conts (mapcar #'(<span style="color: #a020f0;">lambda</span> (x) <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1087;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1077;&#1085;&#1080;&#1103;, &#1085;&#1072;&#1088;&#1077;&#1079;&#1072;&#1085;&#1085;&#1099;&#1077; &#1080;&#1079; tagbody</span>
                            (make-go-cont
                             <span style="color: #483d8b;">:slice</span> x
                             <span style="color: #483d8b;">:env</span> env
                             <span style="color: #483d8b;">:block-env</span> block-env
                             <span style="color: #483d8b;">:go-env</span> go-env <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1101;&#1090;&#1086;&#1090; &#1089;&#1083;&#1086;&#1090; &#1073;&#1091;&#1076;&#1077;&#1084; setf-&#1101;&#1092;&#1080;&#1090;&#1100;</span>
                             <span style="color: #483d8b;">:catch-env</span>  catch-env
                             <span style="color: #483d8b;">:errcont</span> errcont
                             <span style="color: #483d8b;">:cont</span> cont))
                        (tagbody-slice tagbody-body nil)))
         <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1087;&#1072;&#1088;&#1099; (&#1089;&#1080;&#1084;&#1074;&#1086;&#1083; . &#1087;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1077;&#1085;&#1080;&#1077;) &#1085;&#1072;&#1088;&#1077;&#1079;&#1072;&#1085;&#1085;&#1099;&#1077; &#1080;&#1079;</span>
         <span style="color: #b22222;">;; </span><span style="color: #b22222;">tagbody &#1080; &#1076;&#1086;&#1073;&#1072;&#1074;&#1083;&#1077;&#1085;&#1085;&#1099;&#1077; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
         (new-go-env (append (mapcar #'(<span style="color: #a020f0;">lambda</span> (go-cont)
                                         (cons (car (go-cont-slice go-cont))
                                               go-cont))
                                     conts)
                             go-env)))
    <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1080;&#1079;&#1084;&#1077;&#1085;&#1103;&#1077;&#1084; &#1087;&#1086;&#1083;&#1103; go-env, &#1079;&#1072;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1103; &#1074; &#1085;&#1080;&#1093; new-go-env</span>
    <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1074;&#1086; &#1074;&#1089;&#1077;&#1093; &#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1087;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1077;&#1085;&#1080;&#1103;&#1093;</span>
    (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> elt-cont <span style="color: #483d8b;">:in</span> conts <span style="color: #483d8b;">:do</span>
       (setf (go-cont-go-env elt-cont)
             new-go-env))
    <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084; &#1085;&#1086;&#1074;&#1086;&#1077; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
    new-go-env))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_apply_go_continuation_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">apply-go-continuation</span> (go-cont)
  (evtagbody (go-cont-slice go-cont)
             (go-cont-env go-cont)
             (go-cont-block-env go-cont)
             (go-cont-go-env go-cont)
             (go-cont-catch-env go-cont)
             (go-cont-errcont go-cont)
             (go-cont-cont go-cont)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_go_10">((equal (car exp) 'go)       (assoc-2 (cadr exp) go-env
                                      (<span style="color: #a020f0;">lambda</span> (go-cont)
                                        (apply-go-continuation go-cont))
                                      (<span style="color: #a020f0;">lambda</span> (go-label)
                                        (apply-continuation
                                         errcont
                                         (format nil <span style="color: #8b2252;">"go: wrong target ~A"</span> go-label)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_go_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; GO</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 4) (stepper (myeval '(<span style="color: #a020f0;">let</span> ((alfa 0))
                                  (<span style="color: #a020f0;">tagbody</span>
                                   a (setq alfa 1)
                                   b (<span style="color: #a020f0;">go</span> d)
                                   c (setq alfa (cons alfa 3))
                                   d (setq alfa (cons alfa 4)))
                                  alfa)
                                nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; "&#1086;&#1073;&#1088;&#1072;&#1090;&#1085;&#1086;&#1075;&#1086; &#1093;&#1086;&#1076;&#1072;" GO</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 5) (stepper (myeval '(<span style="color: #a020f0;">let</span> ((alfa 0))
                                  (<span style="color: #a020f0;">tagbody</span>
                                   a (<span style="color: #a020f0;">go</span> d)
                                   b (setq alfa 1)
                                   c (<span style="color: #a020f0;">go</span> e)
                                   d (<span style="color: #a020f0;">go</span> b)
                                   e (setq alfa (cons alfa 5)))
                                  alfa)
                                nil nil nil nil #'err #'ok))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-20" class="outline-3">
<h3 id="sec-9-20">LABELS</h3>
<div class="outline-text-3" id="text-9-20">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_labels_10">((equal (car exp) 'labels)   (<span style="color: #a020f0;">let*</span> ((alist (mapcar (<span style="color: #a020f0;">lambda</span> (label) <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1092;&#1086;&#1088;&#1084;&#1080;&#1088;&#1091;&#1077;&#1084; &#1089;&#1087;&#1080;&#1089;&#1086;&#1082; &#1087;&#1072;&#1088; (&#1080;&#1084;&#1103; . nil)</span>
                                                     (cons (car label) nil))
                                                   (cadr exp)))
                                    (new-env (append alist env))   <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1076;&#1086;&#1073;&#1072;&#1074;&#1080;&#1084; &#1082; &#1089;&#1087;&#1080;&#1089;&#1082;&#1091; &#1087;&#1072;&#1088; &#1087;&#1088;&#1077;&#1076;&#1099;&#1076;&#1091;&#1097;&#1077;&#1077; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
                                    (closures (mapcar (<span style="color: #a020f0;">lambda</span> (label)
                                                        <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1089;&#1086;&#1079;&#1076;&#1072;&#1077;&#1084; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1077;, &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1102;&#1097;&#1077;&#1077; (env) &#1085;&#1072; &#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1085;&#1099;&#1077; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1099;&#1077; (&#1089;&#1086;&#1076;&#1077;&#1088;&#1078;&#1072;&#1097;&#1080;&#1077; &#1087;&#1086;&#1082;&#1072; nil)</span>
                                                        (make-closure <span style="color: #483d8b;">:body</span> (cddr label) <span style="color: #b22222;">;; </span><span style="color: #b22222;">implicit progn</span>
                                                                      <span style="color: #483d8b;">:block-env</span> block-env
                                                                      <span style="color: #483d8b;">:env</span> new-env
                                                                      <span style="color: #483d8b;">:go-env</span> go-env
                                                                      <span style="color: #483d8b;">:args</span> (cadr label)))
                                                      (cadr exp))))
                               <span style="color: #b22222;">;; </span><span style="color: #b22222;">alist:    '((zzz . nil) (xxx . nil))</span>
                               <span style="color: #b22222;">;; </span><span style="color: #b22222;">new-env:  '((zzz . nil) (xxx . nil) (old . #:closure))</span>
                               <span style="color: #b22222;">;; </span><span style="color: #b22222;">closures: '(#:closure #:closure) ;; &#1091; &#1101;&#1090;&#1080;&#1093; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1081; :env &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; new-env</span>
                               (<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (length alist) (length closures)))
                               (<span style="color: #a020f0;">loop</span>
                                  <span style="color: #483d8b;">:for</span> aelt     <span style="color: #483d8b;">:in</span> alist
                                  <span style="color: #483d8b;">:for</span> closure  <span style="color: #483d8b;">:in</span> closures
                                  <span style="color: #483d8b;">:do</span> (rplacd aelt closure))
                               <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1087;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084;:</span>
                               <span style="color: #b22222;">;; </span><span style="color: #b22222;">alist:    '((zzz . #:closure) (xxx . #:closure))</span>
                               <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1048; &#1087;&#1077;&#1088;&#1077;&#1076;&#1072;&#1077;&#1084; new-env &#1074; &#1082;&#1072;&#1095;&#1077;&#1089;&#1090;&#1074;&#1077; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
                               (evprogn (cddr exp) new-env block-env go-env catch-env errcont cont)))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myeval_labels_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LABELS</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">labels</span> ((zzz (lst acc)
                          (print acc)
                          (<span style="color: #a020f0;">cond</span> ((null lst) acc)
                                (t (zzz (cdr lst) (+ 1 acc))))))
                 (print 888)
                 (zzz '(1 2 3) 0))
               (stepper (myeval '(<span style="color: #a020f0;">labels</span> ((zzz (lst acc)
                                  (print acc)
                                  (<span style="color: #a020f0;">cond</span> ((null lst) acc)
                                        (t (zzz (cdr lst) (+ 1 acc))))))
                         (print 888)
                         (zzz '(1 2 3) 0))
                         nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">with-output-to-string</span> (*standard-output*)
                 (<span style="color: #a020f0;">labels</span> ((zzz (lst acc)
                            (print acc)
                            (<span style="color: #a020f0;">cond</span> ((null lst) acc)
                                  (t (zzz (cdr lst) (+ 1 acc))))))
                   (print 888)
                   (zzz '(1 2 3) 0)
                   (format t <span style="color: #8b2252;">"~%ok: 3"</span>)))
               (<span style="color: #a020f0;">with-output-to-string</span> (*standard-output*)
                 (stepper (myeval '(<span style="color: #a020f0;">labels</span> ((zzz (lst acc)
                                             (print acc)
                                             (<span style="color: #a020f0;">cond</span> ((null lst) acc)
                                                   (t (zzz (cdr lst) (+ 1 acc))))))
                                    (print 888)
                                    (zzz '(1 2 3) 0))
                                  nil nil nil nil #'err #'ok)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-21" class="outline-3">
<h3 id="sec-9-21">RESET</h3>
<div class="outline-text-3" id="text-9-21">
<p>
Заменяем вызов <code>apply-continuation</code> на возврат списка, начинающегося с символа <code>return</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_reset_10">((equal (car exp) 'reset)    (list 'return cont (myeval (cadr exp)
                                                        env block-env go-env catch-env
                                                        errcont #'identity)))
</pre>
</div>

<p>
Тест так себе, но ничего более умного не придумалось
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_reset_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; RESET</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(assert (equal 8 (stepper (myeval '(progn</span>
<span style="color: #b22222;">;;                             </span><span style="color: #b22222;">(+ 1 (reset (+ 2 3)) 2))</span>
<span style="color: #b22222;">;;                             </span><span style="color: #b22222;">nil nil nil nil #'err #'ok))))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-9-22" class="outline-3">
<h3 id="sec-9-22">SHIFT</h3>
<div class="outline-text-3" id="text-9-22">
<p>
Заменяем вызов <code>myeval</code> на возврат списка, начинающегося с символа <code>eval</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_shift_10">((equal (car exp) 'shift)    (list 'eval (caddr exp)
                                   (acons (cadr exp) cont env)
                                   block-env go-env catch-env
                                   errcont cont))
</pre>
</div>

<p>
Тут мы сохраняем продолжение в переменной и используем его, чтобы возвращаться в него и
вычислять то что происходит между <code>reset</code> и <code>shift</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_shift_10_test"><span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; SHIFT/RESET</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(assert (equal 44 (stepper (myeval '(let ((foo))</span>
<span style="color: #b22222;">;;                             </span><span style="color: #b22222;">(+ 1 (reset (+ 2 (shift f (progn (setq foo f) 4)))))</span>
<span style="color: #b22222;">;;                             </span><span style="color: #b22222;">(foo 42))</span>
<span style="color: #b22222;">;;                           </span><span style="color: #b22222;">nil nil nil nil #'err #'ok))))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10">REPL</h2>
<div class="outline-text-2" id="text-10">
<p>
[TODO:gmm] Тут как-то странно поменялся репл - непонятно почему
Ответ - из рестартов - чтобы не сбрасывать стек. добавить до трамполинизации
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="repl_10">(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">repl</span> (prompt catch-env errcont cont)
  (format t <span style="color: #8b2252;">"~%~A&gt; "</span> prompt)
  (finish-output)
  (myeval (read) nil nil nil (acons 'exit cont catch-env)
          #'(<span style="color: #a020f0;">lambda</span> (x)
              (princ x)
              (terpri)
              (finish-output)
              (repl prompt catch-env errcont cont))
          #'(<span style="color: #a020f0;">lambda</span> (x)
              (princ x)
              (terpri)
              (finish-output)
              (repl prompt catch-env errcont cont))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">repl</span> ()
  (princ <span style="color: #8b2252;">"microlisp&gt;"</span>)
  (finish-output)
  (stepper (list 'eval (read) nil nil nil nil #'err #'ok))
  (terpri)
  (finish-output)
  (repl))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11"><span class="todo TODO">TODO</span> TODO</h2>
<div class="outline-text-2" id="text-11">
<p>
рестарты
ok и err - просто структуры без полей
store вполне можно встроить в дефункционализированный интрерпретатор.
</p>
</div>
</div>

<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12">Итоги</h2>
<div class="outline-text-2" id="text-12">
<p>
Теперь вместо <code>eval</code> в <code>repl</code> нужно использовать <code>stepper</code> с соответствующим фреймом:
</p>

<p>
[TODO:gmm] В более ранних файлах вместо OK и ERR были #'identity. Надо это поправить.
</p>

<div class="org-src-container">

<pre class="src src-lisp">(setq *print-circle* T)
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1050;&#1083;&#1072;&#1089;&#1089;&#1099; &#1086;&#1096;&#1080;&#1073;&#1086;&#1082;</span>
&lt;&lt;errors_10&gt;&gt;
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1057;&#1090;&#1088;&#1091;&#1082;&#1090;&#1091;&#1088;&#1099;</span>
&lt;&lt;unicont_10&gt;&gt;
<span style="color: #b22222;">;; </span><span style="color: #b22222;">APPLY-CONTINUATION</span>
&lt;&lt;apply_continuation_10&gt;&gt;
<span style="color: #b22222;">;; </span><span style="color: #b22222;">CPS-&#1074;&#1077;&#1088;&#1089;&#1080;&#1103; ASSOC</span>
&lt;&lt;assoc_10&gt;&gt;
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1053;&#1086;&#1074;&#1072;&#1103; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; lookup</span>
&lt;&lt;lookup_10&gt;&gt;
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1057;&#1090;&#1088;&#1091;&#1082;&#1090;&#1091;&#1088;&#1072; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1103;</span>
&lt;&lt;closure_10&gt;&gt;
<span style="color: #b22222;">;; </span><span style="color: #b22222;">CPS-&#1074;&#1072;&#1088;&#1080;&#1072;&#1085;&#1090; MYAPPLY &#1080; &#1074;&#1089;&#1077; &#1095;&#1090;&#1086; &#1082; &#1085;&#1077;&#1084;&#1091; &#1086;&#1090;&#1085;&#1086;&#1089;&#1080;&#1090;&#1089;&#1103;</span>
&lt;&lt;myapply_10&gt;&gt;
<span style="color: #b22222;">;; </span><span style="color: #b22222;">CPS-&#1074;&#1072;&#1088;&#1080;&#1072;&#1085;&#1090; MYEVAL &#1080; &#1074;&#1089;&#1077; &#1095;&#1090;&#1086; &#1082; &#1085;&#1077;&#1084;&#1091; &#1086;&#1090;&#1085;&#1086;&#1089;&#1080;&#1090;&#1089;&#1103;</span>
&lt;&lt;myeval_10&gt;&gt;
<span style="color: #b22222;">;; </span><span style="color: #b22222;">STEPPER</span>
&lt;&lt;stepper_10&gt;&gt;
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1080;&#1088;&#1091;&#1077;&#1084; &#1085;&#1086;&#1074;&#1099;&#1081; lookup</span>
&lt;&lt;lookup_10_test&gt;&gt;
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1060;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080; &#1076;&#1083;&#1103; &#1090;&#1077;&#1089;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; CPS-&#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1081;</span>
&lt;&lt;ok_err_10&gt;&gt;
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; MYAPPLY</span>
&lt;&lt;myapply_10_test&gt;&gt;
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; MYEVAL</span>
&lt;&lt;myeval_10_test&gt;&gt;
<span style="color: #b22222;">;; </span><span style="color: #b22222;">REPL</span>
&lt;&lt;repl_10&gt;&gt;
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(repl)</span>
</pre>
</div>

<p>
Получиться должен вот такой результат:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(setq *print-circle* T)
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1050;&#1083;&#1072;&#1089;&#1089;&#1099; &#1086;&#1096;&#1080;&#1073;&#1086;&#1082;</span>
(<span style="color: #a020f0;">define-condition</span> <span style="color: #0000ff;">unknown-continuation</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((cont <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:cont</span>  <span style="color: #483d8b;">:reader</span> cont))
  (<span style="color: #483d8b;">:report</span>
   (<span style="color: #a020f0;">lambda</span> (condition stream)
     (format stream <span style="color: #8b2252;">"Error in APPLY-CONTINUATION: unknown-continuation: ~A"</span>
             (cont condition)))))
(<span style="color: #a020f0;">define-condition</span> <span style="color: #0000ff;">unknown-function</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((fn <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:fn</span>  <span style="color: #483d8b;">:reader</span> fn))
  (<span style="color: #483d8b;">:report</span>
   (<span style="color: #a020f0;">lambda</span> (condition stream)
     (format stream <span style="color: #8b2252;">"Error in MYAPPLY: unknown-function: ~A"</span>
             (fn condition)))))
(<span style="color: #a020f0;">define-condition</span> <span style="color: #0000ff;">invalid-number-of-arguments</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((fn <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:fn</span>  <span style="color: #483d8b;">:reader</span> fn))
  (<span style="color: #483d8b;">:report</span>
   (<span style="color: #a020f0;">lambda</span> (condition stream)
     (format stream <span style="color: #8b2252;">"Error in MYAPPLY: invalid-number-of-arguments: ~A"</span>
             (fn condition)))))
(<span style="color: #a020f0;">define-condition</span> <span style="color: #0000ff;">mypairlis-error</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((lst1 <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:lst1</span>  <span style="color: #483d8b;">:reader</span> lst1)
   (lst2 <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:lst2</span>  <span style="color: #483d8b;">:reader</span> lst2))
  (<span style="color: #483d8b;">:report</span>
   (<span style="color: #a020f0;">lambda</span> (condition stream)
     (format stream <span style="color: #8b2252;">"Error in MYPAIRLIS: wrong params:~%'~A~%'~A"</span>
             (lst1 condition) (lst2 condition)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1057;&#1090;&#1088;&#1091;&#1082;&#1090;&#1091;&#1088;&#1099;</span>
(<span style="color: #a020f0;">defstruct</span> <span style="color: #228b22;">unicont</span>
  block-env
  go-env
  catch-env
  errcont
  cont)
(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">if-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  clauses
  env)
(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">evcond-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  clauses
  env)
(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">evprogn-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  clauses
  env)
(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">and-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  exps
  env)
(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">or-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  exps
  env)
(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">evlet-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  vars
  exps
  evald-exps
  exp
  env)
(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">evletstar-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  varpairs
  exp
  env)
(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">setq-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  clauses
  env)
(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">catch-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  clauses
  env)
(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">throw-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  clauses
  env)
(<span style="color: #a020f0;">defstruct</span> <span style="color: #228b22;">throw2-cont</span>
  prev-arg
  catch-env
  errcont)
(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">evtagbody-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  body
  env)
(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">go-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  slice
  env)
<span style="color: #b22222;">;; </span><span style="color: #b22222;">APPLY-CONTINUATION</span>
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">apply-continuation</span> (cont arg)
  (<span style="color: #a020f0;">cond</span> ((functionp cont)       (funcall cont arg))
        ((if-cont-p cont)       (<span style="color: #a020f0;">if</span> arg
                                    (list 'eval (caddr (if-cont-clauses cont))
                                          (if-cont-env cont)
                                          (if-cont-block-env cont)
                                          (if-cont-go-env cont)
                                          (if-cont-catch-env cont)
                                          (if-cont-errcont cont)
                                          (if-cont-cont cont))
                                    (list 'eval (cadddr (if-cont-clauses cont))
                                          (if-cont-env cont)
                                          (if-cont-block-env cont)
                                          (if-cont-go-env cont)
                                          (if-cont-catch-env cont)
                                          (if-cont-errcont cont)
                                          (if-cont-cont cont))))
        ((evcond-cont-p cont)   (<span style="color: #a020f0;">if</span> arg
                                    (list 'eval (cadar (evcond-cont-clauses cont))
                                          (evcond-cont-env cont)
                                          (evcond-cont-block-env cont)
                                          (evcond-cont-go-env cont)
                                          (evcond-cont-catch-env cont)
                                          (evcond-cont-errcont cont)
                                          (evcond-cont-cont cont))
                                    (evcond (cdr (evcond-cont-clauses cont))
                                            (evcond-cont-env cont)
                                            (evcond-cont-block-env cont)
                                            (evcond-cont-go-env cont)
                                            (evcond-cont-catch-env cont)
                                            (evcond-cont-errcont cont)
                                            (evcond-cont-cont cont))))
        ((evprogn-cont-p cont)  (evprogn (cdr (evprogn-cont-clauses cont))
                                         (evprogn-cont-env cont)
                                         (evprogn-cont-block-env cont)
                                         (evprogn-cont-go-env cont)
                                         (evprogn-cont-catch-env cont)
                                         (evprogn-cont-errcont cont)
                                         (evprogn-cont-cont cont)))
        ((evcond-cont-p cont)   (<span style="color: #a020f0;">if</span> arg
                                    (list 'eval (cadar (evcond-cont-clauses cont))
                                          (evcond-cont-env cont)
                                          (evcond-cont-block-env cont)
                                          (evcond-cont-go-env cont)
                                          (evcond-cont-catch-env cont)
                                          (evcond-cont-errcont cont)
                                          (evcond-cont-cont cont))
                                    (evcond (cdr (evcond-cont-clauses cont))
                                            (evcond-cont-env cont)
                                            (evcond-cont-block-env cont)
                                            (evcond-cont-go-env cont)
                                            (evcond-cont-catch-env cont)
                                            (evcond-cont-errcont cont)
                                            (evcond-cont-cont cont))))
        ((evprogn-cont-p cont)  (evprogn (cdr (evprogn-cont-clauses cont))
                                         (evprogn-cont-env cont)
                                         (evprogn-cont-block-env cont)
                                         (evprogn-cont-go-env cont)
                                         (evprogn-cont-catch-env cont)
                                         (evprogn-cont-errcont cont)
                                         (evprogn-cont-cont cont)))
        ((and-cont-p cont)      (<span style="color: #a020f0;">if</span> (null arg)
                                    (list 'return (and-cont-cont cont) nil)
                                    (evand (and-cont-exps cont)
                                           (and-cont-env cont)
                                           (and-cont-block-env cont)
                                           (and-cont-go-env cont)
                                           (and-cont-catch-env cont)
                                           (and-cont-errcont cont)
                                           (and-cont-cont cont))))
        ((or-cont-p cont)       (<span style="color: #a020f0;">if</span> (not (null arg))
                                    (list 'return (or-cont-cont cont) arg)
                                    (evor (or-cont-exps cont)
                                          (or-cont-env cont)
                                          (or-cont-block-env cont)
                                          (or-cont-go-env cont)
                                          (or-cont-catch-env cont)
                                          (or-cont-errcont cont)
                                          (or-cont-cont cont))))
        ((evlet-cont-p cont)    (evlet (evlet-cont-vars cont)
                                       (cdr (evlet-cont-exps cont))
                                       (cons arg (evlet-cont-evald-exps cont))
                                       (evlet-cont-exp cont)
                                       (evlet-cont-env cont)
                                       (evlet-cont-block-env cont)
                                       (evlet-cont-go-env cont)
                                       (evlet-cont-catch-env cont)
                                       (evlet-cont-errcont cont)
                                       (evlet-cont-cont cont)))
        ((evletstar-cont-p cont) (evletstar (cdr (evletstar-cont-varpairs cont))
                                            (evletstar-cont-exp cont)
                                            (acons (caar (evletstar-cont-varpairs cont))
                                                   arg
                                                   (evletstar-cont-env cont))
                                            (evletstar-cont-block-env cont)
                                            (evletstar-cont-go-env cont)
                                            (evletstar-cont-catch-env cont)
                                            (evletstar-cont-errcont cont)
                                            (evletstar-cont-cont cont)))
        ((setq-cont-p cont)     (<span style="color: #a020f0;">progn</span>
                                  (<span style="color: #a020f0;">if</span> (null (assoc (cadr (setq-cont-clauses cont))
                                                   (setq-cont-env cont)))
                                      <span style="color: #b22222;">;; </span><span style="color: #b22222;">if-null</span>
                                      (<span style="color: #a020f0;">if</span> (null (assoc (cadr (setq-cont-clauses cont))
                                                       *glob-env*))
                                          <span style="color: #b22222;">;; </span><span style="color: #b22222;">then</span>
                                          (push (cons (cadr (setq-cont-clauses cont))
                                                      arg)
                                                *glob-env*)
                                          <span style="color: #b22222;">;; </span><span style="color: #b22222;">else</span>
                                          (rplacd (assoc (cadr (setq-cont-clauses cont))
                                                         *glob-env*)
                                                  arg))
                                      <span style="color: #b22222;">;; </span><span style="color: #b22222;">if-not-null</span>
                                      (rplacd (assoc (cadr (setq-cont-clauses cont))
                                                     (setq-cont-env cont))
                                              arg))
                                  (list 'return (setq-cont-cont cont) arg)))
        ((catch-cont-p cont)    (<span style="color: #a020f0;">if</span> (not (symbolp arg))
                                    (list 'return
                                          errcont
                                          (format nil <span style="color: #8b2252;">"catch: first argument not a symbol"</span>))
                                    (list 'eval (caddr (catch-cont-clauses cont))
                                          (catch-cont-env cont)
                                          (catch-cont-block-env cont)
                                          (catch-cont-go-env cont)
                                          (acons arg
                                                 (catch-cont-cont cont)
                                                 (catch-cont-catch-env cont))
                                          (catch-cont-errcont cont)
                                          (catch-cont-cont cont))))
        ((throw-cont-p cont)    (list 'eval (caddr (throw-cont-clauses cont))
                                      (throw-cont-env cont)
                                      (throw-cont-block-env cont)
                                      (throw-cont-go-env cont)
                                      (throw-cont-catch-env cont)
                                      (throw-cont-errcont cont)
                                      (make-throw2-cont
                                       <span style="color: #483d8b;">:prev-arg</span> arg
                                       <span style="color: #483d8b;">:catch-env</span> (throw-cont-catch-env cont)
                                       <span style="color: #483d8b;">:errcont</span> (throw-cont-errcont cont))))
        ((throw2-cont-p cont)   (assoc-2 (throw2-cont-prev-arg cont)
                                         (throw2-cont-catch-env cont)
                                         (<span style="color: #a020f0;">lambda</span> (cont-res)
                                           (list 'return cont-res arg))
                                         (<span style="color: #a020f0;">lambda</span> (key)
                                           (list 'return (throw2-cont-errcont cont)
                                                 (format
                                                  nil
                                                  <span style="color: #8b2252;">"throw: matching ~A catch is not found"</span>
                                                  key)))))
        ((evtagbody-cont-p cont) (evtagbody (evtagbody-cont-body cont)
                                            (evtagbody-cont-env cont)
                                            (unicont-block-env cont)
                                            (unicont-go-env cont)
                                            (unicont-catch-env cont)
                                            (unicont-errcont cont)
                                            (unicont-cont cont)))
        ((evlis-cont-p cont)    (evlis (evlis-cont-fn cont)
                                       (cdr (evlis-cont-unevaled cont))
                                       (cons arg (evlis-cont-evaled cont))
                                       (evlis-cont-env cont)
                                       (unicont-block-env cont)
                                       (unicont-go-env cont)
                                       (unicont-catch-env cont)
                                       (unicont-errcont cont)
                                       (unicont-cont cont)))
        (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'unknown-continuation <span style="color: #483d8b;">:cont</span> cont))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">CPS-&#1074;&#1077;&#1088;&#1089;&#1080;&#1103; ASSOC</span>
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">assoc-2</span> (key alist success failure) <span style="color: #b22222;">;; </span><span style="color: #b22222;">NB!: inverted order of continuations</span>
  <span style="color: #b22222;">;; </span><span style="color: #b22222;">(for lookup comfort)</span>
  (<span style="color: #a020f0;">cond</span> ((null alist)              (funcall failure key))
        ((equal key (caar alist))  (funcall success    (cdar alist)))
        (t                         (assoc-2 key (cdr alist) success failure))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1053;&#1086;&#1074;&#1072;&#1103; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; lookup</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">environment</span>
(<span style="color: #a020f0;">defparameter</span> <span style="color: #a0522d;">*glob-env*</span> nil)
<span style="color: #b22222;">;; </span><span style="color: #b22222;">lookup</span>
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">lookup</span> (symb env errcont cont)
  (assoc-2 symb env
           (<span style="color: #a020f0;">lambda</span> (x)
             (list 'return cont x))
           (<span style="color: #a020f0;">lambda</span> (key)
             (assoc-2 key *glob-env*
                      (<span style="color: #a020f0;">lambda</span> (x) <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1074;&#1086;&#1079;&#1084;&#1086;&#1078;&#1085;&#1086; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072; (&#1073;&#1099;&#1083;&#1072;) &#1090;&#1091;&#1090;</span>
                        (list 'return cont x))
                      (<span style="color: #a020f0;">lambda</span> (key)
                        (list 'return
                              errcont
                              (format
                               nil <span style="color: #8b2252;">"UNBOUD VARIABLE [~A] ~%LOCAL ENV: [~A] ~%GLOBAL ENV: [~A]"</span>
                               key env *glob-env*)))))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1057;&#1090;&#1088;&#1091;&#1082;&#1090;&#1091;&#1088;&#1072; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1103;</span>
(<span style="color: #a020f0;">defstruct</span> <span style="color: #228b22;">closure</span>
  body
  env
  block-env
  go-env
  args)
<span style="color: #b22222;">;; </span><span style="color: #b22222;">CPS-&#1074;&#1072;&#1088;&#1080;&#1072;&#1085;&#1090; MYAPPLY &#1080; &#1074;&#1089;&#1077; &#1095;&#1090;&#1086; &#1082; &#1085;&#1077;&#1084;&#1091; &#1086;&#1090;&#1085;&#1086;&#1089;&#1080;&#1090;&#1089;&#1103;</span>
(<span style="color: #a020f0;">defstruct</span> (<span style="color: #228b22;">evlis-cont</span> (<span style="color: #483d8b;">:include</span> unicont))
  fn
  unevaled
  evaled
  env)
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evadd</span> (lst acc)
  (<span style="color: #a020f0;">cond</span> ((null lst)        0)
        ((null (cdr lst))  (+ acc (car lst)))
        (t                 (evadd (cdr lst)
                                  (+ acc (car lst))))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evmul</span> (lst acc)
  (<span style="color: #a020f0;">cond</span> ((null lst)        1)
        ((null (cdr lst))  (* acc (car lst)))
        (t                 (evmul (cdr lst)
                                  (* acc (car lst))))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evlis</span> (fn unevaled evaled env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null unevaled)  (myapply fn (reverse evaled) catch-env errcont cont))
        (t                (list 'eval (car unevaled) env block-env go-env catch-env errcont
                                (make-evlis-cont
                                 <span style="color: #483d8b;">:fn</span> fn
                                 <span style="color: #483d8b;">:unevaled</span> unevaled
                                 <span style="color: #483d8b;">:evaled</span> evaled
                                 <span style="color: #483d8b;">:env</span> env
                                 <span style="color: #483d8b;">:block-env</span> block-env
                                 <span style="color: #483d8b;">:go-env</span> go-env
                                 <span style="color: #483d8b;">:catch-env</span> catch-env
                                 <span style="color: #483d8b;">:errcont</span> errcont
                                 <span style="color: #483d8b;">:cont</span> cont)))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">myapply</span> (fn args catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span>
    ((equal fn 'car)             (list 'return cont (caar args)))
    ((equal fn 'cdr)             (list 'return cont (cdar args)))
    ((equal fn 'cons)            (list 'return cont (cons (car args) (cadr args))))
    ((equal fn 'null)            (<span style="color: #a020f0;">if</span> (null (cdr args))
                                     (list 'return cont (null (car args)))
                                     (<span style="color: #ff0000; font-weight: bold;">error</span> 'invalid-number-of-arguments <span style="color: #483d8b;">:fn</span> fn)))
    ((equal fn '+)             (list 'return cont (evadd args 0)))
    ((equal fn '*)             (list 'return cont (evmul args 1)))
    ((closure-p fn)              (evprogn (closure-body fn)
                                          (pairlis (closure-args fn)
                                                   args
                                                   (closure-env fn))
                                          (closure-block-env fn)
                                          (closure-go-env fn)
                                          catch-env
                                          errcont cont))
    ((equal fn 'print)           (list 'return cont (print (car args))))
    ((equal fn 'list)            (list 'return cont args))
    ((equal fn 'call/cc)         (myapply (car args) (list cont) catch-env errcont cont))
    ((functionp fn)              (apply fn args))      <span style="color: #b22222;">; interim hack</span>
    ((unicont-p fn)              (apply-continuation fn (car args)))
    <span style="color: #b22222;">;;  </span><span style="color: #b22222;">((identity-cont-p fn)        (apply-continuation fn (car args))) ;; for identity</span>
    (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'unknown-function <span style="color: #483d8b;">:fn</span> fn))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">CPS-&#1074;&#1072;&#1088;&#1080;&#1072;&#1085;&#1090; MYEVAL &#1080; &#1074;&#1089;&#1077; &#1095;&#1090;&#1086; &#1082; &#1085;&#1077;&#1084;&#1091; &#1086;&#1090;&#1085;&#1086;&#1089;&#1080;&#1090;&#1089;&#1103;</span>
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evcond</span> (clauses env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null clauses)  (list 'return cont nil))
        (t               (list 'eval (caar clauses) env block-env go-env catch-env errcont
                               (make-evcond-cont
                                <span style="color: #483d8b;">:clauses</span> clauses
                                <span style="color: #483d8b;">:env</span> env
                                <span style="color: #483d8b;">:block-env</span> block-env
                                <span style="color: #483d8b;">:go-env</span> go-env
                                <span style="color: #483d8b;">:catch-env</span> catch-env
                                <span style="color: #483d8b;">:errcont</span> errcont
                                <span style="color: #483d8b;">:cont</span> cont)))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evprogn</span> (lst env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null lst)         (list 'return cont nil))
        ((null (cdr lst))   (list 'eval (car lst) env block-env go-env catch-env errcont cont))
        (t                  (list 'eval (car lst) env block-env go-env catch-env errcont
                                  (make-evprogn-cont
                                   <span style="color: #483d8b;">:clauses</span> lst
                                   <span style="color: #483d8b;">:env</span> env
                                   <span style="color: #483d8b;">:block-env</span> block-env
                                   <span style="color: #483d8b;">:go-env</span> go-env
                                   <span style="color: #483d8b;">:catch-env</span> catch-env
                                   <span style="color: #483d8b;">:errcont</span> errcont
                                   <span style="color: #483d8b;">:cont</span> cont)))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evand</span> (exps env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null exps)       (list 'return cont T))
        ((null (cdr exps)) (list 'eval (car exps) env block-env go-env catch-env errcont cont))
        (t                 (list 'eval (car exps) env block-env go-env catch-env errcont
                                 (make-and-cont
                                  <span style="color: #483d8b;">:exps</span> (cdr exps)
                                  <span style="color: #483d8b;">:env</span> env
                                  <span style="color: #483d8b;">:block-env</span> block-env
                                  <span style="color: #483d8b;">:go-env</span> go-env
                                  <span style="color: #483d8b;">:catch-env</span> catch-env
                                  <span style="color: #483d8b;">:errcont</span> errcont
                                  <span style="color: #483d8b;">:cont</span> cont)))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evor</span> (exps env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null exps)       (list 'return cont nil))
        ((null (cdr exps)) (list 'eval (car exps) env block-env go-env catch-env errcont cont))
        (t                 (list 'eval (car exps) env block-env go-env catch-env errcont
                                 (make-or-cont
                                  <span style="color: #483d8b;">:exps</span> (cdr exps)
                                  <span style="color: #483d8b;">:env</span> env
                                  <span style="color: #483d8b;">:block-env</span> block-env
                                  <span style="color: #483d8b;">:go-env</span> go-env
                                  <span style="color: #483d8b;">:catch-env</span> catch-env
                                  <span style="color: #483d8b;">:errcont</span> errcont
                                  <span style="color: #483d8b;">:cont</span> cont)))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">mypairlis</span> (lst1 lst2 alist)
  (<span style="color: #a020f0;">cond</span> ((and (null lst1) (null lst2))  alist)
        ((or  (null lst1) (null lst2))  (<span style="color: #ff0000; font-weight: bold;">error</span> 'mypairlis-error <span style="color: #483d8b;">:lst1</span> lst1 <span style="color: #483d8b;">:lst2</span> lst2))
        (t                              (cons (cons (car lst1)
                                                    (car lst2))
                                              (mypairlis (cdr lst1)
                                                         (cdr lst2)
                                                         alist)))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evlet</span> (vars exps evald-exps exp env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null exps)  (evprogn exp
                               (pairlis vars (reverse evald-exps) env)
                               block-env go-env catch-env
                               errcont cont))
        (t            (list 'eval (car exps) env block-env go-env catch-env errcont
                            (make-evlet-cont
                             <span style="color: #483d8b;">:vars</span> vars
                             <span style="color: #483d8b;">:exps</span> exps
                             <span style="color: #483d8b;">:evald-exps</span> evald-exps
                             <span style="color: #483d8b;">:exp</span> exp
                             <span style="color: #483d8b;">:env</span> env
                             <span style="color: #483d8b;">:block-env</span> block-env
                             <span style="color: #483d8b;">:go-env</span> go-env
                             <span style="color: #483d8b;">:catch-env</span> catch-env
                             <span style="color: #483d8b;">:errcont</span> errcont
                             <span style="color: #483d8b;">:cont</span> cont)))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evletstar</span> (varpairs exp env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null varpairs)  (evprogn exp env block-env go-env catch-env errcont cont))
        (t                (list 'eval (cadar varpairs) env block-env go-env catch-env errcont
                                (make-evletstar-cont
                                 <span style="color: #483d8b;">:varpairs</span> varpairs
                                 <span style="color: #483d8b;">:exp</span> exp
                                 <span style="color: #483d8b;">:env</span> env
                                 <span style="color: #483d8b;">:block-env</span> block-env
                                 <span style="color: #483d8b;">:go-env</span> go-env
                                 <span style="color: #483d8b;">:catch-env</span> catch-env
                                 <span style="color: #483d8b;">:errcont</span> errcont
                                 <span style="color: #483d8b;">:cont</span> cont)))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evthrow</span> (exp env block-env go-env catch-env errcont cont)
  (list 'eval (cadr exp) env block-env go-env catch-env errcont
        (make-throw-cont
         <span style="color: #483d8b;">:clauses</span> exp
         <span style="color: #483d8b;">:env</span> env
         <span style="color: #483d8b;">:block-env</span> block-env
         <span style="color: #483d8b;">:go-env</span> go-env
         <span style="color: #483d8b;">:catch-env</span> catch-env
         <span style="color: #483d8b;">:errcont</span> errcont
         <span style="color: #483d8b;">:cont</span> cont)))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">tagbody-check-tag</span> (exp cont errcont)
  (<span style="color: #a020f0;">cond</span> ((null exp) (funcall cont))
        ((and (symbolp (car exp))
              (member (car exp) (cdr exp)))
         (funcall errcont (car exp)))
        (t (tagbody-check-tag (cdr exp) cont errcont))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">evtagbody</span> (body env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span> ((null (car body))      (list 'return cont nil))
        ((symbolp (car body))   (evtagbody (cdr body) env block-env go-env catch-env errcont cont))
        (t                      (list 'eval (car body) env block-env go-env catch-env errcont
                                      (make-evtagbody-cont
                                       <span style="color: #483d8b;">:body</span> (cdr body)
                                       <span style="color: #483d8b;">:env</span>  env
                                       <span style="color: #483d8b;">:block-env</span> block-env
                                       <span style="color: #483d8b;">:go-env</span> go-env
                                       <span style="color: #483d8b;">:catch-env</span> catch-env
                                       <span style="color: #483d8b;">:errcont</span> errcont
                                       <span style="color: #483d8b;">:cont</span> cont)))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">tagbody-slice</span> (exp res)
  (<span style="color: #a020f0;">cond</span> ((null exp) res)
        ((symbolp (car exp))  (tagbody-slice (cdr exp) (cons exp res)))
        (t                    (tagbody-slice (cdr exp) res))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">is-cont-subset</span> (target-cont cont)
  (<span style="color: #a020f0;">cond</span> ((equal target-cont cont) t)    <span style="color: #b22222;">;; </span><span style="color: #b22222;">positive</span>
        ((functionp cont) nil)          <span style="color: #b22222;">;; </span><span style="color: #b22222;">negative</span>
        (t (is-cont-subset target-cont (cdr cont)))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">make-go-env</span> (tagbody-body env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">let*</span> ((conts (mapcar #'(<span style="color: #a020f0;">lambda</span> (x) <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1087;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1077;&#1085;&#1080;&#1103;, &#1085;&#1072;&#1088;&#1077;&#1079;&#1072;&#1085;&#1085;&#1099;&#1077; &#1080;&#1079; tagbody</span>
                            (make-go-cont
                             <span style="color: #483d8b;">:slice</span> x
                             <span style="color: #483d8b;">:env</span> env
                             <span style="color: #483d8b;">:block-env</span> block-env
                             <span style="color: #483d8b;">:go-env</span> go-env <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1101;&#1090;&#1086;&#1090; &#1089;&#1083;&#1086;&#1090; &#1073;&#1091;&#1076;&#1077;&#1084; setf-&#1101;&#1092;&#1080;&#1090;&#1100;</span>
                             <span style="color: #483d8b;">:catch-env</span>  catch-env
                             <span style="color: #483d8b;">:errcont</span> errcont
                             <span style="color: #483d8b;">:cont</span> cont))
                        (tagbody-slice tagbody-body nil)))
         <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1087;&#1072;&#1088;&#1099; (&#1089;&#1080;&#1084;&#1074;&#1086;&#1083; . &#1087;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1077;&#1085;&#1080;&#1077;) &#1085;&#1072;&#1088;&#1077;&#1079;&#1072;&#1085;&#1085;&#1099;&#1077; &#1080;&#1079;</span>
         <span style="color: #b22222;">;; </span><span style="color: #b22222;">tagbody &#1080; &#1076;&#1086;&#1073;&#1072;&#1074;&#1083;&#1077;&#1085;&#1085;&#1099;&#1077; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
         (new-go-env (append (mapcar #'(<span style="color: #a020f0;">lambda</span> (go-cont)
                                         (cons (car (go-cont-slice go-cont))
                                               go-cont))
                                     conts)
                             go-env)))
    <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1080;&#1079;&#1084;&#1077;&#1085;&#1103;&#1077;&#1084; &#1087;&#1086;&#1083;&#1103; go-env, &#1079;&#1072;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1103; &#1074; &#1085;&#1080;&#1093; new-go-env</span>
    <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1074;&#1086; &#1074;&#1089;&#1077;&#1093; &#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1087;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1077;&#1085;&#1080;&#1103;&#1093;</span>
    (<span style="color: #a020f0;">loop</span> <span style="color: #483d8b;">:for</span> elt-cont <span style="color: #483d8b;">:in</span> conts <span style="color: #483d8b;">:do</span>
       (setf (go-cont-go-env elt-cont)
             new-go-env))
    <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084; &#1085;&#1086;&#1074;&#1086;&#1077; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
    new-go-env))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">apply-go-continuation</span> (go-cont)
  (evtagbody (go-cont-slice go-cont)
             (go-cont-env go-cont)
             (go-cont-block-env go-cont)
             (go-cont-go-env go-cont)
             (go-cont-catch-env go-cont)
             (go-cont-errcont go-cont)
             (go-cont-cont go-cont)))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">myeval</span> (exp env block-env go-env catch-env errcont cont)
  (<span style="color: #a020f0;">cond</span>
    ((null exp)                  (list 'return cont 'nil))
    ((equal 't exp)              (list 'return cont 't))
    ((member exp '(+ * car cdr cons null print list call/cc repl))  (list 'return cont exp))
    ((numberp exp)               (list 'return cont exp))
    ((symbolp exp)               (lookup exp env errcont cont))
    ((equal (car exp) 'quote)    (list 'return cont (cadr exp)))
    ((equal (car exp) 'if)       (list 'eval (cadr exp) env block-env go-env catch-env errcont
                                       (make-if-cont
                                        <span style="color: #483d8b;">:clauses</span> exp
                                        <span style="color: #483d8b;">:env</span> env
                                        <span style="color: #483d8b;">:block-env</span> block-env
                                        <span style="color: #483d8b;">:go-env</span> go-env
                                        <span style="color: #483d8b;">:catch-env</span> catch-env
                                        <span style="color: #483d8b;">:errcont</span> errcont
                                        <span style="color: #483d8b;">:cont</span> cont)))
    ((equal (car exp) 'cond)     (evcond (cdr exp) env block-env go-env catch-env errcont cont))
    ((equal (car exp) 'progn)    (evprogn (cdr exp)
                                          env block-env go-env catch-env
                                          errcont cont))
    ((equal (car exp) 'and)      (evand (cdr exp)
                                        env block-env go-env catch-env
                                        errcont cont))
    ((equal (car exp) 'or)       (evor  (cdr exp)
                                        env block-env go-env catch-env
                                        errcont cont))
    ((equal (car exp) 'let)      (evlet (mapcar #'car (cadr exp))
                                        (mapcar #'cadr (cadr exp))
                                        nil
                                        (cddr exp)
                                        env block-env go-env catch-env
                                        errcont cont))
    ((equal (car exp) 'let*)     (evletstar (cadr exp)
                                            (cddr exp)
                                            env block-env go-env catch-env
                                            errcont cont))
    ((equal (car exp) 'defun)         (<span style="color: #a020f0;">progn</span>
                                        (push (cons (cadr exp)
                                                    (make-closure <span style="color: #483d8b;">:body</span> (cdddr exp)
                                                                  <span style="color: #483d8b;">:block-env</span> block-env
                                                                  <span style="color: #483d8b;">:env</span> env
                                                                  <span style="color: #483d8b;">:go-env</span> go-env
                                                                  <span style="color: #483d8b;">:args</span> (caddr exp)))
                                              *glob-env*)
                                        (list 'return cont (cadr exp))))
    ((equal (car exp) 'setq)     (list 'eval (caddr exp) env block-env go-env catch-env errcont
                                       (make-setq-cont
                                        <span style="color: #483d8b;">:clauses</span> exp
                                        <span style="color: #483d8b;">:env</span> env
                                        <span style="color: #483d8b;">:block-env</span> block-env
                                        <span style="color: #483d8b;">:go-env</span> go-env
                                        <span style="color: #483d8b;">:catch-env</span> catch-env
                                        <span style="color: #483d8b;">:errcont</span> errcont
                                        <span style="color: #483d8b;">:cont</span> cont)))
    <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1089;&#1090;&#1072;&#1083;&#1086;</span>
    ((equal (car exp) 'lambda)   (list 'return cont (make-closure <span style="color: #483d8b;">:body</span> (cddr exp)
                                                                  <span style="color: #483d8b;">:block-env</span> block-env
                                                                  <span style="color: #483d8b;">:env</span> env
                                                                  <span style="color: #483d8b;">:go-env</span> go-env
                                                                  <span style="color: #483d8b;">:args</span> (cadr exp))))
    <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1089;&#1090;&#1072;&#1083;&#1086;</span>
    ((equal (car exp) 'block)    (list 'eval (caddr exp)
                                       env
                                       (acons (cadr exp)
                                              cont
                                              block-env)
                                       go-env catch-env errcont cont))
    ((equal (car exp) 'return-from)
     (<span style="color: #a020f0;">if</span> (not (symbolp (cadr exp)))
         (list 'return
               errcont
               (format
                nil
                <span style="color: #8b2252;">"return-from: first argument not a symbol"</span>))
         (list 'eval (caddr exp) env block-env go-env catch-env errcont
               (<span style="color: #a020f0;">lambda</span> (x)
                 (assoc-2 (cadr exp) block-env
                          (<span style="color: #a020f0;">lambda</span> (y)
                            (<span style="color: #a020f0;">if</span> (is-cont-subset y cont)
                                (list 'return y x)
                                (list 'return
                                      errcont
                                      (format nil <span style="color: #8b2252;">"return-from: attempt to RETURN-FROM to ~A that no longer exists"</span> (cadr exp)))))
                          (<span style="color: #a020f0;">lambda</span> (y)
                            (list 'return
                                  errcont (format nil <span style="color: #8b2252;">"return-from: undefined return block ~A"</span> y))))))))
    ((equal (car exp) 'catch)    (list 'eval (cadr exp) env block-env go-env catch-env errcont
                                       (make-catch-cont
                                        <span style="color: #483d8b;">:clauses</span> exp
                                        <span style="color: #483d8b;">:env</span> env
                                        <span style="color: #483d8b;">:block-env</span> block-env
                                        <span style="color: #483d8b;">:go-env</span> go-env
                                        <span style="color: #483d8b;">:catch-env</span> catch-env
                                        <span style="color: #483d8b;">:errcont</span> errcont
                                        <span style="color: #483d8b;">:cont</span> cont)))
    ((equal (car exp) 'throw)    (evthrow exp
                                          env block-env go-env catch-env
                                          errcont cont))
    ((equal (car exp) 'tagbody)  (tagbody-check-tag
                                  (cdr exp)
                                  (<span style="color: #a020f0;">lambda</span> ()
                                    (evtagbody (cdr exp) env block-env
                                               (make-go-env (cdr exp)
                                                            env block-env go-env catch-env
                                                            errcont cont)
                                               catch-env errcont cont))
                                  (<span style="color: #a020f0;">lambda</span> (x)
                                    (list 'return
                                          errcont
                                          (format
                                           nil
                                           <span style="color: #8b2252;">"tagbody: The tag ~A appears more than once in a tagbody"</span>
                                           x)))))
    ((equal (car exp) 'go)       (assoc-2 (cadr exp) go-env
                                          (<span style="color: #a020f0;">lambda</span> (go-cont)
                                            (apply-go-continuation go-cont))
                                          (<span style="color: #a020f0;">lambda</span> (go-label)
                                            (apply-continuation
                                             errcont
                                             (format nil <span style="color: #8b2252;">"go: wrong target ~A"</span> go-label)))))
    ((equal (car exp) 'labels)   (<span style="color: #a020f0;">let*</span> ((alist (mapcar (<span style="color: #a020f0;">lambda</span> (label) <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1092;&#1086;&#1088;&#1084;&#1080;&#1088;&#1091;&#1077;&#1084; &#1089;&#1087;&#1080;&#1089;&#1086;&#1082; &#1087;&#1072;&#1088; (&#1080;&#1084;&#1103; . nil)</span>
                                                         (cons (car label) nil))
                                                       (cadr exp)))
                                        (new-env (append alist env))   <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1076;&#1086;&#1073;&#1072;&#1074;&#1080;&#1084; &#1082; &#1089;&#1087;&#1080;&#1089;&#1082;&#1091; &#1087;&#1072;&#1088; &#1087;&#1088;&#1077;&#1076;&#1099;&#1076;&#1091;&#1097;&#1077;&#1077; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
                                        (closures (mapcar (<span style="color: #a020f0;">lambda</span> (label)
                                                            <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1089;&#1086;&#1079;&#1076;&#1072;&#1077;&#1084; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1077;, &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1102;&#1097;&#1077;&#1077; (env) &#1085;&#1072; &#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1085;&#1099;&#1077; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1099;&#1077; (&#1089;&#1086;&#1076;&#1077;&#1088;&#1078;&#1072;&#1097;&#1080;&#1077; &#1087;&#1086;&#1082;&#1072; nil)</span>
                                                            (make-closure <span style="color: #483d8b;">:body</span> (cddr label) <span style="color: #b22222;">;; </span><span style="color: #b22222;">implicit progn</span>
                                                                          <span style="color: #483d8b;">:block-env</span> block-env
                                                                          <span style="color: #483d8b;">:env</span> new-env
                                                                          <span style="color: #483d8b;">:go-env</span> go-env
                                                                          <span style="color: #483d8b;">:args</span> (cadr label)))
                                                          (cadr exp))))
                                   <span style="color: #b22222;">;; </span><span style="color: #b22222;">alist:    '((zzz . nil) (xxx . nil))</span>
                                   <span style="color: #b22222;">;; </span><span style="color: #b22222;">new-env:  '((zzz . nil) (xxx . nil) (old . #:closure))</span>
                                   <span style="color: #b22222;">;; </span><span style="color: #b22222;">closures: '(#:closure #:closure) ;; &#1091; &#1101;&#1090;&#1080;&#1093; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1081; :env &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; new-env</span>
                                   (<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (length alist) (length closures)))
                                   (<span style="color: #a020f0;">loop</span>
                                      <span style="color: #483d8b;">:for</span> aelt     <span style="color: #483d8b;">:in</span> alist
                                      <span style="color: #483d8b;">:for</span> closure  <span style="color: #483d8b;">:in</span> closures
                                      <span style="color: #483d8b;">:do</span> (rplacd aelt closure))
                                   <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1087;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084;:</span>
                                   <span style="color: #b22222;">;; </span><span style="color: #b22222;">alist:    '((zzz . #:closure) (xxx . #:closure))</span>
                                   <span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1048; &#1087;&#1077;&#1088;&#1077;&#1076;&#1072;&#1077;&#1084; new-env &#1074; &#1082;&#1072;&#1095;&#1077;&#1089;&#1090;&#1074;&#1077; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
                                   (evprogn (cddr exp) new-env block-env go-env catch-env errcont cont)))
    ((equal (car exp) 'reset)    (list 'return cont (myeval (cadr exp)
                                                            env block-env go-env catch-env
                                                            errcont #'identity)))
    ((equal (car exp) 'shift)    (list 'eval (caddr exp)
                                       (acons (cadr exp) cont env)
                                       block-env go-env catch-env
                                       errcont cont))
    (t
     (list 'eval (car exp) env block-env go-env catch-env errcont
           (<span style="color: #a020f0;">lambda</span> (x)
             (evlis x (cdr exp) nil env block-env go-env catch-env errcont cont))))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">STEPPER</span>
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">stepper</span> (frame)
  (<span style="color: #a020f0;">cond</span> ((equal (car frame) 'done)   (cadr frame))
        ((equal (car frame) 'error)  (cadr frame))
        ((equal (car frame) 'return) (stepper (apply #'apply-continuation (cdr frame))))
        ((equal (car frame) 'eval)   (stepper (apply #'myeval (cdr frame))))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1080;&#1088;&#1091;&#1077;&#1084; &#1085;&#1086;&#1074;&#1099;&#1081; lookup</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">test lookup</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"ok:123"</span> (<span style="color: #a020f0;">let</span> ((retval (lookup 'aaa '((aaa . 123))
                                              (<span style="color: #a020f0;">lambda</span> (x) (format nil <span style="color: #8b2252;">"err:~A"</span> x))
                                              (<span style="color: #a020f0;">lambda</span> (x) (format nil <span style="color: #8b2252;">"ok:~A"</span> x)))))
                          (apply-continuation (cadr retval) (caddr retval)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil      (<span style="color: #a020f0;">let</span> ((retval (lookup 'aaa '((bbb . 123))
                                              (<span style="color: #a020f0;">lambda</span> (x) (<span style="color: #a020f0;">declare</span> (ignore x)) nil)
                                              (<span style="color: #a020f0;">lambda</span> (x) (format nil <span style="color: #8b2252;">"ok:~A"</span> x)))))
                          (apply-continuation (cadr retval) (caddr retval)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1060;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080; &#1076;&#1083;&#1103; &#1090;&#1077;&#1089;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; CPS-&#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1081;</span>
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">ok</span> (x)
  (format t <span style="color: #8b2252;">"~%ok: ~A"</span> x)
  (list 'done x))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">err</span> (x)
  (format t <span style="color: #8b2252;">"~%err: ~A"</span> x)
  (list 'error x))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; MYAPPLY</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; cons, car, cdr</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (stepper (myeval '(cons 1 2) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 2) 3 . 4) (stepper (myeval '(cons (cons 1 2) (cons 3 4)) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (stepper (myeval '(car (cons 2 3)) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(cdr (cons 2 3)) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (stepper (myeval '(car (cons (cons 1 2) (cons 3 4)))
                                         nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 . 4) (stepper (myeval '(cdr (cons (cons 1 2) (cons 3 4)))
                                         nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; cons-&#1103;&#1095;&#1077;&#1077;&#1082;, &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1093; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (stepper (myeval '(car a) '((a . (1 . 2))) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (stepper (myeval '(cdr a) '((a . (1 . 2))) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(car b) '((a . (1 . 2)) (b . (3 . 4))) nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; NULL</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (stepper (myeval '(null ()) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (stepper (myeval '(null nil) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (stepper (myeval '(null T) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (stepper (myeval '(null a) '((a . ())) nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; NULL, &#1089; &#1072;&#1088;&#1075;&#1091;&#1084;&#1077;&#1085;&#1090;&#1086;&#1084;, &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1077; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (stepper (myeval '(null a) '((a . T)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (stepper (myeval '(null a) '((a . 1)) nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVADD</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0                (evadd '() 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2                (evadd '(2) 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 5                (evadd '(2 3) 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3 4)        (evadd '(2 3 4) 0)))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVMUL</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1                (evmul '() 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2                (evmul '(2) 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 6                (evmul '(2 3) 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3 4)        (evmul '(2 3 4) 1)))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0                (stepper (myeval '(+) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2)            (stepper (myeval '(+ 2) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3)          (stepper (myeval '(+ 2 3) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3 4)        (stepper (myeval '(+ 2 3 4) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 (+ 3 4))    (stepper (myeval '(+ 2 (+ 3 4)) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 (+ 3 4) 5)  (stepper (myeval '(+ 2 (+ 3 4) 5) nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1091;&#1084;&#1085;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1                (stepper (myeval '(*) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2)            (stepper (myeval '(* 2) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3)          (stepper (myeval '(* 2 3) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3 4)        (stepper (myeval '(* 2 3 4) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 (* 3 4))    (stepper (myeval '(* 2 (* 3 4)) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 (* 3 4) 5)  (stepper (myeval '(* 2 (* 3 4) 5) nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0
               (stepper (myeval '(+) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2))
                 (+ a))
               (stepper (myeval '(+ a)
                                '((a . 2))
                                nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3))
                 (+ a b))
               (stepper (myeval '(+ a b)
                                '((a . 2) (b . 3))
                                nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3) (c 4))
                 (+ a b c))
               (stepper (myeval '(+ a b c)
                                '((a . 2) (b . 3) (c . 4))
                                nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3) (c 4))
                 (+ a (+ b c)))
               (stepper (myeval '(+ a (+ b c))
                                '((a . 2) (b . 3) (c . 4))
                                nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3) (c 4) (d 5))
                 (+ a (+ b c) d))
               (stepper (myeval '(+ a (+ b c) d)
                                '((a . 2) (b . 3) (c . 4) (d . 5))
                                nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1091;&#1084;&#1085;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;  &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1
               (stepper (myeval '(*) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2))
                 (* a))
               (stepper (myeval '(* a)
                                '((a . 2))
                                nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3))
                 (* a b))
               (stepper (myeval '(* a b)
                                '((a . 2) (b . 3))
                                nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3) (c 4))
                 (* a b c))
               (stepper (myeval '(* a b c)
                                '((a . 2) (b . 3) (c . 4))
                                nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3) (c 4))
                 (* a (* b c)))
               (stepper (myeval '(* a (* b c))
                                '((a . 2) (b . 3) (c . 4))
                                nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 2) (b 3) (c 4) (d 5))
                 (* a (* b c) d))
               (stepper (myeval '(* a (* b c) d)
                                '((a . 2) (b . 3) (c . 4) (d . 5))
                                nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1087;&#1088;&#1080;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1103; CLOSURE</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (stepper (myeval '(((<span style="color: #a020f0;">lambda</span> (x)
                                       (<span style="color: #a020f0;">lambda</span> (y) x))
                                     1)
                                    2)
                                  nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; PRINT &#1074; &#1089;&#1088;&#1072;&#1074;&#1085;&#1077;&#1085;&#1080;&#1080; &#1089; host-&#1086;&#1074;&#1099;&#1084; print</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (format nil <span style="color: #8b2252;">"~%~A ~%ok: ~A"</span> 12 12)
               (<span style="color: #a020f0;">with-output-to-string</span> (*standard-output*)
                 (stepper (myeval '(print 12) nil nil nil nil #'err #'ok)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (print 12)
               (stepper (myeval '(print 12) nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; PRINT &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (format nil <span style="color: #8b2252;">"~%~A ~%ok: ~A"</span> 12 12)
               (<span style="color: #a020f0;">with-output-to-string</span> (*standard-output*)
                 (stepper (myeval '(print a)
                                  '((b . 23) (a . 12))
                                  nil nil nil #'err #'ok)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (print 12)
               (stepper (myeval '(print a)
                                '((b . 23) (a . 12))
                                nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LIST</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 14) (stepper (myeval '(list 1 (+ 2 (* 3 4)))
                                        nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (stepper (myeval '(list (+ 1 2) (* 2 3) 42) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (stepper (myeval '(list (+ a b) (* b c) 42)
                                '((a . 1) (b . 2) (c . 3) (d . 4))
                                nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; CALL/CC</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 14 (stepper (myeval '(+ 1 2 (call/cc (<span style="color: #a020f0;">lambda</span> (x) (+ 3 4) (x (+ 5 6)) (+7 8))))
                                   nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; MYEVAL</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1072;&#1084;&#1086;&#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1093; &#1092;&#1086;&#1088;&#1084;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (stepper (myeval 'T nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (stepper (myeval 'NIL nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 999 (stepper (myeval 999 nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1077;&#1085;&#1080;&#1103; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 6 (stepper (myeval 'b '((a . 3) (b . 6)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal #'err (cadr (myeval 'b nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; QUOTE</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(+ 1 2) (stepper (myeval '(quote (+ 1 2)) nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; IF</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (stepper (myeval '(<span style="color: #a020f0;">if</span> () 1 2) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (stepper (myeval '(<span style="color: #a020f0;">if</span> (null ()) 1 2) nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; IF, &#1075;&#1076;&#1077; &#1091;&#1089;&#1083;&#1086;&#1074;&#1080;&#1077; &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1090;&#1089;&#1103; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (stepper (myeval '(<span style="color: #a020f0;">if</span> a 1 2) '((a . ())) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (stepper (myeval '(<span style="color: #a020f0;">if</span> a 1 2) '((a . 1)) nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; COND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (stepper (myeval '(<span style="color: #a020f0;">cond</span>
                                    (() 1)
                                    (1 2))
                                  nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (stepper (myeval '(<span style="color: #a020f0;">cond</span>
                                    (a 1)
                                    (b 2))
                                  '((a . ()) (b . 1))
                                  nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (stepper (myeval '(<span style="color: #a020f0;">cond</span>
                                    (a 1)
                                    (b 2))
                                  '((a . 1) (b . ()))
                                  nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; PROGN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(<span style="color: #a020f0;">progn</span> 1 2 3) nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; PROGN &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(<span style="color: #a020f0;">progn</span> a b c) '((a . 1) (b . 2) (c . 3))
                                  nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; AND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and)                (stepper (myeval '(and) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1)              (stepper (myeval '(and 1) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and nil)            (stepper (myeval '(and nil) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 nil)          (stepper (myeval '(and 1 nil) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 nil)        (stepper (myeval '(and 1 2 nil) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 3)          (stepper (myeval '(and 1 2 3) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 (and 1 2) 3)  (stepper (myeval '(and 1 (and 1 2) 3) nil nil nil nil
                                                     #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 (and 1 nil) 3)  (stepper (myeval '(and 1 (and 1 nil) 3) nil nil nil nil
                                                       #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; AND &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a nil))
                 (and nil))
               (stepper (myeval '(and a) '((a . nil)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 1))
                 (and a))
               (stepper (myeval '(and a) '((a . 1)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 1)
                     (b nil))
                 (and a b))
               (stepper (myeval '(and a b) '((a . 1) (b . nil)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 1)
                     (b 2)
                     (c nil))
                 (and a b c))
               (stepper (myeval '(and a b c) '((a . 1) (b . 2) (c . nil)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a b c))
               (stepper (myeval '(and a b c) '((a . 1) (b . 2) (c . 3)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a (and a b) c))
               (stepper (myeval '(and a (and a b) c) '((a . 1) (b . 2) (c . 3)) nil nil nil
                                #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 1)
                     (b nil)
                     (c 3))
                 (and a (and a b) c))
               (stepper (myeval '(and a (and a b) c) '((a . 1) (b . nil) (c . 3)) nil nil nil
                                #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; OR</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or)                  (stepper (myeval '(or) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1)            (stepper (myeval '(or nil 1) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil nil 1)        (stepper (myeval '(or nil nil 1) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1 2)          (stepper (myeval '(or nil 1 2) nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil (or 3 2) 2)   (stepper (myeval '(or nil (or 3 2) 2) nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; OR &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a nil))
                 (or a))
               (stepper (myeval '(or a) '((a . nil)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a 1))
                 (or a))
               (stepper (myeval '(or a) '((a . 1)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a nil)
                     (b 1))
                 (or a b))
               (stepper (myeval '(or a b) '((a . nil) (b . 1)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a nil)
                     (b nil)
                     (c 3))
                 (or a b c))
               (stepper (myeval '(or a b c) '((a . nil) (b . nil) (c . 3)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a nil)
                     (b 1)
                     (c 2))
                 (or a b c))
               (stepper (myeval '(or a b c) '((a . nil) (b . 1) (c . 2)) nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">let</span> ((a nil)
                     (b nil)
                     (c nil)
                     (d 2))
                 (or a (or b c) d))
               (stepper (myeval '(or  a (or b c) d) '((a . nil) (b . nil) (c . nil) (d . 2))
                                nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; MYPAIRLIS</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(( a . 1) (b . 2) ( c . 3) (z . 6) (y . 77))
               (mypairlis '(a b c) '(1 2 3) '((z . 6) (y . 77)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"error"</span>
               (<span style="color: #a020f0;">handler-case</span> (mypairlis '(a b c) nil '((z . 6) (y . 77)))
                 (MYPAIRLIS-ERROR (condition) <span style="color: #8b2252;">"error"</span>))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"error"</span>
               (<span style="color: #a020f0;">handler-case</span> (mypairlis nil '(1 2 3) '((z . 6) (y . 77)))
                 (MYPAIRLIS-ERROR (condition) <span style="color: #8b2252;">"error"</span>))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LET</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (stepper (myeval '(<span style="color: #a020f0;">let</span> ((a 1)
                                                (b 2))
                                           (cons a b))
                                         nil nil nil nil
                                         #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LET*</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 1 . 2) (stepper (myeval '(<span style="color: #a020f0;">let*</span> ((a 1)
                                                   (b 2)
                                                   (c (+ a b)))
                                             (cons c (cons a b)))
                                           nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; DEFUN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 64 (<span style="color: #a020f0;">progn</span>
                    (setf *glob-env* nil)
                    (stepper (myeval '(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">alfa</span> (x) (* x x)) nil nil nil nil #'err #'ok))
                    (<span style="color: #a020f0;">prog1</span> (stepper (myeval '(alfa 8) nil nil nil nil #'err #'ok))
                      (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1085;&#1072; IMPLICIT-PROGN &#1074; DEFUN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 384 (<span style="color: #a020f0;">progn</span>
                     (setf *glob-env* nil)
                     (stepper (myeval '(<span style="color: #a020f0;">let</span> ((y 3))
                                        (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">alfa</span> (x)
                                          (setq y 6)
                                          (* x x y)))
                                      nil nil nil nil #'err #'ok))
                     (<span style="color: #a020f0;">prog1</span> (stepper (myeval '(alfa 8) nil nil nil nil #'err #'ok))
                       (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; SETQ</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1082;&#1072; &#1080;&#1079;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1103; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; &#1083;&#1086;&#1082;&#1072;&#1083;&#1100;&#1085;&#1086;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;, &#1085;&#1077; &#1079;&#1072;&#1090;&#1088;&#1072;&#1075;&#1080;&#1074;&#1072;&#1103; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1086;&#1075;&#1086; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((2 . 2) ((alfa . 0)))
               (<span style="color: #a020f0;">progn</span>
                 (setf *glob-env* '((alfa . 0)))
                 (<span style="color: #a020f0;">prog1</span> (list (stepper (myeval '(cons (setq alfa 2)
                                                 alfa)
                                               '((alfa . 1))
                                               nil nil nil #'err #'ok))
                              *glob-env*)
                   (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1048;&#1079;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; &#1085;&#1077;&#1089;&#1091;&#1097;&#1077;&#1089;&#1090;&#1074;&#1091;&#1102;&#1097;&#1077;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081; (&#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1080;&#1077; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1086;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;)</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 1) ((ALFA . 1) (BETA . 222)))
               (<span style="color: #a020f0;">progn</span>
                 (setf *glob-env* '((beta . 222)))
                 (<span style="color: #a020f0;">prog1</span> (list (stepper (myeval '(cons
                                                 (setq alfa 1)
                                                 alfa)
                                               nil nil nil nil #'err #'ok))
                              *glob-env*)
                   (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1048;&#1079;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; &#1089;&#1091;&#1097;&#1077;&#1089;&#1090;&#1074;&#1091;&#1102;&#1097;&#1077;&#1081; &#1075;&#1083;&#1086;&#1073;&#1072;&#1083;&#1100;&#1085;&#1086;&#1081; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 1) ((BETA . 1)))
               (<span style="color: #a020f0;">progn</span>
                 (setf *glob-env* '((beta . 222)))
                 (<span style="color: #a020f0;">prog1</span> (list (stepper (myeval '(cons
                                                 (setq beta 1)
                                                 beta)
                                               nil nil nil nil #'err #'ok))
                              *glob-env*)
                   (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LAMBDA</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '((<span style="color: #a020f0;">lambda</span> (x) (+ 1  x)) 2)
                                  nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LAMBDA &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 5 (stepper (myeval '(<span style="color: #a020f0;">let</span> ((y 3))
                                    ((<span style="color: #a020f0;">lambda</span> (x) (+ y x)) 2))
                                  nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1085;&#1072; IMPLICIT-PROGN &#1074; LAMBDA</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 8 (stepper (myeval '(<span style="color: #a020f0;">let</span> ((y 3))
                                    ((<span style="color: #a020f0;">lambda</span> (x)
                                       (setq y 6)
                                       (+ y x)) 2))
                                  nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; BLOCK</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (stepper (myeval '(<span style="color: #a020f0;">block</span> testblock)
                                    nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(<span style="color: #a020f0;">block</span> testblock 3)
                                  nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; RETURN-FROM</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(<span style="color: #a020f0;">block</span> testblock (<span style="color: #a020f0;">return-from</span> testblock (+ 1 2)) 777)
                                  nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal  <span style="color: #8b2252;">"return-from: undefined return block NOTBLOCK"</span>
                (stepper (myeval '(<span style="color: #a020f0;">block</span> testblock (<span style="color: #a020f0;">return-from</span> notblock (+ 1 2)) 777)
                                 nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"return-from: undefined return block NOT-FOUND-BLOCK"</span>
               (stepper (myeval '(<span style="color: #a020f0;">progn</span> (<span style="color: #a020f0;">return-from</span> not-found-block (+ 1 2)) 777)
                                nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; RETURN-FROM &#1074; &#1083;&#1077;&#1082;&#1089;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 12 (<span style="color: #a020f0;">progn</span>
                    (setf *glob-env* nil)
                    (<span style="color: #a020f0;">prog1</span> (stepper (myeval '(<span style="color: #a020f0;">progn</span>
                                              (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                                (<span style="color: #a020f0;">block</span> in-lambda-block
                                                  (<span style="color: #a020f0;">return-from</span> in-lambda-block
                                                    (+ x 2))
                                                  777))
                                              (foo 10))
                                            nil nil nil nil #'err #'ok))
                      (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; RETURN-FROM &#1074; &#1076;&#1080;&#1085;&#1072;&#1084;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080; (&#1076;&#1086;&#1083;&#1078;&#1085;&#1072; &#1073;&#1099;&#1090;&#1100; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072;)</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"return-from: undefined return block IN-LAMBDA-BLOCK"</span>
               (<span style="color: #a020f0;">progn</span>
                 (setf *glob-env* nil)
                 (<span style="color: #a020f0;">prog1</span> (stepper (myeval '(<span style="color: #a020f0;">progn</span>
                                           (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                             (<span style="color: #a020f0;">return-from</span> in-lambda-block
                                               (+ x 2))
                                             777)
                                           (<span style="color: #a020f0;">block</span> in-lambda-block
                                             (foo 10)))
                                         nil nil nil nil #'err #'ok))
                   (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; &#1085;&#1072; &#1086;&#1096;&#1080;&#1073;&#1082;&#1091; &#1085;&#1077;&#1076;&#1086;&#1089;&#1090;&#1080;&#1078;&#1080;&#1084;&#1086;&#1075;&#1086; &#1073;&#1083;&#1086;&#1082;&#1072;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"return-from: attempt to RETURN-FROM to THE-BLOCK that no longer exists"</span>
               (stepper (myeval '((<span style="color: #a020f0;">block</span> the-block (<span style="color: #a020f0;">lambda</span> () (<span style="color: #a020f0;">return-from</span> the-block nil))))
                                nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; &#1085;&#1072; &#1086;&#1090;&#1089;&#1091;&#1090;&#1089;&#1090;&#1074;&#1080;&#1077; &#1086;&#1096;&#1080;&#1073;&#1082;&#1080; &#1087;&#1088;&#1080; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1077; &#1074; &#1076;&#1086;&#1089;&#1090;&#1080;&#1078;&#1080;&#1084;&#1099;&#1081; &#1073;&#1083;&#1086;&#1082;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 123 (stepper (myeval '(<span style="color: #a020f0;">block</span> the-block (<span style="color: #a020f0;">return-from</span> the-block 123))
                                    nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; CATCH</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (stepper (myeval '(<span style="color: #a020f0;">catch</span> '<span style="color: #008b8b;">zzz</span>)
                                    nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(<span style="color: #a020f0;">catch</span> '<span style="color: #008b8b;">zzz</span> 3)
                                  nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; THROW</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (stepper (myeval '(<span style="color: #a020f0;">catch</span> '<span style="color: #008b8b;">testcatch</span> (<span style="color: #a020f0;">throw</span> '<span style="color: #008b8b;">testcatch</span> (+ 1 2)) 777)
                                  nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"throw: matching NOTCATCH catch is not found"</span>
               (stepper (myeval '(<span style="color: #a020f0;">catch</span> '<span style="color: #008b8b;">testcatch</span> (<span style="color: #a020f0;">throw</span> '<span style="color: #008b8b;">notcatch</span> (+ 1 2)) 777)
                                nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #8b2252;">"throw: matching NOT-FOUND-CATCH catch is not found"</span>
               (stepper (myeval '(<span style="color: #a020f0;">progn</span> (<span style="color: #a020f0;">throw</span> '<span style="color: #008b8b;">not-found-catch</span> (+ 1 2)) 777)
                                nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; THROW &#1074; &#1083;&#1077;&#1082;&#1089;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 12 (<span style="color: #a020f0;">progn</span>
                    (setf *glob-env* nil)
                    (<span style="color: #a020f0;">prog1</span> (stepper (myeval '(<span style="color: #a020f0;">progn</span>
                                              (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                                (<span style="color: #a020f0;">catch</span> '<span style="color: #008b8b;">in-lambda-catch</span>
                                                  (<span style="color: #a020f0;">throw</span> '<span style="color: #008b8b;">in-lambda-catch</span>
                                                    (+ x 2))
                                                  777))
                                              (foo 10))
                                            nil nil nil nil #'err #'ok))
                      (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090; THROW &#1074; &#1076;&#1080;&#1085;&#1072;&#1084;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1081; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1074;&#1080;&#1076;&#1080;&#1084;&#1086;&#1089;&#1090;&#1080; (&#1076;&#1086;&#1083;&#1078;&#1085;&#1086; &#1089;&#1088;&#1072;&#1073;&#1086;&#1090;&#1072;&#1090;&#1100;)</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 12 (<span style="color: #a020f0;">progn</span>
                    (setf *glob-env* nil)
                    (<span style="color: #a020f0;">prog1</span> (stepper (myeval '(<span style="color: #a020f0;">progn</span>
                                              (<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">foo</span> (x)
                                                (<span style="color: #a020f0;">throw</span> '<span style="color: #008b8b;">in-lambda-catch</span>
                                                  (+ x 2))
                                                777)
                                              (<span style="color: #a020f0;">catch</span> '<span style="color: #008b8b;">in-lambda-catch</span>
                                                (foo 10)))
                                            nil nil nil nil #'err #'ok))
                      (setf *glob-env* nil)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; TAGBODY</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (stepper (myeval '(<span style="color: #a020f0;">tagbody</span> a 1)
                                    nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (stepper (myeval '(<span style="color: #a020f0;">tagbody</span> a 1 b 2)
                                    nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; GO</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 4) (stepper (myeval '(<span style="color: #a020f0;">let</span> ((alfa 0))
                                           (<span style="color: #a020f0;">tagbody</span>
                                            a (setq alfa 1)
                                            b (<span style="color: #a020f0;">go</span> d)
                                            c (setq alfa (cons alfa 3))
                                            d (setq alfa (cons alfa 4)))
                                           alfa)
                                         nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; "&#1086;&#1073;&#1088;&#1072;&#1090;&#1085;&#1086;&#1075;&#1086; &#1093;&#1086;&#1076;&#1072;" GO</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 5) (stepper (myeval '(<span style="color: #a020f0;">let</span> ((alfa 0))
                                           (<span style="color: #a020f0;">tagbody</span>
                                            a (<span style="color: #a020f0;">go</span> d)
                                            b (setq alfa 1)
                                            c (<span style="color: #a020f0;">go</span> e)
                                            d (<span style="color: #a020f0;">go</span> b)
                                            e (setq alfa (cons alfa 5)))
                                           alfa)
                                         nil nil nil nil #'err #'ok))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LABELS</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">labels</span> ((zzz (lst acc)
                          (print acc)
                          (<span style="color: #a020f0;">cond</span> ((null lst) acc)
                                (t (zzz (cdr lst) (+ 1 acc))))))
                 (print 888)
                 (zzz '(1 2 3) 0))
               (stepper (myeval '(<span style="color: #a020f0;">labels</span> ((zzz (lst acc)
                                           (print acc)
                                           (<span style="color: #a020f0;">cond</span> ((null lst) acc)
                                                 (t (zzz (cdr lst) (+ 1 acc))))))
                                  (print 888)
                                  (zzz '(1 2 3) 0))
                                nil nil nil nil #'err #'ok))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #a020f0;">with-output-to-string</span> (*standard-output*)
                 (<span style="color: #a020f0;">labels</span> ((zzz (lst acc)
                            (print acc)
                            (<span style="color: #a020f0;">cond</span> ((null lst) acc)
                                  (t (zzz (cdr lst) (+ 1 acc))))))
                   (print 888)
                   (zzz '(1 2 3) 0)
                   (format t <span style="color: #8b2252;">"~%ok: 3"</span>)))
               (<span style="color: #a020f0;">with-output-to-string</span> (*standard-output*)
                 (stepper (myeval '(<span style="color: #a020f0;">labels</span> ((zzz (lst acc)
                                             (print acc)
                                             (<span style="color: #a020f0;">cond</span> ((null lst) acc)
                                                   (t (zzz (cdr lst) (+ 1 acc))))))
                                    (print 888)
                                    (zzz '(1 2 3) 0))
                                  nil nil nil nil #'err #'ok)))))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; RESET</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(assert (equal 8 (stepper (myeval '(progn</span>
<span style="color: #b22222;">;;                             </span><span style="color: #b22222;">(+ 1 (reset (+ 2 3)) 2))</span>
<span style="color: #b22222;">;;                             </span><span style="color: #b22222;">nil nil nil nil #'err #'ok))))</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; SHIFT/RESET</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(assert (equal 44 (stepper (myeval '(let ((foo))</span>
<span style="color: #b22222;">;;                             </span><span style="color: #b22222;">(+ 1 (reset (+ 2 (shift f (progn (setq foo f) 4)))))</span>
<span style="color: #b22222;">;;                             </span><span style="color: #b22222;">(foo 42))</span>
<span style="color: #b22222;">;;                           </span><span style="color: #b22222;">nil nil nil nil #'err #'ok))))</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">REPL</span>
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">repl</span> (prompt catch-env errcont cont)
  (format t <span style="color: #8b2252;">"~%~A&gt; "</span> prompt)
  (finish-output)
  (myeval (read) nil nil nil (acons 'exit cont catch-env)
          #'(<span style="color: #a020f0;">lambda</span> (x)
              (princ x)
              (terpri)
              (finish-output)
              (repl prompt catch-env errcont cont))
          #'(<span style="color: #a020f0;">lambda</span> (x)
              (princ x)
              (terpri)
              (finish-output)
              (repl prompt catch-env errcont cont))))
(<span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">repl</span> ()
  (princ <span style="color: #8b2252;">"microlisp&gt;"</span>)
  (finish-output)
  (stepper (list 'eval (read) nil nil nil nil #'err #'ok))
  (terpri)
  (finish-output)
  (repl))
<span style="color: #b22222;">;; </span><span style="color: #b22222;">(repl)</span>
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
