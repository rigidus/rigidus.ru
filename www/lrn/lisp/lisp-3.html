<!DOCTYPE html>
<html>
<head>
<title>lisp-3</title>
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="rigidus">
<link href="/css/style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="content">
<h1 class="title">lisp-3</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">План работ</a></li>
<li><a href="#sec-2">Окружения и MyApply</a>
<ul>
<li><a href="#sec-2-1">Работа с CONS-ячейками</a></li>
<li><a href="#sec-2-2">NULL-предикат</a></li>
<li><a href="#sec-2-3">Встроенные функции арифметики</a></li>
<li><a href="#sec-2-4"><span class="done CANCEL">CANCEL</span> Вычисление символов-функций</a></li>
<li><a href="#sec-2-5"><span class="done CANCEL">CANCEL</span> LAMBDA</a></li>
</ul>
</li>
<li><a href="#sec-3">MyEval</a>
<ul>
<li><a href="#sec-3-1">Самовычисляемые формы</a></li>
<li><a href="#sec-3-2">Вычисление символов</a></li>
<li><a href="#sec-3-3">Цитирование</a></li>
<li><a href="#sec-3-4">Условное выполнение IF</a></li>
<li><a href="#sec-3-5">COND</a></li>
<li><a href="#sec-3-6">PROGN</a></li>
<li><a href="#sec-3-7">PRINT</a></li>
<li><a href="#sec-3-8">LIST</a></li>
<li><a href="#sec-3-9">AND</a></li>
<li><a href="#sec-3-10">OR</a></li>
<li><a href="#sec-3-11">LET</a></li>
<li><a href="#sec-3-12">LET*</a></li>
<li><a href="#sec-3-13">DEFUN</a></li>
<li><a href="#sec-3-14">SETQ</a></li>
<li><a href="#sec-3-15">LAMBDA</a></li>
</ul>
</li>
<li><a href="#sec-4">REPL</a></li>
<li><a href="#sec-5">Итоги</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">План работ</h2>
<div class="outline-text-2" id="text-1">
<p>
Цель этого этапа - создание лексического окружения (в дополнение к динамическому
окружению и глобальному окружению, которые у нас уже есть). Так мы решаем
<code>funarg-problem</code>, проблему функционального аргумента. Проблема возникает в программах
на языках, которые поддерживают функции как объекты первого класса (first-class
sitizens): позволяюn передавать функции в качестве параметров и возвращать функции из
функций.
</p>

<p>
<code>funarg problem</code> возникает, когда тело определяемой функции ссылается на
идентификаторы, которые определены в окружении, где функция определяется. В то время
как мы бы хотели, чтобы ссылки вели на окружение, в котором функция вызывается.
</p>

<p>
Есть 2 типа этой проблемы:
</p>
<ul class="org-ul">
<li>downward - когда в функцию передается функция [TODO:gmm] Подробнее, с примером
</li>
<li>upward - когда вызывающая функция ссылается на окружение вызываемой после завершения
вызова
</li>
</ul>

<p>
В качестве примера <code>upward</code> возьмем такой код:
</p>

<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #af0000;">;; </span><span style="color: #af0000;">UPWARD FUNARG PROBLEM</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1057;&#1086;&#1079;&#1076;&#1072;&#1076;&#1080;&#1084; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1102; F, &#1082;&#1086;&#1090;&#1086;&#1088;&#1072;&#1103; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1102; &#1074; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1080; &#1087;&#1086; X</span>
(setq f (<span style="color: #af00ff;">lambda</span> (x)
           (<span style="color: #af00ff;">lambda</span> (y)
             (+ x y))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1057; &#1087;&#1086;&#1084;&#1086;&#1097;&#1100;&#1102; F &#1089;&#1086;&#1079;&#1076;&#1072;&#1076;&#1080;&#1084; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1102; G</span>
(setq g (funcall f 5))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1042; &#1101;&#1090;&#1086;&#1081; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080; X &#1089;&#1089;&#1099;&#1083;&#1072;&#1077;&#1090;&#1089;&#1103; &#1085;&#1072; 10, &#1085;&#1086; &#1087;&#1086;&#1089;&#1083;&#1077; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1072; &#1080;&#1079; FUNCALL &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;, &#1075;&#1076;&#1077; X=10</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1091;&#1078;&#1077; &#1085;&#1077; &#1089;&#1091;&#1097;&#1077;&#1089;&#1090;&#1074;&#1091;&#1077;&#1090;</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1090;&#1091;&#1090; &#1087;&#1088;&#1080; &#1074;&#1099;&#1079;&#1086;&#1074;&#1077; Y=10, &#1072; X &#1089;&#1089;&#1099;&#1083;&#1072;&#1077;&#1090;&#1089;&#1103; &#1085;&#1072; &#1085;&#1077;&#1089;&#1091;&#1097;&#1077;&#1089;&#1090;&#1074;&#1091;&#1102;&#1097;&#1077;&#1077; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
(funcall g 10)

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1063;&#1090;&#1086;&#1073;&#1099; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1074;&#1077;&#1088;&#1085;&#1099;&#1081; &#1086;&#1090;&#1074;&#1077;&#1090; (15) &#1085;&#1091;&#1078;&#1085;&#1086; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1090;&#1100; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077; &#1074; &#1084;&#1086;&#1084;&#1077;&#1085;&#1090; &#1089;&#1086;&#1079;&#1076;&#1072;&#1085;&#1080;&#1103; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1103;</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1090;&#1086;&#1075;&#1076;&#1072; &#1076;&#1072;&#1078;&#1077; &#1090;&#1072;&#1082;&#1086;&#1081; &#1082;&#1086;&#1076; &#1073;&#1091;&#1076;&#1077;&#1090; &#1076;&#1072;&#1074;&#1072;&#1090;&#1100; 15</span>
(<span style="color: #af00ff;">let</span> ((x 30))
  (funcall g 10))
</pre>
</div>

<p>
Еще один интересный пример <code>upward</code> funarg problem:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">compose</span> (f g)
  (<span style="color: #af00ff;">lambda</span> (x) (funcall f (funcall g x))))

(funcall (compose #'car #'cdr) '(1 2 3 4))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1041;&#1086;&#1083;&#1077;&#1077; &#1088;&#1072;&#1079;&#1074;&#1077;&#1088;&#1085;&#1091;&#1090;&#1099;&#1081; &#1074;&#1072;&#1088;&#1080;&#1072;&#1085;&#1090; &#1101;&#1090;&#1086;&#1075;&#1086;:</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1057;&#1086;&#1079;&#1076;&#1072;&#1076;&#1080;&#1084; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1102; COMPOSE, &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1091;&#1102; &#1083;&#1103;&#1084;&#1073;&#1076;&#1091;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1072;&#1103;</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1088;&#1080;&#1084;&#1077;&#1085;&#1077;&#1085;&#1103;&#1077;&#1090; &#1087;&#1077;&#1088;&#1074;&#1099;&#1081; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1086;&#1085;&#1072;&#1083;&#1100;&#1085;&#1099;&#1081; &#1072;&#1088;&#1075;&#1091;&#1084;&#1077;&#1085;&#1090; &#1082;&#1086; &#1074;&#1090;&#1086;&#1088;&#1086;&#1084;&#1091;.</span>
(setq compose (<span style="color: #af00ff;">lambda</span> (f g)
                (<span style="color: #af00ff;">lambda</span> (x)
                  (funcall f (funcall g x)))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1057;&#1086;&#1079;&#1076;&#1072;&#1076;&#1080;&#1084; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1102; F, &#1082;&#1086;&#1090;&#1086;&#1088;&#1072;&#1103; &#1103;&#1074;&#1083;&#1103;&#1077;&#1090;&#1089;&#1103; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1077;&#1081;,</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1088;&#1080;&#1084;&#1077;&#1085;&#1103;&#1102;&#1097;&#1080;&#1081; CAR &#1082; CDR</span>
(setq f (funcall compose #'car #'cdr))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1042;&#1099;&#1079;&#1086;&#1074;&#1077;&#1084; &#1087;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1085;&#1091;&#1102; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1102; F &#1086;&#1090; &#1089;&#1087;&#1080;&#1089;&#1082;&#1072; (&#1093;&#1086;&#1090;&#1080;&#1084; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; 2)</span>
(funcall f '(1 2 3 4))
</pre>
</div>

<p>
Когда мы возвращаем лямбду из <code>compose</code> мы теряем окружение (динамическое окружение,
содержащее <code>f</code> и <code>g</code> осталось в месте где лямбда определялась) и у нас нет никакого
способа применить <code>f</code> к <code>(funcall g x)</code>, так как у нас уже нет <code>g</code> в окружении.
</p>

<p>
Таким образом это <code>upward</code> funarg problem [TODO:gmm] Правильно рассуждаю?
[TODO:gmm] Нужен корректный пример <code>downward</code> funarg problem
</p>

<p>
Нам нужно уметь замыкать окружение лексически, тогда лямбда возвратит замыкание, где у
нас будут связанные <code>f</code> и <code>g</code>.
</p>

<p>
Трассировка выполнения еще более наглядно поясняет <code>upward</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1088;&#1072;&#1089;&#1089;&#1080;&#1088;&#1091;&#1077;&#1084; &#1090;&#1072;&#1082;&#1086;&#1081; &#1082;&#1086;&#1076;:</span>
(((<span style="color: #af00ff;">lambda</span> (x)
    (<span style="color: #af00ff;">lambda</span> (y) x))
  1)
 2)

0: (MYEVAL (((<span style="color: #af00ff;">LAMBDA</span> (X) (<span style="color: #af00ff;">LAMBDA</span> (Y) X)) 1) 2) NIL)
  1: (MYEVAL ((<span style="color: #af00ff;">LAMBDA</span> (X) (<span style="color: #af00ff;">LAMBDA</span> (Y) X)) 1) NIL)
    2: (MYEVAL (<span style="color: #af00ff;">LAMBDA</span> (X) (<span style="color: #af00ff;">LAMBDA</span> (Y) X)) NIL)       <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084; car &#1092;&#1086;&#1088;&#1084;&#1099;</span>
    2: MYEVAL returned (<span style="color: #af00ff;">LAMBDA</span> (X) (<span style="color: #af00ff;">LAMBDA</span> (Y) X))    <span style="color: #af0000;">;; </span><span style="color: #af0000;">lambda &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1090;&#1089;&#1103; &#1074; &#1089;&#1077;&#1073;&#1103;</span>
    2: (MYEVAL 1 NIL)                                 <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084; &#1087;&#1077;&#1088;&#1074;&#1099;&#1081; &#1072;&#1088;&#1075;&#1091;&#1084;&#1077;&#1090; 1</span>
    2: MYEVAL returned 1                              <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1095;&#1080;&#1089;&#1083;&#1072; &#1089;&#1072;&#1084;&#1086;&#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1080;&#1084;&#1099;</span>
    2: (MYAPPLY (<span style="color: #af00ff;">LAMBDA</span> (X) (<span style="color: #af00ff;">LAMBDA</span> (Y) X)) (1) NIL)  <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1088;&#1080;&#1084;&#1077;&#1085;&#1103;&#1077;&#1084; &#1087;&#1077;&#1088;&#1074;&#1091;&#1102; &#1083;&#1103;&#1084;&#1073;&#1076;&#1091;</span>
      3: (MYEVAL (<span style="color: #af00ff;">LAMBDA</span> (Y) X) ((X . 1)))            <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1090;&#1077;&#1083;&#1086; &#1087;&#1077;&#1088;&#1074;&#1086;&#1081; &#1083;&#1103;&#1084;&#1073;&#1076;&#1099; -- &#1074;&#1090;&#1086;&#1088;&#1072;&#1103; &#1083;&#1103;&#1084;&#1073;&#1076;&#1072;  -&gt; &#1090;&#1091;&#1090; &#1073;&#1091;&#1076;&#1077;&#1090; &#1079;&#1072;&#1084;&#1099;&#1082;&#1072;&#1085;&#1080;&#1077;</span>
      3: MYEVAL returned (<span style="color: #af00ff;">LAMBDA</span> (Y) X)               <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1083;&#1103;&#1084;&#1073;&#1076;&#1072; &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1090;&#1089;&#1103; &#1074; &#1089;&#1077;&#1073;&#1103;</span>
    2: MYAPPLY returned (<span style="color: #af00ff;">LAMBDA</span> (Y) X)
  1: MYEVAL returned (<span style="color: #af00ff;">LAMBDA</span> (Y) X)
  1: (MYEVAL 2 NIL)                                   <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084; &#1074;&#1090;&#1086;&#1088;&#1086;&#1081; &#1072;&#1088;&#1075;&#1091;&#1084;&#1077;&#1085;&#1090;</span>
  1: MYEVAL returned 2                                <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1086;&#1085; &#1089;&#1072;&#1084;&#1086;&#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1080;&#1084;</span>
  1: (MYAPPLY (<span style="color: #af00ff;">LAMBDA</span> (Y) X) (2) NIL)                 <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1087;&#1088;&#1080;&#1084;&#1077;&#1085;&#1103;&#1077;&#1084; &#1083;&#1103;&#1084;&#1073;&#1076;&#1091; (&#1074;&#1090;&#1086;&#1088;&#1091;&#1102;), &#1085;&#1086; &#1086;&#1073;&#1088;&#1072;&#1090;&#1080; &#1074;&#1085;&#1080;&#1084;&#1072;&#1085;&#1080;&#1077; &#1085;&#1072; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
    2: (MYEVAL X ((Y . 2)))                           <span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1086;&#1082;&#1091;&#1088;&#1078;&#1077;&#1085;&#1080;&#1077; ((x . 1)) &#1087;&#1088;&#1086;&#1087;&#1072;&#1083;&#1086;</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">CL-&#1074;&#1072;&#1088;&#1080;&#1072;&#1085;&#1090;</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">mymapcar</span> (fn lst)
  (<span style="color: #af00ff;">cond</span> ((null lst) nil)
        (t (cons (funcall fn (car lst))
                 (mymapcar fn (cdr lst))))))


<span style="color: #af0000;">;; </span><span style="color: #af0000;">MICROLISP-&#1074;&#1072;&#1088;&#1080;&#1072;&#1085;&#1090;</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">mymapcar</span> (fn lst)
  (<span style="color: #af00ff;">cond</span> ((null lst) nil)
        (t (cons (fn (car lst))
                 (mymapcar fn (cdr lst))))))


(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">foo</span> (lst)
    (mymapcar (<span style="color: #af00ff;">lambda</span> (i) (cons i lst)) '(1 2 3)))

(foo '(a b c))

CL-USER&gt;
((1 a b c)
 (2 a b c)
 (3 a b c))

microlisp&gt;
((1 1 2 3) (2 2 3) (3 3))
</pre>
</div>

<p>
Теперь рассмотрим <code>downward</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #af0000;">;; </span><span style="color: #af0000;">DOWNWARD FUNARG PROBLEM</span>

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1057;&#1086;&#1079;&#1076;&#1072;&#1076;&#1080;&#1084; &#1089;&#1074;&#1086;&#1081; mapcar</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">mymapcar</span> (fn lst)
  (<span style="color: #af00ff;">cond</span> ((null lst) nil)
        (t (cons (funcall fn (car lst))
                 (mymapcar fn (cdr lst))))))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1057;&#1086;&#1079;&#1076;&#1072;&#1076;&#1080;&#1084; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1102; FOO, &#1082;&#1086;&#1090;&#1086;&#1088;&#1072;&#1103; &#1087;&#1088;&#1080;&#1085;&#1080;&#1084;&#1072;&#1077;&#1090; &#1089;&#1087;&#1080;&#1089;&#1086;&#1082; LST &#1080; &#1080;&#1089;&#1087;&#1086;&#1083;&#1100;&#1079;&#1091;&#1077;&#1090;</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">MYMAPCAR &#1095;&#1090;&#1086;&#1073;&#1099; &#1089;&#1082;&#1086;&#1085;&#1089;&#1080;&#1090;&#1100; &#1077;&#1075;&#1086; &#1089; &#1082;&#1072;&#1078;&#1076;&#1099;&#1084; &#1080;&#1079; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1086;&#1074; &#1089;&#1087;&#1080;&#1089;&#1082;&#1072; (1 2 3)</span>
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">foo</span> (lst)
  (mymapcar (<span style="color: #af00ff;">lambda</span> (i)
              (cons i lst))
            '(1 2 3)))

<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1050;&#1086;&#1075;&#1076;&#1072; &#1084;&#1099; &#1074;&#1099;&#1079;&#1086;&#1074;&#1077;&#1084; ... TODO</span>
(foo '(a b c))

<span style="color: #af00ff;">=&gt;</span> ((1 A B C)
    (2 A B C)
    (3 A B C))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Окружения и MyApply</h2>
<div class="outline-text-2" id="text-2">
<p>
Это глобальное окружение, которое было сделано на предыдущем этапе и функция поиска в
нем (<code>lookup</code>), тут ничего не поменялось.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="lookup_3">(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">*glob-env*</span> nil)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">lookup</span> (symb env)
  (<span style="color: #af00ff;">let</span> ((it (assoc symb env)))
    (<span style="color: #af00ff;">if</span> (not (null it))
        it
        (assoc symb *glob-env*))))
</pre>
</div>

<p>
Чтобы сделать лексическое окружение, нужно создать структуру замыкания:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="closure_3">(<span style="color: #af00ff;">defstruct</span> <span style="color: #008700;">closure</span>
  body
  env
  args)
</pre>
</div>

<p>
Когда нам нужно передать лямбду в функцию <code>apply</code> мы будем оборачивать ее в замыкание,
сохраняя окружение функции в нем.
</p>

<p>
Если во время применения функции <code>fn</code> к аргументам (т.е. в <code>apply</code>) в параметре <code>fn</code> мы
получаем структуру типа <code>closure</code>, то мы должны выполнить (т.е. сделать <code>eval</code>) ее поле
<code>closure-body</code> в составном окружении. Это составное окружение состоит из замкнутого
окружения, которое мы получаем из поля <code>closure-env</code> структуры и полученных функцией
<code>myapply</code> аргументов <code>args</code>.
</p>

<p>
Чтобы обеспечить <code>implicit progn</code> делаем <code>eval</code> через <code>evprogn</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_closure_3">((closure-p fn)              (evprogn (closure-body fn)
                                      (pairlis (closure-args fn)
                                               args
                                               (closure-env fn))))
</pre>
</div>

<p>
Этим куском кода мы заменяем обработку <code>lambda</code> внутри <code>myapply</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="errors_3">(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">unknown-function</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((fn <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:fn</span>  <span style="color: #5f5f87;">:reader</span> fn))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYAPPLY: unknown-function: ~A"</span>
             (fn condition)))))
</pre>
</div>

<p>
Нам также надо написать тесты, чтобы убедиться, что это работает правильно:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_closure_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1087;&#1088;&#1080;&#1084;&#1077;&#1085;&#1077;&#1085;&#1080;&#1103; CLOSURE</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(((<span style="color: #af00ff;">lambda</span> (x)
                              (<span style="color: #af00ff;">lambda</span> (y) x))
                            1)
                           2)
                         nil)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_3">&lt;&lt;evaddmul_3&gt;&gt;
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">myapply</span> (fn args env)
  (<span style="color: #af00ff;">cond</span>
    &lt;&lt;myapply_car_cdr_cons_3&gt;&gt;
    &lt;&lt;myapply_null_3&gt;&gt;
    &lt;&lt;myapply_ariph_3&gt;&gt;
    &lt;&lt;myapply_closure_3&gt;&gt;
    (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'unknown-function <span style="color: #5f5f87;">:fn</span> fn))))
</pre>
</div>

<p>
И отдельно вынесем тесты:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_3_test">&lt;&lt;myapply_car_cdr_cons_3_test&gt;&gt;
&lt;&lt;myapply_null_3_test&gt;&gt;
&lt;&lt;evaddmul_3_test&gt;&gt;
&lt;&lt;myapply_ariph_3_test&gt;&gt;
&lt;&lt;myapply_func_symb_3_test&gt;&gt;
&lt;&lt;myapply_closure_3_test&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">Работа с CONS-ячейками</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">

<pre class="src src-lisp" id="myapply_car_cdr_cons_3">((equal fn 'car)             (caar args))
((equal fn 'cdr)             (cdar args))
((equal fn 'cons)            (cons (car args) (cadr args)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_car_cdr_cons_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; cons-&#1103;&#1095;&#1077;&#1077;&#1082;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(cons 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 2) 3 . 4) (myeval '(cons (cons 1 2) (cons 3 4)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(car (cons 2 3)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(cdr (cons 2 3)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(car (cons (cons 1 2) (cons 3 4))) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 . 4) (myeval '(cdr (cons (cons 1 2) (cons 3 4))) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; cons-&#1103;&#1095;&#1077;&#1077;&#1082;, &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1093; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(car a) '((a . (1 . 2))))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(cdr a) '((a . (1 . 2))))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(car b) '((a . (1 . 2)) (b . (3 . 4))))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">NULL-предикат</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">

<pre class="src src-lisp" id="errors_3">(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">invalid-number-of-arguments</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((fn <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:fn</span>  <span style="color: #5f5f87;">:reader</span> fn))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYAPPLY: invalid-number-of-arguments: ~A"</span>
             (fn condition)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_null_3">((equal fn 'null)            (<span style="color: #af00ff;">if</span> (null (cdr args))
                                 (null (car args))
                                 (<span style="color: #ff0000; font-weight: bold;">error</span> 'invalid-number-of-arguments <span style="color: #5f5f87;">:fn</span> fn)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_null_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; NULL</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval '(null ()) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval '(null nil) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval '(null T) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval '(null a) '((a . ())))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; NULL, &#1089; &#1072;&#1088;&#1075;&#1091;&#1084;&#1077;&#1085;&#1090;&#1086;&#1084;, &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1077; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval '(null a) '((a . T)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval '(null a) '((a . 1)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3">Встроенные функции арифметики</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">

<pre class="src src-lisp" id="evaddmul_3">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evadd</span> (lst acc)
  (<span style="color: #af00ff;">cond</span> ((null lst)        0)
        ((null (cdr lst))  (+ acc (car lst)))
        (t                 (evadd (cdr lst)
                                  (+ acc (car lst))))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evmul</span> (lst acc)
  (<span style="color: #af00ff;">cond</span> ((null lst)        1)
        ((null (cdr lst))  (* acc (car lst)))
        (t                 (evmul (cdr lst)
                                  (* acc (car lst))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="evaddmul_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVADD</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0                (evadd '() 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2                (evadd '(2) 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 5                (evadd '(2 3) 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3 4)        (evadd '(2 3 4) 0)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVMUL</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1                (evmul '() 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2                (evmul '(2) 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 6                (evmul '(2 3) 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3 4)        (evmul '(2 3 4) 1)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_ariph_3">((equal fn '+)               (evadd args 0))
((equal fn '*)               (evmul args 1))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_ariph_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0                (myeval '(+) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2)            (myeval '(+ 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3)          (myeval '(+ 2 3) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3 4)        (myeval '(+ 2 3 4) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 (+ 3 4))    (myeval '(+ 2 (+ 3 4)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 (+ 3 4) 5)  (myeval '(+ 2 (+ 3 4) 5) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1091;&#1084;&#1085;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1                (myeval '(*) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2)            (myeval '(* 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3)          (myeval '(* 2 3) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3 4)        (myeval '(* 2 3 4) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 (* 3 4))    (myeval '(* 2 (* 3 4)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 (* 3 4) 5)  (myeval '(* 2 (* 3 4) 5) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0
               (myeval '(+) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2))
                 (+ a))
               (myeval '(+ a)
                       '((a . 2)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3))
                 (+ a b))
               (myeval '(+ a b)
                       '((a . 2) (b . 3)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (+ a b c))
               (myeval '(+ a b c)
                       '((a . 2) (b . 3) (c . 4)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (+ a (+ b c)))
               (myeval '(+ a (+ b c))
                       '((a . 2) (b . 3) (c . 4)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4) (d 5))
                 (+ a (+ b c) d))
               (myeval '(+ a (+ b c) d)
                       '((a . 2) (b . 3) (c . 4) (d . 5)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1091;&#1084;&#1085;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;  &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1
               (myeval '(*) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2))
                 (* a))
               (myeval '(* a)
                       '((a . 2)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3))
                 (* a b))
               (myeval '(* a b)
                       '((a . 2) (b . 3)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (* a b c))
               (myeval '(* a b c)
                       '((a . 2) (b . 3) (c . 4)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (* a (* b c)))
               (myeval '(* a (* b c))
                       '((a . 2) (b . 3) (c . 4)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4) (d 5))
                 (* a (* b c) d))
               (myeval '(* a (* b c) d)
                       '((a . 2) (b . 3) (c . 4) (d . 5)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><span class="done CANCEL">CANCEL</span> Вычисление символов-функций</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">

<pre class="src src-lisp" id="errors_3">(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">function-not-found-error</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((fn <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:fn</span>  <span style="color: #5f5f87;">:reader</span> fn))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYAPPLY: function not found: ~A"</span>
             (fn condition)))))
</pre>
</div>

<p>
Этот кейс удаляем, потому что у нас это вычисление теперь производится в myeval
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_func_symb_3_DELETED">((symbolp fn)                (<span style="color: #af00ff;">let</span> ((it (lookup fn env)))
                               (<span style="color: #af00ff;">if</span> (null it)
                                   (<span style="color: #ff0000; font-weight: bold;">error</span> 'function-not-found-error <span style="color: #5f5f87;">:fn</span> fn)
                                   (myapply (cdr it) args env))))
</pre>
</div>

<p>
И тест видоизменяется, чтобы проверить вычисление в глобальном окружении
</p>

<p>
[TODO:gmm] Тут я не уверен что правильный тест
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_func_symb_3_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 49 (<span style="color: #af00ff;">progn</span>
                    (setf *glob-env* nil)
                    (myeval '(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">alfa</span> (x) (* x x)) nil)
                    (myeval '(setq beta 7) nil)
                    (<span style="color: #af00ff;">prog1</span> (myeval '(alfa beta) nil)
                      (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(assert (equal "error"</span>
<span style="color: #af0000;">;;                </span><span style="color: #af0000;">(handler-case (myeval '(alfa beta) '((beta . 7)))</span>
<span style="color: #af0000;">;;                  </span><span style="color: #af0000;">(FUNCTION-NOT-FOUND-ERROR (condition) "error"))))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5"><span class="done CANCEL">CANCEL</span> LAMBDA</h3>
<div class="outline-text-3" id="text-2-5">
<p>
Этот код больше не используется, и будет удален в следующем файле. Вместо него мы
создаем замыкания
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_lambda_3">((equal (car fn) 'lambda)    (myeval (car (cddr fn))
                                     (pairlis (car (cdr fn))
                                              args
                                              env)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myapply_lambda_3_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(42 . 42) (myeval '((<span style="color: #af00ff;">lambda</span> (x)
                                      (cons x x))
                                    42) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(42 . 17) (myeval '((<span style="color: #af00ff;">lambda</span> (x y)
                                      (cons x y))
                                    42 17) nil)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">MyEval</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_3">&lt;&lt;myeval_evcond_3&gt;&gt;
&lt;&lt;myeval_evprogn_3&gt;&gt;
&lt;&lt;myeval_evlis_3&gt;&gt;
&lt;&lt;myeval_evand_3&gt;&gt;
&lt;&lt;myeval_evor_3&gt;&gt;
&lt;&lt;myeval_mypairlis_3&gt;&gt;
&lt;&lt;myeval_evletstar_3&gt;&gt;

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">myeval</span> (lst env)
  (<span style="color: #af00ff;">cond</span>
    &lt;&lt;myeval_number_3&gt;&gt;
    &lt;&lt;myeval_symb_3&gt;&gt;
    &lt;&lt;myeval_quote_3&gt;&gt;
    &lt;&lt;myeval_if_3&gt;&gt;
    &lt;&lt;myeval_cond_3&gt;&gt;
    &lt;&lt;myeval_progn_3&gt;&gt;
    &lt;&lt;myeval_print_3&gt;&gt;
    &lt;&lt;myeval_list_3&gt;&gt;
    &lt;&lt;myeval_and_3&gt;&gt;
    &lt;&lt;myeval_or_3&gt;&gt;
    &lt;&lt;myeval_let_3&gt;&gt;
    &lt;&lt;myeval_letstar_3&gt;&gt;
    &lt;&lt;myeval_defun_3&gt;&gt;
    &lt;&lt;myeval_setq_3&gt;&gt;
    &lt;&lt;myeval_lambda_3&gt;&gt;
    (t
     (myapply (myeval (car lst) env)
              (evlis (cdr lst) nil env)
              env))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_3_test">&lt;&lt;myeval_number_3_test&gt;&gt;
&lt;&lt;myeval_symb_3_test&gt;&gt;
&lt;&lt;myeval_quote_3_test&gt;&gt;
&lt;&lt;myeval_if_3_test&gt;&gt;
&lt;&lt;myeval_evcond_3_test&gt;&gt;
&lt;&lt;myeval_cond_3_test&gt;&gt;
&lt;&lt;myeval_evprogn_3_test&gt;&gt;
&lt;&lt;myeval_progn_3_test&gt;&gt;
&lt;&lt;myeval_print_3_test&gt;&gt;
&lt;&lt;myeval_evlis_3_test&gt;&gt;
&lt;&lt;myeval_list_3_test&gt;&gt;
&lt;&lt;myeval_evand_3_test&gt;&gt;
&lt;&lt;myeval_and_3_test&gt;&gt;
&lt;&lt;myeval_evor_3_test&gt;&gt;
&lt;&lt;myeval_or_3_test&gt;&gt;
&lt;&lt;myeval_mypairlis_3_test&gt;&gt;
&lt;&lt;myeval_let_3_test&gt;&gt;
&lt;&lt;myeval_letstar_3_test&gt;&gt;
&lt;&lt;myeval_defun_3_test&gt;&gt;
&lt;&lt;myeval_setq_3_test&gt;&gt;
&lt;&lt;myeval_lambda_3_test&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">Самовычисляемые формы</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_number_3">((null lst)                  nil)
((equal t lst)               t)
((member lst '(+ * car cdr cons null))  lst)
((numberp lst)               lst)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_number_3_test">(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval 'T nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval 'NIL nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 999 (myeval 999 nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">Вычисление символов</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">

<pre class="src src-lisp" id="errors_3">(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">var-not-found-error</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((vari <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:vari</span>  <span style="color: #5f5f87;">:reader</span> vari))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYEVAL: variable not found: ~A"</span>
             (vari condition)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_symb_3">((symbolp lst)               (<span style="color: #af00ff;">let</span> ((it (lookup lst env)))
                               (<span style="color: #af00ff;">if</span> (null it)
                                   (<span style="color: #ff0000; font-weight: bold;">error</span> 'var-not-found-error <span style="color: #5f5f87;">:vari</span> lst)
                                   (cdr it))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_symb_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1077;&#1085;&#1080;&#1103; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 6 (myeval 'b '((a . 3) (b . 6)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span>
               (<span style="color: #af00ff;">handler-case</span> (myeval 'b nil)
                 (VAR-NOT-FOUND-ERROR (condition) <span style="color: #87005f;">"error"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3">Цитирование</h3>
<div class="outline-text-3" id="text-3-3">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_quote_3">((equal (car lst) 'quote)    (cadr lst))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_quote_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; QUOTE</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(+ 1 2) (myeval '(quote (+ 1 2)) nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4">Условное выполнение IF</h3>
<div class="outline-text-3" id="text-3-4">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_if_3">((equal (car lst) 'if)       (<span style="color: #af00ff;">if</span> (myeval (cadr lst) env)
                                 (myeval (caddr lst) env)
                                 (myeval (cadddr lst) env)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_if_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; IF</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">if</span> () 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">if</span> (null ()) 1 2) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; IF, &#1075;&#1076;&#1077; &#1091;&#1089;&#1083;&#1086;&#1074;&#1080;&#1077; &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1090;&#1089;&#1103; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">if</span> a 1 2) '((a . ())))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">if</span> a 1 2) '((a . 1)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5">COND</h3>
<div class="outline-text-3" id="text-3-5">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evcond_3">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evcond</span> (lst env)
  (<span style="color: #af00ff;">cond</span> ((null lst)               nil)
        ((myeval (caar lst) env)  (myeval (cadar lst) env))
        (t                        (evcond (cdr lst) env))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evcond_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVCOND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2   (evcond '((t 2)   (t 1)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1   (evcond '((nil 2) (t 1)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (evcond '((nil 2) (nil 1)) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVCOND, &#1075;&#1076;&#1077; &#1091;&#1095;&#1072;&#1089;&#1090;&#1074;&#1091;&#1077;&#1090; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (evcond '((a 2) (b 1))
                         '((a . 1) (b . ())))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (evcond '((a 2) (b 1))
                         '((a . nil) (b . T)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_cond_3">((equal (car lst) 'cond)     (evcond (cdr lst) env))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_cond_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; COND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">cond</span>
                           (() 1)
                           (1 2))
                         nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; COND &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">cond</span>
                           (a 1)
                           (b 2))
                         '((a . ()) (b . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">cond</span>
                           (a 1)
                           (b 2))
                         '((a . 1) (b . ())))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-6" class="outline-3">
<h3 id="sec-3-6">PROGN</h3>
<div class="outline-text-3" id="text-3-6">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evprogn_3">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evprogn</span> (lst env)
  (<span style="color: #af00ff;">cond</span> ((null lst)        nil)
        ((null (cdr lst))  (myeval (car lst) env))
        (t                 (myeval (car lst) env)
                           (evprogn (cdr lst) env))))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evprogn_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; EVPROGN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (evprogn '(1 2) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; EVPROGN &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (evprogn '(a b c) '((a . 1) (b . 2) (c . 3)))))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myeval_progn_3">((equal (car lst) 'progn)    (evprogn (cdr lst) env))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myeval_progn_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; PROGN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">progn</span> 1 2 3) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; PROGN &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">progn</span> a b c) '((a . 1) (b . 2) (c . 3)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-7" class="outline-3">
<h3 id="sec-3-7">PRINT</h3>
<div class="outline-text-3" id="text-3-7">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_print_3">((equal (car lst) 'print)    (print (myeval (cadr lst)  env)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_print_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; PRINT</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (print 12))
               (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (myeval '(print 12) nil))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (print 12)
               (myeval '(print 12) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; PRINT &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (<span style="color: #af00ff;">let</span> ((a 12))
                   (print a)))
               (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (myeval '(print a) '((b . 23) (a . 12))))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 12))
                 (print a))
               (myeval '(print a) '((b . 23) (a . 12)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-8" class="outline-3">
<h3 id="sec-3-8">LIST</h3>
<div class="outline-text-3" id="text-3-8">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evlis_3">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evlis</span> (unevaled evaled env)
  (<span style="color: #af00ff;">cond</span> ((null unevaled)  (reverse evaled))
        (t                (evlis (cdr unevaled)
                                 (cons (myeval (car unevaled) env)
                                       evaled)
                                 env))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evlis_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVLIS</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (evlis '((+ 1 2) (* 2 3) 42) nil nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVLIS &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (evlis '((+ a b) (* b c) 42)
                      nil
                      '((a . 1) (b . 2) (c . 3) (d . 4)))))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myeval_list_3">((equal (car lst) 'list)     (evlis (cdr lst) nil env))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myeval_list_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LIST</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (myeval '(list (+ 1 2) (* 2 3) 42) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LIST &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (myeval '(list (+ a b) (* b c) 42)
                       '((a . 1) (b . 2) (c . 3) (d . 4)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-9" class="outline-3">
<h3 id="sec-3-9">AND</h3>
<div class="outline-text-3" id="text-3-9">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evand_3">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evand</span> (args env)
  (<span style="color: #af00ff;">cond</span> ((null args)        T)
        ((null (cdr args))  (myeval (car args) env))
        (t                  (<span style="color: #af00ff;">let</span> ((tmp (myeval (car args) env)))
                              (<span style="color: #af00ff;">if</span> (null tmp)
                                  nil
                                  (evand (cdr args) env))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evand_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVAND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and)           (evand '() nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1)         (evand '(1) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and nil)       (evand '(nil) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 nil)     (evand '(1 nil) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 nil)   (evand '(1 2 nil) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 3)     (evand '(1 2 3) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 nil 3) (evand '(1 2 nil 3) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVAND &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (and nil))
               (evand '(a) '((a . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (and a))
               (evand '(a) '((a . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b nil))
                 (and a b))
               (evand '(a b) '((a . 1) (b . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c nil))
                 (and a b c))
               (evand '(a b c) '((a . 1) (b . 2) (c . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a b c))
               (evand '(a b c) '((a . 1) (b . 2) (c . 3)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c nil)
                     (d 3))
                 (and a b c d))
               (evand '(a b c) '((a . 1) (b . 2) (c . nil) (d . 3)))))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myeval_and_3">((equal (car lst) 'and)      (evand (cdr lst) env))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myeval_and_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; AND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and)                  (myeval '(and) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1)                (myeval '(and 1) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and nil)              (myeval '(and nil) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 nil)            (myeval '(and 1 nil) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 nil)          (myeval '(and 1 2 nil) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 3)            (myeval '(and 1 2 3) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 nil 3)        (myeval '(and 1 2 nil 3) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 (and 1 2) 3)    (myeval '(and 1 (and 1 2) 3) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 (and 1 nil) 3)  (myeval '(and 1 (and 1 nil) 3) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; AND &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (and nil))
               (myeval '(and a) '((a . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (and a))
               (myeval '(and a) '((a . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b nil))
                 (and a b))
               (myeval '(and a b) '((a . 1) (b . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c nil))
                 (and a b c))
               (myeval '(and a b c) '((a . 1) (b . 2) (c . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a b c))
               (myeval '(and a b c) '((a . 1) (b . 2) (c . 3)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c nil)
                     (d 3))
                 (and a b c d))
               (myeval '(and a b c) '((a . 1) (b . 2) (c . nil) (d . 3)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a (and a b) c))
               (myeval '(and a (and a b) c) '((a . 1) (b . 2) (c . 3)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b nil)
                     (c 3))
                 (and a (and a b) c))
               (myeval '(and a (and a b) c) '((a . 1) (b . nil) (c . 3)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-10" class="outline-3">
<h3 id="sec-3-10">OR</h3>
<div class="outline-text-3" id="text-3-10">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evor_3">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evor</span> (args env)
  (<span style="color: #af00ff;">cond</span> ((null args)        nil)
        ((null (cdr args))  (myeval (car args) env))
        (t                  (<span style="color: #af00ff;">let</span> ((tmp (myeval (car args) env)))
                              (<span style="color: #af00ff;">if</span> (not (null tmp))
                                  tmp
                                  (evor (cdr args) env))))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evor_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVOR</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or)                   (evor '() nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1)             (evor '(nil 1) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil nil 1)         (evor '(nil nil 1) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1 2)           (evor '(nil 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or 1 2 3)             (evor '(1 2 3) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil nil 3 nil)     (evor '(nil nil 3 nil) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVOR &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (or a))
               (evor '(a) '((a . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (or a))
               (evor '(a) '((a . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1))
                 (or a b))
               (evor '(a b) '((a . nil) (b . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b nil)
                     (c 3))
                 (or a b c))
               (evor '(a b c) '((a . nil) (b . nil) (c . 3)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1)
                     (c 2))
                 (or a b c))
               (evor '(a b c) '((a . nil) (b . 1) (c . 2)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b nil)
                     (c 3)
                     (d nil))
                 (or a b c d))
               (evor '(a b c d) '((a . nil) (b . nil) (c . 3) (d . nil)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_or_3">((equal (car lst) 'or)       (evor  (cdr lst) env))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_or_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; OR</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or)                  (myeval '(or) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1)            (myeval '(or nil 1) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil nil 1)        (myeval '(or nil nil 1) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1 2)          (myeval '(or nil 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil (or 3 2) 2)   (myeval '(or nil (or 3 2) 2) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; OR &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (or a))
               (myeval '(or a) '((a . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (or a))
               (myeval '(or a) '((a . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1))
                 (or a b))
               (myeval '(or a b) '((a . nil) (b . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b nil)
                     (c 3))
                 (or a b c))
               (myeval '(or a b c) '((a . nil) (b . nil) (c . 3)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1)
                     (c 2))
                 (or a b c))
               (myeval '(or a b c) '((a . nil) (b . 1) (c . 2)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b nil)
                     (c nil)
                     (d 2))
                 (or a (or b c) d))
               (myeval '(or  a (or b c) d) '((a . nil) (b . nil) (c . nil) (d . 2)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-11" class="outline-3">
<h3 id="sec-3-11">LET</h3>
<div class="outline-text-3" id="text-3-11">
<div class="org-src-container">

<pre class="src src-lisp" id="errors_3">(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">mypairlis-error</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((lst1 <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:lst1</span>  <span style="color: #5f5f87;">:reader</span> lst1)
   (lst2 <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:lst2</span>  <span style="color: #5f5f87;">:reader</span> lst2))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYPAIRLIS: wrong params:~%'~A~%'~A"</span>
             (lst1 condition) (lst2 condition)))))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myeval_mypairlis_3">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">mypairlis</span> (lst1 lst2 alist)
  (<span style="color: #af00ff;">cond</span> ((and (null lst1) (null lst2))  alist)
        ((or  (null lst1) (null lst2))  (<span style="color: #ff0000; font-weight: bold;">error</span> 'mypairlis-error <span style="color: #5f5f87;">:lst1</span> lst1 <span style="color: #5f5f87;">:lst2</span> lst2))
        (t                              (cons (cons (car lst1)
                                                    (car lst2))
                                              (mypairlis (cdr lst1)
                                                         (cdr lst2)
                                                         alist)))))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myeval_mypairlis_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; MYPAIRLIS</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(( a . 1) (b . 2) ( c . 3) (z . 6) (y . 77))
               (mypairlis '(a b c) '(1 2 3) '((z . 6) (y . 77)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span>
               (<span style="color: #af00ff;">handler-case</span> (mypairlis '(a b c) nil '((z . 6) (y . 77)))
                 (MYPAIRLIS-ERROR (condition) <span style="color: #87005f;">"error"</span>))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span>
               (<span style="color: #af00ff;">handler-case</span> (mypairlis nil '(1 2 3) '((z . 6) (y . 77)))
                 (MYPAIRLIS-ERROR (condition) <span style="color: #87005f;">"error"</span>))))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myeval_let_3">((equal (car lst) 'let)      (evprogn (cddr lst) <span style="color: #af0000;">; implicit progn</span>
                                      (pairlis (mapcar #'car (cadr lst))
                                               (evlis (mapcar #'cadr (cadr lst))
                                                      nil
                                                      env)
                                               env)))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="myeval_let_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; LET</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(<span style="color: #af00ff;">let</span> ((a 1)
                                       (b 2))
                                  (cons a b)) nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-12" class="outline-3">
<h3 id="sec-3-12">LET*</h3>
<div class="outline-text-3" id="text-3-12">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_evletstar_3">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evletstar</span> (varpairs exp env)
  (<span style="color: #af00ff;">cond</span> ((null varpairs)  (myeval exp env))
        (t                (evletstar (cdr varpairs)
                                     exp
                                     (cons (cons (caar varpairs)
                                                 (myeval (cadar varpairs) env))
                                           env)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_letstar_3">((equal (car lst) 'let*)     (evletstar (cadr lst)
                                        (caddr lst)
                                        env))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_letstar_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; LET*</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 1 . 2) (myeval '(<span style="color: #af00ff;">let*</span> ((a 1)
                                          (b 2)
                                          (c (+ a b)))
                                    (cons c (cons a b))) nil)))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-13" class="outline-3">
<h3 id="sec-3-13">DEFUN</h3>
<div class="outline-text-3" id="text-3-13">
<p>
При создании функции мы создаем замыкание, в которое кладем тело функции, текущее
окружение и аргументы функции. Обеспечиваем <code>implicit-progn</code> в <code>body</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_defun_3">((equal (car lst) 'defun)         (<span style="color: #af00ff;">progn</span>
                                    (push (cons (cadr lst)
                                                (make-closure <span style="color: #5f5f87;">:body</span> (cdddr lst)
                                                              <span style="color: #5f5f87;">:env</span> env
                                                              <span style="color: #5f5f87;">:args</span> (caddr lst)))
                                          *glob-env*)
                                    (cadr lst)))
</pre>
</div>

<p>
Необходимо протестировать новый <code>defun</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_defun_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; DEFUN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 64 (<span style="color: #af00ff;">progn</span>
                    (setf *glob-env* nil)
                    (myeval '(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">alfa</span> (x) (* x x)) nil)
                    (<span style="color: #af00ff;">prog1</span> (myeval '(alfa 8) nil)
                      (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1085;&#1072; IMPLICIT-PROGN &#1074; DEFUN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 384 (<span style="color: #af00ff;">progn</span>
                     (setf *glob-env* nil)
                     (myeval '(<span style="color: #af00ff;">let</span> ((y 3))
                               (<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">alfa</span> (x)
                                 (setq y 6)
                                 (* x x y)))
                             nil)
                     (<span style="color: #af00ff;">prog1</span> (myeval '(alfa 8) nil)
                       (setf *glob-env* nil)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-14" class="outline-3">
<h3 id="sec-3-14">SETQ</h3>
<div class="outline-text-3" id="text-3-14">
<div class="org-src-container">

<pre class="src src-lisp" id="myeval_setq_3">((equal (car lst) 'setq)     (<span style="color: #af00ff;">let</span> ((it (lookup (cadr lst) env))
                                   (val (myeval (caddr lst) env)))
                               (<span style="color: #af00ff;">if</span> (null it)
                                   (push (cons (cadr lst) val)
                                         *glob-env*)
                                   (rplacd it val))
                               val))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_setq_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; SETQ</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">let</span> ((alfa 2))
                           (setq alfa 1)
                           alfa)
                         nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((ALFA . 1))
             (<span style="color: #af00ff;">progn</span>
               (setf *glob-env* nil)
               (myeval '(setq alfa 1) nil)
               (<span style="color: #af00ff;">prog1</span> *glob-env*
                 (setf *glob-env* nil)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-15" class="outline-3">
<h3 id="sec-3-15">LAMBDA</h3>
<div class="outline-text-3" id="text-3-15">
<p>
При обработке формы, начинающейся с вызова <code>lambda</code> мы должны создать замыкание.
Обеспечиваем <code>implicit-progn</code> в <code>body</code>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_lambda_3">((equal (car lst) 'lambda)   (make-closure <span style="color: #5f5f87;">:body</span> (cddr lst) <span style="color: #5f5f87;">:env</span> env <span style="color: #5f5f87;">:args</span> (cadr lst)))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-lisp" id="myeval_lambda_3_test"><span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LAMBDA</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '((<span style="color: #af00ff;">lambda</span> (x) (+ 1  x)) 2)
                         nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LAMBDA &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 5 (myeval '(<span style="color: #af00ff;">let</span> ((y 3))
                           ((<span style="color: #af00ff;">lambda</span> (x) (+ y x)) 2))
                         nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1085;&#1072; IMPLICIT-PROGN &#1074; LAMBDA</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 8 (myeval '(<span style="color: #af00ff;">let</span> ((y 3))
                           ((<span style="color: #af00ff;">lambda</span> (x)
                              (setq y 6)
                              (+ y x)) 2))
                         nil)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">REPL</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">

<pre class="src src-lisp" id="repl_3">(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">repl</span> ()
  (princ <span style="color: #87005f;">"microlisp&gt;"</span>)
  (finish-output)
  (princ (myeval (read) nil))
  (terpri)
  (finish-output)
  (repl))
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Итоги</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-lisp">&lt;&lt;errors_3&gt;&gt;
&lt;&lt;lookup_3&gt;&gt;
&lt;&lt;closure_3&gt;&gt;
&lt;&lt;myapply_3&gt;&gt;
&lt;&lt;myeval_3&gt;&gt;
&lt;&lt;myapply_3_test&gt;&gt;
&lt;&lt;myeval_3_test&gt;&gt;
&lt;&lt;repl_3&gt;&gt;
</pre>
</div>

<p>
Получиться должен вот такой результат:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">unknown-function</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((fn <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:fn</span>  <span style="color: #5f5f87;">:reader</span> fn))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYAPPLY: unknown-function: ~A"</span>
             (fn condition)))))
(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">invalid-number-of-arguments</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((fn <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:fn</span>  <span style="color: #5f5f87;">:reader</span> fn))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYAPPLY: invalid-number-of-arguments: ~A"</span>
             (fn condition)))))
(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">function-not-found-error</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((fn <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:fn</span>  <span style="color: #5f5f87;">:reader</span> fn))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYAPPLY: function not found: ~A"</span>
             (fn condition)))))
(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">var-not-found-error</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((vari <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:vari</span>  <span style="color: #5f5f87;">:reader</span> vari))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYEVAL: variable not found: ~A"</span>
             (vari condition)))))
(<span style="color: #af00ff;">define-condition</span> <span style="color: #0000ff;">mypairlis-error</span> (<span style="color: #ff0000; font-weight: bold;">error</span>)
  ((lst1 <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:lst1</span>  <span style="color: #5f5f87;">:reader</span> lst1)
   (lst2 <span style="color: #5f5f87;">:initarg</span> <span style="color: #5f5f87;">:lst2</span>  <span style="color: #5f5f87;">:reader</span> lst2))
  (<span style="color: #5f5f87;">:report</span>
   (<span style="color: #af00ff;">lambda</span> (condition stream)
     (format stream <span style="color: #87005f;">"Error in MYPAIRLIS: wrong params:~%'~A~%'~A"</span>
             (lst1 condition) (lst2 condition)))))
(<span style="color: #af00ff;">defparameter</span> <span style="color: #af5f00;">*glob-env*</span> nil)

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">lookup</span> (symb env)
  (<span style="color: #af00ff;">let</span> ((it (assoc symb env)))
    (<span style="color: #af00ff;">if</span> (not (null it))
        it
        (assoc symb *glob-env*))))
(<span style="color: #af00ff;">defstruct</span> <span style="color: #008700;">closure</span>
  body
  env
  args)
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evadd</span> (lst acc)
  (<span style="color: #af00ff;">cond</span> ((null lst)        0)
        ((null (cdr lst))  (+ acc (car lst)))
        (t                 (evadd (cdr lst)
                                  (+ acc (car lst))))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evmul</span> (lst acc)
  (<span style="color: #af00ff;">cond</span> ((null lst)        1)
        ((null (cdr lst))  (* acc (car lst)))
        (t                 (evmul (cdr lst)
                                  (* acc (car lst))))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">myapply</span> (fn args env)
  (<span style="color: #af00ff;">cond</span>
    ((equal fn 'car)             (caar args))
    ((equal fn 'cdr)             (cdar args))
    ((equal fn 'cons)            (cons (car args) (cadr args)))
    ((equal fn 'null)            (<span style="color: #af00ff;">if</span> (null (cdr args))
                                     (null (car args))
                                     (<span style="color: #ff0000; font-weight: bold;">error</span> 'invalid-number-of-arguments <span style="color: #5f5f87;">:fn</span> fn)))
    ((equal fn '+)               (evadd args 0))
    ((equal fn '*)               (evmul args 1))
    ((closure-p fn)              (myeval (closure-body fn)
                                         (pairlis (closure-args fn)
                                                  args
                                                  (closure-env fn))))
    (t (<span style="color: #ff0000; font-weight: bold;">error</span> 'unknown-function <span style="color: #5f5f87;">:fn</span> fn))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evcond</span> (lst env)
  (<span style="color: #af00ff;">cond</span> ((null lst)               nil)
        ((myeval (caar lst) env)  (myeval (cadar lst) env))
        (t                        (evcond (cdr lst) env))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evprogn</span> (lst env)
  (<span style="color: #af00ff;">cond</span> ((null lst)        nil)
        ((null (cdr lst))  (myeval (car lst) env))
        (t                 (myeval (car lst) env)
                           (evprogn (cdr lst) env))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evlis</span> (unevaled evaled env)
  (<span style="color: #af00ff;">cond</span> ((null unevaled)  (reverse evaled))
        (t                (evlis (cdr unevaled)
                                 (cons (myeval (car unevaled) env)
                                       evaled)
                                 env))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evand</span> (lst env)
  (<span style="color: #af00ff;">cond</span> ((null lst)        (and))
        ((null (cdr lst))  (and (myeval (car lst) env)))
        (t                 (and (myeval (car lst) env)
                                (evand (cdr lst) env)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evor</span> (lst env)
  (<span style="color: #af00ff;">cond</span> ((null lst)        (or))
        ((null (cdr lst))  (or (myeval (car lst) env)))
        (t                 (or (myeval (car lst) env)
                               (evor (cdr lst) env)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">mypairlis</span> (lst1 lst2 alist)
  (<span style="color: #af00ff;">cond</span> ((and (null lst1) (null lst2))  alist)
        ((or  (null lst1) (null lst2))  (<span style="color: #ff0000; font-weight: bold;">error</span> 'mypairlis-error <span style="color: #5f5f87;">:lst1</span> lst1 <span style="color: #5f5f87;">:lst2</span> lst2))
        (t                              (cons (cons (car lst1)
                                                    (car lst2))
                                              (mypairlis (cdr lst1)
                                                         (cdr lst2)
                                                         alist)))))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">evletstar</span> (varpairs exp env)
  (<span style="color: #af00ff;">cond</span> ((null varpairs)  (myeval exp env))
        (t                (evletstar (cdr varpairs)
                                     exp
                                     (cons (cons (caar varpairs)
                                                 (myeval (cadar varpairs) env))
                                           env)))))

(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">myeval</span> (lst env)
  (<span style="color: #af00ff;">cond</span>
    ((null lst)                  nil)
    ((equal t lst)               t)
    ((member lst '(+ * car cdr cons null))  lst)
    ((numberp lst)               lst)
    ((symbolp lst)               (<span style="color: #af00ff;">let</span> ((it (lookup lst env)))
                                   (<span style="color: #af00ff;">if</span> (null it)
                                       (<span style="color: #ff0000; font-weight: bold;">error</span> 'var-not-found-error <span style="color: #5f5f87;">:vari</span> lst)
                                       (cdr it))))
    ((equal (car lst) 'quote)    (cadr lst))
    ((equal (car lst) 'if)       (<span style="color: #af00ff;">if</span> (myeval (cadr lst) env)
                                     (myeval (caddr lst) env)
                                     (myeval (cadddr lst) env)))
    ((equal (car lst) 'cond)     (evcond (cdr lst) env))
    ((equal (car lst) 'progn)    (evprogn (cdr lst) env))
    ((equal (car lst) 'print)    (print (myeval (cadr lst)  env)))
    ((equal (car lst) 'list)     (evlis (cdr lst) nil env))
    ((equal (car lst) 'and)      (evand (cdr lst) env))
    ((equal (car lst) 'or)       (evor  (cdr lst) env))
    ((equal (car lst) 'let)      (evprogn (cddr lst) <span style="color: #af0000;">; implicit progn</span>
                                          (pairlis (mapcar #'car (cadr lst))
                                                   (evlis (mapcar #'cadr (cadr lst))
                                                          nil
                                                          env)
                                                   env)))
    ((equal (car lst) 'let*)     (evletstar (cadr lst)
                                            (caddr lst)
                                            env))
    ((equal (car lst) 'defun)         (<span style="color: #af00ff;">progn</span>
                                        (push (cons (cadr lst)
                                                    (make-closure <span style="color: #5f5f87;">:body</span> (cadddr lst)
                                                                  <span style="color: #5f5f87;">:env</span> env
                                                                  <span style="color: #5f5f87;">:args</span> (caddr lst)))
                                              *glob-env*)
                                        (cadr lst)))
    ((equal (car lst) 'setq)     (<span style="color: #af00ff;">let</span> ((it (lookup (cadr lst) env))
                                       (val (myeval (caddr lst) env)))
                                   (<span style="color: #af00ff;">if</span> (null it)
                                       (push (cons (cadr lst) val)
                                             *glob-env*)
                                       (rplacd it val))
                                   val))
    ((equal (car lst) 'lambda)   (make-closure <span style="color: #5f5f87;">:body</span> (caddr lst) <span style="color: #5f5f87;">:env</span> env <span style="color: #5f5f87;">:args</span> (cadr lst)))
    (t
     (myapply (myeval (car lst) env)
              (evlis (cdr lst) nil env)
              env))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; cons-&#1103;&#1095;&#1077;&#1077;&#1082;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(cons 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((1 . 2) 3 . 4) (myeval '(cons (cons 1 2) (cons 3 4)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(car (cons 2 3)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(cdr (cons 2 3)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(car (cons (cons 1 2) (cons 3 4))) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 . 4) (myeval '(cdr (cons (cons 1 2) (cons 3 4))) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; cons-&#1103;&#1095;&#1077;&#1077;&#1082;, &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1093; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(car a) '((a . (1 . 2))))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(cdr a) '((a . (1 . 2))))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(car b) '((a . (1 . 2)) (b . (3 . 4))))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; NULL</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval '(null ()) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval '(null nil) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval '(null T) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval '(null a) '((a . ())))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; NULL, &#1089; &#1072;&#1088;&#1075;&#1091;&#1084;&#1077;&#1085;&#1090;&#1086;&#1084;, &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1084;&#1099;&#1077; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval '(null a) '((a . T)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval '(null a) '((a . 1)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVADD</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0                (evadd '() 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2                (evadd '(2) 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 5                (evadd '(2 3) 0)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3 4)        (evadd '(2 3 4) 0)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVMUL</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1                (evmul '() 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2                (evmul '(2) 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 6                (evmul '(2 3) 1)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3 4)        (evmul '(2 3 4) 1)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0                (myeval '(+) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2)            (myeval '(+ 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3)          (myeval '(+ 2 3) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 3 4)        (myeval '(+ 2 3 4) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 (+ 3 4))    (myeval '(+ 2 (+ 3 4)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (+ 2 (+ 3 4) 5)  (myeval '(+ 2 (+ 3 4) 5) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1091;&#1084;&#1085;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1                (myeval '(*) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2)            (myeval '(* 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3)          (myeval '(* 2 3) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 3 4)        (myeval '(* 2 3 4) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 (* 3 4))    (myeval '(* 2 (* 3 4)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (* 2 (* 3 4) 5)  (myeval '(* 2 (* 3 4) 5) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1089;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 0
               (myeval '(+) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2))
                 (+ a))
               (myeval '(+ a)
                       '((a . 2)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3))
                 (+ a b))
               (myeval '(+ a b)
                       '((a . 2) (b . 3)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (+ a b c))
               (myeval '(+ a b c)
                       '((a . 2) (b . 3) (c . 4)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (+ a (+ b c)))
               (myeval '(+ a (+ b c))
                       '((a . 2) (b . 3) (c . 4)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4) (d 5))
                 (+ a (+ b c) d))
               (myeval '(+ a (+ b c) d)
                       '((a . 2) (b . 3) (c . 4) (d . 5)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1091;&#1084;&#1085;&#1086;&#1078;&#1077;&#1085;&#1080;&#1103;  &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1
               (myeval '(*) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2))
                 (* a))
               (myeval '(* a)
                       '((a . 2)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3))
                 (* a b))
               (myeval '(* a b)
                       '((a . 2) (b . 3)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (* a b c))
               (myeval '(* a b c)
                       '((a . 2) (b . 3) (c . 4)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4))
                 (* a (* b c)))
               (myeval '(* a (* b c))
                       '((a . 2) (b . 3) (c . 4)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 2) (b 3) (c 4) (d 5))
                 (* a (* b c) d))
               (myeval '(* a (* b c) d)
                       '((a . 2) (b . 3) (c . 4) (d . 5)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 49 (<span style="color: #af00ff;">progn</span>
                    (setf *glob-env* nil)
                    (myeval '(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">alfa</span> (x) (* x x)) nil)
                    (myeval '(setq beta 7) nil)
                    (<span style="color: #af00ff;">prog1</span> (myeval '(alfa beta) nil)
                      (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">(assert (equal "error"</span>
<span style="color: #af0000;">;;                </span><span style="color: #af0000;">(handler-case (myeval '(alfa beta) '((beta . 7)))</span>
<span style="color: #af0000;">;;                  </span><span style="color: #af0000;">(FUNCTION-NOT-FOUND-ERROR (condition) "error"))))</span>
<span style="color: #af0000;">;; </span><span style="color: #af0000;">TODO : &#1085;&#1091;&#1078;&#1077;&#1085; &#1090;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; closure &#1074; apply</span>

(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal T (myeval 'T nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal NIL (myeval 'NIL nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 999 (myeval 999 nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1077;&#1085;&#1080;&#1103; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 6 (myeval 'b '((a . 3) (b . 6)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span>
               (<span style="color: #af00ff;">handler-case</span> (myeval 'b nil)
                 (VAR-NOT-FOUND-ERROR (condition) <span style="color: #87005f;">"error"</span>))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; QUOTE</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(+ 1 2) (myeval '(quote (+ 1 2)) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; IF</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">if</span> () 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">if</span> (null ()) 1 2) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; IF, &#1075;&#1076;&#1077; &#1091;&#1089;&#1083;&#1086;&#1074;&#1080;&#1077; &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1103;&#1077;&#1090;&#1089;&#1103; &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">if</span> a 1 2) '((a . ())))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">if</span> a 1 2) '((a . 1)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVCOND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2   (evcond '((t 2)   (t 1)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1   (evcond '((nil 2) (t 1)) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal nil (evcond '((nil 2) (nil 1)) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVCOND, &#1075;&#1076;&#1077; &#1091;&#1095;&#1072;&#1089;&#1090;&#1074;&#1091;&#1077;&#1090; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1077;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (evcond '((a 2) (b 1))
                         '((a . 1) (b . ())))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (evcond '((a 2) (b 1))
                         '((a . nil) (b . T)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; COND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">cond</span>
                           (() 1)
                           (1 2))
                         nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; COND &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (myeval '(<span style="color: #af00ff;">cond</span>
                           (a 1)
                           (b 2))
                         '((a . ()) (b . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">cond</span>
                           (a 1)
                           (b 2))
                         '((a . 1) (b . ())))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; EVPROGN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 2 (evprogn '(1 2) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; EVPROGN &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (evprogn '(a b c) '((a . 1) (b . 2) (c . 3)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; PROGN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">progn</span> 1 2 3) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; PROGN &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '(<span style="color: #af00ff;">progn</span> a b c) '((a . 1) (b . 2) (c . 3)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; PRINT</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (print 12))
               (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (myeval '(print 12) nil))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (print 12)
               (myeval '(print 12) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; PRINT &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (<span style="color: #af00ff;">let</span> ((a 12))
                   (print a)))
               (<span style="color: #af00ff;">with-output-to-string</span> (*standard-output*)
                 (myeval '(print a) '((b . 23) (a . 12))))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 12))
                 (print a))
               (myeval '(print a) '((b . 23) (a . 12)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVLIS</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (evlis '((+ 1 2) (* 2 3) 42) nil nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVLIS &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (evlis '((+ a b) (* b c) 42)
                      nil
                      '((a . 1) (b . 2) (c . 3) (d . 4)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LIST</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (myeval '(list (+ 1 2) (* 2 3) 42) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LIST &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 6 42)
               (myeval '(list (+ a b) (* b c) 42)
                       '((a . 1) (b . 2) (c . 3) (d . 4)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVAND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and)           (evand '() nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1)         (evand '(1) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and nil)       (evand '(nil) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 nil)     (evand '(1 nil) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 nil)   (evand '(1 2 nil) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 3)     (evand '(1 2 3) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVAND &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (and nil))
               (evand '(a) '((a . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (and a))
               (evand '(a) '((a . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b nil))
                 (and a b))
               (evand '(a b) '((a . 1) (b . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c nil))
                 (and a b c))
               (evand '(a b c) '((a . 1) (b . 2) (c . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a b c))
               (evand '(a b c) '((a . 1) (b . 2) (c . 3)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; AND</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and)                (myeval '(and) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1)              (myeval '(and 1) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and nil)            (myeval '(and nil) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 nil)          (myeval '(and 1 nil) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 nil)        (myeval '(and 1 2 nil) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 2 3)          (myeval '(and 1 2 3) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (and 1 (and 1 2) 3)  (myeval '(and 1 (and 1 2) 3) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; AND &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (and nil))
               (myeval '(and a) '((a . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (and a))
               (myeval '(and a) '((a . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b nil))
                 (and a b))
               (myeval '(and a b) '((a . 1) (b . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c nil))
                 (and a b c))
               (myeval '(and a b c) '((a . 1) (b . 2) (c . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1)
                     (b 2)
                     (c 3))
                 (and a b c))
               (myeval '(and a b c) '((a . 1) (b . 2) (c . 3)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVOR</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or)           (evor '() nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1)     (evor '(nil 1) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil nil 1) (evor '(nil nil 1) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1 2)   (evor '(nil 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or 1 2 3)     (evor '(1 2 3) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; EVOR &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (or a))
               (evor '(a) '((a . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (or a))
               (evor '(a) '((a . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1))
                 (or a b))
               (evor '(a b) '((a . nil) (b . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b nil)
                     (c 3))
                 (or a b c))
               (evor '(a b c) '((a . nil) (b . nil) (c . 3)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1)
                     (c 2))
                 (or a b c))
               (evor '(a b c) '((a . nil) (b . 1) (c . 2)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; OR</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or)                  (myeval '(or) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1)            (myeval '(or nil 1) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil nil 1)        (myeval '(or nil nil 1) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil 1 2)          (myeval '(or nil 1 2) nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (or nil (or 3 2) 2)   (myeval '(or nil (or 3 2) 2) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; OR &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil))
                 (or a))
               (myeval '(or a) '((a . nil)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a 1))
                 (or a))
               (myeval '(or a) '((a . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1))
                 (or a b))
               (myeval '(or a b) '((a . nil) (b . 1)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b nil)
                     (c 3))
                 (or a b c))
               (myeval '(or a b c) '((a . nil) (b . nil) (c . 3)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal (<span style="color: #af00ff;">let</span> ((a nil)
                     (b 1)
                     (c 2))
                 (or a b c))
               (myeval '(or a b c) '((a . nil) (b . 1) (c . 2)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; MYPAIRLIS</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(( a . 1) (b . 2) ( c . 3) (z . 6) (y . 77))
               (mypairlis '(a b c) '(1 2 3) '((z . 6) (y . 77)))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span>
               (<span style="color: #af00ff;">handler-case</span> (mypairlis '(a b c) nil '((z . 6) (y . 77)))
                 (MYPAIRLIS-ERROR (condition) <span style="color: #87005f;">"error"</span>))))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal <span style="color: #87005f;">"error"</span>
               (<span style="color: #af00ff;">handler-case</span> (mypairlis nil '(1 2 3) '((z . 6) (y . 77)))
                 (MYPAIRLIS-ERROR (condition) <span style="color: #87005f;">"error"</span>))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; LET</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(1 . 2) (myeval '(<span style="color: #af00ff;">let</span> ((a 1)
                                       (b 2))
                                  (cons a b)) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; LET*</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '(3 1 . 2) (myeval '(<span style="color: #af00ff;">let*</span> ((a 1)
                                          (b 2)
                                          (c (+ a b)))
                                    (cons c (cons a b))) nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; DEFUN</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 64 (<span style="color: #af00ff;">progn</span>
                    (setf *glob-env* nil)
                    (myeval '(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">alfa</span> (x) (* x x)) nil)
                    (<span style="color: #af00ff;">prog1</span> (myeval '(alfa 8) nil)
                      (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090; &#1076;&#1083;&#1103; SETQ</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 1 (myeval '(<span style="color: #af00ff;">let</span> ((alfa 2))
                           (setq alfa 1)
                           alfa)
                         nil)))
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal '((ALFA . 1))
               (<span style="color: #af00ff;">progn</span>
                 (setf *glob-env* nil)
                 (myeval '(setq alfa 1) nil)
                 (<span style="color: #af00ff;">prog1</span> *glob-env*
                   (setf *glob-env* nil)))))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LAMBDA</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 3 (myeval '((<span style="color: #af00ff;">lambda</span> (x) (+ 1  x)) 2)
                         nil)))
<span style="color: #af0000;">;; </span><span style="color: #af0000;">&#1058;&#1077;&#1089;&#1090;&#1099; &#1076;&#1083;&#1103; LAMBDA &#1074; &#1086;&#1082;&#1088;&#1091;&#1078;&#1077;&#1085;&#1080;&#1080;</span>
(<span style="color: #ff0000; font-weight: bold;">assert</span> (equal 5 (myeval '(<span style="color: #af00ff;">let</span> ((y 3))
                           ((<span style="color: #af00ff;">lambda</span> (x) (+ y x)) 2))
                         nil)))
(<span style="color: #af00ff;">defun</span> <span style="color: #0000ff;">repl</span> ()
  (princ <span style="color: #87005f;">"microlisp&gt;"</span>)
  (princ (myeval (read) nil))
  (terpri)
  (finish-output)
  (repl))
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
