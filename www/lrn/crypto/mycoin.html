<!DOCTYPE html>
<html>
<head>
<title>Mycoin</title>
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="rigidus">
<link href="/css/style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="content">
<h1 class="title">Mycoin</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#unnumbered-1">О проекте</a></li>
<li><a href="#unnumbered-2">Features</a></li>
<li><a href="#unnumbered-3">Assets</a></li>
<li><a href="#unnumbered-4">Accounts</a></li>
<li><a href="#unnumbered-5"><span class="todo nilTODO">TODO</span> Transactions</a></li>
<li><a href="#unnumbered-6">Use cases</a>
<ul>
<li><a href="#unnumbered-7">Start of Node</a></li>
<li><a href="#unnumbered-8">Finding neighbors</a></li>
<li><a href="#unnumbered-9">Genesis</a>
<ul>
<li><a href="#unnumbered-10">Transaction Asset Issue</a></li>
<li><a href="#unnumbered-11">Transaction Account Create</a></li>
</ul>
</li>
<li><a href="#unnumbered-12">Synchronization of State</a>
<ul>
<li><a href="#unnumbered-13"><span class="todo nilTODO">TODO</span> Verifycation of Transaction</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#unnumbered-14">Установка и настройка</a>
<ul>
<li><a href="#unnumbered-15">Легкий старт</a></li>
</ul>
</li>
<li><a href="#unnumbered-16">Assembly</a>
<ul>
<li><a href="#unnumbered-17">System definition</a></li>
<li><a href="#unnumbered-18">Prepare to start</a></li>
<li><a href="#unnumbered-19">Определение пакетов</a></li>
<li><a href="#unnumbered-20">Утилиты</a></li>
<li><a href="#unnumbered-21">Copyright</a></li>
<li><a href="#unnumbered-22">Main module definition</a></li>
<li><a href="#unnumbered-23">Entityes</a></li>
<li><a href="#unnumbered-24">Initialization</a></li>
<li><a href="#unnumbered-25">Path translation</a></li>
<li><a href="#unnumbered-26">Codegeneration</a></li>
</ul>
</li>
<li><a href="#unnumbered-27">Html-tree</a>
<ul>
<li><a href="#unnumbered-28">Парсинг html</a></li>
<li><a href="#unnumbered-29">Сборка в html</a></li>
</ul>
</li>
<li><a href="#unnumbered-30">Преобразование страниц</a></li>
<li><a href="#unnumbered-31">Рендеринг</a></li>
<li><a href="#unnumbered-32">Маршрутизация</a>
<ul>
<li><a href="#unnumbered-33">Статические файлы</a></li>
<li><a href="#unnumbered-34">404 страница</a></li>
<li><a href="#unnumbered-35">Страница robots.txt</a></li>
<li><a href="#unnumbered-36">Страницы orgmode</a></li>
<li><a href="#unnumbered-37">Маршруты страниц</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-unnumbered-1" class="outline-2">
<h2 id="unnumbered-1">О проекте</h2>
<div class="outline-text-2" id="text-unnumbered-1">
<p>
Это рабочий прототип криптовалюты, протокола и кошелька, предназначенный для
исследовательских целей.
</p>

<p>
Он написан в <a href="../doc/literate-programming.html">литературном стиле</a> на Common Lisp.
</p>
</div>
</div>

<div id="outline-container-unnumbered-2" class="outline-2">
<h2 id="unnumbered-2">Features</h2>
<div class="outline-text-2" id="text-unnumbered-2">
<ul class="org-ul">
<li>BlockChain
</li>
<li>Consensus: PoS, pBFT
</li>
<li>Transactions
<ul class="org-ul">
<li>IssueAsset
</li>
<li>RemoveAsset
</li>
<li>Transfer
</li>
<li>MassTransfer
</li>
<li>IssueAccount
</li>
<li>InvokeAccount
</li>
</ul>
</li>
<li>SmartAssets
</li>
<li>SmartAccounts
</li>
</ul>
</div>
</div>

<div id="outline-container-unnumbered-3" class="outline-2">
<h2 id="unnumbered-3">Assets</h2>
<div class="outline-text-2" id="text-unnumbered-3">
<p>
Одна из основных целей разработки - это обмен ценностью, которая выражена в так
называемых "ассетах" (<code>assets</code>). Это эквивалент денежных единиц в традиционной системе
денежного обращения, но здесь он имеет несколько дополнительных функций
</p>

<table id="asset_flds">
<caption class="t-above"><span class="table-number">Table 1:</span> Данные ассета</caption>

<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="left">version</td>
<td class="left">int</td>
<td class="left">Версия, от которой зависит способ работы</td>
</tr>

<tr>
<td class="left">asset<sub>id</sub></td>
<td class="left">string</td>
<td class="left">Уникальный идентификтор ассета</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">string</td>
<td class="left">Человекочитаемое имя (не обязательно уникальное)</td>
</tr>

<tr>
<td class="left">descr</td>
<td class="left">text</td>
<td class="left">Описание ассета, заполняется при создании</td>
</tr>

<tr>
<td class="left">quantity</td>
<td class="left">(or db-null int)</td>
<td class="left">Количество единиц ассета, может быть неопределено</td>
</tr>

<tr>
<td class="left">decimals</td>
<td class="left">int</td>
<td class="left">Количество знаков после запятой для дробления ассета</td>
</tr>

<tr>
<td class="left">owner</td>
<td class="left">(or db-null text)</td>
<td class="left">Ключ владельца ассета</td>
</tr>

<tr>
<td class="left">script</td>
<td class="left">(or db-null text)</td>
<td class="left">Код, управляющий ассетом (может отсутствовать)</td>
</tr>
</tbody>
</table>

<p>
Поле <code>name</code> должно всегда быть сопоставлено <code>asset_id</code> во избежание фрода, так как ноды
сети не следят за уникальностью <code>name</code>.
</p>

<p>
Поле <code>owner</code> содержит публичный ключ, которым должна быть проверена транзакция
<code>asset_reissue</code>, которая позволяет изменить поля уже выпущенного ассета. Если поле
<code>owner</code> содержит NULL - это явным образом запрещает обновление полей ассета.
</p>

<p>
Поле <code>script</code> если не NULL, то содержит скрипт, который управляет обработкой транзакций
с этим ассетом. Этот скрипт должен быть выполнен, когда нода обрабатывает любые
операции над этим ассетом.
</p>

<p>
Ассет создается транзакцией <code>asset_issue</code>, удаление ассета не предусмотренно, поскольку
кажется бессмысленным.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="asset_entity"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

&lt;&lt;gen_entity(<span style="color: #ffa07a;">"asset"</span>, <span style="color: #ffa07a;">"&#1072;&#1089;&#1089;&#1077;&#1090;&#1072;"</span>, asset_flds)&gt;&gt;
</pre>
</div>

<p>
Нода хранит ассеты и выполняет содержимое поля <code>script</code> при каждой транзакции, в
которой есть этот ассет.
</p>
</div>
</div>

<div id="outline-container-unnumbered-4" class="outline-2">
<h2 id="unnumbered-4">Accounts</h2>
<div class="outline-text-2" id="text-unnumbered-4">
<p>
Аккаунты пользователей хранят информацию о принадлежащих им ассетах. Каждый аккаунт
может владеть любым количеством единиц любого количества ассетов. Нода обновляет эту
информацию при обработке транзакций.
</p>

<table id="account_flds">
<caption class="t-above"><span class="table-number">Table 2:</span> Данные аккаунта</caption>

<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="left">version</td>
<td class="left">int</td>
<td class="left">Версия, от которой зависит способ работы</td>
</tr>

<tr>
<td class="left">account<sub>id</sub></td>
<td class="left">string</td>
<td class="left">Уникальный идентификтор аккаунта (публичный ключ)</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">string</td>
<td class="left">Имя владельца (не обязательно уникальное)</td>
</tr>

<tr>
<td class="left">descr</td>
<td class="left">text</td>
<td class="left">Описание, заполняется при создании</td>
</tr>

<tr>
<td class="left">script</td>
<td class="left">(or db-null text)</td>
<td class="left">Код, управляющий ассетом (может отсутствовать)</td>
</tr>
</tbody>
</table>

<p>
Поле <code>script</code> если не NULL, то содержит скрипт, который нода исполняет, когда на
аккаунт приходит транзакция. Выполнение скрипта тратит <code>газ</code>, который должен быть
приложен к такой транзакции. Выполнение скрипта может привести к возниконовению
"эффектов", о которых будет сказано позже.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="account_entity"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

&lt;&lt;gen_entity(<span style="color: #ffa07a;">"account"</span>, <span style="color: #ffa07a;">"&#1072;&#1082;&#1082;&#1072;&#1091;&#1085;&#1090;&#1072;"</span>, account_flds)&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-5" class="outline-2">
<h2 id="unnumbered-5"><span class="todo TODO">TODO</span> Transactions</h2>
<div class="outline-text-2" id="text-unnumbered-5">
<p>
Транзакции обеспечивают изменения состояния, которое хранят ноды сети.
</p>

<table id="transaction_flds">
<caption class="t-above"><span class="table-number">Table 3:</span> Данные транзакции</caption>

<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="left">version</td>
<td class="left">int</td>
<td class="left">Версия, от которой зависит способ работы</td>
</tr>

<tr>
<td class="left">sender<sub>id</sub></td>
<td class="left">string</td>
<td class="left">Публичный ключ отправителя</td>
</tr>

<tr>
<td class="left">recipient</td>
<td class="left">string</td>
<td class="left">Публичный ключ получателя</td>
</tr>

<tr>
<td class="left">asset<sub>id</sub></td>
<td class="left">string</td>
<td class="left">Идентификатор ассета</td>
</tr>

<tr>
<td class="left">gas</td>
<td class="left">int</td>
<td class="left">Кол-во приложенного газа</td>
</tr>
</tbody>
</table>

<div class="org-src-container">

<pre class="src src-lisp" id="transaction_entity"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

&lt;&lt;gen_entity(<span style="color: #ffa07a;">"transaction"</span>, <span style="color: #ffa07a;">"&#1090;&#1088;&#1072;&#1085;&#1079;&#1072;&#1082;&#1094;&#1080;&#1080;"</span>, transaction_flds)&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-6" class="outline-2">
<h2 id="unnumbered-6">Use cases</h2>
<div class="outline-text-2" id="text-unnumbered-6">
<p>
Все нужно проектировать сверху вниз, за исключением фундамента, с которого нужно
начинать (c) Алан Перлис.
</p>

<p>
Здесь рассмотрим самые простые сценарии, для которых может быть использована сеть, что
автоматически приведет нас к тому, кто её использует и каким образом. Сценарии нужны
чтобы понять взаимосвязи между объектами в системе.
</p>

<p>
Для демонстрации мы должны выполнить последовательно следующие сценарии:
</p>
<ul class="org-ul">
<li>Старт ноды
</li>
<li>Поиск соседей
</li>
<li>Создание начального состояния
</li>
<li>Синхронизация состояния
</li>
<li>Формирование кворума
</li>
<li>Создание ассета
</li>
<li>Подтверждение ассета
</li>
<li>Отправка перевода
</li>
<li>Подтверждение перевода
</li>
<li>Переформирование кворума
</li>
<li>Создание смарт-контракта
</li>
<li>Активация смарт-контракта
</li>
<li>Применение эффектов
</li>
</ul>
</div>

<div id="outline-container-unnumbered-7" class="outline-3">
<h3 id="unnumbered-7">Start of Node</h3>
<div class="outline-text-3" id="text-unnumbered-7">
<p>
При старте нода должна прочесть свой конфигурационный файл, в котором указан адрес и
порт, на котором нода будет ждать команды. Для наглядности там будет развернут
веб-интерфейс.
</p>

<p>
Нода ожидает найти свой конфиг в каталоге, в котором была запущена.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="config">(load
 (make-pathname <span style="color: #b0c4de;">:directory</span> (sb-posix:getcwd)
                <span style="color: #b0c4de;">:name</span> <span style="color: #ffa07a;">"node"</span>
                <span style="color: #b0c4de;">:type</span> <span style="color: #ffa07a;">"cfg"</span>))
</pre>
</div>

<p>
Образец конфига будет таким:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="config_example"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>

<span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">Configuration for Node of MyCoin</span>

(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

(<span style="color: #00ffff;">defparameter</span> <span style="color: #eedd82;">*node-addr*</span> <span style="color: #ffa07a;">"127.0.0.1"</span>)
(<span style="color: #00ffff;">defparameter</span> <span style="color: #eedd82;">*node-port*</span> 6660)

(<span style="color: #00ffff;">defparameter</span> <span style="color: #eedd82;">*start-neighbors*</span> 6660)
(<span style="color: #00ffff;">defparameter</span> <span style="color: #eedd82;">*end-neighbors*</span>   6669)
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-8" class="outline-3">
<h3 id="unnumbered-8">Finding neighbors</h3>
<div class="outline-text-3" id="text-unnumbered-8">
<p>
Процедура поиска соседей пока будет очень простой и рассчитанной только на локальное
разветрывание - нода будет обращаться по диапазону портов с запросом <code>who-are-you</code> и
если ответ соответствует ожиданиям - заносить адрес в коллекцию <code>neighbors</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="get_neighbors">(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">get-neighbors</span> ()
  (<span style="color: #00ffff;">loop</span> <span style="color: #b0c4de;">:for</span> port
     <span style="color: #b0c4de;">:from</span> *start-neighbors* <span style="color: #b0c4de;">:to</span> *end-neighbors*
     <span style="color: #b0c4de;">:when</span> (<span style="color: #00ffff;">handler-case</span>
               (drakma:http-request
                (format nil <span style="color: #ffa07a;">"http://localhost:~A/who-are-you"</span> port))
             ((or USOCKET:CONNECTION-REFUSED-ERROR USOCKET:TIMEOUT-ERROR)
                 (condition)
               nil))
     <span style="color: #b0c4de;">:collect</span> port))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(get-neighbors)</span>
</pre>
</div>

<p>
Для того чтобы это сработало нужно предусмотреть маршрут для запроса <code>who-are-you</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_who_are_you">(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

(restas:define-route who-are-you (<span style="color: #ffa07a;">"/who-are-you"</span>)
  (format nil <span style="color: #ffa07a;">"MyCoin Node #~A"</span> *node-port*))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-9" class="outline-3">
<h3 id="unnumbered-9">Genesis</h3>
<div class="outline-text-3" id="text-unnumbered-9">
<p>
Создание начального состояния - это специальный вид блока данных, содержащий
транзакции, которые формируют это начальное состояние. Для этого нам нужны следующие
виды транзакций:
</p>
<ul class="org-ul">
<li>создание ассета
</li>
<li>создание аккаунта
</li>
<li>перевод ассета на аккаунт, где отправитель - нулевой аккаунт
</li>
</ul>
</div>

<div id="outline-container-unnumbered-10" class="outline-4">
<h4 id="unnumbered-10">Transaction Asset Issue</h4>
<div class="outline-text-4" id="text-unnumbered-10">
<p>
Транзакция выпуска нового ассета. Помимо всех полей ассета должна содержать:
</p>

<table id="transaction_issue_asset_flds">
<caption class="t-above"><span class="table-number">Table 4:</span> Данные транзакции выпуска ассета</caption>

<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="left">id</td>
<td class="left">serial</td>
<td class="left">Ключевое поле</td>
</tr>

<tr>
<td class="left">version</td>
<td class="left">int</td>
<td class="left">Версия, от которой зависит способ работы</td>
</tr>

<tr>
<td class="left">sender</td>
<td class="left">(or db-null string)</td>
<td class="left">Публичный ключ аккаунта, который выпускает ассет</td>
</tr>

<tr>
<td class="left">fee<sub>asset</sub></td>
<td class="left">(or db-null string)</td>
<td class="left">Ассет, в котором платится комиссия</td>
</tr>

<tr>
<td class="left">fee<sub>value</sub></td>
<td class="left">(or db-null string)</td>
<td class="left">Размер комисии за создание нового ассета</td>
</tr>

<tr>
<td class="left">asset</td>
<td class="left">string</td>
<td class="left">Сериализованные поля ассета</td>
</tr>
</tbody>
</table>

<div class="org-src-container">

<pre class="src src-lisp" id="transaction_issue_asset_entity"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

&lt;&lt;gen_entity(<span style="color: #ffa07a;">"transaction-issue-asset"</span>, <span style="color: #ffa07a;">"&#1090;&#1088;&#1072;&#1085;&#1079;&#1072;&#1082;&#1094;&#1080;&#1080; &#1074;&#1099;&#1087;&#1091;&#1089;&#1082;&#1072; &#1072;&#1089;&#1089;&#1077;&#1090;&#1072;"</span>, transaction_issue_asset_flds)&gt;&gt;
</pre>
</div>

<p>
В genesis блоке мы должны выпустить самый первый ассет, в этом случае комиссия будет
равна NULL, и ассет в котором она платится тоже.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="serialization_with_print_object">(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">FROM: https://stackoverflow.com/questions/3086561/make-clos-objects-printable-in-lisp</span>

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">get-slots</span> (object)
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">thanks to cl-prevalence</span>
  #+openmcl
  (mapcar #'ccl:slot-definition-name
          (#-openmcl-native-threads ccl:class-instance-slots
                                    #+openmcl-native-threads ccl:class-slots
                                    (class-of object)))
  #+cmu
  (mapcar #'pcl:slot-definition-name (pcl:class-slots (class-of object)))
  #+sbcl
  (mapcar #'sb-pcl:slot-definition-name (sb-pcl:class-slots (class-of object)))
  #+lispworks
  (mapcar #'hcl:slot-definition-name (hcl:class-slots (class-of object)))
  #+allegro
  (mapcar #'mop:slot-definition-name (mop:class-slots (class-of object)))
  #+sbcl
  (mapcar #'sb-mop:slot-definition-name (sb-mop:class-slots (class-of object)))
  #+clisp
  (mapcar #'clos:slot-definition-name (clos:class-slots (class-of object)))
  #-(or openmcl cmu lispworks allegro sbcl clisp)
  (<span style="color: #ffc0cb; font-weight: bold;">error</span> <span style="color: #ffa07a;">"not yet implemented"</span>))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">Then, for reading you will need to run this piece of code, which sets up 1/2 of the syntax which is { type-of-object ((slot-name . slot-value) (slot-name . slot-value) ...)</span>

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">serialization</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(let ((test (make-transaction-issue-asset</span>
<span style="color: #ff7f24;">;;              </span><span style="color: #ff7f24;">:version 1</span>
<span style="color: #ff7f24;">;;              </span><span style="color: #ff7f24;">:sender nil</span>
<span style="color: #ff7f24;">;;              </span><span style="color: #ff7f24;">:fee_asset nil</span>
<span style="color: #ff7f24;">;;              </span><span style="color: #ff7f24;">:fee_value nil</span>
<span style="color: #ff7f24;">;;              </span><span style="color: #ff7f24;">:asset "")))</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(get-slots test))</span>

(set-macro-character
 #\{
 #'(<span style="color: #00ffff;">lambda</span> (str char)
     (<span style="color: #00ffff;">declare</span> (ignore char))
     (<span style="color: #00ffff;">let</span> ((list (read-delimited-list #\} str t)))
       (<span style="color: #00ffff;">let</span> ((type (first list))
             (list (second list)))
         (<span style="color: #00ffff;">let</span> ((class (allocate-instance (find-class type))))
           (<span style="color: #00ffff;">loop</span> <span style="color: #b0c4de;">:for</span> i <span style="color: #b0c4de;">:in</span> list <span style="color: #b0c4de;">:do</span>
                (setf (slot-value class (car i)) (cdr i)))
           class)))))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">{ TRANSACTION-ISSUE-ASSET ((ID . 9) (VERSION . 1) (SENDER) (FEE_ASSET)</span>
<span style="color: #ff7f24;">;;                            </span><span style="color: #ff7f24;">(FEE_VALUE) (ASSET . ""))}</span>

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">print-object</span> ((object standard-object) stream)
  (format stream <span style="color: #ffa07a;">"{ ~s ~s}"</span> (type-of object)
          (<span style="color: #00ffff;">loop</span> for i in (get-slots object)
             collect (cons i (slot-value object i)))))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(print-object (make-transaction-issue-asset</span>
<span style="color: #ff7f24;">;;                </span><span style="color: #ff7f24;">:version 1</span>
<span style="color: #ff7f24;">;;                </span><span style="color: #ff7f24;">:sender nil</span>
<span style="color: #ff7f24;">;;                </span><span style="color: #ff7f24;">:fee_asset nil</span>
<span style="color: #ff7f24;">;;                </span><span style="color: #ff7f24;">:fee_value nil</span>
<span style="color: #ff7f24;">;;                </span><span style="color: #ff7f24;">:asset "") t)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-11" class="outline-4">
<h4 id="unnumbered-11">Transaction Account Create</h4>
<div class="outline-text-4" id="text-unnumbered-11">
<table id="transaction_account_create_flds">
<caption class="t-above"><span class="table-number">Table 5:</span> Данные ассета</caption>

<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<tbody>
<tr>
<td class="left">version</td>
<td class="left">int</td>
<td class="left">Версия, от которой зависит способ работы</td>
</tr>

<tr>
<td class="left">asset<sub>id</sub></td>
<td class="left">string</td>
<td class="left">Уникальный идентификтор ассета</td>
</tr>

<tr>
<td class="left">name</td>
<td class="left">string</td>
<td class="left">Человекочитаемое имя (не обязательно уникальное)</td>
</tr>

<tr>
<td class="left">descr</td>
<td class="left">text</td>
<td class="left">Описание ассета, заполняется при создании</td>
</tr>

<tr>
<td class="left">quantity</td>
<td class="left">(or db-null int)</td>
<td class="left">Количество единиц ассета, может быть неопределено</td>
</tr>

<tr>
<td class="left">decimals</td>
<td class="left">int</td>
<td class="left">Количество знаков после запятой для дробления ассета</td>
</tr>

<tr>
<td class="left">owner</td>
<td class="left">(or db-null text)</td>
<td class="left">Ключ владельца ассета</td>
</tr>

<tr>
<td class="left">script</td>
<td class="left">(or db-null text)</td>
<td class="left">Код, управляющий ассетом (может отсутствовать)</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-unnumbered-12" class="outline-3">
<h3 id="unnumbered-12">Synchronization of State</h3>
<div class="outline-text-3" id="text-unnumbered-12">
</div><div id="outline-container-unnumbered-13" class="outline-4">
<h4 id="unnumbered-13"><span class="todo TODO">TODO</span> Verifycation of Transaction</h4>
<div class="outline-text-4" id="text-unnumbered-13">
<p>
Когда Node получает транзакцию (от клиента, в пул неподтвержденных транзакций или в
составе блока), она должна проверить ее валидность. Эта проверка состоит из применения
правил, зависящих от типа транзакции (и возможно от содержимого полей)
</p>

<p>
Если транзакция не удовлетворила какому-то из правил - обработка останавливается,
ошибка пробрасывается от правила вверх и транзакция удаляется.
</p>

<p>
Через все правила протягивается входное состояние и если транзакция удовлетворила всем
правилам мы получаем разницу между исходным состоянием и новым, которую потом применяем
к исходному состоянию (некоторые наборы транзакций должны быть выполнены атомарно)
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-unnumbered-14" class="outline-2">
<h2 id="unnumbered-14">Установка и настройка</h2>
<div class="outline-text-2" id="text-unnumbered-14">
<p>
Ключевой элемент проекта - узел распределенной децентрализованной сети, называемый
<code>Node</code>. Каждый из этих узлов имеет свой адрес и порт, при развертывании на локальной
машине адрес будет одним и тем же: 127.0.0.1, меняется только порт.
</p>

<p>
Для удобства каждый узел имеет веб интерфейс, размещенный на этом порту. Этот
веб-интерфейс показывает состояние ноды и имеет JSON-RPC API для работы с нодой. Все
взаимодействие с нодой происходит через это API.
</p>

<p>
Node работает внутри образа <code>Common Lisp</code> под управлением веб-сервера <code>hunchentoot</code>. В
качестве высокоуровневой библиотеки используется <a href="https://github.com/archimag/restas">RESTAS</a>, которую написал Андрей
Москвитин (archimag).
</p>

<p>
Веб-сервер, библиотеку RESTAS и все необходимые зависимости лучше всего установить при
помощи менеджера библиотек <a href="http://quicklisp.org">Quicklisp</a>.
</p>

<p>
Чтобы запустить проект и попробовать его в работе, пройдите раздел "Легкий
старт". Остальные разделы потребуются вам чтобы обеспечить инструментарий для
литературного программирования.
</p>
</div>

<div id="outline-container-unnumbered-15" class="outline-3">
<h3 id="unnumbered-15">Легкий старт</h3>
<div class="outline-text-3" id="text-unnumbered-15">
<p>
Установите <code>git</code> - систему управления версиями, если она еще не
установлена:
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo apt-get install git
</pre>
</div>

<p>
Клонируйте репозиторий, который содержит проект:
</p>

<div class="org-src-container">

<pre class="src src-sh">mkdir -p ~/repo
<span style="color: #b0c4de;">cd</span> ~/repo
git clone git@github.com:rigidus/rigidus.ru.git
</pre>
</div>

<p>
Установите <code>sbcl</code> - реализацию Common Lisp:
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo apt-get install sbcl
</pre>
</div>

<p>
Установите quicklisp - менеджер библиотек для Common Lisp:
</p>

<div class="org-src-container">

<pre class="src src-sh">mkdir -p ~/build
<span style="color: #b0c4de;">cd</span> ~/build
wget https://beta.quicklisp.org/quicklisp.lisp
</pre>
</div>

<p>
и запустить его с помощью sbcl:
</p>

<div class="org-src-container">

<pre class="src src-sh">sbcl --load quicklisp.lisp
</pre>
</div>

<p>
Теперь мы внутри <code>quicklisp</code>-а, работающего в образе <code>sbcl</code>. Попросим его добавить себя
в инициализационный файл, чтобы <code>quicklisp</code> загружался каждый раз, когда стартует
<code>sbcl</code>:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(ql:add-to-init-file)
</pre>
</div>

<p>
Выйдите из лиспа:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(quit)
</pre>
</div>

<p>
Откройте файл <code>~/.sbclrc</code> и добавьте в конец файла следующие строки,
чтобы <code>quicklisp</code> знал, где находится репозиторий с проектом:
</p>

<div class="org-src-container">

<pre class="src src-lisp">#+quicklisp
(mapcar #'(<span style="color: #00ffff;">lambda</span> (x)
            (pushnew x ql:*local-project-directories*))
        (list #P<span style="color: #ffa07a;">"~/repo/rigidus.ru/org/lrn/crypto/"</span>))
</pre>
</div>

<p>
Снова запустите <code>sbcl</code>
</p>

<div class="org-src-container">

<pre class="src src-sh">sbcl
</pre>
</div>

<p>
И в нем загрузите проект:
</p>

<div class="org-src-container">

<pre class="src src-lisp">(ql:quickload <span style="color: #ffa07a;">"mycoin"</span>)
</pre>
</div>

<p>
Наберите в адресной строке броузера <code>http://localhost:9994</code> и
загрузите главную страницу.
</p>
</div>
</div>
</div>

<div id="outline-container-unnumbered-16" class="outline-2">
<h2 id="unnumbered-16">Assembly</h2>
<div class="outline-text-2" id="text-unnumbered-16">
</div><div id="outline-container-unnumbered-17" class="outline-3">
<h3 id="unnumbered-17">System definition</h3>
<div class="outline-text-3" id="text-unnumbered-17">
<p>
Файл определения системы представляет собой каркас проекта и содержит
в себе определение системы:
</p>
<ul class="org-ul">
<li>библиотеки, от которых зависит система
</li>
<li>набор всех файлов, который должны быть загружены в лисп-процесс.
</li>
</ul>

<p>
Определение системы экпортируется из литературного исходника в
корневой каталог проекта.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="defsystem"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(asdf:defsystem #<span style="color: #b0c4de;">:mycoin</span>
  <span style="color: #b0c4de;">:version</span>      <span style="color: #ffa07a;">"0.0.1"</span>
  <span style="color: #b0c4de;">:author</span>       <span style="color: #ffa07a;">"rigidus <a href="mailto:i.am.rigidus%40gmail.com">&lt;i.am.rigidus@gmail.com&gt;</a>"</span>
  <span style="color: #b0c4de;">:licence</span>      <span style="color: #ffa07a;">"AGPLv3"</span>
  <span style="color: #b0c4de;">:description</span>  <span style="color: #ffa07a;">"mycoincurrency for experimental purposes"</span>
  <span style="color: #b0c4de;">:depends-on</span>   (#<span style="color: #b0c4de;">:anaphora</span>
                 #<span style="color: #b0c4de;">:closer-mop</span>
                 #<span style="color: #b0c4de;">:cl-ppcre</span>
                 #<span style="color: #b0c4de;">:cl-base64</span>
                 #<span style="color: #b0c4de;">:cl-json</span>
                 #<span style="color: #b0c4de;">:cl-html5-parser</span>
                 #<span style="color: #b0c4de;">:cl-who</span>
                 #<span style="color: #b0c4de;">:cl-fad</span>
                 #<span style="color: #b0c4de;">:optima</span>
                 #<span style="color: #b0c4de;">:closure-template</span>
                 #<span style="color: #b0c4de;">:drakma</span>
                 #<span style="color: #b0c4de;">:restas</span>
                 #<span style="color: #b0c4de;">:restas-directory-publisher</span>
                 #<span style="color: #b0c4de;">:split-sequence</span>
                 #<span style="color: #b0c4de;">:postmodern</span>
                 #<span style="color: #b0c4de;">:restas</span>
                 #<span style="color: #b0c4de;">:optima</span>
                 #<span style="color: #b0c4de;">:fare-quasiquote-extras</span>
                 #<span style="color: #b0c4de;">:fare-quasiquote-optima</span>
                 #<span style="color: #b0c4de;">:ironclad</span>)
  <span style="color: #b0c4de;">:serial</span>       t
  <span style="color: #b0c4de;">:components</span>   ((<span style="color: #b0c4de;">:module</span> <span style="color: #ffa07a;">"src"</span>
                          <span style="color: #b0c4de;">:serial</span> t
                          <span style="color: #b0c4de;">:pathname</span> <span style="color: #ffa07a;">"src"</span>
                          <span style="color: #b0c4de;">:components</span> ((<span style="color: #b0c4de;">:static-file</span> <span style="color: #ffa07a;">"templates.htm"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"prepare"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"defmodule"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"entity"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"entityes"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"render"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"routes"</span>)
                                       (<span style="color: #b0c4de;">:file</span> <span style="color: #ffa07a;">"init"</span>)
                                       ))))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-18" class="outline-3">
<h3 id="unnumbered-18">Prepare to start</h3>
<div class="outline-text-3" id="text-unnumbered-18">
<p>
Этот файл (<code>prepare.lisp</code>) компилирует шаблоны и создает пакет <code>TPL</code>. Он делает это еще
до объявления базового пакета. Для того чтобы в процессе загрузки все ссылки на этот
пакет были правильно разрешены, необходимо, чтобы создание пакета завершилось к моменту
появления ссылок на него. А для этого нужно помещать компиляцию в отдельный файл.
</p>

<p>
Однако тогда у нас возникает проблема, заключающаяся в том, что <code>base-dir</code>, путь, от
которого отсчитываются все пути придется объявлять дважды - вне пакета и внутри
него. Чтобы не иметь необходимость вносить изменения в два места одновременно, мы
решаем эту проблему подстановкой средствами литературного программирования:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="base_dir">(merge-pathnames
 (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"repo/rigidus.ru/org/lrn/crypto"</span>))
 (user-homedir-pathname))
</pre>
</div>


<div class="org-src-container">

<pre class="src src-lisp" id="prepare"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>

(closure-template:compile-template
 <span style="color: #b0c4de;">:common-lisp-backend</span> (merge-pathnames
                       (make-pathname <span style="color: #b0c4de;">:name</span> <span style="color: #ffa07a;">"templates"</span> <span style="color: #b0c4de;">:type</span> <span style="color: #ffa07a;">"htm"</span>)
                       (merge-pathnames
                        (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"src"</span>))
                        &lt;&lt;base_dir&gt;&gt;)))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-19" class="outline-3">
<h3 id="unnumbered-19">Определение пакетов</h3>
<div class="outline-text-3" id="text-unnumbered-19">
<p>
Что такое пакет и зачем он нужен лучше всего прочитать <a href="doc/packages-in-lisp.html">тут</a>. Обычно определение пакетов
экспортируется в файл <code>src/package.lisp</code>, но этот проект пока слишком простой, он
содержит всего один пакет (если не считать html-шаблонов)
</p>

<p>
Поэтому определение пакета происходит в разделе <i>Определение модуля</i>
</p>

<p>
А вот текущий пакет, на случай переименования может быть подставлен средствами
литературного прогрммирования:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="package">mycoin
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-20" class="outline-3">
<h3 id="unnumbered-20">Утилиты</h3>
<div class="outline-text-3" id="text-unnumbered-20">
<p>
Несколько маленьких утилитарных функций определены здесь. При экспорте они подключатся
в тот же файл, где происходит определение модуля. Это функции:
</p>
<ul class="org-ul">
<li>отладочного вывода и ошибок
</li>
<li>получения содержимого директории
</li>
</ul>

<div class="org-src-container">

<pre class="src src-lisp" id="utility">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:mycoin</span>)

(<span style="color: #00ffff;">define-condition</span> <span style="color: #87cefa;">pattern-not-found-error</span> (<span style="color: #ffc0cb; font-weight: bold;">error</span>)
  ((text <span style="color: #b0c4de;">:initarg</span> <span style="color: #b0c4de;">:text</span> <span style="color: #b0c4de;">:reader</span> text)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">get-directory-contents</span> (path)
  <span style="color: #ffa07a;">"&#1060;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; &#1089;&#1086;&#1076;&#1077;&#1088;&#1078;&#1080;&#1084;&#1086;&#1077; &#1082;&#1072;&#1090;&#1072;&#1083;&#1086;&#1075;&#1072;"</span>
  (<span style="color: #00ffff;">when</span> (not (equal <span style="color: #ffa07a;">"/"</span> (coerce (last (coerce path 'list)) 'string)))
    (setf path (format nil <span style="color: #ffa07a;">"~A/"</span> path)))
  (directory (format nil <span style="color: #ffa07a;">"~A*.*"</span> path)))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1055;&#1088;&#1077;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; &#1080;&#1085;&#1080;&#1094;&#1080;&#1072;&#1083;&#1080;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1085;&#1099;&#1077; &#1087;&#1086;&#1083;&#1103; &#1086;&#1073;&#1098;&#1077;&#1082;&#1090;&#1072; &#1074; plist</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">get-obj-data</span> (obj)
  (<span style="color: #00ffff;">let</span> ((class (find-class (type-of obj)))
        (result))
    (<span style="color: #00ffff;">loop</span> <span style="color: #b0c4de;">:for</span> slot <span style="color: #b0c4de;">:in</span> (closer-mop:class-direct-slots class) <span style="color: #b0c4de;">:collect</span>
       (<span style="color: #00ffff;">let</span> ((slot-name (closer-mop:slot-definition-name slot)))
         (<span style="color: #00ffff;">when</span> (slot-boundp obj slot-name)
           (setf result
                 (append result (list (intern (symbol-name slot-name) <span style="color: #b0c4de;">:keyword</span>)
                                      (funcall slot-name obj)))))))
    result))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">Assembly WHERE clause</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">make-clause-list</span> (glob-rel rel args)
  (append (list glob-rel)
          (<span style="color: #00ffff;">loop</span>
             <span style="color: #b0c4de;">:for</span> i
             <span style="color: #b0c4de;">:in</span> args
             <span style="color: #b0c4de;">:when</span> (and (symbolp i)
                        (getf args i)
                        (not (symbolp (getf args i))))
             <span style="color: #b0c4de;">:collect</span> (list rel i (getf args i)))))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1052;&#1072;&#1082;&#1088;&#1086;&#1089;&#1099; &#1076;&#1083;&#1103; &#1082;&#1086;&#1088;&#1088;&#1077;&#1082;&#1090;&#1085;&#1086;&#1075;&#1086; &#1074;&#1099;&#1074;&#1086;&#1076;&#1072; &#1086;&#1096;&#1080;&#1073;&#1086;&#1082;</span>
(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">bprint</span> (var)
  `(subseq (<span style="color: #00ffff;">with-output-to-string</span> (*standard-output*)  (pprint ,var)) 1))

(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">err</span> (var)
  `(<span style="color: #ffc0cb; font-weight: bold;">error</span> (format nil <span style="color: #ffa07a;">"ERR:[~A]"</span> (bprint ,var))))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1054;&#1090;&#1083;&#1072;&#1076;&#1086;&#1095;&#1085;&#1099;&#1081; &#1074;&#1099;&#1074;&#1086;&#1076;</span>
(<span style="color: #00ffff;">defparameter</span> <span style="color: #eedd82;">*dbg-enable*</span> t)
(<span style="color: #00ffff;">defparameter</span> <span style="color: #eedd82;">*dbg-indent*</span> 1)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">dbgout</span> (out)
  (<span style="color: #00ffff;">when</span> *dbg-enable*
    (format t (format nil <span style="color: #ffa07a;">"~~%~~~AT~~A"</span> *dbg-indent*) out)))

(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">dbg</span> (frmt <span style="color: #98fb98;">&amp;rest</span> params)
  `(dbgout (format nil ,frmt ,@params)))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(macroexpand-1 '(dbg "~A~A~{~A~^,~}" "zzz" "34234" '(1 2 3 4)))</span>

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">anything-to-keyword</span> (item)
  (intern (string-upcase (format nil <span style="color: #ffa07a;">"~a"</span> item)) <span style="color: #b0c4de;">:keyword</span>))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">alist-to-plist</span> (alist)
  (<span style="color: #00ffff;">if</span> (not (equal (type-of alist) 'cons))
      alist
      <span style="color: #ff7f24;">;;</span><span style="color: #ff7f24;">else</span>
      (<span style="color: #00ffff;">loop</span>
         <span style="color: #b0c4de;">:for</span> (key . value)
         <span style="color: #b0c4de;">:in</span> alist
         <span style="color: #b0c4de;">:nconc</span> (list (anything-to-keyword key) value))))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1063;&#1090;&#1086;&#1073;&#1099; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1090;&#1100; &#1082;&#1086;&#1083;&#1083;&#1077;&#1082;&#1094;&#1080;&#1080; &#1085;&#1072;&#1087;&#1080;&#1096;&#1077;&#1084; &#1084;&#1072;&#1082;&#1088;&#1086;&#1089;</span>
(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">with-collection</span> ((item collection) <span style="color: #98fb98;">&amp;body</span> body)
  `(<span style="color: #00ffff;">loop</span> <span style="color: #b0c4de;">:for</span> ,item <span style="color: #b0c4de;">:in</span> ,collection <span style="color: #b0c4de;">:collect</span>
      ,@body))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1063;&#1090;&#1086;&#1073;&#1099; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1090;&#1100; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1082;&#1086;&#1083;&#1083;&#1077;&#1082;&#1094;&#1080;&#1080; &#1085;&#1072;&#1087;&#1080;&#1096;&#1077;&#1084; &#1084;&#1072;&#1082;&#1088;&#1086;&#1089;</span>
(<span style="color: #00ffff;">defmacro</span> <span style="color: #87cefa;">with-element</span> ((item elt) <span style="color: #98fb98;">&amp;body</span> body)
  `(<span style="color: #00ffff;">let</span> ((,item ,elt))
     (list
      ,@body)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">replace-all</span> (string part replacement <span style="color: #98fb98;">&amp;key</span> (test #'char=))
  <span style="color: #ffa07a;">"Returns a new string in which all the occurences of the part</span>
<span style="color: #ffa07a;">         is replaced with replacement."</span>
  (<span style="color: #00ffff;">with-output-to-string</span> (out)
    (<span style="color: #00ffff;">loop</span> with part-length = (length part)
       for old-pos = 0 then (+ pos part-length)
       for pos = (search part string
                         <span style="color: #b0c4de;">:start2</span> old-pos
                         <span style="color: #b0c4de;">:test</span> test)
       do (write-string string out
                        <span style="color: #b0c4de;">:start</span> old-pos
                        <span style="color: #b0c4de;">:end</span> (or pos (length string)))
       when pos do (write-string replacement out)
       while pos)))

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">explore-dir</span> (path)
  (<span style="color: #00ffff;">let</span> ((raw (directory path))
        (dirs)
        (files))
    (mapcar #'(<span style="color: #00ffff;">lambda</span> (x)
                (<span style="color: #00ffff;">if</span> (cl-fad:directory-pathname-p x)
                    (push x dirs)
                    (push x files)))
            raw)
    (values dirs files raw)))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">clear-db</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">drop</span> (tbl-lst)
  (<span style="color: #00ffff;">let</span> ((tables tbl-lst))
    (<span style="color: #00ffff;">flet</span> ((rmtbl (tblname)
             (<span style="color: #00ffff;">when</span> (with-connection *db-spec*
                     (query (<span style="color: #b0c4de;">:select</span> 'table_name <span style="color: #b0c4de;">:from</span> 'information_schema.tables <span style="color: #b0c4de;">:where</span>
                                     (<span style="color: #b0c4de;">:and</span> (<span style="color: #b0c4de;">:=</span> 'table_schema <span style="color: #ffa07a;">"public"</span>)
                                           (<span style="color: #b0c4de;">:=</span> 'table_name tblname)))))
               (with-connection *db-spec*
                 (query (<span style="color: #b0c4de;">:drop-table</span> (intern (string-upcase tblname))))))))
      (<span style="color: #00ffff;">loop</span> <span style="color: #b0c4de;">:for</span> tblname <span style="color: #b0c4de;">:in</span> tables <span style="color: #b0c4de;">:collect</span>
         (rmtbl tblname)))))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">contains</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">contains</span> (string pattern)
  (<span style="color: #00ffff;">if</span> (search pattern string)
      t))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">empty</span>
(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">empty</span> (string)
  (<span style="color: #00ffff;">if</span> (or (null string)
          (equal <span style="color: #ffa07a;">""</span> string))
      t))
</pre>
</div>
</div>
</div>


<div id="outline-container-unnumbered-21" class="outline-3">
<h3 id="unnumbered-21">Copyright</h3>
<div class="outline-text-3" id="text-unnumbered-21">
<p>
Копирайт вставляется в каждый сгенерированный файл для того чтобы соблюсти требования
лицензии AGPLv3
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="copyright">Copyright &#169; 2014-2018 Glukhov Mikhail. All rights reserved.
Licensed under the GNU AGPLv3
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-22" class="outline-3">
<h3 id="unnumbered-22">Main module definition</h3>
<div class="outline-text-3" id="text-unnumbered-22">
<p>
Файл определения модуля экспортируется в каталог <code>src</code>. Во время экспорта в него
включаются утилиты.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="defmodule"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(restas:define-module #<span style="color: #b0c4de;">:mycoin</span>
  (<span style="color: #b0c4de;">:use</span> #<span style="color: #b0c4de;">:closer-mop</span> #<span style="color: #b0c4de;">:cl</span> #<span style="color: #b0c4de;">:iter</span> #<span style="color: #b0c4de;">:alexandria</span> #<span style="color: #b0c4de;">:anaphora</span> #<span style="color: #b0c4de;">:postmodern</span>)
  (<span style="color: #b0c4de;">:shadowing-import-from</span> <span style="color: #b0c4de;">:closer-mop</span>
                          <span style="color: #b0c4de;">:defclass</span>
                          <span style="color: #b0c4de;">:defmethod</span>
                          <span style="color: #b0c4de;">:standard-class</span>
                          <span style="color: #b0c4de;">:ensure-generic-function</span>
                          <span style="color: #b0c4de;">:defgeneric</span>
                          <span style="color: #b0c4de;">:standard-generic-function</span>
                          <span style="color: #b0c4de;">:class-name</span>))

(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">special syntax for pattern-matching - ON</span>
(named-readtables:in-readtable <span style="color: #b0c4de;">:fare-quasiquote</span>)

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1055;&#1086;&#1076;&#1082;&#1083;&#1102;&#1095;&#1077;&#1085;&#1080;&#1077; &#1082; &#1073;&#1072;&#1079;&#1077; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; PostgreSQL</span>
(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">*db-name*</span> <span style="color: #ffa07a;">"mycoin"</span>)
(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">*db-user*</span> <span style="color: #ffa07a;">"crypto"</span>)
(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">*db-pass*</span> <span style="color: #ffa07a;">"9Jb17sqGQtZb927hRp37Hbspba7p34L"</span>)
(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">*db-serv*</span> <span style="color: #ffa07a;">"localhost"</span>)

(<span style="color: #00ffff;">defvar</span> <span style="color: #eedd82;">*db-spec*</span> (list *db-name* *db-user* *db-pass* *db-serv*))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1047;&#1076;&#1077;&#1089;&#1100; &#1087;&#1086;&#1076;&#1082;&#1083;&#1102;&#1095;&#1072;&#1102;&#1090;&#1089;&#1103; &#1091;&#1090;&#1080;&#1083;&#1080;&#1090;&#1099;</span>
&lt;&lt;utility&gt;&gt;

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1052;&#1077;&#1093;&#1072;&#1085;&#1080;&#1079;&#1084; &#1090;&#1088;&#1072;&#1085;&#1089;&#1083;&#1103;&#1094;&#1080;&#1080; &#1087;&#1091;&#1090;&#1077;&#1081;</span>
&lt;&lt;pathname-translations&gt;&gt;

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1056;&#1072;&#1073;&#1086;&#1090;&#1072; &#1089; html tree</span>
&lt;&lt;html_s_tree&gt;&gt;

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1052;&#1077;&#1093;&#1072;&#1085;&#1080;&#1079;&#1084; &#1087;&#1088;&#1077;&#1086;&#1073;&#1088;&#1072;&#1079;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; &#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;</span>
&lt;&lt;enobler&gt;&gt;

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&#1063;&#1080;&#1090;&#1072;&#1077;&#1084; &#1080; &#1087;&#1088;&#1080;&#1084;&#1077;&#1085;&#1103;&#1077;&#1084; &#1082;&#1086;&#1085;&#1092;&#1080;&#1075;</span>
&lt;&lt;config&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-23" class="outline-3">
<h3 id="unnumbered-23">Entityes</h3>
<div class="outline-text-3" id="text-unnumbered-23">
<div class="org-src-container">

<pre class="src src-lisp" id="entityes"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

&lt;&lt;asset_entity&gt;&gt;
&lt;&lt;account_entity&gt;&gt;

&lt;&lt;transaction_issue_asset_entity&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-24" class="outline-3">
<h3 id="unnumbered-24">Initialization</h3>
<div class="outline-text-3" id="text-unnumbered-24">
<p>
Эта часть запускает сервер на порту, который [TODO:gmm] должна брать из конфига
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="init"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">start</span>
(restas:start '#<span style="color: #b0c4de;">:mycoin</span> <span style="color: #b0c4de;">:port</span> *node-port*)
(restas:debug-mode-on)
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(restas:debug-mode-off)</span>
(setf hunchentoot:*catch-errors-p* t)
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-25" class="outline-3">
<h3 id="unnumbered-25">Path translation</h3>
<div class="outline-text-3" id="text-unnumbered-25">
<p>
Трансляция путей производится с помощью встроенного механизма
<code>logical-pathname-translations</code>
</p>

<p>
По-умолчанию считается, что директория, от которой отсчитываются пути: <code>base-dir</code>. Я не
стал создавать отдельный конфигурационный файл для этой информации.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="pathname-translations">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:mycoin</span>)

(<span style="color: #00ffff;">defparameter</span> <span style="color: #eedd82;">*base-dir*</span>
  &lt;&lt;base_dir&gt;&gt;)

(<span style="color: #00ffff;">defparameter</span> <span style="color: #eedd82;">*base-path*</span> (directory-namestring *base-dir*))

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(setf (logical-pathname-translations "org")</span>
<span style="color: #ff7f24;">;;       </span><span style="color: #ff7f24;">`(("source;*.*"</span>
<span style="color: #ff7f24;">;;          </span><span style="color: #ff7f24;">,(concatenate 'string *base-path* "org/*.org"))</span>
<span style="color: #ff7f24;">;;         </span><span style="color: #ff7f24;">("publish;*.*"</span>
<span style="color: #ff7f24;">;;          </span><span style="color: #ff7f24;">,(concatenate 'string *base-path* "www/*.html"))))</span>

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(translate-logical-pathname "org:source;articles;about.txt")</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">;; #P"/home/rigidus/repo/rigidus.ru/org/articles/about.org"</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(translate-logical-pathname "org:source;articles;emacs;about.txt")</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">;; #P"/home/rigidus/repo/rigidus.ru/org/articles/emacs/about.org"</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(translate-logical-pathname "org:publish;articles;about.txt")</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">;; #P"/home/rigidus/repo/rigidus.ru/www/articles/about.org"</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(translate-logical-pathname "org:publish;articles;emacs;about.txt")</span>
<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">;; #P"/home/rigidus/repo/rigidus.ru/www/articles/emacs/about.org"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-26" class="outline-3">
<h3 id="unnumbered-26">Codegeneration</h3>
<div class="outline-text-3" id="text-unnumbered-26">
<p>
Требуется расширить emacs функциями, которые будет генерировать код из таблиц
литерурного исходника.
</p>

<p>
Чтобы emacs не запрашивал подтверждение на каждый вызов таких функций, установим эту
настройку:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_org_confirm">(<span style="color: #00ffff;">setq</span> org-confirm-babel-evaluate nil)
</pre>
</div>

<p>
Начнем с генерации кода из таблицы полей:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_fields">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">gen-fields</span> (rows)
  (<span style="color: #00ffff;">let</span> ((result))
    (<span style="color: #00ffff;">push</span> <span style="color: #ffa07a;">"\n"</span> result)
    (<span style="color: #00ffff;">push</span> (format <span style="color: #ffa07a;">"  (%s\n"</span> (butlast (car rows))) result)
    (mapcar #'(lambda (x)
                (<span style="color: #00ffff;">push</span> (format <span style="color: #ffa07a;">"   %s\n"</span> (butlast x)) result))
            (butlast (cdr rows)))
    (<span style="color: #00ffff;">push</span> (format <span style="color: #ffa07a;">"   %s)"</span> (butlast (car (last rows)))) result)
    (mapconcat 'identity (reverse result) <span style="color: #ffa07a;">""</span>)))
</pre>
</div>

<p>
Теперь напишем код, который генерирует код для состояний конечного автомата:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_states">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">gen-states</span> (rows)
  (<span style="color: #00ffff;">let</span> ((result)
        (hash (make-hash-table <span style="color: #b0c4de;">:test</span> #'equal))
        (states))
    (<span style="color: #00ffff;">dolist</span> (elt rows nil)
      (puthash (cadr elt) nil hash)
      (puthash (cadr (cdr elt))  nil hash))
    (maphash (<span style="color: #00ffff;">lambda</span> (k v)
               (<span style="color: #00ffff;">push</span> k states))
             hash)
    (<span style="color: #00ffff;">push</span> <span style="color: #ffa07a;">"\n"</span> result)
    (<span style="color: #00ffff;">push</span> <span style="color: #ffa07a;">"  ("</span> result)
    (<span style="color: #00ffff;">dolist</span> (elt (butlast states))
      (<span style="color: #00ffff;">push</span> (format <span style="color: #ffa07a;">":%s "</span> elt) result))
    (<span style="color: #00ffff;">push</span> (format <span style="color: #ffa07a;">":%s)"</span> (car (last states))) result)
    (mapconcat 'identity (reverse result) <span style="color: #ffa07a;">""</span>)))
</pre>
</div>

<p>
И добавим к этом генератор действий - т.е. переходов между состояниями:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="gen_actions">(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">gen-actions</span> (rows)
  (<span style="color: #00ffff;">let</span> ((result))
    (<span style="color: #00ffff;">push</span> <span style="color: #ffa07a;">"\n"</span> result)
    (<span style="color: #00ffff;">let</span> ((x (car rows)))
      (<span style="color: #00ffff;">push</span> (format <span style="color: #ffa07a;">"  ((:%s :%s :%s)"</span> (cadr x) (cadr (cdr x)) (car x)) result))
    (<span style="color: #00ffff;">if</span> (equal 1 (length rows))
        (<span style="color: #00ffff;">push</span> <span style="color: #ffa07a;">")"</span> result)
      (<span style="color: #00ffff;">progn</span>
        (<span style="color: #00ffff;">push</span> <span style="color: #ffa07a;">"\n"</span> result)
        (mapcar #'(lambda (x)
                    (<span style="color: #00ffff;">push</span> (format <span style="color: #ffa07a;">"   (:%s :%s :%s)\n"</span> (cadr x) (cadr (cdr x)) (car x)) result))
                (cdr (butlast rows)))
        (<span style="color: #00ffff;">let</span> ((x (car (last rows))))
          (<span style="color: #00ffff;">push</span> (format <span style="color: #ffa07a;">"   (:%s :%s :%s))"</span> (cadr x) (cadr (cdr x)) (car x)) result))))
    (mapconcat 'identity (reverse result) <span style="color: #ffa07a;">""</span>)))
</pre>
</div>

<p>
Соберем все это в один файл, чтобы загружать перед кодогенерацией проекта:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="generators"><span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>

&lt;&lt;gen_org_confirm&gt;&gt;

&lt;&lt;gen_fields&gt;&gt;

&lt;&lt;gen_states&gt;&gt;

&lt;&lt;gen_actions&gt;&gt;
</pre>
</div>

<p>
И загрузим его:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp" id="generators">(load-file <span style="color: #ffa07a;">"generators.el"</span>)
</pre>
</div>

<p>
Теперь у нас есть все необходимое, чтобы написать вызываемые при tangle генераторы
сущностей и автоматов:
</p>
</div>
</div>
</div>

<div id="outline-container-unnumbered-27" class="outline-2">
<h2 id="unnumbered-27">Html-tree</h2>
<div class="outline-text-2" id="text-unnumbered-27">
<p>
В процессе работы бывает очень полезным представление страницы в виде дерева
s-выражений. Для того чтобы разбирать html в дерево и собирать его обратно используется
парсер из библиотеки <code>html5-parser</code> и простой сборщик, сохраняющий отступы:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="html_s_tree">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:mycoin</span>)

&lt;&lt;html_to_tree&gt;&gt;
&lt;&lt;tree_to_html&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-unnumbered-28" class="outline-3">
<h3 id="unnumbered-28">Парсинг html</h3>
<div class="outline-text-3" id="text-unnumbered-28">
<p>
Разбираем html в дерево s-выражений
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="html_to_tree">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:mycoin</span>)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">html-to-tree</span> (html)
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(html5-parser:node-to-xmls</span>
  (html5-parser:parse-html5-fragment html <span style="color: #b0c4de;">:dom</span> <span style="color: #b0c4de;">:xmls</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-29" class="outline-3">
<h3 id="unnumbered-29">Сборка в html</h3>
<div class="outline-text-3" id="text-unnumbered-29">
<div class="org-src-container">

<pre class="src src-lisp" id="tree_to_html">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:mycoin</span>)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">tree-to-html</span> (tree <span style="color: #98fb98;">&amp;optional</span> (step 0))
  (<span style="color: #00ffff;">macrolet</span> ((indent ()
               `(make-string (* 3 step) <span style="color: #b0c4de;">:initial-element</span> #\Space)))
    (<span style="color: #00ffff;">labels</span> ((paired (subtree)
               (format nil <span style="color: #ffa07a;">"~A&lt;~A~A&gt;~%~A~4:*~A&lt;/~A&gt;~%"</span>
                       (indent)
                       (car subtree)
                       (format nil <span style="color: #ffa07a;">"~:[~; ~1:*~{~A~^ ~}~]"</span>
                               (mapcar #'(<span style="color: #00ffff;">lambda</span> (attr)
                                           (<span style="color: #00ffff;">let</span> ((key (car attr))
                                                 (val (cadr attr)))
                                             (format nil <span style="color: #ffa07a;">"~A=\"~A\""</span> key val)))
                                       (cadr subtree)))
                       (format nil <span style="color: #ffa07a;">"~{~A~}"</span>
                               (<span style="color: #00ffff;">progn</span>
                                 (incf step)
                                 (<span style="color: #00ffff;">let</span> ((ret (mapcar #'(<span style="color: #00ffff;">lambda</span> (x)
                                                        (subtree-to-html x step))
                                                    (cddr subtree))))
                                   (decf step)
                                   ret)))))
             (singled (subtree)
               (format nil <span style="color: #ffa07a;">"~A&lt;~A~A /&gt;~%"</span>
                       (indent)
                       (car subtree)
                       (format nil <span style="color: #ffa07a;">"~:[~; ~1:*~{~A~^ ~}~]"</span>
                               (mapcar #'(<span style="color: #00ffff;">lambda</span> (attr)
                                           (<span style="color: #00ffff;">let</span> ((key (car attr))
                                                 (val (cadr attr)))
                                             (format nil <span style="color: #ffa07a;">"~A=\"~A\""</span> key val)))
                                       (cadr subtree)))))
             (subtree-to-html (subtree <span style="color: #98fb98;">&amp;optional</span> (step 0))
               (<span style="color: #00ffff;">cond</span> ((stringp subtree) (format nil <span style="color: #ffa07a;">"~A~A~%"</span> (indent) subtree))
                     ((numberp subtree) (format nil <span style="color: #ffa07a;">"~A~A~%"</span> (indent) subtree))
                     ((listp   subtree)
                      (<span style="color: #00ffff;">let</span> ((tag (car subtree)))
                        (<span style="color: #00ffff;">cond</span> ((or (equal tag <span style="color: #ffa07a;">"img"</span>)
                                   (equal tag <span style="color: #ffa07a;">"link"</span>)
                                   (equal tag <span style="color: #ffa07a;">"meta"</span>))  <span style="color: #ffc0cb; font-weight: bold;">(singled subtree))</span>
                              (t (paired subtree)))))
                     (t (format nil <span style="color: #ffa07a;">"[:err:~A]"</span> subtree)))))
      (reduce #'(<span style="color: #00ffff;">lambda</span> (a b) (concatenate 'string a b))
              (mapcar #'(<span style="color: #00ffff;">lambda</span> (x) (subtree-to-html x step))
                      tree)))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-unnumbered-30" class="outline-2">
<h2 id="unnumbered-30">Преобразование страниц</h2>
<div class="outline-text-2" id="text-unnumbered-30">
<p>
Здесь механизм, который разбирает файлы, строит из них дерево s-выражений и
осуществляет его трансформацию.
</p>

<p>
Я обнаружил определенную проблему с ним, связанную с выводом листингов внутри тега
<code>&lt;pre&gt;&lt;/pre&gt;</code> - из-за отступов, которые формирует <code>tree-to-html</code> сьезжает
форматирование исходного кода. Поэтому, до написания своего парсера, учитывающего эти
аспекты, я закомментировал такую обработку, тем более, что в данный момент
трансформация заключается просто в присоединении шаблона, содержащего трекеры
статистики.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="enobler">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:mycoin</span>)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">enobler</span> (pathname <span style="color: #98fb98;">&amp;optional</span> dbg)
  (<span style="color: #00ffff;">let*</span> ((file-contents (alexandria:read-file-into-string pathname))
         (onestring (cl-ppcre:regex-replace-all <span style="color: #ffa07a;">"(\\n|\\s*$)"</span> file-contents (<span style="color: #00ffff;">if</span> dbg <span style="color: #ffa07a;">""</span> <span style="color: #ffa07a;">" "</span>)))
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(tree (html-to-tree onestring))</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(inject-css '("link" (("href" "/css/style.css") ("rel" "stylesheet") ("type" "text/css"))))</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(replace-css #'(lambda (in)</span>
         <span style="color: #ff7f24;">;;                  </span><span style="color: #ff7f24;">(optima:match in</span>
         <span style="color: #ff7f24;">;;                    </span><span style="color: #ff7f24;">(`("style" (("type" "text/css")) ,_) inject-css))))</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(remove-css (maptree-transform replace-css tree))</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(inject-js '("script" (("src" "scripts.js"))))</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(replace-js  #'(lambda (in)</span>
         <span style="color: #ff7f24;">;;                  </span><span style="color: #ff7f24;">(optima:match in</span>
         <span style="color: #ff7f24;">;;                    </span><span style="color: #ff7f24;">(`("script" (("type" "text/javascript")) ,_) inject-js))))</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(remove-js (maptree-transform replace-js remove-css))</span>
         <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(result tree)</span>
    <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(if dbg</span>
    <span style="color: #ff7f24;">;;     </span><span style="color: #ff7f24;">result</span>
    <span style="color: #ff7f24;">;;     </span><span style="color: #ff7f24;">(format nil "~A~A~%~A~%~A"</span>
    <span style="color: #ff7f24;">;;             </span><span style="color: #ff7f24;">;; "&lt;!DOCTYPE html&gt;\n"</span>
    <span style="color: #ff7f24;">;;             </span><span style="color: #ff7f24;">""</span>
    <span style="color: #ff7f24;">;;             </span><span style="color: #ff7f24;">;; (tree-to-html result)</span>
    <span style="color: #ff7f24;">;;             </span><span style="color: #ff7f24;">file-contents</span>
    <span style="color: #ff7f24;">;;             </span><span style="color: #ff7f24;">(tpl:stat)</span>
    <span style="color: #ff7f24;">;;             </span><span style="color: #ff7f24;">"  &lt;div id=\"linker\"&gt;&lt;a href=\"/\"&gt;Home&lt;/a&gt;&lt;/div&gt;"</span>
              )
    onestring
    ))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-31" class="outline-2">
<h2 id="unnumbered-31">Рендеринг</h2>
<div class="outline-text-2" id="text-unnumbered-31">
<p>
RESTAS использует концепцию <code>рендера</code> чтобы отделить отображение страницы от ее
маршрута. Нам надо определить рендер для вывода orgmode-страниц:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="render"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

(<span style="color: #00ffff;">defclass</span> <span style="color: #98fb98;">orgmode-handler</span> () ())

(<span style="color: #00ffff;">defmethod</span> <span style="color: #87cefa;">restas:render-object</span> ((renderer orgmode-handler) (file pathname))
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">NOTE: &#1054;&#1089;&#1090;&#1072;&#1074;&#1083;&#1077;&#1085;&#1086; &#1082;&#1072;&#1082; &#1087;&#1088;&#1080;&#1084;&#1077;&#1088; &#1074;&#1099;&#1079;&#1086;&#1074;&#1072; CGI</span>
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(cond</span>
  <span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">((and (string= (pathname-type file) "cgi"))</span>
  <span style="color: #ff7f24;">;;    </span><span style="color: #ff7f24;">(hunchentoot-cgi::handle-cgi-script file))</span>
  <span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(t</span>
  <span style="color: #ff7f24;">;;    </span><span style="color: #ff7f24;">(call-next-method)))</span>
  (enobler file))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-32" class="outline-2">
<h2 id="unnumbered-32">Маршрутизация</h2>
<div class="outline-text-2" id="text-unnumbered-32">
<p>
Маршрутизация осуществляется средствами библиотеки <code>RESTAS</code>, документация по которой
доступна <a href="http://github.com/archimag/restas/">здесь</a>.
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="routes"><span style="color: #ff7f24;">;;;; </span><span style="color: #ff7f24;">&lt;&lt;copyright&gt;&gt;</span>
(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

&lt;&lt;route_static_files&gt;&gt;
&lt;&lt;route_404&gt;&gt;
&lt;&lt;route_robots&gt;&gt;
&lt;&lt;route_orgmode&gt;&gt;
&lt;&lt;route_pages&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-unnumbered-33" class="outline-3">
<h3 id="unnumbered-33">Статические файлы</h3>
<div class="outline-text-3" id="text-unnumbered-33">
<p>
Для всех файлов, которые должны отдаваться "как есть", таких как картинки, скрипты и
стили предусмотрены соответствующие маршруты:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_static_files">(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(restas:mount-module -css- (#:restas.directory-publisher)</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(:url "/css/")</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(restas.directory-publisher:*directory*</span>
<span style="color: #ff7f24;">;;    </span><span style="color: #ff7f24;">(merge-pathnames (make-pathname :directory '(:relative "css"))</span>
<span style="color: #ff7f24;">;;                     </span><span style="color: #ff7f24;">*base-dir*)))</span>

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(restas:mount-module -img- (#:restas.directory-publisher)</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(:url "/img/")</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(restas.directory-publisher:*directory*</span>
<span style="color: #ff7f24;">;;    </span><span style="color: #ff7f24;">(merge-pathnames (make-pathname :directory '(:relative "img"))</span>
<span style="color: #ff7f24;">;;                     </span><span style="color: #ff7f24;">*base-dir*)))</span>

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(restas:mount-module -js- (#:restas.directory-publisher)</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(:url "/js/")</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(restas.directory-publisher:*directory*</span>
<span style="color: #ff7f24;">;;    </span><span style="color: #ff7f24;">(merge-pathnames (make-pathname :directory '(:relative "js"))</span>
<span style="color: #ff7f24;">;;                     </span><span style="color: #ff7f24;">*base-dir*)))</span>

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(restas:mount-module -resources- (#:restas.directory-publisher)</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(:url "/resources")</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(restas.directory-publisher:*directory*</span>
<span style="color: #ff7f24;">;;    </span><span style="color: #ff7f24;">(merge-pathnames (make-pathname :directory '(:relative "resources"))</span>
<span style="color: #ff7f24;">;;                     </span><span style="color: #ff7f24;">*base-dir*)))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-34" class="outline-3">
<h3 id="unnumbered-34">404 страница</h3>
<div class="outline-text-3" id="text-unnumbered-34">
<p>
Для ненайденных страниц мы определяем страницу с 404 ошибкой.
</p>

<p>
[TODO:gmm] - Сделать ее более функциональной и красивой
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_404">(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

(<span style="color: #00ffff;">defparameter</span> <span style="color: #eedd82;">*log-404*</span> nil)

(<span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">page-404</span> (<span style="color: #98fb98;">&amp;optional</span> (title <span style="color: #ffa07a;">"404 Not Found"</span>) (content <span style="color: #ffa07a;">"&#1057;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1072; &#1085;&#1077; &#1085;&#1072;&#1081;&#1076;&#1077;&#1085;&#1072;"</span>))
  <span style="color: #ffa07a;">"404 Not Found"</span>)

(restas:define-route not-found-route (<span style="color: #ffa07a;">"*any"</span>)
  (push any *log-404*)
  (restas:abort-route-handler
   (page-404)
   <span style="color: #b0c4de;">:return-code</span> hunchentoot:+http-not-found+
   <span style="color: #b0c4de;">:content-type</span> <span style="color: #ffa07a;">"text/html"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-35" class="outline-3">
<h3 id="unnumbered-35">Страница robots.txt</h3>
<div class="outline-text-3" id="text-unnumbered-35">
<p>
Для указаний поисковым краулерам делаем страницу <code>robots.txt</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_robots">(<span style="color: #00ffff;">in-package</span> #<span style="color: #b0c4de;">:mycoin</span>)

(restas:define-route robots (<span style="color: #ffa07a;">"/robots.txt"</span>)
  (format nil <span style="color: #ffa07a;">"User-agent: *~%Disallow: "</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-36" class="outline-3">
<h3 id="unnumbered-36">Страницы orgmode</h3>
<div class="outline-text-3" id="text-unnumbered-36">
<p>
Для отображения страниц, экспортированных из orgmode, используется <code>render-method</code>,
который преобразует код страницы перед выдачей пользователю:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_orgmode">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:mycoin</span>)

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(restas:mount-module -base- (#:restas.directory-publisher)</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(:url "/")</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(:render-method (make-instance 'orgmode-handler))</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(restas.directory-publisher:*directory*</span>
<span style="color: #ff7f24;">;;    </span><span style="color: #ff7f24;">(merge-pathnames (make-pathname :directory '(:relative "www"))</span>
<span style="color: #ff7f24;">;;                     </span><span style="color: #ff7f24;">*base-dir*)))</span>

(restas:mount-module -doc- (#<span style="color: #b0c4de;">:restas.directory-publisher</span>)
  (<span style="color: #b0c4de;">:url</span> <span style="color: #ffa07a;">"/doc"</span>)
  (<span style="color: #b0c4de;">:render-method</span> (make-instance 'orgmode-handler))
  (restas.directory-publisher:*directory*
   (merge-pathnames (make-pathname <span style="color: #b0c4de;">:directory</span> '(<span style="color: #b0c4de;">:relative</span> <span style="color: #ffa07a;">"www/doc"</span>))
                    *base-dir*)))
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-37" class="outline-3">
<h3 id="unnumbered-37">Маршруты страниц</h3>
<div class="outline-text-3" id="text-unnumbered-37">
<p>
Для всех остальных страниц маршруты определены напрямую, так, чтобы ведомый слэш не
приводил к появляению 404-ой ошибки:
</p>

<div class="org-src-container">

<pre class="src src-lisp" id="route_pages">(<span style="color: #00ffff;">in-package</span> <span style="color: #b0c4de;">:mycoin</span>)

(restas:define-route index (<span style="color: #ffa07a;">"/"</span>)
  <span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(enobler (translate-logical-pathname "org:publish;index"))</span>
  <span style="color: #ffa07a;">"mainpage"</span>
  )

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(restas:define-route index.html ("/index.html")</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(enobler (translate-logical-pathname "org:publish;index")))</span>

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(defmacro def/route (name param &amp;body body)</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">`(progn</span>
<span style="color: #ff7f24;">;;      </span><span style="color: #ff7f24;">(restas:define-route ,name ,param</span>
<span style="color: #ff7f24;">;;        </span><span style="color: #ff7f24;">,@body)</span>
<span style="color: #ff7f24;">;;      </span><span style="color: #ff7f24;">(restas:define-route</span>
<span style="color: #ff7f24;">;;          </span><span style="color: #ff7f24;">,(intern (concatenate 'string (symbol-name name) "/"))</span>
<span style="color: #ff7f24;">;;          </span><span style="color: #ff7f24;">,(cons (concatenate 'string (car param) "/") (cdr param))</span>
<span style="color: #ff7f24;">;;        </span><span style="color: #ff7f24;">,@body)</span>
<span style="color: #ff7f24;">;;      </span><span style="color: #ff7f24;">(restas:define-route</span>
<span style="color: #ff7f24;">;;          </span><span style="color: #ff7f24;">,(intern (concatenate 'string (symbol-name name) ".html"))</span>
<span style="color: #ff7f24;">;;          </span><span style="color: #ff7f24;">,(cons (concatenate 'string (car param) ".html") (cdr param))</span>
<span style="color: #ff7f24;">;;        </span><span style="color: #ff7f24;">,@body)))</span>

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(def/route research ("research")</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(enobler (translate-logical-pathname "org:publish;research")))</span>

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(def/route slides ("slides")</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(enobler (translate-logical-pathname "org:publish;slides")))</span>

<span style="color: #ff7f24;">;; </span><span style="color: #ff7f24;">(def/route projects ("projects")</span>
<span style="color: #ff7f24;">;;   </span><span style="color: #ff7f24;">(enobler (translate-logical-pathname "org:publish;projects")))</span>

&lt;&lt;route_who_are_you&gt;&gt;
</pre>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
