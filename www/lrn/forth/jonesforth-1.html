<!DOCTYPE html>
<html>
<head>
<title></title>
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="rigidus">
<link href="/css/style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="content">
<h1 class="title"></h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#unnumbered-1">Внутреннее устройство Forth-машины</a>
<ul>
<li><a href="#unnumbered-2">Словарь</a></li>
<li><a href="#unnumbered-3">Прямой шитый код</a></li>
<li><a href="#unnumbered-4">Коссвенный шитый код</a></li>
<li><a href="#unnumbered-5">Интерпретатор и стек возвратов</a></li>
<li><a href="#unnumbered-6">Начинаем работу</a></li>
<li><a href="#unnumbered-7">Встроенные слова</a></li>
<li><a href="#unnumbered-8">Cmdline слова</a></li>
<li><a href="#unnumbered-9">Env слова</a></li>
<li><a href="#unnumbered-10">EXIT - Возвращение из форт-слов</a></li>
<li><a href="#unnumbered-11">Литералы</a></li>
<li><a href="#unnumbered-12">Память</a></li>
<li><a href="#unnumbered-13">Встроенные переменные</a></li>
<li><a href="#unnumbered-14">Встроенные константы</a></li>
<li><a href="#unnumbered-15">Стек возвратов</a></li>
<li><a href="#unnumbered-16">Стек данных</a></li>
<li><a href="#unnumbered-17">Ввод и вывод: KEY EMIT WORD NUMBER</a></li>
<li><a href="#unnumbered-18">Просмотр словаря</a></li>
<li><a href="#unnumbered-19">Компиляция</a></li>
<li><a href="#unnumbered-20">Расширение компилятора</a>
<ul>
<li><a href="#unnumbered-21">IMMEDIATE</a></li>
<li><a href="#unnumbered-22">HIDDEN</a></li>
<li><a href="#unnumbered-23">TICK</a></li>
</ul>
</li>
<li><a href="#unnumbered-24">Ветвление</a></li>
<li><a href="#unnumbered-25">Строковые литералы - LITSTRING</a></li>
<li><a href="#unnumbered-26">Печать строки - TELL</a></li>
<li><a href="#unnumbered-27">QUIT</a></li>
<li><a href="#unnumbered-28">INTERPRET</a></li>
<li><a href="#unnumbered-29">CHAR</a></li>
<li><a href="#unnumbered-30">EXECUTE</a></li>
<li><a href="#unnumbered-31">DODOES</a></li>
<li><a href="#unnumbered-32">Системные вызовы</a></li>
<li><a href="#unnumbered-33">Сегмент стека и буффер ввода</a></li>
</ul>
</li>
<li><a href="#unnumbered-34">Tangling</a></li>
<li><a href="#unnumbered-35">Trobleshooting</a></li>
</ul>
</div>
</div>

<div id="outline-container-unnumbered-1" class="outline-2">
<h2 id="unnumbered-1">Внутреннее устройство Forth-машины</h2>
<div class="outline-text-2" id="text-unnumbered-1">
</div><div id="outline-container-unnumbered-2" class="outline-3">
<h3 id="unnumbered-2">Словарь</h3>
<div class="outline-text-3" id="text-unnumbered-2">
<p>
В Forth, как вы уже знаете, функции называются "словами", и, так же, как и в других
языках программирования, у них есть <code>имя</code> и <code>определение</code>. Вот два слова Forth:
</p>

<div class="org-src-container">

<pre class="src src-forth">: DOUBLE DUP + ;              <span style="color: #ff7f24;">\ &#1080;&#1084;&#1103;: "DOUBLE"     &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1077;: "DUP +"
</span><span style="color: #00ffff;">: </span><span style="color: #87cefa;">QUADRUPLE </span>DOUBLE DOUBLE ;   <span style="color: #ff7f24;">\ &#1080;&#1084;&#1103;: "QUADRUPLE"  &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1077;: "DOUBLE DOUBLE"
</span>
</pre>
</div>

<p>
Слова, как встроенные, так и те, которые программист определяет позже, хранятся в
словаре, который является связным списком записей словаря.
</p>


<div class="figure">
<p><img src="../../../img/forth-dict-list.png" alt="forth-dict-list.png">
</p>
</div>

<p>
Мы дойдем до определения слова позже. Сейчас просто посмотрите на его заголовок
(dictionary entry / header). Первые 4 байта - это <code>LINK</code>-указатель. Он указывает на
предыдущее слово в словаре, и для первого слова в словаре является указателем
<code>NULL</code>. Затем идет байт <code>LENGTH/FLAGS</code>. Длина слова может составлять до 31 символа
(используется 5 бит), а три верхних бита используются для различных флагов, про которые
я расскажу позже. За этим следует само имя, и в этой реализации имя всегда кратно 4
байтам, и первоначально заполнено нулевыми байтами. Кратность нужна просто для того,
чтобы определение начиналось с 32-битной границы - такого рода выравнивание важно для
быстродействия.
</p>

<p>
Переменная Forth, называемая <code>LATEST</code>, содержит указатель на последнее заданное слово,
другими словами, <code>голову</code> этого связанного списка.
</p>

<p>
<code>DOUBLE</code> и <code>QUADRUPLE</code> могут выглядеть так::
</p>


<div class="figure">
<p><img src="../../../img/forth-dict-2words.png" alt="forth-dict-2words.png">
</p>
</div>

<p>
Вы должны увидеть из этого, как можно реализовать поиск слова в словаре (просто пройти
по записям, начинающимся с той, на которую указывает LATEST, и сопоставляя имена, пока
вы не найдете совпадение или не наткнетесь на указатель NULL в конце словаря).
</p>

<p>
И как добавить слово в словарь (создать новое определение, установить его LINK в LATEST
и установить LATEST, чтобы он указывал на новое слово). Мы увидим именно эти функции,
реализованные на ассемблере позже.
</p>

<p>
Одним из интересных последствий использования связанного списка является то, что вы
можете переопределять слова, и более новое определение слова переопределяет более
старое. Это важная концепция в Forth, потому что это означает, что любое слово (даже
"встроенные" или "стандартные" слова) могут быть переопределены новым определением,
либо для его улучшения, либо для его ускорения или даже для его отключения. Однако
из-за того, как компилируются слова Forth, слова, определенные с использованием старого
определения слова, продолжают использовать старое определение. Только новые слова,
определенные после нового определения, используют новое определение.
</p>
</div>
</div>

<div id="outline-container-unnumbered-3" class="outline-3">
<h3 id="unnumbered-3">Прямой шитый код</h3>
<div class="outline-text-3" id="text-unnumbered-3">
<p>
Теперь мы перейдем к действительно важному, для понимания Forth, аспекту. Если вы не
поймете этот раздел, то вы не поймете как работает Forth, и это будет неудачей с моей
стороны.
</p>

<p>
Давайте поговорим сначала о том, что означает "шитый код". Представьте себе
своеобразную версию Cи, где вам разрешено вызывать только функции без аргументов. (Не
беспокойтесь, о том, что такой язык будет совершенно бесполезен) Итак, в нашем
своеобразном Cи код будет выглядеть так:
</p>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #87cefa;">f</span> () {
    a ();
    b ();
    c ();
}
</pre>
</div>

<p>
&#x2026;и так далее. Как бы функция, скажем, <code>f</code> выше, была скомпилирована стандартным
компилятором Cи в машинный код? Например для i386 так:
</p>

<div class="org-src-container">

<pre class="src src-asm"><span style="color: #87cefa;">f</span>:
    <span style="color: #00ffff;">CALL</span> a          #  E8 08 00 00 00
    <span style="color: #00ffff;">CALL</span> b          #  E8 1C 00 00 00
    <span style="color: #00ffff;">CALL</span> c          #  E8 2C 00 00 00
    <span style="color: #ff7f24;">;;  </span><span style="color: #ff7f24;">&#1089;&#1077;&#1081;&#1095;&#1072;&#1089; &#1084;&#1099; &#1087;&#1086;&#1082;&#1072; &#1080;&#1075;&#1085;&#1086;&#1088;&#1080;&#1088;&#1091;&#1077;&#1084; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090; &#1080;&#1079; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080;</span>
</pre>
</div>

<p>
<code>E8</code> - это машинный код x86 для «CALL» функции. В первые 20 лет компьютерная память
была ужасно дорогой, и мы могли бы беспокоиться о том, что расходуем впустую
память повторенными байтами «E8». Мы можем сэкономить 20% в размере кода (и,
следовательно, дорогостоящей памяти), сжав это:
</p>

<div class="org-src-container">

<pre class="src src-asm"><span style="color: #87cefa;">08</span> <span style="color: #00ffff;">00</span> 00 00   #  &#1055;&#1088;&#1086;&#1089;&#1090;&#1086; &#1072;&#1076;&#1088;&#1077;&#1089;&#1072; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1081;, &#1073;&#1077;&#1079; CALL
<span style="color: #87cefa;">1C</span> <span style="color: #00ffff;">00</span> 00 00
<span style="color: #87cefa;">2C</span> <span style="color: #00ffff;">00</span> 00 00
</pre>
</div>

<p>
На 16-битной машине, подобной той, на которой Forth был запущен в первый раз, экономия
еще больше - 33%.
</p>

<p>
Историческое примечание: Если модель исполнения, используемая Forth, кажется странной,
то она была полностью мотивирована необходимостью экономить память на ранних
компьютерах. Это сжатие не так важно сейчас, когда наши машины имеют больше памяти в
своих кэшах L1, чем в ранних компьютерах, но модель исполнения по-прежнему обладает
некоторыми полезными свойствами. Кроме того, на современных процессорах, Forth-система
способна целиком поместиться в кэше процессора, что делает ее прямо таки чудовищно
быстрой.
</p>

<p>
Конечно, этот сжатый код, из которого убраны <code>E8</code>, больше не будет работать
непосредственно на процессоре. Вместо этого нам нужно написать интерпретатор, который
берет каждый адрес и вызывает его.
</p>

<p>
На машине i386 получается, что этот интерпретатор можно легко написать в двух
ассемблерных инструкциях, которые превращаются всего в 3 байта машинного кода. Давайте
сохраним в регистре <code>%esi</code> указатель на следующее слово для выполнения:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-01.png" alt="forth-interpret-01.png">
</p>
</div>

<p>
В i386 есть инструкция <code>LODSL</code> (или в терминологии руководств Intel, <code>LODSW</code>). Она
делает две вещи:
</p>
<ul class="org-ul">
<li>читает из памяти, на которую указывает <code>%esi</code> 4 байта в регистр <code>%eax</code>
</li>
<li>увеличивает значение в регистре <code>%esi</code> на 4
</li>
</ul>

<p>
Итак, после выполнения инструкции <code>LODSL</code> ситуация выглядит так:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-02.png" alt="forth-interpret-02.png">
</p>
</div>

<p>
Сейчас нам надо сделать <code>jmp</code> на адрес, содержащийся в <code>%eax</code>. Это снова всего одна
x86-инструкция, которая записывается как <code>JMP *(%eax)</code>. И после того как мы сделаем JMP
ситуация выглядит так:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-03.png" alt="forth-interpret-03.png">
</p>
</div>

<p>
Для выполнения этой работы каждая подпрограмма сопровождается двумя инструкциями:
<code>LODSL; JMP *(%eax)</code>, которые буквально переходят к следующей подпрограмме.
</p>

<p>
И это подводит нас к нашей первой части реального кода! Ну, то есть, это макрос.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="macro_next"><span style="color: #00ffff;">.macro</span> NEXT
    <span style="color: #00ffff;">lodsl</span>
    <span style="color: #00ffff;">jmp</span> *(<span style="color: #eedd82;">%eax</span>)
<span style="color: #00ffff;">.endm</span>
</pre>
</div>

<p>
Этот макрос называется <code>NEXT</code>. Он раскрывается в эти две инструкции.
</p>

<p>
Каждый примитив Forth, который мы пишем, должен быть завершен <code>NEXT</code>. Думайте об
этом как о <code>return</code>.
</p>

<p>
Все, что описано выше, называется <code>прямым шитым кодом</code>.
</p>

<p>
Подводя итог: мы сжимаем наши вызовы функций до списка адресов и используем макрос,
чтобы переходить к следующей функции в списке. Мы также используем один регистр
(<code>%esi</code>), как своего рода указатель инструкции (Instruction Pointer), указывающий на
следующую функцию в списке.
</p>

<p>
Я просто дам вам намек на то, что должно произойти, сказав, что определение Forth,
такое как:
</p>

<div class="org-src-container">

<pre class="src src-forth">: QUADRUPLE DOUBLE DOUBLE ;   <span style="color: #ff7f24;">\ &#1080;&#1084;&#1103;: "QUADRUPLE"  &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1077;: "DOUBLE DOUBLE"
</span>
</pre>
</div>

<p>
на самом деле компилирует (не совсем точно, но мы сразу увидим, почему) список адресов
функций для DOUBLE, DOUBLE и специальную функцию EXIT для завершения.
</p>

<p>
На данный момент, остроглазые эксперты ассемблера могут воскликнуть: "вы сделали
ошибку!".
</p>

<p>
Ага, я лгал вам о <code>JMP *(%eax)</code>.
</p>
</div>
</div>

<div id="outline-container-unnumbered-4" class="outline-3">
<h3 id="unnumbered-4">Коссвенный шитый код</h3>
<div class="outline-text-3" id="text-unnumbered-4">
<p>
Оказывается, что <code>прямой шитый код</code> интересен, только если вы хотите просто выполнить
список функций, написанных на ассемблере. Поэтому QUADRUPLE будет работать только в том
случае, если DOUBLE является функцией языка ассемблера. В <code>прямом шитом коде</code> QUADRUPLE
будет выглядеть так:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-04.png" alt="forth-interpret-04.png">
</p>
</div>

<p>
Мы можем добавить дополнительный уровень косвенности, позволяющей нам запускать как
слова, написанные на ассемблере (примитивы, написанные для скорости), так и слова,
написанные на Forth-е, как списки адресов.
</p>

<p>
Дополнительная косвенность является причиной скобок в <code>JMP *(%eax)</code>.
</p>

<p>
Давайте посмотрим, как QUADRUPLE и DOUBLE действительно выглядят в Forth:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-05.png" alt="forth-interpret-05.png">
</p>
</div>

<p>
Это та часть, где вам может понадобиться дополнительная чашка кофе. Что изменилось, так
это то, что я добавил дополнительный указатель <b>на начало определения</b>. В Forth это
называют <code>codeword</code> - кодовое слово. <code>codeword</code> является указателем на интерпретатор
для запуска функции. Для примитивов, написанных на языке ассемблера, <code>codeword</code> просто
указывает на сам код - его не нужно интерпретировать, он просто запускается.
</p>

<p>
В словах, написанных на Forth (например, QUADRUPLE и DOUBLE), <code>codeword</code> указывает на
функцию-интерпретатор.
</p>

<p>
Я вскоре покажу вам функцию-интерпретатор, но давайте вспомним наш косвенный <code>JMP
*(%eax)</code> с "дополнительными" скобками. Возьмем случай, когда мы выполняем DOUBLE, как
показано, и вызывается DUP. Обратите внимание, что <code>%esi</code> указывает на адрес <code>+</code>
</p>

<p>
Ассемблерный код для DUP в конце делает <code>NEXT</code>. Это:
</p>
<ul class="org-ul">
<li>читает адрес <code>+</code> в <code>%eax</code> - теперь <code>%eax</code> указывает на <code>codeword</code> для кода <code>+</code>
</li>
<li>увеличивает <code>%esi</code> на 4
</li>
<li>выполняет <code>jmp</code> на содержимое того адреса, который лежит в <code>%eax</code> → т.е. <code>jmp</code> по
адресу, лежащему в <code>codeword</code> слова <code>+</code>, → т.е. <code>jmp</code> на ассемблерный код, реализующий
<code>+</code>.
</li>
</ul>


<div class="figure">
<p><img src="../../../img/forth-interpret-06.png" alt="forth-interpret-06.png">
</p>
</div>

<p>
Поэтому я надеюсь, что я убедил вас, что <code>NEXT</code> делает примерно то, что вы
ожидаете. Это <code>коссвенный шитый код</code>.
</p>

<p>
Обратите особенное внимание, что на рисунках "адрес DOUBLE" следует читать как "адрес
поля codeword слова DOUBLE". Такое длинное описание просто не вмещается в рисунок,
поэтому мне пришлось сократить. Однако я сейчас приведу "увеличенный фрагмент", чтобы
избежать возможной путаницы:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-06a.png" alt="forth-interpret-06a.png">
</p>
</div>


<p>
Я не сказал о четырех вещах. Интересно, сможете ли вы догадаться о них, не читая
дальше?
</p>

<p>
Вот список этих вещей:
</p>
<ul class="org-ul">
<li>что делает <code>EXIT</code>?
</li>
<li>как происходит вызов функции, т.е. как <code>%esi</code> начинает указывать на часть QUADRUPLE,
а затем указывать на часть DOUBLE?
</li>
<li>Что входит в <code>codeword</code> для слов, написанных на Forth?
</li>
<li>Как компилировать функцию, которая делает что-то еще, кроме вызова других функций,
например функцию, которая содержит число, такую как <code>: DOUBLE 2 * ;</code>?
</li>
</ul>
</div>
</div>

<div id="outline-container-unnumbered-5" class="outline-3">
<h3 id="unnumbered-5">Интерпретатор и стек возвратов</h3>
<div class="outline-text-3" id="text-unnumbered-5">
<p>
Не останавливаясь на этом, давайте поговорим о третьей и второй проблемах,
интерпретаторе и стеке возврата.
</p>

<p>
Слова, которые определены в Forth, нуждаются в <code>codeword</code>, указателе, указывающем на
небольшое количество кода, который протягивает им "руку помощи". Им не нужно много, но
им нужно то, что известно как <code>интерпретатор</code>, хотя на самом деле он не является
интерпретатором в том же смысле, как, например, медленный интерпретатор байт-кода
Java. Этот интерпретатор просто устанавливает несколько машинных регистров, чтобы затем
слово могло выполняться на полной скорости с использованием модели коссвенного шитого
кода, показанной выше.
</p>

<p>
Одна из вещей, которые должны произойти, когда QUADRUPLE вызывает DOUBLE, заключается в
том, что мы сохраняем старый указатель инструкций <code>%esi</code> и создаем новый, указывающий
на первое слово в DOUBLE. Поскольку нам нужно будет восстановить старый <code>%esi</code> в конце
слова DOUBLE (в конце концов, это как вызов функции), нам понадобится стек для хранения
этих "адресов возврата" (старых значений <code>%esi</code>).
</p>

<p>
Как вы, наверно видели в документации, Forth имеет два стека: обычный <code>стек параметров</code>
и немного загадочный <code>стек возвратов</code>. Но наш <code>стек возвратов</code> - это просто тот стек, о
котором я говорил в предыдущем абзаце, используемый для сохранения <code>%esi</code> когда из
одного слова Forth вызывается другое слово Forth.
</p>

<p>
В нашем Forth в качестве <code>стека параметров</code> мы будем использовать аппаратный стек с
регистром-указателем <code>%esp</code>. А для <code>стека возвратов</code> мы будем использовать другой
регистр-указатель стека i386 (<code>%ebp</code>, называемый "указателем фрейма").
</p>

<p>
У меня есть два макроса, которые просто оборачивают детали использования <code>%ebp</code> для
<code>стека возвратов</code>. Вы используете их так: <code>PUSHRSP %eax</code> (<code>push</code> %eax в стек возвратов)
или <code>POPRSP %ebx</code> (<code>pop</code> значение, на которое указывает вершина стека возвратов %ebp в
регистр <code>%ebx</code>).
</p>

<div class="org-src-container">

<pre class="src src-asm" id="macro_pushrsp"><span style="color: #00ffff;">.macro</span> PUSHRSP reg
    <span style="color: #00ffff;">lea</span>     -4(<span style="color: #eedd82;">%ebp</span>), <span style="color: #eedd82;">%ebp</span>  # &#1076;&#1077;&#1082;&#1088;&#1077;&#1084;&#1077;&#1085;&#1090; <span style="color: #eedd82;">%ebp</span> &#1085;&#1072; 4
    <span style="color: #00ffff;">movl</span>    \reg, (<span style="color: #eedd82;">%ebp</span>)    # push reg &#1074; &#1089;&#1090;&#1077;&#1082; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074;
<span style="color: #00ffff;">.endm</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-asm" id="macro_poprsp"><span style="color: #00ffff;">.macro</span> POPRSP reg
    <span style="color: #00ffff;">mov</span>     (<span style="color: #eedd82;">%ebp</span>), \reg    # pop &#1074;&#1077;&#1088;&#1096;&#1080;&#1085;&#1091; &#1089;&#1090;&#1077;&#1082;&#1072; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074; &#1074; reg
    <span style="color: #00ffff;">lea</span>     4(<span style="color: #eedd82;">%ebp</span>), <span style="color: #eedd82;">%ebp</span>   # &#1080;&#1085;&#1082;&#1088;&#1077;&#1084;&#1077;&#1085;&#1090; <span style="color: #eedd82;">%ebp</span> &#1085;&#1072; 4
<span style="color: #00ffff;">.endm</span>
</pre>
</div>

<p>
Область, идущая сразу за <code>codeword</code> в слове называется <code>param-field</code>.  Если слово
является примитивом (т.е. его исполняемый код написан на ассемблере), то за <code>codeword</code>,
прямо в <code>param-field</code> будет идти ассемблерный код слова, и <code>codeword</code> будет указывать
на него.
</p>

<p>
Если же слово не примитив, т.е. соcтоит из вызовов других слов, то <code>param-field</code> будет
содержать указатели на <code>codeword</code>-ы этих слов. У такого слова <code>codeword</code> будет
указателем на DOCOL, о котором сейчас пойдет речь.
</p>

<p>
В Forth функция-интерпретатор часто называется DOCOL (я думаю, что это означает "DO
COLON", потому что все определения Forth начинаются с двоеточия, как например в
выражении <code>: DOUBLE DUP ;</code>
</p>

<p>
Интерпретатору (на самом деле это не "интерпретация") нужно push-нуть старый <code>%esi</code> в
стек возвратов и установить <code>%esi</code> так, чтобы он указывал на первое слово в
определении. Помните, как мы перешли к функции с помощью <code>JMP *(%eax)</code>? Вследствие
этого удобно, что <code>%eax</code> содержит адрес этого <code>codeword</code>, поэтому просто добавляя к
нему 4, мы получаем адрес первого слова идущего за <code>codeword</code>.
</p>

<p>
Наконец, после установки <code>%esi</code>, он просто делает NEXT, который вызывает запуск первого
слова. Удобно, что в архитектуре i386 можно одной командой увеличить <code>%EAX</code> на 4 и
послать результат в <code>%ESI</code>. Таким образом, определение DOCOL будет выглядеть так:
</p>

<div class="org-src-container">

<pre class="src src-asm" id="asm_docol">    <span style="color: #00ffff;">.text</span>
    <span style="color: #00ffff;">.align</span> 4
<span style="color: #87cefa;">DOCOL</span>:
    <span style="color: #00ffff;">PUSHRSP</span> <span style="color: #eedd82;">%esi</span>            # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1090;&#1100; <span style="color: #eedd82;">%esi</span> &#1074; &#1089;&#1090;&#1077;&#1082;&#1077; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074;
    <span style="color: #00ffff;">leal</span>    4(<span style="color: #eedd82;">%eax</span>), <span style="color: #eedd82;">%esi</span>   # <span style="color: #eedd82;">%esi</span> &#1090;&#1077;&#1087;&#1077;&#1088;&#1100; &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; param-field
    <span style="color: #00ffff;">NEXT</span>                    # &#1044;&#1077;&#1083;&#1072;&#1077;&#1084; NEXT
</pre>
</div>

<p>
Чтобы это было совершенно ясно, посмотрим, как работает DOCOL при прыжке с QUADRUPLE в
DOUBLE:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-07.png" alt="forth-interpret-07.png">
</p>
</div>

<p>
Во-первых, вызов DOUBLE вызывает DOCOL (<code>codeword</code> DOUBLE). DOCOL делает следующее:
он push-ит старый <code>%esi</code> на стек возвратов. <code>%eax</code> указывает на <code>codeword</code> DOUBLE,
поэтому мы просто добавляем к нему 4, чтобы получить наш новый <code>%esi</code>:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-08.png" alt="forth-interpret-08.png">
</p>
</div>

<p>
Затем он делает NEXT и из-за магии шитого кода (копирование текущего адреса из %esi в
%eax, вызов его из %eax и увеличения %esi) вызывается DUP.
</p>

<p>
Здесь есть одна второстепенная вещь. Поскольку DOCOL - это первый кусок ассемблерного
кода, который должен быть определен в этом файле (остальные - только макросы), и
поскольку я обычно (но не в этом случае) компилирую этот код с сегментом <code>.text</code>,
начинающимся с адреса 0, DOCOL имеет адрес 0. Поэтому, если вы дизассемблируете код и
увидите слово с <code>codeword</code> 0, вы сразу же поймете, что это слово Forth (а не
ассемблерный примитив), и поэтому оно использует DOCOL в качестве интерпретатора.
</p>

<p>
К сожалению, это не сработает в современных дистрибутивах Linux, где блокируеются
попытки доступа к младшим адресам памяти. За это отвечает параметр
<code>CONFIG_DEFAULT_MMAP_MIN_ADDR</code> и на моей системе вызов <code>cat /proc/sys/vm/mmap_min_addr</code>
возвращает 65536. Можно изменить опции линкера на "<code>-Wl,-Ttext,10000</code>" (адрес надо
задавать шестнадцатиричным значением). Но так как я компилирую в обычный исполняемый
файл ELF для Linux, статически слинкованный с библиотекой Си (которая нам понадобится
для разных практических целей) при дизассемблировании придется запомнить адрес DOCOL.
</p>
</div>
</div>

<div id="outline-container-unnumbered-6" class="outline-3">
<h3 id="unnumbered-6">Начинаем работу</h3>
<div class="outline-text-3" id="text-unnumbered-6">
<p>
Теперь давайте перейдем к гайкам и болтам. Когда мы запускаем программу, нам нужно
настроить несколько вещей, таких как стек возвратов. Но как только мы сможем, мы хотим
перейти в код Forth (хотя большая часть «раннего» кода Forth все равно должна быть
написана как примитивы на host-языке).
</p>

<p>
Это то, что делает код настройки:
</p>
<ul class="org-ul">
<li>Делает небольшую вступительную часть - сбрасывает флаг направления DF.
</li>
<li>Настраивает отдельный стек возврата (NB: Linux уже дает нам обычный стек параметров)
</li>
<li>затем сразу переходит к слову Forth, называемому QUIT. Несмотря на свое название QUIT
никуда не выходит. Он сбрасывает стек возвратов и начинает чтение и интерпретацию
команд. (Причина, по которой он называется QUIT, заключается в том, что вы можете
вызывать QUIT из вашего собственного кода Forth, чтобы «выйти» из вашей программы и
вернуться к вводу и интерпретации команд).
</li>
</ul>

<p>
Здесь мы настраиваем указатель HERE на начало области данных <code>data_buffer</code>, который я
выделил в сегменте <code>.bcc</code>. Так проще, нежели пытаться определять и расширять <code>data
segment</code> с помощью системного вызова <code>brk(2)</code>, который у меня возвращает -1.
</p>

<p>
Мы используем обычный стек процесса (на который указывает регистр %esp) в качестве
стека параметров, потому что операции с этим стеком - самые частые в Forth-программе, а
команды работы со стеком процесса быстрее и короче. Стек возвратов используется
Forth-программой реже, поэтому мы адресуемся к нему через регистр %ebp
</p>

<div class="org-src-container">

<pre class="src src-asm" id="asm_entry">    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">Assembler entry point. */</span>

    <span style="color: #00ffff;">.data</span>

    <span style="color: #00ffff;">.align</span> 4
    <span style="color: #00ffff;">.globl</span> forth_asm_argc
<span style="color: #87cefa;">forth_asm_argc</span>:
    <span style="color: #00ffff;">.int</span>  0                  # &#1050;&#1086;&#1083;&#1080;&#1095;&#1077;&#1089;&#1090;&#1074;&#1086; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;&#1086;&#1074; &#1082;&#1086;&#1084;&#1072;&#1085;&#1076;&#1085;&#1086;&#1081; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;

    <span style="color: #00ffff;">.align</span> 4
    <span style="color: #00ffff;">.globl</span> forth_asm_argv
<span style="color: #87cefa;">forth_asm_argv</span>:
    <span style="color: #00ffff;">.int</span>  0                  # &#1059;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;&#1099; &#1082;&#1086;&#1084;&#1072;&#1085;&#1076;&#1085;&#1086;&#1081; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;

    <span style="color: #00ffff;">.text</span>

    <span style="color: #00ffff;">.globl</span>  forth_asm_start
    <span style="color: #00ffff;">.type</span>   forth_asm_start, @function
<span style="color: #87cefa;">forth_asm_start</span>:
    # &#1057;&#1073;&#1088;&#1072;&#1089;&#1099;&#1074;&#1072;&#1077;&#1084; &#1092;&#1083;&#1072;&#1075; &#1085;&#1072;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1103;
    <span style="color: #00ffff;">cld</span>
    # &#1047;&#1072;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1077;&#1084; &#1074;&#1077;&#1088;&#1096;&#1080;&#1085;&#1091; &#1089;&#1090;&#1077;&#1082;&#1072; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;&#1086;&#1074; <span style="color: #eedd82;">%esp</span> &#1074; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1091;&#1102; S0
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%esp</span>, (var_S0)
    # &#1059;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; &#1089;&#1090;&#1077;&#1082; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074; <span style="color: #eedd82;">%ebp</span>
    <span style="color: #00ffff;">mov</span>     $return_stack_top, <span style="color: #eedd82;">%ebp</span>
    # &#1059;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; HERE &#1085;&#1072; &#1085;&#1072;&#1095;&#1072;&#1083;&#1086; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;.
    <span style="color: #00ffff;">mov</span>     $data_buffer, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%eax</span>, (var_HERE)
    # &#1048;&#1085;&#1080;&#1094;&#1080;&#1072;&#1083;&#1080;&#1079;&#1080;&#1088;&#1091;&#1077;&#1084; IP
    <span style="color: #00ffff;">mov</span>     $cold_start, <span style="color: #eedd82;">%esi</span>
    # &#1047;&#1072;&#1087;&#1091;&#1089;&#1082;&#1072;&#1077;&#1084; &#1080;&#1085;&#1090;&#1077;&#1088;&#1087;&#1088;&#1077;&#1090;&#1072;&#1090;&#1086;&#1088;
    <span style="color: #00ffff;">NEXT</span>

    <span style="color: #00ffff;">.section</span> .rodata
<span style="color: #87cefa;">cold_start</span>:                             # High-level code without a codeword.
    <span style="color: #00ffff;">.int</span> QUIT
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-7" class="outline-3">
<h3 id="unnumbered-7">Встроенные слова</h3>
<div class="outline-text-3" id="text-unnumbered-7">
<p>
Помните наши словарные записи? Давайте приведем их вместе с <code>codeword</code> и <code>param-field</code>,
чтобы увидеть, как
</p>

<div class="org-src-container">

<pre class="src src-forth">: DOUBLE DUP <span style="color: #00ffff;">;</span>
</pre>
</div>

<p>
действительно выглядит в памяти.
</p>

<p>
Мы хотим формировать свои первые слова байт за байтом прямо внутри этого файла чтобы,
когда этот файл будет скомпилирован, у нас был минимальный набор слов.
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-09.png" alt="forth-interpret-09.png">
</p>
</div>

<p>
Вначале мы не можем просто написать буквально <code>: DOUBLE DUP ;</code> , потому что нам еще пока
нечем читать строку, разбивать ее на слова, анализировать каждое слово и.т.д. Поэтому
вместо этого нам придется определять встроенные слова, используя конструкторы данных
ассемблера GNU (например, .int, .byte, .string, .ascii и.т.д.)
</p>

<div class="org-src-container">

<pre class="src src-asm">    <span style="color: #00ffff;">.int</span>  &lt;&#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1087;&#1088;&#1077;&#1076;&#1099;&#1076;&#1091;&#1097;&#1077;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086;&gt;
    <span style="color: #00ffff;">.byte</span> 6         # len
    <span style="color: #00ffff;">.ascii</span> <span style="color: #ffa07a;">"DOUBLE"</span> # name
    <span style="color: #00ffff;">.byte</span> 0         # padding
<span style="color: #87cefa;">DOUBLE</span>:
    <span style="color: #00ffff;">.int</span> DOCOL      # codeword
    <span style="color: #00ffff;">.int</span> DUP        # &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; codeword DUP
    <span style="color: #00ffff;">.int</span> PLUS       # &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; codeword +
    <span style="color: #00ffff;">.int</span> EXIT       # &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; codeword EXIT
</pre>
</div>

<p>
Но это быстро утомляет, поэтому я определяю ассемблерный макрос, чтобы я мог просто
написать:
</p>

<div class="org-src-container">

<pre class="src src-asm"><span style="color: #87cefa;">defword</span> <span style="color: #ffa07a;">"DOUBLE"</span>,6,,DOUBLE
    <span style="color: #00ffff;">.int</span> DUP,PLUS,EXIT
</pre>
</div>

<p>
и получить точно такой же эффект. Мы определим здесь значение флагов, реализацию
которых обсудим несколько позже.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="flags"><span style="color: #00ffff;">.set</span> F_IMMED,0x80
<span style="color: #00ffff;">.set</span> F_HIDDEN,0x20
<span style="color: #00ffff;">.set</span> F_LENMASK,0x1f  # length mask
</pre>
</div>

<p>
А вот и наш макрос <code>defword</code>:
</p>

<div class="org-src-container">

<pre class="src src-asm" id="macro_defword">    <span style="color: #00ffff;">.set</span> link,0             # &#1048;&#1085;&#1080;&#1094;&#1080;&#1072;&#1083;&#1080;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100; &#1085;&#1072;&#1095;&#1072;&#1083;&#1100;&#1085;&#1086;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077;
                            # &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081; &#1074;&#1088;&#1077;&#1084;&#1077;&#1085;&#1080; &#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1103;&#1094;&#1080;&#1080; link
<span style="color: #00ffff;">.macro</span> defword name, namelen, flags=0, label
    <span style="color: #00ffff;">.section</span> .rodata
    <span style="color: #00ffff;">.align</span> 4
    <span style="color: #00ffff;">.globl</span> name_\label
<span style="color: #87cefa;">name</span>_\label :
    <span style="color: #00ffff;">.int</span> link               # link
    <span style="color: #00ffff;">.set</span> link,name_\label
    <span style="color: #00ffff;">.byte</span> \flags+\namelen   # flags + &#1073;&#1072;&#1081;&#1090; &#1076;&#1083;&#1080;&#1085;&#1099;
    <span style="color: #00ffff;">.ascii</span> <span style="color: #ffa07a;">"\name"</span>          # &#1080;&#1084;&#1103;
    <span style="color: #00ffff;">.align</span> 4                # &#1074;&#1099;&#1088;&#1072;&#1074;&#1085;&#1080;&#1074;&#1072;&#1085;&#1080;&#1077; &#1085;&#1072; 4-&#1093; &#1073;&#1072;&#1081;&#1090;&#1086;&#1074;&#1091;&#1102; &#1075;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091;
    <span style="color: #00ffff;">.globl</span> \label
\label :
    <span style="color: #00ffff;">.int</span> DOCOL              # codeword - &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1102;-&#1080;&#1085;&#1090;&#1077;&#1087;&#1088;&#1077;&#1090;&#1072;&#1090;&#1086;&#1088;
    # &#1076;&#1072;&#1083;&#1100;&#1096;&#1077; &#1073;&#1091;&#1076;&#1091;&#1090; &#1080;&#1076;&#1090;&#1080; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1080; &#1085;&#1072; &#1089;&#1083;&#1086;&#1074;&#1072;
<span style="color: #00ffff;">.endm</span>
</pre>
</div>

<p>
Этим способом я хочу писать высокоуровневые слова, написанные с использованием
ассемблера (как инструмента). Мы должны написать некоторое количество базового кода,
прежде чем будет достаточно инфраструктуры, чтобы начать писать слова на Forth, но
также я хочу определить некоторые общие слова на ассемблере для скорости, хотя я мог бы
написать их на Forth.
</p>

<p>
Сейчас этим и займемся. Для начала, рассмотрим, как DUP выглядит в памяти:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-10.png" alt="forth-interpret-10.png">
</p>
</div>

<p>
Опять же, для краткости я собираюсь написать макрос ассемблера с именем <code>defcode</code>.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="macro_defcode"><span style="color: #00ffff;">.macro</span> defcode name, namelen, flags=0, label
    <span style="color: #00ffff;">.section</span> .rodata
    <span style="color: #00ffff;">.align</span> 4
    <span style="color: #00ffff;">.globl</span> name_\label
<span style="color: #87cefa;">name</span>_\label :
    <span style="color: #00ffff;">.int</span>    link               # link
    <span style="color: #00ffff;">.set</span>    link,name_\label
    <span style="color: #00ffff;">.byte</span>   \flags+\namelen    # flags + &#1073;&#1072;&#1081;&#1090; &#1076;&#1083;&#1080;&#1085;&#1099;
    <span style="color: #00ffff;">.ascii</span>  <span style="color: #ffa07a;">"\name"</span>            # &#1080;&#1084;&#1103;
    <span style="color: #00ffff;">.align</span>  4                  # &#1074;&#1099;&#1088;&#1072;&#1074;&#1085;&#1080;&#1074;&#1072;&#1085;&#1080;&#1077; &#1085;&#1072; 4-&#1093; &#1073;&#1072;&#1081;&#1090;&#1086;&#1074;&#1091;&#1102; &#1075;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091;
    <span style="color: #00ffff;">.globl</span>  \label
\label :
    <span style="color: #00ffff;">.int</span>    code_\label        # codeword
    <span style="color: #00ffff;">.text</span>
    <span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">.align 4</span>
    <span style="color: #00ffff;">.globl</span>  code_\label
<span style="color: #87cefa;">code</span>_\label :
    # &#1076;&#1072;&#1083;&#1077;&#1077; &#1089;&#1083;&#1077;&#1076;&#1091;&#1077;&#1090; &#1072;&#1089;&#1089;&#1077;&#1084;&#1073;&#1083;&#1077;&#1088;&#1085;&#1099;&#1081; &#1082;&#1086;&#1076;
<span style="color: #00ffff;">.endm</span>
</pre>
</div>

<p>
Теперь несколько простых примитивов Forth. Они написаны на ассемблере для скорости.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="simple_primitives"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"DROP"</span>,4,,DROP
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1089;&#1073;&#1088;&#1086;&#1089;&#1080;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"SWAP"</span>,4,,SWAP
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1087;&#1086;&#1084;&#1077;&#1085;&#1103;&#1090;&#1100; &#1084;&#1077;&#1089;&#1090;&#1072;&#1084;&#1080; &#1076;&#1074;&#1072; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1093; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1072; &#1085;&#1072; &#1089;&#1090;&#1077;&#1082;&#1077;
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"DUP"</span>,3,,DUP
    <span style="color: #00ffff;">mov</span>     (<span style="color: #eedd82;">%esp</span>), <span style="color: #eedd82;">%eax</span>    # &#1076;&#1091;&#1073;&#1083;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072;
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"OVER"</span>,4,,OVER
    <span style="color: #00ffff;">mov</span>     4(<span style="color: #eedd82;">%esp</span>), <span style="color: #eedd82;">%eax</span>   # &#1074;&#1079;&#1103;&#1090;&#1100; &#1074;&#1090;&#1086;&#1088;&#1086;&#1081; &#1086;&#1090; &#1074;&#1077;&#1088;&#1093;&#1072; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072;
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>            # &#1080; &#1087;&#1086;&#1083;&#1086;&#1078;&#1080;&#1090;&#1100; &#1077;&#1075;&#1086; &#1082;&#1086;&#1087;&#1080;&#1102; &#1089;&#1074;&#1077;&#1088;&#1093;&#1091;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"ROT"</span>,3,,ROT
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ecx</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%ecx</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"-ROT"</span>,4,,NROT
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ecx</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%ecx</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"2DROP"</span>,5,,TWODROP
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1089;&#1073;&#1088;&#1086;&#1089;&#1080;&#1090;&#1100; &#1076;&#1074;&#1072; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1093; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1072; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072;
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"2DUP"</span>,4,,TWODUP
    <span style="color: #00ffff;">movl</span>    (<span style="color: #eedd82;">%esp</span>), <span style="color: #eedd82;">%eax</span>    # &#1076;&#1091;&#1073;&#1083;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100; &#1076;&#1074;&#1072; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1093; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1072; &#1085;&#1072; &#1089;&#1090;&#1077;&#1082;&#1077;
    <span style="color: #00ffff;">movl</span>    4(<span style="color: #eedd82;">%esp</span>), <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"2SWAP"</span>,5,,TWOSWAP
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1087;&#1086;&#1084;&#1077;&#1085;&#1103;&#1090;&#1100; &#1084;&#1077;&#1089;&#1090;&#1072;&#1084;&#1080; &#1076;&#1074;&#1077; &#1087;&#1072;&#1088;&#1099; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1086;&#1074; &#1085;&#1072; &#1089;&#1090;&#1077;&#1082;&#1077;
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ecx</span>
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%edx</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%edx</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%ecx</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"?DUP"</span>,4,,QDUP
    <span style="color: #00ffff;">movl</span>    (<span style="color: #eedd82;">%esp</span>), <span style="color: #eedd82;">%eax</span>    # &#1076;&#1091;&#1073;&#1083;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1077;&#1089;&#1083;&#1080; &#1086;&#1085; &#1085;&#1077; &#1085;&#1091;&#1083;&#1077;&#1074;&#1086;&#1081;
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">jz</span>      1f
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
<span style="color: #87cefa;">1</span>:
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"1+"</span>,2,,INCR
    <span style="color: #00ffff;">incl</span>    (<span style="color: #eedd82;">%esp</span>)          # &#1091;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1085;&#1072; &#1077;&#1076;&#1080;&#1085;&#1080;&#1094;&#1091;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"1-"</span>,2,,DECR
    <span style="color: #00ffff;">decl</span>    (<span style="color: #eedd82;">%esp</span>)          # &#1091;&#1084;&#1077;&#1085;&#1100;&#1096;&#1080;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1085;&#1072; &#1077;&#1076;&#1080;&#1085;&#1080;&#1094;&#1091;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"4+"</span>,2,,INCR4
    <span style="color: #00ffff;">addl</span>    $4, (<span style="color: #eedd82;">%esp</span>)      # &#1091;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1085;&#1072; 4
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"4-"</span>,2,,DECR4
    <span style="color: #00ffff;">subl</span>    $4, (<span style="color: #eedd82;">%esp</span>)      # &#1091;&#1084;&#1077;&#1085;&#1100;&#1096;&#1080;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1085;&#1072; 4
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"+"</span>,1,,ADD
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1074;&#1079;&#1103;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072;
    <span style="color: #00ffff;">addl</span>    <span style="color: #eedd82;">%eax</span>, (<span style="color: #eedd82;">%esp</span>)    # &#1087;&#1088;&#1080;&#1073;&#1072;&#1074;&#1080;&#1100; &#1077;&#1075;&#1086; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1082; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1091;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1081; &#1089;&#1090;&#1072;&#1083; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1084;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"-"</span>,1,,SUB
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1074;&#1079;&#1103;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072;
    <span style="color: #00ffff;">subl</span>    <span style="color: #eedd82;">%eax</span>, (<span style="color: #eedd82;">%esp</span>)    # &#1074;&#1099;&#1095;&#1077;&#1089;&#1090;&#1100; &#1077;&#1075;&#1086; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1080;&#1079; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1072;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1081; &#1089;&#1090;&#1072;&#1083; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1084; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1084;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"*"</span>,1,,MUL
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1074;&#1079;&#1103;&#1090;&#1100; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>            # &#1074;&#1079;&#1103;&#1090;&#1100; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1080;&#1081; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;
    <span style="color: #00ffff;">imull</span>   <span style="color: #eedd82;">%ebx</span>, <span style="color: #eedd82;">%eax</span>      # &#1091;&#1084;&#1085;&#1086;&#1078;&#1080;&#1090;&#1100; &#1080;&#1093; &#1076;&#1088;&#1091;&#1075; &#1085;&#1072; &#1076;&#1088;&#1091;&#1075;&#1072;
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>            # &#1080;&#1075;&#1085;&#1086;&#1088;&#1080;&#1088;&#1091;&#1077;&#1084; &#1087;&#1077;&#1088;&#1077;&#1087;&#1086;&#1083;&#1085;&#1077;&#1085;&#1080;&#1077;
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>

<p>
В этом Forth только <code>/MOD</code> примитив. Позже мы определим слова <code>/</code> и <code>MOD</code> в терминах
примитива <code>/MOD</code>. Конструкция ассемблерной команды <code>idiv</code>, которая оставляет как частное,
так и остаток, делает этот выбор очевидным.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="mod"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"/MOD"</span>,4,,DIVMOD
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">cdq</span>
    <span style="color: #00ffff;">idivl</span>   <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%edx</span>            # push &#1086;&#1089;&#1090;&#1072;&#1090;&#1086;&#1082;
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>            # push &#1095;&#1072;&#1089;&#1090;&#1085;&#1086;&#1077;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"U/MOD"</span>,5,,UDIVMOD
    <span style="color: #00ffff;">xor</span> <span style="color: #eedd82;">%edx</span>, <span style="color: #eedd82;">%edx</span>
    <span style="color: #00ffff;">pop</span> <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">pop</span> <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">divl</span> <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">push</span> <span style="color: #eedd82;">%edx</span>               # push &#1086;&#1089;&#1090;&#1072;&#1090;&#1086;&#1082;
    <span style="color: #00ffff;">push</span> <span style="color: #eedd82;">%eax</span>               # push &#1095;&#1072;&#1089;&#1090;&#1085;&#1086;&#1077;
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>

<p>
Множество сравнительных операций, таких как <code>=</code>, <code>&lt;</code>, <code>&gt;</code>, и.т.д
</p>

<p>
Стандарт ANSI Forth говорит, что слова сравнения должны возвращать все двоичные разряды
равные единице для TRUE, и все двоичные разряды равные нулю для FALSE. Для
программистов на языке Си это немного странное соглашение, поэтому этот Forth не
следует ему и возвращает более нормальное (для программистов на Си) значение <code>1</code> для
TRUE и <code>0</code> для FALSE.
</p>

<p>
Причиной этого соглашения является то, что при его использовании слова AND, OR, XOR и
INVERT могут функционировать одновременно как логические операторы, так и как побитовые
операторы. Для сравнения, если использовать соглашение языка Си, что FALSE = 0 и TRUE =
1, вам нужны два набора операторов: <code>&amp;&amp;</code> и <code>&amp;</code>, <code>||</code> и <code>|</code>, и.т.д.
</p>

<p>
В будущем я планирую приблизить этот Forth к стандарту ANSI и отказаться от
использования boolean-соглашений языка Си везде, кроме вызова сишных API. Минусом
такого подхода будет увеличение накладных расходов при вызове сишных API на конвертацию
логических значений, и необходимость аккуратно отследить все места изменений.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="comparison"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"="</span>,1,,EQU
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1076;&#1074;&#1072; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1093; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1072; &#1089;&#1090;&#1077;&#1082;&#1072; &#1088;&#1072;&#1074;&#1085;&#1099;?
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">cmpl</span>    <span style="color: #eedd82;">%ebx</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">sete</span>    <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzbl</span>  <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"&lt;&gt;"</span>,2,,NEQU
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1076;&#1074;&#1072; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1093; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1072; &#1089;&#1090;&#1077;&#1082;&#1072; &#1085;&#1077; &#1088;&#1072;&#1074;&#1085;&#1099;?
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">cmpl</span>    <span style="color: #eedd82;">%ebx</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">setne</span>   <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzbl</span>  <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"&lt;"</span>,1,,LT
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">cmpl</span>    <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">setl</span>    <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzbl</span>  <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"&gt;"</span>,1,,GT
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">cmpl</span>    <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">setg</span>    <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzbl</span>  <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"&lt;="</span>,2,,LE
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">cmpl</span>    <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">setle</span>   <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzbl</span>  <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"&gt;="</span>,2,,GE
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">cmpl</span>    <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">setge</span>   <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzbl</span>  <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"0="</span>,2,,ZEQU
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1088;&#1072;&#1074;&#1077;&#1085; &#1085;&#1091;&#1083;&#1102;?
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">setz</span>    <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzbl</span>  <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"0&lt;&gt;"</span>,3,,ZNEQU
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1085;&#1077; &#1088;&#1072;&#1074;&#1077;&#1085; &#1085;&#1091;&#1083;&#1102;?
    <span style="color: #00ffff;">testl</span>   <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">setnz</span>   <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzbl</span>  <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"0&lt;"</span>,2,,ZLT
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # comparisons with 0
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">setl</span>    <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzbl</span>  <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"0&gt;"</span>,2,,ZGT
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">testl</span>   <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">setg</span>    <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzbl</span>  <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"0&lt;="</span>,3,,ZLE
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">testl</span>   <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">setle</span>   <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzbl</span>  <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"0&gt;="</span>,3,,ZGE
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">setge</span>   <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzbl</span>  <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"AND"</span>,3,,AND
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1073;&#1080;&#1090;&#1086;&#1074;&#1099;&#1081; AND
    <span style="color: #00ffff;">andl</span>    <span style="color: #eedd82;">%eax</span>, (<span style="color: #eedd82;">%esp</span>)
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"OR"</span>,2,,OR
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1073;&#1080;&#1090;&#1086;&#1074;&#1099;&#1081; OR
    <span style="color: #00ffff;">orl</span>     <span style="color: #eedd82;">%eax</span>, (<span style="color: #eedd82;">%esp</span>)
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"XOR"</span>,3,,XOR
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1073;&#1080;&#1090;&#1086;&#1074;&#1099;&#1081; XOR
    <span style="color: #00ffff;">xorl</span>    <span style="color: #eedd82;">%eax</span>, (<span style="color: #eedd82;">%esp</span>)
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"INVERT"</span>,6,,INVERT
    <span style="color: #00ffff;">notl</span>    (<span style="color: #eedd82;">%esp</span>)          # &#1101;&#1090;&#1086; &#1073;&#1080;&#1090;&#1086;&#1074;&#1072;&#1103; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; <span style="color: #ffa07a;">"NOT"</span> (&#1089;&#1084;. NEGATE and NOT)
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-8" class="outline-3">
<h3 id="unnumbered-8">Cmdline слова</h3>
<div class="outline-text-3" id="text-unnumbered-8">
<div class="org-src-container">

<pre class="src src-asm" id="argc"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"ARGC"</span>,4,,ARGC
    <span style="color: #00ffff;">mov</span>     (forth_asm_argc), <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-asm" id="argv"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"ARGV"</span>,4,,ARGV
    <span style="color: #00ffff;">mov</span>     (forth_asm_argv), <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-9" class="outline-3">
<h3 id="unnumbered-9">Env слова</h3>
<div class="outline-text-3" id="text-unnumbered-9">
<div class="org-src-container">

<pre class="src src-asm" id="env"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"ENV"</span>,3,,ENV
    <span style="color: #00ffff;">mov</span>     (environ), <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-10" class="outline-3">
<h3 id="unnumbered-10">EXIT - Возвращение из форт-слов</h3>
<div class="outline-text-3" id="text-unnumbered-10">
<p>
Время поговорить о том, что происходит, когда мы делаем EXIT. На этой диаграмме
QUADRUPLE вызывает DOUBLE, и DOUBLE собирается сделать EXIT (посмотрите, куда указывает
<code>%esi</code>)
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-11.png" alt="forth-interpret-11.png">
</p>
</div>

<p>
Что происходит, когда функция выполняет NEXT? Выполняется следующий код:
</p>

<div class="org-src-container">

<pre class="src src-asm" id="exit"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"EXIT"</span>,4,,EXIT
    <span style="color: #00ffff;">POPRSP</span>  <span style="color: #eedd82;">%esi</span>            # &#1042;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1080;&#1079; &#1089;&#1090;&#1077;&#1082;&#1072; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074; &#1074; <span style="color: #eedd82;">%esi</span>
    <span style="color: #00ffff;">NEXT</span>                    # &#1057;&#1076;&#1077;&#1083;&#1072;&#1090;&#1100; NEXT
</pre>
</div>

<p>
EXIT получает старый <code>%esi</code>, который мы сохранили ранее (когда выполняли DOCOL) в <code>стеке
возвратов</code>, и помещает его в <code>%esi</code>. Итак, после этого (но до NEXT) мы получаем:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-12.png" alt="forth-interpret-12.png">
</p>
</div>

<p>
И NEXT просто завершает работу, в этом случае, просто вызвав DOUBLE снова.
</p>
</div>
</div>

<div id="outline-container-unnumbered-11" class="outline-3">
<h3 id="unnumbered-11">Литералы</h3>
<div class="outline-text-3" id="text-unnumbered-11">
<p>
Последний момент, который я "замалчивал" раньше, заключался в том, как иметь дело с
функциями, которые делают что-либо помимо вызова других функций. Например, предположим,
что DOUBLE был определен следующим образом:
</p>

<div class="org-src-container">

<pre class="src src-forth">: DOUBLE 2 * <span style="color: #00ffff;">;</span>
</pre>
</div>

<p>
Он делает то же самое, но как мы его скомпилируем, если он содержит буквально цифру 2?
Одним из способов было бы иметь функцию под названием <code>2</code> (которую вы должны были бы
написать на ассемблере), но вам понадобится такая функция для каждого отдельного
литерала, который вы бы хотели использовать.
</p>

<p>
Forth решает это, вкомпиливая в слово специальное слово LIT:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-13.png" alt="forth-interpret-13.png">
</p>
</div>

<p>
Возможно более понятным будет такое представление:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-13a.png" alt="forth-interpret-13a.png">
</p>
</div>

<p>
LIT выполняется обычным способом, но то, что он делает дальше, определенно не
нормально. Он смотрит на <code>%esi</code> (который теперь указывает на число <code>2</code>), берет это
число и кладет его в стек, а затем манипулирует <code>%esi</code>, чтобы пропустить число <code>2</code>, как
если бы его никогда не было.
</p>

<p>
Так что там за проблема с числами, скажете вы? А вот в чем. Если вы помните, как
работает <code>lodsl</code> и <code>NEXT</code>, то вы сразу поймете, что в случае, если числа никак не будут
проигнорированны, то при исполнении слова, Forth, наткнувшись на число, попытается
исполнить его как слово. То есть попытается перейти на адрес 2, что приведет к ошибке.
</p>

<p>
Что интересно, так это то, что весь захват и манипуляция может быть выполнена с
использованием одной байтовой команды i386, нашего старого друга <code>LODSL</code>. Вместо того,
чтобы рисовать диаграммы, посмотрите, можете ли вы узнать, как работает <code>LIT</code>:
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_lit"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"LIT"</span>,3,,LIT
    # <span style="color: #eedd82;">%esi</span> &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1091;&#1102; &#1082;&#1086;&#1084;&#1072;&#1085;&#1076;&#1091;, &#1085;&#1086; &#1074; &#1101;&#1090;&#1086;&#1084; &#1089;&#1083;&#1091;&#1095;&#1072;&#1077; &#1101;&#1090;&#1086; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1080;&#1081;
    # &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;, &#1087;&#1088;&#1077;&#1076;&#1089;&#1090;&#1072;&#1074;&#1083;&#1103;&#1102;&#1097;&#1080;&#1081; &#1089;&#1086;&#1073;&#1086;&#1081; 4 &#1073;&#1072;&#1081;&#1090;&#1086;&#1074;&#1086;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077;. &#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1101;&#1090;&#1086;&#1075;&#1086; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;&#1072; &#1074; <span style="color: #eedd82;">%eax</span>
    # &#1080; &#1080;&#1085;&#1082;&#1088;&#1077;&#1084;&#1077;&#1085;&#1090; <span style="color: #eedd82;">%esi</span> &#1085;&#1072; x86 -  &#1101;&#1090;&#1086; &#1091;&#1076;&#1086;&#1073;&#1085;&#1072;&#1103; &#1086;&#1076;&#1085;&#1086;&#1073;&#1072;&#1081;&#1090;&#1086;&#1074;&#1072;&#1103; &#1080;&#1085;&#1089;&#1090;&#1088;&#1091;&#1082;&#1094;&#1080;&#1103;! (&#1089;&#1084;. NEXT macro)
    <span style="color: #00ffff;">lodsl</span>
    # push literal &#1074; &#1089;&#1090;&#1077;&#1082;
    <span style="color: #00ffff;">push</span> <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-12" class="outline-3">
<h3 id="unnumbered-12">Память</h3>
<div class="outline-text-3" id="text-unnumbered-12">
<p>
Важным моментом в Forth является то, что он дает вам прямой доступ к самым
низкоуровневым деталям виртуальной машины. Манипулирование памятью часто осуществляется
в Forth, и вот примитивы для этого:
</p>

<div class="org-src-container">

<pre class="src src-asm" id="store"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"!"</span>,1,,STORE
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1072;&#1076;&#1088;&#1077;&#1089;, &#1082;&#1091;&#1076;&#1072; &#1073;&#1091;&#1076;&#1077;&#1084; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1090;&#1100;
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1077;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1077; &#1073;&#1091;&#1076;&#1077;&#1084; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1090;&#1100;
    <span style="color: #00ffff;">movl</span>    <span style="color: #eedd82;">%eax</span>, (<span style="color: #eedd82;">%ebx</span>)    # &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1077;&#1084; &#1076;&#1072;&#1085;&#1085;&#1099;&#1077; &#1087;&#1086; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"@"</span>,1,,FETCH
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;, &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1082;&#1086;&#1090;&#1086;&#1088;&#1086;&#1081; &#1085;&#1072;&#1076;&#1086; &#1074;&#1077;&#1088;&#1085;&#1091;&#1090;&#1100;
    <span style="color: #00ffff;">movl</span>    (<span style="color: #eedd82;">%ebx</span>), <span style="color: #eedd82;">%eax</span>    # &#1074;&#1099;&#1103;&#1089;&#1085;&#1103;&#1077;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1087;&#1086; &#1101;&#1090;&#1086;&#1084;&#1091; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091;
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>            # push-&#1080;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1074; &#1089;&#1090;&#1077;&#1082;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"+!"</span>,2,,ADDSTORE
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1091;&#1102; &#1073;&#1091;&#1076;&#1077;&#1084; &#1091;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1074;&#1072;&#1090;&#1100;
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1085;&#1072; &#1082;&#1086;&#1090;&#1086;&#1088;&#1086;&#1077; &#1073;&#1091;&#1076;&#1077;&#1084; &#1091;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1074;&#1072;&#1090;&#1100;
    <span style="color: #00ffff;">addl</span>    <span style="color: #eedd82;">%eax</span>, (<span style="color: #eedd82;">%ebx</span>)    # &#1076;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1082; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081; &#1087;&#1086; &#1101;&#1090;&#1086;&#1084;&#1091; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"-!"</span>,2,,SUBSTORE
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1091;&#1102; &#1073;&#1091;&#1076;&#1077;&#1084; &#1091;&#1084;&#1077;&#1085;&#1100;&#1096;&#1072;&#1090;&#1100;
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1085;&#1072; &#1082;&#1086;&#1090;&#1086;&#1088;&#1086;&#1077; &#1073;&#1091;&#1076;&#1077;&#1084; &#1091;&#1084;&#1077;&#1085;&#1100;&#1096;&#1072;&#1090;&#1100;
    <span style="color: #00ffff;">subl</span>    <span style="color: #eedd82;">%eax</span>, (<span style="color: #eedd82;">%ebx</span>)    # &#1074;&#1099;&#1095;&#1080;&#1090;&#1072;&#1077;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1080;&#1079; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081; &#1087;&#1086; &#1101;&#1090;&#1086;&#1084;&#1091; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091;
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>

<p>
<code>!</code> и <code>@</code> (STORE и FETCH) работают с 32-битными словами. Также полезно иметь
возможность читать и писать байты, поэтому мы также определяем стандартные слова <code>C@</code> и
<code>C!</code>. Байт-ориентированные операции работают только на архитектуре, которая их
разрешает (i386 является одной из них).
</p>

<div class="org-src-container">

<pre class="src src-asm" id="char_store"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"C!"</span>,2,,STOREBYTE
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1072;&#1076;&#1088;&#1077;&#1089;, &#1082;&#1091;&#1076;&#1072; &#1073;&#1091;&#1076;&#1077;&#1084; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1090;&#1100;
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1077;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1077; &#1073;&#1091;&#1076;&#1077;&#1084; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1090;&#1100;
    <span style="color: #00ffff;">movb</span>    <span style="color: #eedd82;">%al</span>, (<span style="color: #eedd82;">%ebx</span>)     # &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1077;&#1084; &#1076;&#1072;&#1085;&#1085;&#1099;&#1077; &#1087;&#1086; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"C@"</span>,2,,FETCHBYTE
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebx</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;, &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1082;&#1086;&#1090;&#1086;&#1088;&#1086;&#1081; &#1085;&#1072;&#1076;&#1086; &#1074;&#1077;&#1088;&#1085;&#1091;&#1090;&#1100;
    <span style="color: #00ffff;">xorl</span>    <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>      # &#1086;&#1095;&#1080;&#1097;&#1072;&#1077;&#1084; &#1088;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088; <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">movb</span>    (<span style="color: #eedd82;">%ebx</span>), <span style="color: #eedd82;">%al</span>     # &#1074;&#1099;&#1103;&#1089;&#1085;&#1103;&#1077;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1087;&#1086; &#1101;&#1090;&#1086;&#1084;&#1091; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>            # push-&#1080;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1074; &#1089;&#1090;&#1077;&#1082;
    <span style="color: #00ffff;">NEXT</span>

# C@C! - &#1101;&#1090;&#1086; &#1087;&#1086;&#1083;&#1077;&#1079;&#1085;&#1099;&#1081; &#1087;&#1088;&#1080;&#1084;&#1080;&#1090;&#1080;&#1074; &#1076;&#1083;&#1103; &#1082;&#1086;&#1087;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; &#1073;&#1072;&#1081;&#1090;
<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"C@C!"</span>,4,,CCOPY
    <span style="color: #00ffff;">movl</span>    4(<span style="color: #eedd82;">%esp</span>), <span style="color: #eedd82;">%ebx</span>   # &#1072;&#1076;&#1088;&#1077;&#1089; &#1080;&#1089;&#1090;&#1086;&#1095;&#1085;&#1080;&#1082;&#1072;
    <span style="color: #00ffff;">movb</span>    (<span style="color: #eedd82;">%ebx</span>), <span style="color: #eedd82;">%al</span>     # &#1087;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1073;&#1072;&#1081;&#1090; &#1080;&#1079; &#1080;&#1089;&#1090;&#1086;&#1095;&#1085;&#1080;&#1082;&#1072;
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%edi</span>            # &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1088;&#1080;&#1077;&#1084;&#1085;&#1080;&#1082;&#1072;
    <span style="color: #00ffff;">stosb</span>                   # &#1082;&#1086;&#1087;&#1080;&#1088;&#1091;&#1077;&#1084; &#1073;&#1072;&#1081;&#1090; &#1074; &#1087;&#1088;&#1080;&#1077;&#1084;&#1085;&#1080;&#1082;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%edi</span>            # &#1091;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1074;&#1072;&#1077;&#1084; &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1088;&#1080;&#1077;&#1084;&#1085;&#1080;&#1082;&#1072;
    <span style="color: #00ffff;">incl</span>    4(<span style="color: #eedd82;">%esp</span>)         # &#1091;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1074;&#1072;&#1077;&#1084; &#1072;&#1076;&#1088;&#1077;&#1089; &#1080;&#1089;&#1090;&#1086;&#1095;&#1085;&#1080;&#1082;&#1072;
    <span style="color: #00ffff;">NEXT</span>

# CMOVE - &#1086;&#1087;&#1077;&#1088;&#1072;&#1094;&#1080;&#1103; &#1082;&#1086;&#1087;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; &#1073;&#1083;&#1086;&#1082;&#1072; &#1073;&#1072;&#1081;&#1090;&#1086;&#1074;
<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"CMOVE"</span>,5,,CMOVE
    <span style="color: #00ffff;">movl</span>    <span style="color: #eedd82;">%esi</span>, <span style="color: #eedd82;">%edx</span>      # &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1084; <span style="color: #eedd82;">%esi</span>
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ecx</span>            # length
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%edi</span>            # &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1088;&#1080;&#1077;&#1084;&#1085;&#1080;&#1082;&#1072;
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%esi</span>            # &#1072;&#1076;&#1088;&#1077;&#1089; &#1080;&#1089;&#1090;&#1086;&#1095;&#1085;&#1080;&#1082;&#1072;
    <span style="color: #00ffff;">rep</span>     movsb           # &#1082;&#1086;&#1087;&#1080;&#1088;&#1091;&#1077;&#1084; &#1080;&#1089;&#1090;&#1086;&#1095;&#1085;&#1080;&#1082; &#1074; &#1087;&#1088;&#1080;&#1077;&#1084;&#1085;&#1080;&#1082; length &#1088;&#1072;&#1079;
    <span style="color: #00ffff;">movl</span>    <span style="color: #eedd82;">%edx</span>, <span style="color: #eedd82;">%esi</span>      # &#1074;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; <span style="color: #eedd82;">%esi</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-13" class="outline-3">
<h3 id="unnumbered-13">Встроенные переменные</h3>
<div class="outline-text-3" id="text-unnumbered-13">
<p>
Это некоторые встроенные переменные и соответствующие стандартные слова Forth. Из них
единственное, что мы обсуждали до сих пор, было LATEST, указывающее на последнее
определенное в словаре Forth слово. LATEST также является словом Forth, которое
выталкивает адрес переменнуй LATEST в стек, поэтому вы можете читать или писать ее с
помощью операторов <code>@</code> и <code>!</code>. Например, чтобы напечатать текущее значение LATEST (и это
применимо к любой переменной Forth), вы должны:
</p>

<div class="org-src-container">

<pre class="src src-forth">LATEST @ . CR
</pre>
</div>

<p>
Чтобы уменьшить определение переменных, я использую макрос <code>defvar</code>, похожий на
<code>defword</code> и <code>defcode</code> выше. (Фактически, <code>defvar</code> макрос использует <code>defcode</code> для
создания заголовка записи в словаре).
</p>

<div class="org-src-container">

<pre class="src src-asm" id="macro_defvar"><span style="color: #00ffff;">.macro</span> defvar name, namelen, flags=0, label, initial=0
    <span style="color: #00ffff;">defcode</span> \name,\namelen,\flags,\label
    <span style="color: #00ffff;">push</span>    $var_\name
    <span style="color: #00ffff;">NEXT</span>
    <span style="color: #00ffff;">.data</span>
    <span style="color: #00ffff;">.align</span> 4
    <span style="color: #00ffff;">var_</span>\name :
    <span style="color: #00ffff;">.int</span> \initial
<span style="color: #00ffff;">.endm</span>
</pre>
</div>

<p>
Встроенные переменные:
</p>
<ul class="org-ul">
<li>STATE - состояние интерпретации (ноль) или компиляции слова (не ноль)
</li>
<li>LATEST - указатель на последнее заданное слово в словаре.
</li>
<li>HERE - указатель на следующий свободный байт памяти. При компиляции скомпилированные
слова помещаются по этому указателю, а потом он передвигается дальше.
</li>
<li>S0 - хранит адрес вершины стека параметров.
</li>
<li>BASE - текущая база (radix) для печати и чтения чисел.
</li>
</ul>

<div class="org-src-container">

<pre class="src src-asm" id="built_in_vars"><span style="color: #87cefa;">defvar</span> <span style="color: #ffa07a;">"STATE"</span>,5,,STATE
<span style="color: #87cefa;">defvar</span> <span style="color: #ffa07a;">"HERE"</span>,4,,HERE
<span style="color: #87cefa;">defvar</span> <span style="color: #ffa07a;">"LATEST"</span>,6,,LATEST,name_SYSCALL0  # SYSCALL0 &#1076;&#1086;&#1083;&#1078;&#1077;&#1085; &#1073;&#1099;&#1090;&#1100; &#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1080;&#1084; &#1074;&#1089;&#1090;&#1088;&#1086;&#1077;&#1085;&#1085;&#1099;&#1084; &#1089;&#1083;&#1086;&#1074;&#1086;&#1084;
<span style="color: #87cefa;">defvar</span> <span style="color: #ffa07a;">"S0"</span>,2,,SZ
<span style="color: #87cefa;">defvar</span> <span style="color: #ffa07a;">"BASE"</span>,4,,BASE,10
</pre>
</div>

<p>
Для того чтобы это стало более понятно, рассмотрим, как создается слово LATEST. Сначал
у нас есть кусок кода, в котором мы хотим сделать макрораскрытие вызова
<code>defvar "LATEST" ...</code>:
</p>

<div class="org-src-container">

<pre class="src src-asm">...
<span style="color: #87cefa;">defvar</span> <span style="color: #ffa07a;">"LATEST"</span>,6,,LATEST,name_SYSCALL0  # SYSCALL0 &#1076;&#1086;&#1083;&#1078;&#1077;&#1085; &#1073;&#1099;&#1090;&#1100; &#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1080;&#1084; &#1074;&#1089;&#1090;&#1088;&#1086;&#1077;&#1085;&#1085;&#1099;&#1084; &#1089;&#1083;&#1086;&#1074;&#1086;&#1084;
...
</pre>
</div>

<p>
Сейчас нам нужно раскрыть <code>defvar</code>. Но сначала напомним (для справки) его определение:
</p>

<div class="org-src-container">

<pre class="src src-asm"><span style="color: #00ffff;">.macro</span> defvar name, namelen, flags=0, label, initial=0
  <span style="color: #00ffff;">defcode</span> \name,\namelen,\flags,\label
    <span style="color: #00ffff;">push</span>    $var_\name
    <span style="color: #00ffff;">NEXT</span>
    <span style="color: #00ffff;">.data</span>
    <span style="color: #00ffff;">.align</span> 4
  <span style="color: #00ffff;">var_</span>\name :
    <span style="color: #00ffff;">.int</span> \initial
<span style="color: #00ffff;">.endm</span>
</pre>
</div>

<p>
Раскрывается макрос <code>defvar</code>:
</p>

<div class="org-src-container">

<pre class="src src-asm">...
<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"LATEST"</span>,6,0,LATEST
    <span style="color: #00ffff;">push</span>    $var_LATEST
    <span style="color: #00ffff;">NEXT</span>
    <span style="color: #00ffff;">.data</span>
    <span style="color: #00ffff;">.align</span> 4
<span style="color: #87cefa;">var_LATEST</span> :
    <span style="color: #00ffff;">.int</span> name_SYSCALL0
...
</pre>
</div>

<p>
Это макрораскрытие обнажает вложенный вызов макроса <code>defcode</code>. Значит, следующий шаг -
раскрытие макроса <code>defcode</code>. Снова (для справки) приведем его определение:
</p>

<div class="org-src-container">

<pre class="src src-asm"><span style="color: #00ffff;">.macro</span> defcode name, namelen, flags=0, label
    <span style="color: #00ffff;">.section</span> .rodata
    <span style="color: #00ffff;">.align</span> 4
    <span style="color: #00ffff;">.globl</span> name_\label
<span style="color: #87cefa;">name</span>_\label :
    <span style="color: #00ffff;">.int</span>    link               # link
    <span style="color: #00ffff;">.set</span>    link,name_\label
    <span style="color: #00ffff;">.byte</span>   \flags+\namelen    # flags + &#1073;&#1072;&#1081;&#1090; &#1076;&#1083;&#1080;&#1085;&#1099;
    <span style="color: #00ffff;">.ascii</span>  <span style="color: #ffa07a;">"\name"</span>            # &#1080;&#1084;&#1103;
    <span style="color: #00ffff;">.align</span>  4                  # &#1074;&#1099;&#1088;&#1072;&#1074;&#1085;&#1080;&#1074;&#1072;&#1085;&#1080;&#1077; &#1085;&#1072; 4-&#1093; &#1073;&#1072;&#1081;&#1090;&#1086;&#1074;&#1091;&#1102; &#1075;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091;
    <span style="color: #00ffff;">.globl</span>  \label
\label :
    <span style="color: #00ffff;">.int</span>    code_\label        # codeword
    <span style="color: #00ffff;">.text</span>
    <span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">.align 4</span>
    <span style="color: #00ffff;">.globl</span>  code_\label
<span style="color: #87cefa;">code</span>_\label :                  # &#1076;&#1072;&#1083;&#1077;&#1077; &#1089;&#1083;&#1077;&#1076;&#1091;&#1077;&#1090; &#1072;&#1089;&#1089;&#1077;&#1084;&#1073;&#1083;&#1077;&#1088;&#1085;&#1099;&#1081; &#1082;&#1086;&#1076;
<span style="color: #00ffff;">.endm</span>
</pre>
</div>

<p>
Раскрывается вложенный макрос <code>defcode</code>:
</p>

<div class="org-src-container">

<pre class="src src-asm">...
    <span style="color: #00ffff;">.section</span> .rodata
    <span style="color: #00ffff;">.align</span> 4
    <span style="color: #00ffff;">.globl</span> name_LATEST
<span style="color: #87cefa;">name_LATEST</span> :
    <span style="color: #00ffff;">.int</span>    link               # link
    <span style="color: #00ffff;">.set</span>    link,name_LATEST
    <span style="color: #00ffff;">.byte</span>   0+6                # flags + &#1073;&#1072;&#1081;&#1090; &#1076;&#1083;&#1080;&#1085;&#1099;
    <span style="color: #00ffff;">.ascii</span>  <span style="color: #ffa07a;">"LATEST"</span>           # &#1080;&#1084;&#1103;
    <span style="color: #00ffff;">.align</span>  4                  # &#1074;&#1099;&#1088;&#1072;&#1074;&#1085;&#1080;&#1074;&#1072;&#1085;&#1080;&#1077; &#1085;&#1072; 4-&#1093; &#1073;&#1072;&#1081;&#1090;&#1086;&#1074;&#1091;&#1102; &#1075;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091;
    <span style="color: #00ffff;">.globl</span>  LATEST
<span style="color: #87cefa;">LATEST</span> :
    <span style="color: #00ffff;">.int</span>    code_LATEST        # codeword
    <span style="color: #00ffff;">.text</span>
    <span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">.align 4</span>
    <span style="color: #00ffff;">.globl</span>  code_LATEST
<span style="color: #87cefa;">code_LATEST</span> :                  # &#1076;&#1072;&#1083;&#1077;&#1077; &#1089;&#1083;&#1077;&#1076;&#1091;&#1077;&#1090; &#1072;&#1089;&#1089;&#1077;&#1084;&#1073;&#1083;&#1077;&#1088;&#1085;&#1099;&#1081; &#1082;&#1086;&#1076;

    <span style="color: #00ffff;">push</span>    $var_LATEST
    <span style="color: #00ffff;">NEXT</span>
    <span style="color: #00ffff;">.data</span>
    <span style="color: #00ffff;">.align</span> 4
<span style="color: #87cefa;">var_LATEST</span> :
    <span style="color: #00ffff;">.int</span> name_SYSCALL0
...
</pre>
</div>

<p>
Таким образом, последовательное раскрытие этих двух макросов формирует слово LATEST, которое
имеет все то, из чего состоит это слово:
</p>
<ul class="org-ul">
<li>Поле связи LINK
</li>
<li>Байт длины/флагов
</li>
<li>Имя слова
</li>
<li>Выравнивание (pad)
</li>
<li><code>codeword</code>, который указывает на&#x2026;
</li>
<li>&#x2026;код, который пушит на стек данных <b>адрес переменной</b> <code>var_LATEST</code> и делает NEXT
</li>
</ul>

<p>
Значит, чтобы получить само значение переменной, нам требуется выполнить операцию
"получение значения по адресу", более краткое название которой - "разименовывание". В
Forth она имеет имя <code>@</code>. Как мы уже говорили в начале этого раздела, чтобы напечатать
текущее значение LATEST (и это применимо к любой переменной Forth), вы должны
напечатать в Forth-консоли:
</p>

<div class="org-src-container">

<pre class="src src-forth">LATEST @ . CR
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-14" class="outline-3">
<h3 id="unnumbered-14">Встроенные константы</h3>
<div class="outline-text-3" id="text-unnumbered-14">
<p>
Встроенные константы:
</p>
<ul class="org-ul">
<li>VERSION    - это текущая версия этого Forth.
</li>
<li>R0         - максимальный адрес (адрес дна) стека возвратов.
</li>
<li>DOCOL      - Указатель на DOCOL.
</li>
<li>F＿IMMED   - текущее значение флага IMMEDIATE.
</li>
<li>F＿HIDDEN  - Текущее значение флага HIDDEN.
</li>
<li>F＿LENMASK - Маска длины в  flags/len байте
</li>
<li>SYS＿* и числовые коды различных системных вызовов Linux (из &lt;asm/unistd.h&gt;)
</li>
</ul>

<div class="org-src-container">

<pre class="src src-asm" id="macro_defconst"><span style="color: #00ffff;">.macro</span> defconst name, namelen, flags=0, label, value
    <span style="color: #00ffff;">defcode</span> \name,\namelen,\flags,\label
    <span style="color: #00ffff;">push</span> $\value
    <span style="color: #00ffff;">NEXT</span>
<span style="color: #00ffff;">.endm</span>
</pre>
</div>


<div class="org-src-container">

<pre class="src src-asm" id="built_in_constants"><span style="color: #00ffff;">.set</span> JONES_VERSION,47

<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"VERSION"</span>,7,,VERSION,JONES_VERSION
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"R0"</span>,2,,RZ,return_stack_top
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"DOCOL"</span>,5,,__DOCOL,DOCOL
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"F_IMMED"</span>,7,,__F_IMMED,F_IMMED
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"F_HIDDEN"</span>,8,,__F_HIDDEN,F_HIDDEN
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"F_LENMASK"</span>,9,,__F_LENMASK,F_LENMASK

<span style="color: #00ffff;">.set</span> sys_exit,1
<span style="color: #00ffff;">.set</span> sys_read,3
<span style="color: #00ffff;">.set</span> sys_write,4
<span style="color: #00ffff;">.set</span> sys_open,5
<span style="color: #00ffff;">.set</span> sys_close,6
<span style="color: #00ffff;">.set</span> sys_creat,8
<span style="color: #00ffff;">.set</span> sys_unlink,0xA
<span style="color: #00ffff;">.set</span> sys_lseek,0x13
<span style="color: #00ffff;">.set</span> sys_truncate,0x5C

<span style="color: #00ffff;">.set</span> stdin,0
<span style="color: #00ffff;">.set</span> stdout,1
<span style="color: #00ffff;">.set</span> stderr,2

<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"SYS_EXIT"</span>,8,,SYS_EXIT,sys_exit
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"SYS_OPEN"</span>,8,,SYS_OPEN,sys_open
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"SYS_CLOSE"</span>,9,,SYS_CLOSE,sys_close
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"SYS_READ"</span>,8,,SYS_READ,sys_read
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"SYS_WRITE"</span>,9,,SYS_WRITE,sys_write
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"SYS_CREAT"</span>,9,,SYS_CREAT,sys_creat

<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_RDONLY"</span>,8,,__O_RDONLY,0
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_WRONLY"</span>,8,,__O_WRONLY,1
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_RDWR"</span>,6,,__O_RDWR,2
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_CREAT"</span>,7,,__O_CREAT,0100
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_EXCL"</span>,6,,__O_EXCL,0200
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_TRUNC"</span>,7,,__O_TRUNC,01000
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_APPEND"</span>,8,,__O_APPEND,02000
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_NONBLOCK"</span>,10,,__O_NONBLOCK,04000

<span style="color: #00ffff;">.set</span> wordsize,4
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"WORDSIZE"</span>,8,,WORDSIZE,wordsize
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-15" class="outline-3">
<h3 id="unnumbered-15">Стек возвратов</h3>
<div class="outline-text-3" id="text-unnumbered-15">
<p>
Эти слова позволяют получить доступ к стеку возвратов. Напомним, что регистр <code>%ebp</code>
всегда указывает на вершину стека возвратов.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="words_for_retstack"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"&gt;R"</span>,2,,TOR
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>            # pop &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1074; <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">PUSHRSP</span> <span style="color: #eedd82;">%eax</span>            # push <span style="color: #eedd82;">%eax</span> &#1085;&#1072; &#1089;&#1090;&#1077;&#1082; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"R&gt;"</span>,2,,FROMR
    <span style="color: #00ffff;">POPRSP</span>  <span style="color: #eedd82;">%eax</span>            # pop &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074; &#1074; <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>            # push <span style="color: #eedd82;">%eax</span> &#1085;&#1072; &#1089;&#1090;&#1077;&#1082; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;&#1086;&#1074;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"RSP@"</span>,4,,RSPFETCH
    <span style="color: #00ffff;">pushl</span>    <span style="color: #eedd82;">%ebp</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"RSP!"</span>,4,,RSPSTORE
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%ebp</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"RDROP"</span>,5,,RDROP
    <span style="color: #00ffff;">addl</span>    $4, <span style="color: #eedd82;">%ebp</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-16" class="outline-3">
<h3 id="unnumbered-16">Стек данных</h3>
<div class="outline-text-3" id="text-unnumbered-16">
<p>
Эти функции позволяют вам управлять стеком параметров. Напомним, что Linux
устанавливает для нас стек параметров, и он доступен через регистр <code>%esp</code>.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="data_stack_words"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"DSP@"</span>,4,,DSPFETCH
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%esp</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"DSP!"</span>,4,,DSPSTORE
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%esp</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-17" class="outline-3">
<h3 id="unnumbered-17">Ввод и вывод: KEY EMIT WORD NUMBER</h3>
<div class="outline-text-3" id="text-unnumbered-17">
<p>
Это наши первые действительно сложные примитивы Forth. Я решил написать их на
ассемблере, но удивительно, что в реальных реализациях Forth они часто пишутся в
терминах более фундаментальных примитивов Forth.
</p>

<p>
Я решил избежать этого, потому что я думаю, что это просто скрывает реализацию. В конце
концов, вы не можете не понимать ассемблер, ведь ассемблер понять могут не только лишь
все, мало кто может это сделать (см. <a href="http://absurdopedia.net/wiki/%D0%9A%D0%BB%D0%B8%D1%87%D0%BA%D0%BE%D1%81%D0%BE%D1%84%D0%B8%D1%8F">переполнение разрядной сетки</a>)
</p>

<p>
Давайте сначала обсудим ввод.
</p>

<p>
Слово KEY считывает следующий байт из stdin (и push-ит его на стек
параметров). Поэтому, если KEY вызывается, и кто-то нажимает на клавишу пробела, то
число 32 (ASCII-код пробела) помещается в стек.
</p>

<p>
В Forth нет различий между чтением кода и чтением ввода. Мы могли бы читать и
компилировать код, мы могли бы читать слова для выполнения, мы могли бы попросить
пользователя набрать свое имя - в конечном итоге все это происходит через KEY.
</p>

<p>
Реализация KEY использует входной буфер определенного размера (определенный в конце
этого файла). KEY вызывает системный вызов Linux <code>read(2)</code> для заполнения этого буфера,
отслеживая положение данных в буфере с помощью пары переменных. Когда заканчивается
входной буфер, KEY автоматически заполняет его. Если KEY обнаруживает, что <code>stdin</code>
закрыт, он выходит из программы, поэтому, когда вы нажимаете <code>^D</code>, система Forth
завершается.
</p>



<div class="figure">
<p><img src="../../../img/forth-interpret-14.png" alt="forth-interpret-14.png">
</p>
</div>

<div class="org-src-container">

<pre class="src src-asm" id="word_key">    <span style="color: #00ffff;">defcode</span> <span style="color: #ffa07a;">"KEY"</span>,3,,KEY
    <span style="color: #00ffff;">call</span> _KEY
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>            #       # push-&#1080;&#1084; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1077;&#1085;&#1085;&#1099;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; &#1085;&#1072; &#1089;&#1090;&#1077;&#1082;
    <span style="color: #00ffff;">NEXT</span>                    #
<span style="color: #87cefa;">_KEY</span>:                       # &lt;--+
    <span style="color: #00ffff;">mov</span>     (currkey), <span style="color: #eedd82;">%ebx</span> #    |  # &#1041;&#1077;&#1088;&#1077;&#1084; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; currkey &#1074; <span style="color: #eedd82;">%ebx</span>
    <span style="color: #00ffff;">cmp</span>     (bufftop), <span style="color: #eedd82;">%ebx</span> #    |  # (bufftop &gt;= currkey)? - &#1074; &#1073;&#1091;&#1092;&#1077;&#1088;&#1077; &#1077;&#1089;&#1090;&#1100; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1099;?
    <span style="color: #00ffff;">jge</span>     1f              #-+  |  # ?-&#1053;&#1077;&#1090;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074;&#1087;&#1077;&#1088;&#1077;&#1076;
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>      # |  |  # ?-&#1044;&#1072;,  (1) &#1087;&#1077;&#1088;&#1077;&#1085;&#1086;&#1089;&#1080;&#1084; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;, &#1085;&#1072; &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1081;
    <span style="color: #00ffff;">mov</span>     (<span style="color: #eedd82;">%ebx</span>), <span style="color: #eedd82;">%al</span>     # |  |  #        &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; currkey &#1074; <span style="color: #eedd82;">%eax</span>,
    <span style="color: #00ffff;">inc</span>     <span style="color: #eedd82;">%ebx</span>            # |  |  #        (2) &#1080;&#1085;&#1082;&#1088;&#1077;&#1084;&#1077;&#1085;&#1090;&#1080;&#1088;&#1091;&#1077;&#1084; &#1082;&#1086;&#1087;&#1080;&#1102; currkey
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%ebx</span>, (currkey) # |  |  #        (3) &#1079;&#1072;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1077;&#1084; &#1077;&#1077; &#1074; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1091;&#1102; currkey,
    <span style="color: #00ffff;">ret</span>                     # |  |  #        &#1080; &#1074;&#1099;&#1093;&#1086;&#1076;&#1080;&#1084; (&#1074; <span style="color: #eedd82;">%eax</span> &#1083;&#1077;&#1078;&#1080;&#1090; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;)
    # ---------------- RET    |  |
<span style="color: #87cefa;">1</span>:  #                     &lt;---+  |  # &#1041;&#1091;&#1092;&#1077;&#1088; &#1074;&#1074;&#1086;&#1076;&#1072; &#1087;&#1091;&#1089;&#1090;, &#1089;&#1076;&#1077;&#1083;&#1072;&#1077;&#1084; read &#1080;&#1079; stdin
    <span style="color: #00ffff;">mov</span>     $sys_read, <span style="color: #eedd82;">%eax</span> #    |  # param1: SYSCALL #3 (read)
    <span style="color: #00ffff;">mov</span>     $stdin, <span style="color: #eedd82;">%ebx</span>    #    |  # param2: &#1044;&#1077;&#1089;&#1082;&#1088;&#1080;&#1087;&#1090;&#1086;&#1088; #2 (stdin)
    <span style="color: #00ffff;">mov</span>     $input_buffer, <span style="color: #eedd82;">%ecx</span> #|  # param3: &#1050;&#1083;&#1072;&#1076;&#1077;&#1084; &#1072;&#1076;&#1088;&#1077;&#1089; &#1073;&#1091;&#1092;&#1077;&#1088;&#1072; &#1074;&#1074;&#1086;&#1076;&#1072; &#1074; <span style="color: #eedd82;">%ecx</span>
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%ecx</span>, currkey   #    |  # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1077;&#1084; &#1072;&#1076;&#1088;&#1077;&#1089; &#1073;&#1091;&#1092;&#1077;&#1088;&#1072; &#1074;&#1074;&#1086;&#1076;&#1072; &#1074; currkey
    <span style="color: #00ffff;">mov</span>     $INPUT_BUFFER_SIZE, <span style="color: #eedd82;">%edx</span> # &#1052;&#1072;&#1082;&#1089;&#1080;&#1084;&#1072;&#1083;&#1100;&#1085;&#1072;&#1103; &#1076;&#1083;&#1080;&#1085;&#1072; &#1074;&#1074;&#1086;&#1076;&#1072;
    <span style="color: #00ffff;">int</span>     $0x80           #    |  # SYSCALL
    # &#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1103;&#1077;&#1084; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1077;&#1085;&#1085;&#1086;&#1077;     |  # &#1076;&#1086;&#1083;&#1078;&#1085;&#1086; &#1073;&#1099;&#1090;&#1100; &#1082;&#1086;&#1083;&#1080;&#1095;&#1077;&#1089;&#1090;&#1074;&#1086; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074; + '\n'
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>      #    |  # (<span style="color: #eedd82;">%eax</span> &lt;= 0)?
    <span style="color: #00ffff;">jbe</span>     2f              #-+  |  # ?-&#1044;&#1072;, &#1101;&#1090;&#1086; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074;&#1087;&#1077;&#1088;&#1077;&#1076;
    <span style="color: #00ffff;">addl</span>    <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%ecx</span>      # |  |  # ?-&#1053;&#1077;&#1090;, (1) &#1076;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; &#1074; <span style="color: #eedd82;">%ecx</span> &#1082;&#1086;&#1083;-&#1074;&#1086; &#1087;&#1088;&#1086;&#1095;&#1080;&#1090;&#1072;&#1085;&#1085;&#1099;&#1093; &#1073;&#1072;&#1081;&#1090;
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%ecx</span>, (bufftop) # |  |  #        (2) &#1079;&#1072;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1077;&#1084; <span style="color: #eedd82;">%ecx</span> &#1074; bufftop
    <span style="color: #00ffff;">jmp</span>     _KEY            # |  |
    # ------------------------|--+
<span style="color: #87cefa;">2</span>:  #                     &lt;---+     # &#1054;&#1096;&#1080;&#1073;&#1082;&#1072; &#1080;&#1083;&#1080; &#1082;&#1086;&#1085;&#1077;&#1094; &#1087;&#1086;&#1090;&#1086;&#1082;&#1072; &#1074;&#1074;&#1086;&#1076;&#1072; - &#1074;&#1099;&#1093;&#1086;&#1076;&#1080;&#1084;
    <span style="color: #00ffff;">mov</span>     $sys_exit, <span style="color: #eedd82;">%eax</span>         # param1: SYSCALL #1 (exit)
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%ebx</span>, <span style="color: #eedd82;">%ebx</span>              # param2: &#1082;&#1086;&#1076; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1072;
    <span style="color: #00ffff;">int</span>     $0x80                   # SYSCALL
    # --------------- EXIT
    <span style="color: #00ffff;">.data</span>
    <span style="color: #00ffff;">.align</span> 4
<span style="color: #87cefa;">currkey</span>:
    # &#1061;&#1088;&#1072;&#1085;&#1080;&#1090; &#1089;&#1084;&#1077;&#1097;&#1077;&#1085;&#1080;&#1077; &#1085;&#1072; &#1090;&#1077;&#1082;&#1091;&#1097;&#1077;&#1077; &#1087;&#1086;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1077; &#1074; &#1073;&#1091;&#1092;&#1077;&#1088;&#1077; &#1074;&#1074;&#1086;&#1076;&#1072; (&#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1080;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; &#1073;&#1091;&#1076;&#1077;&#1090; &#1087;&#1088;&#1086;&#1095;&#1080;&#1090;&#1072;&#1085; &#1087;&#1086; &#1085;&#1077;&#1084;&#1091;)
    <span style="color: #00ffff;">.int</span> input_buffer
<span style="color: #87cefa;">bufftop</span>:
    # &#1061;&#1088;&#1072;&#1085;&#1080;&#1090; &#1074;&#1077;&#1088;&#1096;&#1080;&#1085;&#1091; &#1073;&#1091;&#1092;&#1077;&#1088;&#1072; &#1074;&#1074;&#1086;&#1076;&#1072; (&#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1080;&#1077; &#1074;&#1072;&#1083;&#1080;&#1076;&#1085;&#1099;&#1077; &#1076;&#1072;&#1085;&#1085;&#1099;&#1077; + 1)
    <span style="color: #00ffff;">.int</span> input_buffer
</pre>
</div>

<p>
Вывод намного проще. Слово EMIT выводит один байт в stdout. Эта реализация просто
использует системный вызов <code>write</code>. Никакой попытки сделать буфер не производится, но
было бы хорошим упражнением добавить его.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_emit"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"EMIT"</span>,4,,EMIT
    <span style="color: #00ffff;">popl</span>    <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">call</span>    _EMIT
    <span style="color: #00ffff;">NEXT</span>
<span style="color: #87cefa;">_EMIT</span>:
    <span style="color: #00ffff;">movl</span>    $stdout, <span style="color: #eedd82;">%ebx</span>            # param1: stdout
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%al</span>, emit_scratch   # &#1073;&#1077;&#1088;&#1077;&#1084; &#1073;&#1072;&#1081;&#1090; &#1080; &#1079;&#1072;&#1085;&#1086;&#1089;&#1080;&#1084; &#1077;&#1075;&#1086; &#1074; emit_scratch
    <span style="color: #00ffff;">mov</span>     $emit_scratch, <span style="color: #eedd82;">%ecx</span> # param2: &#1072;&#1076;&#1088;&#1077;&#1089; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1084;&#1086;&#1075;&#1086; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103;
    <span style="color: #00ffff;">mov</span>     $1, <span style="color: #eedd82;">%edx</span>            # param3: &#1076;&#1083;&#1080;&#1085;&#1072;
    <span style="color: #00ffff;">mov</span>     $sys_write, <span style="color: #eedd82;">%eax</span>    # SYSCALL #4 (write)
    <span style="color: #00ffff;">int</span>     $0x80
    <span style="color: #00ffff;">ret</span>

    <span style="color: #00ffff;">.data</span>           # NB: &#1087;&#1088;&#1086;&#1097;&#1077; &#1079;&#1072;&#1087;&#1080;&#1089;&#1072;&#1090;&#1100; &#1074; .data section
<span style="color: #87cefa;">emit_scratch</span>:
    <span style="color: #00ffff;">.space</span> 1        # &#1052;&#1077;&#1089;&#1090;&#1086; &#1076;&#1083;&#1103; &#1073;&#1072;&#1081;&#1090;&#1072;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1081; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1090; EMIT
</pre>
</div>

<p>
Вернемся к вводу. WORD - это слово , которое читает следующее полное слово со
стандартного ввода. Если подробнее, оно сначала пропускает любые пробельные символы
(пробелы, табуляции, символы новой строки и.т.д.). Затем оно вызывает KEY, чтобы читать
символы в буфере ввода, пока не наткнется на пробел. Затем оно вычисляет длину
прочитанного слова и возвращает адрес и длину как два слова в стеке (при этом длина
сверху).
</p>

<p>
Обратите внимание, что WORD имеет единственный внутренний буфер, который он
перезаписывает каждый раз (как статическая строка в Си). Это, фактически означает, что
вы не можете использовать в интерактивном режиме что-то вроде:
</p>

<div class="org-src-container">

<pre class="src src-forth">WORD FOO FIND
</pre>
</div>

<p>
чтобы получить адрес слова FOO, потому что INTERPRET также использует WORD, и поэтому
внутренний буфер <code>word_buffer</code> будет перезаписан словом FIND, которое интерпретатор
считает следующим. Вместо этого, необходимо определить слово, например так:
</p>

<div class="org-src-container">

<pre class="src src-forth">: GETADDR WORD FIND <span style="color: #00ffff;">;</span>
</pre>
</div>

<p>
В этом случае, когда между исполнением WORD и FIND не будет никакого иного кода,
который мог бы перезаписать <code>word-buffer</code>.
</p>

<p>
Также обратите внимание, что внутренний буфер WORD составляет всего 32 байта, и нет
никакой проверки на переполнение. 31 байт - это максимальная длина слова Forth, которую
мы поддерживаем, и это то, для чего WORD и используется: чтения слов Forth при
компиляции и выполнении кода. Возвращенные строки НЕ заканчиваются NULL.
</p>

<p>
Начальный адрес и длина строки - это обычный способ представления строк в Forth (не
заканчивающийся символом ASCII NULL, как в C), и поэтому строки Forth могут содержать
любой символ, включая NUL, и могут быть любой длины.
</p>

<p>
WORD не подходит для простого считывания строк (например, пользовательского ввода)
из-за всех вышеперечисленных особенностей и ограничений.
</p>

<p>
Обратите внимание, что при выполнении в немедленном режиме вы увидите:
</p>

<div class="org-src-container">

<pre class="src src-forth">WORD FOO
</pre>
</div>

<p>
который помещает <code>FOO</code> и длину <code>3</code> в стек, но при компиляции:
</p>

<div class="org-src-container">

<pre class="src src-forth">: BAR WORD FOO <span style="color: #00ffff;">;</span>
</pre>
</div>

<p>
будет ошибка (или, по крайней мере, неожиданное поведение). Позже мы поговорим о
компиляции и про <code>режим немедленного исполнения</code>, и вы поймете, почему.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_word">    <span style="color: #00ffff;">defcode</span> <span style="color: #ffa07a;">"WORD"</span>,4,,WORD
    <span style="color: #00ffff;">call</span>    _WORD
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%edi</span>            # push base address
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%ecx</span>            # push length
    <span style="color: #00ffff;">NEXT</span>
<span style="color: #87cefa;">_WORD</span>:
    # &#1048;&#1097;&#1077;&#1084; &#1087;&#1077;&#1088;&#1074;&#1099;&#1081; &#1085;&#1077;&#1087;&#1088;&#1086;&#1073;&#1077;&#1083;&#1100;&#1085;&#1099;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;, &#1087;&#1088;&#1086;&#1087;&#1091;&#1089;&#1082;&#1072;&#1103; &#1082;&#1086;&#1084;&#1084;&#1077;&#1085;&#1090;&#1099;, &#1085;&#1072;&#1095;&#1080;&#1085;&#1072;&#1102;&#1097;&#1080;&#1077;&#1089;&#1103; &#1089; &#1086;&#1073;&#1088;&#1072;&#1090;&#1085;&#1086;&#1075;&#1086; &#1089;&#1083;&#1101;&#1096;&#1072;
<span style="color: #87cefa;">1</span>:                      # &lt;---+
    <span style="color: #00ffff;">call</span>    _KEY            # |     # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1091;&#1102; &#1073;&#1091;&#1082;&#1074;&#1091;, &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;&#1091;&#1102; &#1074; <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">cmpb</span>    $'\\', <span style="color: #eedd82;">%al</span>      # |     # (&#1069;&#1090;&#1086; &#1085;&#1072;&#1095;&#1072;&#1083;&#1086; &#1082;&#1086;&#1084;&#1084;&#1077;&#1085;&#1090;&#1072;&#1088;&#1080;&#1103;)?
    <span style="color: #00ffff;">je</span>      3f              #-|---+ # ?-&#1044;&#1072;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074;&#1087;&#1077;&#1088;&#1077;&#1076;
    <span style="color: #00ffff;">cmpb</span>    $' ', <span style="color: #eedd82;">%al</span>       # |   | # ?-&#1053;&#1077;&#1090;. (&#1069;&#1090;&#1086; &#1087;&#1088;&#1086;&#1073;&#1077;&#1083;, &#1074;&#1086;&#1079;&#1088;&#1072;&#1090; &#1082;&#1072;&#1088;&#1077;&#1090;&#1082;&#1080;, &#1087;&#1077;&#1088;&#1077;&#1074;&#1086;&#1076; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;)?
    <span style="color: #00ffff;">jbe</span>     1b              #-+   | # ?-&#1044;&#1072;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1085;&#1072;&#1079;&#1072;&#1076;
    #                             |
    # &#1048;&#1097;&#1077;&#1084; &#1082;&#1086;&#1085;&#1077;&#1094; &#1089;&#1083;&#1086;&#1074;&#1072;, &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1103; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1099; &#1087;&#1086; &#1084;&#1077;&#1088;&#1077; &#1087;&#1088;&#1086;&#1076;&#1074;&#1080;&#1078;&#1077;&#1085;&#1080;&#1103;
    <span style="color: #00ffff;">mov</span>     $word_buffer, <span style="color: #eedd82;">%edi</span>  # | # &#1059;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;&#1099;&#1081; &#1073;&#1091;&#1092;&#1077;&#1088;
<span style="color: #87cefa;">2</span>:                      # &lt;---+   |
    <span style="color: #00ffff;">stosb</span>                   # |   | # &#1044;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; &#1074; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;&#1099;&#1081; &#1073;&#1091;&#1092;&#1077;&#1088;
    <span style="color: #00ffff;">call</span>    _KEY            # |   | # &#1042;&#1099;&#1079;&#1099;&#1074;&#1072;&#1077;&#1084; KEY &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; &#1073;&#1091;&#1076;&#1077;&#1090; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1077;&#1085; &#1074; <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">cmpb</span>    $' ', <span style="color: #eedd82;">%al</span>       # |   | # (&#1069;&#1090;&#1086; &#1087;&#1088;&#1086;&#1073;&#1077;&#1083;, &#1074;&#1086;&#1079;&#1088;&#1072;&#1090; &#1082;&#1072;&#1088;&#1077;&#1090;&#1082;&#1080;, &#1087;&#1077;&#1088;&#1077;&#1074;&#1086;&#1076; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;)?
    <span style="color: #00ffff;">ja</span>      2b              #-+   | # &#1045;&#1089;&#1083;&#1080; &#1085;&#1077;&#1090;, &#1087;&#1086;&#1074;&#1090;&#1086;&#1088;&#1080;&#1084;
    #                       #     |
    # &#1042;&#1077;&#1088;&#1085;&#1077;&#1084; &#1089;&#1083;&#1086;&#1074;&#1086; (&#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1089;&#1090;&#1072;&#1090;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1073;&#1091;&#1092;&#1077;&#1088; &#1095;&#1077;&#1088;&#1077;&#1093; <span style="color: #eedd82;">%ecx</span>) &#1080; &#1077;&#1075;&#1086; &#1076;&#1083;&#1080;&#1085;&#1091; (&#1095;&#1077;&#1088;&#1077;&#1079; <span style="color: #eedd82;">%edi</span>)
    <span style="color: #00ffff;">sub</span>     $word_buffer, <span style="color: #eedd82;">%edi</span>  # |
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%edi</span>, <span style="color: #eedd82;">%ecx</span>      #     | # return: &#1076;&#1083;&#1080;&#1085;&#1072; &#1089;&#1083;&#1086;&#1074;&#1072;
    <span style="color: #00ffff;">mov</span>     $word_buffer, <span style="color: #eedd82;">%edi</span>  # | # return: &#1072;&#1076;&#1088;&#1077;&#1089; &#1073;&#1091;&#1092;&#1077;&#1088;&#1072;
    <span style="color: #00ffff;">ret</span>                     #     |
    # ----------------- RET       |
    #                             |
    # &#1069;&#1090;&#1086; &#1082;&#1086;&#1084;&#1084;&#1077;&#1085;&#1090;&#1072;&#1088;&#1080;&#1081;, &#1087;&#1088;&#1086;&#1087;&#1091;&#1089;&#1082;&#1072;&#1077;&#1084; | &#1077;&#1075;&#1086; &#1076;&#1086; &#1082;&#1086;&#1085;&#1094;&#1072; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
<span style="color: #87cefa;">3</span>:                      # &lt;---+ &lt;-+
    <span style="color: #00ffff;">call</span>    _KEY            # |
    <span style="color: #00ffff;">cmpb</span>    $'\n', <span style="color: #eedd82;">%al</span>      # |     # KEY &#1074;&#1077;&#1088;&#1085;&#1091;&#1083; &#1082;&#1086;&#1085;&#1077;&#1094; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;?
    <span style="color: #00ffff;">jne</span>     3b              #-+     # &#1053;&#1077;&#1090;, &#1087;&#1086;&#1074;&#1090;&#1086;&#1088;&#1080;&#1084;
    <span style="color: #00ffff;">jmp</span>     1b              #
    # ---------------- to 1

    <span style="color: #00ffff;">.data</span>
    # &#1057;&#1090;&#1072;&#1090;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1073;&#1091;&#1092;&#1077;&#1088;, &#1074; &#1082;&#1086;&#1090;&#1086;&#1088;&#1086;&#1084; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090;&#1089;&#1103; WORD.
    # &#1055;&#1086;&#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1080;&#1077; &#1074;&#1099;&#1079;&#1086;&#1074;&#1099; &#1087;&#1077;&#1088;&#1077;&#1079;&#1072;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1102;&#1090; &#1101;&#1090;&#1086;&#1090; &#1073;&#1091;&#1092;&#1077;&#1088;.
    # &#1052;&#1072;&#1082;&#1089;&#1080;&#1084;&#1072;&#1083;&#1100;&#1085;&#1072;&#1103; &#1076;&#1083;&#1080;&#1085;&#1072; &#1089;&#1083;&#1086;&#1074;&#1072; - 32 &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1072;.
<span style="color: #87cefa;">word_buffer</span>:
    <span style="color: #00ffff;">.space</span> 32
</pre>
</div>

<p>
Помимо чтения слов, нам нужно будет читать цифры, и для этого мы используем функцию
NUMBER. Она анализирует числовую строку, например, возвращаемую WORD, и push-ит число в
стек.
</p>

<p>
эта функция использует переменную BASE в качестве базы (radix) для преобразования,
поэтому, например, если BASE равна 2, мы ожидаем двоичное число. Обычно BASE составляет
<code>10</code>
</p>

<p>
Если слово начинается с символа '-', тогда возвращаемое значение отрицательно.
</p>

<p>
Если строка не может быть проанализирована как число (или содержит символы за пределами
текущей BASE), тогда нам нужно вернуть индикацию ошибки. Таким образом, NUMBER
фактически возвращает два элемента в стеке. В верхней части стека он возвращает
количество неразобранных символов (т.е. если 0, то все символы были разобраны, поэтому
нет ошибки). Второй элемент от вершины стека - это распарсенное число (или частичное
значение, если произошла ошибка).
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_number"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"NUMBER"</span>,6,,NUMBER
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%ecx</span>            # length of string
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%edi</span>            # start address of string
    <span style="color: #00ffff;">call</span>    _NUMBER
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>            # parsed number
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%ecx</span>            # number of unparsed characters (0 = no error)
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">_NUMBER</span>:
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%ebx</span>, <span style="color: #eedd82;">%ebx</span>
    # &#1055;&#1086;&#1087;&#1099;&#1090;&#1082;&#1072; &#1088;&#1072;&#1089;&#1087;&#1072;&#1088;&#1089;&#1080;&#1090;&#1100; &#1087;&#1091;&#1089;&#1090;&#1091;&#1102; &#1089;&#1090;&#1088;&#1086;&#1082;&#1091; &#1101;&#1090;&#1086; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072; &#1085;&#1086; &#1084;&#1099; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084; 0
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%ecx</span>, <span style="color: #eedd82;">%ecx</span>
    <span style="color: #00ffff;">jz</span>  5f                  #-&gt; RET #
    # &#1057;&#1090;&#1088;&#1086;&#1082;&#1072; &#1085;&#1077; &#1087;&#1091;&#1089;&#1090;&#1072;, &#1073;&#1091;&#1076;&#1077;&#1084; &#1088;&#1072;&#1079;&#1073;&#1080;&#1088;&#1072;&#1090;&#1100;
    <span style="color: #00ffff;">movl</span>    (var_BASE), <span style="color: #eedd82;">%edx</span>#       # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; BASE &#1074; <span style="color: #eedd82;">%dl</span>
    # &#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1080;&#1084;, &#1084;&#1086;&#1078;&#1077;&#1090; &#1073;&#1099;&#1090;&#1100; &#1087;&#1077;&#1088;&#1074;&#1099;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; '-'?
    <span style="color: #00ffff;">movb</span>    (<span style="color: #eedd82;">%edi</span>), <span style="color: #eedd82;">%bl</span>     #       # <span style="color: #eedd82;">%bl</span> = &#1087;&#1077;&#1088;&#1074;&#1099;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">inc</span>     <span style="color: #eedd82;">%edi</span>            #       #
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>            #       # push 0 &#1074; &#1089;&#1090;&#1077;&#1082;
    <span style="color: #00ffff;">cmpb</span>    $'-', <span style="color: #eedd82;">%bl</span>       #       # (&#1054;&#1090;&#1088;&#1080;&#1094;&#1072;&#1090;&#1077;&#1083;&#1100;&#1085;&#1086;&#1077; &#1095;&#1080;&#1089;&#1083;&#1086;)?
    <span style="color: #00ffff;">jnz</span> 2f                  #-+     # ?-&#1053;&#1077;&#1090;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1082; &#1082;&#1086;&#1085;&#1074;&#1077;&#1088;&#1090;&#1072;&#1094;&#1080;&#1080; (2)
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%eax</span>            # |     # ?-&#1044;&#1072;, &#1079;&#1072;&#1073;&#1077;&#1088;&#1077;&#1084; &#1086;&#1073;&#1088;&#1072;&#1090;&#1085;&#1086; 0 &#1080;&#1079; &#1089;&#1090;&#1077;&#1082;&#1072;,
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%ebx</span>            # |     #       push &#1085;&#1077; &#1085;&#1086;&#1083;&#1100; &#1074; &#1089;&#1090;&#1077;&#1082;, &#1082;&#1072;&#1082; &#1080;&#1085;&#1076;&#1080;&#1082;&#1072;&#1090;&#1086;&#1088; &#1086;&#1090;&#1088;&#1080;&#1094;&#1072;&#1090;&#1077;&#1083;&#1100;&#1085;&#1086;&#1075;&#1086;
    <span style="color: #00ffff;">dec</span>     <span style="color: #eedd82;">%ecx</span>            # |     #       &#1091;&#1084;&#1077;&#1085;&#1100;&#1096;&#1080;&#1084; &#1089;&#1095;&#1077;&#1090;&#1095;&#1080;&#1082; &#1086;&#1089;&#1090;&#1072;&#1074;&#1096;&#1080;&#1093;&#1089;&#1103; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074;
    <span style="color: #00ffff;">jnz</span> 1f                  #-----+ #       (&#1057;&#1090;&#1088;&#1086;&#1082;&#1072; &#1079;&#1072;&#1082;&#1086;&#1085;&#1095;&#1080;&#1083;&#1072;&#1089;&#1100;)? ?-&#1053;&#1077;&#1090;: &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076; &#1085;&#1072; (1)
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%ebx</span>            # |   | #       ?-&#1044;&#1072; - &#1101;&#1090;&#1086; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072;, &#1089;&#1090;&#1088;&#1086;&#1082;&#1072; <span style="color: #ffa07a;">"-"</span>. &#1047;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1080;&#1079; &#1089;&#1090;&#1077;&#1082;&#1072;
    <span style="color: #00ffff;">movl</span>    $1, <span style="color: #eedd82;">%ecx</span>        # |   | #            &#1087;&#1086;&#1084;&#1077;&#1097;&#1072;&#1077;&#1084; &#1074; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;&#1091;&#1102; &#1085;&#1077;&#1088;&#1072;&#1089;&#1087;&#1072;&#1088;&#1089;&#1077;&#1085;&#1085;&#1091;&#1102; &#1076;&#1083;&#1080;&#1085;&#1091;
    <span style="color: #00ffff;">ret</span>                     # |   | #            &#1077;&#1076;&#1080;&#1085;&#1080;&#1094;&#1091; &#1080; &#1074;&#1099;&#1093;&#1086;&#1076;&#1080;&#1084;.
    # --------------------- # |   | # -------------------------------------------------------
    # &#1062;&#1080;&#1082;&#1083; &#1095;&#1090;&#1077;&#1085;&#1080;&#1103; &#1095;&#1080;&#1089;&#1077;&#1083;     # |   | #
<span style="color: #87cefa;">1</span>:  #                    &lt;========+ #
    <span style="color: #00ffff;">imull</span>   <span style="color: #eedd82;">%edx</span>, <span style="color: #eedd82;">%eax</span>      # |   | # <span style="color: #eedd82;">%eax</span> *= BASE
    <span style="color: #00ffff;">movb</span>    (<span style="color: #eedd82;">%edi</span>), <span style="color: #eedd82;">%bl</span>     # |   | # <span style="color: #eedd82;">%bl</span> = &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1080;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; &#1074; &#1089;&#1090;&#1088;&#1086;&#1082;&#1077;
    <span style="color: #00ffff;">inc</span>     <span style="color: #eedd82;">%edi</span>            # |   | # &#1059;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1074;&#1072;&#1077;&#1084; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100;
<span style="color: #87cefa;">2</span>:  #                    &lt;----+   | #
    # &#1055;&#1088;&#1077;&#1086;&#1073;&#1088;&#1072;&#1079;&#1091;&#1077;&#1084; 0-9, A-Z &#1074; &#1095;&#1080;&#1089;&#1083;&#1072; 0-35.
    <span style="color: #00ffff;">subb</span>    $'0', <span style="color: #eedd82;">%bl</span>       #     | # (&lt; '0')?
    <span style="color: #00ffff;">jb</span>  4f                  #---+ | # ?-&#1044;&#1072;, &#1093;&#1077;&#1088;&#1085;&#1103; &#1082;&#1072;&#1082;&#1072;&#1103;-&#1090;&#1086;, &#1072; &#1085;&#1077; &#1094;&#1080;&#1092;&#1088;&#1072;, &#1086;&#1096;&#1080;&#1073;&#1082;&#1072;, &#1080;&#1076;&#1077;&#1084; &#1085;&#1072; (4)
    <span style="color: #00ffff;">cmp</span>     $10, <span style="color: #eedd82;">%bl</span>        #   | | # ?-&#1053;&#1077;&#1090;, (&lt;= '9')?
    <span style="color: #00ffff;">jb</span>  3f                  #-+ | | #        ?-&#1044;&#1072;, &#1080;&#1076;&#1077;&#1084; &#1085;&#1072; (3), &#1101;&#1090;&#1086; &#1095;&#1080;&#1089;&#1083;&#1086; &#1084;&#1077;&#1078;&#1076;&#1091; 0 &#1080; 9
    <span style="color: #00ffff;">subb</span>    $17, <span style="color: #eedd82;">%bl</span>        # | | | #        ?-&#1053;&#1077;&#1090;, (&lt; 'A')? &#1087;&#1086;&#1090;&#1086;&#1084;&#1091; &#1095;&#1090;&#1086; (17 = 'A'-'0')
    <span style="color: #00ffff;">jb</span>  4f                  #---+ | #               ?-&#1044;&#1072;, &#1101;&#1090;&#1086; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072;, &#1080;&#1076;&#1077;&#1084; &#1085;&#1072; (4)
    <span style="color: #00ffff;">addb</span>    $10, <span style="color: #eedd82;">%bl</span>        # | | | #               ?-&#1053;&#1077;&#1090;, &#1076;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; &#1082; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1102; 10
<span style="color: #87cefa;">3</span>:  #                     &lt;---+ | | #
    <span style="color: #00ffff;">cmp</span>     <span style="color: #eedd82;">%dl</span>, <span style="color: #eedd82;">%bl</span>        #   | | #                      (RESULT &gt;= BASE)?
    <span style="color: #00ffff;">jge</span> 4f                  #---+ | #                      ?-&#1044;&#1072;, &#1087;&#1077;&#1088;&#1077;&#1073;&#1086;&#1088;, &#1080;&#1076;&#1077;&#1084; &#1085;&#1072; (4)
    <span style="color: #00ffff;">add</span>     <span style="color: #eedd82;">%ebx</span>, <span style="color: #eedd82;">%eax</span>      #   | | #                      ?-&#1053;&#1077;&#1090;, &#1074;&#1089;&#1077; &#1074; &#1087;&#1086;&#1088;&#1103;&#1076;&#1082;&#1077;. &#1044;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084;
    <span style="color: #00ffff;">dec</span>     <span style="color: #eedd82;">%ecx</span>            #   | | #                        RESULT &#1082; <span style="color: #eedd82;">%eax</span> &#1080; LOOP-&#1080;&#1084; &#1076;&#1072;&#1083;&#1100;&#1096;&#1077;.
    <span style="color: #00ffff;">jnz</span> 1b                  #---|-+ #
<span style="color: #87cefa;">4</span>:  #                     &lt;-----+   #
    # &#1058;&#1091;&#1090; &#1084;&#1099; &#1086;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1084;&#1089;&#1103; &#1077;&#1089;&#1083;&#1080; &#1094;&#1080;&#1082;&#1083; &#1079;&#1072;&#1082;&#1086;&#1085;&#1095;&#1080;&#1083;&#1089;&#1103; - &#1090;&#1086;&#1075;&#1076;&#1072; &#1091; &#1085;&#1072;&#1089; <span style="color: #eedd82;">%ecx</span>=0
    # &#1042; &#1080;&#1085;&#1086;&#1084; &#1089;&#1083;&#1091;&#1095;&#1072;&#1077; <span style="color: #eedd82;">%ecx</span> &#1089;&#1086;&#1076;&#1077;&#1088;&#1078;&#1080;&#1090; &#1082;&#1086;&#1083;&#1080;&#1095;&#1077;&#1089;&#1090;&#1074;&#1086; &#1085;&#1077;&#1088;&#1072;&#1089;&#1087;&#1072;&#1088;&#1089;&#1077;&#1085;&#1085;&#1099;&#1093; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074;
    # &#1045;&#1089;&#1083;&#1080; &#1091; &#1085;&#1072;&#1089; &#1086;&#1090;&#1088;&#1080;&#1094;&#1072;&#1090;&#1077;&#1083;&#1100;&#1085;&#1099;&#1081; &#1088;&#1077;&#1079;&#1091;&#1083;&#1100;&#1090;&#1072;&#1090;, &#1090;&#1086; &#1087;&#1077;&#1088;&#1074;&#1099;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; '-' (&#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1077;&#1085; &#1074; &#1089;&#1090;&#1077;&#1082;&#1077;)
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%ebx</span>            #       #
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%ebx</span>, <span style="color: #eedd82;">%ebx</span>      #       # (&#1054;&#1090;&#1088;&#1080;&#1094;&#1072;&#1090;&#1077;&#1083;&#1100;&#1085;&#1086;&#1077; &#1095;&#1080;&#1089;&#1083;&#1086;)?
    <span style="color: #00ffff;">jz</span>  5f                  #-+     # ?-&#1053;&#1077;&#1090;, &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084; &#1082;&#1072;&#1082; &#1077;&#1089;&#1090;&#1100; (5)
    <span style="color: #00ffff;">neg</span>     <span style="color: #eedd82;">%eax</span>            # |     # ?-&#1044;&#1072;, &#1080;&#1085;&#1074;&#1077;&#1088;&#1090;&#1080;&#1088;&#1091;&#1077;&#1084;
<span style="color: #87cefa;">5</span>:  #                     &lt;---+
    <span style="color: #00ffff;">ret</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-18" class="outline-3">
<h3 id="unnumbered-18">Просмотр словаря</h3>
<div class="outline-text-3" id="text-unnumbered-18">
<p>
Мы подходим к нашей прелюдии о том, как компилируется код Forth, но сначала нам нужно
еще немного инфраструктуры.
</p>

<p>
Слово FIND принимает строку (слово, которое анализируется WORD - см. выше) и находит
его его в словаре. Фактически он возвращает адрес найденного слова. Если слово не
найдено, он возвращает 0
</p>

<p>
Поэтому, если DOUBLE определен в словаре, тогда
</p>

<div class="org-src-container">

<pre class="src src-forth">WORD DOUBLE FIND
</pre>
</div>

<p>
возвращает следующий указатель:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-15.png" alt="forth-interpret-15.png">
</p>
</div>

<p>
См. также <code>&gt;CFA</code> и <code>&gt;DFA</code>.
</p>

<p>
FIND не находит словарные записи, помеченные как HIDDEN. См. ниже, почему.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_find">    <span style="color: #00ffff;">defcode</span> <span style="color: #ffa07a;">"FIND"</span>,4,,FIND
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%ecx</span>            # <span style="color: #eedd82;">%ecx</span> = &#1076;&#1083;&#1080;&#1085;&#1072; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%edi</span>            # <span style="color: #eedd82;">%edi</span> = &#1072;&#1076;&#1088;&#1077;&#1089; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">call</span>    _FIND
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>            # <span style="color: #eedd82;">%eax</span> = &#1072;&#1076;&#1088;&#1077;&#1089; &#1089;&#1083;&#1086;&#1074;&#1072; (&#1080;&#1083;&#1080; &#1085;&#1086;&#1083;&#1100;)
    <span style="color: #00ffff;">NEXT</span>
<span style="color: #87cefa;">_FIND</span>:
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%esi</span>            # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1084; <span style="color: #eedd82;">%esi</span> - &#1090;&#1072;&#1082; &#1084;&#1099; &#1089;&#1084;&#1086;&#1078;&#1077;&#1084; &#1080;&#1089;&#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1100; &#1101;&#1090;&#1086;&#1090;
                            # &#1088;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088; &#1076;&#1083;&#1103; &#1089;&#1088;&#1072;&#1074;&#1085;&#1077;&#1085;&#1080;&#1103; &#1089;&#1090;&#1088;&#1086;&#1082; &#1082;&#1086;&#1084;&#1072;&#1085;&#1076;&#1086;&#1081; CMPSB
    # &#1047;&#1076;&#1077;&#1089;&#1100; &#1084;&#1099; &#1085;&#1072;&#1095;&#1080;&#1085;&#1072;&#1077;&#1084; &#1080;&#1089;&#1082;&#1072;&#1090;&#1100; &#1074; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1077; &#1101;&#1090;&#1086; &#1089;&#1083;&#1086;&#1074;&#1086; &#1086;&#1090; &#1082;&#1086;&#1085;&#1094;&#1072; &#1082; &#1085;&#1072;&#1095;&#1072;&#1083;&#1091; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1103;
    <span style="color: #00ffff;">mov</span>     (var_LATEST), <span style="color: #eedd82;">%edx</span>          # <span style="color: #eedd82;">%edx</span> &#1090;&#1077;&#1087;&#1077;&#1088;&#1100; &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; &#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1077;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086; &#1074; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1077;
<span style="color: #87cefa;">1</span>:  #                   &lt;------------+
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%edx</span>, <span style="color: #eedd82;">%edx</span>      # (&#1074; <span style="color: #eedd82;">%edx</span> &#1085;&#1072;&#1093;&#1086;&#1076;&#1080;&#1090;&#1089;&#1103; NULL-&#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100;, &#1090;.&#1077;. &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1100; &#1082;&#1086;&#1085;&#1095;&#1080;&#1083;&#1089;&#1103;)?
    <span style="color: #00ffff;">je</span>  4f                  #-----+  |  # ?-&#1044;&#1072;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074;&#1087;&#1077;&#1088;&#1077;&#1076; &#1082; (4)
    #                             |  |
    # &#1057;&#1088;&#1072;&#1074;&#1085;&#1080;&#1084; &#1086;&#1078;&#1080;&#1076;&#1072;&#1077;&#1084;&#1091;&#1102; &#1076;&#1083;&#1080;&#1085;&#1091; &#1080; &#1076;&#1083;&#1080;&#1085;&#1091; &#1089;&#1083;&#1086;&#1074;&#1072;
    # &#1042;&#1085;&#1080;&#1084;&#1072;&#1085;&#1080;&#1077;, &#1077;&#1089;&#1083;&#1080; F_HIDDEN &#1091;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1083;&#1077;&#1085; &#1076;&#1083;&#1103; &#1101;&#1090;&#1086;&#1075;&#1086; &#1089;&#1083;&#1086;&#1074;&#1072;, &#1090;&#1086; &#1089;&#1086;&#1074;&#1087;&#1072;&#1076;&#1077;&#1085;&#1080;&#1103; &#1085;&#1077; &#1073;&#1091;&#1076;&#1077;&#1090;.
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>      #     |  |  # &#1054;&#1095;&#1080;&#1097;&#1072;&#1077;&#1084; <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">movb</span>    4(<span style="color: #eedd82;">%edx</span>), <span style="color: #eedd82;">%al</span>    #     |  |  # <span style="color: #eedd82;">%al</span> = flags+length
    <span style="color: #00ffff;">andb</span>    $(F_HIDDEN|F_LENMASK), <span style="color: #eedd82;">%al</span>  # <span style="color: #eedd82;">%al</span> = &#1090;&#1077;&#1087;&#1077;&#1088;&#1100; &#1076;&#1083;&#1080;&#1085;&#1072; &#1080;&#1084;&#1077;&#1085;&#1080; (&#1084;&#1072;&#1089;&#1082;&#1080;&#1088;&#1091;&#1077;&#1084; &#1092;&#1083;&#1072;&#1075;&#1080;)
    <span style="color: #00ffff;">cmpb</span>    <span style="color: #eedd82;">%cl</span>, <span style="color: #eedd82;">%al</span>        #     |  |  # (&#1044;&#1083;&#1080;&#1085;&#1099; &#1086;&#1076;&#1080;&#1085;&#1072;&#1082;&#1086;&#1074;&#1099;&#1077;?)
    <span style="color: #00ffff;">jne</span> 2f                  #--+  |  |  # ?-&#1053;&#1077;&#1090;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074;&#1087;&#1077;&#1088;&#1077;&#1076; &#1082; (2)
    #                          |  |  |
    # &#1055;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1082; &#1076;&#1077;&#1090;&#1072;&#1083;&#1100;&#1085;&#1086;&#1084;&#1091; &#1089;&#1088;&#1072;&#1074;&#1085;&#1077;&#1085;&#1080;&#1102;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%ecx</span>            #  |  |  |  # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1084; &#1076;&#1083;&#1080;&#1085;&#1091;, &#1087;&#1086;&#1090;&#1086;&#1084;&#1091; &#1095;&#1090;&#1086; repe cmpsb &#1091;&#1084;&#1077;&#1085;&#1100;&#1096;&#1072;&#1077;&#1090; <span style="color: #eedd82;">%ecx</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%edi</span>            #  |  |  |  # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1084; &#1072;&#1076;&#1088;&#1077;&#1089;, &#1087;&#1086;&#1090;&#1086;&#1084;&#1091; &#1095;&#1090;&#1086; repe cmpsb &#1076;&#1074;&#1080;&#1075;&#1072;&#1077;&#1090; <span style="color: #eedd82;">%edi</span>
    <span style="color: #00ffff;">lea</span>     5(<span style="color: #eedd82;">%edx</span>), <span style="color: #eedd82;">%esi</span>   #  |  |  |  # &#1047;&#1072;&#1075;&#1088;&#1091;&#1078;&#1072;&#1077;&#1084; &#1074; <span style="color: #eedd82;">%esi</span> &#1072;&#1076;&#1088;&#1077;&#1089; &#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1080;&#1084;&#1077;&#1085;&#1080; &#1089;&#1083;&#1086;&#1074;&#1072;
    <span style="color: #00ffff;">repe</span>    cmpsb           #  |  |  |  # &#1057;&#1088;&#1072;&#1074;&#1085;&#1080;&#1074;&#1072;&#1077;&#1084;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%edi</span>            #  |  |  |  # &#1042;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; &#1072;&#1076;&#1088;&#1077;&#1089;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%ecx</span>            #  |  |  |  # &#1042;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1084; &#1076;&#1083;&#1080;&#1085;&#1091;
    <span style="color: #00ffff;">jne</span> 2f                  #--+  |  |  # ?-&#1045;&#1089;&#1083;&#1080; &#1085;&#1077; &#1088;&#1072;&#1074;&#1085;&#1099; - &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074;&#1087;&#1077;&#1088;&#1077;&#1076; &#1082; (2)
    #                          |  |  |
    # &#1057;&#1090;&#1088;&#1086;&#1082;&#1080; &#1088;&#1072;&#1074;&#1085;&#1099; - &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1080;&#1084; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1079;&#1072;&#1075;&#1086;&#1083;&#1086;&#1074;&#1086;&#1082; &#1074; <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%esi</span>            #  |  |  |  # &#1042;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1084; <span style="color: #eedd82;">%esi</span>
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%edx</span>, <span style="color: #eedd82;">%eax</span>      #  |  |  |  # <span style="color: #eedd82;">%edx</span> &#1074;&#1089;&#1077; &#1077;&#1097;&#1077; &#1089;&#1086;&#1076;&#1077;&#1088;&#1078;&#1080;&#1090; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1081; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;
    <span style="color: #00ffff;">ret</span>                     #  |  |  |  # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;
    # ----------------- RET    |  |  |
<span style="color: #87cefa;">2</span>:  #                     &lt;----+  |  |
    <span style="color: #00ffff;">mov</span>     (<span style="color: #eedd82;">%edx</span>), <span style="color: #eedd82;">%edx</span>    #     |  |  # &#1055;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1087;&#1086; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1102; &#1082; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1077;&#1084;&#1091; &#1089;&#1083;&#1086;&#1074;&#1091;
    <span style="color: #00ffff;">jmp</span> 1b                  #     |  |  # &#1048; &#1079;&#1072;&#1094;&#1080;&#1082;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084;&#1089;&#1103;
    # ----------------------------|--+
<span style="color: #87cefa;">4</span>:  #                     &lt;-------+
    # &#1057;&#1083;&#1086;&#1074;&#1086; &#1085;&#1077; &#1085;&#1072;&#1081;&#1076;&#1077;&#1085;&#1086;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%esi</span>            # &#1042;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1084; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1077;&#1085;&#1085;&#1099;&#1081; <span style="color: #eedd82;">%esi</span>
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>      # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1080;&#1084; &#1085;&#1086;&#1083;&#1100; &#1074; <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">ret</span>                     # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;
</pre>
</div>

<p>
FIND возвращает указатель словаря, но при Forth-компиляции нам нужен указатель кодового
слова (напомним, что определения Forth скомпилированы в списки указателей на
<code>codeword</code>-ы). Стандартное слово <code>&gt;CFA</code> превращает указатель словаря в указатель на
<code>codeword</code>.
</p>

<p>
<code>CFA</code> означает "Code Field Address", т.е. <code>codeword</code>
</p>

<p>
В приведенном ниже примере показан результат:
</p>

<div class="org-src-container">

<pre class="src src-forth">WORD DOUBLE FIND &gt;CFA
</pre>
</div>


<div class="figure">
<p><img src="../../../img/forth-interpret-16.png" alt="forth-interpret-16.png">
</p>
</div>

<p>
NB: поскольку имена различаются по длине, это не просто простое приращение.
</p>

<p>
В этом Forth вы не можете легко превратить указатель на <code>codeword</code> обратно в указатель
на слово, но это не так для большинства реализаций Forth, где хранится обратный
указатель (с очевидной стоимостью по памяти/сложности).
</p>

<p>
Причина, по которой такие реализации хранят обратный указатель, заключается в том, что
это бывает полезно, чтобы быстро декомпилировать слова Forth.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_tcfa">    <span style="color: #00ffff;">defcode</span> <span style="color: #ffa07a;">"&gt;CFA"</span>,4,,TCFA
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%edi</span>
    <span style="color: #00ffff;">call</span>    _TCFA
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%edi</span>
    <span style="color: #00ffff;">NEXT</span>
<span style="color: #87cefa;">_TCFA</span>:
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">add</span>     $4, <span style="color: #eedd82;">%edi</span>        # &#1055;&#1088;&#1086;&#1087;&#1091;&#1089;&#1082;&#1072;&#1077;&#1084; LINK - &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1087;&#1088;&#1077;&#1076;&#1099;&#1076;&#1091;&#1097;&#1077;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086;
    <span style="color: #00ffff;">movb</span>    (<span style="color: #eedd82;">%edi</span>), <span style="color: #eedd82;">%al</span>     # &#1047;&#1072;&#1075;&#1088;&#1091;&#1078;&#1072;&#1077;&#1084; flags+len &#1074; <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">inc</span>     <span style="color: #eedd82;">%edi</span>            # &#1055;&#1088;&#1086;&#1087;&#1091;&#1089;&#1082;&#1072;&#1077;&#1084; flags+len &#1073;&#1072;&#1081;&#1090;
    <span style="color: #00ffff;">andb</span>    $F_LENMASK, <span style="color: #eedd82;">%al</span> # &#1052;&#1072;&#1089;&#1082;&#1080;&#1088;&#1091;&#1077;&#1084;, &#1095;&#1090;&#1086;&#1073;&#1099; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1076;&#1083;&#1080;&#1085;&#1091; &#1080;&#1084;&#1077;&#1085;&#1080;, &#1073;&#1077;&#1079; &#1092;&#1083;&#1072;&#1075;&#1086;&#1074;
    <span style="color: #00ffff;">add</span>     <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%edi</span>      # &#1055;&#1088;&#1086;&#1087;&#1091;&#1089;&#1082;&#1072;&#1077;&#1084; &#1080;&#1084;&#1103;
    <span style="color: #00ffff;">addl</span>    $3, <span style="color: #eedd82;">%edi</span>        # &#1059;&#1095;&#1080;&#1090;&#1099;&#1074;&#1072;&#1077;&#1084; &#1074;&#1099;&#1088;&#1072;&#1074;&#1085;&#1080;&#1074;&#1072;&#1085;&#1080;&#1077;
    <span style="color: #00ffff;">andl</span>    $~3, <span style="color: #eedd82;">%edi</span>
    <span style="color: #00ffff;">ret</span>
</pre>
</div>

<p>
В связи с <code>&gt;CFA</code> рассмотрим <code>&gt;DFA</code>, который берет адрес записи словаря, возвращаемый
FIND, и возвращает указатель на первую ячейку <code>param-field</code>.
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-17.png" alt="forth-interpret-17.png">
</p>
</div>

<p>
(Обратите внимание на этот момент, кто знаком с исходным кодом FIG-Forth / ciforth: Это
&gt;DFA определение отличается от их, потому что у них есть дополнительная косвенность).
</p>

<p>
Как легко можно увидеть &gt;DFA легко определяется в Forth, просто путем добавления 4 к
результату &gt;CFA.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_tdfa"><span style="color: #87cefa;">defword</span> <span style="color: #ffa07a;">"&gt;DFA"</span>,4,,TDFA
    <span style="color: #00ffff;">.int</span> TCFA       # &gt;CFA     (&#1087;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; code field address)
    <span style="color: #00ffff;">.int</span> INCR4      # 4+       (&#1076;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; 4, &#1095;&#1090;&#1086;&#1073;&#1099; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1077;&#1088;&#1074;&#1086;&#1075;&#1086; &#1089;&#1083;&#1086;&#1074;&#1072; &#1074; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1085;&#1080;&#1080;)
    <span style="color: #00ffff;">.int</span> EXIT       # EXIT     (&#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;&#1089;&#1103;)
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-19" class="outline-3">
<h3 id="unnumbered-19">Компиляция</h3>
<div class="outline-text-3" id="text-unnumbered-19">
<p>
Теперь мы поговорим о том, как Forth компилирует слова. Напомним, что определение слова
выглядит следующим образом:
</p>

<div class="org-src-container">

<pre class="src src-forth">: DOUBLE DUP + <span style="color: #00ffff;">;</span>
</pre>
</div>

<p>
и мы должны превратить это в:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-18.png" alt="forth-interpret-18.png">
</p>
</div>

<p>
Теперь нам нужно решить несколько задач:
</p>
<ul class="org-ul">
<li>Куда поместить новое слово?
</li>
<li>Как мы читаем слова?
</li>
<li>Как мы определяем слова <code>:</code> (COLON) и <code>;</code> (SEMICOLON)?
</li>
</ul>

<p>
Forth решает это довольно изящно и, как вы можете ожидать, очень низкоуровневым
способом, который позволяет вам изменить способ работы компилятора над вашим
собственным кодом.
</p>

<p>
Forth имеет функцию INTERPRET (настоящий интерпретатор на этот раз, а не DOCOL),
которая работает в цикле,
</p>
<ul class="org-ul">
<li>читая слова (используя WORD)
</li>
<li>находя их (используя FIND)
</li>
<li>и превращая их в указатели кодового слова (используя &gt;CFA)
</li>
<li>а потом <b>решая, что с ними делать</b>.
</li>
</ul>

<p>
Решение, что с ними делать, зависит от режима интерпретатора (хранящегося в переменной
STATE):
</p>
<ul class="org-ul">
<li>Когда STATE равно нулю, интерпретатор просто запускает каждое слово, как только
находит его. Это называется "немедленным режимом" (immediate mode).
</li>
<li>Интересные вещи происходят, когда STATE не равен нулю - в "режим компиляции"
(compiling mode). В этом режиме интерпретатор добавляет указатель <code>codeword</code> в
пользовательскую память (переменная HERE указывает на следующий свободный байт
пользовательской памяти).
</li>
</ul>

<p>
Таким образом, вы сможете увидеть, как мы можем определить <code>:</code> (COLON). Общий план:
</p>
<ul class="org-ul">
<li>(1) Использовать WORD для чтения имени определяемой функции.
</li>
<li>(2) Построить запись словаря - только заголовочную часть - в пользовательской памяти:
</li>
</ul>


<div class="figure">
<p><img src="../../../img/forth-interpret-19.png" alt="forth-interpret-19.png">
</p>
</div>

<ul class="org-ul">
<li>(3) Установить LATEST, чтобы указать на новое слово, &#x2026;
</li>
<li>(4) .. и самое главное установить HERE, чтобы он указывал сразу после нового
<code>codeword</code>. Здесь интерпретатор будет добавлять кодовые слова.
</li>
<li>(5) Установить STATE в 1. Это вызовет переход в режим компиляции, поэтому интерпретатор
начинает добавлять кодовые слова к нашему частично сформированному слову.
</li>
</ul>

<p>
После того, как <code>:</code> запущен, наш ввод находится здесь:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-20.png" alt="forth-interpret-20.png">
</p>
</div>

<p>
поэтому интерпретатор (теперь он находится в режиме компиляции, поэтому его можно
считать компилятором) читает "DUP", находит его в словаре, получает его указатель на
<code>codeword</code> и добавляет его.
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-21.png" alt="forth-interpret-21.png">
</p>
</div>

<p>
Затем мы читаем <code>+</code>, получаем указатель его <code>codeword</code> и добавляем его:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-22.png" alt="forth-interpret-22.png">
</p>
</div>

<p>
Теперь проблема заключается в следующем. Очевидно, что мы не хотим, чтобы мы читали <code>;</code>
скомпилировали его и продолжали компилировать все подряд.
</p>

<p>
На этом этапе Forth использует трюк. Помните, что длина байта в определении словаря не
просто байт длины, но также может содержать флаги. Один флаг называется флагом
IMMEDIATE (F＿IMMED в этом коде). Если слово в словаре помечено как IMMEDIATE, тогда
интерпретатор запускает его немедленно <b>даже если он находится в режиме компиляции</b>.
</p>

<p>
Вот как это слово <code>;</code> (SEMICOLON) работает - как слово, помеченное в словаре как
IMMEDIATE.
</p>

<p>
Все, что оно делает, - это добавляет кодовое слово для EXIT в текущее определение и
возвращает к немедленному режиму (установкой STATE на 0). Вскоре мы увидим его
фактическое определение; и мы увидим, что это действительно очень простое определение,
объявленное как IMMEDIATE.
</p>

<p>
После чтения интерпретатором <code>;</code> и выполнения его "немедленно", мы получаем это:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-23.png" alt="forth-interpret-23.png">
</p>
</div>

<p>
и STATE установлена в 0;
</p>

<p>
И это вся работа, наше новое определение скомпилировано, и мы вернулись в
непосредственный режим, простых чтений и выполнений слов, возможно, включая вызов,
чтобы проверить наше новое слово DOUBLE.
</p>

<p>
Единственная последняя заминка в том, чтобы, пока слово компилируется, оно было в
"полуготовом" состоянии. Мы, разумеется, не хотели бы, чтобы DOUBLE был вызван кем-то в
это время. Есть несколько способов сделать это это, но в Forth мы устанавливаем байт
<code>flags/len</code> с флагом HIDDEN (F＿HIDDEN в этом коде) во время его компиляции. Это
предотвращает обнаружение компилируемого слова с помощью FIND и, таким образом,
теоретически предотвращает любой шанс его вызова.
</p>

<p>
Вышеприведенное объясняет, как компилировать <code>:</code> (COLON) и <code>;</code> (SEMICOLON), и через
некоторое время я их определю. Функция: (COLON) может быть сделана немного более общей,
если написать ее в двух частях. Первая часть, называемая CREATE, создает только
заголовок:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-24.png" alt="forth-interpret-24.png">
</p>
</div>

<p>
и вторая часть, фактическое определение <code>:</code> (COLON), вызывает CREATE и добавляет кодовое
слово DOCOL:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-25.png" alt="forth-interpret-25.png">
</p>
</div>

<p>
CREATE является стандартным словом Forth, и преимущество этого разделения состоит в
том, что мы можем его повторно использовать для создания других типов слов (не только
тех, которые содержат код, но например и таких, которые содержат переменные, константы
и другие данные).
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_create"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"CREATE"</span>,6,,CREATE

    # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; length &#1080; address &#1080;&#1084;&#1077;&#1085;&#1080; &#1080;&#1079; &#1089;&#1090;&#1077;&#1082;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%ecx</span>            # <span style="color: #eedd82;">%ecx</span> = length
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%ebx</span>            # <span style="color: #eedd82;">%ebx</span> = address

    # &#1060;&#1086;&#1088;&#1084;&#1080;&#1088;&#1091;&#1077;&#1084; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; LINK
    <span style="color: #00ffff;">movl</span>    (var_HERE), <span style="color: #eedd82;">%edi</span># <span style="color: #eedd82;">%edi</span> &#1090;&#1077;&#1087;&#1077;&#1088;&#1100; &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; &#1079;&#1072;&#1075;&#1086;&#1083;&#1086;&#1074;&#1086;&#1082;
    <span style="color: #00ffff;">movl</span>    (var_LATEST), <span style="color: #eedd82;">%eax</span> # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1077;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086; -
                            # - &#1101;&#1090;&#1086; LINK &#1089;&#1086;&#1079;&#1076;&#1072;&#1074;&#1072;&#1077;&#1084;&#1086;&#1075;&#1086; &#1089;&#1083;&#1086;&#1074;&#1072;
    <span style="color: #00ffff;">stosl</span>                   # &#1080; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1077;&#1084; &#1077;&#1075;&#1086; &#1074; &#1092;&#1086;&#1088;&#1084;&#1080;&#1088;&#1091;&#1077;&#1084;&#1086;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086;

    # &#1060;&#1086;&#1088;&#1084;&#1080;&#1088;&#1091;&#1077;&#1084; &#1041;&#1072;&#1081;&#1090; &#1076;&#1083;&#1080;&#1085;&#1099; &#1080; &#1080;&#1084;&#1103; &#1089;&#1083;&#1086;&#1074;&#1072;
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%cl</span>,<span style="color: #eedd82;">%al</span>         # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1076;&#1083;&#1080;&#1085;&#1091;
    <span style="color: #00ffff;">stosb</span>                   # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1077;&#1084; length/flags &#1073;&#1072;&#1081;&#1090;.
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%esi</span>            # &#1053;&#1077;&#1085;&#1072;&#1076;&#1086;&#1083;&#1075;&#1086; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1084; <span style="color: #eedd82;">%esi</span>
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%ebx</span>, <span style="color: #eedd82;">%esi</span>      # &#1074; <span style="color: #eedd82;">%esi</span> &#1090;&#1077;&#1087;&#1077;&#1088;&#1100; &#1072;&#1076;&#1088;&#1077;&#1089; &#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1080;&#1084;&#1077;&#1085;&#1080;
    <span style="color: #00ffff;">rep</span>     movsb           # &#1050;&#1086;&#1087;&#1080;&#1088;&#1091;&#1077;&#1084; &#1080;&#1084;&#1103; &#1089;&#1083;&#1086;&#1074;&#1072;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%esi</span>            # &#1042;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1084; <span style="color: #eedd82;">%esi</span>
    <span style="color: #00ffff;">addl</span>    $3, <span style="color: #eedd82;">%edi</span>        # &#1042;&#1099;&#1095;&#1080;&#1089;&#1083;&#1080;&#1084; &#1074;&#1099;&#1088;&#1072;&#1074;&#1085;&#1080;&#1074;&#1072;&#1085;&#1080;&#1077;
    <span style="color: #00ffff;">andl</span>    $~3, <span style="color: #eedd82;">%edi</span>

    # &#1054;&#1073;&#1085;&#1086;&#1074;&#1080;&#1084; LATEST &#1080; HERE.
    <span style="color: #00ffff;">movl</span>    (var_HERE), <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">movl</span>    <span style="color: #eedd82;">%eax</span>, (var_LATEST)
    <span style="color: #00ffff;">movl</span>    <span style="color: #eedd82;">%edi</span>, (var_HERE)
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>

<p>
Поскольку я хочу определить <code>:</code> (COLON) в Forth, а не в ассемблере, нам нужно еще
несколько слов Forth.
</p>

<p>
Первый - это <code> , </code> (COMMA), который является стандартным словом Forth, которое добавляет
32-битное целое к пользовательской памяти, на которое указывает HERE, а потом добавляет 4 к
HERE. Таким образом, действие <code> , </code> (COMMA) выглядит так:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-26.png" alt="forth-interpret-26.png">
</p>
</div>

<p>
DATA - любое 32-битное значение, которое лежит на вершине стека
</p>

<p>
<code> , </code> (COMMA) является довольно фундаментальной операцией при компиляции. Оно
используется для добавления указателей на <code>codeword</code>-ы дочерних слов в текущее слово,
которое компилируется.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_comma"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">","</span>,1,,COMMA
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%eax</span>      # &#1042;&#1079;&#1103;&#1090;&#1100; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1074; <span style="color: #eedd82;">%eax</span> &#1090;&#1086; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1086;&#1077; &#1073;&#1091;&#1076;&#1077;&#1084; &#1074;&#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1080;&#1074;&#1072;&#1090;&#1100;
    <span style="color: #00ffff;">call</span>    _COMMA
    <span style="color: #00ffff;">NEXT</span>
<span style="color: #87cefa;">_COMMA</span>:
    <span style="color: #00ffff;">movl</span>    (var_HERE), <span style="color: #eedd82;">%edi</span>  # &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; HERE &#1074; <span style="color: #eedd82;">%edi</span>
    <span style="color: #00ffff;">stosl</span>                     # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1100; &#1087;&#1086; &#1085;&#1077;&#1084;&#1091; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1080;&#1079; <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">movl</span>    <span style="color: #eedd82;">%edi</span>, (var_HERE)  # &#1054;&#1073;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; HERE (&#1080;&#1089;&#1087;&#1086;&#1083;&#1100;&#1079;&#1091;&#1103; &#1080;&#1085;&#1082;&#1088;&#1077;&#1084;&#1077;&#1085;&#1090;, &#1089;&#1076;&#1077;&#1083;&#1072;&#1085;&#1085;&#1099;&#1081; STOSL)
    <span style="color: #00ffff;">ret</span>
</pre>
</div>

<p>
Наши определения <code>:</code> (COLON) и <code>;</code> (SEMICOLON) необходимо будет переключать в <b>режим
компиляции</b> и из него.
</p>

<p>
Глобальная переменная STATE определяет текущий режим (<code>немедленный</code> или <code>режим
компиляции</code>) и, изменяя эту переменную, мы можем переключаться между этими двумя
режимами.
</p>

<p>
По различным причинам, которые проявятся позже, Forth определяет два стандартных слова,
называемых <code>[</code> и <code>]</code> (LBRAC и RBRAC), которые переключают между этими режимами:
</p>

<table>


<colgroup>
<col  class="left">

<col  class="left">

<col  class="left">

<col  class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Слово</th>
<th scope="col" class="left">Ассемблерное имя</th>
<th scope="col" class="left">Действие</th>
<th scope="col" class="left">Эффект</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">[</td>
<td class="left">LBRAC</td>
<td class="left">STATE = 0</td>
<td class="left">Переключение в немедленный режим.</td>
</tr>

<tr>
<td class="left">]</td>
<td class="left">RBRAC</td>
<td class="left">STATE = 1</td>
<td class="left">Переключение в режим компиляции.</td>
</tr>
</tbody>
</table>

<p>
<code>[</code> (LBRAC) является НЕМЕДЛЕННЫМ (IMMEDIATE) словом. Причина такова: если бы это было
не так и мы находились в режиме компиляции, и интерпретатор увидел <code>[</code> - тогда он
скомпилировал бы ее, а не выполнил бы ее. И мы никогда не смогли бы вернуться к
немедленному режиму! Поэтому мы помечаем слово как IMMEDIATE, так что даже в режиме
компиляции <code>[</code> запускается в немедленном режиме, переключая нас обратно в немедленный
режим.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_rbrac"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"["</span>,1,F_IMMED,LBRAC
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">movl</span>    <span style="color: #eedd82;">%eax</span>, (var_STATE)   # &#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; STATE &#1074; 0
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"]"</span>,1,,RBRAC
    <span style="color: #00ffff;">movl</span>    $1, (var_STATE)     # &#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; STATE &#1074; 1
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>

<p>
Теперь мы можем определить <code>:</code> (COLON), используя CREATE. Он просто вызывает CREATE,
добавляет DOCOL (как <code>codeword</code>), устанавливает HIDDEN и переходит в режим компиляции.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_colon"><span style="color: #87cefa;">defword</span> <span style="color: #ffa07a;">":"</span>,1,,COLON
    <span style="color: #00ffff;">.int</span> WORD               # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1080;&#1084;&#1103; &#1085;&#1086;&#1074;&#1086;&#1075;&#1086; &#1089;&#1083;&#1086;&#1074;&#1072;
    <span style="color: #00ffff;">.int</span> CREATE             # CREATE &#1079;&#1072;&#1075;&#1086;&#1083;&#1086;&#1074;&#1086;&#1082; &#1079;&#1072;&#1087;&#1080;&#1089;&#1080; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1103;
    <span style="color: #00ffff;">.int</span> LIT, DOCOL, COMMA  # &#1044;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; DOCOL (&#1082;&#1072;&#1082; codeword).
    <span style="color: #00ffff;">.int</span> LATEST, FETCH, HIDDEN # &#1044;&#1077;&#1083;&#1072;&#1077;&#1084; &#1089;&#1083;&#1086;&#1074;&#1086; &#1089;&#1082;&#1088;&#1099;&#1090;&#1099;&#1084; (&#1089;&#1084;. &#1085;&#1080;&#1078;&#1077; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1077; HIDDEN).
    <span style="color: #00ffff;">.int</span> RBRAC              # &#1055;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074; &#1088;&#1077;&#1078;&#1080;&#1084; &#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1103;&#1094;&#1080;&#1080;
    <span style="color: #00ffff;">.int</span> EXIT               # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090; &#1080;&#1079; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080;
</pre>
</div>

<p>
<code>;</code> (SEMICOLON) также элегантно прост. Обратите внимание на флаг F＿IMMED.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_semicolon"><span style="color: #87cefa;">defword</span> <span style="color: #ffa07a;">";"</span>,1,F_IMMED,SEMICOLON
    <span style="color: #00ffff;">.int</span> LIT, EXIT, COMMA   # &#1044;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; EXIT (&#1090;&#1072;&#1082; &#1089;&#1083;&#1086;&#1074;&#1086; &#1076;&#1077;&#1083;&#1072;&#1077;&#1090; RETURN).
    <span style="color: #00ffff;">.int</span> LATEST, FETCH, HIDDEN # &#1055;&#1077;&#1088;&#1077;&#1082;&#1083;&#1102;&#1095;&#1072;&#1077;&#1084; HIDDEN flag  (&#1089;&#1084;. &#1085;&#1080;&#1078;&#1077; &#1076;&#1083;&#1103; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1103;).
    <span style="color: #00ffff;">.int</span> LBRAC              # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;&#1089;&#1103; &#1074; IMMEDIATE &#1088;&#1077;&#1078;&#1080;&#1084;.
    <span style="color: #00ffff;">.int</span> EXIT               # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090; &#1080;&#1079; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080;
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-20" class="outline-3">
<h3 id="unnumbered-20">Расширение компилятора</h3>
<div class="outline-text-3" id="text-unnumbered-20">
</div><div id="outline-container-unnumbered-21" class="outline-4">
<h4 id="unnumbered-21">IMMEDIATE</h4>
<div class="outline-text-4" id="text-unnumbered-21">
<p>
Слова, помеченные IMMEDIATE (F＿IMMED), предназначены не только для использования
компилятором Forth. Вы также можете определить свои собственные IMMEDIATE-слова, и это
важный аспект при расширении базового Forth, поскольку он позволяет фактически
расширять сам компилятор. GCC позволяет вам это делать?
</p>

<p>
Стандартные слова Forth, такие как <code>IF</code>, <code>WHILE</code>, <code> ." </code> и.т.д., написаны как
расширения базового компилятора, и все это IMMEDIATE-слова.
</p>

<p>
Слово IMMEDIATE переключает флаг F＿IMMED (IMMEDIATE) в последнем определеннем слове
или в текущем слове, если вы вызываете его в середине определения.
</p>

<p>
Типичное использование:
</p>

<div class="org-src-container">

<pre class="src src-forth">: MYIMMEDWORD <span style="color: #00ffff;">IMMEDIATE</span>
    ...definition...
<span style="color: #00ffff;">;</span>
</pre>
</div>

<p>
но некоторые Forth-программисты пишут это вместо этого:
</p>

<div class="org-src-container">

<pre class="src src-forth"><span style="color: #00ffff;">: </span><span style="color: #87cefa;">MYIMMEDWORD
</span>    ...definition...
<span style="color: #00ffff;">; IMMEDIATE</span>
</pre>
</div>

<p>
Эти два способа использования эквивалентны в первом приближении.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_immediate"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"IMMEDIATE"</span>,9,F_IMMED,IMMEDIATE
    <span style="color: #00ffff;">movl</span>    (var_LATEST), <span style="color: #eedd82;">%edi</span>  # LATEST &#1089;&#1083;&#1086;&#1074;&#1086; &#1074; <span style="color: #eedd82;">%edi</span>.
    <span style="color: #00ffff;">addl</span>    $4, <span style="color: #eedd82;">%edi</span>            # &#1058;&#1077;&#1087;&#1077;&#1088;&#1100; <span style="color: #eedd82;">%edi</span> &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; &#1073;&#1072;&#1081;&#1090; name/flags
    <span style="color: #00ffff;">xorb</span>    $F_IMMED, (<span style="color: #eedd82;">%edi</span>)    # &#1055;&#1077;&#1088;&#1077;&#1082;&#1083;&#1102;&#1095;&#1080;&#1090;&#1100; the F_IMMED &#1073;&#1080;&#1090;.
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>

<p>
В качестве примера использования IMMEDIATE-слов для компиляции рассмотрим такой:
</p>

<div class="org-src-container">

<pre class="src src-forth">: BAZ IMMEDIATE HERE @ , <span style="color: #00ffff;">;</span>
<span style="color: #00ffff;">: </span><span style="color: #87cefa;">BAR </span>BAZ BAZ <span style="color: #00ffff;">;</span>
</pre>
</div>

<p>
BAZ - "немедленное" слово. Оно положит на стек данных значение по адресу HERE, а затем
вкомпилирует его в новое слово. В момент создания слова BAR:
</p>
<ul class="org-ul">
<li>Сначала создается заголовочная часть BAR, устанавливается HERE и LATEST (см. CREATE и
COLON
</li>
<li>Потом исполняется первый BAZ (кладется значение по адресу HERE на стек), после чего
COMMA вкомпиливает его в создаваемое слово BAR. В реезультате значение по адресу из
HERE - "вкомпиливается" в BAR.
</li>
<li>Исполняется второй BAZ. Происходит то же самое.
</li>
<li>SEMICOLON (точка с запятой) вкомпиливает в BAR слово EXIT и выходит из режима
компиляции
</li>
</ul>

<p>
Вот так скомпилированное слово BAR будет выглядеть в памяти:
</p>

<pre class="example">
LINK
FLAGS/LEN
"BAR" (name)
padding (опционально)
DOCOL
addr of HERE
addr of HERE
EXIT
</pre>

<p>
Таким образом, IMMEDIATE слова не становятся во время компиляции "частью" других слов,
как мы привыкли. Вместо этого они получают возможность вкомпиливать все что захотят
прямо в режиме компиляции.
</p>

<p>
Не стоит вызывать это слово - оно содержит ошибку потому что HERE не является
правильным адресом дочернего слова. Если это непонятно, вернитесь к главе "Косвенный
шитый код" в первой части мана
</p>
</div>
</div>

<div id="outline-container-unnumbered-22" class="outline-4">
<h4 id="unnumbered-22">HIDDEN</h4>
<div class="outline-text-4" id="text-unnumbered-22">
<p>
<code>addr HIDDEN</code> переключает HIDDEN флаг (F＿HIDDEN) слова, определенного в <code>addr</code>. Чтобы
скрыть последнее заданное слово (используемое выше в <code>:</code> и <code>;</code> определениях), вы
должны:
</p>

<div class="org-src-container">

<pre class="src src-forth">LATEST @ HIDDEN
</pre>
</div>

<p>
<code>HIDE word</code> переключает флаг названного слова <code>word</code>.
</p>

<p>
Установка этого флага предотвращает нахождение слова с помощью FIND, поэтому его можно
использовать для создания "private" слов. Например, чтобы разбить большое слово на
более мелкие части, вы можете сделать:
</p>

<div class="org-src-container">

<pre class="src src-forth">: SUB1 ... subword ... <span style="color: #00ffff;">;</span>
<span style="color: #00ffff;">: </span><span style="color: #87cefa;">SUB2 </span>... subword ... <span style="color: #00ffff;">;</span>
<span style="color: #00ffff;">: </span><span style="color: #87cefa;">SUB3 </span>... subword ... <span style="color: #00ffff;">;</span>
<span style="color: #00ffff;">: </span><span style="color: #87cefa;">MAIN </span>... defined in terms of SUB1, SUB2, SUB3 ... <span style="color: #00ffff;">;</span>
HIDE SUB1
HIDE SUB2
HIDE SUB3
</pre>
</div>

<p>
После этого только MAIN "экспортируется" и остается видимым для остальной части
программы.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_hidden"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"HIDDEN"</span>,6,,HIDDEN
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%edi</span>                # &#1059;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1089;&#1083;&#1086;&#1074;&#1086; &#1074; <span style="color: #eedd82;">%edi</span>
    <span style="color: #00ffff;">addl</span>    $4, <span style="color: #eedd82;">%edi</span>            # &#1058;&#1077;&#1087;&#1077;&#1088;&#1100; &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; &#1073;&#1072;&#1081;&#1090; length/flags.
    <span style="color: #00ffff;">xorb</span>    $F_HIDDEN, (<span style="color: #eedd82;">%edi</span>)   # &#1055;&#1077;&#1088;&#1077;&#1082;&#1083;&#1102;&#1095;&#1072;&#1077;&#1084; HIDDEN &#1073;&#1080;&#1090;.
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defword</span> <span style="color: #ffa07a;">"HIDE"</span>,4,,HIDE
    <span style="color: #00ffff;">.int</span>    WORD                # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1089;&#1083;&#1086;&#1074;&#1086; (&#1080;&#1097;&#1091;&#1097;&#1077;&#1077; &#1079;&#1072; HIDE).
    <span style="color: #00ffff;">.int</span>    FIND                # &#1048;&#1097;&#1077;&#1084; &#1077;&#1075;&#1086; &#1074; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1077;
    <span style="color: #00ffff;">.int</span>    HIDDEN              # &#1059;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; F_HIDDEN &#1092;&#1083;&#1072;&#1075;.
    <span style="color: #00ffff;">.int</span>    EXIT                # &#1042;&#1099;&#1093;&#1086;&#1076;&#1080;&#1084;
</pre>
</div>

<p>
IMMEDIATE, как вы уже поняли, может работать только с последним определенным словом или
с текущим. Потому что предполагается, что вы на стадии создания слова знаете, будет оно
"немедленным" или нет. В случае, если все-таки вам нужно сделать слово "немедленным", а
оно где-то в середине вашего словаря, вручную занестите в LATEST указатель на это слово
и выполните IMMEDIATE. Только не забудьте восстановить указатель в LATEST!
</p>

<p>
HIDDEN, в отличие от IMMEDIATE, может работать с любым словом, чей адрес помещен на
стек данных, откуда он его возьмет.
</p>
</div>
</div>

<div id="outline-container-unnumbered-23" class="outline-4">
<h4 id="unnumbered-23">TICK</h4>
<div class="outline-text-4" id="text-unnumbered-23">
<p>
<code> ' </code> (TICK) - это стандартное слово Forth, которое возвращает <code>codeword</code> следующего за
ним слова.
</p>

<p>
Общее использование:
</p>

<div class="org-src-container">

<pre class="src src-forth"><span style="color: #00ffff;">' </span><span style="color: #87cefa;">FOO </span>,
</pre>
</div>

<p>
это способ добавить <code>codeword</code> FOO к текущему слову, которое мы определяем (это
работает только в компилируемом коде).
</p>

<p>
Вы, как правило, используете <code> ' </code> в IMMEDIATE словах. Например, альтернативный (и
довольно бесполезный) способ определения литерала 2 может быть:
</p>

<div class="org-src-container">

<pre class="src src-forth">: LIT2 <span style="color: #00ffff;">IMMEDIATE</span>
    <span style="color: #00ffff;">' </span>LIT ,   <span style="color: #ff7f24;">\ &#1044;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1090; LIT &#1082; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1103;&#1077;&#1084;&#1086;&#1084;&#1091; &#1074; &#1085;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1081; &#1084;&#1086;&#1084;&#1077;&#1085;&#1090; &#1089;&#1083;&#1086;&#1074;&#1091;
</span>    <span style="color: #7fffd4;">2 </span>,       <span style="color: #ff7f24;">\ &#1044;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1090; &#1095;&#1080;&#1089;&#1083;&#1086; 2 &#1082; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1103;&#1077;&#1084;&#1086;&#1084;&#1091; &#1074; &#1085;&#1072;&#1089;&#1090;&#1086;&#1103;&#1097;&#1080;&#1081; &#1084;&#1086;&#1084;&#1077;&#1085;&#1090; &#1089;&#1083;&#1086;&#1074;&#1091;
</span><span style="color: #00ffff;">;</span>
</pre>
</div>

<p>
Таким образом, вы можете сделать:
</p>

<div class="org-src-container">

<pre class="src src-forth">: DOUBLE LIT2 * <span style="color: #00ffff;">;</span>
</pre>
</div>

<p>
(Если вы не понимаете, как работает LIT2, вы должны просмотреть материал о компиляции
слов и немедленном режиме).
</p>

<p>
Это ассемблерное определение <code> ' </code> использует чит, который я скопировал из buzzard92. В
результате он работает только в скомпилированном коде. Можно написать версию <code> ' </code> на
основе <code>WORD</code>, <code>FIND</code>, <code>&gt;CFA</code>, которая также работает в немедленном режиме.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_tick"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"'"</span>,1,,TICK
    <span style="color: #00ffff;">lodsl</span>                   # &#1055;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1072;&#1076;&#1088;&#1077;&#1089; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1077;&#1075;&#1086; &#1089;&#1083;&#1086;&#1074;&#1072; &#1080; &#1087;&#1088;&#1086;&#1087;&#1091;&#1089;&#1090;&#1080;&#1090;&#1100; &#1077;&#1075;&#1086;
    <span style="color: #00ffff;">pushl</span>    <span style="color: #eedd82;">%eax</span>           # Push &#1077;&#1075;&#1086; &#1074; &#1089;&#1090;&#1077;&#1082;
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-unnumbered-24" class="outline-3">
<h3 id="unnumbered-24">Ветвление</h3>
<div class="outline-text-3" id="text-unnumbered-24">
<p>
Оказывается, все, что вам нужно для определения циклов, IF-выражений и.т.д. - это два
примитива.
</p>

<p>
BRANCH - безусловная ветвь (эквивалентная команде безусловного перехода
ассемблера). 0BRANCH - условная ветвь (переход будет осуществлен, если значение на
вершине стека равно нулю).
</p>

<p>
Диаграмма ниже показывает, как BRANCH работает в некотором воображаемом
скомпилированном слове. Когда BRANCH выполняется, <code>%esi</code> указывает на поле
смещения. Это поле содержит число байт, на которое должен быть передвинут указатель
исполняемой инструкции в ESI, чтобы пропустить то, что обозначено как "пропущено"
(сравните с LIT выше):
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-27.png" alt="forth-interpret-27.png">
</p>
</div>

<p>
Смещение добавляется к <code>%esi</code>, чтобы сформировать новый <code>%esi</code>, и результатом является
то, что при выполнении NEXT выполнение продолжается по целевому адресу
ветки. Отрицательные смещения тоже работают, как ожидается.
</p>

<p>
0BRANCH - это то же самое, за исключением того, что ветвление происходит по условию.
</p>

<p>
Теперь стандартные Forth слова, такие как IF, THEN, ELSE, WHILE, REPEAT и т. Д., Могут
быть полностью реализованы в Forth. Это НЕМЕДЛЕННЫЕ слова, которые добавляют различные
комбинации BRANCH или 0BRANCH в слово, которое в настоящее время компилируется.
</p>

<p>
Например, код, написанный следующим образом:
</p>

<div class="org-src-container">

<pre class="src src-forth">condition-code IF true-part <span style="color: #ffc0cb; font-weight: bold;">THEN </span>rest-code
</pre>
</div>

<p>
компилируется в:
</p>


<div class="figure">
<p><img src="../../../img/forth-interpret-28.png" alt="forth-interpret-28.png">
</p>
</div>

<p>
Вот определение:
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_branch"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"BRANCH"</span>,6,,BRANCH
    <span style="color: #00ffff;">add</span>     (<span style="color: #eedd82;">%esi</span>),<span style="color: #eedd82;">%esi</span>     # &#1076;&#1086;&#1073;&#1072;&#1074;&#1080;&#1090;&#1100; offset &#1082; instruction pointer
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"0BRANCH"</span>,7,,ZBRANCH
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>      # &#1042;&#1077;&#1088;&#1096;&#1080;&#1085;&#1072; &#1089;&#1090;&#1077;&#1082;&#1072; &#1088;&#1072;&#1074;&#1085;&#1072; &#1085;&#1091;&#1083;&#1102;?
    <span style="color: #00ffff;">jz</span>      code_BRANCH     # &#1045;&#1089;&#1083;&#1080; &#1076;&#1072;, &#1074;&#1077;&#1088;&#1085;&#1091;&#1090;&#1100;&#1089;&#1103; &#1085;&#1072;&#1079;&#1072;&#1076; &#1082; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080; BRANCH &#1074;&#1099;&#1096;&#1077;
    <span style="color: #00ffff;">lodsl</span>                   # &#1080;&#1085;&#1072;&#1095;&#1077; &#1087;&#1088;&#1086;&#1087;&#1091;&#1089;&#1090;&#1080;&#1090;&#1100; &#1089;&#1084;&#1077;&#1097;&#1077;&#1085;&#1080;&#1077;
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-25" class="outline-3">
<h3 id="unnumbered-25">Строковые литералы - LITSTRING</h3>
<div class="outline-text-3" id="text-unnumbered-25">
<p>
LITSTRING - это примитив, используемый для реализации операторов <code> ." </code> И <code> S" </code> (которые
написаны в формате Forth). См. ниже определение этих операторов.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_lit"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"LITSTRING"</span>,9,,LITSTRING
    <span style="color: #00ffff;">lodsl</span>                   # &#1055;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1076;&#1083;&#1080;&#1085;&#1091; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%esi</span>            # push &#1072;&#1076;&#1088;&#1077;&#1089; &#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>            # push &#1076;&#1083;&#1080;&#1085;&#1091;
    <span style="color: #00ffff;">addl</span>    <span style="color: #eedd82;">%eax</span>,<span style="color: #eedd82;">%esi</span>       # &#1087;&#1088;&#1086;&#1087;&#1091;&#1089;&#1090;&#1080;&#1090;&#1100; &#1089;&#1090;&#1088;&#1086;&#1082;&#1091;
    <span style="color: #00ffff;">addl</span>    $3,<span style="color: #eedd82;">%esi</span>         # &#1085;&#1086; &#1086;&#1082;&#1088;&#1091;&#1075;&#1083;&#1080;&#1090;&#1100; &#1076;&#1086; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1077;&#1081; 4 &#1073;&#1072;&#1081;&#1090;&#1086;&#1074;&#1086;&#1081; &#1075;&#1088;&#1072;&#1085;&#1080;&#1094;&#1099;
    <span style="color: #00ffff;">andl</span>    $~3,<span style="color: #eedd82;">%esi</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-26" class="outline-3">
<h3 id="unnumbered-26">Печать строки - TELL</h3>
<div class="outline-text-3" id="text-unnumbered-26">
<p>
TELL просто печатает строку. Это более эффективно определять в ассемблере, потому что
мы можем сделать это одним из системных вызовов Linux.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_tell"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"TELL"</span>,4,,TELL
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%edx</span>                # param3: &#1076;&#1083;&#1080;&#1085;&#1072; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%ecx</span>                # param2: &#1072;&#1076;&#1088;&#1077;&#1089; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">mov</span>     $stdout, <span style="color: #eedd82;">%ebx</span>       # param1: stdout
    <span style="color: #00ffff;">mov</span>     $sys_write, <span style="color: #eedd82;">%eax</span>    # SYSCALL #4 (write)
    <span style="color: #00ffff;">int</span>     $0x80
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-27" class="outline-3">
<h3 id="unnumbered-27">QUIT</h3>
<div class="outline-text-3" id="text-unnumbered-27">
<p>
QUIT - первая функция Forth, вызываемая почти сразу после того, как система Forth
загружается. Как объяснялось ранее, QUIT никуда не "уходит". Она выполняет некоторую
инициализацию (в частности, она очищает стек возвратов), и вызывает INTERPRET в цикле
для интерпретации команд.
</p>

<p>
Причина, по которой он называется QUIT, заключается в том, что вы можете вызвать его из
собственных слов Forth, чтобы "выйти" из вашей программы и начать снова работать в
режиме приема команд от пользователя.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_quit"># QUIT &#1085;&#1077; &#1076;&#1086;&#1083;&#1078;&#1085;&#1072; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1090;&#1100;&#1089;&#1103; (&#1090;&#1077; &#1077;&#1089;&#1090;&#1100; &#1074;&#1099;&#1079;&#1099;&#1074;&#1072;&#1090;&#1100; EXIT).
<span style="color: #87cefa;">defword</span> <span style="color: #ffa07a;">"QUIT"</span>,4,,QUIT
    # &#1055;&#1086;&#1083;&#1086;&#1078;&#1080;&#1090;&#1100; &#1082;&#1086;&#1085;&#1089;&#1090;&#1072;&#1085;&#1090;&#1091; RZ (&#1085;&#1072;&#1095;&#1072;&#1083;&#1100;&#1085;&#1086;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1089;&#1090;&#1077;&#1082;&#1072; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074;) &#1085;&#1072; &#1089;&#1090;&#1077;&#1082; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;&#1086;&#1074;.
    <span style="color: #00ffff;">.int</span> RZ
    # &#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077;, &#1083;&#1077;&#1078;&#1072;&#1097;&#1077;&#1077; &#1085;&#1072; &#1089;&#1090;&#1077;&#1082;&#1077; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;&#1086;&#1074;, &#1082;&#1072;&#1082; &#1085;&#1086;&#1074;&#1086;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1074;&#1077;&#1088;&#1096;&#1080;&#1085;&#1099; &#1089;&#1090;&#1077;&#1082;&#1072; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074;
    <span style="color: #00ffff;">.int</span> RSPSTORE       # &#1069;&#1090;&#1086; &#1086;&#1095;&#1080;&#1097;&#1072;&#1077;&#1090; &#1089;&#1090;&#1077;&#1082; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074;
    # &#1047;&#1072;&#1087;&#1091;&#1089;&#1090;&#1080;&#1090;&#1100; &#1080;&#1085;&#1090;&#1077;&#1088;&#1087;&#1088;&#1077;&#1090;&#1072;&#1090;&#1086;&#1088; &#1082;&#1086;&#1084;&#1072;&#1085;&#1076;                  &lt;-----+
    <span style="color: #00ffff;">.int</span> INTERPRET      # &#1048;&#1085;&#1090;&#1077;&#1088;&#1087;&#1088;&#1077;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1077;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086;  |
    # &#1048; &#1085;&#1072;&#1074;&#1089;&#1077;&#1075;&#1076;&#1072; &#1079;&#1072;&#1094;&#1080;&#1082;&#1083;&#1080;&#1090;&#1100;&#1089;&#1103;                                |
    <span style="color: #00ffff;">.int</span> BRANCH,-8      # -----------------------------------
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-28" class="outline-3">
<h3 id="unnumbered-28">INTERPRET</h3>
<div class="outline-text-3" id="text-unnumbered-28">
<p>
INTERPRET является REPL (см.: <a href="http://en.wikipedia.org/wiki/REPL">http://en.wikipedia.org/wiki/REPL</a>) внутри Forth.
</p>

<p>
Этот интерпретатор довольно прост, но помните, что в Forth вы всегда можете
переопределить его более мощным!
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_interpret"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"INTERPRET"</span>,9,,INTERPRET
    <span style="color: #00ffff;">call</span>    _WORD           # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; <span style="color: #eedd82;">%ecx</span> = &#1076;&#1083;&#1080;&#1085;&#1091;, <span style="color: #eedd82;">%edi</span> = &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1089;&#1083;&#1086;&#1074;&#1086;.
    # &#1045;&#1089;&#1090;&#1100; &#1083;&#1080; &#1089;&#1083;&#1086;&#1074;&#1086; &#1074; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1077;?
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">movl</span>    <span style="color: #eedd82;">%eax</span>, (interpret_is_lit)    # &#1069;&#1090;&#1086; &#1085;&#1077; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083; (&#1080;&#1083;&#1080; &#1087;&#1086;&#1082;&#1072; &#1085;&#1077; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;)
    <span style="color: #00ffff;">call</span>    _FIND           #           # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; &#1074; <span style="color: #eedd82;">%eax</span> &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1079;&#1072;&#1075;&#1086;&#1083;&#1086;&#1074;&#1086;&#1082; &#1080;&#1083;&#1080; 0
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>      #           # (&#1057;&#1086;&#1074;&#1087;&#1072;&#1076;&#1077;&#1085;&#1080;&#1077;)?
    <span style="color: #00ffff;">jz</span>  1f                  #--------+  # ?-&#1053;&#1077; &#1076;&#1091;&#1084;&#1072;&#1102;! &#1055;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076; &#1074;&#1087;&#1077;&#1088;&#1077;&#1076; &#1082; (1)
    # &#1069;&#1090;&#1086; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1085;&#1086;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086;   #        |  # ?-&#1044;&#1072;. &#1053;&#1072;&#1081;&#1076;&#1077;&#1085;&#1086; &#1089;&#1086;&#1074;&#1087;&#1072;&#1076;&#1072;&#1102;&#1097;&#1077;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086;. &#1055;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1072;&#1077;&#1084;.
    # &#1069;&#1090;&#1086; IMMEDIATE-&#1089;&#1083;&#1086;&#1074;&#1086;?  #        |  #
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%edi</span>      #        |  # <span style="color: #eedd82;">%edi</span> = &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1089;&#1083;&#1086;&#1074;&#1086;
    <span style="color: #00ffff;">movb</span>    4(<span style="color: #eedd82;">%edi</span>), <span style="color: #eedd82;">%al</span>    #        |  # <span style="color: #eedd82;">%al</span> = flags+length.
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>            #        |  # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1084; &#1077;&#1075;&#1086; (flags+length) &#1085;&#1077;&#1085;&#1072;&#1076;&#1086;&#1083;&#1075;&#1086;
    <span style="color: #00ffff;">call</span>    _TCFA           #        |  # &#1055;&#1088;&#1077;&#1086;&#1073;&#1088;&#1072;&#1079;&#1091;&#1077;&#1084; entry (&#1074; <span style="color: #eedd82;">%edi</span>) &#1074; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; codeword
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%eax</span>            #        |  # &#1042;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1084; flags+length
    <span style="color: #00ffff;">andb</span>    $F_IMMED, <span style="color: #eedd82;">%al</span>   #        |  # (&#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1083;&#1077;&#1085; &#1092;&#1083;&#1072;&#1075; F_IMMED)?
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%edi</span>, <span style="color: #eedd82;">%eax</span>      #        |  # <span style="color: #eedd82;">%edi</span>-&gt;<span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">jnz</span>     4f              #--------|-+# ?-&#1044;&#1072;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1089;&#1088;&#1072;&#1079;&#1091; &#1082; &#1074;&#1099;&#1087;&#1086;&#1083;&#1085;&#1077;&#1085;&#1080;&#1102; (4)
    <span style="color: #00ffff;">jmp</span> 2f                  #--+     | |# ?-&#1053;&#1077;&#1090;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1082; &#1087;&#1088;&#1086;&#1074;&#1077;&#1088;&#1082;&#1077; &#1088;&#1077;&#1078;&#1080;&#1084;&#1072; &#1088;&#1072;&#1073;&#1086;&#1090;&#1099; (2)
    # --------------------- #  |     | |# -------------------------------------------------
<span style="color: #87cefa;">1</span>:  #                   &lt;------|-----+ |
    # &#1053;&#1077;&#1090; &#1074; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1077;, &#1073;&#1091;&#1076;&#1077;&#1084; &#1089;&#1095;&#1080;&#1090;&#1072;&#1090;&#1100;, &#1095;&#1090;&#1086; &#1101;&#1090;&#1086; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;
    <span style="color: #00ffff;">incl</span>    (interpret_is_lit)#|       |# &#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1084; &#1092;&#1083;&#1072;&#1075;
    <span style="color: #00ffff;">call</span>    _NUMBER         #  |       |# &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; &#1095;&#1080;&#1089;&#1083;&#1086; &#1074; in <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%ecx</span> &gt; 0 &#1077;&#1089;&#1083;&#1080; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072;
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%ecx</span>, <span style="color: #eedd82;">%ecx</span>      #  |       |# (&#1059;&#1076;&#1072;&#1083;&#1086;&#1089;&#1100; &#1088;&#1072;&#1089;&#1087;&#1072;&#1088;&#1089;&#1080;&#1090;&#1100; &#1095;&#1080;&#1089;&#1083;&#1086;)?
    <span style="color: #00ffff;">jnz</span> 6f                  #--|-----+ |# ?-&#1053;&#1077;&#1090;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1082; (6)
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%ebx</span>      #  |     | |# ?-&#1044;&#1072;, &#1055;&#1077;&#1088;&#1077;&#1084;&#1077;&#1097;&#1072;&#1077;&#1084; &#1095;&#1080;&#1089;&#1083;&#1086; &#1074; <span style="color: #eedd82;">%ebx</span>,
    <span style="color: #00ffff;">mov</span>     $LIT, <span style="color: #eedd82;">%eax</span>      #  |     | |#     &#1059;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; &#1089;&#1083;&#1086;&#1074;&#1086; LIT &#1074; <span style="color: #eedd82;">%eax</span> &lt;&#1047;&#1040;&#1063;&#1045;&#1052;????&gt;
<span style="color: #87cefa;">2</span>:  #                   &lt;------+     | |#
    # &#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1080;&#1084; &#1074; &#1082;&#1072;&#1082;&#1086;&#1084; &#1084;&#1099; &#1088;&#1077;&#1078;&#1080;&#1084;&#1077;     | |#
    <span style="color: #00ffff;">movl</span>    (var_STATE), <span style="color: #eedd82;">%edx</span>#       | |#
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%edx</span>, <span style="color: #eedd82;">%edx</span>      #        | |#     (&#1052;&#1099; &#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084;&#1089;&#1103; &#1080;&#1083;&#1080; &#1074;&#1099;&#1087;&#1086;&#1083;&#1085;&#1103;&#1077;&#1084;&#1089;&#1103;)?
    <span style="color: #00ffff;">jz</span>  4f                  #-----+  | |#     ?-&#1042;&#1099;&#1087;&#1086;&#1083;&#1085;&#1103;&#1077;&#1084;&#1089;&#1103;. &#1055;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1082; (4)
    <span style="color: #00ffff;">call</span>    _COMMA          #     |  | |#     ?-&#1050;&#1086;&#1084;&#1087;&#1080;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084;&#1089;&#1103;. &#1044;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1085;&#1086;&#1077; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1077;
    <span style="color: #00ffff;">mov</span>     (interpret_is_lit), <span style="color: #eedd82;">%ecx</span>#| |#
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%ecx</span>, <span style="color: #eedd82;">%ecx</span>      #     |  | |#       (&#1069;&#1090;&#1086; &#1073;&#1099;&#1083; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;)?
    <span style="color: #00ffff;">jz</span>      3f              #--+  |  | |#       ?-&#1053;&#1077;&#1090;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1082; NEXT
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%ebx</span>, <span style="color: #eedd82;">%eax</span>      #  |  |  | |#       ?-&#1044;&#1072;, &#1087;&#1086;&#1101;&#1090;&#1086;&#1084;&#1091; &#1079;&#1072; LIT &#1089;&#1083;&#1077;&#1076;&#1091;&#1077;&#1090; &#1095;&#1080;&#1089;&#1083;&#1086;,
    <span style="color: #00ffff;">call</span>    _COMMA          #  |  |  | |#            &#1074;&#1099;&#1079;&#1099;&#1074;&#1072;&#1077;&#1084; _COMMA, &#1095;&#1090;&#1086;&#1073;&#1099; &#1089;&#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1080;&#1090;&#1100; &#1077;&#1075;&#1086;
<span style="color: #87cefa;">3</span>:  #                   &lt;------+  |  | |#
    <span style="color: #00ffff;">NEXT</span>                    #     |  | |# NEXT
    # ---------------------       |  | |# -------------------------------------------------
<span style="color: #87cefa;">4</span>:  #                   &lt;---------+&lt;-|-+
    # &#1042;&#1099;&#1087;&#1086;&#1083;&#1085;&#1103;&#1077;&#1084;&#1089;&#1103;                    |
    <span style="color: #00ffff;">mov</span>     (interpret_is_lit), <span style="color: #eedd82;">%ecx</span>#|
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%ecx</span>, <span style="color: #eedd82;">%ecx</span>      #        |  # (&#1069;&#1090;&#1086; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;)?
    <span style="color: #00ffff;">jnz</span> 5f                  #--+     |  # ?-&#1044;&#1072;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1082; (5)
    # &#1053;&#1077; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;, &#1074;&#1099;&#1087;&#1086;&#1083;&#1085;&#1080;&#1084; &#1087;&#1088;&#1103;&#1084;&#1086; &#1089;&#1077;&#1081;&#1095;&#1072;&#1089;. &#1052;&#1099; &#1085;&#1077; &#1086;&#1089;&#1091;&#1097;&#1077;&#1089;&#1090;&#1074;&#1083;&#1103;&#1077;&#1084; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1072;, &#1085;&#1086;
    # codeword &#1074; &#1082;&#1086;&#1085;&#1077;&#1095;&#1085;&#1086;&#1084; &#1080;&#1090;&#1086;&#1075;&#1077; &#1074;&#1099;&#1079;&#1086;&#1074;&#1077;&#1090; NEXT, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1081; &#1087;&#1086;&#1074;&#1090;&#1086;&#1088;&#1085;&#1086; &#1074;&#1077;&#1088;&#1085;&#1077;&#1090; &#1094;&#1080;&#1082;&#1083; &#1074; QUIT
    <span style="color: #00ffff;">jmp</span>     *(<span style="color: #eedd82;">%eax</span>)         #  |     |
    # --------------------- #  |     |  # -------------------------------------------------
<span style="color: #87cefa;">5</span>:  #                    &lt;-----+     |
    # &#1042;&#1099;&#1087;&#1086;&#1083;&#1085;&#1103;&#1077;&#1084; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;, &#1095;&#1090;&#1086; &#1086;&#1079;&#1085;&#1072;&#1095;&#1072;&#1077;&#1090;, &#1095;&#1090;&#1086; &#1084;&#1099; push-&#1080;&#1084; &#1077;&#1075;&#1086; &#1074; &#1089;&#1090;&#1077;&#1082; &#1080; &#1076;&#1077;&#1083;&#1072;&#1077;&#1084; NEXT
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%ebx</span>            #        |
    <span style="color: #00ffff;">NEXT</span>                    #        |
<span style="color: #87cefa;">6</span>:  #                    &lt;-----------+
    # &#1052;&#1099; &#1079;&#1076;&#1077;&#1089;&#1100;, &#1077;&#1089;&#1083;&#1080; &#1085;&#1077; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1083;&#1086;&#1089;&#1100; &#1088;&#1072;&#1089;&#1087;&#1072;&#1088;&#1089;&#1080;&#1090;&#1100; &#1095;&#1080;&#1089;&#1083;&#1086; &#1074; &#1090;&#1077;&#1082;&#1091;&#1097;&#1077;&#1081; &#1073;&#1072;&#1079;&#1077; &#1080;&#1083;&#1080; &#1101;&#1090;&#1086;&#1075;&#1086;
    # &#1089;&#1083;&#1086;&#1074;&#1072; &#1085;&#1077;&#1090; &#1074; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1077;. &#1055;&#1077;&#1095;&#1072;&#1090;&#1072;&#1077;&#1084; &#1089;&#1086;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1077; &#1086;&#1073; &#1086;&#1096;&#1080;&#1073;&#1082;&#1077; &#1080; 40 &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074; &#1082;&#1086;&#1085;&#1090;&#1077;&#1082;&#1089;&#1090;&#1072;.
    <span style="color: #00ffff;">mov</span>     $sys_write, <span style="color: #eedd82;">%eax</span>#           # SYSCALL #4 (write)
    <span style="color: #00ffff;">mov</span>     $stderr, <span style="color: #eedd82;">%ebx</span>   #           # param1: stderr
    <span style="color: #00ffff;">mov</span>     $errmsg, <span style="color: #eedd82;">%ecx</span>   #           # param2: &#1042;&#1099;&#1074;&#1086;&#1076;&#1080;&#1084;&#1072;&#1103; &#1089;&#1090;&#1088;&#1086;&#1082;&#1072;
    <span style="color: #00ffff;">mov</span>     $errmsgend-errmsg, <span style="color: #eedd82;">%edx</span>     # param3: &#1044;&#1083;&#1080;&#1085;&#1072; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1084;&#1086;&#1081; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">int</span>     $0x80           #           # SYSCALL
    # &#1054;&#1096;&#1080;&#1073;&#1082;&#1072; &#1087;&#1088;&#1086;&#1080;&#1079;&#1086;&#1096;&#1083;&#1072; &#1087;&#1077;&#1088;&#1077;&#1076; currkey
    <span style="color: #00ffff;">mov</span>     (currkey), <span style="color: #eedd82;">%ecx</span> #
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%ecx</span>, <span style="color: #eedd82;">%edx</span>      #
    <span style="color: #00ffff;">sub</span>     $input_buffer, <span style="color: #eedd82;">%edx</span>         # <span style="color: #eedd82;">%edx</span> = (currkey - buffer) (&#1076;&#1083;&#1080;&#1085;&#1072; &#1073;&#1091;&#1092;&#1077;&#1088;&#1072; &#1087;&#1077;&#1088;&#1077;&#1076; currkey)
    <span style="color: #00ffff;">cmp</span>     $40, <span style="color: #eedd82;">%edx</span>       #           # (if &gt; 40)?
    <span style="color: #00ffff;">jle</span> 7f                  #--+        # ?-&#1053;&#1077;&#1090;, &#1087;&#1077;&#1095;&#1072;&#1090;&#1072;&#1077;&#1084; &#1074;&#1089;&#1077;
    <span style="color: #00ffff;">mov</span>     $40, <span style="color: #eedd82;">%edx</span>       #  |        # ?-&#1044;&#1072;, &#1087;&#1077;&#1095;&#1072;&#1090;&#1072;&#1090;&#1100; &#1090;&#1086;&#1083;&#1100;&#1082;&#1086; 40 &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074;
<span style="color: #87cefa;">7</span>:  #                    &lt;-----+
    <span style="color: #00ffff;">sub</span>     <span style="color: #eedd82;">%edx</span>, <span style="color: #eedd82;">%ecx</span>      #           # <span style="color: #eedd82;">%ecx</span> = start of area to print, <span style="color: #eedd82;">%edx</span> = length
    <span style="color: #00ffff;">mov</span>     $sys_write, <span style="color: #eedd82;">%eax</span>            # SYSCALL #4 (write)
    <span style="color: #00ffff;">int</span>     $0x80           #           # SYSCALL
    # &#1042;&#1099;&#1074;&#1077;&#1076;&#1077;&#1084; &#1087;&#1077;&#1088;&#1077;&#1074;&#1086;&#1076; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">mov</span>     $sys_write, <span style="color: #eedd82;">%eax</span>            # SYSCALL #4 (write)
    <span style="color: #00ffff;">mov</span>     $errmsgnl, <span style="color: #eedd82;">%ecx</span> #           # newline
    <span style="color: #00ffff;">mov</span>     $1, <span style="color: #eedd82;">%edx</span>        #           # &#1044;&#1083;&#1080;&#1085;&#1072;
    <span style="color: #00ffff;">int</span>     $0x80           #           # SYSCALL
    <span style="color: #00ffff;">NEXT</span>                    #           # NEXT
    # ---------------------
    <span style="color: #00ffff;">.section</span> .rodata
<span style="color: #87cefa;">errmsg</span>:
    <span style="color: #00ffff;">.ascii</span> <span style="color: #ffa07a;">"PARSE ERROR: "</span>
<span style="color: #87cefa;">errmsgend</span>:
<span style="color: #87cefa;">errmsgnl</span>:
    <span style="color: #00ffff;">.ascii</span> <span style="color: #ffa07a;">"\n"</span>

    <span style="color: #00ffff;">.data</span>                   # NB: &#1087;&#1088;&#1086;&#1097;&#1077; &#1079;&#1072;&#1087;&#1080;&#1089;&#1072;&#1090;&#1100; &#1074; .data section
    <span style="color: #00ffff;">.align</span> 4
<span style="color: #87cefa;">interpret_is_lit</span>:
    <span style="color: #00ffff;">.int</span> 0                  # &#1060;&#1083;&#1072;&#1075; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;&#1072;
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-29" class="outline-3">
<h3 id="unnumbered-29">CHAR</h3>
<div class="outline-text-3" id="text-unnumbered-29">
<p>
CHAR помещает код ASCII первого символа следующего слова в стек. Например, <code>CHAR A</code>
кладет 65 в стек.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_char"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"CHAR"</span>,4,,CHAR
    <span style="color: #00ffff;">call</span>    _WORD           # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; <span style="color: #eedd82;">%ecx</span> = length, <span style="color: #eedd82;">%edi</span> = &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1089;&#1083;&#1086;&#1074;&#1086;.
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%eax</span>, <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">movb</span>    (<span style="color: #eedd82;">%edi</span>), <span style="color: #eedd82;">%al</span>     # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1087;&#1077;&#1088;&#1074;&#1099;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; &#1089;&#1083;&#1086;&#1074;&#1072;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>            # &#1050;&#1083;&#1072;&#1076;&#1077;&#1084; &#1077;&#1075;&#1086; &#1074; &#1089;&#1090;&#1077;&#1082;
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-30" class="outline-3">
<h3 id="unnumbered-30">EXECUTE</h3>
<div class="outline-text-3" id="text-unnumbered-30">
<p>
EXECUTE используется для запуска токенов выполнения. См. обсуждение токенов выполнения
в коде Forth для получения более подробной информации.
</p>

<p>
С точки зрения реализации EXECUTE делает следующее:
</p>
<ul class="org-ul">
<li>берет указатель на <code>codeword</code> слова, которое нужно выполнить.
</li>
<li>т.к. этот <code>codeword</code> сам является указателем на процедуру выполнения (такую, как
DOCON) - осуществляется переход по нему. Т.е. управление передается этой процедуре.
</li>
</ul>

<p>
После перехода на токен его NEXT выйдет из текущего слова.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_execute"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"EXECUTE"</span>,7,,EXECUTE
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%eax</span>            # &#1055;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1090;&#1086;&#1082;&#1077;&#1085; &#1074;&#1099;&#1087;&#1086;&#1083;&#1085;&#1077;&#1085;&#1080;&#1103; &#1074; <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">jmp</span>     *(<span style="color: #eedd82;">%eax</span>)         # &#1080; &#1074;&#1099;&#1087;&#1086;&#1083;&#1085;&#1080;&#1090;&#1100; jump &#1085;&#1072; &#1085;&#1077;&#1075;&#1086;.
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-31" class="outline-3">
<h3 id="unnumbered-31">DODOES</h3>
<div class="outline-text-3" id="text-unnumbered-31">
<p>
Работа этого кода объясняется во второй части
</p>

<div class="org-src-container">

<pre class="src src-asm" id="dodoes"><span style="color: #87cefa;">DODOES</span>:
    <span style="color: #00ffff;">PUSHRSP</span> <span style="color: #eedd82;">%esi</span>            # (&#1089;) &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1077;&#1084; ESI &#1085;&#1072; &#1089;&#1090;&#1077;&#1082;&#1077; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074;

    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%esi</span>            # (b,d) CALL-RETADDR -&gt; ESI

    <span style="color: #00ffff;">lea</span>     4(<span style="color: #eedd82;">%eax</span>), <span style="color: #eedd82;">%eax</span>   # (a) &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1080;&#1090;&#1100; param-field DEUX
    <span style="color: #00ffff;">pushl</span>   <span style="color: #eedd82;">%eax</span>            # (a) push &#1077;&#1075;&#1086; &#1085;&#1072; &#1089;&#1090;&#1077;&#1082; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;

    <span style="color: #00ffff;">NEXT</span>                    # (e) &#1074;&#1099;&#1079;&#1074;&#1072;&#1090;&#1100; &#1080;&#1085;&#1090;&#1077;&#1088;&#1087;&#1088;&#1077;&#1090;&#1072;&#1090;&#1086;&#1088;

<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"DODOES_ADDR"</span>,11,,DODOES_ADDR,DODOES
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-32" class="outline-3">
<h3 id="unnumbered-32">Системные вызовы</h3>
<div class="outline-text-3" id="text-unnumbered-32">
<p>
SYSCALL0, SYSCALL1, SYSCALL2, SYSCALL3 делают стандартный системный вызов Linux.  (См.
список номеров системных вызовов). Как видно из названия, эти формы занимают от 0 до 3
параметров syscall, а также номер системного вызова.
</p>

<p>
В этом Forth SYSCALL0 должен быть последним словом во встроенном (ассемблерном)
словаре, потому что мы инициализируем переменную LATEST, чтобы указать на нее. Это
означает, что если вы хотите расширить ассемблерную часть, вы должны поместить новые
слова перед SYSCALL0 или изменить способ инициализации LATEST.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_syscalls"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"SYSCALL3"</span>,8,,SYSCALL3
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%eax</span>            # &#1053;&#1086;&#1084;&#1077;&#1088; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1086;&#1075;&#1086; &#1074;&#1099;&#1079;&#1086;&#1074;&#1072; (&#1089;&#1084;. &lt;asm/unistd.h&gt;)
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%ebx</span>            # &#1055;&#1077;&#1088;&#1074;&#1099;&#1081; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;.
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%ecx</span>            # &#1042;&#1090;&#1086;&#1088;&#1086;&#1081; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%edx</span>            # &#1058;&#1088;&#1077;&#1090;&#1080;&#1081; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;
    <span style="color: #00ffff;">int</span>     $0x80
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>            # &#1056;&#1077;&#1079;&#1091;&#1083;&#1100;&#1090;&#1072;&#1090;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"SYSCALL2"</span>,8,,SYSCALL2
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%eax</span>            # &#1053;&#1086;&#1084;&#1077;&#1088; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1086;&#1075;&#1086; &#1074;&#1099;&#1079;&#1086;&#1074;&#1072; (&#1089;&#1084;. &lt;asm/unistd.h&gt;)
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%ebx</span>            # &#1055;&#1077;&#1088;&#1074;&#1099;&#1081; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;.
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%ecx</span>            # &#1042;&#1090;&#1086;&#1088;&#1086;&#1081; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;
    <span style="color: #00ffff;">int</span>     $0x80
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>            # &#1056;&#1077;&#1079;&#1091;&#1083;&#1100;&#1090;&#1072;&#1090;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"SYSCALL1"</span>,8,,SYSCALL1
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%eax</span>            # &#1053;&#1086;&#1084;&#1077;&#1088; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1086;&#1075;&#1086; &#1074;&#1099;&#1079;&#1086;&#1074;&#1072; (&#1089;&#1084;. &lt;asm/unistd.h&gt;)
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%ebx</span>            # &#1055;&#1077;&#1088;&#1074;&#1099;&#1081; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;.
    <span style="color: #00ffff;">int</span>     $0x80
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>            # &#1056;&#1077;&#1079;&#1091;&#1083;&#1100;&#1090;&#1072;&#1090;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"SYSCALL0"</span>,8,,SYSCALL0
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%eax</span>            # &#1053;&#1086;&#1084;&#1077;&#1088; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1086;&#1075;&#1086; &#1074;&#1099;&#1079;&#1086;&#1074;&#1072; (&#1089;&#1084;. &lt;asm/unistd.h&gt;)
    <span style="color: #00ffff;">int</span>     $0x80
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%eax</span>            # &#1056;&#1077;&#1079;&#1091;&#1083;&#1100;&#1090;&#1072;&#1090;
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-33" class="outline-3">
<h3 id="unnumbered-33">Сегмент стека и буффер ввода</h3>
<div class="outline-text-3" id="text-unnumbered-33">
<div class="org-src-container">

<pre class="src src-asm" id="sys_ret_stack_and_input_buffer">    <span style="color: #00ffff;">.bss</span>

    # &#1057;&#1090;&#1077;&#1082; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074; Forth
    <span style="color: #00ffff;">.set</span> RETURN_STACK_SIZE,8192
    <span style="color: #00ffff;">.align</span> 4096
<span style="color: #87cefa;">return_stack</span>:
    <span style="color: #00ffff;">.space</span> RETURN_STACK_SIZE
<span style="color: #87cefa;">return_stack_top</span>:           # Initial top of return stack.

    # &#1041;&#1091;&#1092;&#1077;&#1088; &#1074;&#1074;&#1086;&#1076;&#1072;
    <span style="color: #00ffff;">.set</span> INPUT_BUFFER_SIZE,4096
    <span style="color: #00ffff;">.align</span> 4096
<span style="color: #87cefa;">input_buffer</span>:
    <span style="color: #00ffff;">.space</span> INPUT_BUFFER_SIZE

    # &#1041;&#1091;&#1092;&#1077;&#1088; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; - c&#1102;&#1076;&#1072; &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; HERE
    <span style="color: #00ffff;">.set</span> INITIAL_DATA_SEGMENT_SIZE,65536
    <span style="color: #00ffff;">.align</span> 4096
<span style="color: #87cefa;">data_buffer</span>:
    <span style="color: #00ffff;">.space</span> INITIAL_DATA_SEGMENT_SIZE
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-unnumbered-34" class="outline-2">
<h2 id="unnumbered-34">Tangling</h2>
<div class="outline-text-2" id="text-unnumbered-34">
<p>
Теперь мы можем переходить к высокоуровневой части. Она лежит в разделе: <a href="jonesforth-2.html">Forth-часть</a>
</p>

<p>
А тут осталась только сборка всего кода в один ассемблерный файл:
</p>

<div class="org-src-container">

<pre class="src src-asm" id="macros"><span style="color: #87cefa;">&lt;&lt;macro_next</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;macro_pushrsp</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;macro_poprsp</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;macro_defword</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;macro_defcode</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;macro_defvar</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;macro_defconst</span>&gt;&gt;
</pre>
</div>

<div class="org-src-container">

<pre class="src src-asm" id="assembly"><span style="color: #87cefa;">&lt;&lt;flags</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;macros</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;built_in_vars</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;built_in_constants</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;asm_docol</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;words_for_retstack</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;simple_primitives</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;mod</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;comparison</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;argc</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;argv</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;env</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;exit</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;store</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;char_store</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;data_stack_words</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_key</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_emit</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_word</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_find</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_tcfa</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_tdfa</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_number</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_lit</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_tell</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_create</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_comma</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_rbrac</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_colon</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_semicolon</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_immediate</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_hidden</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_tick</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_interpret</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_branch</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_quit</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_char</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_execute</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;dodoes</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_syscalls</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;asm_entry</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;sys_ret_stack_and_input_buffer</span>&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-35" class="outline-2">
<h2 id="unnumbered-35">Trobleshooting</h2>
<div class="outline-text-2" id="text-unnumbered-35">
<p>
Если при попытке собрать 32-разрядную версию из под 64-разрядной возникает ошибка вида:
</p>

<div class="org-src-container">

<pre class="src src-sh">make -f Makefile32
gcc -c -m32 -g -D_REENTRANT -I/usr/include/SDL2 -Iinc32 src32/sdlwrap32.c -o sdlwrap32.o
In file included from /usr/include/stdio.h:27:0,
                 from src32/sdlwrap32.c:2:
/usr/include/features.h:367:25: fatal error: sys/cdefs.h: &#1053;&#1077;&#1090; &#1090;&#1072;&#1082;&#1086;&#1075;&#1086; &#1092;&#1072;&#1081;&#1083;&#1072; &#1080;&#1083;&#1080; &#1082;&#1072;&#1090;&#1072;&#1083;&#1086;&#1075;&#1072;
compilation terminated.
Makefile32:45: &#1086;&#1096;&#1080;&#1073;&#1082;&#1072; &#1074;&#1099;&#1087;&#1086;&#1083;&#1085;&#1077;&#1085;&#1080;&#1103; &#1088;&#1077;&#1094;&#1077;&#1087;&#1090;&#1072; &#1076;&#1083;&#1103; &#1094;&#1077;&#1083;&#1080; &#171;sdlwrap32.o&#187;
make: *** [sdlwrap32.o] &#1054;&#1096;&#1080;&#1073;&#1082;&#1072; 1
</pre>
</div>

<p>
Следует поставить недостающие 32-разрядные библиотеки:
</p>

<div class="org-src-container">

<pre class="src src-sh">sudo apt install libc6-dev-i386 g++-multilib
</pre>
</div>

<p>
На самом дел это приведет к установке еще многих зависмостей:
</p>

<div class="org-src-container">

<pre class="src src-sh">g++-5-multilib g++-multilib gcc-5-multilib gcc-multilib lib32asan2
lib32atomic1 lib32cilkrts5 lib32gcc-5-dev lib32gcc1 lib32gomp1 lib32itm1
lib32mpx0 lib32quadmath0 lib32stdc++-5-dev lib32stdc++6 lib32ubsan0
libc6-dev-i386 libc6-dev-x32 libc6-i386 libc6-x32 libx32asan2 libx32atomic1
libx32cilkrts5 libx32gcc-5-dev libx32gcc1 libx32gomp1 libx32itm1
libx32quadmath0 libx32stdc++-5-dev libx32stdc++6 libx32ubsan0
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
