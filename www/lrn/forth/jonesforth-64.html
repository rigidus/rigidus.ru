<!DOCTYPE html>
<html>
<head>
<title></title>
<meta  charset="utf-8">
<meta  name="generator" content="Org-mode">
<meta  name="author" content="rigidus">
<link href="/css/style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="content">
<h1 class="title"></h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#unnumbered-1">Внутреннее устройство Forth-машины</a>
<ul>
<li><a href="#unnumbered-2">NEXT</a></li>
<li><a href="#unnumbered-3">Макросы для стека возвратов</a></li>
<li><a href="#unnumbered-4">DOCOL - интерпретатор</a></li>
<li><a href="#unnumbered-5">Ассемблерная точка входа</a></li>
<li><a href="#unnumbered-6">Сишная точка входа</a></li>
<li><a href="#unnumbered-7">Маски для FLAGS/LENGHT</a></li>
<li><a href="#unnumbered-8">Макросы DEFWORD и DEFCODE</a></li>
<li><a href="#unnumbered-9">Базовые примитивы</a></li>
<li><a href="#unnumbered-10">Cmdline слова</a></li>
<li><a href="#unnumbered-11">EXIT - Возвращение из форт-слов</a></li>
<li><a href="#unnumbered-12">Литералы</a></li>
<li><a href="#unnumbered-13">Память</a></li>
<li><a href="#unnumbered-14">Встроенные переменные</a></li>
<li><a href="#unnumbered-15">Встроенные константы</a></li>
<li><a href="#unnumbered-16">Стек возвратов</a></li>
<li><a href="#unnumbered-17">Стек данных</a></li>
<li><a href="#unnumbered-18">Ввод и вывод: KEY EMIT WORD NUMBER</a></li>
<li><a href="#unnumbered-19">FIND - просмотр словаря</a></li>
<li><a href="#unnumbered-20">Компиляция</a></li>
<li><a href="#unnumbered-21">Расширение компилятора</a>
<ul>
<li><a href="#unnumbered-22">IMMEDIATE</a></li>
<li><a href="#unnumbered-23">HIDDEN</a></li>
<li><a href="#unnumbered-24">TICK</a></li>
</ul>
</li>
<li><a href="#unnumbered-25">Ветвление</a></li>
<li><a href="#unnumbered-26">Строковые литералы - LITSTRING</a></li>
<li><a href="#unnumbered-27">Печать строки - TELL</a></li>
<li><a href="#unnumbered-28">QUIT</a></li>
<li><a href="#unnumbered-29">INTERPRET</a></li>
<li><a href="#unnumbered-30">CHAR</a></li>
<li><a href="#unnumbered-31">EXECUTE</a></li>
<li><a href="#unnumbered-32">DODOES</a></li>
<li><a href="#unnumbered-33">Системные вызовы</a></li>
<li><a href="#unnumbered-34">Сегмент стека и буффер ввода</a></li>
</ul>
</li>
<li><a href="#unnumbered-35">Дополнения</a>
<ul>
<li><a href="#unnumbered-36">Хэширование</a></li>
<li><a href="#unnumbered-37">Внешнее управление</a></li>
<li><a href="#unnumbered-38">Нода</a></li>
</ul>
</li>
<li><a href="#unnumbered-39">Tangling</a></li>
</ul>
</div>
</div>

<div id="outline-container-unnumbered-1" class="outline-2">
<h2 id="unnumbered-1">Внутреннее устройство Forth-машины</h2>
<div class="outline-text-2" id="text-unnumbered-1">
<p>
Теперь, обладая работающей 32-разрядной версией мы можем портировать ее на 64 разряда.
</p>
</div>

<div id="outline-container-unnumbered-2" class="outline-3">
<h3 id="unnumbered-2">NEXT</h3>
<div class="outline-text-3" id="text-unnumbered-2">
<p>
Теперь наш макрос <code>NEXT</code> будет делать то же самое, что и раньше но с увеличенным вдвое
размером адреса:
</p>

<div class="org-src-container">

<pre class="src src-asm" id="macro_next"><span style="color: #00ffff;">.macro</span> NEXT
    <span style="color: #00ffff;">lodsq</span>
    <span style="color: #00ffff;">jmp</span> *(<span style="color: #eedd82;">%rax</span>)
<span style="color: #00ffff;">.endm</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-3" class="outline-3">
<h3 id="unnumbered-3">Макросы для стека возвратов</h3>
<div class="outline-text-3" id="text-unnumbered-3">
<p>
Теперь используют 64-разрядные значения:
</p>

<div class="org-src-container">

<pre class="src src-asm" id="macro_pushrsp"><span style="color: #00ffff;">.macro</span> PUSHRSP reg
    <span style="color: #00ffff;">lea</span>     -8(<span style="color: #eedd82;">%rbp</span>),<span style="color: #eedd82;">%rbp</span>   # &#1076;&#1077;&#1082;&#1088;&#1077;&#1084;&#1077;&#1085;&#1090; <span style="color: #eedd82;">%rbp</span> &#1085;&#1072; 8
    <span style="color: #00ffff;">mov</span>     \reg,(<span style="color: #eedd82;">%rbp</span>)     # push reg &#1074; &#1089;&#1090;&#1077;&#1082; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074;
<span style="color: #00ffff;">.endm</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-asm" id="macro_poprsp"><span style="color: #00ffff;">.macro</span> POPRSP reg
    <span style="color: #00ffff;">mov</span> (<span style="color: #eedd82;">%rbp</span>),\reg         # pop &#1074;&#1077;&#1088;&#1096;&#1080;&#1085;&#1091; &#1089;&#1090;&#1077;&#1082;&#1072; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074; &#1074; reg
    <span style="color: #00ffff;">lea</span> 8(<span style="color: #eedd82;">%rbp</span>),<span style="color: #eedd82;">%rbp</span>        # &#1080;&#1085;&#1082;&#1088;&#1077;&#1084;&#1077;&#1085;&#1090; <span style="color: #eedd82;">%rbp</span> &#1085;&#1072; 8
<span style="color: #00ffff;">.endm</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-4" class="outline-3">
<h3 id="unnumbered-4">DOCOL - интерпретатор</h3>
<div class="outline-text-3" id="text-unnumbered-4">
<p>
Почти не изменился:
</p>

<div class="org-src-container">

<pre class="src src-asm" id="asm_docol">    <span style="color: #00ffff;">.text</span>
    <span style="color: #00ffff;">.align</span> 8
<span style="color: #87cefa;">DOCOL</span>:
    <span style="color: #00ffff;">PUSHRSP</span> <span style="color: #eedd82;">%rsi</span>            # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1090;&#1100; <span style="color: #eedd82;">%rsi</span> &#1074; &#1089;&#1090;&#1077;&#1082;&#1077; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074;
    <span style="color: #00ffff;">leaq</span>    8(<span style="color: #eedd82;">%rax</span>), <span style="color: #eedd82;">%rsi</span>   # <span style="color: #eedd82;">%rsi</span> &#1090;&#1077;&#1087;&#1077;&#1088;&#1100; &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; param-field
    <span style="color: #ff7f24;">/*</span>
<span style="color: #ff7f24;">    # &#1048;&#1083;&#1080; &#1076;&#1088;&#1091;&#1075;&#1080;&#1084;&#1080; &#1089;&#1083;&#1086;&#1074;&#1072;&#1084;&#1080;:</span>
<span style="color: #ff7f24;">    # add   $8, %rax</span>
<span style="color: #ff7f24;">    # mov   %rax, %rsi</span>
<span style="color: #ff7f24;">    */</span>
    <span style="color: #00ffff;">NEXT</span>                    # &#1044;&#1077;&#1083;&#1072;&#1077;&#1084; NEXT
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-5" class="outline-3">
<h3 id="unnumbered-5">Ассемблерная точка входа</h3>
<div class="outline-text-3" id="text-unnumbered-5">
<p>
[TODO:gmm] Необходимо бэкпортить <code>argv</code> и <code>argc</code> в 32-разрядную версию.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="asm_entry">    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">Assembler entry point. */</span>

    <span style="color: #00ffff;">.data</span>

    <span style="color: #00ffff;">.align</span> 8
    <span style="color: #00ffff;">.globl</span> forth_asm_argc
<span style="color: #87cefa;">forth_asm_argc</span>:
    <span style="color: #00ffff;">.quad</span> 0                  # &#1050;&#1086;&#1083;&#1080;&#1095;&#1077;&#1089;&#1090;&#1074;&#1086; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;&#1086;&#1074; &#1082;&#1086;&#1084;&#1072;&#1085;&#1076;&#1085;&#1086;&#1081; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;

    <span style="color: #00ffff;">.align</span> 8
    <span style="color: #00ffff;">.globl</span> forth_asm_argv
<span style="color: #87cefa;">forth_asm_argv</span>:
    <span style="color: #00ffff;">.quad</span> 0                  # &#1059;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;&#1099; &#1082;&#1086;&#1084;&#1072;&#1085;&#1076;&#1085;&#1086;&#1081; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;

    <span style="color: #00ffff;">.text</span>

    <span style="color: #00ffff;">.globl</span>  forth_asm_start
    <span style="color: #00ffff;">.type</span>   forth_asm_start, @function
<span style="color: #87cefa;">forth_asm_start</span>:
    # &#1057;&#1073;&#1088;&#1072;&#1089;&#1099;&#1074;&#1072;&#1077;&#1084; &#1092;&#1083;&#1072;&#1075; &#1085;&#1072;&#1087;&#1088;&#1072;&#1074;&#1083;&#1077;&#1085;&#1080;&#1103;
    <span style="color: #00ffff;">cld</span>
    # &#1047;&#1072;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1077;&#1084; &#1074;&#1077;&#1088;&#1096;&#1080;&#1085;&#1091; &#1089;&#1090;&#1077;&#1082;&#1072; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;&#1086;&#1074; <span style="color: #eedd82;">%rsp</span> &#1074; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1091;&#1102; S0
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rsp</span>, (var_S0)
    # &#1059;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; &#1089;&#1090;&#1077;&#1082; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074; <span style="color: #eedd82;">%rbp</span>
    <span style="color: #00ffff;">mov</span>     $return_stack_top, <span style="color: #eedd82;">%rbp</span>
    # &#1059;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; HERE &#1085;&#1072; &#1085;&#1072;&#1095;&#1072;&#1083;&#1086; &#1086;&#1073;&#1083;&#1072;&#1089;&#1090;&#1080; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;.
    <span style="color: #00ffff;">mov</span>     $data_buffer, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rax</span>, (var_HERE)
    # &#1048;&#1085;&#1080;&#1094;&#1080;&#1072;&#1083;&#1080;&#1079;&#1080;&#1088;&#1091;&#1077;&#1084; IP
    <span style="color: #00ffff;">mov</span>     $cold_start, <span style="color: #eedd82;">%rsi</span>
    # &#1047;&#1072;&#1087;&#1091;&#1089;&#1082;&#1072;&#1077;&#1084; &#1080;&#1085;&#1090;&#1077;&#1088;&#1087;&#1088;&#1077;&#1090;&#1072;&#1090;&#1086;&#1088;
    <span style="color: #00ffff;">NEXT</span>

    <span style="color: #00ffff;">.section</span> .rodata
<span style="color: #87cefa;">cold_start</span>:                             # High-level code without a codeword.
    <span style="color: #00ffff;">.quad</span> QUIT
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-6" class="outline-3">
<h3 id="unnumbered-6">Сишная точка входа</h3>
<div class="outline-text-3" id="text-unnumbered-6">
<p>
Чтобы иметь возможность подключать библиотеки языка Си мы собираем исполнямый файл из
двух частей - сишного, который содержит точку входа и подключение необходимых
библиотек; и ассемблерного, который содержит Fort-машину. Этой Forth-машине передается
управление, когда сишная часть выполнила всю необходимую инициализацию.
</p>

<p>
Например, в сишной части мы сохраняем для будущего использования <code>argc</code> и <code>argv</code> -
количество параметров переданных в командной строке и указатель на эти параметры:
</p>

<div class="org-src-container">

<pre class="src src-c" id="save_cmdline_args">forth_asm_argc = argc;
forth_asm_argv = (<span style="color: #98fb98;">void</span>*)argv;
</pre>
</div>

<p>
Переменные, в которых хранятся эти значения, должны быть определены в отдельном
h-файле, чтобы они были видны и ассемблерному и сишному коду:
</p>

<div class="org-src-container">

<pre class="src src-c" id="shared_vars"><span style="color: #98fb98;">int</span>    <span style="color: #eedd82;">forth_asm_argc</span>;
<span style="color: #98fb98;">void</span>  *<span style="color: #eedd82;">forth_asm_argv</span>;
</pre>
</div>

<p>
Там же следует определить прототипы ассемблерных функкций, чтобы сишный код о них
узнал:
</p>

<div class="org-src-container">

<pre class="src src-c" id="asm_func_prototypes"><span style="color: #98fb98;">void</span> <span style="color: #87cefa;">asmo_init</span>();
<span style="color: #98fb98;">void</span> <span style="color: #87cefa;">forth_asm_start</span>();
</pre>
</div>

<p>
Нам также стоит добавить внешнюю переменную <code>environ</code>. В результате h-файл будет таким:
</p>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;asm-generic/unistd.h&gt;</span>

<span style="color: #00ffff;">extern</span> <span style="color: #98fb98;">char</span> ** <span style="color: #eedd82;">environ</span>;

&lt;&lt;shared_vars&gt;&gt;

&lt;&lt;asm_func_prototypes&gt;&gt;
</pre>
</div>

<p>
Одной из важных используемых библиотек является SDL2, которую планируется использовать
для визуализации. Отдельные куски, иллюстрирующие её использование оставлены для
будущих расширений.
</p>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">g++ sdltest.c `pkg-config --cflags --libs sdl2` -o sdltest   </span><span style="color: #ff7f24;">*/</span>
<span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">https://github.com/mahiuchun/Snake-SDL </span><span style="color: #ff7f24;">*/</span>

<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;stdio.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;stdlib.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;time.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;SDL2/SDL.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;memory.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;string.h&gt;</span>

<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">"sha256.h"</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">"sdlwrap.h"</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">"runvfm64.h"</span>

<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">"asm.h"</span>

<span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">SDL_Texture*  fruit_texture = NULL; </span><span style="color: #ff7f24;">*/</span>
<span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">SDL_Texture*  shead_texture = NULL; </span><span style="color: #ff7f24;">*/</span>
<span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">SDL_Texture*  snake_texture = NULL; </span><span style="color: #ff7f24;">*/</span>
<span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">SDL_Texture*  field_texture = NULL; </span><span style="color: #ff7f24;">*/</span>

<span style="color: #98fb98;">int</span> <span style="color: #87cefa;">sha256_test</span>()
{
    <span style="color: #98fb98;">BYTE</span> <span style="color: #eedd82;">text1</span>[] = {<span style="color: #ffa07a;">"abc"</span>};
    <span style="color: #98fb98;">BYTE</span> <span style="color: #eedd82;">text2</span>[] = {<span style="color: #ffa07a;">"abcdbcdecdefdefgefghfghighijhijkijkljklmklmnlmnomnopnopq"</span>};
    <span style="color: #98fb98;">BYTE</span> <span style="color: #eedd82;">text3</span>[] = {<span style="color: #ffa07a;">"aaaaaaaaaa"</span>};
    <span style="color: #98fb98;">BYTE</span> <span style="color: #eedd82;">hash1</span>[SHA256_BLOCK_SIZE] = {0xba,0x78,0x16,0xbf,0x8f,0x01,0xcf,0xea,0x41,0x41,0x40,0xde,0x5d,0xae,0x22,0x23,
                                     0xb0,0x03,0x61,0xa3,0x96,0x17,0x7a,0x9c,0xb4,0x10,0xff,0x61,0xf2,0x00,0x15,0xad};
    <span style="color: #98fb98;">BYTE</span> <span style="color: #eedd82;">hash2</span>[SHA256_BLOCK_SIZE] = {0x24,0x8d,0x6a,0x61,0xd2,0x06,0x38,0xb8,0xe5,0xc0,0x26,0x93,0x0c,0x3e,0x60,0x39,
                                     0xa3,0x3c,0xe4,0x59,0x64,0xff,0x21,0x67,0xf6,0xec,0xed,0xd4,0x19,0xdb,0x06,0xc1};
    <span style="color: #98fb98;">BYTE</span> <span style="color: #eedd82;">hash3</span>[SHA256_BLOCK_SIZE] = {0xcd,0xc7,0x6e,0x5c,0x99,0x14,0xfb,0x92,0x81,0xa1,0xc7,0xe2,0x84,0xd7,0x3e,0x67,
                                     0xf1,0x80,0x9a,0x48,0xa4,0x97,0x20,0x0e,0x04,0x6d,0x39,0xcc,0xc7,0x11,0x2c,0xd0};
    <span style="color: #98fb98;">BYTE</span> <span style="color: #eedd82;">buf</span>[SHA256_BLOCK_SIZE];
    <span style="color: #98fb98;">SHA256_CTX</span> <span style="color: #eedd82;">ctx</span>;
    <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">idx</span>;
    <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">pass</span> = 1;

    sha256_init(&amp;ctx);
    sha256_update(&amp;ctx, text1, strlen(text1));
    sha256_final(&amp;ctx, buf);

    <span style="color: #00ffff;">for</span>(<span style="color: #98fb98;">int</span> <span style="color: #eedd82;">i</span>=0; i&lt;32; i++) {
        printf(<span style="color: #ffa07a;">"%2d: %p : %2hhX \n"</span>, i, (<span style="color: #98fb98;">void</span> *)(buf+i), *(<span style="color: #98fb98;">char</span>* )(<span style="color: #98fb98;">void</span> *)(buf+i));
    }

    pass = pass &amp;&amp; !memcmp(hash1, buf, SHA256_BLOCK_SIZE);

    sha256_init(&amp;ctx);
    sha256_update(&amp;ctx, text2, strlen(text2));
    sha256_final(&amp;ctx, buf);
    pass = pass &amp;&amp; !memcmp(hash2, buf, SHA256_BLOCK_SIZE);

    sha256_init(&amp;ctx);
    <span style="color: #00ffff;">for</span> (idx = 0; idx &lt; 100000; ++idx)
        sha256_update(&amp;ctx, text3, strlen(text3));
    sha256_final(&amp;ctx, buf);
    pass = pass &amp;&amp; !memcmp(hash3, buf, SHA256_BLOCK_SIZE);

    <span style="color: #00ffff;">return</span>(pass);
}

<span style="color: #98fb98;">void</span> <span style="color: #87cefa;">sha256</span> (<span style="color: #98fb98;">char</span> <span style="color: #eedd82;">str</span>[], <span style="color: #98fb98;">BYTE</span> <span style="color: #eedd82;">buf</span>[SHA256_BLOCK_SIZE])
{
    <span style="color: #98fb98;">SHA256_CTX</span> <span style="color: #eedd82;">ctx</span>;
    sha256_init(&amp;ctx);
    sha256_update(&amp;ctx, str, strlen(str));
    sha256_final(&amp;ctx, buf);
}


<span style="color: #98fb98;">int</span> <span style="color: #87cefa;">main</span>(<span style="color: #98fb98;">int</span> <span style="color: #eedd82;">argc</span>, <span style="color: #98fb98;">char</span> * <span style="color: #eedd82;">argv</span>[])
{
    &lt;&lt;save_cmdline_args&gt;&gt;

    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">BYTE buf[SHA256_BLOCK_SIZE]; </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">sha256("abc", buf); </span><span style="color: #ff7f24;">*/</span>

    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">for(int i=0; i&lt;32; i++) { </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/*     </span><span style="color: #ff7f24;">printf("%2d: %p : %2hhX \n", i, (void *)(buf+i), *(char* )(void *)(buf+i)); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">} </span><span style="color: #ff7f24;">*/</span>

    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">printf("SHA-256 tests: %s\n", sha256_test() ? "SUCCEEDED" : "FAILED"); </span><span style="color: #ff7f24;">*/</span>

    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">Disable buffering </span><span style="color: #ff7f24;">*/</span>
    setbuf(stdout, <span style="color: #7fffd4;">NULL</span>);

    __asm(<span style="color: #ffa07a;">"call forth_asm_start"</span>);

    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">gameover_flag = 0; </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">int delay = 16; </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">init(); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">render(); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">for (;;) { </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/*     </span><span style="color: #ff7f24;">input(); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/*     </span><span style="color: #ff7f24;">__asm("call forth_asm_start"); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/*     </span><span style="color: #ff7f24;">__asm("call update2"); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/*     </span><span style="color: #ff7f24;">/\* update(); *\/ </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/*     </span><span style="color: #ff7f24;">if (gameover_flag) { </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/*         </span><span style="color: #ff7f24;">gameover(); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/*     </span><span style="color: #ff7f24;">} </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/*     </span><span style="color: #ff7f24;">__asm("call render"); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/*     </span><span style="color: #ff7f24;">/\* render(); *\/ </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/*     </span><span style="color: #ff7f24;">SDL_Delay(delay * 10); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">} </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #00ffff;">return</span> 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-7" class="outline-3">
<h3 id="unnumbered-7">Маски для FLAGS/LENGHT</h3>
<div class="outline-text-3" id="text-unnumbered-7">
<p>
Остаются без изменений
</p>

<div class="org-src-container">

<pre class="src src-asm" id="flags"><span style="color: #00ffff;">.set</span> F_IMMED,0x80
<span style="color: #00ffff;">.set</span> F_HIDDEN,0x20
<span style="color: #00ffff;">.set</span> F_LENMASK,0x1f  # length mask
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-8" class="outline-3">
<h3 id="unnumbered-8">Макросы DEFWORD и DEFCODE</h3>
<div class="outline-text-3" id="text-unnumbered-8">
<p>
<code>defword</code> изменился только в отношении выравнивания и типов (.int -&gt; .quad)
</p>

<div class="org-src-container">

<pre class="src src-asm" id="macro_defword">    <span style="color: #00ffff;">.set</span> link,0             # &#1048;&#1085;&#1080;&#1094;&#1080;&#1072;&#1083;&#1080;&#1079;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100; &#1085;&#1072;&#1095;&#1072;&#1083;&#1100;&#1085;&#1086;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077;
                            # &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081; &#1074;&#1088;&#1077;&#1084;&#1077;&#1085;&#1080; &#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1103;&#1094;&#1080;&#1080; link
<span style="color: #00ffff;">.macro</span> defword name, namelen, flags=0, label
    <span style="color: #00ffff;">.section</span> .rodata
    <span style="color: #00ffff;">.align</span> 8
    <span style="color: #00ffff;">.globl</span> name_\label
<span style="color: #87cefa;">name</span>_\label :
    <span style="color: #00ffff;">.quad</span> link              # link
    <span style="color: #00ffff;">.set</span> link,name_\label
    <span style="color: #00ffff;">.byte</span> \flags+\namelen   # flags + &#1073;&#1072;&#1081;&#1090; &#1076;&#1083;&#1080;&#1085;&#1099;
    <span style="color: #00ffff;">.ascii</span> <span style="color: #ffa07a;">"\name"</span>          # &#1080;&#1084;&#1103;
    <span style="color: #00ffff;">.align</span> 8                # &#1074;&#1099;&#1088;&#1072;&#1074;&#1085;&#1080;&#1074;&#1072;&#1085;&#1080;&#1077; &#1085;&#1072; 8-&#1073;&#1072;&#1081;&#1090;&#1086;&#1074;&#1091;&#1102; &#1075;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091;
    <span style="color: #00ffff;">.globl</span> \label
\label :
    <span style="color: #00ffff;">.quad</span> DOCOL             # codeword - &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1102;-&#1080;&#1085;&#1090;&#1077;&#1087;&#1088;&#1077;&#1090;&#1072;&#1090;&#1086;&#1088;
    # &#1076;&#1072;&#1083;&#1100;&#1096;&#1077; &#1073;&#1091;&#1076;&#1091;&#1090; &#1080;&#1076;&#1090;&#1080; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1080; &#1085;&#1072; &#1089;&#1083;&#1086;&#1074;&#1072;
<span style="color: #00ffff;">.endm</span>
</pre>
</div>

<p>
То же с <code>defcode</code>.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="macro_defcode"><span style="color: #00ffff;">.macro</span> defcode name, namelen, flags=0, label
    <span style="color: #00ffff;">.section</span> .rodata
    <span style="color: #00ffff;">.align</span> 8
    <span style="color: #00ffff;">.globl</span> name_\label
<span style="color: #87cefa;">name</span>_\label :
    <span style="color: #00ffff;">.quad</span>   link               # link
    <span style="color: #00ffff;">.set</span>    link,name_\label
    <span style="color: #00ffff;">.byte</span>   \flags+\namelen    # flags + &#1073;&#1072;&#1081;&#1090; &#1076;&#1083;&#1080;&#1085;&#1099;
    <span style="color: #00ffff;">.ascii</span>  <span style="color: #ffa07a;">"\name"</span>            # &#1080;&#1084;&#1103;
    <span style="color: #00ffff;">.align</span>  8                  # &#1074;&#1099;&#1088;&#1072;&#1074;&#1085;&#1080;&#1074;&#1072;&#1085;&#1080;&#1077; &#1085;&#1072; 4-&#1093; &#1073;&#1072;&#1081;&#1090;&#1086;&#1074;&#1091;&#1102; &#1075;&#1088;&#1072;&#1085;&#1080;&#1094;&#1091;
    <span style="color: #00ffff;">.globl</span>  \label
\label :
    <span style="color: #00ffff;">.quad</span>   code_\label        # codeword
    <span style="color: #00ffff;">.text</span>
    <span style="color: #ff7f24;">//</span><span style="color: #ff7f24;">.align 8</span>
    <span style="color: #00ffff;">.globl</span>  code_\label
<span style="color: #87cefa;">code</span>_\label :
    # &#1076;&#1072;&#1083;&#1077;&#1077; &#1089;&#1083;&#1077;&#1076;&#1091;&#1077;&#1090; &#1072;&#1089;&#1089;&#1077;&#1084;&#1073;&#1083;&#1077;&#1088;&#1085;&#1099;&#1081; &#1082;&#1086;&#1076;
<span style="color: #00ffff;">.endm</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-9" class="outline-3">
<h3 id="unnumbered-9">Базовые примитивы</h3>
<div class="outline-text-3" id="text-unnumbered-9">
<p>
Теперь несколько простых примитивов Forth. Они написаны на ассемблере для скорости.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="simple_primitives"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"DROP"</span>,4,,DROP
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1089;&#1073;&#1088;&#1086;&#1089;&#1080;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"SWAP"</span>,4,,SWAP
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1087;&#1086;&#1084;&#1077;&#1085;&#1103;&#1090;&#1100; &#1084;&#1077;&#1089;&#1090;&#1072;&#1084;&#1080; &#1076;&#1074;&#1072; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1093; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1072; &#1085;&#1072; &#1089;&#1090;&#1077;&#1082;&#1077;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"DUP"</span>,3,,DUP
    <span style="color: #00ffff;">mov</span>     (<span style="color: #eedd82;">%rsp</span>), <span style="color: #eedd82;">%rax</span>    # &#1076;&#1091;&#1073;&#1083;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"OVER"</span>,4,,OVER
    <span style="color: #00ffff;">mov</span>     8(<span style="color: #eedd82;">%rsp</span>), <span style="color: #eedd82;">%rax</span>   # &#1074;&#1079;&#1103;&#1090;&#1100; &#1074;&#1090;&#1086;&#1088;&#1086;&#1081; &#1086;&#1090; &#1074;&#1077;&#1088;&#1093;&#1072; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>            # &#1080; &#1087;&#1086;&#1083;&#1086;&#1078;&#1080;&#1090;&#1100; &#1077;&#1075;&#1086; &#1082;&#1086;&#1087;&#1080;&#1102; &#1089;&#1074;&#1077;&#1088;&#1093;&#1091;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"ROT"</span>,3,,ROT
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rcx</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rcx</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"-ROT"</span>,4,,NROT
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rcx</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rcx</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"2DROP"</span>,5,,TWODROP
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1089;&#1073;&#1088;&#1086;&#1089;&#1080;&#1090;&#1100; &#1076;&#1074;&#1072; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1093; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1072; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"2DUP"</span>,4,,TWODUP
    <span style="color: #00ffff;">mov</span>     (<span style="color: #eedd82;">%rsp</span>), <span style="color: #eedd82;">%rax</span>    # &#1076;&#1091;&#1073;&#1083;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100; &#1076;&#1074;&#1072; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1093; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1072; &#1085;&#1072; &#1089;&#1090;&#1077;&#1082;&#1077;
    <span style="color: #00ffff;">mov</span>     8(<span style="color: #eedd82;">%rsp</span>), <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"2SWAP"</span>,5,,TWOSWAP
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1087;&#1086;&#1084;&#1077;&#1085;&#1103;&#1090;&#1100; &#1084;&#1077;&#1089;&#1090;&#1072;&#1084;&#1080; &#1076;&#1074;&#1077; &#1087;&#1072;&#1088;&#1099; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1086;&#1074; &#1085;&#1072; &#1089;&#1090;&#1077;&#1082;&#1077;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rcx</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdx</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rdx</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rcx</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"?DUP"</span>,4,,QDUP
    <span style="color: #00ffff;">mov</span>     (<span style="color: #eedd82;">%rsp</span>), <span style="color: #eedd82;">%rax</span>    # &#1076;&#1091;&#1073;&#1083;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1077;&#1089;&#1083;&#1080; &#1086;&#1085; &#1085;&#1077; &#1085;&#1091;&#1083;&#1077;&#1074;&#1086;&#1081;
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">jz</span>      1f
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
<span style="color: #87cefa;">1</span>:
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"1+"</span>,2,,INCR
    <span style="color: #00ffff;">incq</span>    (<span style="color: #eedd82;">%rsp</span>)          # &#1091;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1085;&#1072; &#1077;&#1076;&#1080;&#1085;&#1080;&#1094;&#1091;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"1-"</span>,2,,DECR
    <span style="color: #00ffff;">decq</span>    (<span style="color: #eedd82;">%rsp</span>)          # &#1091;&#1084;&#1077;&#1085;&#1100;&#1096;&#1080;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1085;&#1072; &#1077;&#1076;&#1080;&#1085;&#1080;&#1094;&#1091;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"4+"</span>,2,,INCR4
    <span style="color: #00ffff;">addq</span>    $4, (<span style="color: #eedd82;">%rsp</span>)      # &#1091;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1085;&#1072; 4
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"4-"</span>,2,,DECR4
    <span style="color: #00ffff;">subq</span>    $4, (<span style="color: #eedd82;">%rsp</span>)      # &#1091;&#1084;&#1077;&#1085;&#1100;&#1096;&#1080;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1085;&#1072; 4
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"8+"</span>,2,,INCR8
    <span style="color: #00ffff;">addq</span>    $8, (<span style="color: #eedd82;">%rsp</span>)      # &#1091;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1085;&#1072; 8
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"8-"</span>,2,,DECR8
    <span style="color: #00ffff;">subq</span>    $8, (<span style="color: #eedd82;">%rsp</span>)      # &#1091;&#1084;&#1077;&#1085;&#1100;&#1096;&#1080;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1085;&#1072; 8
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"+"</span>,1,,ADD
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1074;&#1079;&#1103;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072;
    <span style="color: #00ffff;">add</span>     <span style="color: #eedd82;">%rax</span>, (<span style="color: #eedd82;">%rsp</span>)    # &#1087;&#1088;&#1080;&#1073;&#1072;&#1074;&#1080;&#1100; &#1077;&#1075;&#1086; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1082; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1091;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1081; &#1089;&#1090;&#1072;&#1083; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1084;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"-"</span>,1,,SUB
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1074;&#1079;&#1103;&#1090;&#1100; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072;
    <span style="color: #00ffff;">sub</span>     <span style="color: #eedd82;">%rax</span>, (<span style="color: #eedd82;">%rsp</span>)    # &#1074;&#1099;&#1095;&#1077;&#1089;&#1090;&#1100; &#1077;&#1075;&#1086; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1080;&#1079; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1072;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1081; &#1089;&#1090;&#1072;&#1083; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1084; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1084;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"*"</span>,1,,MUL
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1074;&#1079;&#1103;&#1090;&#1100; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>            # &#1074;&#1079;&#1103;&#1090;&#1100; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1080;&#1081; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;
    <span style="color: #00ffff;">imul</span>    <span style="color: #eedd82;">%rbx</span>, <span style="color: #eedd82;">%rax</span>      # &#1091;&#1084;&#1085;&#1086;&#1078;&#1080;&#1090;&#1100; &#1080;&#1093; &#1076;&#1088;&#1091;&#1075; &#1085;&#1072; &#1076;&#1088;&#1091;&#1075;&#1072;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>            # &#1080;&#1075;&#1085;&#1086;&#1088;&#1080;&#1088;&#1091;&#1077;&#1084; &#1087;&#1077;&#1088;&#1077;&#1087;&#1086;&#1083;&#1085;&#1077;&#1085;&#1080;&#1077;
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>

<p>
Насколько мне известно, в 64-разрядном режиме нет аналога <code>CDQ</code> поэтому в <code>/MOD</code> регистр
<code>%rdx</code> очищается вручную. Тогда он полностью становится эквивалентом <code>U/MOD</code>. Тут нужно
было бы анализировать старший знаковый байт и эмулировать <code>CDQ</code> но пока для простоты и
скорости сделано так как сделано.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="mod"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"/MOD"</span>,4,,DIVMOD
    <span style="color: #00ffff;">xor</span> <span style="color: #eedd82;">%rdx</span>, <span style="color: #eedd82;">%rdx</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">idiv</span>    <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rdx</span>            # push &#1086;&#1089;&#1090;&#1072;&#1090;&#1086;&#1082;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>            # push &#1095;&#1072;&#1089;&#1090;&#1085;&#1086;&#1077;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"U/MOD"</span>,5,,UDIVMOD
    <span style="color: #00ffff;">xor</span> <span style="color: #eedd82;">%rdx</span>, <span style="color: #eedd82;">%rdx</span>
    <span style="color: #00ffff;">pop</span> <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">pop</span> <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">div</span>  <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">push</span> <span style="color: #eedd82;">%rdx</span>               # push &#1086;&#1089;&#1090;&#1072;&#1090;&#1086;&#1082;
    <span style="color: #00ffff;">push</span> <span style="color: #eedd82;">%rax</span>               # push &#1095;&#1072;&#1089;&#1090;&#1085;&#1086;&#1077;
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>

<p>
Множество сравнительных операций, таких как <code>=</code>, <code>&lt;</code>, <code>&gt;</code>, и.т.д
</p>

<p>
Стандарт ANSI Forth говорит, что слова сравнения должны возвращать все двоичные разряды
равные единице для TRUE, и все двоичные разряды равные нулю для FALSE. Для
программистов на языке Си это немного странное соглашение, поэтому этот Forth не
следует ему и возвращает более нормальное (для программистов на Си) значение <code>1</code> для
TRUE и <code>0</code> для FALSE.
</p>

<p>
Причиной этого соглашения является то, что при его использовании слова AND, OR, XOR и
INVERT могут функционировать одновременно как логические операторы, так и как побитовые
операторы. Для сравнения, если использовать соглашение языка Си, что FALSE = 0 и TRUE =
1, вам нужны два набора операторов: <code>&amp;&amp;</code> и <code>&amp;</code>, <code>||</code> и <code>|</code>, и.т.д.
</p>

<p>
В будущем я планирую приблизить этот Forth к стандарту ANSI и отказаться от
использования boolean-соглашений языка Си везде, кроме вызова сишных API. Минусом
такого подхода будет увеличение накладных расходов при вызове сишных API на конвертацию
логических значений, и необходимость аккуратно отследить все места изменений.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="comparison"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"="</span>,1,,EQU
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1076;&#1074;&#1072; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1093; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1072; &#1089;&#1090;&#1077;&#1082;&#1072; &#1088;&#1072;&#1074;&#1085;&#1099;?
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">cmp</span>     <span style="color: #eedd82;">%rbx</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">sete</span>    <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzb</span>   <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"&lt;&gt;"</span>,2,,NEQU
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1076;&#1074;&#1072; &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1093; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090;&#1072; &#1089;&#1090;&#1077;&#1082;&#1072; &#1085;&#1077; &#1088;&#1072;&#1074;&#1085;&#1099;?
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">cmp</span>     <span style="color: #eedd82;">%rbx</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">setne</span>   <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzb</span>   <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"&lt;"</span>,1,,LT
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">cmp</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">setl</span>    <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzb</span>   <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"&gt;"</span>,1,,GT
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">cmp</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">setg</span>    <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzb</span>   <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"&lt;="</span>,2,,LE
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">cmp</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">setle</span>   <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzb</span>   <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"&gt;="</span>,2,,GE
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">cmp</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">setge</span>   <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzb</span>   <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"0="</span>,2,,ZEQU
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1088;&#1072;&#1074;&#1077;&#1085; &#1085;&#1091;&#1083;&#1102;?
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">setz</span>    <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzb</span>   <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"0&lt;&gt;"</span>,3,,ZNEQU
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1074;&#1077;&#1088;&#1093;&#1085;&#1080;&#1081; &#1101;&#1083;&#1077;&#1084;&#1077;&#1085;&#1090; &#1089;&#1090;&#1077;&#1082;&#1072; &#1085;&#1077; &#1088;&#1072;&#1074;&#1077;&#1085; &#1085;&#1091;&#1083;&#1102;?
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">setnz</span>   <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzb</span>   <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"0&lt;"</span>,2,,ZLT
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # comparisons with 0
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">setl</span>    <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzb</span>   <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"0&gt;"</span>,2,,ZGT
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">setg</span>    <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzb</span>   <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"0&lt;="</span>,3,,ZLE
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">setle</span>   <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzb</span>   <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"0&gt;="</span>,3,,ZGE
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">setge</span>   <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">movzb</span>   <span style="color: #eedd82;">%al</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"AND"</span>,3,,AND
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1073;&#1080;&#1090;&#1086;&#1074;&#1099;&#1081; AND
    <span style="color: #00ffff;">and</span>     <span style="color: #eedd82;">%rax</span>, (<span style="color: #eedd82;">%rsp</span>)
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"OR"</span>,2,,OR
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1073;&#1080;&#1090;&#1086;&#1074;&#1099;&#1081; OR
    <span style="color: #00ffff;">or</span>      <span style="color: #eedd82;">%rax</span>, (<span style="color: #eedd82;">%rsp</span>)
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"XOR"</span>,3,,XOR
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1073;&#1080;&#1090;&#1086;&#1074;&#1099;&#1081; XOR
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%rax</span>, (<span style="color: #eedd82;">%rsp</span>)
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"INVERT"</span>,6,,INVERT
    <span style="color: #00ffff;">notq</span>    (<span style="color: #eedd82;">%rsp</span>)          # &#1101;&#1090;&#1086; &#1073;&#1080;&#1090;&#1086;&#1074;&#1072;&#1103; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1103; <span style="color: #ffa07a;">"NOT"</span> (&#1089;&#1084;. NEGATE and NOT)
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-10" class="outline-3">
<h3 id="unnumbered-10">Cmdline слова</h3>
<div class="outline-text-3" id="text-unnumbered-10">
<div class="org-src-container">

<pre class="src src-asm" id="argc"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"ARGC"</span>,4,,ARGC
    <span style="color: #00ffff;">movq</span>    (forth_asm_argc), <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-asm" id="argv"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"ARGV"</span>,4,,ARGV
    <span style="color: #00ffff;">movq</span>    (forth_asm_argv), <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-asm" id="env"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"ENV"</span>,3,,ENV
    <span style="color: #00ffff;">movq</span>    (environ), <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-11" class="outline-3">
<h3 id="unnumbered-11">EXIT - Возвращение из форт-слов</h3>
<div class="outline-text-3" id="text-unnumbered-11">
<p>
Благодаря макросам тут нет никаких изменений, кроме размера регистра.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="exit"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"EXIT"</span>,4,,EXIT
    <span style="color: #00ffff;">POPRSP</span>  <span style="color: #eedd82;">%rsi</span>            # &#1042;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1080;&#1079; &#1089;&#1090;&#1077;&#1082;&#1072; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074; &#1074; <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">NEXT</span>                    # &#1057;&#1076;&#1077;&#1083;&#1072;&#1090;&#1100; NEXT
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-12" class="outline-3">
<h3 id="unnumbered-12">Литералы</h3>
<div class="outline-text-3" id="text-unnumbered-12">
<div class="org-src-container">

<pre class="src src-asm" id="word_lit"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"LIT"</span>,3,,LIT
    # <span style="color: #eedd82;">%rsi</span> &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1091;&#1102; &#1082;&#1086;&#1084;&#1072;&#1085;&#1076;&#1091;, &#1085;&#1086; &#1074; &#1101;&#1090;&#1086;&#1084; &#1089;&#1083;&#1091;&#1095;&#1072;&#1077; &#1101;&#1090;&#1086; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1080;&#1081;
    # &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;, &#1087;&#1088;&#1077;&#1076;&#1089;&#1090;&#1072;&#1074;&#1083;&#1103;&#1102;&#1097;&#1080;&#1081; &#1089;&#1086;&#1073;&#1086;&#1081; 8-&#1073;&#1072;&#1081;&#1090;&#1086;&#1074;&#1086;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077;. &#1055;&#1086;&#1083;&#1091;&#1095;&#1077;&#1085;&#1080;&#1077; &#1101;&#1090;&#1086;&#1075;&#1086; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;&#1072; &#1074; <span style="color: #eedd82;">%rax</span>
    # &#1080; &#1080;&#1085;&#1082;&#1088;&#1077;&#1084;&#1077;&#1085;&#1090; <span style="color: #eedd82;">%rsi</span> &#1085;&#1072; x86 -  &#1101;&#1090;&#1086; &#1091;&#1076;&#1086;&#1073;&#1085;&#1072;&#1103; &#1086;&#1076;&#1085;&#1086;&#1073;&#1072;&#1081;&#1090;&#1086;&#1074;&#1072;&#1103; &#1080;&#1085;&#1089;&#1090;&#1088;&#1091;&#1082;&#1094;&#1080;&#1103;! (&#1089;&#1084;. NEXT macro)
    <span style="color: #00ffff;">lodsq</span>
    # push literal &#1074; &#1089;&#1090;&#1077;&#1082;
    <span style="color: #00ffff;">push</span> <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-13" class="outline-3">
<h3 id="unnumbered-13">Память</h3>
<div class="outline-text-3" id="text-unnumbered-13">
<div class="org-src-container">

<pre class="src src-asm" id="store"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"!"</span>,1,,STORE
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1072;&#1076;&#1088;&#1077;&#1089;, &#1082;&#1091;&#1076;&#1072; &#1073;&#1091;&#1076;&#1077;&#1084; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1090;&#1100;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1077;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1077; &#1073;&#1091;&#1076;&#1077;&#1084; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1090;&#1100;
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rax</span>, (<span style="color: #eedd82;">%rbx</span>)    # &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1077;&#1084; &#1076;&#1072;&#1085;&#1085;&#1099;&#1077; &#1087;&#1086; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"@"</span>,1,,FETCH
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;, &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1082;&#1086;&#1090;&#1086;&#1088;&#1086;&#1081; &#1085;&#1072;&#1076;&#1086; &#1074;&#1077;&#1088;&#1085;&#1091;&#1090;&#1100;
    <span style="color: #00ffff;">mov</span>     (<span style="color: #eedd82;">%rbx</span>), <span style="color: #eedd82;">%rax</span>    # &#1074;&#1099;&#1103;&#1089;&#1085;&#1103;&#1077;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1087;&#1086; &#1101;&#1090;&#1086;&#1084;&#1091; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>            # push-&#1080;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1074; &#1089;&#1090;&#1077;&#1082;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"+!"</span>,2,,ADDSTORE
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1091;&#1102; &#1073;&#1091;&#1076;&#1077;&#1084; &#1091;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1074;&#1072;&#1090;&#1100;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1085;&#1072; &#1082;&#1086;&#1090;&#1086;&#1088;&#1086;&#1077; &#1073;&#1091;&#1076;&#1077;&#1084; &#1091;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1074;&#1072;&#1090;&#1100;
    <span style="color: #00ffff;">add</span>     <span style="color: #eedd82;">%rax</span>, (<span style="color: #eedd82;">%rbx</span>)    # &#1076;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1082; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081; &#1087;&#1086; &#1101;&#1090;&#1086;&#1084;&#1091; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"-!"</span>,2,,SUBSTORE
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1091;&#1102; &#1073;&#1091;&#1076;&#1077;&#1084; &#1091;&#1084;&#1077;&#1085;&#1100;&#1096;&#1072;&#1090;&#1100;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1085;&#1072; &#1082;&#1086;&#1090;&#1086;&#1088;&#1086;&#1077; &#1073;&#1091;&#1076;&#1077;&#1084; &#1091;&#1084;&#1077;&#1085;&#1100;&#1096;&#1072;&#1090;&#1100;
    <span style="color: #00ffff;">sub</span>     <span style="color: #eedd82;">%rax</span>, (<span style="color: #eedd82;">%rbx</span>)    # &#1074;&#1099;&#1095;&#1080;&#1090;&#1072;&#1077;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1080;&#1079; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081; &#1087;&#1086; &#1101;&#1090;&#1086;&#1084;&#1091; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091;
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-asm" id="char_store"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"C!"</span>,2,,STOREBYTE
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1072;&#1076;&#1088;&#1077;&#1089;, &#1082;&#1091;&#1076;&#1072; &#1073;&#1091;&#1076;&#1077;&#1084; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1090;&#1100;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1077;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1077; &#1073;&#1091;&#1076;&#1077;&#1084; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1090;&#1100;
    <span style="color: #00ffff;">movb</span>    <span style="color: #eedd82;">%al</span>, (<span style="color: #eedd82;">%rbx</span>)     # &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1077;&#1084; &#1076;&#1072;&#1085;&#1085;&#1099;&#1077; &#1087;&#1086; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"C@"</span>,2,,FETCHBYTE
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>            # &#1079;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086;&#1081;, &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1082;&#1086;&#1090;&#1086;&#1088;&#1086;&#1081; &#1085;&#1072;&#1076;&#1086; &#1074;&#1077;&#1088;&#1085;&#1091;&#1090;&#1100;
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>      # &#1086;&#1095;&#1080;&#1097;&#1072;&#1077;&#1084; &#1088;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088; <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">movb</span>    (<span style="color: #eedd82;">%rbx</span>), <span style="color: #eedd82;">%al</span>     # &#1074;&#1099;&#1103;&#1089;&#1085;&#1103;&#1077;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1087;&#1086; &#1101;&#1090;&#1086;&#1084;&#1091; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>            # push-&#1080;&#1084; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1074; &#1089;&#1090;&#1077;&#1082;
    <span style="color: #00ffff;">NEXT</span>

# C@C! - &#1101;&#1090;&#1086; &#1087;&#1086;&#1083;&#1077;&#1079;&#1085;&#1099;&#1081; &#1087;&#1088;&#1080;&#1084;&#1080;&#1090;&#1080;&#1074; &#1076;&#1083;&#1103; &#1082;&#1086;&#1087;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; &#1073;&#1072;&#1081;&#1090;
<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"C@C!"</span>,4,,CCOPY
    <span style="color: #00ffff;">mov</span>     8(<span style="color: #eedd82;">%rsp</span>), <span style="color: #eedd82;">%rbx</span>   # &#1072;&#1076;&#1088;&#1077;&#1089; &#1080;&#1089;&#1090;&#1086;&#1095;&#1085;&#1080;&#1082;&#1072;
    <span style="color: #00ffff;">movb</span>    (<span style="color: #eedd82;">%rbx</span>), <span style="color: #eedd82;">%al</span>     # &#1087;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1073;&#1072;&#1081;&#1090; &#1080;&#1079; &#1080;&#1089;&#1090;&#1086;&#1095;&#1085;&#1080;&#1082;&#1072;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>            # &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1088;&#1080;&#1077;&#1084;&#1085;&#1080;&#1082;&#1072;
    <span style="color: #00ffff;">stosb</span>                   # &#1082;&#1086;&#1087;&#1080;&#1088;&#1091;&#1077;&#1084; &#1073;&#1072;&#1081;&#1090; &#1074; &#1087;&#1088;&#1080;&#1077;&#1084;&#1085;&#1080;&#1082;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rdi</span>            # &#1091;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1074;&#1072;&#1077;&#1084; &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1088;&#1080;&#1077;&#1084;&#1085;&#1080;&#1082;&#1072;
    <span style="color: #00ffff;">incq</span>    8(<span style="color: #eedd82;">%rsp</span>)         # &#1091;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1074;&#1072;&#1077;&#1084; &#1072;&#1076;&#1088;&#1077;&#1089; &#1080;&#1089;&#1090;&#1086;&#1095;&#1085;&#1080;&#1082;&#1072;
    <span style="color: #00ffff;">NEXT</span>

# CMOVE - &#1086;&#1087;&#1077;&#1088;&#1072;&#1094;&#1080;&#1103; &#1082;&#1086;&#1087;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103; &#1073;&#1083;&#1086;&#1082;&#1072; &#1073;&#1072;&#1081;&#1090;&#1086;&#1074;
<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"CMOVE"</span>,5,,CMOVE
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rsi</span>, <span style="color: #eedd82;">%rdx</span>      # &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1084; <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rcx</span>            # length
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>            # &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1088;&#1080;&#1077;&#1084;&#1085;&#1080;&#1082;&#1072;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rsi</span>            # &#1072;&#1076;&#1088;&#1077;&#1089; &#1080;&#1089;&#1090;&#1086;&#1095;&#1085;&#1080;&#1082;&#1072;
    <span style="color: #00ffff;">rep</span>     movsb           # &#1082;&#1086;&#1087;&#1080;&#1088;&#1091;&#1077;&#1084; &#1080;&#1089;&#1090;&#1086;&#1095;&#1085;&#1080;&#1082; &#1074; &#1087;&#1088;&#1080;&#1077;&#1084;&#1085;&#1080;&#1082; length &#1088;&#1072;&#1079;
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rdx</span>, <span style="color: #eedd82;">%rsi</span>      # &#1074;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-14" class="outline-3">
<h3 id="unnumbered-14">Встроенные переменные</h3>
<div class="outline-text-3" id="text-unnumbered-14">
<div class="org-src-container">

<pre class="src src-asm" id="macro_defvar"><span style="color: #00ffff;">.macro</span> defvar name, namelen, flags=0, label, initial=0
    <span style="color: #00ffff;">defcode</span> \name,\namelen,\flags,\label
    <span style="color: #00ffff;">push</span>    $var_\name
    <span style="color: #00ffff;">NEXT</span>
    <span style="color: #00ffff;">.data</span>
    <span style="color: #00ffff;">.align</span> 8
    <span style="color: #00ffff;">var_</span>\name :
    <span style="color: #00ffff;">.quad</span> \initial
<span style="color: #00ffff;">.endm</span>
</pre>
</div>

<p>
Встроенные переменные:
</p>
<ul class="org-ul">
<li>STATE - состояние интерпретации (ноль) или компиляции слова (не ноль)
</li>
<li>LATEST - указатель на последнее заданное слово в словаре.
</li>
<li>HERE - указатель на следующий свободный байт памяти. При компиляции скомпилированные
слова помещаются по этому указателю, а потом он передвигается дальше.
</li>
<li>S0 - хранит адрес вершины стека параметров.
</li>
<li>BASE - текущая база (radix) для печати и чтения чисел.
</li>
</ul>

<div class="org-src-container">

<pre class="src src-asm" id="built_in_vars"><span style="color: #87cefa;">defvar</span> <span style="color: #ffa07a;">"STATE"</span>,5,,STATE
<span style="color: #87cefa;">defvar</span> <span style="color: #ffa07a;">"HERE"</span>,4,,HERE
<span style="color: #87cefa;">defvar</span> <span style="color: #ffa07a;">"LATEST"</span>,6,,LATEST,name_SYSCALL0  # SYSCALL0 &#1076;&#1086;&#1083;&#1078;&#1077;&#1085; &#1073;&#1099;&#1090;&#1100; &#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1080;&#1084; &#1074;&#1089;&#1090;&#1088;&#1086;&#1077;&#1085;&#1085;&#1099;&#1084; &#1089;&#1083;&#1086;&#1074;&#1086;&#1084;
<span style="color: #87cefa;">defvar</span> <span style="color: #ffa07a;">"S0"</span>,2,,SZ
<span style="color: #87cefa;">defvar</span> <span style="color: #ffa07a;">"BASE"</span>,4,,BASE,10
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-15" class="outline-3">
<h3 id="unnumbered-15">Встроенные константы</h3>
<div class="outline-text-3" id="text-unnumbered-15">
<p>
Встроенные константы:
</p>
<ul class="org-ul">
<li>VERSION    - это текущая версия этого Forth.
</li>
<li>R0         - максимальный адрес (адрес дна) стека возвратов.
</li>
<li>DOCOL      - Указатель на DOCOL.
</li>
<li>F＿IMMED   - текущее значение флага IMMEDIATE.
</li>
<li>F＿HIDDEN  - Текущее значение флага HIDDEN.
</li>
<li>F＿LENMASK - Маска длины в  flags/len байте
</li>
<li>SYS＿* и числовые коды различных системных вызовов Linux (из &lt;asm/unistd.h&gt;)
</li>
</ul>

<div class="org-src-container">

<pre class="src src-asm" id="macro_defconst"><span style="color: #00ffff;">.macro</span> defconst name, namelen, flags=0, label, value
    <span style="color: #00ffff;">defcode</span> \name,\namelen,\flags,\label
    <span style="color: #00ffff;">push</span> $\value
    <span style="color: #00ffff;">NEXT</span>
<span style="color: #00ffff;">.endm</span>
</pre>
</div>


<div class="org-src-container">

<pre class="src src-asm" id="built_in_constants"><span style="color: #00ffff;">.set</span> JONES_VERSION,47

<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"VERSION"</span>,7,,VERSION,JONES_VERSION
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"R0"</span>,2,,RZ,return_stack_top
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"DOCOL"</span>,5,,__DOCOL,DOCOL
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"F_IMMED"</span>,7,,__F_IMMED,F_IMMED
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"F_HIDDEN"</span>,8,,__F_HIDDEN,F_HIDDEN
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"F_LENMASK"</span>,9,,__F_LENMASK,F_LENMASK

<span style="color: #00ffff;">.set</span> sys_exit,60
<span style="color: #00ffff;">.set</span> sys_read,0
<span style="color: #00ffff;">.set</span> sys_write,1
<span style="color: #00ffff;">.set</span> sys_open,5
<span style="color: #00ffff;">.set</span> sys_close,6
<span style="color: #00ffff;">.set</span> sys_creat,8
<span style="color: #00ffff;">.set</span> sys_unlink,0xA
<span style="color: #00ffff;">.set</span> sys_lseek,0x13
<span style="color: #00ffff;">.set</span> sys_truncate,0x5C

<span style="color: #00ffff;">.set</span> stdin,0
<span style="color: #00ffff;">.set</span> stdout,1
<span style="color: #00ffff;">.set</span> stderr,2

<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"SYS_EXIT"</span>,8,,SYS_EXIT,sys_exit
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"SYS_OPEN"</span>,8,,SYS_OPEN,sys_open
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"SYS_CLOSE"</span>,9,,SYS_CLOSE,sys_close
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"SYS_READ"</span>,8,,SYS_READ,sys_read
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"SYS_WRITE"</span>,9,,SYS_WRITE,sys_write
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"SYS_CREAT"</span>,9,,SYS_CREAT,sys_creat

<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_RDONLY"</span>,8,,__O_RDONLY,0
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_WRONLY"</span>,8,,__O_WRONLY,1
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_RDWR"</span>,6,,__O_RDWR,2
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_CREAT"</span>,7,,__O_CREAT,0100
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_EXCL"</span>,6,,__O_EXCL,0200
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_TRUNC"</span>,7,,__O_TRUNC,01000
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_APPEND"</span>,8,,__O_APPEND,02000
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"O_NONBLOCK"</span>,10,,__O_NONBLOCK,04000

<span style="color: #00ffff;">.set</span> wordsize,8
<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"WORDSIZE"</span>,8,,WORDSIZE,wordsize
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-16" class="outline-3">
<h3 id="unnumbered-16">Стек возвратов</h3>
<div class="outline-text-3" id="text-unnumbered-16">
<div class="org-src-container">

<pre class="src src-asm" id="words_for_retstack"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"&gt;R"</span>,2,,TOR
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # pop &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1074; <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">PUSHRSP</span> <span style="color: #eedd82;">%rax</span>            # push <span style="color: #eedd82;">%rax</span> &#1085;&#1072; &#1089;&#1090;&#1077;&#1082; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"R&gt;"</span>,2,,FROMR
    <span style="color: #00ffff;">POPRSP</span>  <span style="color: #eedd82;">%rax</span>            # pop &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074; &#1074; <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>            # push <span style="color: #eedd82;">%rax</span> &#1085;&#1072; &#1089;&#1090;&#1077;&#1082; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;&#1086;&#1074;
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"RSP@"</span>,4,,RSPFETCH
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rbp</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"RSP!"</span>,4,,RSPSTORE
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbp</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"RDROP"</span>,5,,RDROP
    <span style="color: #00ffff;">add</span>     $8, <span style="color: #eedd82;">%rbp</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-17" class="outline-3">
<h3 id="unnumbered-17">Стек данных</h3>
<div class="outline-text-3" id="text-unnumbered-17">
<div class="org-src-container">

<pre class="src src-asm" id="data_stack_words"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"DSP@"</span>,4,,DSPFETCH
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rsp</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"DSP!"</span>,4,,DSPSTORE
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rsp</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-18" class="outline-3">
<h3 id="unnumbered-18">Ввод и вывод: KEY EMIT WORD NUMBER</h3>
<div class="outline-text-3" id="text-unnumbered-18">
<div class="org-src-container">

<pre class="src src-asm" id="word_key">    <span style="color: #00ffff;">defcode</span> <span style="color: #ffa07a;">"KEY"</span>,3,,KEY
    <span style="color: #00ffff;">call</span> _KEY
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>            #       # push-&#1080;&#1084; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1077;&#1085;&#1085;&#1099;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; &#1085;&#1072; &#1089;&#1090;&#1077;&#1082;
    <span style="color: #00ffff;">NEXT</span>                    #
<span style="color: #87cefa;">_KEY</span>:                       # &lt;--+
    <span style="color: #00ffff;">mov</span>     (currkey), <span style="color: #eedd82;">%rbx</span> #    |  # &#1041;&#1077;&#1088;&#1077;&#1084; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; currkey &#1074; <span style="color: #eedd82;">%rbx</span>
    <span style="color: #00ffff;">cmp</span>     (bufftop), <span style="color: #eedd82;">%rbx</span> #    |  # (bufftop &gt;= currkey)? - &#1074; &#1073;&#1091;&#1092;&#1077;&#1088;&#1077; &#1077;&#1089;&#1090;&#1100; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1099;?
    <span style="color: #00ffff;">jge</span>     1f              #-+  |  # ?-&#1053;&#1077;&#1090;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074;&#1087;&#1077;&#1088;&#1077;&#1076;
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>      # |  |  # ?-&#1044;&#1072;,  (1) &#1087;&#1077;&#1088;&#1077;&#1085;&#1086;&#1089;&#1080;&#1084; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;, &#1085;&#1072; &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1081;
    <span style="color: #00ffff;">mov</span>     (<span style="color: #eedd82;">%rbx</span>), <span style="color: #eedd82;">%al</span>     # |  |  #        &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; currkey &#1074; <span style="color: #eedd82;">%rax</span>,
    <span style="color: #00ffff;">inc</span>     <span style="color: #eedd82;">%rbx</span>            # |  |  #        (2) &#1080;&#1085;&#1082;&#1088;&#1077;&#1084;&#1077;&#1085;&#1090;&#1080;&#1088;&#1091;&#1077;&#1084; &#1082;&#1086;&#1087;&#1080;&#1102; currkey
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rbx</span>, (currkey) # |  |  #        (3) &#1079;&#1072;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1077;&#1084; &#1077;&#1077; &#1074; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1091;&#1102; currkey,
    <span style="color: #00ffff;">ret</span>                     # |  |  #        &#1080; &#1074;&#1099;&#1093;&#1086;&#1076;&#1080;&#1084; (&#1074; <span style="color: #eedd82;">%rax</span> &#1083;&#1077;&#1078;&#1080;&#1090; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;)
    # ---------------- RET    |  |
<span style="color: #87cefa;">1</span>:  #                     &lt;---+  |  # &#1041;&#1091;&#1092;&#1077;&#1088; &#1074;&#1074;&#1086;&#1076;&#1072; &#1087;&#1091;&#1089;&#1090;, &#1089;&#1076;&#1077;&#1083;&#1072;&#1077;&#1084; read &#1080;&#1079; stdin
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rsi</span>            #    |  # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1077;&#1084; <span style="color: #eedd82;">%rsi</span> &amp; <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rdi</span>            #    |  #
    <span style="color: #00ffff;">mov</span>     $stdin, <span style="color: #eedd82;">%rdi</span>    #    |  #  param1: &#1044;&#1077;&#1089;&#1082;&#1088;&#1080;&#1087;&#1090;&#1086;&#1088; stdin &#1074; <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">mov</span>     $input_buffer, <span style="color: #eedd82;">%rsi</span> #|  #  param2: &#1050;&#1083;&#1072;&#1076;&#1077;&#1084; &#1072;&#1076;&#1088;&#1077;&#1089; &#1073;&#1091;&#1092;&#1077;&#1088;&#1072; &#1074;&#1074;&#1086;&#1076;&#1072; &#1074; <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rsi</span>, currkey   #    |  #  &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1077;&#1084; &#1077;&#1075;&#1086; (&#1072;&#1076;&#1088;&#1077;&#1089; &#1073;&#1091;&#1092;&#1077;&#1088;&#1072;) &#1074;&#1074;&#1086;&#1076;&#1072; &#1074; currkey
    <span style="color: #00ffff;">mov</span>     $INPUT_BUFFER_SIZE, <span style="color: #eedd82;">%rdx</span> # param3: &#1052;&#1072;&#1082;&#1089;&#1080;&#1084;&#1072;&#1083;&#1100;&#1085;&#1072;&#1103; &#1076;&#1083;&#1080;&#1085;&#1072; &#1074;&#1074;&#1086;&#1076;&#1072; &#1074; <span style="color: #eedd82;">%rdx</span>
    <span style="color: #00ffff;">mov</span>     $sys_read, <span style="color: #eedd82;">%rax</span> #    |  #  SYSCALL read &#1074; <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">syscall</span>                 #    |  #  SYSCALL
    # &#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1103;&#1077;&#1084; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1077;&#1085;&#1085;&#1086;&#1077;     |  # &#1076;&#1086;&#1083;&#1078;&#1085;&#1086; &#1073;&#1099;&#1090;&#1100; &#1082;&#1086;&#1083;&#1080;&#1095;&#1077;&#1089;&#1090;&#1074;&#1086; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074; + '\n'
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>      #    |  # (<span style="color: #eedd82;">%rax</span> &lt;= 0)?
    <span style="color: #00ffff;">jbe</span>     2f              #-+  |  # ?-&#1044;&#1072;, &#1101;&#1090;&#1086; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074;&#1087;&#1077;&#1088;&#1077;&#1076;
    <span style="color: #00ffff;">add</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rsi</span>      # |  |  # ?-&#1053;&#1077;&#1090;, (1) &#1076;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; &#1074; <span style="color: #eedd82;">%rsi</span> &#1082;&#1086;&#1083;-&#1074;&#1086; &#1087;&#1088;&#1086;&#1095;&#1080;&#1090;&#1072;&#1085;&#1085;&#1099;&#1093; &#1073;&#1072;&#1081;&#1090;
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rsi</span>, (bufftop) # |  |  #        (2) &#1079;&#1072;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1077;&#1084; <span style="color: #eedd82;">%rsi</span> &#1074; bufftop
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>            # |  |  # &#1058;&#1077;&#1087;&#1077;&#1088;&#1100; &#1084;&#1086;&#1078;&#1085;&#1086; &#1074;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; <span style="color: #eedd82;">%rdi</span> &amp; <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rsi</span>            # |  |
    <span style="color: #00ffff;">jmp</span>     _KEY            # |  |
    # ------------------------|--+
<span style="color: #87cefa;">2</span>:  #                     &lt;---+     # &#1054;&#1096;&#1080;&#1073;&#1082;&#1072; &#1080;&#1083;&#1080; &#1082;&#1086;&#1085;&#1077;&#1094; &#1087;&#1086;&#1090;&#1086;&#1082;&#1072; &#1074;&#1074;&#1086;&#1076;&#1072; - &#1074;&#1099;&#1093;&#1086;&#1076;&#1080;&#1084;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>            #       # &#1057;&#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1085;&#1072;&#1076;&#1086; &#1074;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; <span style="color: #eedd82;">%rdi</span> &amp; <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rsi</span>            #
    <span style="color: #00ffff;">mov</span>     $sys_exit, <span style="color: #eedd82;">%rax</span>         # param1: SYSCALL #1 (exit)
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%rdi</span>, <span style="color: #eedd82;">%rdi</span>              # param2: &#1082;&#1086;&#1076; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1072;
    <span style="color: #00ffff;">syscall</span>                         # SYSCALL
    # --------------- EXIT
    <span style="color: #00ffff;">.data</span>
    <span style="color: #00ffff;">.align</span> 8
<span style="color: #87cefa;">currkey</span>:
    # &#1061;&#1088;&#1072;&#1085;&#1080;&#1090; &#1089;&#1084;&#1077;&#1097;&#1077;&#1085;&#1080;&#1077; &#1085;&#1072; &#1090;&#1077;&#1082;&#1091;&#1097;&#1077;&#1077; &#1087;&#1086;&#1083;&#1086;&#1078;&#1077;&#1085;&#1080;&#1077; &#1074; &#1073;&#1091;&#1092;&#1077;&#1088;&#1077; &#1074;&#1074;&#1086;&#1076;&#1072; (&#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1080;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; &#1073;&#1091;&#1076;&#1077;&#1090; &#1087;&#1088;&#1086;&#1095;&#1080;&#1090;&#1072;&#1085; &#1087;&#1086; &#1085;&#1077;&#1084;&#1091;)
    <span style="color: #00ffff;">.quad</span> input_buffer
<span style="color: #87cefa;">bufftop</span>:
    # &#1061;&#1088;&#1072;&#1085;&#1080;&#1090; &#1074;&#1077;&#1088;&#1096;&#1080;&#1085;&#1091; &#1073;&#1091;&#1092;&#1077;&#1088;&#1072; &#1074;&#1074;&#1086;&#1076;&#1072; (&#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1080;&#1077; &#1074;&#1072;&#1083;&#1080;&#1076;&#1085;&#1099;&#1077; &#1076;&#1072;&#1085;&#1085;&#1099;&#1077; + 1)
    <span style="color: #00ffff;">.quad</span> input_buffer
</pre>
</div>


<div class="org-src-container">

<pre class="src src-asm" id="word_emit"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"EMIT"</span>,4,,EMIT
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">call</span>    _EMIT
    <span style="color: #00ffff;">NEXT</span>
<span style="color: #87cefa;">_EMIT</span>:
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rsi</span>            #    |  #
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rdi</span>            #    |  #
    <span style="color: #00ffff;">mov</span>     $stdout, <span style="color: #eedd82;">%rdi</span>           # param1: stdout &#1074; $rdi
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%al</span>, emit_scratch       # &#1073;&#1077;&#1088;&#1077;&#1084; &#1073;&#1072;&#1081;&#1090; &#1080; &#1079;&#1072;&#1085;&#1086;&#1089;&#1080;&#1084; &#1077;&#1075;&#1086; &#1074; emit_scratch
    <span style="color: #00ffff;">mov</span>     $emit_scratch, <span style="color: #eedd82;">%rsi</span>     # param2: &#1072;&#1076;&#1088;&#1077;&#1089; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1084;&#1086;&#1075;&#1086; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1103; &#1074; <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">mov</span>     $1, <span style="color: #eedd82;">%rdx</span>                # param3: &#1076;&#1083;&#1080;&#1085;&#1072;
    <span style="color: #00ffff;">mov</span>     $sys_write, <span style="color: #eedd82;">%rax</span>        # SYSCALL write
    <span style="color: #00ffff;">syscall</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>            #    |
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rsi</span>            #    |
    <span style="color: #00ffff;">ret</span>

    <span style="color: #00ffff;">.data</span>           # NB: &#1087;&#1088;&#1086;&#1097;&#1077; &#1079;&#1072;&#1087;&#1080;&#1089;&#1072;&#1090;&#1100; &#1074; .data section
<span style="color: #87cefa;">emit_scratch</span>:
    <span style="color: #00ffff;">.space</span> 1        # &#1052;&#1077;&#1089;&#1090;&#1086; &#1076;&#1083;&#1103; &#1073;&#1072;&#1081;&#1090;&#1072;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1081; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1090; EMIT
</pre>
</div>


<div class="org-src-container">

<pre class="src src-asm" id="word_word">    <span style="color: #00ffff;">defcode</span> <span style="color: #ffa07a;">"WORD"</span>,4,,WORD
    <span style="color: #00ffff;">call</span>    _WORD
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rdi</span>            # push base address
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rcx</span>            # push length
    <span style="color: #00ffff;">NEXT</span>
<span style="color: #87cefa;">_WORD</span>:
    # &#1048;&#1097;&#1077;&#1084; &#1087;&#1077;&#1088;&#1074;&#1099;&#1081; &#1085;&#1077;&#1087;&#1088;&#1086;&#1073;&#1077;&#1083;&#1100;&#1085;&#1099;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;, &#1087;&#1088;&#1086;&#1087;&#1091;&#1089;&#1082;&#1072;&#1103; &#1082;&#1086;&#1084;&#1084;&#1077;&#1085;&#1090;&#1099;, &#1085;&#1072;&#1095;&#1080;&#1085;&#1072;&#1102;&#1097;&#1080;&#1077;&#1089;&#1103; &#1089; &#1086;&#1073;&#1088;&#1072;&#1090;&#1085;&#1086;&#1075;&#1086; &#1089;&#1083;&#1101;&#1096;&#1072;
<span style="color: #87cefa;">1</span>:                      # &lt;---+
    <span style="color: #00ffff;">call</span>    _KEY            # |     # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1091;&#1102; &#1073;&#1091;&#1082;&#1074;&#1091;, &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;&#1091;&#1102; &#1074; <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">cmpb</span>    $'\\', <span style="color: #eedd82;">%al</span>      # |     # (&#1069;&#1090;&#1086; &#1085;&#1072;&#1095;&#1072;&#1083;&#1086; &#1082;&#1086;&#1084;&#1084;&#1077;&#1085;&#1090;&#1072;&#1088;&#1080;&#1103;)?
    <span style="color: #00ffff;">je</span>      3f              #-|---+ # ?-&#1044;&#1072;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074;&#1087;&#1077;&#1088;&#1077;&#1076;
    <span style="color: #00ffff;">cmpb</span>    $' ', <span style="color: #eedd82;">%al</span>       # |   | # ?-&#1053;&#1077;&#1090;. (&#1069;&#1090;&#1086; &#1087;&#1088;&#1086;&#1073;&#1077;&#1083;, &#1074;&#1086;&#1079;&#1088;&#1072;&#1090; &#1082;&#1072;&#1088;&#1077;&#1090;&#1082;&#1080;, &#1087;&#1077;&#1088;&#1077;&#1074;&#1086;&#1076; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;)?
    <span style="color: #00ffff;">jbe</span>     1b              #-+   | # ?-&#1044;&#1072;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1085;&#1072;&#1079;&#1072;&#1076;
    #                             |
    # &#1048;&#1097;&#1077;&#1084; &#1082;&#1086;&#1085;&#1077;&#1094; &#1089;&#1083;&#1086;&#1074;&#1072;, &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1103; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1099; &#1087;&#1086; &#1084;&#1077;&#1088;&#1077; &#1087;&#1088;&#1086;&#1076;&#1074;&#1080;&#1078;&#1077;&#1085;&#1080;&#1103;
    <span style="color: #00ffff;">mov</span>     $word_buffer, <span style="color: #eedd82;">%rdi</span>  # | # &#1059;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;&#1099;&#1081; &#1073;&#1091;&#1092;&#1077;&#1088;
<span style="color: #87cefa;">2</span>:                      # &lt;---+   |
    <span style="color: #00ffff;">stosb</span>                   # |   | # &#1044;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; &#1074; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;&#1099;&#1081; &#1073;&#1091;&#1092;&#1077;&#1088;
    <span style="color: #00ffff;">call</span>    _KEY            # |   | # &#1042;&#1099;&#1079;&#1099;&#1074;&#1072;&#1077;&#1084; KEY &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; &#1073;&#1091;&#1076;&#1077;&#1090; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1077;&#1085; &#1074; <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">cmpb</span>    $' ', <span style="color: #eedd82;">%al</span>       # |   | # (&#1069;&#1090;&#1086; &#1087;&#1088;&#1086;&#1073;&#1077;&#1083;, &#1074;&#1086;&#1079;&#1088;&#1072;&#1090; &#1082;&#1072;&#1088;&#1077;&#1090;&#1082;&#1080;, &#1087;&#1077;&#1088;&#1077;&#1074;&#1086;&#1076; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;)?
    <span style="color: #00ffff;">ja</span>      2b              #-+   | # &#1045;&#1089;&#1083;&#1080; &#1085;&#1077;&#1090;, &#1087;&#1086;&#1074;&#1090;&#1086;&#1088;&#1080;&#1084;
    #                       #     |
    # &#1042;&#1077;&#1088;&#1085;&#1077;&#1084; &#1089;&#1083;&#1086;&#1074;&#1086; (&#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1089;&#1090;&#1072;&#1090;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1073;&#1091;&#1092;&#1077;&#1088; &#1095;&#1077;&#1088;&#1077;&#1093; <span style="color: #eedd82;">%rcx</span>) &#1080; &#1077;&#1075;&#1086; &#1076;&#1083;&#1080;&#1085;&#1091; (&#1095;&#1077;&#1088;&#1077;&#1079; <span style="color: #eedd82;">%rdi</span>)
    <span style="color: #00ffff;">sub</span>     $word_buffer, <span style="color: #eedd82;">%rdi</span>  # |
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rdi</span>, <span style="color: #eedd82;">%rcx</span>      #     | # return: &#1076;&#1083;&#1080;&#1085;&#1072; &#1089;&#1083;&#1086;&#1074;&#1072;
    <span style="color: #00ffff;">mov</span>     $word_buffer, <span style="color: #eedd82;">%rdi</span>  # | # return: &#1072;&#1076;&#1088;&#1077;&#1089; &#1073;&#1091;&#1092;&#1077;&#1088;&#1072;
    <span style="color: #00ffff;">ret</span>                     #     |
    # ----------------- RET       |
    #                             |
    # &#1069;&#1090;&#1086; &#1082;&#1086;&#1084;&#1084;&#1077;&#1085;&#1090;&#1072;&#1088;&#1080;&#1081;, &#1087;&#1088;&#1086;&#1087;&#1091;&#1089;&#1082;&#1072;&#1077;&#1084; | &#1077;&#1075;&#1086; &#1076;&#1086; &#1082;&#1086;&#1085;&#1094;&#1072; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
<span style="color: #87cefa;">3</span>:                      # &lt;---+ &lt;-+
    <span style="color: #00ffff;">call</span>    _KEY            # |
    <span style="color: #00ffff;">cmpb</span>    $'\n', <span style="color: #eedd82;">%al</span>      # |     # KEY &#1074;&#1077;&#1088;&#1085;&#1091;&#1083; &#1082;&#1086;&#1085;&#1077;&#1094; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;?
    <span style="color: #00ffff;">jne</span>     3b              #-+     # &#1053;&#1077;&#1090;, &#1087;&#1086;&#1074;&#1090;&#1086;&#1088;&#1080;&#1084;
    <span style="color: #00ffff;">jmp</span>     1b              #
    # ---------------- to 1

    <span style="color: #00ffff;">.data</span>
    # &#1057;&#1090;&#1072;&#1090;&#1080;&#1095;&#1077;&#1089;&#1082;&#1080;&#1081; &#1073;&#1091;&#1092;&#1077;&#1088;, &#1074; &#1082;&#1086;&#1090;&#1086;&#1088;&#1086;&#1084; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090;&#1089;&#1103; WORD.
    # &#1055;&#1086;&#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1080;&#1077; &#1074;&#1099;&#1079;&#1086;&#1074;&#1099; &#1087;&#1077;&#1088;&#1077;&#1079;&#1072;&#1087;&#1080;&#1089;&#1099;&#1074;&#1072;&#1102;&#1090; &#1101;&#1090;&#1086;&#1090; &#1073;&#1091;&#1092;&#1077;&#1088;.
    # &#1052;&#1072;&#1082;&#1089;&#1080;&#1084;&#1072;&#1083;&#1100;&#1085;&#1072;&#1103; &#1076;&#1083;&#1080;&#1085;&#1072; &#1089;&#1083;&#1086;&#1074;&#1072; - 32 &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1072;.
<span style="color: #87cefa;">word_buffer</span>:
    <span style="color: #00ffff;">.space</span> 32
</pre>
</div>


<div class="org-src-container">

<pre class="src src-asm" id="word_number"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"NUMBER"</span>,6,,NUMBER
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rcx</span>            # length of string
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>            # start address of string
    <span style="color: #00ffff;">call</span>    _NUMBER
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>            # parsed number
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rcx</span>            # number of unparsed characters (0 = no error)
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">_NUMBER</span>:
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%rbx</span>, <span style="color: #eedd82;">%rbx</span>
    # &#1055;&#1086;&#1087;&#1099;&#1090;&#1082;&#1072; &#1088;&#1072;&#1089;&#1087;&#1072;&#1088;&#1089;&#1080;&#1090;&#1100; &#1087;&#1091;&#1089;&#1090;&#1091;&#1102; &#1089;&#1090;&#1088;&#1086;&#1082;&#1091; &#1101;&#1090;&#1086; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072; &#1085;&#1086; &#1084;&#1099; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084; 0
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rcx</span>, <span style="color: #eedd82;">%rcx</span>
    <span style="color: #00ffff;">jz</span>  5f                  #-&gt; RET #
    # &#1057;&#1090;&#1088;&#1086;&#1082;&#1072; &#1085;&#1077; &#1087;&#1091;&#1089;&#1090;&#1072;, &#1073;&#1091;&#1076;&#1077;&#1084; &#1088;&#1072;&#1079;&#1073;&#1080;&#1088;&#1072;&#1090;&#1100;
    <span style="color: #00ffff;">mov</span>     (var_BASE), <span style="color: #eedd82;">%rdx</span>#       # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; BASE &#1074; <span style="color: #eedd82;">%dl</span>
    # &#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1080;&#1084;, &#1084;&#1086;&#1078;&#1077;&#1090; &#1073;&#1099;&#1090;&#1100; &#1087;&#1077;&#1088;&#1074;&#1099;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; '-'?
    <span style="color: #00ffff;">movb</span>    (<span style="color: #eedd82;">%rdi</span>), <span style="color: #eedd82;">%bl</span>     #       # <span style="color: #eedd82;">%bl</span> = &#1087;&#1077;&#1088;&#1074;&#1099;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">inc</span>     <span style="color: #eedd82;">%rdi</span>            #       #
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>            #       # push 0 &#1074; &#1089;&#1090;&#1077;&#1082;
    <span style="color: #00ffff;">cmpb</span>    $'-', <span style="color: #eedd82;">%bl</span>       #       # (&#1054;&#1090;&#1088;&#1080;&#1094;&#1072;&#1090;&#1077;&#1083;&#1100;&#1085;&#1086;&#1077; &#1095;&#1080;&#1089;&#1083;&#1086;)?
    <span style="color: #00ffff;">jnz</span> 2f                  #-+     # ?-&#1053;&#1077;&#1090;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1082; &#1082;&#1086;&#1085;&#1074;&#1077;&#1088;&#1090;&#1072;&#1094;&#1080;&#1080; (2)
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # |     # ?-&#1044;&#1072;, &#1079;&#1072;&#1073;&#1077;&#1088;&#1077;&#1084; &#1086;&#1073;&#1088;&#1072;&#1090;&#1085;&#1086; 0 &#1080;&#1079; &#1089;&#1090;&#1077;&#1082;&#1072;,
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rbx</span>            # |     #       push &#1085;&#1077; &#1085;&#1086;&#1083;&#1100; &#1074; &#1089;&#1090;&#1077;&#1082;, &#1082;&#1072;&#1082; &#1080;&#1085;&#1076;&#1080;&#1082;&#1072;&#1090;&#1086;&#1088; &#1086;&#1090;&#1088;&#1080;&#1094;&#1072;&#1090;&#1077;&#1083;&#1100;&#1085;&#1086;&#1075;&#1086;
    <span style="color: #00ffff;">dec</span>     <span style="color: #eedd82;">%rcx</span>            # |     #       &#1091;&#1084;&#1077;&#1085;&#1100;&#1096;&#1080;&#1084; &#1089;&#1095;&#1077;&#1090;&#1095;&#1080;&#1082; &#1086;&#1089;&#1090;&#1072;&#1074;&#1096;&#1080;&#1093;&#1089;&#1103; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074;
    <span style="color: #00ffff;">jnz</span> 1f                  #-----+ #       (&#1057;&#1090;&#1088;&#1086;&#1082;&#1072; &#1079;&#1072;&#1082;&#1086;&#1085;&#1095;&#1080;&#1083;&#1072;&#1089;&#1100;)? ?-&#1053;&#1077;&#1090;: &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076; &#1085;&#1072; (1)
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>            # |   | #       ?-&#1044;&#1072; - &#1101;&#1090;&#1086; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072;, &#1089;&#1090;&#1088;&#1086;&#1082;&#1072; <span style="color: #ffa07a;">"-"</span>. &#1047;&#1072;&#1073;&#1080;&#1088;&#1072;&#1077;&#1084; &#1080;&#1079; &#1089;&#1090;&#1077;&#1082;&#1072;
    <span style="color: #00ffff;">mov</span>     $1, <span style="color: #eedd82;">%rcx</span>        # |   | #            &#1087;&#1086;&#1084;&#1077;&#1097;&#1072;&#1077;&#1084; &#1074; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;&#1091;&#1102; &#1085;&#1077;&#1088;&#1072;&#1089;&#1087;&#1072;&#1088;&#1089;&#1077;&#1085;&#1085;&#1091;&#1102; &#1076;&#1083;&#1080;&#1085;&#1091;
    <span style="color: #00ffff;">ret</span>                     # |   | #            &#1077;&#1076;&#1080;&#1085;&#1080;&#1094;&#1091; &#1080; &#1074;&#1099;&#1093;&#1086;&#1076;&#1080;&#1084;.
    # --------------------- # |   | # -------------------------------------------------------
    # &#1062;&#1080;&#1082;&#1083; &#1095;&#1090;&#1077;&#1085;&#1080;&#1103; &#1095;&#1080;&#1089;&#1077;&#1083;     # |   | #
<span style="color: #87cefa;">1</span>:  #                    &lt;========+ #
    <span style="color: #00ffff;">imul</span>    <span style="color: #eedd82;">%rdx</span>, <span style="color: #eedd82;">%rax</span>      # |   | # <span style="color: #eedd82;">%rax</span> *= BASE
    <span style="color: #00ffff;">movb</span>    (<span style="color: #eedd82;">%rdi</span>), <span style="color: #eedd82;">%bl</span>     # |   | # <span style="color: #eedd82;">%bl</span> = &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1080;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; &#1074; &#1089;&#1090;&#1088;&#1086;&#1082;&#1077;
    <span style="color: #00ffff;">inc</span>     <span style="color: #eedd82;">%rdi</span>            # |   | # &#1059;&#1074;&#1077;&#1083;&#1080;&#1095;&#1080;&#1074;&#1072;&#1077;&#1084; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100;
<span style="color: #87cefa;">2</span>:  #                    &lt;----+   | #
    # &#1055;&#1088;&#1077;&#1086;&#1073;&#1088;&#1072;&#1079;&#1091;&#1077;&#1084; 0-9, A-Z &#1074; &#1095;&#1080;&#1089;&#1083;&#1072; 0-35.
    <span style="color: #00ffff;">subb</span>    $'0', <span style="color: #eedd82;">%bl</span>       #     | # (&lt; '0')?
    <span style="color: #00ffff;">jb</span>  4f                  #---+ | # ?-&#1044;&#1072;, &#1093;&#1077;&#1088;&#1085;&#1103; &#1082;&#1072;&#1082;&#1072;&#1103;-&#1090;&#1086;, &#1072; &#1085;&#1077; &#1094;&#1080;&#1092;&#1088;&#1072;, &#1086;&#1096;&#1080;&#1073;&#1082;&#1072;, &#1080;&#1076;&#1077;&#1084; &#1085;&#1072; (4)
    <span style="color: #00ffff;">cmp</span>     $10, <span style="color: #eedd82;">%bl</span>        #   | | # ?-&#1053;&#1077;&#1090;, (&lt;= '9')?
    <span style="color: #00ffff;">jb</span>  3f                  #-+ | | #        ?-&#1044;&#1072;, &#1080;&#1076;&#1077;&#1084; &#1085;&#1072; (3), &#1101;&#1090;&#1086; &#1095;&#1080;&#1089;&#1083;&#1086; &#1084;&#1077;&#1078;&#1076;&#1091; 0 &#1080; 9
    <span style="color: #00ffff;">subb</span>    $17, <span style="color: #eedd82;">%bl</span>        # | | | #        ?-&#1053;&#1077;&#1090;, (&lt; 'A')? &#1087;&#1086;&#1090;&#1086;&#1084;&#1091; &#1095;&#1090;&#1086; (17 = 'A'-'0')
    <span style="color: #00ffff;">jb</span>  4f                  #---+ | #               ?-&#1044;&#1072;, &#1101;&#1090;&#1086; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072;, &#1080;&#1076;&#1077;&#1084; &#1085;&#1072; (4)
    <span style="color: #00ffff;">addb</span>    $10, <span style="color: #eedd82;">%bl</span>        # | | | #               ?-&#1053;&#1077;&#1090;, &#1076;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; &#1082; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1102; 10
<span style="color: #87cefa;">3</span>:  #                     &lt;---+ | | #
    <span style="color: #00ffff;">cmp</span>     <span style="color: #eedd82;">%dl</span>, <span style="color: #eedd82;">%bl</span>        #   | | #                      (RESULT &gt;= BASE)?
    <span style="color: #00ffff;">jge</span> 4f                  #---+ | #                      ?-&#1044;&#1072;, &#1087;&#1077;&#1088;&#1077;&#1073;&#1086;&#1088;, &#1080;&#1076;&#1077;&#1084; &#1085;&#1072; (4)
    <span style="color: #00ffff;">add</span>     <span style="color: #eedd82;">%rbx</span>, <span style="color: #eedd82;">%rax</span>      #   | | #                      ?-&#1053;&#1077;&#1090;, &#1074;&#1089;&#1077; &#1074; &#1087;&#1086;&#1088;&#1103;&#1076;&#1082;&#1077;. &#1044;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084;
    <span style="color: #00ffff;">dec</span>     <span style="color: #eedd82;">%rcx</span>            #   | | #                        RESULT &#1082; <span style="color: #eedd82;">%rax</span> &#1080; LOOP-&#1080;&#1084; &#1076;&#1072;&#1083;&#1100;&#1096;&#1077;.
    <span style="color: #00ffff;">jnz</span> 1b                  #---|-+ #
<span style="color: #87cefa;">4</span>:  #                     &lt;-----+   #
    # &#1058;&#1091;&#1090; &#1084;&#1099; &#1086;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1084;&#1089;&#1103; &#1077;&#1089;&#1083;&#1080; &#1094;&#1080;&#1082;&#1083; &#1079;&#1072;&#1082;&#1086;&#1085;&#1095;&#1080;&#1083;&#1089;&#1103; - &#1090;&#1086;&#1075;&#1076;&#1072; &#1091; &#1085;&#1072;&#1089; <span style="color: #eedd82;">%rcx</span>=0
    # &#1042; &#1080;&#1085;&#1086;&#1084; &#1089;&#1083;&#1091;&#1095;&#1072;&#1077; <span style="color: #eedd82;">%rcx</span> &#1089;&#1086;&#1076;&#1077;&#1088;&#1078;&#1080;&#1090; &#1082;&#1086;&#1083;&#1080;&#1095;&#1077;&#1089;&#1090;&#1074;&#1086; &#1085;&#1077;&#1088;&#1072;&#1089;&#1087;&#1072;&#1088;&#1089;&#1077;&#1085;&#1085;&#1099;&#1093; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074;
    # &#1045;&#1089;&#1083;&#1080; &#1091; &#1085;&#1072;&#1089; &#1086;&#1090;&#1088;&#1080;&#1094;&#1072;&#1090;&#1077;&#1083;&#1100;&#1085;&#1099;&#1081; &#1088;&#1077;&#1079;&#1091;&#1083;&#1100;&#1090;&#1072;&#1090;, &#1090;&#1086; &#1087;&#1077;&#1088;&#1074;&#1099;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; '-' (&#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1077;&#1085; &#1074; &#1089;&#1090;&#1077;&#1082;&#1077;)
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>            #       #
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rbx</span>, <span style="color: #eedd82;">%rbx</span>      #       # (&#1054;&#1090;&#1088;&#1080;&#1094;&#1072;&#1090;&#1077;&#1083;&#1100;&#1085;&#1086;&#1077; &#1095;&#1080;&#1089;&#1083;&#1086;)?
    <span style="color: #00ffff;">jz</span>  5f                  #-+     # ?-&#1053;&#1077;&#1090;, &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084; &#1082;&#1072;&#1082; &#1077;&#1089;&#1090;&#1100; (5)
    <span style="color: #00ffff;">neg</span>     <span style="color: #eedd82;">%rax</span>            # |     # ?-&#1044;&#1072;, &#1080;&#1085;&#1074;&#1077;&#1088;&#1090;&#1080;&#1088;&#1091;&#1077;&#1084;
<span style="color: #87cefa;">5</span>:  #                     &lt;---+
    <span style="color: #00ffff;">ret</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-19" class="outline-3">
<h3 id="unnumbered-19">FIND - просмотр словаря</h3>
<div class="outline-text-3" id="text-unnumbered-19">
<div class="org-src-container">

<pre class="src src-asm" id="word_find">    <span style="color: #00ffff;">defcode</span> <span style="color: #ffa07a;">"FIND"</span>,4,,FIND
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rcx</span>            # <span style="color: #eedd82;">%rcx</span> = &#1076;&#1083;&#1080;&#1085;&#1072; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>            # <span style="color: #eedd82;">%rdi</span> = &#1072;&#1076;&#1088;&#1077;&#1089; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">call</span>    _FIND
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>            # <span style="color: #eedd82;">%rax</span> = &#1072;&#1076;&#1088;&#1077;&#1089; &#1089;&#1083;&#1086;&#1074;&#1072; (&#1080;&#1083;&#1080; &#1085;&#1086;&#1083;&#1100;)
    <span style="color: #00ffff;">NEXT</span>
<span style="color: #87cefa;">_FIND</span>:
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rsi</span>            # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1084; <span style="color: #eedd82;">%rsi</span> - &#1090;&#1072;&#1082; &#1084;&#1099; &#1089;&#1084;&#1086;&#1078;&#1077;&#1084; &#1080;&#1089;&#1087;&#1086;&#1083;&#1100;&#1079;&#1086;&#1074;&#1072;&#1090;&#1100; &#1101;&#1090;&#1086;&#1090;
                            # &#1088;&#1077;&#1075;&#1080;&#1089;&#1090;&#1088; &#1076;&#1083;&#1103; &#1089;&#1088;&#1072;&#1074;&#1085;&#1077;&#1085;&#1080;&#1103; &#1089;&#1090;&#1088;&#1086;&#1082; &#1082;&#1086;&#1084;&#1072;&#1085;&#1076;&#1086;&#1081; CMPSB
    # &#1047;&#1076;&#1077;&#1089;&#1100; &#1084;&#1099; &#1085;&#1072;&#1095;&#1080;&#1085;&#1072;&#1077;&#1084; &#1080;&#1089;&#1082;&#1072;&#1090;&#1100; &#1074; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1077; &#1101;&#1090;&#1086; &#1089;&#1083;&#1086;&#1074;&#1086; &#1086;&#1090; &#1082;&#1086;&#1085;&#1094;&#1072; &#1082; &#1085;&#1072;&#1095;&#1072;&#1083;&#1091; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1103;
    <span style="color: #00ffff;">mov</span>     (var_LATEST), <span style="color: #eedd82;">%rdx</span>          # <span style="color: #eedd82;">%rdx</span> &#1090;&#1077;&#1087;&#1077;&#1088;&#1100; &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; &#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1077;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086; &#1074; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1077;
<span style="color: #87cefa;">1</span>:  #                   &lt;------------+
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rdx</span>, <span style="color: #eedd82;">%rdx</span>      # (&#1074; <span style="color: #eedd82;">%rdx</span> &#1085;&#1072;&#1093;&#1086;&#1076;&#1080;&#1090;&#1089;&#1103; NULL-&#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100;, &#1090;.&#1077;. &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1100; &#1082;&#1086;&#1085;&#1095;&#1080;&#1083;&#1089;&#1103;)?
    <span style="color: #00ffff;">je</span>  4f                  #-----+  |  # ?-&#1044;&#1072;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074;&#1087;&#1077;&#1088;&#1077;&#1076; &#1082; (4)
    #                             |  |
    # &#1057;&#1088;&#1072;&#1074;&#1085;&#1080;&#1084; &#1086;&#1078;&#1080;&#1076;&#1072;&#1077;&#1084;&#1091;&#1102; &#1076;&#1083;&#1080;&#1085;&#1091; &#1080; &#1076;&#1083;&#1080;&#1085;&#1091; &#1089;&#1083;&#1086;&#1074;&#1072;
    # &#1042;&#1085;&#1080;&#1084;&#1072;&#1085;&#1080;&#1077;, &#1077;&#1089;&#1083;&#1080; F_HIDDEN &#1091;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1083;&#1077;&#1085; &#1076;&#1083;&#1103; &#1101;&#1090;&#1086;&#1075;&#1086; &#1089;&#1083;&#1086;&#1074;&#1072;, &#1090;&#1086; &#1089;&#1086;&#1074;&#1087;&#1072;&#1076;&#1077;&#1085;&#1080;&#1103; &#1085;&#1077; &#1073;&#1091;&#1076;&#1077;&#1090;.
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>      #     |  |  # &#1054;&#1095;&#1080;&#1097;&#1072;&#1077;&#1084; <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">movb</span>    8(<span style="color: #eedd82;">%rdx</span>), <span style="color: #eedd82;">%al</span>    #     |  |  # <span style="color: #eedd82;">%al</span> = flags+length
    <span style="color: #00ffff;">andb</span>    $(F_HIDDEN|F_LENMASK), <span style="color: #eedd82;">%al</span>  # <span style="color: #eedd82;">%al</span> = &#1090;&#1077;&#1087;&#1077;&#1088;&#1100; &#1076;&#1083;&#1080;&#1085;&#1072; &#1080;&#1084;&#1077;&#1085;&#1080; (&#1084;&#1072;&#1089;&#1082;&#1080;&#1088;&#1091;&#1077;&#1084; &#1092;&#1083;&#1072;&#1075;&#1080;)
    <span style="color: #00ffff;">cmpb</span>    <span style="color: #eedd82;">%cl</span>, <span style="color: #eedd82;">%al</span>        #     |  |  # (&#1044;&#1083;&#1080;&#1085;&#1099; &#1086;&#1076;&#1080;&#1085;&#1072;&#1082;&#1086;&#1074;&#1099;&#1077;?)
    <span style="color: #00ffff;">jne</span> 2f                  #--+  |  |  # ?-&#1053;&#1077;&#1090;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074;&#1087;&#1077;&#1088;&#1077;&#1076; &#1082; (2)
    #                          |  |  |
    # &#1055;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1082; &#1076;&#1077;&#1090;&#1072;&#1083;&#1100;&#1085;&#1086;&#1084;&#1091; &#1089;&#1088;&#1072;&#1074;&#1085;&#1077;&#1085;&#1080;&#1102;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rcx</span>            #  |  |  |  # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1084; &#1076;&#1083;&#1080;&#1085;&#1091;, &#1087;&#1086;&#1090;&#1086;&#1084;&#1091; &#1095;&#1090;&#1086; repe cmpsb &#1091;&#1084;&#1077;&#1085;&#1100;&#1096;&#1072;&#1077;&#1090; <span style="color: #eedd82;">%rcx</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rdi</span>            #  |  |  |  # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1084; &#1072;&#1076;&#1088;&#1077;&#1089;, &#1087;&#1086;&#1090;&#1086;&#1084;&#1091; &#1095;&#1090;&#1086; repe cmpsb &#1076;&#1074;&#1080;&#1075;&#1072;&#1077;&#1090; <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">lea</span>     9(<span style="color: #eedd82;">%rdx</span>), <span style="color: #eedd82;">%rsi</span>   #  |  |  |  # &#1047;&#1072;&#1075;&#1088;&#1091;&#1078;&#1072;&#1077;&#1084; &#1074; <span style="color: #eedd82;">%rsi</span> &#1072;&#1076;&#1088;&#1077;&#1089; &#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1080;&#1084;&#1077;&#1085;&#1080; &#1089;&#1083;&#1086;&#1074;&#1072;
    <span style="color: #00ffff;">repe</span>    cmpsb           #  |  |  |  # &#1057;&#1088;&#1072;&#1074;&#1085;&#1080;&#1074;&#1072;&#1077;&#1084;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>            #  |  |  |  # &#1042;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; &#1072;&#1076;&#1088;&#1077;&#1089;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rcx</span>            #  |  |  |  # &#1042;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1084; &#1076;&#1083;&#1080;&#1085;&#1091;
    <span style="color: #00ffff;">jne</span> 2f                  #--+  |  |  # ?-&#1045;&#1089;&#1083;&#1080; &#1085;&#1077; &#1088;&#1072;&#1074;&#1085;&#1099; - &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074;&#1087;&#1077;&#1088;&#1077;&#1076; &#1082; (2)
    #                          |  |  |
    # &#1057;&#1090;&#1088;&#1086;&#1082;&#1080; &#1088;&#1072;&#1074;&#1085;&#1099; - &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1080;&#1084; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1079;&#1072;&#1075;&#1086;&#1083;&#1086;&#1074;&#1086;&#1082; &#1074; <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rsi</span>            #  |  |  |  # &#1042;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1084; <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rdx</span>, <span style="color: #eedd82;">%rax</span>      #  |  |  |  # <span style="color: #eedd82;">%rdx</span> &#1074;&#1089;&#1077; &#1077;&#1097;&#1077; &#1089;&#1086;&#1076;&#1077;&#1088;&#1078;&#1080;&#1090; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1081; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;
    <span style="color: #00ffff;">ret</span>                     #  |  |  |  # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;
    # ----------------- RET    |  |  |
<span style="color: #87cefa;">2</span>:  #                     &lt;----+  |  |
    <span style="color: #00ffff;">mov</span>     (<span style="color: #eedd82;">%rdx</span>), <span style="color: #eedd82;">%rdx</span>    #     |  |  # &#1055;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1087;&#1086; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1102; &#1082; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1077;&#1084;&#1091; &#1089;&#1083;&#1086;&#1074;&#1091;
    <span style="color: #00ffff;">jmp</span> 1b                  #     |  |  # &#1048; &#1079;&#1072;&#1094;&#1080;&#1082;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084;&#1089;&#1103;
    # ----------------------------|--+
<span style="color: #87cefa;">4</span>:  #                     &lt;-------+
    # &#1057;&#1083;&#1086;&#1074;&#1086; &#1085;&#1077; &#1085;&#1072;&#1081;&#1076;&#1077;&#1085;&#1086;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rsi</span>            # &#1042;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1084; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1077;&#1085;&#1085;&#1099;&#1081; <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>      # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1080;&#1084; &#1085;&#1086;&#1083;&#1100; &#1074; <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">ret</span>                     # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;
</pre>
</div>


<div class="org-src-container">

<pre class="src src-asm" id="word_tcfa">    <span style="color: #00ffff;">defcode</span> <span style="color: #ffa07a;">"&gt;CFA"</span>,4,,TCFA
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">call</span>    _TCFA
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">NEXT</span>
<span style="color: #87cefa;">_TCFA</span>:
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">add</span>     $8, <span style="color: #eedd82;">%rdi</span>        # &#1055;&#1088;&#1086;&#1087;&#1091;&#1089;&#1082;&#1072;&#1077;&#1084; LINK - &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1087;&#1088;&#1077;&#1076;&#1099;&#1076;&#1091;&#1097;&#1077;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086;
    <span style="color: #00ffff;">movb</span>    (<span style="color: #eedd82;">%rdi</span>), <span style="color: #eedd82;">%al</span>     # &#1047;&#1072;&#1075;&#1088;&#1091;&#1078;&#1072;&#1077;&#1084; flags+len &#1074; <span style="color: #eedd82;">%al</span>
    <span style="color: #00ffff;">inc</span>     <span style="color: #eedd82;">%rdi</span>            # &#1055;&#1088;&#1086;&#1087;&#1091;&#1089;&#1082;&#1072;&#1077;&#1084; flags+len &#1073;&#1072;&#1081;&#1090;
    <span style="color: #00ffff;">andb</span>    $F_LENMASK, <span style="color: #eedd82;">%al</span> # &#1052;&#1072;&#1089;&#1082;&#1080;&#1088;&#1091;&#1077;&#1084;, &#1095;&#1090;&#1086;&#1073;&#1099; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1076;&#1083;&#1080;&#1085;&#1091; &#1080;&#1084;&#1077;&#1085;&#1080;, &#1073;&#1077;&#1079; &#1092;&#1083;&#1072;&#1075;&#1086;&#1074;
    <span style="color: #00ffff;">add</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rdi</span>      # &#1055;&#1088;&#1086;&#1087;&#1091;&#1089;&#1082;&#1072;&#1077;&#1084; &#1080;&#1084;&#1103;
    <span style="color: #00ffff;">add</span>     $(wordsize-1), <span style="color: #eedd82;">%rdi</span>        # &#1059;&#1095;&#1080;&#1090;&#1099;&#1074;&#1072;&#1077;&#1084; &#1074;&#1099;&#1088;&#1072;&#1074;&#1085;&#1080;&#1074;&#1072;&#1085;&#1080;&#1077;
    <span style="color: #00ffff;">and</span>     $~(wordsize-1), <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">ret</span>
</pre>
</div>


<div class="org-src-container">

<pre class="src src-asm" id="word_tdfa"><span style="color: #87cefa;">defword</span> <span style="color: #ffa07a;">"&gt;DFA"</span>,4,,TDFA
    <span style="color: #00ffff;">.quad</span> TCFA       # &gt;CFA     (&#1087;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; code field address)
    <span style="color: #00ffff;">.quad</span> INCR8      # 8+       (&#1076;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; 8, &#1095;&#1090;&#1086;&#1073;&#1099; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1072;&#1076;&#1088;&#1077;&#1089; &#1087;&#1077;&#1088;&#1074;&#1086;&#1075;&#1086; &#1089;&#1083;&#1086;&#1074;&#1072; &#1074; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1085;&#1080;&#1080;)
    <span style="color: #00ffff;">.quad</span> EXIT       # EXIT     (&#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;&#1089;&#1103;)
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-20" class="outline-3">
<h3 id="unnumbered-20">Компиляция</h3>
<div class="outline-text-3" id="text-unnumbered-20">
<div class="org-src-container">

<pre class="src src-asm" id="word_create"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"CREATE"</span>,6,,CREATE

    # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; length &#1080; address &#1080;&#1084;&#1077;&#1085;&#1080; &#1080;&#1079; &#1089;&#1090;&#1077;&#1082;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rcx</span>            # <span style="color: #eedd82;">%rcx</span> = length
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rbx</span>            # <span style="color: #eedd82;">%rbx</span> = address

    # &#1060;&#1086;&#1088;&#1084;&#1080;&#1088;&#1091;&#1077;&#1084; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; LINK
    <span style="color: #00ffff;">mov</span>     (var_HERE), <span style="color: #eedd82;">%rdi</span># <span style="color: #eedd82;">%rdi</span> &#1090;&#1077;&#1087;&#1077;&#1088;&#1100; &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; &#1079;&#1072;&#1075;&#1086;&#1083;&#1086;&#1074;&#1086;&#1082;
    <span style="color: #00ffff;">mov</span>     (var_LATEST), <span style="color: #eedd82;">%rax</span> # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1087;&#1086;&#1089;&#1083;&#1077;&#1076;&#1085;&#1077;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086; -
                            # - &#1101;&#1090;&#1086; LINK &#1089;&#1086;&#1079;&#1076;&#1072;&#1074;&#1072;&#1077;&#1084;&#1086;&#1075;&#1086; &#1089;&#1083;&#1086;&#1074;&#1072;
    <span style="color: #00ffff;">stosq</span>                   # &#1080; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1077;&#1084; &#1077;&#1075;&#1086; &#1074; &#1092;&#1086;&#1088;&#1084;&#1080;&#1088;&#1091;&#1077;&#1084;&#1086;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086;

    # &#1060;&#1086;&#1088;&#1084;&#1080;&#1088;&#1091;&#1077;&#1084; &#1041;&#1072;&#1081;&#1090; &#1076;&#1083;&#1080;&#1085;&#1099; &#1080; &#1080;&#1084;&#1103; &#1089;&#1083;&#1086;&#1074;&#1072;
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%cl</span>,<span style="color: #eedd82;">%al</span>         # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1076;&#1083;&#1080;&#1085;&#1091;
    <span style="color: #00ffff;">stosb</span>                   # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1077;&#1084; length/flags &#1073;&#1072;&#1081;&#1090;.
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rsi</span>            # &#1053;&#1077;&#1085;&#1072;&#1076;&#1086;&#1083;&#1075;&#1086; &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1084; <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rbx</span>, <span style="color: #eedd82;">%rsi</span>      # &#1074; <span style="color: #eedd82;">%rsi</span> &#1090;&#1077;&#1087;&#1077;&#1088;&#1100; &#1072;&#1076;&#1088;&#1077;&#1089; &#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1080;&#1084;&#1077;&#1085;&#1080;
    <span style="color: #00ffff;">rep</span>     movsb           # &#1050;&#1086;&#1087;&#1080;&#1088;&#1091;&#1077;&#1084; &#1080;&#1084;&#1103; &#1089;&#1083;&#1086;&#1074;&#1072;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rsi</span>            # &#1042;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1084; <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">add</span>     $(wordsize-1), <span style="color: #eedd82;">%rdi</span>        # &#1042;&#1099;&#1095;&#1080;&#1089;&#1083;&#1080;&#1084; &#1074;&#1099;&#1088;&#1072;&#1074;&#1085;&#1080;&#1074;&#1072;&#1085;&#1080;&#1077;
    <span style="color: #00ffff;">and</span>     $~(wordsize-1), <span style="color: #eedd82;">%rdi</span>

    # &#1054;&#1073;&#1085;&#1086;&#1074;&#1080;&#1084; LATEST &#1080; HERE.
    <span style="color: #00ffff;">mov</span>     (var_HERE), <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rax</span>, (var_LATEST)
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rdi</span>, (var_HERE)
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>


<div class="org-src-container">

<pre class="src src-asm" id="word_comma"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">","</span>,1,,COMMA
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>      # &#1042;&#1079;&#1103;&#1090;&#1100; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1074; <span style="color: #eedd82;">%rax</span> &#1090;&#1086; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077;, &#1082;&#1086;&#1090;&#1086;&#1088;&#1086;&#1077; &#1073;&#1091;&#1076;&#1077;&#1084; &#1074;&#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1080;&#1074;&#1072;&#1090;&#1100;
    <span style="color: #00ffff;">call</span>    _COMMA
    <span style="color: #00ffff;">NEXT</span>
<span style="color: #87cefa;">_COMMA</span>:
    <span style="color: #00ffff;">mov</span>     (var_HERE), <span style="color: #eedd82;">%rdi</span>  # &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; HERE &#1074; <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">stosq</span>                     # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1100; &#1087;&#1086; &#1085;&#1077;&#1084;&#1091; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1080;&#1079; <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rdi</span>, (var_HERE)  # &#1054;&#1073;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; HERE (&#1080;&#1089;&#1087;&#1086;&#1083;&#1100;&#1079;&#1091;&#1103; &#1080;&#1085;&#1082;&#1088;&#1077;&#1084;&#1077;&#1085;&#1090;, &#1089;&#1076;&#1077;&#1083;&#1072;&#1085;&#1085;&#1099;&#1081; STOSQ)
    <span style="color: #00ffff;">ret</span>
</pre>
</div>


<div class="org-src-container">

<pre class="src src-asm" id="word_rbrac"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"["</span>,1,F_IMMED,LBRAC
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rax</span>, (var_STATE)   # &#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; STATE &#1074; 0
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"]"</span>,1,,RBRAC
    <span style="color: #00ffff;">movq</span>    $1, (var_STATE)     # &#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; STATE &#1074; 1
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>


<div class="org-src-container">

<pre class="src src-asm" id="word_colon"><span style="color: #87cefa;">defword</span> <span style="color: #ffa07a;">":"</span>,1,,COLON
    <span style="color: #00ffff;">.quad</span> WORD               # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1080;&#1084;&#1103; &#1085;&#1086;&#1074;&#1086;&#1075;&#1086; &#1089;&#1083;&#1086;&#1074;&#1072;
    <span style="color: #00ffff;">.quad</span> CREATE             # CREATE &#1079;&#1072;&#1075;&#1086;&#1083;&#1086;&#1074;&#1086;&#1082; &#1079;&#1072;&#1087;&#1080;&#1089;&#1080; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1103;
    <span style="color: #00ffff;">.quad</span> LIT, DOCOL, COMMA  # &#1044;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; DOCOL (&#1082;&#1072;&#1082; codeword).
    <span style="color: #00ffff;">.quad</span> LATEST, FETCH, HIDDEN # &#1044;&#1077;&#1083;&#1072;&#1077;&#1084; &#1089;&#1083;&#1086;&#1074;&#1086; &#1089;&#1082;&#1088;&#1099;&#1090;&#1099;&#1084; (&#1089;&#1084;. &#1085;&#1080;&#1078;&#1077; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1077; HIDDEN).
    <span style="color: #00ffff;">.quad</span> RBRAC              # &#1055;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1074; &#1088;&#1077;&#1078;&#1080;&#1084; &#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1103;&#1094;&#1080;&#1080;
    <span style="color: #00ffff;">.quad</span> EXIT               # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090; &#1080;&#1079; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080;
</pre>
</div>

<p>
<code>;</code> (SEMICOLON) также элегантно прост. Обратите внимание на флаг F＿IMMED.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_semicolon"><span style="color: #87cefa;">defword</span> <span style="color: #ffa07a;">";"</span>,1,F_IMMED,SEMICOLON
    <span style="color: #00ffff;">.quad</span> LIT, EXIT, COMMA   # &#1044;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; EXIT (&#1090;&#1072;&#1082; &#1089;&#1083;&#1086;&#1074;&#1086; &#1076;&#1077;&#1083;&#1072;&#1077;&#1090; RETURN).
    <span style="color: #00ffff;">.quad</span> LATEST, FETCH, HIDDEN # &#1055;&#1077;&#1088;&#1077;&#1082;&#1083;&#1102;&#1095;&#1072;&#1077;&#1084; HIDDEN flag  (&#1089;&#1084;. &#1085;&#1080;&#1078;&#1077; &#1076;&#1083;&#1103; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1103;).
    <span style="color: #00ffff;">.quad</span> LBRAC              # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1084;&#1089;&#1103; &#1074; IMMEDIATE &#1088;&#1077;&#1078;&#1080;&#1084;.
    <span style="color: #00ffff;">.quad</span> EXIT               # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090; &#1080;&#1079; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080;
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-21" class="outline-3">
<h3 id="unnumbered-21">Расширение компилятора</h3>
<div class="outline-text-3" id="text-unnumbered-21">
</div><div id="outline-container-unnumbered-22" class="outline-4">
<h4 id="unnumbered-22">IMMEDIATE</h4>
<div class="outline-text-4" id="text-unnumbered-22">
<div class="org-src-container">

<pre class="src src-asm" id="word_immediate"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"IMMEDIATE"</span>,9,F_IMMED,IMMEDIATE
    <span style="color: #00ffff;">mov</span>     (var_LATEST), <span style="color: #eedd82;">%rdi</span>  # LATEST &#1089;&#1083;&#1086;&#1074;&#1086; &#1074; <span style="color: #eedd82;">%rdi</span>.
    <span style="color: #00ffff;">add</span>     $8, <span style="color: #eedd82;">%rdi</span>            # &#1058;&#1077;&#1087;&#1077;&#1088;&#1100; <span style="color: #eedd82;">%rdi</span> &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; &#1073;&#1072;&#1081;&#1090; name/flags
    <span style="color: #00ffff;">xorb</span>    $F_IMMED, (<span style="color: #eedd82;">%rdi</span>)    # &#1055;&#1077;&#1088;&#1077;&#1082;&#1083;&#1102;&#1095;&#1080;&#1090;&#1100; the F_IMMED &#1073;&#1080;&#1090;.
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-23" class="outline-4">
<h4 id="unnumbered-23">HIDDEN</h4>
<div class="outline-text-4" id="text-unnumbered-23">
<div class="org-src-container">

<pre class="src src-asm" id="word_hidden"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"HIDDEN"</span>,6,,HIDDEN
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>                # &#1059;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1089;&#1083;&#1086;&#1074;&#1086; &#1074; <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">add</span>     $8, <span style="color: #eedd82;">%rdi</span>            # &#1058;&#1077;&#1087;&#1077;&#1088;&#1100; &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; &#1085;&#1072; &#1073;&#1072;&#1081;&#1090; length/flags.
    <span style="color: #00ffff;">xor</span>     $F_HIDDEN, (<span style="color: #eedd82;">%rdi</span>)   # &#1055;&#1077;&#1088;&#1077;&#1082;&#1083;&#1102;&#1095;&#1072;&#1077;&#1084; HIDDEN &#1073;&#1080;&#1090;.
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defword</span> <span style="color: #ffa07a;">"HIDE"</span>,4,,HIDE
    <span style="color: #00ffff;">.quad</span>    WORD                # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1089;&#1083;&#1086;&#1074;&#1086; (&#1080;&#1097;&#1091;&#1097;&#1077;&#1077; &#1079;&#1072; HIDE).
    <span style="color: #00ffff;">.quad</span>    FIND                # &#1048;&#1097;&#1077;&#1084; &#1077;&#1075;&#1086; &#1074; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1077;
    <span style="color: #00ffff;">.quad</span>    HIDDEN              # &#1059;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; F_HIDDEN &#1092;&#1083;&#1072;&#1075;.
    <span style="color: #00ffff;">.quad</span>    EXIT                # &#1042;&#1099;&#1093;&#1086;&#1076;&#1080;&#1084;
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-24" class="outline-4">
<h4 id="unnumbered-24">TICK</h4>
<div class="outline-text-4" id="text-unnumbered-24">
<div class="org-src-container">

<pre class="src src-asm" id="word_tick"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"'"</span>,1,,TICK
    <span style="color: #00ffff;">lodsq</span>                   # &#1055;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1072;&#1076;&#1088;&#1077;&#1089; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1077;&#1075;&#1086; &#1089;&#1083;&#1086;&#1074;&#1072; &#1080; &#1087;&#1088;&#1086;&#1087;&#1091;&#1089;&#1090;&#1080;&#1090;&#1100; &#1077;&#1075;&#1086;
    <span style="color: #00ffff;">push</span>     <span style="color: #eedd82;">%rax</span>           # Push &#1077;&#1075;&#1086; &#1074; &#1089;&#1090;&#1077;&#1082;
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-unnumbered-25" class="outline-3">
<h3 id="unnumbered-25">Ветвление</h3>
<div class="outline-text-3" id="text-unnumbered-25">
<div class="org-src-container">

<pre class="src src-asm" id="word_branch"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"BRANCH"</span>,6,,BRANCH
    <span style="color: #00ffff;">add</span>     (<span style="color: #eedd82;">%rsi</span>),<span style="color: #eedd82;">%rsi</span>     # &#1076;&#1086;&#1073;&#1072;&#1074;&#1080;&#1090;&#1100; offset &#1082; instruction pointer
    <span style="color: #00ffff;">NEXT</span>

<span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"0BRANCH"</span>,7,,ZBRANCH
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>      # &#1042;&#1077;&#1088;&#1096;&#1080;&#1085;&#1072; &#1089;&#1090;&#1077;&#1082;&#1072; &#1088;&#1072;&#1074;&#1085;&#1072; &#1085;&#1091;&#1083;&#1102;?
    <span style="color: #00ffff;">jz</span>      code_BRANCH     # &#1045;&#1089;&#1083;&#1080; &#1076;&#1072;, &#1074;&#1077;&#1088;&#1085;&#1091;&#1090;&#1100;&#1089;&#1103; &#1085;&#1072;&#1079;&#1072;&#1076; &#1082; &#1092;&#1091;&#1085;&#1082;&#1094;&#1080;&#1080; BRANCH &#1074;&#1099;&#1096;&#1077;
    <span style="color: #00ffff;">lodsq</span>                   # &#1080;&#1085;&#1072;&#1095;&#1077; &#1087;&#1088;&#1086;&#1087;&#1091;&#1089;&#1090;&#1080;&#1090;&#1100; &#1089;&#1084;&#1077;&#1097;&#1077;&#1085;&#1080;&#1077;
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-26" class="outline-3">
<h3 id="unnumbered-26">Строковые литералы - LITSTRING</h3>
<div class="outline-text-3" id="text-unnumbered-26">
<p>
LITSTRING - это примитив, используемый для реализации операторов <code> ." </code> И <code> S" </code> (которые
написаны в формате Forth). См. ниже определение этих операторов.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_lit"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"LITSTRING"</span>,9,,LITSTRING
    <span style="color: #00ffff;">lodsq</span>                   # &#1055;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1076;&#1083;&#1080;&#1085;&#1091; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rsi</span>            # push &#1072;&#1076;&#1088;&#1077;&#1089; &#1085;&#1072;&#1095;&#1072;&#1083;&#1072; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>            # push &#1076;&#1083;&#1080;&#1085;&#1091;
    <span style="color: #00ffff;">add</span>     <span style="color: #eedd82;">%rax</span>,<span style="color: #eedd82;">%rsi</span>       # &#1087;&#1088;&#1086;&#1087;&#1091;&#1089;&#1090;&#1080;&#1090;&#1100; &#1089;&#1090;&#1088;&#1086;&#1082;&#1091;
    <span style="color: #00ffff;">add</span>     $(wordsize-1),<span style="color: #eedd82;">%esi</span>         # &#1074;&#1099;&#1088;&#1086;&#1074;&#1085;&#1103;&#1090;&#1100;
    <span style="color: #00ffff;">and</span>     $~(wordsize-1),<span style="color: #eedd82;">%esi</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-27" class="outline-3">
<h3 id="unnumbered-27">Печать строки - TELL</h3>
<div class="outline-text-3" id="text-unnumbered-27">
<p>
TELL просто печатает строку. Это более эффективно определять в ассемблере, потому что
мы можем сделать это одним из системных вызовов Linux.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_tell"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"TELL"</span>,4,,TELL
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdx</span>                # param3: &#1076;&#1083;&#1080;&#1085;&#1072; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rcx</span>                # param2: &#1072;&#1076;&#1088;&#1077;&#1089; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080; &#1074;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086; &#1087;&#1086;&#1084;&#1077;&#1097;&#1072;&#1077;&#1084; &#1074; <span style="color: #eedd82;">%rcx</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rsi</span>                # save <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rdi</span>                # save <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">mov</span>     $stdout, <span style="color: #eedd82;">%rdi</span>       # param1: stdout
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rcx</span>, <span style="color: #eedd82;">%rsi</span>          # param2: &#1072;&#1076;&#1088;&#1077;&#1089; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1097;&#1072;&#1077;&#1084; &#1074; <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">mov</span>     $sys_write, <span style="color: #eedd82;">%rax</span>    # SYSCALL write
    <span style="color: #00ffff;">syscall</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>                # restore <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rsi</span>                # restore <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-28" class="outline-3">
<h3 id="unnumbered-28">QUIT</h3>
<div class="outline-text-3" id="text-unnumbered-28">
<div class="org-src-container">

<pre class="src src-asm" id="word_quit"># QUIT &#1085;&#1077; &#1076;&#1086;&#1083;&#1078;&#1085;&#1072; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1090;&#1100;&#1089;&#1103; (&#1090;&#1077; &#1077;&#1089;&#1090;&#1100; &#1074;&#1099;&#1079;&#1099;&#1074;&#1072;&#1090;&#1100; EXIT).
<span style="color: #87cefa;">defword</span> <span style="color: #ffa07a;">"QUIT"</span>,4,,QUIT
    # &#1055;&#1086;&#1083;&#1086;&#1078;&#1080;&#1090;&#1100; &#1082;&#1086;&#1085;&#1089;&#1090;&#1072;&#1085;&#1090;&#1091; RZ (&#1085;&#1072;&#1095;&#1072;&#1083;&#1100;&#1085;&#1086;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1089;&#1090;&#1077;&#1082;&#1072; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074;) &#1085;&#1072; &#1089;&#1090;&#1077;&#1082; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;&#1086;&#1074;.
    <span style="color: #00ffff;">.quad</span> RZ
    # &#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1090;&#1100; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077;, &#1083;&#1077;&#1078;&#1072;&#1097;&#1077;&#1077; &#1085;&#1072; &#1089;&#1090;&#1077;&#1082;&#1077; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;&#1086;&#1074;, &#1082;&#1072;&#1082; &#1085;&#1086;&#1074;&#1086;&#1077; &#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1080;&#1077; &#1074;&#1077;&#1088;&#1096;&#1080;&#1085;&#1099; &#1089;&#1090;&#1077;&#1082;&#1072; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074;
    <span style="color: #00ffff;">.quad</span> RSPSTORE       # &#1069;&#1090;&#1086; &#1086;&#1095;&#1080;&#1097;&#1072;&#1077;&#1090; &#1089;&#1090;&#1077;&#1082; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074;
    # &#1047;&#1072;&#1087;&#1091;&#1089;&#1090;&#1080;&#1090;&#1100; &#1080;&#1085;&#1090;&#1077;&#1088;&#1087;&#1088;&#1077;&#1090;&#1072;&#1090;&#1086;&#1088; &#1082;&#1086;&#1084;&#1072;&#1085;&#1076;                  &lt;------+
    <span style="color: #00ffff;">.quad</span> INTERPRET      # &#1048;&#1085;&#1090;&#1077;&#1088;&#1087;&#1088;&#1077;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1090;&#1100; &#1089;&#1083;&#1077;&#1076;&#1091;&#1102;&#1097;&#1077;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086;  |
    # &#1048; &#1085;&#1072;&#1074;&#1089;&#1077;&#1075;&#1076;&#1072; &#1079;&#1072;&#1094;&#1080;&#1082;&#1083;&#1080;&#1090;&#1100;&#1089;&#1103;                                 |
    <span style="color: #00ffff;">.quad</span> BRANCH,-16     # -----------------------------------
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-29" class="outline-3">
<h3 id="unnumbered-29">INTERPRET</h3>
<div class="outline-text-3" id="text-unnumbered-29">
<p>
INTERPRET является REPL (см.: <a href="http://en.wikipedia.org/wiki/REPL">http://en.wikipedia.org/wiki/REPL</a>) внутри Forth.
</p>

<p>
Этот интерпретатор довольно прост, но помните, что в Forth вы всегда можете
переопределить его более мощным!
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_interpret"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"INTERPRET"</span>,9,,INTERPRET
    <span style="color: #00ffff;">call</span>    _WORD           # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; <span style="color: #eedd82;">%rcx</span> = &#1076;&#1083;&#1080;&#1085;&#1091;, <span style="color: #eedd82;">%rdi</span> = &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1089;&#1083;&#1086;&#1074;&#1086;.
    # &#1045;&#1089;&#1090;&#1100; &#1083;&#1080; &#1089;&#1083;&#1086;&#1074;&#1086; &#1074; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1077;?
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rax</span>, (interpret_is_lit)    # &#1069;&#1090;&#1086; &#1085;&#1077; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083; (&#1080;&#1083;&#1080; &#1087;&#1086;&#1082;&#1072; &#1085;&#1077; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;)
    <span style="color: #00ffff;">call</span>    _FIND           #           # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; &#1074; <span style="color: #eedd82;">%eax</span> &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1079;&#1072;&#1075;&#1086;&#1083;&#1086;&#1074;&#1086;&#1082; &#1080;&#1083;&#1080; 0
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>      #           # (&#1057;&#1086;&#1074;&#1087;&#1072;&#1076;&#1077;&#1085;&#1080;&#1077;)?
    <span style="color: #00ffff;">jz</span>  1f                  #--------+  # ?-&#1053;&#1077; &#1076;&#1091;&#1084;&#1072;&#1102;! &#1055;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076; &#1074;&#1087;&#1077;&#1088;&#1077;&#1076; &#1082; (1)
    # &#1069;&#1090;&#1086; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1085;&#1086;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086;   #        |  # ?-&#1044;&#1072;. &#1053;&#1072;&#1081;&#1076;&#1077;&#1085;&#1086; &#1089;&#1086;&#1074;&#1087;&#1072;&#1076;&#1072;&#1102;&#1097;&#1077;&#1077; &#1089;&#1083;&#1086;&#1074;&#1086;. &#1055;&#1088;&#1086;&#1076;&#1086;&#1083;&#1078;&#1072;&#1077;&#1084;.
    # &#1069;&#1090;&#1086; IMMEDIATE-&#1089;&#1083;&#1086;&#1074;&#1086;?  #        |  #
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rdi</span>      #        |  # <span style="color: #eedd82;">%edi</span> = &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1089;&#1083;&#1086;&#1074;&#1086;
    <span style="color: #00ffff;">movb</span>    8(<span style="color: #eedd82;">%rdi</span>), <span style="color: #eedd82;">%al</span>    #        |  # <span style="color: #eedd82;">%al</span> = flags+length.
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>            #        |  # &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1080;&#1084; &#1077;&#1075;&#1086; (flags+length) &#1085;&#1077;&#1085;&#1072;&#1076;&#1086;&#1083;&#1075;&#1086;
    <span style="color: #00ffff;">call</span>    _TCFA           #        |  # &#1055;&#1088;&#1077;&#1086;&#1073;&#1088;&#1072;&#1079;&#1091;&#1077;&#1084; entry (&#1074; <span style="color: #eedd82;">%rdi</span>) &#1074; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; codeword
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            #        |  # &#1042;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1084; flags+length
    <span style="color: #00ffff;">andb</span>    $F_IMMED, <span style="color: #eedd82;">%al</span>   #        |  # (&#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1083;&#1077;&#1085; &#1092;&#1083;&#1072;&#1075; F_IMMED)?
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rdi</span>, <span style="color: #eedd82;">%rax</span>      #        |  # <span style="color: #eedd82;">%rdi</span>-&gt;<span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">jnz</span>     4f              #--------|-+# ?-&#1044;&#1072;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1089;&#1088;&#1072;&#1079;&#1091; &#1082; &#1074;&#1099;&#1087;&#1086;&#1083;&#1085;&#1077;&#1085;&#1080;&#1102; (4)
    <span style="color: #00ffff;">jmp</span> 2f                  #--+     | |# ?-&#1053;&#1077;&#1090;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1082; &#1087;&#1088;&#1086;&#1074;&#1077;&#1088;&#1082;&#1077; &#1088;&#1077;&#1078;&#1080;&#1084;&#1072; &#1088;&#1072;&#1073;&#1086;&#1090;&#1099; (2)
    # --------------------- #  |     | |# -------------------------------------------------
<span style="color: #87cefa;">1</span>:  #                   &lt;------|-----+ |
    # &#1053;&#1077;&#1090; &#1074; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1077;, &#1073;&#1091;&#1076;&#1077;&#1084; &#1089;&#1095;&#1080;&#1090;&#1072;&#1090;&#1100;, &#1095;&#1090;&#1086; &#1101;&#1090;&#1086; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;
    <span style="color: #00ffff;">incq</span>    (interpret_is_lit)#|       |# &#1059;&#1089;&#1090;&#1072;&#1085;&#1086;&#1074;&#1080;&#1084; &#1092;&#1083;&#1072;&#1075;
    <span style="color: #00ffff;">call</span>    _NUMBER         #  |       |# &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; &#1095;&#1080;&#1089;&#1083;&#1086; &#1074; <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rcx</span> &gt; 0 &#1077;&#1089;&#1083;&#1080; &#1086;&#1096;&#1080;&#1073;&#1082;&#1072;
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rcx</span>, <span style="color: #eedd82;">%rcx</span>      #  |       |# (&#1059;&#1076;&#1072;&#1083;&#1086;&#1089;&#1100; &#1088;&#1072;&#1089;&#1087;&#1072;&#1088;&#1089;&#1080;&#1090;&#1100; &#1095;&#1080;&#1089;&#1083;&#1086;)?
    <span style="color: #00ffff;">jnz</span> 6f                  #--|-----+ |# ?-&#1053;&#1077;&#1090;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1082; (6)
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rbx</span>      #  |     | |# ?-&#1044;&#1072;, &#1055;&#1077;&#1088;&#1077;&#1084;&#1077;&#1097;&#1072;&#1077;&#1084; &#1095;&#1080;&#1089;&#1083;&#1086; &#1074; <span style="color: #eedd82;">%ebx</span>,
    <span style="color: #00ffff;">mov</span>     $LIT, <span style="color: #eedd82;">%rax</span>      #  |     | |#     &#1059;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; &#1089;&#1083;&#1086;&#1074;&#1086; LIT &#1074; <span style="color: #eedd82;">%eax</span> &lt;&#1047;&#1040;&#1063;&#1045;&#1052;????&gt;
<span style="color: #87cefa;">2</span>:  #                   &lt;------+     | |#
    # &#1055;&#1088;&#1086;&#1074;&#1077;&#1088;&#1080;&#1084; &#1074; &#1082;&#1072;&#1082;&#1086;&#1084; &#1084;&#1099; &#1088;&#1077;&#1078;&#1080;&#1084;&#1077;     | |#
    <span style="color: #00ffff;">mov</span>     (var_STATE), <span style="color: #eedd82;">%rdx</span>#       | |#
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rdx</span>, <span style="color: #eedd82;">%rdx</span>      #        | |#     (&#1052;&#1099; &#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084;&#1089;&#1103; &#1080;&#1083;&#1080; &#1074;&#1099;&#1087;&#1086;&#1083;&#1085;&#1103;&#1077;&#1084;&#1089;&#1103;)?
    <span style="color: #00ffff;">jz</span>  4f                  #-----+  | |#     ?-&#1042;&#1099;&#1087;&#1086;&#1083;&#1085;&#1103;&#1077;&#1084;&#1089;&#1103;. &#1055;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1082; (4)
    <span style="color: #00ffff;">call</span>    _COMMA          #     |  | |#     ?-&#1050;&#1086;&#1084;&#1087;&#1080;&#1083;&#1080;&#1088;&#1091;&#1077;&#1084;&#1089;&#1103;. &#1044;&#1086;&#1073;&#1072;&#1074;&#1083;&#1103;&#1077;&#1084; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1085;&#1086;&#1077; &#1086;&#1087;&#1088;&#1077;&#1076;&#1077;&#1083;&#1077;&#1085;&#1080;&#1077;
    <span style="color: #00ffff;">mov</span>     (interpret_is_lit), <span style="color: #eedd82;">%rcx</span>#| |#
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rcx</span>, <span style="color: #eedd82;">%rcx</span>      #     |  | |#       (&#1069;&#1090;&#1086; &#1073;&#1099;&#1083; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;)?
    <span style="color: #00ffff;">jz</span>      3f              #--+  |  | |#       ?-&#1053;&#1077;&#1090;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1082; NEXT
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rbx</span>, <span style="color: #eedd82;">%rax</span>      #  |  |  | |#       ?-&#1044;&#1072;, &#1087;&#1086;&#1101;&#1090;&#1086;&#1084;&#1091; &#1079;&#1072; LIT &#1089;&#1083;&#1077;&#1076;&#1091;&#1077;&#1090; &#1095;&#1080;&#1089;&#1083;&#1086;,
    <span style="color: #00ffff;">call</span>    _COMMA          #  |  |  | |#            &#1074;&#1099;&#1079;&#1099;&#1074;&#1072;&#1077;&#1084; _COMMA, &#1095;&#1090;&#1086;&#1073;&#1099; &#1089;&#1082;&#1086;&#1084;&#1087;&#1080;&#1083;&#1080;&#1090;&#1100; &#1077;&#1075;&#1086;
<span style="color: #87cefa;">3</span>:  #                   &lt;------+  |  | |#
    <span style="color: #00ffff;">NEXT</span>                    #     |  | |# NEXT
    # ---------------------       |  | |# -------------------------------------------------
<span style="color: #87cefa;">4</span>:  #                   &lt;---------+&lt;-|-+
    # &#1042;&#1099;&#1087;&#1086;&#1083;&#1085;&#1103;&#1077;&#1084;&#1089;&#1103;                    |
    <span style="color: #00ffff;">mov</span>     (interpret_is_lit), <span style="color: #eedd82;">%rcx</span>#|
    <span style="color: #00ffff;">test</span>    <span style="color: #eedd82;">%rcx</span>, <span style="color: #eedd82;">%rcx</span>      #        |  # (&#1069;&#1090;&#1086; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;)?
    <span style="color: #00ffff;">jnz</span> 5f                  #--+     |  # ?-&#1044;&#1072;, &#1087;&#1077;&#1088;&#1077;&#1093;&#1086;&#1076;&#1080;&#1084; &#1082; (5)
    # &#1053;&#1077; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;, &#1074;&#1099;&#1087;&#1086;&#1083;&#1085;&#1080;&#1084; &#1087;&#1088;&#1103;&#1084;&#1086; &#1089;&#1077;&#1081;&#1095;&#1072;&#1089;. &#1052;&#1099; &#1085;&#1077; &#1086;&#1089;&#1091;&#1097;&#1077;&#1089;&#1090;&#1074;&#1083;&#1103;&#1077;&#1084; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1072;, &#1085;&#1086;
    # codeword &#1074; &#1082;&#1086;&#1085;&#1077;&#1095;&#1085;&#1086;&#1084; &#1080;&#1090;&#1086;&#1075;&#1077; &#1074;&#1099;&#1079;&#1086;&#1074;&#1077;&#1090; NEXT, &#1082;&#1086;&#1090;&#1086;&#1088;&#1099;&#1081; &#1087;&#1086;&#1074;&#1090;&#1086;&#1088;&#1085;&#1086; &#1074;&#1077;&#1088;&#1085;&#1077;&#1090; &#1094;&#1080;&#1082;&#1083; &#1074; QUIT
    <span style="color: #00ffff;">jmp</span>     *(<span style="color: #eedd82;">%rax</span>)         #  |     |
    # --------------------- #  |     |  # -------------------------------------------------
<span style="color: #87cefa;">5</span>:  #                    &lt;-----+     |
    # &#1042;&#1099;&#1087;&#1086;&#1083;&#1085;&#1103;&#1077;&#1084; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;, &#1095;&#1090;&#1086; &#1086;&#1079;&#1085;&#1072;&#1095;&#1072;&#1077;&#1090;, &#1095;&#1090;&#1086; &#1084;&#1099; push-&#1080;&#1084; &#1077;&#1075;&#1086; &#1074; &#1089;&#1090;&#1077;&#1082; &#1080; &#1076;&#1077;&#1083;&#1072;&#1077;&#1084; NEXT
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rbx</span>            #        |
    <span style="color: #00ffff;">NEXT</span>                    #        |
<span style="color: #87cefa;">6</span>:  #                    &lt;-----------+
    # &#1052;&#1099; &#1079;&#1076;&#1077;&#1089;&#1100;, &#1077;&#1089;&#1083;&#1080; &#1085;&#1077; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1083;&#1086;&#1089;&#1100; &#1088;&#1072;&#1089;&#1087;&#1072;&#1088;&#1089;&#1080;&#1090;&#1100; &#1095;&#1080;&#1089;&#1083;&#1086; &#1074; &#1090;&#1077;&#1082;&#1091;&#1097;&#1077;&#1081; &#1073;&#1072;&#1079;&#1077; &#1080;&#1083;&#1080; &#1101;&#1090;&#1086;&#1075;&#1086;
    # &#1089;&#1083;&#1086;&#1074;&#1072; &#1085;&#1077;&#1090; &#1074; &#1089;&#1083;&#1086;&#1074;&#1072;&#1088;&#1077;. &#1055;&#1077;&#1095;&#1072;&#1090;&#1072;&#1077;&#1084; &#1089;&#1086;&#1086;&#1073;&#1097;&#1077;&#1085;&#1080;&#1077; &#1086;&#1073; &#1086;&#1096;&#1080;&#1073;&#1082;&#1077; &#1080; 40 &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074; &#1082;&#1086;&#1085;&#1090;&#1077;&#1082;&#1089;&#1090;&#1072;.
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rdx</span>
    <span style="color: #00ffff;">mov</span>     $stderr, <span style="color: #eedd82;">%rdi</span>   #           # param1: stderr
    <span style="color: #00ffff;">mov</span>     $errmsg, <span style="color: #eedd82;">%rsi</span>   #           # param2: &#1042;&#1099;&#1074;&#1086;&#1076;&#1080;&#1084;&#1072;&#1103; &#1089;&#1090;&#1088;&#1086;&#1082;&#1072;
    <span style="color: #00ffff;">mov</span>     $errmsgend-errmsg, <span style="color: #eedd82;">%rdx</span>     # param3: &#1044;&#1083;&#1080;&#1085;&#1072; &#1074;&#1099;&#1074;&#1086;&#1076;&#1080;&#1084;&#1086;&#1081; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">mov</span>     $sys_write, <span style="color: #eedd82;">%rax</span>#           # SYSCALL write
    <span style="color: #00ffff;">syscall</span>                 #           # SYSCALL
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdx</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rsi</span>
    # &#1054;&#1096;&#1080;&#1073;&#1082;&#1072; &#1087;&#1088;&#1086;&#1080;&#1079;&#1086;&#1096;&#1083;&#1072; &#1087;&#1077;&#1088;&#1077;&#1076; currkey
    <span style="color: #00ffff;">mov</span>     (currkey), <span style="color: #eedd82;">%rcx</span> #
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rcx</span>, <span style="color: #eedd82;">%rdx</span>      #
    <span style="color: #00ffff;">sub</span>     $input_buffer, <span style="color: #eedd82;">%rdx</span>         # <span style="color: #eedd82;">%rdx</span> = (currkey - buffer) (&#1076;&#1083;&#1080;&#1085;&#1072; &#1073;&#1091;&#1092;&#1077;&#1088;&#1072; &#1087;&#1077;&#1088;&#1077;&#1076; currkey)
    <span style="color: #00ffff;">cmp</span>     $40, <span style="color: #eedd82;">%rdx</span>       #           # (if &gt; 40)?
    <span style="color: #00ffff;">jle</span> 7f                  #--+        # ?-&#1053;&#1077;&#1090;, &#1087;&#1077;&#1095;&#1072;&#1090;&#1072;&#1077;&#1084; &#1074;&#1089;&#1077;
    <span style="color: #00ffff;">mov</span>     $40, <span style="color: #eedd82;">%rdx</span>       #  |        # ?-&#1044;&#1072;, &#1087;&#1077;&#1095;&#1072;&#1090;&#1072;&#1090;&#1100; &#1090;&#1086;&#1083;&#1100;&#1082;&#1086; 40 &#1089;&#1080;&#1084;&#1074;&#1086;&#1083;&#1086;&#1074;
<span style="color: #87cefa;">7</span>:  #                    &lt;-----+
    <span style="color: #00ffff;">sub</span>     <span style="color: #eedd82;">%rdx</span>, <span style="color: #eedd82;">%rcx</span>      #           # <span style="color: #eedd82;">%rcx</span> = start of area to print, <span style="color: #eedd82;">%edx</span> = length
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rdx</span>
    <span style="color: #00ffff;">mov</span>     $stderr, <span style="color: #eedd82;">%rdi</span>               # param1: stderr
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rcx</span>, <span style="color: #eedd82;">%rsi</span>                  # param2: &#1042;&#1099;&#1074;&#1086;&#1076;&#1080;&#1084;&#1072;&#1103; &#1089;&#1090;&#1088;&#1086;&#1082;&#1072;
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rdx</span>, <span style="color: #eedd82;">%rdx</span>                  # param3: &#1044;&#1083;&#1080;&#1085;&#1072;
    <span style="color: #00ffff;">mov</span>     $sys_write, <span style="color: #eedd82;">%eax</span>            # SYSCALL write
    <span style="color: #00ffff;">syscall</span>                 #           # SYSCALL
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdx</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rsi</span>
    # &#1042;&#1099;&#1074;&#1077;&#1076;&#1077;&#1084; &#1087;&#1077;&#1088;&#1077;&#1074;&#1086;&#1076; &#1089;&#1090;&#1088;&#1086;&#1082;&#1080;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">mov</span>     $stderr, <span style="color: #eedd82;">%rdi</span>               # param1: stderr
    <span style="color: #00ffff;">mov</span>     $errmsgnl, <span style="color: #eedd82;">%rsi</span> #           # param2: newline
    <span style="color: #00ffff;">mov</span>     $1, <span style="color: #eedd82;">%edx</span>        #           # param3: &#1044;&#1083;&#1080;&#1085;&#1072;
    <span style="color: #00ffff;">mov</span>     $sys_write, <span style="color: #eedd82;">%eax</span>            # SYSCALL write
    <span style="color: #00ffff;">syscall</span>                 #           # SYSCALL
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">NEXT</span>                    #           # NEXT
    # ---------------------
    <span style="color: #00ffff;">.section</span> .rodata
<span style="color: #87cefa;">errmsg</span>:
    <span style="color: #00ffff;">.ascii</span> <span style="color: #ffa07a;">"PARSE ERROR: "</span>
<span style="color: #87cefa;">errmsgend</span>:
<span style="color: #87cefa;">errmsgnl</span>:
    <span style="color: #00ffff;">.ascii</span> <span style="color: #ffa07a;">"\n"</span>

    <span style="color: #00ffff;">.data</span>                   # NB: &#1087;&#1088;&#1086;&#1097;&#1077; &#1079;&#1072;&#1087;&#1080;&#1089;&#1072;&#1090;&#1100; &#1074; .data section
    <span style="color: #00ffff;">.align</span> 8
<span style="color: #87cefa;">interpret_is_lit</span>:
    <span style="color: #00ffff;">.quad</span> 0                  # &#1060;&#1083;&#1072;&#1075; &#1083;&#1080;&#1090;&#1077;&#1088;&#1072;&#1083;&#1072;
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-30" class="outline-3">
<h3 id="unnumbered-30">CHAR</h3>
<div class="outline-text-3" id="text-unnumbered-30">
<p>
CHAR помещает код ASCII первого символа следующего слова в стек. Например, <code>CHAR A</code>
кладет 65 в стек.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_char"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"CHAR"</span>,4,,CHAR
    <span style="color: #00ffff;">call</span>    _WORD           # &#1042;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; <span style="color: #eedd82;">%ecx</span> = length, <span style="color: #eedd82;">%edi</span> = &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1089;&#1083;&#1086;&#1074;&#1086;.
    <span style="color: #00ffff;">xor</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">movb</span>    (<span style="color: #eedd82;">%rdi</span>), <span style="color: #eedd82;">%al</span>     # &#1055;&#1086;&#1083;&#1091;&#1095;&#1072;&#1077;&#1084; &#1087;&#1077;&#1088;&#1074;&#1099;&#1081; &#1089;&#1080;&#1084;&#1074;&#1086;&#1083; &#1089;&#1083;&#1086;&#1074;&#1072;
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>            # &#1050;&#1083;&#1072;&#1076;&#1077;&#1084; &#1077;&#1075;&#1086; &#1074; &#1089;&#1090;&#1077;&#1082;
    <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-31" class="outline-3">
<h3 id="unnumbered-31">EXECUTE</h3>
<div class="outline-text-3" id="text-unnumbered-31">
<p>
EXECUTE используется для запуска токенов выполнения. См. обсуждение токенов выполнения
в коде Forth для получения более подробной информации.
</p>

<p>
С точки зрения реализации EXECUTE делает следующее:
</p>
<ul class="org-ul">
<li>берет указатель на <code>codeword</code> слова, которое нужно выполнить.
</li>
<li>т.к. этот <code>codeword</code> сам является указателем на процедуру выполнения (такую, как
DOCON) - осуществляется переход по нему. Т.е. управление передается этой процедуре.
</li>
</ul>

<p>
После перехода на токен его NEXT выйдет из текущего слова.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_execute"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"EXECUTE"</span>,7,,EXECUTE
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rax</span>            # &#1055;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1090;&#1086;&#1082;&#1077;&#1085; &#1074;&#1099;&#1087;&#1086;&#1083;&#1085;&#1077;&#1085;&#1080;&#1103; &#1074; <span style="color: #eedd82;">%eax</span>
    <span style="color: #00ffff;">jmp</span>     *(<span style="color: #eedd82;">%rax</span>)         # &#1080; &#1074;&#1099;&#1087;&#1086;&#1083;&#1085;&#1080;&#1090;&#1100; jump &#1085;&#1072; &#1085;&#1077;&#1075;&#1086;.
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-32" class="outline-3">
<h3 id="unnumbered-32">DODOES</h3>
<div class="outline-text-3" id="text-unnumbered-32">
<p>
Работа этого кода объясняется во второй части
</p>

<div class="org-src-container">

<pre class="src src-asm" id="dodoes"><span style="color: #87cefa;">DODOES</span>:
    <span style="color: #00ffff;">PUSHRSP</span> <span style="color: #eedd82;">%rsi</span>            # (&#1089;) &#1057;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1077;&#1084; ESI &#1085;&#1072; &#1089;&#1090;&#1077;&#1082;&#1077; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074;

    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rsi</span>            # (b,d) CALL-RETADDR -&gt; ESI

    <span style="color: #00ffff;">lea</span>     4(<span style="color: #eedd82;">%rax</span>), <span style="color: #eedd82;">%rax</span>   # (a) &#1074;&#1099;&#1095;&#1080;&#1089;&#1083;&#1080;&#1090;&#1100; param-field DEUX
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rax</span>            # (a) push &#1077;&#1075;&#1086; &#1085;&#1072; &#1089;&#1090;&#1077;&#1082; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;

    <span style="color: #00ffff;">NEXT</span>                    # (e) &#1074;&#1099;&#1079;&#1074;&#1072;&#1090;&#1100; &#1080;&#1085;&#1090;&#1077;&#1088;&#1087;&#1088;&#1077;&#1090;&#1072;&#1090;&#1086;&#1088;

<span style="color: #87cefa;">defconst</span> <span style="color: #ffa07a;">"DODOES_ADDR"</span>,11,,DODOES_ADDR,DODOES
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-33" class="outline-3">
<h3 id="unnumbered-33">Системные вызовы</h3>
<div class="outline-text-3" id="text-unnumbered-33">
<p>
SYSCALL0, SYSCALL1, SYSCALL2, SYSCALL3 делают стандартный системный вызов Linux.  (См.
список номеров системных вызовов). Как видно из названия, эти формы занимают от 0 до 3
параметров syscall, а также номер системного вызова.
</p>

<p>
В этом Forth SYSCALL0 должен быть последним словом во встроенном (ассемблерном)
словаре, потому что мы инициализируем переменную LATEST, чтобы указать на нее. Это
означает, что если вы хотите расширить ассемблерную часть, вы должны поместить новые
слова перед SYSCALL0 или изменить способ инициализации LATEST.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="word_syscalls"><span style="color: #ff7f24;">/*</span>
<span style="color: #ff7f24;">;; defcode "SYSCALL3",8,,SYSCALL3</span>
<span style="color: #ff7f24;">;;     pop     %eax            # &#1053;&#1086;&#1084;&#1077;&#1088; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1086;&#1075;&#1086; &#1074;&#1099;&#1079;&#1086;&#1074;&#1072; (&#1089;&#1084;. &lt;asm/unistd.h&gt;)</span>
<span style="color: #ff7f24;">;;     pop     %ebx            # &#1055;&#1077;&#1088;&#1074;&#1099;&#1081; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;.</span>
<span style="color: #ff7f24;">;;     pop     %ecx            # &#1042;&#1090;&#1086;&#1088;&#1086;&#1081; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;</span>
<span style="color: #ff7f24;">;;     pop     %edx            # &#1058;&#1088;&#1077;&#1090;&#1080;&#1081; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;</span>
<span style="color: #ff7f24;">;;     int     $0x80</span>
<span style="color: #ff7f24;">;;     push    %eax            # &#1056;&#1077;&#1079;&#1091;&#1083;&#1100;&#1090;&#1072;&#1090;</span>
<span style="color: #ff7f24;">;;     NEXT</span>
<span style="color: #ff7f24;">*/</span>
  <span style="color: #00ffff;">defcode</span> <span style="color: #ffa07a;">"SYSCALL3"</span>,8,,SYSCALL3
  <span style="color: #00ffff;">mov</span> <span style="color: #eedd82;">%rsi</span>,<span style="color: #eedd82;">%r10</span> #save <span style="color: #eedd82;">%rsi</span>
  <span style="color: #00ffff;">mov</span> <span style="color: #eedd82;">%rdi</span>,<span style="color: #eedd82;">%r9</span> #save <span style="color: #eedd82;">%rdi</span>
  <span style="color: #00ffff;">pop</span> <span style="color: #eedd82;">%rax</span>        # System call number (see &lt;asm/unistd.h&gt;)
  <span style="color: #00ffff;">pop</span> <span style="color: #eedd82;">%rdi</span>        # First parameter.
  <span style="color: #00ffff;">pop</span> <span style="color: #eedd82;">%rsi</span>        # Second parameter
  <span style="color: #00ffff;">pop</span> <span style="color: #eedd82;">%rdx</span>        # Third parameter
  <span style="color: #00ffff;">syscall</span>
  <span style="color: #00ffff;">push</span> <span style="color: #eedd82;">%rax</span>       # Result (negative for -errno)
  <span style="color: #00ffff;">mov</span> <span style="color: #eedd82;">%r10</span>,<span style="color: #eedd82;">%rsi</span>
  <span style="color: #00ffff;">mov</span> <span style="color: #eedd82;">%r9</span>,<span style="color: #eedd82;">%rdi</span>
  <span style="color: #00ffff;">NEXT</span>
<span style="color: #ff7f24;">/*</span>
<span style="color: #ff7f24;">;; defcode "SYSCALL2",8,,SYSCALL2</span>
<span style="color: #ff7f24;">;;     pop     %eax            # &#1053;&#1086;&#1084;&#1077;&#1088; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1086;&#1075;&#1086; &#1074;&#1099;&#1079;&#1086;&#1074;&#1072; (&#1089;&#1084;. &lt;asm/unistd.h&gt;)</span>
<span style="color: #ff7f24;">;;     pop     %ebx            # &#1055;&#1077;&#1088;&#1074;&#1099;&#1081; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;.</span>
<span style="color: #ff7f24;">;;     pop     %ecx            # &#1042;&#1090;&#1086;&#1088;&#1086;&#1081; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;</span>
<span style="color: #ff7f24;">;;     int     $0x80</span>
<span style="color: #ff7f24;">;;     push    %eax            # &#1056;&#1077;&#1079;&#1091;&#1083;&#1100;&#1090;&#1072;&#1090;</span>
<span style="color: #ff7f24;">;;     NEXT</span>
<span style="color: #ff7f24;">*/</span>
  <span style="color: #00ffff;">defcode</span> <span style="color: #ffa07a;">"SYSCALL2"</span>,8,,SYSCALL2
  <span style="color: #00ffff;">mov</span> <span style="color: #eedd82;">%rsi</span>,<span style="color: #eedd82;">%r10</span> #save <span style="color: #eedd82;">%rsi</span>
  <span style="color: #00ffff;">mov</span> <span style="color: #eedd82;">%rdi</span>,<span style="color: #eedd82;">%r9</span> #save <span style="color: #eedd82;">%rdi</span>
  <span style="color: #00ffff;">pop</span> <span style="color: #eedd82;">%rax</span>        # System call number (see &lt;asm/unistd.h&gt;)
  <span style="color: #00ffff;">pop</span> <span style="color: #eedd82;">%rdi</span>        # First parameter.
  <span style="color: #00ffff;">pop</span> <span style="color: #eedd82;">%rsi</span>        # Second parameter
  <span style="color: #00ffff;">syscall</span>
  <span style="color: #00ffff;">push</span> <span style="color: #eedd82;">%rax</span>       # Result (negative for -errno)
  <span style="color: #00ffff;">mov</span> <span style="color: #eedd82;">%r10</span>,<span style="color: #eedd82;">%rsi</span>
  <span style="color: #00ffff;">mov</span> <span style="color: #eedd82;">%r9</span>,<span style="color: #eedd82;">%rdi</span>
  <span style="color: #00ffff;">NEXT</span>
<span style="color: #ff7f24;">/*</span>
<span style="color: #ff7f24;">;; defcode "SYSCALL1",8,,SYSCALL1</span>
<span style="color: #ff7f24;">;;     pop     %eax            # &#1053;&#1086;&#1084;&#1077;&#1088; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1086;&#1075;&#1086; &#1074;&#1099;&#1079;&#1086;&#1074;&#1072; (&#1089;&#1084;. &lt;asm/unistd.h&gt;)</span>
<span style="color: #ff7f24;">;;     pop     %ebx            # &#1055;&#1077;&#1088;&#1074;&#1099;&#1081; &#1087;&#1072;&#1088;&#1072;&#1084;&#1077;&#1090;&#1088;.</span>
<span style="color: #ff7f24;">;;     int     $0x80</span>
<span style="color: #ff7f24;">;;     push    %eax            # &#1056;&#1077;&#1079;&#1091;&#1083;&#1100;&#1090;&#1072;&#1090;</span>
<span style="color: #ff7f24;">;;     NEXT</span>
<span style="color: #ff7f24;">*/</span>
  <span style="color: #00ffff;">defcode</span> <span style="color: #ffa07a;">"SYSCALL1"</span>,8,,SYSCALL1
  <span style="color: #00ffff;">mov</span> <span style="color: #eedd82;">%rsi</span>,<span style="color: #eedd82;">%r10</span> #save <span style="color: #eedd82;">%rsi</span>
  <span style="color: #00ffff;">mov</span> <span style="color: #eedd82;">%rdi</span>,<span style="color: #eedd82;">%r9</span> #save <span style="color: #eedd82;">%rdi</span>
  <span style="color: #00ffff;">pop</span> <span style="color: #eedd82;">%rax</span>        # System call number (see &lt;asm/unistd.h&gt;)
  <span style="color: #00ffff;">pop</span> <span style="color: #eedd82;">%rdi</span>        # First parameter.
  <span style="color: #00ffff;">syscall</span>
  <span style="color: #00ffff;">push</span> <span style="color: #eedd82;">%rax</span>       # Result (negative for -errno)
  <span style="color: #00ffff;">mov</span> <span style="color: #eedd82;">%r10</span>,<span style="color: #eedd82;">%rsi</span>
  <span style="color: #00ffff;">mov</span> <span style="color: #eedd82;">%r9</span>,<span style="color: #eedd82;">%rdi</span>
  <span style="color: #00ffff;">NEXT</span>
<span style="color: #ff7f24;">/*</span>
<span style="color: #ff7f24;">;; defcode "SYSCALL0",8,,SYSCALL0</span>
<span style="color: #ff7f24;">;;     pop     %eax            # &#1053;&#1086;&#1084;&#1077;&#1088; &#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1086;&#1075;&#1086; &#1074;&#1099;&#1079;&#1086;&#1074;&#1072; (&#1089;&#1084;. &lt;asm/unistd.h&gt;)</span>
<span style="color: #ff7f24;">;;     int     $0x80</span>
<span style="color: #ff7f24;">;;     push    %eax            # &#1056;&#1077;&#1079;&#1091;&#1083;&#1100;&#1090;&#1072;&#1090;</span>
<span style="color: #ff7f24;">;;     NEXT</span>
<span style="color: #ff7f24;">*/</span>
  <span style="color: #00ffff;">defcode</span> <span style="color: #ffa07a;">"SYSCALL0"</span>,8,,SYSCALL0
  <span style="color: #00ffff;">pop</span> <span style="color: #eedd82;">%rax</span>        # System call number (see &lt;asm/unistd.h&gt;)
  <span style="color: #00ffff;">syscall</span>
  <span style="color: #00ffff;">push</span> <span style="color: #eedd82;">%rax</span>       # Result (negative for -errno)
  <span style="color: #00ffff;">NEXT</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-34" class="outline-3">
<h3 id="unnumbered-34">Сегмент стека и буффер ввода</h3>
<div class="outline-text-3" id="text-unnumbered-34">
<div class="org-src-container">

<pre class="src src-asm" id="sys_ret_stack_and_input_buffer">    <span style="color: #00ffff;">.bss</span>

    # &#1057;&#1090;&#1077;&#1082; &#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1090;&#1086;&#1074; Forth
    <span style="color: #00ffff;">.set</span> RETURN_STACK_SIZE,8192
    <span style="color: #00ffff;">.align</span> 4096
<span style="color: #87cefa;">return_stack</span>:
    <span style="color: #00ffff;">.space</span> RETURN_STACK_SIZE
<span style="color: #87cefa;">return_stack_top</span>:           # Initial top of return stack.

    # &#1041;&#1091;&#1092;&#1077;&#1088; &#1074;&#1074;&#1086;&#1076;&#1072;
    <span style="color: #00ffff;">.set</span> INPUT_BUFFER_SIZE,4096
    <span style="color: #00ffff;">.align</span> 4096
<span style="color: #87cefa;">input_buffer</span>:
    <span style="color: #00ffff;">.space</span> INPUT_BUFFER_SIZE

    # &#1041;&#1091;&#1092;&#1077;&#1088; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; - c&#1102;&#1076;&#1072; &#1091;&#1082;&#1072;&#1079;&#1099;&#1074;&#1072;&#1077;&#1090; HERE
    <span style="color: #00ffff;">.set</span> INITIAL_DATA_SEGMENT_SIZE,65536
    <span style="color: #00ffff;">.align</span> 4096
<span style="color: #87cefa;">data_buffer</span>:
    <span style="color: #00ffff;">.space</span> INITIAL_DATA_SEGMENT_SIZE
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-unnumbered-35" class="outline-2">
<h2 id="unnumbered-35">Дополнения</h2>
<div class="outline-text-2" id="text-unnumbered-35">
</div><div id="outline-container-unnumbered-36" class="outline-3">
<h3 id="unnumbered-36">Хэширование</h3>
<div class="outline-text-3" id="text-unnumbered-36">
<p>
<code>SHA-256</code> - это враппер, который вызывает функцию си <code>sha256</code>. Эта функция принимает
два параметра:
</p>
<ul class="org-ul">
<li>указатель на нуль-терминантную строку (<code>RDI</code>)
</li>
<li>указатель на буфер размером в 32 байта куда будет помещен хэш (<code>RSI</code>)
</li>
</ul>

<p>
Перед вызовом мы хотим выделить под хэш место и сохранить ESI, а после - восстановить его.
</p>

<div class="org-src-container">

<pre class="src src-asm" id="words_for_hash"><span style="color: #87cefa;">defcode</span> <span style="color: #ffa07a;">"SHA256"</span>,6,,SHA256
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rdi</span>            # pop &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1085;&#1072; &#1089;&#1090;&#1088;&#1086;&#1082;&#1091; &#1089;&#1086; &#1089;&#1090;&#1077;&#1082;&#1072; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1074; <span style="color: #eedd82;">%rdi</span>
    <span style="color: #00ffff;">sub</span>     $32, <span style="color: #eedd82;">%rsp</span>       # &#1074;&#1099;&#1076;&#1077;&#1083;&#1103;&#1077;&#1084; &#1084;&#1077;&#1089;&#1090;&#1086; &#1087;&#1086;&#1076; &#1093;&#1101;&#1096;
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rsp</span>, <span style="color: #eedd82;">%rax</span>      # &#1089;&#1086;&#1093;&#1088;&#1103;&#1085;&#1103;&#1077;&#1084; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1074; <span style="color: #eedd82;">%rax</span>
    <span style="color: #00ffff;">push</span>    <span style="color: #eedd82;">%rsi</span>            # &#1089;&#1086;&#1093;&#1088;&#1072;&#1085;&#1103;&#1077;&#1084; <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">mov</span>     <span style="color: #eedd82;">%rax</span>, <span style="color: #eedd82;">%rsi</span>      # &#1082;&#1086;&#1087;&#1080;&#1088;&#1091;&#1077;&#1084; &#1091;&#1082;&#1072;&#1079;&#1072;&#1090;&#1077;&#1083;&#1100; &#1074; <span style="color: #eedd82;">%rsi</span>
    <span style="color: #00ffff;">call</span>    sha256          # &#1074;&#1099;&#1079;&#1099;&#1074;&#1072;&#1077;&#1084; sha256
    <span style="color: #00ffff;">pop</span>     <span style="color: #eedd82;">%rsi</span>            # &#1074;&#1086;&#1089;&#1089;&#1090;&#1072;&#1085;&#1072;&#1074;&#1083;&#1080;&#1074;&#1072;&#1077;&#1084; <span style="color: #eedd82;">%esi</span>
    <span style="color: #00ffff;">NEXT</span>                    # &#1085;&#1072; &#1089;&#1090;&#1077;&#1082;&#1077; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093; &#1086;&#1089;&#1090;&#1072;&#1077;&#1090;&#1089;&#1103; &#1093;&#1101;&#1096;
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-37" class="outline-3">
<h3 id="unnumbered-37">Внешнее управление</h3>
<div class="outline-text-3" id="text-unnumbered-37">
<p>
Для того чтобы использовать виртуальную машину как дочерний процесс, создадим
супервизор, который будет запускать ее, передавая окружение и заменяя дескрипторы stdin
и stdout на pipes, через которые будет отправлять код и считывать результат из repl
</p>

<div class="org-src-container">

<pre class="src src-c" id="ext_control"><span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;unistd.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;stdio.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;stdlib.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;fcntl.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;string.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;sys/stat.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;sys/wait.h&gt;</span>

<span style="color: #7fffd4;">#define</span> <span style="color: #eedd82;">SIZE</span> 1024

<span style="color: #98fb98;">char</span> * <span style="color: #87cefa;">read_file_into_string</span> (<span style="color: #98fb98;">char</span> <span style="color: #eedd82;">filename</span>[])
{
    <span style="color: #00ffff;">struct</span> <span style="color: #98fb98;">stat</span> <span style="color: #eedd82;">sb</span>;
    <span style="color: #00ffff;">if</span>(-1 == stat(filename, &amp;sb)) {
        perror(<span style="color: #ffa07a;">"stat file"</span>);
        printf(<span style="color: #ffa07a;">"function: read_file_into_string\n"</span>);
        printf(<span style="color: #ffa07a;">"filename: [%s]\n"</span>, filename);
        <span style="color: #00ffff;">return</span> <span style="color: #7fffd4;">NULL</span>;
    }
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">printf("filesize: %ld\n", sb.st_size); </span><span style="color: #ff7f24;">*/</span>

    <span style="color: #98fb98;">FILE</span> *<span style="color: #eedd82;">fp</span>=fopen(filename, <span style="color: #ffa07a;">"r"</span>);
    <span style="color: #00ffff;">if</span>(<span style="color: #7fffd4;">NULL</span> == fp) {
        perror(<span style="color: #ffa07a;">"fopen file"</span>);
        printf(<span style="color: #ffa07a;">"function: read_file_into_string\n"</span>);
        printf(<span style="color: #ffa07a;">"filename: [%s]\n"</span>, filename);
        <span style="color: #00ffff;">return</span> <span style="color: #7fffd4;">NULL</span>;
    }
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">printf("file handle: %p\n", fp); </span><span style="color: #ff7f24;">*/</span>

    <span style="color: #98fb98;">char</span> *<span style="color: #eedd82;">str</span> = malloc(sb.st_size+1);
    <span style="color: #00ffff;">if</span>(<span style="color: #7fffd4;">NULL</span> == str) {
        perror(<span style="color: #ffa07a;">"malloc"</span>);
        printf(<span style="color: #ffa07a;">"function: read_file_into_string\n"</span>);
        printf(<span style="color: #ffa07a;">"filename: [%s]\n"</span>, filename);
        <span style="color: #00ffff;">return</span> <span style="color: #7fffd4;">NULL</span>;
    }
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">printf("malloc pntr: %p\n", str); </span><span style="color: #ff7f24;">*/</span>

    <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">cnt</span> = fread(str, 1, sb.st_size, fp);
    <span style="color: #00ffff;">if</span>(sb.st_size != cnt) {
        perror(<span style="color: #ffa07a;">"fread"</span>);
        printf(<span style="color: #ffa07a;">"function: read_file_into_string\n"</span>);
        printf(<span style="color: #ffa07a;">"filename: [%s]\n"</span>, filename);
        <span style="color: #00ffff;">return</span> <span style="color: #7fffd4;">NULL</span>;
    }
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">printf("read bytes: %d\n", cnt); </span><span style="color: #ff7f24;">*/</span>

    fclose(fp);
    str[sb.st_size] = 0;
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">printf("content is:%s\n", str); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #00ffff;">return</span> str;
}

<span style="color: #98fb98;">void</span> <span style="color: #87cefa;">toPipe</span> (<span style="color: #98fb98;">int</span> <span style="color: #eedd82;">inPipe</span>[], <span style="color: #98fb98;">char</span> <span style="color: #eedd82;">outstr</span>[])
{
    <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">len</span> = strlen(outstr);
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">printf(":: strlen(outstr) = %d\n", len); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">fflush(stdout); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">cnt</span> = write(inPipe[1], outstr, len);
    <span style="color: #00ffff;">if</span> (-1 == cnt) { perror(<span style="color: #ffa07a;">"write to pipe"</span>); exit(-1); }
}

<span style="color: #98fb98;">char</span>* <span style="color: #87cefa;">fromPipe</span>(<span style="color: #98fb98;">int</span> <span style="color: #eedd82;">outPipe</span>[], <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">len</span>)
{
    <span style="color: #98fb98;">char</span> *<span style="color: #eedd82;">buf</span> = malloc(len);
    <span style="color: #00ffff;">if</span>(<span style="color: #7fffd4;">NULL</span> == buf) {
        perror(<span style="color: #ffa07a;">"malloc"</span>);
        printf(<span style="color: #ffa07a;">"function: fromPipe\n"</span>);
        <span style="color: #00ffff;">return</span> <span style="color: #7fffd4;">NULL</span>;
    }
    memset(buf, 0, len);
    <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">cnt</span> = read(outPipe[0], buf, len);
    <span style="color: #00ffff;">if</span> (-1 == cnt) { perror(<span style="color: #ffa07a;">"read from pipe"</span>); exit(-1); }
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">if (0  == cnt) { perror("eof"); exit(-1); } </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">if (1  == cnt) { perror("1"); exit(-1); } </span><span style="color: #ff7f24;">*/</span>
    printf(<span style="color: #ffa07a;">":: %d [child out]\n%s\n"</span>, cnt, buf);
    fflush(stdout);
    <span style="color: #00ffff;">return</span> buf;
}

<span style="color: #98fb98;">void</span> <span style="color: #87cefa;">runvfm</span> (<span style="color: #98fb98;">char</span> <span style="color: #eedd82;">vfm</span>[], <span style="color: #98fb98;">char</span> <span style="color: #eedd82;">base</span>[], <span style="color: #98fb98;">char</span> <span style="color: #eedd82;">code</span>[], <span style="color: #98fb98;">char</span> *<span style="color: #eedd82;">params</span>[], <span style="color: #98fb98;">char</span> *<span style="color: #eedd82;">env</span>[], <span style="color: #98fb98;">char</span> <span style="color: #eedd82;">run</span>[],
             <span style="color: #98fb98;">char</span> <span style="color: #eedd82;">hash</span>[])
{
    <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">pid</span>, <span style="color: #eedd82;">in</span>, <span style="color: #eedd82;">out</span>, <span style="color: #eedd82;">cnt</span>, <span style="color: #eedd82;">inPipe</span>[2], <span style="color: #eedd82;">outPipe</span>[2];
    <span style="color: #00ffff;">if</span> (pipe(inPipe)  == -1) { perror(<span style="color: #ffa07a;">"In Pipe Failed"</span>);  exit(-1); }
    <span style="color: #00ffff;">if</span> (pipe(outPipe) == -1) { perror(<span style="color: #ffa07a;">"Out Pipe Failed"</span>); exit(-1); }
    <span style="color: #00ffff;">switch</span>(pid = fork()) {
    <span style="color: #00ffff;">case</span> -1:
        perror(<span style="color: #ffa07a;">"fork"</span>);
        exit(-1);
    <span style="color: #00ffff;">case</span> 0:
        close(0);
        close(1);
        dup2(inPipe[0], 0);
        close(inPipe[1]);
        close(outPipe[0]);
        dup2(outPipe[1], 1);
        execve(vfm, params, env);
    }
    printf(<span style="color: #ffa07a;">":: pid = %d\n"</span>, pid);
    fflush(stdout);

    toPipe(inPipe, base); sleep(1);
    <span style="color: #98fb98;">char</span> <span style="color: #eedd82;">vfm_hello</span>[] = <span style="color: #ffa07a;">"VFM VERSION 47 OK\n"</span>;
    <span style="color: #98fb98;">char</span> *<span style="color: #eedd82;">hello_str</span> = fromPipe(outPipe, 30);
    <span style="color: #00ffff;">if</span> (0 != strncmp(vfm_hello, hello_str, <span style="color: #00ffff;">sizeof</span>(vfm_hello))) {
        printf(<span style="color: #ffa07a;">":: vfm hello error:\n"</span>);
        printf(<span style="color: #ffa07a;">"[%s]\n"</span>, hello_str);
        printf(<span style="color: #ffa07a;">"expected: [%s]\n"</span>, vfm_hello);
        exit(-1);
    }
    free(hello_str);

    toPipe(inPipe, <span style="color: #ffa07a;">"1 2 3 + . BYE \n"</span>);
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">/\* toPipe(inPipe, run); *\/ </span><span style="color: #ff7f24;">*/</span>

    <span style="color: #98fb98;">char</span> *<span style="color: #eedd82;">result1</span> = fromPipe(outPipe, SIZE);
    printf(<span style="color: #ffa07a;">"Result is [%s]\n"</span>, result1);
    fflush(stdout);
    free(result1);

    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">char *result2 = fromPipe(outPipe, SIZE); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">fromPipe(outPipe, 0); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">printf("Result is [%s]\n", result2); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">fflush(stdout); </span><span style="color: #ff7f24;">*/</span>
    <span style="color: #ff7f24;">/* </span><span style="color: #ff7f24;">free(result2); </span><span style="color: #ff7f24;">*/</span>

    <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">status</span>;
    wait(&amp;status);

    printf(<span style="color: #ffa07a;">"Fin: %d\n"</span>, status);
    fflush(stdout);

    exit(0);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-unnumbered-38" class="outline-3">
<h3 id="unnumbered-38">Нода</h3>
<div class="outline-text-3" id="text-unnumbered-38">
<div class="org-src-container">

<pre class="src src-c" id="ext_control"><span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;stdio.h&gt;</span>
<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">&lt;stdlib.h&gt;</span>

<span style="color: #7fffd4;">#include</span> <span style="color: #ffa07a;">"runvfm64.h"</span>


<span style="color: #98fb98;">int</span> <span style="color: #87cefa;">main</span>(<span style="color: #98fb98;">int</span> <span style="color: #eedd82;">argc</span>, <span style="color: #98fb98;">char</span> * <span style="color: #eedd82;">argv</span>[])
{
    <span style="color: #98fb98;">char</span> * <span style="color: #eedd82;">libf</span> = read_file_into_string(<span style="color: #ffa07a;">"./src64/jonesforth64.f"</span>);
    <span style="color: #00ffff;">if</span> (<span style="color: #7fffd4;">NULL</span> == libf)
    {
        printf(<span style="color: #ffa07a;">"Aborting: no lib.f file\n"</span>);
        exit(-1);
    }
    <span style="color: #98fb98;">char</span> * <span style="color: #eedd82;">args</span>[] = { <span style="color: #ffa07a;">"forth64"</span>, <span style="color: #ffa07a;">"asd"</span>, <span style="color: #ffa07a;">"qwe"</span>, <span style="color: #7fffd4;">NULL</span> };
    <span style="color: #98fb98;">char</span> * <span style="color: #eedd82;">envp</span>[] = { <span style="color: #ffa07a;">"USER=test"</span>, <span style="color: #ffa07a;">"HOME=/home/test"</span>, <span style="color: #7fffd4;">NULL</span> };

    runvfm(<span style="color: #ffa07a;">"./forth64"</span>,
           libf,
           <span style="color: #ffa07a;">": ALFA .\" &#5788;do-beta-gamma&#5787;\" CR ;\n"</span>,
           args,
           envp,
           <span style="color: #ffa07a;">"ALFA\n"</span>,
           <span style="color: #ffa07a;">"hash"</span>
           );

    <span style="color: #00ffff;">return</span> 0;
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-unnumbered-39" class="outline-2">
<h2 id="unnumbered-39">Tangling</h2>
<div class="outline-text-2" id="text-unnumbered-39">
<p>
Теперь мы можем переходить к высокоуровневой части. Она лежит в разделе: <a href="jonesforth-2.html">Forth-часть</a>
</p>

<p>
А тут осталась только сборка всего кода в один ассемблерный файл:
</p>

<div class="org-src-container">

<pre class="src src-asm" id="macros"><span style="color: #87cefa;">&lt;&lt;macro_next</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;macro_pushrsp</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;macro_poprsp</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;macro_defword</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;macro_defcode</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;macro_defvar</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;macro_defconst</span>&gt;&gt;
</pre>
</div>

<div class="org-src-container">

<pre class="src src-asm" id="assembly"><span style="color: #87cefa;">&lt;&lt;flags</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;macros</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;built_in_vars</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;built_in_constants</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;asm_docol</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;words_for_retstack</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;simple_primitives</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;mod</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;comparison</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;argc</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;argv</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;env</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;exit</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;store</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;char_store</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;data_stack_words</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_key</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_emit</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_word</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_find</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_tcfa</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_tdfa</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_number</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_lit</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_tell</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_create</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_comma</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_rbrac</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_colon</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_semicolon</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_immediate</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_hidden</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_tick</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_interpret</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_branch</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_quit</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_char</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_execute</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;dodoes</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;words_for_hash</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;word_syscalls</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;asm_entry</span>&gt;&gt;

<span style="color: #87cefa;">&lt;&lt;sys_ret_stack_and_input_buffer</span>&gt;&gt;
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
